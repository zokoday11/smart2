This file is a merged representation of a subset of the codebase, containing files not matching ignore patterns, combined into a single document by Repomix.

# File Summary

## Purpose
This file contains a packed representation of a subset of the repository's contents that is considered the most important context.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.

## File Format
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  a. A header with the file path (## File: path/to/file)
  b. The full contents of the file in a code block

## Usage Guidelines
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.

## Notes
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching these patterns are excluded: node_modules, .next, dist, build, .git
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)

# Directory Structure
```
.firebase/
  hosting.b3V0.cache
  hosting.Lm5leHQ.cache
app/
  admin/
    login/
      page.tsx
    logs/
      page.tsx
    page.tsx
  api/
    extractProfile/
      route.ts
    generate-cv/
      generate-letter/
        route.ts
      route.ts
    generate-zip/
      route.ts
    generateInterviewQA/
      route.ts
    generateLetterAndPitch/
      route.ts
    interview/
      route.ts
    jobs/
      route.ts
    letterAndPitch/
      route.ts
    linkedin/
      exchange/
        route.ts
      token/
        route.ts
    polar/
      checkout/
        route.ts
      test/
        route.ts
    stt/
      route.ts
    webhook/
      polar/
        route.ts
  app/
    apply/
      page.tsx
    credits/
      page.tsx
    cv/
      CvTemplatePicker.tsx
      page.tsx
    history/
      page.tsx
    interview/
      page.tsx
    lm/
      page.tsx
    pitch/
      page.tsx
    settings/
      page.tsx
    tracker/
      page.tsx
    layout.tsx
    page.tsx
  assistance-candidature/
    page.tsx
  auth/
    verify-email/
      page.tsx
  debug/
    polar/
      page.tsx
  forgot-password/
    page.tsx
  login/
    page.tsx
  signup/
    page.tsx
  tech/
    page.tsx
  globals.css
  layout.tsx
  not-found.tsx
  page.tsx
components/
  assistant/
    CvPdfEditorModal.tsx
    CvTemplatePicker.tsx
  layout/
    AppLayout.tsx
  pdf/
    PdfEditorModal.tsx
    PdfViewer.tsx
  user/
    CreditsBadge.tsx
  ActivityTracker.tsx
  AOSProvider.tsx
  BlockedOverlay.tsx
  BuyCreditsButtons.tsx
  CvTemplatePicker.tsx
  InterviewChat.tsx
  LandingFeatures.tsx
  LandingHero.tsx
  LandingStack.tsx
  PaymentHeader.jsx
  PolarCheckoutModal.jsx
  SidebarUser.tsx
  TopbarUser.tsx
context/
  AuthContext.tsx
  CreditsContext.tsx
  LangContext.tsx
functions/
  index.js
  package.json
  recaptcha-interview.js
hooks/
  useAdminGuard.ts
  useRechargeHistory.ts
  useUserCredits.ts
  useUserProfile.ts
lib/
  pdf/
    templates/
      cvAts.ts
      cvTemplates.ts
      letter.ts
      types.ts
    colors.ts
    fitOnePage.ts
    generateCvLm.ts
    mergePdfs.ts
    pdfmakeClient.ts
  server/
    credits.ts
  apiClient.ts
  auth.ts
  credits.ts
  firebase.ts
  firebaseAdmin.ts
  firestore.ts
  gemini.ts
  interviewPrompt.ts
  ipLocation.ts
  linkedin.ts
  logAuthFailed.ts
  logUsage.ts
  polar-checkout.ts
  polar.ts
  recaptcha.ts
  userTracking.ts
public/
  cv-templates/
    cv-previews-grid-new.png
    cv-template-ats.png
    cv-template-classic.png
    cv-template-compact.png
    cv-template-consulting.png
    cv-template-creative.png
    cv-template-elegant.png
    cv-template-executive.png
    cv-template-minimalist.png
    cv-template-modern.png
    cv-template-pro-max.png
    cv-template-projects.png
    cv-template-skills-matrix.png
    cv-template-tech.png
    cv-template-timeline.png
  manifest.webmanifest
types/
  cv.ts
.firebaserc
.gitignore
api.txt
firebase.json
firestore.indexes.json
firestore.rules
next-env.d.ts
next.config.mjs
package.json
postcss.config.js
setAdmin.js
syncAuthUsersToFirestore.js
tailwind.config.js
tsconfig.json
```

# Files

## File: .firebase/hosting.Lm5leHQ.cache
````
required-server-files.json,1764026729350,faa6020d48adf6312d77ee01042cf6db7bce645322cec2497961e1fcf6323c07
react-loadable-manifest.json,1764026716482,a4b04944443134617e3f0ce2d83bd80777944443377c1b3d27d20980cd705f74
prerender-manifest.json,1764026735152,c2dc04e5dabc25e9acc484a2f3460a62c09af8ede877366b92f51c7fdddba5d4
routes-manifest.json,1764026698224,c555d09020c1ff150941161b9ffc7c997b163ac15f30362a0bed428829832180
prerender-manifest.js,1764026735242,c303b184a8a946bc7e3178fc2577c9d562e9b2ffef83363530d37b0e22dc244c
package.json,1764026698223,bcb9a16329e98e1c8a36644006703f1ec868425fd8a87f6e56461c280b826234
next-minimal-server.js.nft.json,1764026743650,03fda4dba157e3caf24f302b96fe9664d8bec48b55b00d683b6ba17d486fa52f
next-server.js.nft.json,1764026743650,f4f5ad4c61d468a0f4acf7234de162444a89622b9f67a97128027b3fe92923c2
images-manifest.json,1764026735376,5debd95a6cb1ddabb0f4052b9ffa429290ee932f8cafc4ec0aab6d9f85e1cf55
export-marker.json,1764026735452,56b9bc6d101d87fcd90a42b4b20f18c87e9ad5fd6523ba1b2fa67f01c00843a2
build-manifest.json,1764026716483,1ea5b8a9339bbe2731223db127d0d67559807118e45a5a2ff7df9eff69b2dc9b
app-path-routes-manifest.json,1764026727489,0f7e2d1f6b9259941d2a2314c3a8947307a1354e3fd6cff1cf2a39e00b2d6e92
app-build-manifest.json,1764026716483,a85c7e52f7458bcba0e631143f1bb4177504b67e10dda402725ccbae62600efe
BUILD_ID,1764026729338,8ffea43f5de75690d4b9438d09393a005a72499ab5e565a70be72287abf8b43c
types/package.json,1764026705341,fb83e1c2e553bcd88716e880a7ad4c4a77e92bdc857ac531d99436a10cea04cf
types/app/page.ts,1764026705308,eb5f4e457ec07e31870d6aea56e3e55b8554c6024ca41292e56de4fb3092cc68
types/app/layout.ts,1764026705341,e84d5dc310608f208720abf21293e6a60114940444c9cff3f4ba76a03ba4d588
types/app/tech/page.ts,1764026705308,1c1809941d2ff3ec07d2670ca7367cb0175ce3159f37236a2e406a21575490c3
types/app/signup/page.ts,1764026705308,2ecd725092fe78e6df6710e98a6065a24f4023f08ec6cf7f96891ffbb3c7dbb1
types/app/login/page.ts,1764026705308,f25be1d3cca2bde80b18561cd235c15fd1b027514d619b383d05879d6b191d67
types/app/auth/verify-email/page.ts,1764026705310,ca58d246324b7d9e65b0b840cbb8277cc29eba583b02c633b24572c91e756bc7
types/app/assistance-candidature/page.ts,1764026705308,55d4152496dbd96043d2461bd92ed9da4526a59d5e65da62bfa38eb804b59adf
types/app/app/page.ts,1764026705310,e72891a038ac654f4c1eee106b84fe9c84d104e5c1fa943bfaa683c9417ea831
types/app/app/tracker/page.ts,1764026705335,486c4ede492e2d58ecd1ef492aab0801a80663818e5869f2000076da64e38ec5
types/app/app/settings/page.ts,1764026705340,005d08996f221e5a26fd79615992288bf4683e2b1424625003e18b105621d539
types/app/app/pitch/page.ts,1764026705323,32b4c30794640bfcfac04ad8decfabf7b8f2d683346bb53b2bed1132b02005b5
types/app/app/lm/page.ts,1764026705340,2233e5615e959240bac8ad67c0db8beea8f9f19fee57661de34b9f380fa6d789
types/app/app/interview/page.ts,1764026705340,9d78266af5c0f20bec41e7f03cae3681fc6c654a722e359d3fab95613039099b
types/app/app/history/page.ts,1764026705341,8a87b2de60976ed83e769956351c4a520f2a9971134d448ead947683c9894e53
types/app/app/cv/page.ts,1764026705340,f3976927c7206640aa5edeb639f91394c004ac0e7df3b2d6776a34345c5629f1
types/app/app/credits/page.ts,1764026705335,9318f268d91b6cbb421d05fba6440521dda42fcbd8de5eeded42c1e17609cd19
types/app/app/apply/page.ts,1764026705340,fbf31f45950016f60250a4a68be2f3844580fe28ee8746ec3eeda1be96949288
types/app/api/polar/webhook/route.ts,1764026705336,ef908572982192c9c27ede864e28b0adc21ecb6b5999a92fd24bbb20d48e04ba
types/app/api/linkedin/token/route.ts,1764026705336,b6acc7578d8b261dde27ca5221926edc9dcc6ffae4b7c717086247f186ec126d
types/app/api/linkedin/exchange/route.ts,1764026705337,4ea317891c345be889c9f48705e043e68f2bb2ffedb699eaf7f391dd572e3151
types/app/admin/page.ts,1764026705308,f4adbbf8eb01a045ab920a9c925ee8829da2e3c2869fcf007ac944e6ff12573f
types/app/admin/login/page.ts,1764026705313,45292f68178863776fa57801f8e2cc7839220fbc6799ea95a35d9feb770d2a60
static/chunks/webpack-91b2d14d0f678b80.js,1764026716472,7c5b4f6fc9c1c64625417a25000feb25495d11438ab49c90c36caf9d44e92e41
static/css/f22078e41cee5400.css,1764026716494,c7f33f4b5844e54993038946795c4511df4869cc0e7bd46d4f354a67714e0dc2
static/chunks/main-app-2e7364934d9bcc31.js,1764026716459,7202fc85e98aa93028029008f04ed2823d9a1809fcb72df44136c86df86c7def
trace,1764026743694,f8982d26a68ebf31317c92875f27a5817a817abfb80054656438167c9ea5d48a
static/chunks/621-3d25d5ee54bc5eb1.js,1764026716483,d5ce8437d45b55a2628db37c20cfe2c717971b5e9ca112e83beae4c6ca49bf52
static/chunks/polyfills-78c92fac7aa8fdd8.js,1764026716483,a5b39edcc77b6069d442b5dbeb8091cf27ac47ac7a1a99cfc325213bdaae2fb5
static/chunks/main-2794a98e2503d678.js,1764026716459,8835a50251026fb0b1617e03639469a4ad86883c4ec70e881e041e31ba8ec66a
static/chunks/69806262-c31872e60297e46d.js,1764026716473,4f4211a27aba4cfd537d50cd51661fcb603d911bd0635b3487c5bc4980bc0c6f
static/chunks/pages/_error-1be831200e60c5c0.js,1764026716460,7ba7b69d070dbc710e451691d369b4ce050c7aff928d7ff030baa21135383430
static/chunks/pages/_app-6a626577ffa902a4.js,1764026716459,033ba1808728c513ad0a88d7ddf19b808f355e4bccb8e18dd6b1928961cf7a45
static/chunks/138-7507c07ab2f9fc1d.js,1764026716483,91e92091a4d37d24da31f94ea676dce2e0025aa584bf1d4a0d8c3524724926b4
static/chunks/app/not-found-0d92631d0244d996.js,1764026716459,c13384c322e45582ecb54e7581d10f6105a2e6f929d88b88a4fb3699c2042dab
static/chunks/app/layout-a618519e30fc5082.js,1764026716459,ead943790b104200135437395cd72a436cd761755cff12d9bb499a995f5ba3c7
static/chunks/app/page-190ea484f1cfb43c.js,1764026716459,3edcd45c01c081de96cde9e577c19bfb60fa523fb8db2130b72c31fb37db2fdc
static/chunks/955-3cd8599ce6aa07c2.js,1764026716482,480a8d35d35df333d9754ff92b6c5e523e4649270ebf535ec31aff8256bab0ca
static/chunks/app/tech/page-53b001589ec4b409.js,1764026716460,82387e0dc4c5ab6527090c260f51d025e5a2e07867679264f4dd83d63acb4954
static/chunks/app/signup/page-591af0428c3c8d19.js,1764026716459,6eea57794e7ad969d32d0aba976ae81201105f5d07cb42995c36d713dac2679c
static/chunks/app/login/page-383e7d3fb5f56246.js,1764026716460,97e046275c288f6cc40e2aeb32c4ecbb409ba7f415b3805ca275fbd88034cc0a
static/chunks/app/auth/verify-email/page-ac86f774492d8f10.js,1764026716460,b49a5154c933ccf2153a02edf6e8f7607f7c022c12ef2cef4fda7b3c38a01fef
static/chunks/app/assistance-candidature/page-4e3c0a0fbfaa46b9.js,1764026716459,5ea28e433b8f80ac391dace8d3af730568b30c0fc88328dab306688b43caff8b
static/chunks/app/app/lm/page-d2424b1c58ec485f.js,1764026716471,4b7b2dc1668e8a9af41882a291f8498c0917ee195675af10a3ab0c05347585ce
static/chunks/app/app/page-93cc857ad2ae5002.js,1764026716472,deb3b43928d34631b9960284e84ae575600416f3f4e43d00878ec476cb85f157
static/chunks/app/app/credits/page-e697f2bb8d726ec9.js,1764026716474,d738c16316413f56a09a8bb7246b9ad9df561eec2205c30b83af6a422e156272
static/chunks/app/app/layout-6aed7b227000a15a.js,1764026716472,c3e1ff34f45c8e28aed9bb74fe054d4c3d26940b7b7dc015dd2b4249cad51507
static/chunks/app/app/apply/page-ff605542414d7f7f.js,1764026716471,3d1a478dc7704b5fb18f64410fc3872edea77f1e7d65c0820632b79f0991982c
static/chunks/app/admin/login/page-240daa14bb4852c0.js,1764026716460,ae17b8fa6940c6f38f0c1e6268f3d82a79d22b6033f0f074c834c9e4831618e1
static/chunks/app/admin/page-8857cf2a57926d01.js,1764026716459,9045bdbd33a422215036810dbb37d02cac3c3d959114dfef839ff197ec9c3a40
static/chunks/app/_not-found/page-29db342e34374c89.js,1764026716459,13d3e75033764ed3306d7ec29efe4c83d3e4cc0af66065fd8578935ffb4df03a
static/-dT6A1SvnRSySsEbysDYr/_ssgManifest.js,1764026735319,02dbc1aeab6ef0a6ff2ff9a1643158cf9bb38929945eaa343a3627dee9ba6778
static/-dT6A1SvnRSySsEbysDYr/_buildManifest.js,1764026716489,d69e5a007397f17b35522afa5231f150a71e70144a0b25094b29b45bb5e6de96
server/server-reference-manifest.json,1764026705342,ca34e4b77172d3b8b2702eaac9586210574c409b034aa6dc731084dbc23786a9
server/webpack-runtime.js,1764026705293,f45ae6f81d5f7169cc53c6f3fa69a4c25238876a6692c08599ed810c58bd416f
server/pages-manifest.json,1764026734952,6b5834025a891ba7f8c4c4d40d486c8fc382a0b20353347d0b1e3e9265a45d00
server/next-font-manifest.json,1764026716491,7b3fdd39ef88a4f1a399b6c5db0e293276d61e74616d22506da791d19c18853d
server/middleware-react-loadable-manifest.js,1764026716485,ab4b3550c791b0ce095966989fb559527bc579db9697f53478f9996a28acf179
server/next-font-manifest.js,1764026716491,0516113d642299cc41ed8dfbcc3411732df29e0731dcf16fb2c18ce648e556fc
server/server-reference-manifest.js,1764026705341,ad544a760a19d613df67fe08face8e009a2f0d83a57ba0b29760deaf00b01ece
server/middleware-manifest.json,1764026708873,44131e01ea364a61de764fb249651ffe6fdcae5b7ab75e7f56ab60aeeed8e9dc
server/interception-route-rewrite-manifest.js,1764026708873,0e1ba25843e7639a44c34068a45a9e043402eeb3cd1ccc5c2d84b99b6ec810ac
server/middleware-build-manifest.js,1764026716485,5be83cf816efb1c65bf3cda845c83b875abf6811bc389e40bbaaf1f6857801a6
static/chunks/app/app/tracker/page-0ce47c9c65c0fc6d.js,1764026716471,3e41ecc6f797416d7f4830d2bb5fda4439984de5cc9c13501438412b3a9f5cef
server/functions-config-manifest.json,1764026729286,6b736f30bb3e680388457fe5fbb0293db3a6fb06c47a7df50a348236717fa747
static/chunks/app/app/cv/page-4c9c75503c5069c8.js,1764026716474,058266404ce25a3d25b9fc797c1af672ab0d4dc7873c60615413bc7db1e7f7b5
static/chunks/app/app/settings/page-8c2e33a56a848599.js,1764026716471,97a5c69d6ab86734367532759ccada046ef4b8a39a261f0ec60e4650d0308778
static/chunks/framework-aec844d2ccbe7592.js,1764026716472,7885994d6203224805fffa95f6a6551af6903a76bbec7b9292d3ea205e7d447f
static/chunks/app/app/pitch/page-c31ce7b3525e659c.js,1764026716472,6531b907e07757401e38643ff35e9a408b220fdaa1469a164e10575627a68391
server/font-manifest.json,1764026705298,6731668a37f6a3ed10d77860e21c7ba693c377a061571ffa58564d1d699c1798
static/chunks/app/app/history/page-ba2f61e7c7cba866.js,1764026716474,544e40ded57e5639de2f84d5c6885ec08d561ee40ce2cfbccc9a821ad27f6b45
static/chunks/app/app/interview/page-bd53d6b7237f5620.js,1764026716471,dcd71273057154c86d38f8fd2ebd663e8283f8917a5571838ebd0a8e557d1707
static/chunks/fd9d1056-41afe60f3d3c21b2.js,1764026716488,1ad5b60900951695550bcfb3b5d43784825075257435b5badf3d5a7ed4b9e1f9
server/app-paths-manifest.json,1764026708856,45cdce38d3d1053f583b65c1192527cc7fb98391a72500cc8ef6a7ff0ef4ad7c
static/chunks/ca377847-ba88b40a0691822b.js,1764026716483,f3518b038f5ba71224751678bfd02c707f512eefa5d99b943a692d6f622dc782
server/pages/_error.js.nft.json,1764026743627,f3103a2cfb0e52a9142f5cc1cec951e7df09a28c7866b47c952c49f6d6948448
static/chunks/23-a018d5b946342a64.js,1764026716483,ecc22580e6753b5bc285b46a3d4336d95e37f088effb8ab7d47f4d409d6fee9e
server/pages/_error.js,1764026705283,9d1484768dbdce62ae27550ee0aac87c0536b4b01538cf2ebe5915abb36d73aa
server/pages/_document.js.nft.json,1764026743625,1dd6b313b1f1df84db1c05ed61eecb61fb22a30586efffacb790ec02f90c4bb3
static/chunks/bc9e92e6-c92f39a73848b8a1.js,1764026716472,0ca8c089ad5759331761854b39e094ef24612544c3168410548694e9c6e39b55
server/pages/_document.js,1764026705289,ca5276420d329a86d6e2c6caef0b20a86f4060fb2bd896f4402c340574b1bccd
server/pages/_app.js.nft.json,1764026743632,f2ae4965a89bff1105ee000b4bc1f1ba040469c3f396e9ed79df07183847998c
server/pages/404.html,1764026734419,2a92d454d1b10bcb8e5b90c0b4f5713a80604534421865f4718537521ce9edf3
server/pages/_app.js,1764026705283,a096157015a2ee91a3984993ff98682529ad435c4329eb6ab6ec2f4fb7526ee6
server/pages/500.html,1764026732565,9dedaef1bccf8b51bbd4c1384d7ccfdf9058f85fdb7135ff8bc28f98d09e713b
server/chunks/682.js,1764026705296,6a55378f19ef26f47fbf66ad6b48b5748e5a7362772a03d202666923760c1e0e
server/chunks/972.js,1764026705294,043102158eeed7586923d8ccb7f4919c6e03838e09781a28a7e21c0bf501347f
server/chunks/10.js,1764026705298,58062128d087253d99f7dc626327229010b1b42eb620ebcf62f2e031b37a535e
server/app/tech.rsc,1764026734276,d2b3ffaec2c87d96c92d6e8573f916400a5c6808c7e6962e210f8a37cf9c4070
server/app/signup.rsc,1764026734275,2669465a36bda815d470758e6a29eb4acf66315049fb7254ee472293bc1a839f
server/app/tech.html,1764026734280,1a0a62430c185dd4733e86cfe9094b29d914812ffa81565f975dacb7c6a212cd
server/app/signup.meta,1764026734283,1cf7ec4b44fa726f7cf2f4f406aa5858e7ddd0a3ace5f41848d08fdbdc3710b8
server/app/signup.html,1764026734280,c0f3d377ca269e095072bfcaca236b264be51d202d3e0e53ad6c6bce28425614
server/app/tech.meta,1764026734282,b606cdc8a28c2ca43bbf810d893410eacf65cb38d5936bf1d2a2cbb096aeb47e
server/app/page_client-reference-manifest.js,1764026716491,f6666f371b5566cb6dc0332593948d0ab1db8fc5c7ff837e91d373e7be52044c
server/app/login.meta,1764026733996,679384b27256e79d6787a0422a20ff18e239f15a72dce53443e9a3672ebb9462
server/app/index.meta,1764026734058,e9cb1abe59404b1848c500ac3b6029bf17116af5bbd827f20260f2f077fe0d2f
server/app/login.html,1764026733996,c71b92cb4e734cfcb97cd05aec2f5e4f1d2d6be200473feaaa788dbfbad5bced
server/app/index.rsc,1764026734056,c22cc93a96116d70263e1b8ddd916282c26dc7766c69551e435fdd7bd2b78958
static/chunks/537-ce8c447b5bd64451.js,1764026716482,0450691049244cddbca2d67e1e0dc5006bb87db3de4d8241e8025d00a35df387
server/app/page.js.nft.json,1764026743625,6c24862ba2dc96868dbae9fc6285e6849eecf4935514c919bab08319abc6ac42
server/app/assistance-candidature.meta,1764026733756,00a26dd8b3f23eea682f5680b5e19dc2cb4208d4582978a5cfad884598ed8cf1
server/app/page.js,1764026705284,8077e599228bd79bd609dafa51a3bc9eefa7310575c321e8a733b6f9acbfba8d
server/app/app.meta,1764026734137,2194b0478a36dd1305b778f19930aa2c5e954f69368a9754cca6497d31a38a03
server/app/assistance-candidature.html,1764026733755,ca0785855d9a6e74ca71b7c592d04e9729dea0be113c5e8f123a6baf291d7c3d
server/app/index.html,1764026734057,b3c358fe8644453109f63842214c39e781bd028ba8f564c3a46600d1dc73b6bf
server/app/assistance-candidature.rsc,1764026733753,085b5f5d02075cc7831e5685da4698bd195f8bca8e5d98d90dc04a43ab770d00
server/app/app.rsc,1764026734134,c063a2c72b60a0ab00edb158b474794fafe3f163caedf530b40b9317f66959fb
server/app/login.rsc,1764026733995,2d3efda02f056683d18904c2a8b90691f9431fc2f7886ad620a956633d9c2ae5
server/app/admin.meta,1764026734286,bad0bdc40e9b73db07237079f2a6b06235490bc56fd7f6a8b690715b776fdbef
server/app/admin.rsc,1764026734281,190316dacf7193c6adfcbd5432605d3fb8558101e679859b05935b4dfc74e0a0
server/app/_not-found.rsc,1764026733382,5696cea366f6693fba34d602c73bd7006e98acb9452eba68627691b7ced74b34
server/chunks/font-manifest.json,1764026705282,6731668a37f6a3ed10d77860e21c7ba693c377a061571ffa58564d1d699c1798
server/app/_not-found.meta,1764026733388,9b0ddfb98f277970ee75de2f4f80679d4dd59e2a89b379098d839d061197756a
server/app/app.html,1764026734136,264f638ccb796245130f1b0de12b5a272a5c951f8feb62814b753befd2d0d966
server/app/admin.html,1764026734284,5a291647c83b11c32fefd0be5b61a8c39663adb4d4dec39d978a76d91657e978
server/app/_not-found.html,1764026733383,2a92d454d1b10bcb8e5b90c0b4f5713a80604534421865f4718537521ce9edf3
server/app/tech/page_client-reference-manifest.js,1764026716491,4cb279f8a0aa972deca94ab59fbc5f8e189e66fc09bea71b9715d13da8db44ee
server/app/tech/page.js.nft.json,1764026743625,c0c74ad18a7a75c1ca768f1e20ff8ec89e2456a16a4c8a18732f99f2cae9733a
server/app/tech/page.js,1764026705287,a338325f6261aa37b8ff54536cc6d2163a31893183bc3c6b06b04aa98432b0ad
server/app/signup/page_client-reference-manifest.js,1764026716491,0aa207798d24880c6d135e4015cca8c449b4ca38af6f4f888b8f578e142b1dc0
server/app/signup/page.js.nft.json,1764026743625,c0c74ad18a7a75c1ca768f1e20ff8ec89e2456a16a4c8a18732f99f2cae9733a
server/chunks/948.js,1764026705293,45033c1f6d5616f7e5e9016c200b580bf07b343b92364805de6aa6522f4baaea
server/app/login/page.js.nft.json,1764026743625,c0c74ad18a7a75c1ca768f1e20ff8ec89e2456a16a4c8a18732f99f2cae9733a
server/app/signup/page.js,1764026705287,aa26db4277e6d7c8363bee453fc727fb805b8bc4885aeaf917159869a4c0b00e
server/app/login/page_client-reference-manifest.js,1764026716491,fc53f4672b147e77f93994ff59677cad50faea7f79ee1ae6abee092981cac522
server/app/login/page.js,1764026705287,100fab30d891de1777220a3b2d636c694d5e838ea5f497dfe5e9b30bef2cd90b
server/app/auth/verify-email.rsc,1764026733892,79b6010bd5bc699a565a762c7be931b4a555f4506f32e506274c48f566f0bc1a
server/app/auth/verify-email.meta,1764026733894,a566cf5ac4ba42c2c0c00beafe61da29f999e19cd8c2f05a8379d230a3412914
server/chunks/622.js,1764026705294,84df62a3bfcba640cfe8018c547ed03638c80ae16a43f7963854170dd8ee1cf1
server/app/auth/verify-email/page_client-reference-manifest.js,1764026716491,b2fd220f62f00eb4a627dd91df75ead2640bbf193dcb5f4f5571eb9622cc15c0
server/app/auth/verify-email/page.js.nft.json,1764026743625,5ba162c85b003181ae736d2e1d05076f88aaf5cbe721466503d5c8640b140c48
server/app/auth/verify-email/page.js,1764026705287,dd31014c15fdba7ecb3cc643106596df8d4eff65d74834c9cee62974474c2bfd
server/app/assistance-candidature/page_client-reference-manifest.js,1764026716491,857b2dff3047f4ae127742ffdc690c6ecc540238bc988e09e511142399efa91c
server/app/auth/verify-email.html,1764026733894,05d9001c10b2514cf36f1eb5341bab3e4f9cd6ab61243f2d51c6ae8a6b88fca1
server/app/assistance-candidature/page.js.nft.json,1764026743625,bb7cde0f585498f675b44c936d6db59207a8a065f1c839ed176cd5854079e479
server/app/assistance-candidature/page.js,1764026705288,c4b01b81449cd03b8a733e00d7977cb6866536d97738436bc9e3993af4b668d1
server/app/app/tracker.rsc,1764026733929,39c199c3ee9cd454a35278d7c1f09c111b7f4407d81b01bdb0d26bfd9b22a84a
server/app/app/tracker.html,1764026733929,52e436ececac03f3b47c8a470c8d72905eaddd4d83a300bec3b3b7196dfece14
server/app/app/settings.rsc,1764026733675,144434b7221c5c2c7213ab483f13a87310465f53a4c724acdd1deca64f84179e
server/app/app/settings.html,1764026733676,bd000bf4703766b0872915a134cea49e197b7e70f8857b11b8f9c43014883f3c
server/app/app/settings.meta,1764026733677,61e24ac4645b6bfc1e4edde2a706de0cef571be36472d53bd09fda1d3cd766f2
server/app/app/pitch.meta,1764026733671,b96294f210dc68d6ed5f7d7fd558aa6f8787909611ddea3b1529f5d65c3d8de1
server/app/app/pitch.rsc,1764026733667,30160839b0a11e25a396a9c21be74191942befae16617684362db089f8bb9b7b
server/app/app/tracker.meta,1764026733930,2bf5058e644cfa342725213c7bef725d7b39c603242e7c99aba6f52f2bc55efc
server/app/app/pitch.html,1764026733668,f34dc2a9a7890a8756dc387cdcc400fac197c755ca613e7dc317ceef11946f8d
server/app/app/page_client-reference-manifest.js,1764026716492,1478c5671b574133bf876646be0f37e193f46c2b909fa0608410c90bb15e5573
server/app/app/page.js.nft.json,1764026743625,dcf52dadbcbb7b55bad9cb8051b63e4f0c20cbeff8c824d8820b078d94034704
server/app/app/lm.rsc,1764026733734,922564088718544373245fc64366051cf06b48d25f563f7fab8b60c583804402
server/app/app/lm.html,1764026733738,703720e85c6544a8438840f384f215da49842c1161c08a288dfc028bc1d16654
server/app/app/lm.meta,1764026733738,04a1afc9b5c9d3c66420d60fe724a4eb7846889efde9ec68eb2d28fa4191cc51
server/app/app/interview.rsc,1764026733556,e87c2d76458a38059baa71e503caa00f9b9d10b945be5f4b18d1c2af7a6c6af1
server/app/app/interview.meta,1764026733560,316676f311368fc2a2b64e6be3ef9a1f33d111fa54869f250d3fcfe6515fa983
server/app/app/history.rsc,1764026734132,1f04abaf4db2a5cf34dcf30e5ceb0b61378ed2684baad1429837c12dbe7aa338
server/app/app/history.html,1764026734133,c70e6519c39281428d61e3f950ed38c3ffc48131d2ce6b1357a0feacd89390f3
server/app/app/interview.html,1764026733559,193c4e41647330cdc58d410fbf4247571147c0fcd27b38c15f8601b2e5d4bb8d
server/app/app/history.meta,1764026734134,ccfd2db673d40cdeaf7ef0d7aad5c0140d1af7f2107aff2d9858775ac2a52c6c
server/app/app/cv.meta,1764026733543,3bc75ba2cf927dd094e9fa7a7ebd18fdfc2df8a83e1082be80613c591c294565
server/app/app/cv.rsc,1764026733541,b0ea1f052e4d6e113f68e0ed0abc865c064f1464a9258d42da78aff460e72874
server/app/app/cv.html,1764026733542,9ccde8b13ff0feb3aaf78c333c81ef790fb49422c77f9e8c9e24314150e622a0
server/app/app/credits.meta,1764026733391,0ba7583a8c447a60bbd5ac60a625ebe737ef41e8825560751188929d0c6e4085
server/app/app/credits.rsc,1764026733389,610d4ed1679ca8b7ba24c984f8f432c775479a3474cc02f01075888ec8c421d3
server/app/app/credits.html,1764026733390,2bdef619a6b0247140759d6c8d378164e0435977f6ac67d9b244dfc2a9d27d12
server/app/app/apply.rsc,1764026734179,f1cbab3b0699564ada0bf2e7c8c86f679d06db904ce35a25a533064fa15e9845
server/app/app/apply.meta,1764026734181,7733dc31718f9147899aeb7818e83a5bd27b05e1dfa3dbcaaaab829f920e187d
server/app/app/apply.html,1764026734180,d9b7d3dd31f64871027a766cdb774d6eb9dcac8065d59871e885f44bd06f7cdb
server/app/app/tracker/page_client-reference-manifest.js,1764026716492,7dc70b31a812727224db784c3ff186987998bde6813dc5c3cd712c42493d310c
server/app/app/tracker/page.js.nft.json,1764026743627,3ea3e05e656da738b8ceac6244f7cb7ccc89f908351e572d52acbefbea231341
server/app/app/tracker/page.js,1764026705291,0bdfadb6960f3c49a85b58eb4e401ede157447f23e4dac787f1f7d8c58efd4b5
server/app/app/settings/page_client-reference-manifest.js,1764026716494,99394414ac94dc0d3468e9959d8a8069c83c818dadbfd5b71b695eafc22be045
server/app/app/settings/page.js.nft.json,1764026743625,4d505ac5f1de0adeeaf4d41bbb52795670e5cb6751a67d106fbeb72adcc412d4
server/app/app/pitch/page_client-reference-manifest.js,1764026716491,cbb7b827a1962ca7753a901ac058c83d8d8761f50c978bc34b810aa00a989ec8
server/app/app/settings/page.js,1764026705292,8bf4afa0a640fc674223306db7b1afa61d32e5d333a1cb8c1fc772a90f60203f
server/app/app/pitch/page.js.nft.json,1764026743625,4d505ac5f1de0adeeaf4d41bbb52795670e5cb6751a67d106fbeb72adcc412d4
server/app/app/pitch/page.js,1764026705292,b5788dd6ca77fde290f62233a6b0c9dc63e63e2f6346a9cb8fe5f4be36463e63
server/app/app/lm/page_client-reference-manifest.js,1764026716494,01d6f42ca5e38af024902d6b46c72064659a7419fd8f784eeb527b8e3be1c1a9
server/app/app/lm/page.js.nft.json,1764026743625,3ea3e05e656da738b8ceac6244f7cb7ccc89f908351e572d52acbefbea231341
server/app/app/lm/page.js,1764026705292,dc68758656ded45c5c838c5973f755ddc0d39bbc052cb7559febf842e8c86352
server/app/app/interview/page_client-reference-manifest.js,1764026716494,2aa911daae2fa6c2cb63a897720e02e24d04481411314742231389076ef4100f
server/app/app/interview/page.js,1764026705292,bc6264f28f5fc843559065f5db61da590d2d28596d3fb85347844d752223af80
server/app/app/interview/page.js.nft.json,1764026743630,4d505ac5f1de0adeeaf4d41bbb52795670e5cb6751a67d106fbeb72adcc412d4
server/app/app/history/page_client-reference-manifest.js,1764026716494,6683f41479fae4f70fc6094786f73c52c3275f7620164339958944af59ddc88a
server/app/app/history/page.js,1764026705293,6d8cbc3d3314683dd1059fc371f6b8823c1e99dccbf148dcf6a5ca40fa2bbf75
server/app/app/history/page.js.nft.json,1764026743627,4d505ac5f1de0adeeaf4d41bbb52795670e5cb6751a67d106fbeb72adcc412d4
server/app/app/cv/page_client-reference-manifest.js,1764026716494,e4852e761a7aa0fb29845adbfbc671741b0d54bafea4345740a71e76d279474f
server/app/app/cv/page.js,1764026705292,529d9f56c4746a0e546329cb6d2af8d3a7bdd1448dc8f4a7093c82ebb806101e
server/app/app/cv/page.js.nft.json,1764026743627,4d505ac5f1de0adeeaf4d41bbb52795670e5cb6751a67d106fbeb72adcc412d4
server/app/app/credits/page_client-reference-manifest.js,1764026716491,a8a13feeed10060e54772e9e9a98873da43b9fee1e16d4853bd222a47f542313
server/app/app/credits/page.js,1764026705292,d8e4004b336bc4a8023bd57de455140dbd05fdc25fa9e794faf47d5f57a4771f
server/app/app/credits/page.js.nft.json,1764026743625,4d505ac5f1de0adeeaf4d41bbb52795670e5cb6751a67d106fbeb72adcc412d4
server/app/app/apply/page.js.nft.json,1764026743632,4d505ac5f1de0adeeaf4d41bbb52795670e5cb6751a67d106fbeb72adcc412d4
server/app/api/polar/webhook/route.js.nft.json,1764026743625,796be69d4da4af17133295c67ec12e7c14bb8d1846829ef52135dcc1244ecb6e
server/app/api/polar/webhook/route.js,1764026705290,eed78a62a284f29f754001abdf2ea1b5c76dc6bafc4b705747e89fc73c21b1f7
server/app/app/apply/page_client-reference-manifest.js,1764026716494,d1495ce120debe8d48ae02504dc4737ca80382495fa094a985a9e9c62d8808cd
server/app/api/linkedin/token/route.js.nft.json,1764026743625,796be69d4da4af17133295c67ec12e7c14bb8d1846829ef52135dcc1244ecb6e
server/app/app/apply/page.js,1764026705293,27ff452aa7e4655fed48993499211eb55935426d0c4944b01b40c2f96418aa20
server/app/api/linkedin/exchange/route.js,1764026705289,412b09c643df42cb268df80aaa2f7db76ff94910a5d23caf087bc1cd3ad3f59e
server/app/api/linkedin/token/route.js,1764026705288,99340dca17580ce19363ed568dc0be2b9a4f1dc9e1a5d802f69d4d8aec472581
server/app/api/linkedin/exchange/route.js.nft.json,1764026743625,796be69d4da4af17133295c67ec12e7c14bb8d1846829ef52135dcc1244ecb6e
server/app/admin/page_client-reference-manifest.js,1764026716491,206a1603a7be6b0d4d2bbbf94865dc5078bd0ca815be5c3e6cec1228c4150037
server/app/admin/page.js.nft.json,1764026743625,6d0f9f3a635e0052395e591d0fbca8a18ce5429ee90d8191f79869b286c5d174
server/app/admin/login.rsc,1764026733266,a1bbb5ab018ab12c977c5164b2147d2dbb3b600d551849d8fa475cc494426415
server/app/admin/login.meta,1764026733268,e5221f8e14d92870d3b29f6391ce660c8ee7d86bfd9d5bd874d0c608a628f946
server/app/admin/page.js,1764026705286,03bb00ca7abcc3197eb670b8486599c3f66d1800bc5e7195467cbbfbe27c6ba8
server/app/admin/login/page.js,1764026705287,131dcf4415189b38bb5f00ccc3d730920f8962b012d1d8f1996ec1e1f8032fda
server/app/admin/login/page_client-reference-manifest.js,1764026716491,9f056511577a3b0d63cc1b95f47fa60a76f164d5ae6aa3a5bdce99a33dfab75b
server/app/admin/login/page.js.nft.json,1764026743625,5ba162c85b003181ae736d2e1d05076f88aaf5cbe721466503d5c8640b140c48
server/app/_not-found/page.js,1764026705286,5b5f5335a4fc20ac15e06452ec3cb31a7a7ddc2858bd3b2efd3e5ebb180ad48b
server/app/_not-found/page.js.nft.json,1764026743625,c0c74ad18a7a75c1ca768f1e20ff8ec89e2456a16a4c8a18732f99f2cae9733a
server/app/_not-found/page_client-reference-manifest.js,1764026716490,d4f29cd13c3c59844cfb92c82d6bd6dcef46cb05170f2dac570924fefe5f313d
server/app/admin/login.html,1764026733267,4886c912d168d1a7907f7405c625bb07b7f31fbebff904e1bd07217502e1865f
cache/webpack/server-production/2.pack,1764026706592,3be9ce6cecf649c02c6e3bb2b2f9f1f9f8e1fe2fef377d731f676f7ac833b274
cache/webpack/server-development/6.pack.gz,1764024287161,af5813aca905aa5a7a97b1e5b7675dc1bc28e341312bd4a612cdb818b2aeb31e
server/app/app/page.js,1764026705291,e61535bddd23ff85f3fc9c7b1510de0b11213d229b6f3f1ca21e0168ac85d787
cache/webpack/server-development/15.pack.gz,1764024478922,6fbe853fac4248b73a11c90a43eba6edf59782530d783b9b50e564644cc6707f
cache/webpack/server-development/11.pack.gz,1764024287152,f875f25d7e9093fb1bb816db2d754d685d094346225cd1435787fc6902f14853
cache/webpack/edge-server-production/index.pack,1764024896487,f930deff61cd0f8e15d35a5996abae25ec091975ed6689e2c5028eed3c27209b
cache/webpack/edge-server-production/0.pack,1764024896487,59c753cc45ee8a4ca8e89f9074c0a493819b5a37358aa131156273515da76376
cache/webpack/client-production/5.pack,1764026717087,ba616cd5a26fbda70e6ff6b8f14e3a3a1cb8635b87032c101a988d4ef179ae3e
cache/webpack/client-production/4.pack,1764025809169,861564f47b4fdb92bff604be45c3bea1c58dedf0432dbe6aaf4381238de5e484
cache/webpack/client-production/1.pack,1764025809180,50b578df7a32ddf4a70c34244efd930eaf761adc713daf3767e17e95803a11e6
cache/webpack/client-production/3.pack,1764026717058,82fe9b530572ab47659b5ec28f4686614d8c68bc03a131ffbc4f66a0936d5791
cache/webpack/client-development-fallback/1.pack.gz,1763726991041,f61803af34be4773ca38272a9a924a1832e7e70eb24147e6927f887e02893095
cache/webpack/client-development/9.pack.gz,1764026444340,dd8810dda553ee803e79954b8ae9c5607043a113d89694c64706949615648a89
cache/webpack/server-development/16.pack.gz,1764024478931,415172b8deca54ed5cff8de0255b48d7ad101fb669bcacb27885294a1f0b0e32
cache/webpack/client-production/2.pack,1764025809168,5f956b09fd3adc12a5a125f8657055a1de340df6b44092b01e04e046601d0ec0
cache/webpack/client-development/21.pack.gz,1763988536526,1be651da5078a64070533b34658b5803c831a94f26a9ac326964ff164d23976b
cache/webpack/client-development/22.pack.gz,1763987316980,2ecfbaf7023039a0da19ae122ba501122d185e196efa7d0c9ecaa7bfc82968a1
cache/webpack/client-development/24.pack.gz,1763987528318,c57f090c3bc52cb27b948397439f3b3a7bf0b1f5fb9e542dca27c58f16ef81e1
cache/webpack/client-development-fallback/index.pack.gz,1763921497081,a01df9400632244658fa28a8106a1ff323ed5a9a45ae22939fcf99659e193e04
cache/webpack/client-development-fallback/index.pack.gz.old,1763873529452,d766420aee69fc87896c35c03c6be1a0237bd250e9c6ae951c957d590e8b39c5
cache/webpack/server-development/0.pack.gz,1764026442370,947f307d0df9d1ae306ad9748558cfe9b56ac4f658da5c9dd94cd75aa7cf68fe
cache/webpack/server-development/7.pack.gz,1764024478941,b0c569ad7f0b726945445af7def37bde26e6ddb6b113879c63a88a1bff0e37ba
cache/webpack/client-development/17.pack.gz,1763986942086,f84688711ef56374c6c18a20a6fa2d6097471b63927a3490bd9c26a22e52be27
cache/webpack/client-development/11.pack.gz,1764024858312,d3f516b8392a8a6308a85dd9d03bde944f0fc5082b9f0c3f60665abb703e1a7e
cache/webpack/server-development/4.pack.gz,1764026444268,94dfc57db1f0a25e4edda508660f2bb4004099963e0f514443c08fde2dfe5153
cache/webpack/client-development/16.pack.gz,1764021355468,f769bfe625095718462c540a33d16a33e6602f16fc66e4e5e94c6381928e4a65
cache/webpack/server-development/3.pack.gz,1764026444386,74023dfe4317e765d61dd6a9807f1a04ad62e8da248ab69128d2329e5b785e54
cache/webpack/server-development/5.pack.gz,1763989632258,1ec658b7b8d89f228d50afb2f679d425a78fe12cb66f22a9cf45842f5d672638
cache/webpack/server-development/index.pack.gz,1764026444350,03f2b92eec824712f05d4ef5397a98c9e95e39538ad86c90fcf04b4417a6e769
cache/webpack/server-development/index.pack.gz.old,1764024859308,9bd96307be040e788a47d131f398d4a53e30371f03440151489f0dd1dbd09b38
cache/webpack/server-development/1.pack.gz,1764023592035,59630e27ca9506cf51d0b98f9dddc6112e7ad46bfe06773d76bbf3120ff1cf23
cache/webpack/client-development/0.pack.gz,1764026444335,67333172fd61e9d5387c1189a4ca6d76838c0e6519de4341cdee49f07e605fba
server/chunks/254.js,1764026705294,df597731c4b651bc4792c8298bd15cd2384c0225e24ef1b49526d91d3efb8a0a
cache/webpack/server-development/2.pack.gz,1764023829411,d21f7bf5b0c8d4e1f65f8278814cb3b730d6f68bbe4fd36fadaa546e0f64918d
cache/webpack/server-development/12.pack.gz,1764024478936,28f0ee449337ebf528c0a44fe10537395258b7735279cb86935a1315749d7ebf
cache/webpack/client-development/14.pack.gz,1764026444365,ee6e6204e9b89ade016ab1a82b6c6d7e73ea21ea9c698487ff1985ec0cfec373
cache/webpack/client-production/7.pack,1764026717064,c243fbe1ad78cc2cbb8891c69e93b5d8d5de25afa7bdfab674a3099d95bf513b
cache/webpack/server-development/13.pack.gz,1763988902299,71c14dc314fe4d95d8477f72260e428fbd47d442d217ff342dd0ab839c696c04
cache/webpack/client-development/index.pack.gz.old,1764025787240,73dbc14890d1674cb365356ae99df5c3dacbc04b58f945aef1ade0694d6c09c5
cache/webpack/client-development/index.pack.gz,1764026444390,d3c9b99283a328761c60faefb956265c5b8d2a573d3e256872f25c402ca4f4a4
cache/webpack/server-development/17.pack.gz,1764026442362,d2ad7444e57888e6b7afa447265c86e17488e6e2bdb9cfe737588f57f4d39a14
cache/webpack/client-development/15.pack.gz,1764024414530,13373de1947ff8b169256b3cabefda95b88bb3a815281c2306ec9e1addc3c01b
cache/webpack/server-development/10.pack.gz,1764026442369,61880f9607c3e89f652b4bd92a0127d29ff6601f5e11f64824f185bbb8d7f97f
cache/webpack/client-development/13.pack.gz,1763968188144,639e5a9ab4ed71fcba7416618b84710e2537303485689576bb143a809567b566
cache/webpack/server-production/1.pack,1764026706591,4af1d06e9e5435925d39a4631d84d9537ad600da6690e84cc19509045a5fe4eb
cache/webpack/client-development/12.pack.gz,1763951604099,76bd1da3fac92263b39565f6165a4a25fa27b1039fdd4f9897f38ab27a07b8a1
cache/webpack/server-production/index.pack.old,1764025799422,d66f3f0f5f96a5952fc9e370e0c42c3973ca739d7350f50ca4b944cab92674d6
cache/webpack/server-production/index.pack,1764026706594,b1654556d94073ee618e490103f6570666a2e3a015aa9aeadc31650dc0b365ae
cache/webpack/client-production/index.pack.old,1764026016461,de941ba7ef440c1f8173f7c48d341bdbf87c675c853c37331da6bb7a2baaf23b
cache/webpack/client-production/index.pack,1764026717091,f6700140c332fed5a67176912c463afd0f2859638736490c0d7070799ab2e53c
cache/webpack/server-development/9.pack.gz,1763951604183,1004351b0acb99281e1c7415dd77c5157ea07d77ea8c1651b28de8b2f8d2dbd0
cache/webpack/server-development/8.pack.gz,1764024111083,88112fd577fe747768bde149380e95477c68963162452faa3f584043af1dbdde
cache/webpack/client-development/6.pack.gz,1764026444697,d7e7471f7c6aa20e8a12a431c521199ae55fdeb81eda2cf50dbe8b61f0ed1c3c
cache/webpack/client-development/18.pack.gz,1763987528813,22caf0af068a091156465524c89c17c5f3c815cea362405a9ab8c1f4e82ccba1
cache/webpack/client-development/7.pack.gz,1763983814599,98e647b9a55f43f38005c38f3ee5a5487a98ba64dbc9638eb2fca57530c61506
cache/webpack/client-development/1.pack.gz,1763990016627,20c3229ba3dd2a052bc3ad8949ecc5be9bad8a9c72e0b41cdddf471d2eb24eea
cache/webpack/client-development/8.pack.gz,1763983997981,66ae1347be96206145361fa304a1fe57a826a4e5a04c56e5ac3df2ee8d89d2be
cache/webpack/client-development/5.pack.gz,1763945324748,505c70bb2acfb85da18bf8d7e24b17fce54b57aa36716f653191abacb7a15b08
cache/webpack/client-development/19.pack.gz,1763987669403,25aa2f30e282fd12a9e29dab8a86f4e9be4ff3f3b4dba37eca1166817ca1baa4
cache/webpack/client-development/4.pack.gz,1763988536836,733ff9ece11cdd38504cf809ec97e4a65d24adad77093589fd7317224020b2b5
cache/webpack/client-development/10.pack.gz,1764025787234,283a69de3a025bbe55f3f6807ef44a08299fd5cabcbc7e72033fbc9426658af4
cache/webpack/client-development/2.pack.gz,1763942931149,6b697172bbde5161c5e917cc0c4fe84214decdf303778b260285612b753480b8
cache/webpack/client-development/20.pack.gz,1763986671864,760fe4ccd7765c8166608397a1346525c1bb9154a7a061501712b1a77413291b
cache/webpack/client-production/6.pack,1764026717134,fd9dbc57ea55aca90888ddb84ac8c6f5ea9b4cc3a495c2ba2f22d2f4118c6a4d
cache/webpack/client-development/3.pack.gz,1764023831064,9d9368d90de2535715bd0edf4a48453e135abce85afccce08f9a4382fad51e3c
cache/webpack/client-development-fallback/0.pack.gz,1763921497803,c97aaf6f15fa631a6664be64d4c9cf42945fa7e05595920edd7fb24ea1a9c2fd
cache/webpack/server-production/0.pack,1764026706676,8d8e8dfd045c0535d1fe3571d15e1a82fd2d5f1b4b0d56419dabc5650df37d7a
cache/webpack/client-development/25.pack.gz,1763894293590,7538527500128b39b36e55f3e63eb1d48e5aea4bc1e91f74d510a9415eb5d54c
cache/webpack/server-development/14.pack.gz,1764024289034,45edb5b8908cc95ba77914137c1ba47da29fa0120ea9d7af464b1573e6ad8ff8
cache/webpack/client-development/23.pack.gz,1763986672120,fc4708bebdd6f16423170a4b9d7ceb88231b67e0c1bde408758d3f46b4353f4e
cache/webpack/server-production/3.pack,1764026706769,b043e64e56d8c46d1717601643778a12dba1d7586e1155a6fc5612feed533b78
cache/webpack/client-production/0.pack,1764026717221,2e4a71900671a280a59332cd93725570040238a7c09ba8c0b846e01ae8aa3a30
````

## File: app/admin/login/page.tsx
````typescript
"use client";

import { useState, FormEvent } from "react";
import Link from "next/link";
import { useRouter } from "next/navigation";
import {
  signInWithEmailAndPassword,
  GoogleAuthProvider,
  signInWithPopup,
} from "firebase/auth";
import { auth } from "@/lib/firebase";

export default function AdminLoginPage() {
  // Simples √©tats de formulaire et de soumission
  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [submitting, setSubmitting] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const router = useRouter();

  const mapFirebaseError = (code?: string) => {
    switch (code) {
      case "auth/invalid-email":
        return "Adresse email invalide.";
      case "auth/user-not-found":
      case "auth/wrong-password":
        return "Email ou mot de passe incorrect.";
      case "auth/user-disabled":
        return "Ce compte a √©t√© d√©sactiv√©. Contacte l‚Äôadministrateur.";
      case "auth/popup-closed-by-user":
        return "Connexion annul√©e.";
      default:
        return "Impossible de te connecter. R√©essaie dans un instant.";
    }
  };

  const handleSubmit = async (e: FormEvent) => {
    e.preventDefault();
    setError(null);
    setSubmitting(true);

    try {
      const cred = await signInWithEmailAndPassword(auth, email, password);
      console.log("Admin login success (email/password):", cred.user.uid);

      // Redirection vers le dashboard admin (√† adapter si besoin)
      router.push("/admin/dashboard");
    } catch (err: any) {
      console.error(err);
      const msg = mapFirebaseError(err?.code);
      setError(msg);
    } finally {
      setSubmitting(false);
    }
  };

  const handleGoogleLogin = async () => {
    setError(null);
    setSubmitting(true);

    try {
      const provider = new GoogleAuthProvider();
      provider.setCustomParameters({
        prompt: "select_account",
      });

      const result = await signInWithPopup(auth, provider);
      console.log("Admin login success (Google):", result.user.uid);

      // Redirection vers le dashboard admin (√† adapter si besoin)
      router.push("/admin/dashboard");
    } catch (err: any) {
      console.error(err);
      const msg = mapFirebaseError(err?.code);
      setError(msg);
    } finally {
      setSubmitting(false);
    }
  };

  return (
    <div className="min-h-screen flex flex-col bg-slate-950 text-slate-100">
      {/* Navbar (Minimal Admin Header) */}
      <header className="border-b border-slate-800/80 bg-slate-950/80 backdrop-blur">
        <div className="max-w-5xl mx-auto px-4 sm:px-6 py-3 flex items-center justify-between gap-3">
          <div className="flex items-center gap-2">
            <div className="w-8 h-8 rounded-xl bg-gradient-to-br from-red-500 to-red-400 flex items-center justify-center text-[10px] font-semibold text-slate-950 shadow-lg shadow-red-500/40">
              AD
            </div>
            <div className="flex flex-col">
              <span className="text-[10px] uppercase tracking-[0.18em] text-slate-400">
                Acc√®s r√©serv√©
              </span>
              <span className="text-xs font-medium text-slate-100">
                Administration
              </span>
            </div>
          </div>
          <Link
            href="/login" // Lien de retour vers la connexion utilisateur classique
            className="px-2 py-1 rounded-full border border-slate-700/80 hover:border-red-500/80 text-slate-300 hover:text-red-300 transition-colors text-[11px]"
          >
            ‚Üê Retour Client
          </Link>
        </div>
      </header>

      {/* CONTENU PRINCIPAL - Centr√© */}
      <main className="flex-1 flex items-center justify-center px-4 py-6">
        <div className="glass max-w-sm w-full p-6 sm:p-7 rounded-2xl border border-slate-800 bg-slate-950/80 shadow-2xl shadow-red-900/40">
          <div className="mb-5">
            <p className="inline-flex items-center gap-2 rounded-full bg-slate-900/80 border border-slate-700 px-3 py-1 mb-2">
              <span className="text-xs text-red-400">üö®</span>
              <span className="text-[11px] uppercase tracking-[0.18em] text-slate-300">
                Acc√®s Admin
              </span>
            </p>
            <h1 className="text-lg sm:text-xl font-semibold text-slate-50">
              Connexion administrateur
            </h1>
            <p className="text-xs text-slate-400 mt-1">
              Veuillez utiliser vos identifiants de s√©curit√©.
            </p>
          </div>

          {error && (
            <div className="mb-4 rounded-lg border border-red-500/70 bg-red-500/10 px-3 py-2 text-[11px] text-red-100">
              {error}
            </div>
          )}

          {/* FORMULAIRE */}
          <form onSubmit={handleSubmit} className="space-y-4 text-sm">
            <div>
              <label className="block mb-1 text-xs text-slate-300">
                Email
              </label>
              <input
                type="email"
                required
                className="w-full rounded-lg bg-slate-900/80 border border-slate-700 px-3 py-2 text-xs text-slate-100 placeholder:text-slate-500 outline-none focus:ring-1 focus:ring-red-500 focus:border-red-500"
                placeholder="admin@example.com"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                disabled={submitting}
              />
            </div>

            <div>
              <label className="block mb-1 text-xs text-slate-300">
                Mot de passe
              </label>
              <input
                type="password"
                required
                className="w-full rounded-lg bg-slate-900/80 border border-slate-700 px-3 py-2 text-xs text-slate-100 placeholder:text-slate-500 outline-none focus:ring-1 focus:ring-red-500 focus:border-red-500"
                placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                disabled={submitting}
              />
              {/* Le lien "Mot de passe oubli√© ?" est intentionnellement omis ici */}
            </div>

            <button
              type="submit"
              disabled={submitting}
              className="w-full inline-flex items-center justify-center rounded-lg bg-red-600 hover:bg-red-700 disabled:opacity-60 disabled:cursor-not-allowed text-xs font-medium text-white px-3 py-2 transition-colors mt-2"
            >
              {submitting ? "Connexion en cours..." : "Se connecter"}
            </button>
          </form>

          {/* S√©parateur */}
          <div className="flex items-center gap-3 my-4">
            <div className="h-px flex-1 bg-slate-800" />
            <span className="text-[10px] text-slate-500 uppercase tracking-[0.18em]">
              ou
            </span>
            <div className="h-px flex-1 bg-slate-800" />
          </div>

          {/* BOUTON GOOGLE */}
          <button
            type="button"
            onClick={handleGoogleLogin}
            disabled={submitting}
            className="w-full inline-flex items-center justify-center gap-2 rounded-lg bg-slate-900/80 hover:bg-slate-900 disabled:opacity-60 disabled:cursor-not-allowed border border-slate-700 px-3 py-2 text-xs font-medium text-slate-100 transition-colors"
          >
            {/* Ic√¥ne Google minimaliste (SVG) */}
            <span className="w-4 h-4 rounded-sm bg-white flex items-center justify-center">
              <span className="text-[11px] font-bold text-slate-900">G</span>
            </span>
            <span>
              {submitting
                ? "Connexion en cours..."
                : "Se connecter avec Google"}
            </span>
          </button>
        </div>
      </main>
    </div>
  );
}
````

## File: app/admin/logs/page.tsx
````typescript
"use client";

import { useEffect, useState } from "react";
import { motion } from "framer-motion";
import { db } from "@/lib/firebase";
import {
  collection,
  getDocs,
  limit,
  orderBy,
  query,
} from "firebase/firestore";
import { useAdminGuard } from "@/hooks/useAdminGuard";

interface UsageLogRow {
  id: string;
  userId: string;
  email?: string | null;
  type: string;
  createdAt?: Date | null;
  meta?: any;
}

function formatDateTime(date?: Date | null): string {
  if (!date) return "‚Äî";
  return date.toLocaleString("fr-FR", {
    dateStyle: "short",
    timeStyle: "short",
  });
}

export default function AdminLogsPage() {
  const { loading, isAdmin } = useAdminGuard();
  const [logs, setLogs] = useState<UsageLogRow[]>([]);
  const [loadingLogs, setLoadingLogs] = useState(true);

  useEffect(() => {
    if (!isAdmin || loading) return;

    const fetchLogs = async () => {
      try {
        const q = query(
          collection(db, "usageLogs"),
          orderBy("createdAt", "desc"),
          limit(200)
        );
        const snap = await getDocs(q);
        const rows: UsageLogRow[] = snap.docs.map((d) => {
          const data = d.data() as any;
          const createdAt =
            data.createdAt?.toDate?.() &&
            typeof data.createdAt.toDate === "function"
              ? data.createdAt.toDate()
              : null;

          return {
            id: d.id,
            userId: data.userId ?? "‚Äî",
            email: data.email ?? null,
            type: data.type ?? "‚Äî",
            createdAt,
            meta: data.meta ?? {},
          };
        });
        setLogs(rows);
      } catch (err) {
        console.error("Erreur chargement logs:", err);
      } finally {
        setLoadingLogs(false);
      }
    };

    fetchLogs();
  }, [loading, isAdmin]);

  if (loading) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <p className="text-xs text-[var(--muted)]">
          Chargement de l&apos;admin‚Ä¶
        </p>
      </div>
    );
  }

  if (!isAdmin) return null;

  return (
    <div className="min-h-screen px-4 sm:px-8 py-6 bg-[var(--bg)] text-[var(--ink)]">
      <div className="max-w-6xl mx-auto flex flex-col gap-4">
        <motion.div
          initial={{ opacity: 0, y: 10 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.25 }}
        >
          <h1 className="text-xl sm:text-2xl font-semibold">
            Logs d&apos;utilisation
          </h1>
          <p className="text-xs sm:text-sm text-[var(--muted)] mt-1 max-w-xl">
            Historique des actions des utilisateurs (g√©n√©ration de CV, LM,
            etc.).
          </p>
        </motion.div>

        <motion.div
          initial={{ opacity: 0, y: 10 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.25, delay: 0.05 }}
          className="glass rounded-2xl p-4 overflow-x-auto"
        >
          {loadingLogs ? (
            <p className="text-[12px] text-[var(--muted)]">
              Chargement des logs‚Ä¶
            </p>
          ) : logs.length === 0 ? (
            <p className="text-[12px] text-[var(--muted)]">
              Aucun log pour le moment.
            </p>
          ) : (
            <table className="w-full text-[11px] sm:text-xs">
              <thead className="text-[10px] uppercase tracking-[0.18em] text-[var(--muted)]">
                <tr className="text-left border-b border-[var(--border)]">
                  <th className="py-2 pr-2">Date</th>
                  <th className="py-2 pr-2">User</th>
                  <th className="py-2 pr-2">Type</th>
                  <th className="py-2 pr-2">Meta</th>
                </tr>
              </thead>
              <tbody>
                {logs.map((log) => (
                  <tr
                    key={log.id}
                    className="border-b border-[var(--border)]/60 last:border-none align-top"
                  >
                    <td className="py-2 pr-2">
                      {formatDateTime(log.createdAt)}
                    </td>
                    <td className="py-2 pr-2">
                      <div className="flex flex-col">
                        <span className="font-medium text-[11px]">
                          {log.email || "‚Äî"}
                        </span>
                        <span className="text-[10px] text-[var(--muted)]">
                          UID: {log.userId?.slice(0, 8) || "‚Äî"}‚Ä¶
                        </span>
                      </div>
                    </td>
                    <td className="py-2 pr-2">
                      <span className="inline-flex px-2 py-[2px] rounded-full border border-[var(--border)] text-[10px]">
                        {log.type}
                      </span>
                    </td>
                    <td className="py-2 pr-2 max-w-xs">
                      <pre className="text-[10px] whitespace-pre-wrap break-words text-[var(--muted)]">
                        {JSON.stringify(log.meta ?? {}, null, 2)}
                      </pre>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          )}
        </motion.div>
      </div>
    </div>
  );
}
````

## File: app/admin/page.tsx
````typescript
// app/admin/page.tsx
"use client";

import { useEffect, useState, useRef } from "react";
import { motion } from "framer-motion";
import { db } from "@/lib/firebase";
import {
  collection,
  onSnapshot,
  doc,
  updateDoc,
  query,
  orderBy,
  limit,
  deleteDoc,
} from "firebase/firestore";
import Chart from "chart.js/auto";
import { useAdminGuard } from "@/hooks/useAdminGuard";
import { useAuth } from "@/context/AuthContext";

type AdminUser = {
  id: string;
  email: string;
  displayName?: string | null;
  createdAt?: number | null;
  lastLoginAt?: number | null;
  lastSeenAt?: number | null;
  lastSeenPage?: string | null;
  credits?: number;
  blocked?: boolean;
  emailVerified?: boolean;
  provider?: string;

  role?: string | null;

  lastIp?: string | null;
  country?: string | null;
  city?: string | null;

  lastAction?: string | null;
  lastActionAt?: number | null;
  lastDeviceType?: string | null; // "iphone" | "ipad" | "mac" | "mobile" | "tablet" | "desktop" | ...
  lastOs?: string | null;
  lastBrowser?: string | null;

  totalIaCalls?: number | null;
  totalCvGenerated?: number | null;
  totalLmGenerated?: number | null;
  totalDocumentsGenerated?: number | null;

  authFailedCount?: number | null;
};

type UsageLog = {
  id: string;
  userId: string;
  email?: string | null;
  action: string;
  tool?: string | null;
  docType?: string | null;
  eventType?: string | null;
  createdAt?: number | null;

  ip?: string | null;
  country?: string | null;
  city?: string | null;
  path?: string | null;
  creditsDelta?: number | null;

  deviceType?: string | null;
  os?: string | null;
  browser?: string | null;
};

function formatDate(ts?: number | null) {
  if (!ts) return "‚Äî";
  const d = new Date(ts);
  return new Intl.DateTimeFormat("fr-FR", {
    day: "2-digit",
    month: "short",
    year: "numeric",
    hour: "2-digit",
    minute: "2-digit",
  }).format(d);
}

function formatRelative(ts?: number | null): string {
  if (!ts) return "Jamais vu¬∑e";
  const now = Date.now();
  const diffMs = now - ts;
  if (diffMs < 0) return "Dans le futur ü§î";

  const diffSec = Math.floor(diffMs / 1000);
  if (diffSec < 60) return `Il y a ${diffSec}s`;

  const diffMin = Math.floor(diffSec / 60);
  if (diffMin < 60) return `Il y a ${diffMin} min`;

  const diffH = Math.floor(diffMin / 60);
  if (diffH < 48) return `Il y a ${diffH} h`;

  const diffJ = Math.floor(diffH / 24);
  return `Il y a ${diffJ} j`;
}

function getPresence(lastSeenAt?: number | null) {
  if (!lastSeenAt) {
    return {
      label: "Jamais vu¬∑e",
      dotClass: "bg-slate-500",
      badgeClass:
        "bg-slate-500/10 text-slate-200 border border-slate-500/40",
    };
  }

  const now = Date.now();
  const diff = now - lastSeenAt;

  if (diff < 2 * 60 * 1000) {
    return {
      label: "En ligne",
      dotClass: "bg-emerald-400",
      badgeClass:
        "bg-emerald-500/10 text-emerald-200 border border-emerald-500/50",
    };
  }

  if (diff < 60 * 60 * 1000) {
    return {
      label: formatRelative(lastSeenAt),
      dotClass: "bg-amber-400",
      badgeClass:
        "bg-amber-500/10 text-amber-200 border border-amber-500/40",
    };
  }

  return {
    label: formatRelative(lastSeenAt),
    dotClass: "bg-slate-400",
    badgeClass:
      "bg-slate-500/10 text-slate-200 border border-slate-500/40",
  };
}

function getCountryFlag(country?: string | null): string {
  if (!country) return "üè≥Ô∏è";
  const c = country.toLowerCase();

  if (c.includes("france")) return "üá´üá∑";
  if (c.includes("belgique") || c.includes("belgium")) return "üáßüá™";
  if (c.includes("suisse") || c.includes("switzerland")) return "üá®üá≠";
  if (c.includes("canada")) return "üá®üá¶";
  if (c.includes("maroc")) return "üá≤üá¶";
  if (c.includes("tunisie") || c.includes("tunisia")) return "üáπüá≥";
  if (c.includes("alg√©rie") || c.includes("algerie")) return "üá©üáø";
  if (c.includes("luxembourg")) return "üá±üá∫";

  if (
    c.includes("united states") ||
    c.includes("usa") ||
    c.includes("√©tats-unis") ||
    c.includes("etats-unis")
  )
    return "üá∫üá∏";
  if (c.includes("spain") || c.includes("espagne")) return "üá™üá∏";
  if (c.includes("germany") || c.includes("allemagne")) return "üá©üá™";
  if (c.includes("italy") || c.includes("italie")) return "üáÆüáπ";
  if (c.includes("portugal")) return "üáµüáπ";
  if (c.includes("netherlands") || c.includes("pays-bas")) return "üá≥üá±";
  if (
    c.includes("united kingdom") ||
    c.includes("uk") ||
    c.includes("royaume-uni")
  )
    return "üá¨üáß";

  return "üåç";
}

// Traduction du path en section lisible
function getPageLabel(path?: string | null): string {
  if (!path) return "Inconnu";
  const [clean] = path.split("?");
  if (!clean) return "Inconnu";

  if (clean === "/" || clean === "/app") return "Accueil (app)";
  if (clean.startsWith("/lm")) return "Lettre de motivation IA";
  if (
    clean.startsWith("/applications") ||
    clean.startsWith("/tracker") ||
    clean.startsWith("/suivi")
  )
    return "Suivi de candidatures";
  if (clean.startsWith("/credits")) return "Page cr√©dits";
  if (clean.startsWith("/login") || clean.startsWith("/signup"))
    return "Connexion / Inscription";
  if (clean.startsWith("/admin")) return "Administration";
  if (clean.startsWith("/profil") || clean.startsWith("/profile"))
    return "Profil candidat";

  return clean;
}

// Affichage lisible du device, avec diff√©renciation iPhone / iPad / macOS
function formatDevice(
  deviceType?: string | null,
  os?: string | null
): string {
  if (!deviceType && !os) return "‚Äî";

  let label: string;

  switch (deviceType) {
    case "iphone":
      label = "üì± iPhone";
      break;
    case "ipad":
      label = "üì± iPad";
      break;
    case "mac":
      label = "üíª macOS";
      break;
    case "mobile":
      label = "üì± Mobile";
      break;
    case "tablet":
      label = "üì± Tablette";
      break;
    case "desktop":
      label = "üñ• Desktop";
      break;
    default:
      label = "‚ùì Appareil";
  }

  if (os) label += ` ¬∑ ${os}`;

  return label;
}

export default function AdminDashboardPage() {
  const { loading, isAdmin } = useAdminGuard();
  const { logout } = useAuth();

  const [users, setUsers] = useState<AdminUser[]>([]);
  const [loadingUsers, setLoadingUsers] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [editingCredits, setEditingCredits] = useState<
    Record<string, string>
  >({});
  const [updatingIds, setUpdatingIds] = useState<Record<string, boolean>>(
    {}
  );

  const [activeTab, setActiveTab] = useState<"users" | "logs">("users");

  const [usageLogs, setUsageLogs] = useState<UsageLog[]>([]);
  const [loadingLogs, setLoadingLogs] = useState(false);

  // üîé nouveau : filtre sur les logs (tous / seulement auth_failed)
  const [logFilter, setLogFilter] = useState<"all" | "auth_failed">("all");

  // Chart.js pour les logs
  const logsChartRef = useRef<HTMLCanvasElement | null>(null);
  const [logsChart, setLogsChart] = useState<Chart | null>(null);

  // --- USERS SUB ---
  useEffect(() => {
    if (!isAdmin) {
      setUsers([]);
      setLoadingUsers(false);
      return;
    }

    setLoadingUsers(true);

    const unsub = onSnapshot(
      collection(db, "users"),
      (snap) => {
        const list: AdminUser[] = snap.docs.map((d) => {
          const data = d.data() as any;
          return {
            id: d.id,
            email: data.email || "‚Äî",
            displayName: data.displayName || null,
            createdAt:
              typeof data.createdAt === "number" ? data.createdAt : null,
            lastLoginAt:
              typeof data.lastLoginAt === "number"
                ? data.lastLoginAt
                : null,
            lastSeenAt:
              typeof data.lastSeenAt === "number" ? data.lastSeenAt : null,
            lastSeenPage: data.lastSeenPage || null,
            credits:
              typeof data.credits === "number"
                ? data.credits
                : data.credits ?? 0,
            blocked: !!data.blocked,
            emailVerified: !!data.emailVerified,
            provider: data.provider || "",

            role: data.role || (data.isAdmin ? "admin" : "user"),

            lastIp: data.lastSeenIp || null,
            country: data.lastSeenCountry || null,
            city: data.lastSeenCity || null,
            lastAction: data.lastAction || null,
            lastActionAt:
              typeof data.lastActionAt === "number"
                ? data.lastActionAt
                : null,
            lastDeviceType: data.lastDeviceType || null,
            lastOs: data.lastOs || null,
            lastBrowser: data.lastBrowser || null,

            totalIaCalls:
              typeof data.totalIaCalls === "number"
                ? data.totalIaCalls
                : null,
            totalCvGenerated:
              typeof data.totalCvGenerated === "number"
                ? data.totalCvGenerated
                : null,
            totalLmGenerated:
              typeof data.totalLmGenerated === "number"
                ? data.totalLmGenerated
                : null,
            totalDocumentsGenerated:
              typeof data.totalDocumentsGenerated === "number"
                ? data.totalDocumentsGenerated
                : null,
            authFailedCount:
              typeof data.authFailedCount === "number"
                ? data.authFailedCount
                : null,
          };
        });

        list.sort((a, b) => {
          const ta = a.createdAt || 0;
          const tb = b.createdAt || 0;
          return tb - ta;
        });

        setUsers(list);
        setLoadingUsers(false);
        setError(null);
      },
      (err) => {
        console.error("Erreur onSnapshot(users):", err);
        setError("Impossible de charger les utilisateurs.");
        setLoadingUsers(false);
      }
    );

    return () => {
      unsub();
    };
  }, [isAdmin]);

  // --- USAGE LOGS SUB ---
  useEffect(() => {
    if (!isAdmin || activeTab !== "logs") {
      setUsageLogs([]);
      setLoadingLogs(false);
      return;
    }

    setLoadingLogs(true);

    const qLogs = query(
      collection(db, "usageLogs"),
      orderBy("createdAt", "desc"),
      limit(200)
    );

    const unsub = onSnapshot(
      qLogs,
      (snap) => {
        const list: UsageLog[] = snap.docs.map((d) => {
          const data = d.data() as any;
          return {
            id: d.id,
            userId: data.userId,
            email: data.email ?? null,
            action: data.action || "‚Äî",
            tool: data.tool ?? null,
            docType: data.docType ?? null,
            eventType: data.eventType ?? null,
            createdAt:
              typeof data.createdAt === "number"
                ? data.createdAt
                : null,
            ip: data.ip ?? null,
            country: data.country ?? null,
            city: data.city ?? null,
            path: data.path ?? null,
            creditsDelta:
              typeof data.creditsDelta === "number"
                ? data.creditsDelta
                : null,
            deviceType: data.deviceType ?? null,
            os: data.os ?? null,
            browser: data.browser ?? null,
          };
        });

        setUsageLogs(list);
        setLoadingLogs(false);
      },
      (err) => {
        console.error("Erreur onSnapshot(usageLogs):", err);
        setLoadingLogs(false);
      }
    );

    return () => {
      unsub();
    };
  }, [isAdmin, activeTab]);

  // --- CHARTS SUR LES LOGS (LM / CV par jour) ---
  useEffect(() => {
    if (activeTab !== "logs") return;
    if (!logsChartRef.current) return;

    const ctx = logsChartRef.current.getContext("2d");
    if (!ctx) return;

    if (logsChart) {
      logsChart.destroy();
    }

    if (usageLogs.length === 0) {
      setLogsChart(null);
      return;
    }

    const byDate: Record<
      string,
      { total: number; lm: number; cv: number }
    > = {};

    usageLogs.forEach((log) => {
      if (!log.createdAt) return;
      const d = new Date(log.createdAt);
      const key = d.toISOString().slice(0, 10); // YYYY-MM-DD

      if (!byDate[key]) {
        byDate[key] = { total: 0, lm: 0, cv: 0 };
      }

      byDate[key].total += 1;

      if (log.docType === "lm") {
        byDate[key].lm += 1;
      } else if (log.docType === "cv") {
        byDate[key].cv += 1;
      }
    });

    const labels = Object.keys(byDate).sort();
    const totalData = labels.map((k) => byDate[k].total);
    const lmData = labels.map((k) => byDate[k].lm);
    const cvData = labels.map((k) => byDate[k].cv);

    const chart = new Chart(ctx, {
      type: "line",
      data: {
        labels,
        datasets: [
          {
            label: "Total appels IA",
            data: totalData,
            borderWidth: 2,
            tension: 0.3,
          },
          {
            label: "LM g√©n√©r√©es",
            data: lmData,
            borderWidth: 2,
            tension: 0.3,
          },
          {
            label: "CV g√©n√©r√©s",
            data: cvData,
            borderWidth: 2,
            tension: 0.3,
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            labels: {
              color: "#e5e7eb",
              font: { size: 11 },
            },
          },
        },
        scales: {
          x: {
            ticks: { color: "#9ca3af", font: { size: 10 } },
            grid: { color: "rgba(55,65,81,0.4)" },
          },
          y: {
            ticks: { color: "#9ca3af", font: { size: 10 } },
            grid: { color: "rgba(55,65,81,0.4)" },
          },
        },
      },
    });

    setLogsChart(chart);

    return () => {
      chart.destroy();
    };
  }, [usageLogs, activeTab]);

  // --- ACTIONS ADMIN ---

  const handleSaveCredits = async (u: AdminUser) => {
    const raw = editingCredits[u.id];
    if (raw == null) return;

    const parsed = Number(raw);
    if (Number.isNaN(parsed)) {
      alert("Merci de saisir un nombre valide.");
      return;
    }

    try {
      setUpdatingIds((prev) => ({ ...prev, [u.id]: true }));
      const ref = doc(db, "users", u.id);
      await updateDoc(ref, { credits: parsed });
    } catch (e) {
      console.error("Erreur update credits:", e);
      alert("Erreur en mettant √† jour les cr√©dits.");
    } finally {
      setUpdatingIds((prev) => ({ ...prev, [u.id]: false }));
    }
  };

  const handleToggleBlocked = async (u: AdminUser) => {
    try {
      setUpdatingIds((prev) => ({ ...prev, [u.id]: true }));
      const ref = doc(db, "users", u.id);
      await updateDoc(ref, { blocked: !u.blocked });
    } catch (e) {
      console.error("Erreur toggle blocked:", e);
      alert("Erreur en mettant √† jour le statut de blocage.");
    } finally {
      setUpdatingIds((prev) => ({ ...prev, [u.id]: false }));
    }
  };

  const handleDeleteUser = async (u: AdminUser) => {
    const sure = window.confirm(
      `Supprimer l'utilisateur ${u.email} de Firestore ?\n\n(Le compte Auth ne sera pas supprim√© automatiquement.)`
    );
    if (!sure) return;

    try {
      setUpdatingIds((prev) => ({ ...prev, [u.id]: true }));
      const ref = doc(db, "users", u.id);
      await deleteDoc(ref);
    } catch (e) {
      console.error("Erreur delete user:", e);
      alert("Erreur lors de la suppression de l'utilisateur.");
    } finally {
      setUpdatingIds((prev) => ({ ...prev, [u.id]: false }));
    }
  };

  const handleLogout = async () => {
    try {
      await logout();
      window.location.href = "/login";
    } catch (e) {
      console.error("Erreur logout:", e);
    }
  };

  if (loading) {
    return (
      <div className="min-h-screen flex items-center justify-center text-sm text-slate-300">
        V√©rification des droits admin‚Ä¶
      </div>
    );
  }

  if (!isAdmin) {
    return null;
  }

  const totalCredits = users.reduce(
    (sum, u) => sum + (u.credits ?? 0),
    0
  );
  const blockedCount = users.filter((u) => u.blocked).length;
  const totalDocs = users.reduce(
    (sum, u) => sum + (u.totalDocumentsGenerated ?? 0),
    0
  );

  const lmTotal = users.reduce(
    (sum, u) => sum + (u.totalLmGenerated ?? 0),
    0
  );
  const cvTotal = users.reduce(
    (sum, u) => sum + (u.totalCvGenerated ?? 0),
    0
  );

  const suspiciousLogs = usageLogs.filter(
    (l) => l.action === "auth_failed"
  ).length;

  // üîé on applique le filtre pour le tableau
  const filteredLogs =
    logFilter === "auth_failed"
      ? usageLogs.filter((l) => l.action === "auth_failed")
      : usageLogs;

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-950 via-slate-900 to-slate-950 px-3 sm:px-6 py-5">
      <div className="max-w-7xl mx-auto flex flex-col gap-4">
        {/* HEADER */}
        <motion.header
          initial={{ opacity: 0, y: 10 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.25 }}
          className="flex items-center justify-between gap-3"
        >
          <div>
            <p className="inline-flex items-center gap-1.5 rounded-full border border-sky-500/30 bg-sky-500/10 px-2 py-[3px]">
              <span className="w-1.5 h-1.5 rounded-full bg-emerald-400" />
              <span className="text-[11px] uppercase tracking-[0.18em] text-sky-100/80">
                Espace admin
              </span>
            </p>
            <h1 className="mt-2 text-xl sm:text-2xl font-semibold text-white">
              Tableau de bord administrateur
            </h1>
            <p className="text-xs sm:text-sm text-slate-300/80 mt-1 max-w-xl">
              Vue globale sur les comptes, la localisation des utilisateurs,
              les documents IA g√©n√©r√©s et les appels √† l&apos;assistant.
            </p>
          </div>

          <div className="flex items-center gap-2">
            <button
              type="button"
              className="hidden sm:inline-flex items-center gap-1.5 rounded-full border border-slate-700 bg-slate-900/60 px-3 py-1.5 text-[11px] text-slate-200"
            >
              <span className="w-2 h-2 rounded-full bg-emerald-400 animate-pulse" />
              <span>Admin connect√©</span>
            </button>
            <button
              type="button"
              onClick={handleLogout}
              className="inline-flex items-center gap-1.5 rounded-full bg-slate-100 text-slate-900 px-3 py-1.5 text-[12px] font-medium hover:bg-white transition-colors"
            >
              <span>Se d√©connecter</span>
              <span className="text-[13px]">‚Ü©</span>
            </button>
          </div>
        </motion.header>

        {/* TABS */}
        <div className="flex items-center gap-2 border-b border-slate-800/80">
          <button
            type="button"
            onClick={() => setActiveTab("users")}
            className={`relative px-3 py-2 text-[12px] sm:text-[13px] ${
              activeTab === "users"
                ? "text-white"
                : "text-slate-400 hover:text-slate-200"
            }`}
          >
            Utilisateurs
            {activeTab === "users" && (
              <span className="absolute inset-x-2 -bottom-px h-[2px] rounded-full bg-sky-400" />
            )}
          </button>
          <button
            type="button"
            onClick={() => setActiveTab("logs")}
            className={`relative px-3 py-2 text-[12px] sm:text-[13px] ${
              activeTab === "logs"
                ? "text-white"
                : "text-slate-400 hover:text-slate-200"
            }`}
          >
            Logs IA
            {activeTab === "logs" && (
              <span className="absolute inset-x-2 -bottom-px h-[2px] rounded-full bg-sky-400" />
            )}
          </button>
        </div>

        {/* ONGLET UTILISATEURS */}
        {activeTab === "users" && (
          <>
            {/* STATS RAPIDES */}
            <div className="grid gap-3 md:grid-cols-4">
              <div className="rounded-2xl border border-slate-800 bg-slate-900/70 p-4 shadow-sm shadow-sky-500/5">
                <p className="text-[11px] uppercase tracking-[0.18em] text-slate-400 mb-1">
                  Utilisateurs
                </p>
                <p className="text-2xl font-semibold text-white">
                  {loadingUsers ? "‚Ä¶" : users.length}
                </p>
                <p className="text-[11px] text-slate-400">
                  Nombre total de comptes dans{" "}
                  <code className="text-sky-300">users</code>.
                </p>
              </div>

              <div className="rounded-2xl border border-slate-800 bg-slate-900/70 p-4 shadow-sm shadow-sky-500/5">
                <p className="text-[11px] uppercase tracking-[0.18em] text-slate-400 mb-1">
                  Utilisateurs bloqu√©s
                </p>
                <p className="text-2xl font-semibold text-white">
                  {loadingUsers ? "‚Ä¶" : blockedCount}
                </p>
                <p className="text-[11px] text-slate-400">
                  Comptes avec{" "}
                  <code className="text-sky-300">blocked = true</code>.
                </p>
              </div>

              <div className="rounded-2xl border border-slate-800 bg-slate-900/70 p-4 shadow-sm shadow-sky-500/5">
                <p className="text-[11px] uppercase tracking-[0.18em] text-slate-400 mb-1">
                  Cr√©dits totaux
                </p>
                <p className="text-2xl font-semibold text-white">
                  {loadingUsers ? "‚Ä¶" : totalCredits}
                </p>
                <p className="text-[11px] text-slate-400">
                  Somme de tous les cr√©dits utilisateurs.
                </p>
              </div>

              <div className="rounded-2xl border border-slate-800 bg-slate-900/70 p-4 shadow-sm shadow-sky-500/5">
                <p className="text-[11px] uppercase tracking-[0.18em] text-slate-400 mb-1">
                  Docs IA g√©n√©r√©s
                </p>
                <p className="text-2xl font-semibold text-white">
                  {loadingUsers ? "‚Ä¶" : totalDocs}
                </p>
                <p className="text-[11px] text-slate-400">
                  LM: {lmTotal} ¬∑ CV: {cvTotal}
                </p>
              </div>
            </div>

            {/* TABLE UTILISATEURS */}
            <div className="rounded-2xl border border-slate-800 bg-slate-950/80 p-4 sm:p-5 shadow-inner shadow-black/40">
              <div className="flex items-center justify-between mb-3 gap-2">
                <h2 className="text-sm sm:text-base font-semibold text-white">
                  Liste des utilisateurs
                </h2>
                {loadingUsers && (
                  <span className="text-[11px] text-slate-400">
                    Chargement‚Ä¶
                  </span>
                )}
              </div>

              {error && (
                <div className="mb-3 rounded-lg border border-red-500/40 bg-red-500/10 px-3 py-2 text-[11px] text-red-100">
                  {error}
                </div>
              )}

              {!loadingUsers && users.length === 0 && !error && (
                <p className="text-[12px] text-slate-400">
                  Aucun utilisateur trouv√© dans{" "}
                  <code className="text-sky-300">users</code>.
                  <br />
                  V√©rifie que ta fonction{" "}
                  <code className="text-sky-300">upsertUserOnLogin</code> est
                  bien appel√©e apr√®s chaque connexion.
                </p>
              )}

              {users.length > 0 && (
                <div className="overflow-x-auto mt-2">
                  <table className="w-full text-[11px] sm:text-[12px] border-collapse">
                    <thead>
                      <tr className="text-slate-400 border-b border-slate-800">
                        <th className="text-left py-2 pr-3">Utilisateur</th>
                        <th className="text-left py-2 pr-3 hidden sm:table-cell">
                          Localisation / Appareil
                        </th>
                        <th className="text-left py-2 pr-3">Cr√©dits</th>
                        <th className="text-left py-2 pr-3">Statut</th>
                        <th className="text-left py-2 pr-3 hidden md:table-cell">
                          Dernier login
                        </th>
                        <th className="text-left py-2 pr-3 hidden lg:table-cell">
                          Derni√®re activit√©
                        </th>
                        <th className="text-left py-2 pl-3">Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      {users.map((u) => {
                        const isUpdating = !!updatingIds[u.id];
                        const creditsValue =
                          editingCredits[u.id] ?? String(u.credits ?? 0);
                        const presence = getPresence(u.lastSeenAt);

                        const flag = getCountryFlag(u.country);
                        const pageLabel = getPageLabel(u.lastSeenPage);

                        return (
                          <tr
                            key={u.id}
                            className="border-b border-slate-800/70 hover:bg-slate-900/60"
                          >
                            {/* Utilisateur */}
                            <td className="py-2 pr-3 align-top">
                              <div className="flex flex-col gap-0.5">
                                <span className="font-medium text-[13px] text-white">
                                  {u.email}
                                </span>
                                <span className="text-[10px] text-slate-400">
                                  UID: {u.id}
                                </span>
                                <span className="text-[10px] text-slate-400">
                                  {u.displayName || "‚Äî"}{" "}
                                  <span className="ml-1">
                                    {u.provider || "password"}
                                    {u.emailVerified
                                      ? " ¬∑ ‚úÖ v√©rifi√©"
                                      : " ¬∑ ‚ö†Ô∏è non v√©rifi√©"}
                                  </span>
                                </span>
                                {u.role && (
                                  <span className="inline-flex w-fit mt-0.5 rounded-full border border-sky-500/50 bg-sky-500/10 px-2 py-[1px] text-[10px] text-sky-200">
                                    R√¥le : {u.role}
                                  </span>
                                )}
                              </div>
                            </td>

                            {/* Localisation + device + page */}
                            <td className="py-2 pr-3 align-top hidden sm:table-cell">
                              <div className="flex flex-col gap-0.5 text-slate-200">
                                <div className="flex items-center gap-1.5">
                                  <span className="text-lg">{flag}</span>
                                  <span>
                                    {u.city || u.country
                                      ? `${u.city ?? ""}${
                                          u.city && u.country ? " ¬∑ " : ""
                                        }${u.country ?? ""}`
                                      : "‚Äî"}
                                  </span>
                                </div>
                                {u.lastIp && (
                                  <span className="text-[10px] text-slate-400">
                                    IP: {u.lastIp}
                                  </span>
                                )}
                                <span className="text-[10px] text-slate-400">
                                  {formatDevice(u.lastDeviceType, u.lastOs)}
                                </span>
                                <span className="text-[10px] text-slate-400">
                                  Section: {pageLabel}
                                </span>
                                {u.lastSeenPage && (
                                  <span className="text-[10px] text-slate-500 line-clamp-1">
                                    Path: {u.lastSeenPage}
                                  </span>
                                )}
                                {u.lastBrowser && (
                                  <span className="text-[10px] text-slate-500">
                                    Navigateur: {u.lastBrowser}
                                  </span>
                                )}
                              </div>
                            </td>

                            {/* Cr√©dits */}
                            <td className="py-2 pr-3 align-top min-w-[90px]">
                              <div className="flex items-center gap-1.5">
                                <input
                                  type="number"
                                  className="w-20 rounded-md border border-slate-700 bg-slate-900 px-1.5 py-1 text-[11px] text-slate-100 outline-none focus:ring-1 focus:ring-sky-500"
                                  value={creditsValue}
                                  onChange={(e) =>
                                    setEditingCredits((prev) => ({
                                      ...prev,
                                      [u.id]: e.target.value,
                                    }))
                                  }
                                />
                                <button
                                  type="button"
                                  onClick={() => handleSaveCredits(u)}
                                  disabled={isUpdating}
                                  className="rounded-md border border-slate-700 bg-slate-900/70 px-2 py-1 text-[10px] text-slate-100 hover:border-sky-500 hover:text-sky-300 disabled:opacity-60"
                                >
                                  {isUpdating ? "‚Ä¶" : "OK"}
                                </button>
                              </div>
                            </td>

                            {/* Statut / IA */}
                            <td className="py-2 pr-3 align-top">
                              <div className="flex flex-col gap-1">
                                <span
                                  className={
                                    "inline-flex items-center gap-1 rounded-full px-2 py-[2px] text-[10px] " +
                                    presence.badgeClass
                                  }
                                >
                                  <span
                                    className={
                                      "w-1.5 h-1.5 rounded-full " +
                                      presence.dotClass
                                    }
                                  />
                                  <span>{presence.label}</span>
                                </span>
                                <span
                                  className={
                                    u.blocked
                                      ? "text-[10px] text-red-300"
                                      : "text-[10px] text-emerald-300"
                                  }
                                >
                                  {u.blocked ? "Bloqu√©" : "Autoris√©"}
                                </span>

                                {(u.totalIaCalls ||
                                  u.totalCvGenerated ||
                                  u.totalLmGenerated) && (
                                  <span className="text-[10px] text-sky-300">
                                    IA: {u.totalIaCalls ?? 0} ¬∑ CV:{" "}
                                    {u.totalCvGenerated ?? 0} ¬∑ LM:{" "}
                                    {u.totalLmGenerated ?? 0}
                                  </span>
                                )}

                                {u.authFailedCount &&
                                  u.authFailedCount > 0 && (
                                    <span className="text-[10px] text-red-300">
                                      ‚ö† {u.authFailedCount} tentatives login
                                      √©chou√©es
                                    </span>
                                  )}

                                {u.lastAction && (
                                  <span className="text-[10px] text-slate-400 line-clamp-1">
                                    Derni√®re action: {u.lastAction}
                                  </span>
                                )}
                              </div>
                            </td>

                            {/* Dernier login */}
                            <td className="py-2 pr-3 align-top hidden md:table-cell text-slate-200">
                              {formatDate(u.lastLoginAt)}
                            </td>

                            {/* Derni√®re activit√© */}
                            <td className="py-2 pr-3 align-top hidden lg:table-cell text-slate-200">
                              {formatDate(u.lastSeenAt)}
                              <div className="text-[10px] text-slate-400">
                                {formatRelative(u.lastSeenAt)}
                              </div>
                            </td>

                            {/* Actions */}
                            <td className="py-2 pl-3 align-top">
                              <div className="flex flex-col gap-1">
                                <button
                                  type="button"
                                  onClick={() => handleToggleBlocked(u)}
                                  disabled={isUpdating}
                                  className={
                                    "inline-flex items-center justify-center rounded-full px-2.5 py-1 text-[10px] border " +
                                    (u.blocked
                                      ? "border-emerald-400/70 text-emerald-200 hover:bg-emerald-500/10"
                                      : "border-red-400/70 text-red-200 hover:bg-red-500/10")
                                  }
                                >
                                  {isUpdating
                                    ? "‚Ä¶"
                                    : u.blocked
                                    ? "D√©bloquer"
                                    : "Bloquer"}
                                </button>
                                <button
                                  type="button"
                                  onClick={() => handleDeleteUser(u)}
                                  disabled={isUpdating}
                                  className="inline-flex items-center justify-center rounded-full px-2.5 py-1 text-[10px] border border-slate-700 text-slate-300 hover:border-red-500 hover:text-red-300 disabled:opacity-60"
                                >
                                  Supprimer
                                </button>
                              </div>
                            </td>
                          </tr>
                        );
                      })}
                    </tbody>
                  </table>
                </div>
              )}
            </div>
          </>
        )}

        {/* ONGLET LOGS */}
        {activeTab === "logs" && (
          <div className="space-y-4">
            {/* STATS + COURBE */}
            <div className="grid gap-3 lg:grid-cols-[2fr,1fr]">
              <div className="rounded-2xl border border-slate-800 bg-slate-950/80 p-4 sm:p-5 shadow-inner shadow-black/40">
                <div className="flex items-center justify-between mb-3 gap-2">
                  <h2 className="text-sm sm:text-base font-semibold text-white">
                    Activit√© IA (LM / CV)
                  </h2>
                  {loadingLogs && (
                    <span className="text-[11px] text-slate-400">
                      Chargement‚Ä¶
                    </span>
                  )}
                </div>
                <div className="relative h-[220px] sm:h-[260px]">
                  <canvas ref={logsChartRef} />
                </div>
              </div>

              <div className="grid gap-3 sm:grid-cols-2 lg:grid-cols-1">
                <div className="rounded-2xl border border-slate-800 bg-slate-950/80 p-4 shadow-inner shadow-black/40">
                  <p className="text-[11px] uppercase tracking-[0.18em] text-slate-400 mb-1">
                    LM g√©n√©r√©es (logs)
                  </p>
                  <p className="text-2xl font-semibold text-white">
                    {usageLogs.filter((l) => l.docType === "lm").length}
                  </p>
                  <p className="text-[11px] text-slate-400">
                    Nombre d&apos;√©v√©nements avec <code>docType = "lm"</code>.
                  </p>
                </div>
                <div className="rounded-2xl border border-slate-800 bg-slate-950/80 p-4 shadow-inner shadow-black/40">
                  <p className="text-[11px] uppercase tracking-[0.18em] text-slate-400 mb-1">
                    Tentatives suspectes
                  </p>
                  <p className="text-2xl font-semibold text-white">
                    {suspiciousLogs}
                  </p>
                  <p className="text-[11px] text-slate-400">
                    Logs avec <code>action = "auth_failed"</code> (√©checs de
                    connexion). √Ä logger c√¥t√© Auth sur chaque erreur de login.
                  </p>
                </div>
              </div>
            </div>

            {/* TABLE DES LOGS */}
            <div className="rounded-2xl border border-slate-800 bg-slate-950/80 p-4 sm:p-5 shadow-inner shadow-black/40">
              <div className="flex items-center justify-between mb-3 gap-2">
                <h2 className="text-sm sm:text-base font-semibold text-white">
                  Logs d&apos;usage IA (derniers 200)
                </h2>
                <div className="flex items-center gap-2">
                  {/* Filtre logs vs auth_failed */}
                  <div className="inline-flex items-center gap-1 rounded-full border border-slate-700 bg-slate-900/80 p-1">
                    <button
                      type="button"
                      onClick={() => setLogFilter("all")}
                      className={
                        "px-2.5 py-0.5 rounded-full text-[10px] " +
                        (logFilter === "all"
                          ? "bg-sky-500 text-slate-900"
                          : "text-slate-300 hover:text-white")
                      }
                    >
                      Tous
                    </button>
                    <button
                      type="button"
                      onClick={() => setLogFilter("auth_failed")}
                      className={
                        "px-2.5 py-0.5 rounded-full text-[10px] " +
                        (logFilter === "auth_failed"
                          ? "bg-red-500 text-slate-900"
                          : "text-slate-300 hover:text-white")
                      }
                    >
                      √âchecs de connexion
                    </button>
                  </div>

                  {loadingLogs && (
                    <span className="text-[11px] text-slate-400">
                      Chargement‚Ä¶
                    </span>
                  )}
                </div>
              </div>

              {usageLogs.length === 0 && !loadingLogs && (
                <p className="text-[12px] text-slate-400">
                  Aucun log d&apos;usage trouv√©. V√©rifie que{" "}
                  <code className="text-sky-300">logUsage()</code> est bien
                  appel√© quand tu g√©n√®res / t√©l√©charges LM & CV, et que tu
                  loggues aussi les erreurs de connexion avec{" "}
                  <code className="text-sky-300">action = "auth_failed"</code>.
                </p>
              )}

              {usageLogs.length > 0 && filteredLogs.length === 0 && (
                <p className="text-[12px] text-slate-400">
                  Aucun log pour ce filtre. Il n&apos;y a pas (encore) de
                  logs avec <code>action = "auth_failed"</code>.
                </p>
              )}

              {filteredLogs.length > 0 && (
                <div className="overflow-x-auto mt-2">
                  <table className="w-full text-[11px] sm:text-[12px] border-collapse">
                    <thead>
                      <tr className="text-slate-400 border-b border-slate-800">
                        <th className="text-left py-2 pr-3">Date</th>
                        <th className="text-left py-2 pr-3">User</th>
                        <th className="text-left py-2 pr-3">Action</th>
                        <th className="text-left py-2 pr-3 hidden md:table-cell">
                          Cr√©dit
                        </th>
                        <th className="text-left py-2 pr-3 hidden sm:table-cell">
                          Localisation / Appareil
                        </th>
                        <th className="text-left py-2 pl-3 hidden lg:table-cell">
                          Page
                        </th>
                      </tr>
                    </thead>
                    <tbody>
                      {filteredLogs.map((log) => {
                        const flag = getCountryFlag(log.country);
                        const deviceLabel = formatDevice(
                          log.deviceType ?? undefined,
                          log.os ?? undefined
                        );
                        const pageLabel = getPageLabel(log.path ?? undefined);

                        const isSuspicious = log.action === "auth_failed";

                        return (
                          <tr
                            key={log.id}
                            className={
                              "border-b border-slate-800/70 hover:bg-slate-900/60 " +
                              (isSuspicious ? "bg-red-900/10" : "")
                            }
                          >
                            <td className="py-2 pr-3 align-top text-slate-200">
                              <div className="flex flex-col">
                                <span>{formatDate(log.createdAt)}</span>
                                <span className="text-[10px] text-slate-400">
                                  {formatRelative(log.createdAt ?? null)}
                                </span>
                              </div>
                            </td>
                            <td className="py-2 pr-3 align-top">
                              <div className="flex flex-col">
                                <span className="text-slate-100">
                                  {log.email || "‚Äî"}
                                </span>
                                <span className="text-[10px] text-slate-400">
                                  UID: {log.userId}
                                </span>
                              </div>
                            </td>
                            <td className="py-2 pr-3 align-top">
                              <div className="flex flex-col gap-0.5">
                                <span
                                  className={
                                    "text-slate-100 " +
                                    (log.action === "auth_failed"
                                      ? "text-red-300"
                                      : "")
                                  }
                                >
                                  {log.action}
                                </span>
                                <span className="text-[10px] text-slate-400">
                                  {log.docType || "‚Äî"}{" "}
                                  {log.eventType
                                    ? `¬∑ ${log.eventType}`
                                    : ""}
                                </span>
                                {log.tool && (
                                  <span className="inline-flex w-fit rounded-full border border-sky-500/50 bg-sky-500/10 px-2 py-[1px] text-[10px] text-sky-200">
                                    {log.tool}
                                  </span>
                                )}
                              </div>
                            </td>
                            <td className="py-2 pr-3 align-top hidden md:table-cell text-slate-200">
                              {log.creditsDelta != null ? (
                                <span
                                  className={
                                    log.creditsDelta < 0
                                      ? "text-red-300"
                                      : log.creditsDelta > 0
                                      ? "text-emerald-300"
                                      : "text-slate-200"
                                  }
                                >
                                  {log.creditsDelta > 0 ? "+" : ""}
                                  {log.creditsDelta}
                                </span>
                              ) : (
                                "‚Äî"
                              )}
                            </td>
                            <td className="py-2 pr-3 align-top hidden sm:table-cell text-slate-200">
                              <div className="flex flex-col gap-0.5">
                                <div className="flex items-center gap-1.5">
                                  <span className="text-lg">{flag}</span>
                                  <span>
                                    {log.city || log.country
                                      ? `${log.city ?? ""}${
                                          log.city && log.country ? " ¬∑ " : ""
                                        }${log.country ?? ""}`
                                      : "‚Äî"}
                                  </span>
                                </div>
                                {log.ip && (
                                  <span className="text-[10px] text-slate-400">
                                    IP: {log.ip}
                                  </span>
                                )}
                                <span className="text-[10px] text-slate-400">
                                  {deviceLabel}
                                </span>
                                {log.browser && (
                                  <span className="text-[10px] text-slate-500">
                                    Navigateur: {log.browser}
                                  </span>
                                )}
                              </div>
                            </td>
                            <td className="py-2 pl-3 align-top hidden lg:table-cell text-slate-200">
                              <span className="text-[11px] text-slate-300 line-clamp-1">
                                Section: {pageLabel}
                              </span>
                              {log.path && (
                                <div className="text-[10px] text-slate-500 line-clamp-1">
                                  Path: {log.path}
                                </div>
                              )}
                            </td>
                          </tr>
                        );
                      })}
                    </tbody>
                  </table>
                </div>
              )}
            </div>
          </div>
        )}
      </div>
    </div>
  );
}
````

## File: app/api/extractProfile/route.ts
````typescript
import { NextResponse } from "next/server";

const UPSTREAM =
  process.env.EXTRACT_PROFILE_UPSTREAM ||
  "https://europe-west1-assistant-ia-v4.cloudfunctions.net/extractProfile";

export async function POST(req: Request) {
  const auth = req.headers.get("authorization") || "";
  const recaptcha = req.headers.get("x-recaptcha-token") || "";

  const body = await req.json().catch(() => null);

  if (!body || !body.base64Pdf) {
    return NextResponse.json(
      { error: "Champ 'base64Pdf' manquant." },
      { status: 400 }
    );
  }

  const upstreamRes = await fetch(UPSTREAM, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      ...(auth ? { Authorization: auth } : {}),
      ...(recaptcha ? { "X-Recaptcha-Token": recaptcha } : {}),
    },
    body: JSON.stringify(body),
    cache: "no-store",
  });

  const text = await upstreamRes.text();
  const contentType =
    upstreamRes.headers.get("content-type") || "application/json";

  return new NextResponse(text, {
    status: upstreamRes.status,
    headers: { "Content-Type": contentType },
  });
}
````

## File: app/api/generate-cv/generate-letter/route.ts
````typescript
import { NextResponse } from "next/server";
import { getApps, initializeApp, applicationDefault, cert } from "firebase-admin/app";
import { getAuth } from "firebase-admin/auth";
import { getFirestore, FieldValue } from "firebase-admin/firestore";

export const runtime = "nodejs";

function getAdminApp() {
  if (getApps().length) return getApps()[0];

  const projectId = process.env.FIREBASE_ADMIN_PROJECT_ID || process.env.FIREBASE_PROJECT_ID;
  const clientEmail = process.env.FIREBASE_ADMIN_CLIENT_EMAIL;
  const privateKeyRaw = process.env.FIREBASE_ADMIN_PRIVATE_KEY;

  if (projectId && clientEmail && privateKeyRaw) {
    const privateKey = privateKeyRaw.replace(/\\n/g, "\n");
    return initializeApp({
      credential: cert({ projectId, clientEmail, privateKey }),
    });
  }

  return initializeApp({
    credential: applicationDefault(),
  });
}

async function requireUser(req: Request) {
  getAdminApp();

  const authHeader = req.headers.get("authorization") || "";
  const token = authHeader.startsWith("Bearer ") ? authHeader.slice(7).trim() : "";

  if (!token) {
    return { ok: false as const, status: 401, error: "Missing Authorization Bearer token" };
  }

  try {
    const decoded = await getAuth().verifyIdToken(token);
    return { ok: true as const, uid: decoded.uid, email: decoded.email || "" };
  } catch (e) {
    console.error("verifyIdToken error:", e);
    return { ok: false as const, status: 401, error: "Invalid token" };
  }
}

async function consumeCreditsAndLog(params: {
  uid: string;
  email: string;
  cost: number;
  tool: string;
  docType: "cv" | "lm" | "other";
  meta?: any;
}) {
  getAdminApp();
  const db = getFirestore();

  const userRef = db.collection("users").doc(params.uid);
  const usageRef = db.collection("usageLogs").doc();
  const now = Date.now();

  await db.runTransaction(async (tx) => {
    const snap = await tx.get(userRef);
    const data = snap.exists ? snap.data() || {} : {};
    const currentCredits = typeof data.credits === "number" ? data.credits : 0;

    if (currentCredits < params.cost) {
      const err: any = new Error("NO_CREDITS");
      err.code = "NO_CREDITS";
      throw err;
    }

    tx.set(
      userRef,
      {
        credits: currentCredits - params.cost,
        totalIaCalls: FieldValue.increment(1),
        totalDocumentsGenerated: FieldValue.increment(params.docType === "cv" || params.docType === "lm" ? 1 : 0),
        totalCvGenerated: FieldValue.increment(params.docType === "cv" ? 1 : 0),
        totalLmGenerated: FieldValue.increment(params.docType === "lm" ? 1 : 0),
        updatedAt: FieldValue.serverTimestamp(),
      },
      { merge: true }
    );

    tx.set(
      usageRef,
      {
        userId: params.uid,
        email: params.email || "",
        action: "generate_document",
        docType: params.docType,
        eventType: "generate",
        tool: params.tool,
        creditsDelta: -params.cost,
        meta: params.meta || null,
        createdAt: now,
        createdAtServer: FieldValue.serverTimestamp(),
      },
      { merge: true }
    );
  });
}

function buildProfileContextForIA(profile: any) {
  const p = profile || {};

  let skillsArr: any[] = [];
  if (Array.isArray(p.skills)) {
    skillsArr = p.skills;
  } else if (p.skills && typeof p.skills === "object") {
    if (Array.isArray(p.skills.sections)) {
      p.skills.sections.forEach((sec: any) => {
        if (Array.isArray(sec.items)) skillsArr = skillsArr.concat(sec.items);
      });
    }
    if (Array.isArray(p.skills.tools)) skillsArr = skillsArr.concat(p.skills.tools);
  }

  const skillsStr = (skillsArr || []).join(", ");

  const expStr = Array.isArray(p.experiences)
    ? p.experiences
        .map(
          (e: any) =>
            `${e.role || e.title || ""} chez ${e.company || ""} (${e.dates || ""}): ${(e.bullets || []).join(" ")}`
        )
        .join("; \n")
    : "";

  const eduStr = Array.isArray(p.education)
    ? p.education
        .map((e: any) => `${e.degree || e.title || ""} - ${e.school || e.institution || ""} (${e.dates || ""})`)
        .join("; \n")
    : "";

  return `Nom: ${p.fullName || p.name || ""}
Titre: ${p.profileHeadline || p.title || ""}
Contact: ${p.email || ""} | ${p.phone || ""} | ${p.linkedin || ""} | ${p.city || ""}
R√©sum√© de profil: ${p.profileSummary || p.summary || ""}
Comp√©tences: ${skillsStr}
Exp√©riences: 
${expStr}
Formations: 
${eduStr}
Certifications: ${p.certs || ""}
Langues: ${p.langLine || p.lang || ""}`.trim();
}

async function callGeminiText(prompt: string, apiKey: string, temperature = 0.7, maxOutputTokens = 2400) {
  const endpoint = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent";

  const body = {
    contents: [{ role: "user", parts: [{ text: prompt }] }],
    generationConfig: { temperature, maxOutputTokens },
  };

  const resp = await fetch(endpoint, {
    method: "POST",
    headers: { "Content-Type": "application/json", "x-goog-api-key": apiKey },
    body: JSON.stringify(body),
  });

  if (!resp.ok) {
    const errorText = await resp.text();
    throw new Error("Erreur Gemini (texte): " + errorText);
  }

  const data = await resp.json();
  const parts = data?.candidates?.[0]?.content?.parts || [];
  const text = parts
    .map((p: any) => (typeof p.text === "string" ? p.text : ""))
    .join("\n")
    .trim();

  if (!text) throw new Error("R√©ponse Gemini (texte) vide");
  return text;
}

function buildFallbackLetterAndPitch(profile: any, jobTitle: string, companyName: string, jobDescription: string, lang: string) {
  const p = profile || {};
  const name = p.fullName || "";
  const primaryDomain = p.primaryDomain || "";
  const summary = p.profileSummary || "";
  const firstExp = Array.isArray(p.experiences) && p.experiences.length ? p.experiences[0] : null;
  const role = firstExp?.role || firstExp?.title || "";
  const company = firstExp?.company || "";
  const years = Array.isArray(p.experiences) && p.experiences.length > 0 ? p.experiences.length : null;

  if (lang === "en") {
    return {
      pitch:
        summary ||
        `I am ${name || "a candidate"} with ${years ? years + " years of experience" : "solid experience"} in ${
          primaryDomain || "my field"
        }, motivated by the ${jobTitle || "role"} at ${companyName || "your company"}.`,
      coverLetter: `I am writing to express my interest in the position of ${jobTitle || "your advertised role"}. With ${
        years ? years + " years of experience" : "solid experience"
      } in ${primaryDomain || "my field"}, I have developed strong skills relevant to this opportunity.

In my previous experience at ${company || "my last company"}, I contributed to projects with measurable impact and collaborated with different stakeholders.

I would be delighted to discuss how I can contribute to your team.`,
    };
  }

  return {
    pitch:
      summary ||
      `Je suis ${name || "un(e) candidat(e)"} avec ${
        years ? years + " ans d‚Äôexp√©rience" : "une solide exp√©rience"
      } ${primaryDomain ? "dans " + primaryDomain : ""}, motiv√©(e) par le poste de ${
        jobTitle || "votre poste"
      } chez ${companyName || "votre entreprise"}.`,
    coverLetter: `Je vous √©cris pour vous faire part de mon int√©r√™t pour le poste de ${jobTitle || "..."} au sein de ${
      companyName || "votre entreprise"
    }. Avec ${years ? years + " ans d‚Äôexp√©rience" : "une exp√©rience significative"} ${
      primaryDomain ? "dans " + primaryDomain : "dans mon domaine"
    }, j‚Äôai d√©velopp√© des comp√©tences solides en ${role || "gestion de projets, collaboration et suivi d‚Äôobjectifs"}.

Je serais ravi(e) d‚Äô√©changer plus en d√©tail lors d‚Äôun entretien.`,
  };
}

export async function POST(req: Request) {
  const auth = await requireUser(req);
  if (!auth.ok) return NextResponse.json({ ok: false, error: auth.error }, { status: auth.status });

  let body: any = null;
  try {
    body = await req.json();
  } catch {
    return NextResponse.json({ ok: false, error: "Invalid JSON body" }, { status: 400 });
  }

  const profile = body?.profile;
  const jobDescription = body?.jobDescription || "";
  const jobTitle = body?.jobTitle || "";
  const companyName = body?.companyName || "";
  const langRaw = body?.lang || "fr";
  const lang = String(langRaw).toLowerCase().startsWith("en") ? "en" : "fr";

  if (!profile) return NextResponse.json({ ok: false, error: "Missing profile" }, { status: 400 });
  if (!jobTitle && !jobDescription) {
    return NextResponse.json(
      { ok: false, error: "Ajoute au moins l'intitul√© du poste ou un extrait de la description." },
      { status: 400 }
    );
  }

  // ‚úÖ D√©bit -1 cr√©dit + log
  try {
    await consumeCreditsAndLog({
      uid: auth.uid,
      email: auth.email,
      cost: 1,
      tool: "generateLetterAndPitch",
      docType: "lm",
      meta: { jobTitle, companyName, lang },
    });
  } catch (e: any) {
    if (e?.code === "NO_CREDITS" || e?.message === "NO_CREDITS") {
      return NextResponse.json({ ok: false, error: "NO_CREDITS" }, { status: 402 });
    }
    console.error("consumeCreditsAndLog error:", e);
    return NextResponse.json({ ok: false, error: "CREDITS_ERROR" }, { status: 500 });
  }

  const GEMINI_API_KEY = process.env.GEMINI_API_KEY || "";

  const cvText = buildProfileContextForIA(profile);

  if (!GEMINI_API_KEY) {
    const fb = buildFallbackLetterAndPitch(profile, jobTitle, companyName, jobDescription, lang);
    return NextResponse.json({ ok: true, coverLetter: fb.coverLetter, pitch: fb.pitch, lang }, { status: 200 });
  }

  const prompt =
    lang === "en"
      ? `You are a senior career coach and recruiter.

Return STRICTLY valid JSON:
{ "coverLetter": "string", "pitch": "string" }

COVER LETTER RULES:
- "coverLetter" must be ONLY the BODY (no header, no subject, no greeting, no signature).
- 3 to 5 short paragraphs separated by a blank line.
- Do not invent facts, companies, tools, numbers.
- Use ONLY the candidate profile and the job description.

CANDIDATE PROFILE (source of truth):
${cvText}

JOB DESCRIPTION:
${jobDescription || "‚Äî"}

JOB TITLE: ${jobTitle || "the role"}
COMPANY: ${companyName || "your company"}`
      : `Tu es un coach carri√®res senior et recruteur.

Retourne STRICTEMENT un JSON valide :
{ "coverLetter": "string", "pitch": "string" }

R√àGLES LETTRE :
- "coverLetter" = UNIQUEMENT le CORPS (pas d‚Äôen-t√™te, pas d‚Äôobjet, pas de formule d‚Äôappel, pas de signature).
- 3 √† 5 paragraphes s√©par√©s par une ligne vide.
- Ne pas inventer (entreprises/outils/chiffres).
- Utilise UNIQUEMENT le profil candidat + la fiche de poste.

PROFIL CANDIDAT (source de v√©rit√©) :
${cvText}

FICHE DE POSTE :
${jobDescription || "‚Äî"}

INTITUL√â : ${jobTitle || "le poste"}
ENTREPRISE : ${companyName || "votre entreprise"}`;

  let coverLetter = "";
  let pitch = "";

  try {
    const raw = await callGeminiText(prompt, GEMINI_API_KEY, 0.7, 2200);
    const cleaned = String(raw).replace(/```json|```/gi, "").trim();

    let parsed: any = null;
    try {
      parsed = JSON.parse(cleaned);
    } catch {
      parsed = { coverLetter: cleaned, pitch: "" };
    }

    coverLetter = typeof parsed.coverLetter === "string" ? parsed.coverLetter.trim() : "";
    pitch = typeof parsed.pitch === "string" ? parsed.pitch.trim() : "";
  } catch (e) {
    console.error("Gemini generateLetterAndPitch error:", e);
  }

  if (!coverLetter || !pitch) {
    const fb = buildFallbackLetterAndPitch(profile, jobTitle, companyName, jobDescription, lang);
    if (!coverLetter) coverLetter = fb.coverLetter;
    if (!pitch) pitch = fb.pitch;
  }

  return NextResponse.json({ ok: true, coverLetter, pitch, lang }, { status: 200 });
}
````

## File: app/api/generateInterviewQA/route.ts
````typescript
// app/api/generateInterviewQA/route.ts
import { NextRequest, NextResponse } from "next/server";

export const runtime = "nodejs";

// Petit helper pour r√©cup√©rer un JSON m√™me si Gemini met des ```json ... ```
function extractJson(text: string): any | null {
  if (!text) return null;

  let t = text.trim();

  // Si Gemini renvoie ```json ... ```
  if (t.startsWith("```")) {
    // retire ```json ou ``` et la derni√®re ```
    t = t.replace(/^```[a-zA-Z]*\s*/, "").replace(/```$/, "").trim();
  }

  // 1√®re tentative : parser tout
  try {
    return JSON.parse(t);
  } catch {
    // ignore, on tente plus bas
  }

  // 2√®me tentative : chercher le premier bloc {...}
  const match = t.match(/\{[\s\S]*\}/);
  if (match) {
    try {
      return JSON.parse(match[0]);
    } catch {
      // toujours pas bon
    }
  }

  return null;
}

export async function POST(req: NextRequest) {
  try {
    const body = await req.json();
    const { profile, experienceIndex, lang = "fr" } = body;

    if (!profile || typeof experienceIndex !== "number") {
      return NextResponse.json(
        { error: "Missing profile or experienceIndex" },
        { status: 400 }
      );
    }

    const experiences: any[] =
      (profile.experiences as any[]) ||
      (profile.experience as any[]) ||
      [];

    const exp = experiences[experienceIndex];
    if (!exp) {
      return NextResponse.json(
        { error: "Experience not found" },
        { status: 404 }
      );
    }

    const bullets = Array.isArray(exp.bullets)
      ? exp.bullets.join("\n- ")
      : "";

    const prompt = `
Tu es un coach d'entretien. G√©n√®re 5 questions d'entretien pour le candidat,
bas√©es sur cette exp√©rience de son CV, avec des r√©ponses de qualit√©.

Tu dois renvoyer STRICTEMENT un objet JSON valide, sans aucun texte avant ou apr√®s.

Format de sortie EXACT :
{
  "questions": [
    {
      "question": "string",
      "answer": "string"
    }
  ]
}

Pas de commentaires, pas de texte hors de cet objet JSON.

Langue : ${lang === "en" ? "anglais" : "fran√ßais"}.

Exp√©rience :
- Poste : ${exp.role || exp.title || ""}
- Entreprise : ${exp.company || ""}
- Lieu : ${exp.city || exp.location || ""}
- Dates : ${exp.dates || ""}

Missions / r√©sultats :
- ${bullets}
    `.trim();

    const apiKey = process.env.GEMINI_API_KEY;
    if (!apiKey) {
      console.warn("[generateInterviewQA] GEMINI_API_KEY manquant ‚Üí mode d√©mo.");
      // Fallback d√©mo simple
      return NextResponse.json({
        questions: [
          {
            question:
              lang === "en"
                ? "Tell me about a challenge in this role and how you handled it."
                : "Parle-moi d‚Äôun d√©fi que tu as rencontr√© sur ce poste et comment tu l‚Äôas g√©r√©.",
            answer:
              lang === "en"
                ? "Sample answer here‚Ä¶"
                : "Exemple de r√©ponse ici‚Ä¶",
          },
        ],
        lang,
      });
    }

    const model =
      process.env.GEMINI_MODEL || "models/gemini-2.5-flash";

    const url = `https://generativelanguage.googleapis.com/v1beta/${model}:generateContent?key=${apiKey}`;

    const payload = {
      contents: [
        {
          role: "user",
          parts: [{ text: prompt }],
        },
      ],
      // >>> IMPORTANT : on force une r√©ponse en JSON pur
      generationConfig: {
        response_mime_type: "application/json",
      },
    };

    const resp = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    });

    if (!resp.ok) {
      const errorText = await resp.text();
      console.error(
        "Gemini error (generateInterviewQA):",
        resp.status,
        errorText
      );

      if (resp.status === 429) {
        console.warn(
          "[generateInterviewQA] Quota Gemini d√©pass√© ‚Üí fallback d√©mo."
        );
        return NextResponse.json({
          questions: [
            {
              question:
                lang === "en"
                  ? "Demo mode (quota exceeded): what did you learn in this experience?"
                  : "Mode d√©mo (quota d√©pass√©) : qu‚Äôas-tu appris dans cette exp√©rience ?",
              answer:
                lang === "en"
                  ? "Sample answer here‚Ä¶"
                  : "Exemple de r√©ponse ici‚Ä¶",
            },
          ],
          lang,
        });
      }

      return NextResponse.json(
        { error: "Gemini call failed" },
        { status: 500 }
      );
    }

    const data = await resp.json();

    const textRaw: string =
      data?.candidates?.[0]?.content?.parts
        ?.map((p: any) => p?.text || "")
        .join("")
        .trim() || "";

    if (!textRaw) {
      console.error("Empty Gemini response (generateInterviewQA):", data);
      // On ne jette plus une 500, on renvoie un fallback propre
      return NextResponse.json({
        questions: [
          {
            question:
              lang === "en"
                ? "Based on this experience, what are you most proud of?"
                : "De quoi es-tu le plus fier dans cette exp√©rience ?",
            answer:
              lang === "en"
                ? "Sample answer here‚Ä¶"
                : "Exemple de r√©ponse ici‚Ä¶",
          },
        ],
        lang,
      });
    }

    const parsed = extractJson(textRaw);

    if (!parsed || !Array.isArray(parsed.questions)) {
      console.error(
        "JSON parse error generateInterviewQA: texte non exploitable",
        textRaw
      );
      // Toujours un fallback pour ne plus avoir de 500 c√¥t√© front
      return NextResponse.json({
        questions: [
          {
            question:
              lang === "en"
                ? "Tell me about this role and your main responsibilities."
                : "Parle-moi de ce poste et de tes principales responsabilit√©s.",
            answer:
              lang === "en"
                ? "Sample answer here‚Ä¶"
                : "Exemple de r√©ponse ici‚Ä¶",
          },
        ],
        lang,
      });
    }

    // On force la langue si absente
    if (!parsed.lang) {
      parsed.lang = lang;
    }

    return NextResponse.json(parsed);
  } catch (err) {
    console.error("generateInterviewQA API error:", err);
    return NextResponse.json(
      { error: "Internal error" },
      { status: 500 }
    );
  }
}
````

## File: app/api/jobs/route.ts
````typescript
// app/api/jobs/route.ts
import { NextRequest, NextResponse } from "next/server";

export const runtime = "nodejs";

// Cl√©s Adzuna c√¥t√© serveur Next
const ADZUNA_APP_ID = process.env.ADZUNA_APP_ID;
const ADZUNA_APP_KEY = process.env.ADZUNA_APP_KEY;

// Base CF pour v√©rifier reCAPTCHA c√¥t√© serveur (anti-bypass)
const DEFAULT_API_BASE =
  "https://europe-west1-assistant-ia-v4.cloudfunctions.net";
const API_BASE = (
  process.env.NEXT_PUBLIC_API_BASE_URL ||
  process.env.API_BASE_URL ||
  DEFAULT_API_BASE
).replace(/\/+$/, "");

async function verifyRecaptchaServer(token: string, action: string) {
  const res = await fetch(`${API_BASE}/recaptchaVerify`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ token, action: (action || "").trim().toLowerCase() }),
    cache: "no-store",
  });

  const data: any = await res.json().catch(() => ({}));
  return { ok: res.ok && data?.ok === true, data };
}

type AdzunaRawJob = {
  id?: string;
  title?: string;
  company?: { display_name?: string };
  location?: { display_name?: string };
  redirect_url?: string;
  description?: string;
  created?: string;
  salary_min?: number;
  salary_max?: number;
};

type AdzunaRawResponse = {
  results?: AdzunaRawJob[];
  count?: number;
  mean?: number;
};

const ALLOWED_COUNTRIES = new Set([
  "fr",
  "be",
  "ch",
  "ca",
  "gb",
  "es",
  "de",
  "it",
]);

function asNumber(v: any): number | undefined {
  const n = typeof v === "number" ? v : Number(v);
  return Number.isFinite(n) ? n : undefined;
}

export async function POST(req: NextRequest) {
  try {
    const body = await req.json();

    const {
      query,
      location,
      country = "fr",
      page = 1,
      results_per_page = 50,

      // Filtres optionnels (front)
      contract_time, // "any" | "full_time" | "part_time"
      contract_type, // "any" | "permanent" | "contract"
      salary_min,
      salary_max,
      max_days_old,

      recaptchaToken,
    } = body || {};

    // ‚úÖ reCAPTCHA (anti-bypass)
    const check = await verifyRecaptchaServer(
      String(recaptchaToken || ""),
      "jobs_search"
    );
    if (!check.ok) {
      return NextResponse.json(
        { error: "reCAPTCHA refus√©", details: check.data },
        { status: 403 }
      );
    }

    if (!query && !location) {
      return NextResponse.json(
        { error: "query ou location requis" },
        { status: 400 }
      );
    }

    if (!ADZUNA_APP_ID || !ADZUNA_APP_KEY) {
      console.error("ADZUNA_APP_ID ou ADZUNA_APP_KEY manquants");
      return NextResponse.json(
        {
          error:
            "Cl√©s Adzuna non configur√©es c√¥t√© serveur. Ajoute ADZUNA_APP_ID et ADZUNA_APP_KEY dans ton .env.local.",
        },
        { status: 500 }
      );
    }

    const safeCountry = String(country || "fr").toLowerCase().trim();
    const countryCode = ALLOWED_COUNTRIES.has(safeCountry) ? safeCountry : "fr";

    const safePage = asNumber(page) && (page as number) > 0 ? Number(page) : 1;

    const rppRaw = asNumber(results_per_page) ?? 50;
    const safeRpp = Math.max(1, Math.min(100, Math.floor(rppRaw)));

    const params = new URLSearchParams();
    params.set("app_id", ADZUNA_APP_ID);
    params.set("app_key", ADZUNA_APP_KEY);
    params.set("results_per_page", String(safeRpp));
    params.set("content-type", "application/json");

    if (query) params.set("what", String(query));
    if (location) params.set("where", String(location));

    // Filtres Adzuna
    const salMin = asNumber(salary_min);
    const salMax = asNumber(salary_max);
    const maxDays = asNumber(max_days_old);

    if (salMin !== undefined) params.set("salary_min", String(Math.floor(salMin)));
    if (salMax !== undefined) params.set("salary_max", String(Math.floor(salMax)));
    if (maxDays !== undefined) params.set("max_days_old", String(Math.floor(maxDays)));

    // contract_time
    if (contract_time === "full_time") params.set("full_time", "1");
    if (contract_time === "part_time") params.set("part_time", "1");

    // contract_type
    if (contract_type === "permanent") params.set("permanent", "1");
    if (contract_type === "contract") params.set("contract", "1");

    // URL
    const url = `https://api.adzuna.com/v1/api/jobs/${countryCode}/search/${safePage}?${params.toString()}`;

    const resp = await fetch(url, {
      method: "GET",
      headers: { Accept: "application/json" },
    });

    if (!resp.ok) {
      const textErr = await resp.text();
      console.error("Erreur Adzuna:", resp.status, textErr);
      return NextResponse.json(
        { error: "Erreur lors de l'appel √† l'API Adzuna." },
        { status: 500 }
      );
    }

    const data: AdzunaRawResponse = await resp.json();

    const jobs =
      (data.results || []).map((job, index) => ({
        id: job.id || `job-${safePage}-${index}`,
        title: job.title || "Offre sans titre",
        company: job.company?.display_name || "Entreprise non renseign√©e",
        location: job.location?.display_name || "Lieu non pr√©cis√©",
        url: job.redirect_url || "",
        description: job.description || "",
        created: job.created || "",
        // ‚úÖ important pour ton front (il calcule salary avec salary_min/max)
        salary_min: typeof job.salary_min === "number" ? job.salary_min : undefined,
        salary_max: typeof job.salary_max === "number" ? job.salary_max : undefined,
      })) || [];

    return NextResponse.json({
      jobs,
      meta: {
        country: countryCode,
        page: safePage,
        results_per_page: safeRpp,
        count: typeof data.count === "number" ? data.count : undefined,
      },
    });
  } catch (err) {
    console.error("Erreur /api/jobs:", err);
    return NextResponse.json(
      { error: "Erreur interne lors de la recherche d'offres (API jobs)." },
      { status: 500 }
    );
  }
}
````

## File: app/api/letterAndPitch/route.ts
````typescript
// app/api/letterAndPitch/route.ts
import { NextRequest, NextResponse } from "next/server";

export const runtime = "nodejs";

function getModelPath(envValue: string | undefined, fallback: string): string {
  const raw = (envValue || fallback).trim();
  return raw.startsWith("models/") ? raw : `models/${raw}`;
}

// Base Cloud Functions pour v√©rifier reCAPTCHA c√¥t√© serveur
const DEFAULT_API_BASE =
  "https://europe-west1-assistant-ia-v4.cloudfunctions.net";
const API_BASE = (
  process.env.NEXT_PUBLIC_API_BASE_URL ||
  process.env.API_BASE_URL ||
  DEFAULT_API_BASE
).replace(/\/+$/, "");

async function verifyRecaptchaServer(token: string, action: string) {
  const res = await fetch(`${API_BASE}/recaptchaVerify`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ token, action: (action || "").trim().toLowerCase() }),
    cache: "no-store",
  });

  const data: any = await res.json().catch(() => ({}));
  return { ok: res.ok && data?.ok === true, data };
}

// Helper: enl√®ve ```json ... ``` si besoin
function extractJson(text: string): any | null {
  if (!text) return null;
  let t = text.trim();

  if (t.startsWith("```")) {
    t = t.replace(/^```[a-zA-Z]*\s*/, "").replace(/```$/, "").trim();
  }

  try {
    return JSON.parse(t);
  } catch {
    const match = t.match(/\{[\s\S]*\}/);
    if (match) {
      try {
        return JSON.parse(match[0]);
      } catch {
        return null;
      }
    }
    return null;
  }
}

export async function POST(req: NextRequest) {
  try {
    const body = await req.json();
    const {
      profile,
      jobTitle = "",
      companyName = "",
      jobDescription = "",
      lang = "fr",
      recaptchaToken,
    } = body || {};

    // ‚úÖ V√©rif reCAPTCHA (anti-bypass)
    const check = await verifyRecaptchaServer(
      String(recaptchaToken || ""),
      "generate_letter_pitch"
    );
    if (!check.ok) {
      return NextResponse.json(
        { error: "reCAPTCHA refus√©", details: check.data },
        { status: 403 }
      );
    }

    if (!profile) {
      return NextResponse.json({ error: "Missing profile" }, { status: 400 });
    }

    const apiKey = process.env.GEMINI_API_KEY;
    if (!apiKey) {
      console.warn("[letterAndPitch] GEMINI_API_KEY manquant ‚Üí mode d√©mo.");
      return NextResponse.json({
        coverLetter:
          lang === "en"
            ? "Demo mode: here would be a tailored cover letter based on your CV and the job description."
            : "Mode d√©mo : ici appara√Ætrait une lettre de motivation personnalis√©e √† partir de ton CV et de l'offre.",
        pitch:
          lang === "en"
            ? "Demo mode: here would be a short elevator pitch summarizing your profile for this job."
            : "Mode d√©mo : ici appara√Ætrait un court pitch d‚Äôascenseur r√©sumant ton profil pour ce poste.",
        lang,
      });
    }

    const model = getModelPath(process.env.GEMINI_MODEL, "gemini-2.5-flash");
    const url = `https://generativelanguage.googleapis.com/v1beta/${model}:generateContent?key=${apiKey}`;

    const profileJson = JSON.stringify(profile ?? {}).slice(0, 20000);

    const prompt = `
Tu es un assistant expert en candidatures.

√Ä partir :
- du profil CV du candidat (en JSON),
- du poste vis√© (intitul√©, entreprise),
- et d'√©ventuels extraits d'annonce,

tu dois produire :
1) une lettre de motivation compl√®te (1 page max) pr√™te √† √™tre envoy√©e,
2) un pitch d'ascenseur de 2 √† 4 phrases pour se pr√©senter rapidement.

Langue de sortie : ${lang === "en" ? "anglais" : "fran√ßais"}.

R√©ponds STRICTEMENT au format JSON suivant, sans aucun texte avant ou apr√®s :

{
  "coverLetter": "string",
  "pitch": "string",
  "lang": "fr"
}

O√π "lang" est "fr" ou "en".

Profil CV (JSON) :
${profileJson}

Informations sur le poste :
- Intitul√© : ${jobTitle}
- Entreprise : ${companyName}
- Description / extraits d'annonce : ${jobDescription}
`.trim();

    const payload = {
      contents: [{ role: "user", parts: [{ text: prompt }] }],
      generationConfig: { response_mime_type: "application/json" },
    };

    const resp = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    });

    if (!resp.ok) {
      const errorText = await resp.text().catch(() => "");
      console.error("Gemini error (letterAndPitch):", resp.status, errorText);

      if (resp.status === 429) {
        return NextResponse.json({
          coverLetter:
            lang === "en"
              ? "Demo mode (quota exceeded): here is a short sample cover letter. Please try again later when the quota is reset."
              : "Mode d√©mo (quota d√©pass√©) : voici un exemple de lettre. R√©essaie plus tard quand le quota sera r√©initialis√©.",
          pitch:
            lang === "en"
              ? "Demo mode (quota exceeded): here is a sample elevator pitch."
              : "Mode d√©mo (quota d√©pass√©) : voici un exemple de pitch d‚Äôascenseur.",
          lang,
        });
      }

      return NextResponse.json({ error: "Gemini call failed" }, { status: 500 });
    }

    const data = await resp.json().catch(() => null);

    const textRaw: string =
      data?.candidates?.[0]?.content?.parts
        ?.map((p: any) => p?.text || "")
        .join("")
        .trim() || "";

    if (!textRaw) {
      console.error("Empty Gemini response (letterAndPitch):", data);
      return NextResponse.json({
        coverLetter:
          lang === "en"
            ? "Based on your experience and this role, explain in 3‚Äì4 paragraphs why you are a good fit."
            : "En te basant sur ton exp√©rience et ce poste, explique en 3‚Äì4 paragraphes pourquoi tu es un bon profil.",
        pitch:
          lang === "en"
            ? "Summarize your profile in 2‚Äì3 sentences as if you were introducing yourself at the start of an interview."
            : "R√©sume ton profil en 2‚Äì3 phrases comme si tu te pr√©sentais en d√©but d‚Äôentretien.",
        lang,
      });
    }

    const parsed = extractJson(textRaw);

    const coverLetter =
      typeof parsed?.coverLetter === "string" ? parsed.coverLetter.trim() : "";
    const pitch =
      typeof parsed?.pitch === "string" ? parsed.pitch.trim() : "";
    const outLang = typeof parsed?.lang === "string" ? parsed.lang : lang;

    if (!coverLetter && !pitch) {
      console.error("letterAndPitch: JSON non exploitable, texte brut :", textRaw);
      return NextResponse.json({
        coverLetter:
          lang === "en"
            ? "Based on your CV and this job, write a motivation letter explaining why you are a good match."
            : "√Ä partir de ton CV et de cette offre, r√©dige une lettre de motivation expliquant pourquoi tu corresponds au poste.",
        pitch:
          lang === "en"
            ? "Give a short pitch (2‚Äì4 sentences) summarizing your profile for this job."
            : "Donne un court pitch (2‚Äì4 phrases) r√©sumant ton profil pour ce poste.",
        lang,
      });
    }

    return NextResponse.json({ coverLetter, pitch, lang: outLang });
  } catch (err) {
    console.error("letterAndPitch API error:", err);
    return NextResponse.json({ error: "Internal error" }, { status: 500 });
  }
}
````

## File: app/api/linkedin/exchange/route.ts
````typescript
// app/api/linkedin/exchange/route.ts
import { NextRequest, NextResponse } from "next/server";
import qs from "querystring";

// ‚ö†Ô∏è Mets ces valeurs dans .env.local (voir plus bas)
const CLIENT_ID = process.env.LINKEDIN_CLIENT_ID!;
const CLIENT_SECRET = process.env.LINKEDIN_CLIENT_SECRET!;
const REDIRECT_URI = process.env.LINKEDIN_REDIRECT_URI!; // doit matcher l'URL callback

export async function POST(req: NextRequest) {
  try {
    const { code } = await req.json();

    if (!code) {
      return NextResponse.json(
        { error: "Missing authorization code" },
        { status: 400 }
      );
    }

    // 1) √âchanger le code contre un access_token + id_token
    const tokenResp = await fetch(
      "https://www.linkedin.com/oauth/v2/accessToken",
      {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded"
        },
        body: qs.stringify({
          grant_type: "authorization_code",
          code,
          redirect_uri: REDIRECT_URI,
          client_id: CLIENT_ID,
          client_secret: CLIENT_SECRET
        })
      }
    );

    if (!tokenResp.ok) {
      const text = await tokenResp.text();
      console.error("LinkedIn token error:", text);
      return NextResponse.json(
        { error: "Failed to exchange code", details: text },
        { status: 400 }
      );
    }

    const tokenJson = (await tokenResp.json()) as any;

    // LinkedIn peut renvoyer un id_token si on a demand√© scope "openid"
    const idToken = tokenJson.id_token;
    const accessToken = tokenJson.access_token;

    if (!idToken) {
      // On peut continuer avec accessToken si besoin, mais pour Firebase OIDC,
      // on veut surtout un id_token. Si pas dispo, renvoie erreur claire.
      return NextResponse.json(
        {
          error:
            "LinkedIn n'a pas renvoy√© d'id_token (v√©rifie que le scope openid est bien activ√©)"
        },
        { status: 400 }
      );
    }

    return NextResponse.json({ idToken, accessToken });
  } catch (e: any) {
    console.error("LinkedIn exchange error:", e);
    return NextResponse.json(
      { error: "Server error", details: e.message },
      { status: 500 }
    );
  }
}
````

## File: app/api/linkedin/token/route.ts
````typescript
// app/api/linkedin/token/route.ts
import { NextRequest, NextResponse } from "next/server";

export async function POST(req: NextRequest) {
  try {
    const { code } = await req.json();

    if (!code) {
      return NextResponse.json(
        { error: "code manquant" },
        { status: 400 }
      );
    }

    const clientId = process.env.LINKEDIN_CLIENT_ID!;
    const clientSecret = process.env.LINKEDIN_CLIENT_SECRET!;
    const redirectUri = process.env.LINKEDIN_REDIRECT_URI!;

    const body = new URLSearchParams({
      grant_type: "authorization_code",
      code,
      redirect_uri: redirectUri,
      client_id: clientId,
      client_secret: clientSecret,
    });

    // Appel LinkedIn pour √©changer le code
    const resp = await fetch("https://www.linkedin.com/oauth/v2/accessToken", {
      method: "POST",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded",
      },
      body: body.toString(),
    });

    const data = await resp.json();

    if (!resp.ok) {
      console.error("LinkedIn token error:", data);
      return NextResponse.json(
        { error: "Erreur LinkedIn", details: data },
        { status: 400 }
      );
    }

    // Avec le scope "openid", LinkedIn peut renvoyer un id_token
    const idToken = (data as any).id_token;

    if (!idToken) {
      return NextResponse.json(
        {
          error:
            "id_token manquant dans la r√©ponse LinkedIn. V√©rifie que le scope 'openid' est bien activ√©.",
          details: data,
        },
        { status: 400 }
      );
    }

    return NextResponse.json({ idToken });
  } catch (e: any) {
    console.error("API /api/linkedin/token error:", e);
    return NextResponse.json(
      { error: e.message ?? "Erreur serveur" },
      { status: 500 }
    );
  }
}
````

## File: app/api/polar/checkout/route.ts
````typescript
// src/app/api/polar/checkout/route.ts
// @ts-nocheck
import { NextRequest, NextResponse } from "next/server";
import { createPolarCheckout, CreditPackId } from "@/lib/polar";

// Cette route tourne en mode node en dev / en mode serveur
export const runtime = "nodejs";
// ‚ö†Ô∏è NE PAS mettre `export const dynamic = "force-dynamic"` ici en output: "export"

export async function POST(req: NextRequest) {
  try {
    let body: any = null;
    try {
      body = await req.json();
    } catch (e) {
      console.error("[/api/polar/checkout] Body non JSON ou vide");
      return NextResponse.json(
        {
          ok: false,
          error: "Body JSON invalide pour /api/polar/checkout.",
        },
        { status: 400 }
      );
    }

    const packId = body.packId as CreditPackId | undefined;
    const userId = body.userId as string | undefined;
    const email = body.email as string | undefined;

    console.log("[/api/polar/checkout] body re√ßu :", body);

    if (!packId || !userId || !email) {
      console.error("[/api/polar/checkout] Param√®tres manquants", {
        packId,
        userId,
        email,
      });
      return NextResponse.json(
        {
          ok: false,
          error:
            "Param√®tres manquants. Il faut packId ('20' | '50' | '100'), userId et email.",
        },
        { status: 400 }
      );
    }

    // V√©rif rapide des variables d'env
    if (!process.env.POLAR_ACCESS_TOKEN) {
      console.error("[/api/polar/checkout] POLAR_ACCESS_TOKEN manquant");
      return NextResponse.json(
        {
          ok: false,
          error: "Config Polar manquante (POLAR_ACCESS_TOKEN).",
        },
        { status: 500 }
      );
    }

    const { url } = await createPolarCheckout({
      packId,
      userId,
      email,
    });

    console.log("[/api/polar/checkout] Checkout cr√©√©, URL :", url);

    // Toujours renvoyer du JSON
    return NextResponse.json({ ok: true, url }, { status: 200 });
  } catch (error: any) {
    console.error("[/api/polar/checkout] ERREUR :", error);

    return NextResponse.json(
      {
        ok: false,
        error: "Erreur lors de la cr√©ation du checkout Polar.",
        detail: error?.message ?? String(error),
      },
      { status: 500 }
    );
  }
}
````

## File: app/api/polar/test/route.ts
````typescript
// src/app/api/polar/test/route.ts
import { NextResponse } from "next/server";
import { polar } from "@/lib/polar";

export async function GET() {
  try {
    // Appel simple √† l'API Polar en prod
    const result = await polar.products.list({});

    // On renvoie directement ce que Polar renvoie,
    // sans essayer de boucler ni de faire des "..."
    return NextResponse.json({ ok: true, result });
  } catch (error: any) {
    console.error("Erreur Polar test (prod):", error);
    return NextResponse.json(
      {
        ok: false,
        message:
          "Erreur d'appel √† Polar (prod). V√©rifie POLAR_ACCESS_TOKEN si √ßa persiste.",
        detail: error?.message ?? String(error),
      },
      { status: 500 }
    );
  }
}
````

## File: app/api/stt/route.ts
````typescript
import { NextRequest, NextResponse } from "next/server";

export const runtime = "nodejs";

// Nettoie le nom du mod√®le si n√©cessaire
function getModelName(envValue: string | undefined, fallback: string): string {
  const raw = (envValue || fallback).trim();
  // On accepte "gemini-2.5-flash" ou "models/gemini-2.5-flash"
  return raw.replace(/^models\//, "");
}

export async function POST(req: NextRequest) {
  try {
    const formData = await req.formData();
    const file = formData.get("audio") as File | null;

    if (!file) {
      return NextResponse.json(
        { error: "Aucun fichier audio re√ßu (champ 'audio' manquant)." },
        { status: 400 }
      );
    }

    const arrayBuffer = await file.arrayBuffer();
    const buffer = Buffer.from(arrayBuffer);
    const base64 = buffer.toString("base64");
    const mimeType = file.type || "audio/webm";

    const apiKey = process.env.GEMINI_API_KEY;
    if (!apiKey) {
      console.error("[/api/stt] GEMINI_API_KEY manquant.");
      return NextResponse.json(
        { error: "GEMINI_API_KEY manquant c√¥t√© serveur." },
        { status: 500 }
      );
    }

    // Mod√®le audio (configurable via env)
    const configuredModel = getModelName(
      process.env.GEMINI_STT_MODEL,
      "gemini-2.5-flash"
    );

    const url = `https://generativelanguage.googleapis.com/v1beta/models/${configuredModel}:generateContent?key=${apiKey}`;

    const prompt =
      "Transcris mot √† mot l'audio suivant en texte. " +
      "R√©ponds uniquement par la transcription, sans guillemets ni commentaire.";

    const payload = {
      contents: [
        {
          role: "user",
          parts: [
            { text: prompt },
            {
              inlineData: {
                mimeType,
                data: base64,
              },
            },
          ],
        },
      ],
    };

    const resp = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    });

    const status = resp.status;
    const bodyText = await resp.text().catch(() => "");

    if (!resp.ok) {
      console.error("Erreur Gemini STT:", status, bodyText);

      if (status === 429) {
        return NextResponse.json(
          {
            error:
              "Quota Gemini STT d√©pass√©. R√©essaie un peu plus tard.",
          },
          { status: 429 }
        );
      }

      return NextResponse.json(
        { error: `Erreur Gemini (${status})` },
        { status: 500 }
      );
    }

    let data: any;
    try {
      data = JSON.parse(bodyText);
    } catch {
      return NextResponse.json(
        { error: "R√©ponse invalide de Gemini (JSON)" },
        { status: 500 }
      );
    }

    const transcript: string =
      data?.candidates?.[0]?.content?.parts
        ?.map((p: any) => p?.text || "")
        .join("")
        .trim() || "";

    return NextResponse.json({ transcript });
  } catch (err) {
    console.error("Erreur interne /api/stt:", err);
    return NextResponse.json(
      { error: "Erreur interne sur /api/stt" },
      { status: 500 }
    );
  }
}
````

## File: app/api/webhook/polar/route.ts
````typescript
// @ts-nocheck
import { NextRequest, NextResponse } from "next/server";
import {
  validateEvent,
  WebhookVerificationError,
  WebhookHeaders,
} from "@polar-sh/sdk/webhooks";
import {
  addCreditsToUserById,
  addCreditsToUserByEmail,
} from "@/lib/credits";

export const runtime = "nodejs";

// ‚úÖ mapping product_id -> cr√©dits (depuis tes .env)
const PRODUCT_ID_TO_CREDITS: Record<string, number> = {};

if (process.env.POLAR_PRODUCT_20_ID) {
  PRODUCT_ID_TO_CREDITS[process.env.POLAR_PRODUCT_20_ID] = 20;
}
if (process.env.POLAR_PRODUCT_50_ID) {
  PRODUCT_ID_TO_CREDITS[process.env.POLAR_PRODUCT_50_ID] = 50;
}
if (process.env.POLAR_PRODUCT_100_ID) {
  PRODUCT_ID_TO_CREDITS[process.env.POLAR_PRODUCT_100_ID] = 100;
}

// GET juste pour tester depuis le navigateur
export async function GET() {
  return NextResponse.json({
    ok: true,
    env: process.env.POLAR_ENV,
    mappedProducts: PRODUCT_ID_TO_CREDITS,
    message:
      "Endpoint webhook Polar OK. Utilis√© en POST par Polar, pas en GET par le navigateur.",
  });
}

// Webhook POST appel√© par Polar
export async function POST(req: NextRequest) {
  const secret = process.env.POLAR_WEBHOOK_SECRET;
  if (!secret) {
    console.error("POLAR_WEBHOOK_SECRET manquant");
    return new NextResponse("Config manquante", { status: 500 });
  }

  // 1) Body brut (texte) pour la v√©rification de signature
  const body = await req.text();

  // 2) Headers envoy√©s par Polar
  const headers: WebhookHeaders = {
    "webhook-id": req.headers.get("webhook-id") ?? "",
    "webhook-timestamp": req.headers.get("webhook-timestamp") ?? "",
    "webhook-signature": req.headers.get("webhook-signature") ?? "",
  };

  let event: any;
  try {
    // 3) V√©rifier la signature + parser l'event
    event = validateEvent(body, headers, secret);
  } catch (error) {
    if (error instanceof WebhookVerificationError) {
      console.error("Signature Polar invalide");
      return new NextResponse("Signature invalide", { status: 403 });
    }
    console.error("Erreur webhook Polar:", error);
    return new NextResponse("Erreur interne", { status: 500 });
  }

  console.log("üì¨ Webhook Polar re√ßu:", event.type);

  // 4) Gestion des √©v√©nements
  switch (event.type) {
    case "order.paid": {
      const data = event.data;

      console.log("üí∞ order.paid data brut:", JSON.stringify(data, null, 2));

      const productId = data.product_id as string | undefined;
      const creditsToAdd =
        (productId && PRODUCT_ID_TO_CREDITS[productId]) ?? 0;

      const externalId: string | undefined =
        (data.customer?.external_id as string | undefined) ?? undefined;
      const email: string | undefined =
        (data.customer?.email as string | undefined) ?? undefined;

      console.log("üë§ Client pour cr√©dit:", {
        productId,
        creditsToAdd,
        externalId,
        email,
      });

      if (creditsToAdd > 0) {
        try {
          if (externalId) {
            await addCreditsToUserById(externalId, creditsToAdd);
          } else if (email) {
            await addCreditsToUserByEmail(email, creditsToAdd);
          } else {
            console.warn(
              "‚ö†Ô∏è Aucun externalId ni email dans l'order.paid, impossible de cr√©diter l'utilisateur."
            );
          }
        } catch (e) {
          console.error("Erreur lors de l'ajout de cr√©dits Firestore:", e);
          // On n'√©choue pas le webhook : Polar consid√®re le paiement OK
        }
      } else {
        console.log(
          "Produit non mapp√© dans PRODUCT_ID_TO_CREDITS, aucun cr√©dit ajout√©."
        );
      }

      break;
    }

    default:
      console.log("Event non g√©r√© explicitement:", event.type);
  }

  // 5) R√©ponse OK pour Polar
  return NextResponse.json({ received: true });
}
````

## File: app/app/apply/page.tsx
````typescript
"use client";

import { useState, useEffect, FormEvent, useMemo } from "react";
import { motion } from "framer-motion";
import { auth, db } from "@/lib/firebase";
import { onAuthStateChanged } from "firebase/auth";
import { doc, getDoc, collection, addDoc, serverTimestamp } from "firebase/firestore";
import { getRecaptchaToken } from "@/lib/recaptcha";

// --- TYPES PROFIL / CV ---
type CvSkillsSection = { title: string; items: string[] };
type CvSkills = { sections: CvSkillsSection[]; tools: string[] };

type CvExperience = {
  company: string;
  role: string;
  dates: string;
  bullets: string[];
  location?: string;
};

type CvEducation = {
  school: string;
  degree: string;
  dates: string;
  location?: string;
};

type CvProfile = {
  fullName: string;
  email: string;
  phone: string;
  linkedin: string;
  profileSummary: string;

  city?: string;
  address?: string;

  contractType: string;
  contractTypeStandard?: string;
  contractTypeFull?: string;

  primaryDomain?: string;
  secondaryDomains?: string[];
  softSkills?: string[];

  drivingLicense?: string;
  vehicle?: string;

  skills: CvSkills;
  experiences: CvExperience[];
  education: CvEducation[];
  educationShort: string[];
  certs: string;
  langLine: string;
  hobbies: string[];
  updatedAt?: number;
};

type Lang = "fr" | "en";

type JobOffer = {
  id: string;
  title: string;
  company: string;
  location: string;
  url: string;
  description: string;
  created: string;
  salary: string | null;
  matchScore: number;
};

type LastOpenedJob = {
  id: string;
  title: string;
  company: string;
  url: string;
  location?: string;
  openedAt: number;
};

// --- ENDPOINTS CLOUD FUNCTIONS ---
const GENERATE_CV_API =
  "https://europe-west1-assistant-ia-v4.cloudfunctions.net/generateCvPdf";

const GENERATE_CV_LM_ZIP_API =
  "https://europe-west1-assistant-ia-v4.cloudfunctions.net/generateCvLmZip";

// --- AUTOCOMPLETE ---
const JOB_SUGGESTIONS = [
  "Kin√©sith√©rapeute",
  "Kin√© respiratoire",
  "Infirmier",
  "Infirmi√®re",
  "M√©decin g√©n√©raliste",
  "D√©veloppeur web",
  "D√©veloppeur front-end",
  "D√©veloppeur back-end",
  "Product Owner",
  "Chef de projet",
  "Data analyst",
  "Data engineer",
  "Comptable",
  "Charg√© de recrutement",
  "Responsable RH",
  "Commercial B2B",
  "Commercial s√©dentaire",
  "UX designer",
  "Graphiste",
];

const CITY_SUGGESTIONS_FR = [
  "Paris",
  "Lyon",
  "Marseille",
  "Toulouse",
  "Nice",
  "Nantes",
  "Montpellier",
  "Strasbourg",
  "Bordeaux",
  "Lille",
  "Rennes",
  "Reims",
  "Le Havre",
  "Saint-√âtienne",
  "Grenoble",
  "Dijon",
  "Angers",
  "N√Æmes",
  "Villeurbanne",
  "Clermont-Ferrand",
];

const COUNTRY_CODES = [
  { code: "fr", label: "France" },
  { code: "be", label: "Belgique" },
  { code: "ch", label: "Suisse" },
  { code: "ca", label: "Canada" },
  { code: "gb", label: "Royaume-Uni" },
  { code: "es", label: "Espagne" },
  { code: "de", label: "Allemagne" },
  { code: "it", label: "Italie" },
];

// --- HELPERS ---
function normalize(str: string) {
  return str
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .toLowerCase();
}

function tokenize(str: string): string[] {
  return normalize(str)
    .split(/[^a-z0-9]+/i)
    .filter((t) => t.length >= 3);
}

function extractProfileKeywords(profile: CvProfile | null): string[] {
  if (!profile) return [];
  const tokens: string[] = [];

  if (profile.primaryDomain) tokens.push(profile.primaryDomain);
  if (Array.isArray(profile.secondaryDomains)) tokens.push(...profile.secondaryDomains);
  if (profile.profileSummary) tokens.push(profile.profileSummary);

  if (profile.skills) {
    if (Array.isArray(profile.skills.sections)) {
      profile.skills.sections.forEach((sec) => {
        if (sec?.title) tokens.push(sec.title);
        if (Array.isArray(sec?.items)) tokens.push(...sec.items);
      });
    }
    if (Array.isArray(profile.skills.tools)) tokens.push(...profile.skills.tools);
  }

  if (Array.isArray(profile.softSkills)) tokens.push(...profile.softSkills);

  if (Array.isArray(profile.experiences)) {
    profile.experiences.forEach((exp) => {
      if (exp.role) tokens.push(exp.role);
      if (exp.company) tokens.push(exp.company);
      if (Array.isArray(exp.bullets)) tokens.push(...exp.bullets);
    });
  }

  const dedup = Array.from(
    new Set(tokens.map((t) => String(t)).flatMap((t) => tokenize(t)))
  );

  return dedup.slice(0, 80);
}

function computeMatchScore(
  rawJob: any,
  profile: CvProfile | null,
  searchQuery: string,
  searchLocation: string,
  remoteOnly: boolean
): number {
  const title = rawJob.title || "";
  const company =
    (rawJob.company && rawJob.company.display_name) || rawJob.company || "";
  const description = rawJob.description || "";
  const loc =
    (rawJob.location && rawJob.location.display_name) || rawJob.location || "";

  const jobText = `${title} ${company} ${description} ${loc}`;
  const jobTokens = new Set(tokenize(jobText));

  const profileTokens = extractProfileKeywords(profile);
  const queryTokens = tokenize(searchQuery);
  const locationTokens = tokenize(searchLocation);

  const allKeywords = Array.from(new Set([...profileTokens, ...queryTokens]));

  let overlap = 0;
  for (const kw of allKeywords) {
    if (jobTokens.has(kw)) overlap += 1;
  }

  const baseDenom = Math.max(5, allKeywords.length || 5);
  let score = (overlap / baseDenom) * 100;

  if (locationTokens.length) {
    for (const lt of locationTokens) {
      if (jobTokens.has(lt)) {
        score += 10;
        break;
      }
    }
  }

  if (remoteOnly) {
    const jobNorm = normalize(jobText);
    if (/remote|teletravail|home\s*office|hybride/.test(jobNorm)) score += 10;
    else score -= 15;
  }

  return Math.max(0, Math.min(100, Math.round(score)));
}

function scoreBadgeClass(score: number): string {
  if (score >= 75) return "bg-emerald-500/15 text-emerald-300 border-emerald-400/60";
  if (score >= 50) return "bg-amber-500/15 text-amber-300 border-amber-400/60";
  if (score >= 30) return "bg-yellow-500/10 text-yellow-200 border-yellow-400/40";
  return "bg-red-500/10 text-red-200 border-red-400/40";
}

// --- PAGE ---
export default function ApplyPage() {
  // AUTH & PROFIL CV
  const [userId, setUserId] = useState<string | null>(null);
  const [userEmail, setUserEmail] = useState<string | null>(null);
  const [profile, setProfile] = useState<CvProfile | null>(null);
  const [loadingProfile, setLoadingProfile] = useState(true);

  useEffect(() => {
    const unsub = onAuthStateChanged(auth, async (user) => {
      if (!user) {
        setUserId(null);
        setUserEmail(null);
        setProfile(null);
        setLoadingProfile(false);
        return;
      }

      setUserId(user.uid);
      setUserEmail(user.email ?? null);

      try {
        const ref = doc(db, "profiles", user.uid);
        const snap = await getDoc(ref);

        if (snap.exists()) {
          const data = snap.data() as any;
          const loaded: CvProfile = {
            fullName: data.fullName || "",
            email: data.email || "",
            phone: data.phone || "",
            linkedin: data.linkedin || "",
            profileSummary: data.profileSummary || "",
            city: data.city || "",
            address: data.address || "",
            contractType: data.contractType || data.contractTypeStandard || "",
            contractTypeStandard: data.contractTypeStandard || "",
            contractTypeFull: data.contractTypeFull || "",
            primaryDomain: data.primaryDomain || "",
            secondaryDomains: Array.isArray(data.secondaryDomains) ? data.secondaryDomains : [],
            softSkills: Array.isArray(data.softSkills) ? data.softSkills : [],
            drivingLicense: data.drivingLicense || "",
            vehicle: data.vehicle || "",
            skills: {
              sections: Array.isArray(data.skills?.sections) ? data.skills.sections : [],
              tools: Array.isArray(data.skills?.tools) ? data.skills.tools : [],
            },
            experiences: Array.isArray(data.experiences) ? data.experiences : [],
            education: Array.isArray(data.education) ? data.education : [],
            educationShort: Array.isArray(data.educationShort) ? data.educationShort : [],
            certs: data.certs || "",
            langLine: data.langLine || "",
            hobbies: Array.isArray(data.hobbies) ? data.hobbies : [],
            updatedAt: typeof data.updatedAt === "number" ? data.updatedAt : undefined,
          };
          setProfile(loaded);
        } else {
          setProfile(null);
        }
      } catch (e) {
        console.error("Erreur chargement profil pour Apply:", e);
      } finally {
        setLoadingProfile(false);
      }
    });

    return () => unsub();
  }, []);

  const profileName = profile?.fullName || userEmail || "Profil non d√©tect√©";

  // RECHERCHE D‚ÄôOFFRES
  const [searchQuery, setSearchQuery] = useState("");
  const [searchLocation, setSearchLocation] = useState("");
  const [searchCountry, setSearchCountry] = useState("fr");
  const [contractTime, setContractTime] = useState<"any" | "full_time" | "part_time">("any");
  const [contractType, setContractType] = useState<"any" | "permanent" | "contract">("any");
  const [remoteOnly, setRemoteOnly] = useState(false);
  const [minSalary, setMinSalary] = useState("");
  const [maxSalary, setMaxSalary] = useState("");
  const [publishedWithin, setPublishedWithin] = useState<"any" | "1" | "3" | "7" | "30">("7");

  const [jobs, setJobs] = useState<JobOffer[]>([]);
  const [searchLoading, setSearchLoading] = useState(false);
  const [searchError, setSearchError] = useState<string | null>(null);
  const [maxDisplay, setMaxDisplay] = useState(30);

  // VISITES / D√âJ√Ä CONSULT√âES
  const [visitedJobIds, setVisitedJobIds] = useState<string[]>([]);
  const [pendingApplyJob, setPendingApplyJob] = useState<LastOpenedJob | null>(null);

  useEffect(() => {
    if (typeof window === "undefined") return;
    try {
      const rawVisited = window.localStorage.getItem("visitedJobIds");
      if (rawVisited) {
        const arr = JSON.parse(rawVisited);
        if (Array.isArray(arr)) setVisitedJobIds(arr);
      }

      const rawLast = window.localStorage.getItem("lastOpenedJob");
      if (rawLast) {
        const obj = JSON.parse(rawLast) as LastOpenedJob;
        if (obj && obj.id && obj.title && obj.company) setPendingApplyJob(obj);
      }
    } catch (e) {
      console.error("Erreur lecture localStorage Apply:", e);
    }
  }, []);

  const markJobVisited = (job: JobOffer) => {
    if (typeof window === "undefined") return;

    setVisitedJobIds((prev) => {
      const set = new Set(prev);
      set.add(job.id);
      const arr = Array.from(set);
      window.localStorage.setItem("visitedJobIds", JSON.stringify(arr));
      return arr;
    });

    const last: LastOpenedJob = {
      id: job.id,
      title: job.title,
      company: job.company,
      url: job.url,
      location: job.location,
      openedAt: Date.now(),
    };
    window.localStorage.setItem("lastOpenedJob", JSON.stringify(last));
    setPendingApplyJob(last);
  };

  const clearPendingApplyJob = () => {
    if (typeof window !== "undefined") window.localStorage.removeItem("lastOpenedJob");
    setPendingApplyJob(null);
  };

  // AUTOCOMPLETE
  const jobAutocomplete = useMemo(() => {
    const q = searchQuery.trim();
    if (q.length < 2) return [];
    const lower = normalize(q);
    return JOB_SUGGESTIONS.filter((s) => normalize(s).startsWith(lower)).slice(0, 8);
  }, [searchQuery]);

  const cityAutocomplete = useMemo(() => {
    const q = searchLocation.trim();
    if (q.length < 2) return [];
    const lower = normalize(q);
    return CITY_SUGGESTIONS_FR.filter((s) => normalize(s).startsWith(lower)).slice(0, 8);
  }, [searchLocation]);

  // /api/jobs
  const handleSearchJobs = async (e: FormEvent) => {
    e.preventDefault();
    if (!searchQuery.trim() && !searchLocation.trim()) {
      alert("Saisis au moins un mot-cl√© ou une localisation.");
      return;
    }

    setSearchLoading(true);
    setSearchError(null);
    setJobs([]);
    setMaxDisplay(30);

    try {
      const recaptchaToken = await getRecaptchaToken("jobs_search");

      const res = await fetch("/api/jobs", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          query: searchQuery.trim(),
          location: searchLocation.trim(),
          country: searchCountry.trim() || "fr",
          contract_time: contractTime === "any" ? undefined : contractTime,
          contract_type: contractType === "any" ? undefined : contractType,
          remote_only: remoteOnly,
          salary_min: minSalary ? Number(minSalary) || undefined : undefined,
          salary_max: maxSalary ? Number(maxSalary) || undefined : undefined,
          max_days_old: publishedWithin === "any" ? undefined : Number(publishedWithin),
          page: 1,
          results_per_page: 100,
          recaptchaToken,
        }),
      });

      const contentType = res.headers.get("content-type") || "";
      if (!contentType.includes("application/json")) {
        const textErr = await res.text();
        console.error("R√©ponse non JSON /api/jobs:", textErr);
        throw new Error("R√©ponse serveur invalide (jobs).");
      }

      const data = await res.json();
      if (!res.ok) throw new Error(data.error || "Erreur lors de la recherche d'offres.");

      const rawList: any[] = data.jobs || data.results || [];

      let list: JobOffer[] = rawList.map((j, index) => {
        const id =
          j.id?.toString() ??
          j.adref?.toString() ??
          `job_${index}_${Math.random().toString(36).slice(2)}`;

        const title = j.title || "";
        const company = (j.company && j.company.display_name) || j.company || "";
        const location = (j.location && j.location.display_name) || j.location || "";
        const url = j.url || j.redirect_url || "";
        const description = j.description || "";
        const created = j.created || "";

        const salary =
          j.salary_min && j.salary_max
            ? `${Math.round(j.salary_min)} - ${Math.round(j.salary_max)} ‚Ç¨`
            : j.salary_min
              ? `‚â• ${Math.round(j.salary_min)} ‚Ç¨`
              : null;

        const matchScore = computeMatchScore(j, profile, searchQuery, searchLocation, remoteOnly);

        return { id, title, company, location, url, description, created, salary, matchScore };
      });

      if (remoteOnly) {
        list = list.filter((job) => {
          const txt = normalize(`${job.title} ${job.description} ${job.location}`);
          return /remote|teletravail|home\s*office|hybride/.test(txt);
        });
      }

      list.sort((a, b) => b.matchScore - a.matchScore);
      setJobs(list);

      if (!list.length) setSearchError("Aucune offre trouv√©e pour ces crit√®res.");
    } catch (err: any) {
      console.error(err);
      setSearchError(err.message || "Erreur lors de la recherche d'offres, r√©essaie plus tard.");
    } finally {
      setSearchLoading(false);
    }
  };

  // SUIVI candidature apr√®s visite
  const createApplicationFromJob = async (job: LastOpenedJob) => {
    if (!userId || !job) return;
    try {
      const appsRef = collection(db, "applications");
      await addDoc(appsRef, {
        userId,
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp(),
        company: job.company,
        jobTitle: job.title,
        jobLink: job.url,
        location: job.location || "",
        status: "applied",
        source: "Adzuna / Apply",
      });
    } catch (e) {
      console.error("Erreur cr√©ation suivi candidature depuis Apply:", e);
    }
  };

  const handleAnswerApplied = async (applied: boolean) => {
    if (!pendingApplyJob) {
      clearPendingApplyJob();
      return;
    }
    if (applied) await createApplicationFromJob(pendingApplyJob);
    clearPendingApplyJob();
  };

  // G√©n√©ration CV / ZIP
  const [cvJobLoadingId, setCvJobLoadingId] = useState<string | null>(null);
  const [cvLmJobLoadingId, setCvLmJobLoadingId] = useState<string | null>(null);

  const [cvLang] = useState<Lang>("fr");
  const [lmLang] = useState<Lang>("fr");

  const generateCvForJob = async (job: JobOffer) => {
    if (!profile) {
      alert("Aucun profil CV IA d√©tect√©. Va d'abord dans l'onglet CV IA pour analyser ton CV PDF.");
      return;
    }

    setCvJobLoadingId(job.id);
    try {
      const recaptchaToken = await getRecaptchaToken("generate_cv_pdf");

      const res = await fetch(GENERATE_CV_API, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          profile,
          targetJob: job.title,
          template: "ats",
          lang: cvLang,
          contract: profile.contractType || "",
          jobLink: job.url,
          jobDescription: job.description,
          recaptchaToken,
        }),
      });

      if (!res.ok) {
        const text = await res.text();
        throw new Error(text || "Erreur serveur lors de la g√©n√©ration du CV.");
      }

      const blob = await res.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "cv-ia.pdf";
      document.body.appendChild(a);
      a.click();
      a.remove();
      window.URL.revokeObjectURL(url);
    } catch (e: any) {
      console.error("Erreur g√©n√©ration CV pour offre:", e);
      alert(e?.message || "Impossible de g√©n√©rer le CV pour cette offre.");
    } finally {
      setCvJobLoadingId(null);
    }
  };

  const generateCvLmForJob = async (job: JobOffer) => {
    if (!profile) {
      alert("Aucun profil CV IA d√©tect√©. Va d'abord dans l'onglet CV IA pour analyser ton CV PDF.");
      return;
    }

    setCvLmJobLoadingId(job.id);
    try {
      const recaptchaToken = await getRecaptchaToken("generate_cv_lm_zip");

      const res = await fetch(GENERATE_CV_LM_ZIP_API, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          profile,
          targetJob: job.title,
          template: "ats",
          lang: cvLang,
          contract: profile.contractType || "",
          jobLink: job.url,
          jobDescription: job.description,
          lm: {
            companyName: job.company,
            jobTitle: job.title,
            jobDescription: job.description,
            jobLink: job.url,
            lang: lmLang,
          },
          recaptchaToken,
        }),
      });

      if (!res.ok) {
        const text = await res.text();
        throw new Error(text || "Erreur serveur lors de la g√©n√©ration du ZIP CV + LM.");
      }

      const blob = await res.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "cv-lm-ia.zip";
      document.body.appendChild(a);
      a.click();
      a.remove();
      window.URL.revokeObjectURL(url);
    } catch (e: any) {
      console.error("Erreur g√©n√©ration CV+LM pour offre:", e);
      alert(e?.message || "Impossible de g√©n√©rer le CV + LM pour cette offre.");
    } finally {
      setCvLmJobLoadingId(null);
    }
  };

  // RENDER
  if (!userId && !loadingProfile) {
    return (
      <div className="max-w-5xl mx-auto px-4 py-8">
        <div className="glass rounded-2xl p-6 space-y-3">
          <h1 className="text-xl font-semibold">Postuler √† des offres</h1>
          <p className="text-sm text-[var(--muted)]">
            Connecte-toi pour rechercher des offres, g√©n√©rer ton CV/LM et suivre tes candidatures.
          </p>
        </div>
      </div>
    );
  }

  const displayedJobs = jobs.slice(0, maxDisplay);

  return (
    <motion.div
      initial={{ opacity: 0, y: 10 }}
      animate={{ opacity: 1, y: 0 }}
      transition={{ duration: 0.2 }}
      className="max-w-5xl mx-auto px-4 py-6 space-y-6"
    >
      {pendingApplyJob && (
        <div className="fixed bottom-4 left-1/2 -translate-x-1/2 z-40 max-w-md w-full px-3">
          <div className="rounded-2xl bg-[var(--bg)] border border-[var(--border)] shadow-lg px-4 py-3 text-xs flex flex-col gap-2">
            <p className="text-[var(--muted)]">
              Tu viens de consulter{" "}
              <span className="font-semibold text-[var(--ink)]">{pendingApplyJob.title}</span> chez{" "}
              <span className="font-semibold text-[var(--ink)]">{pendingApplyJob.company}</span>. As-tu postul√© ?
            </p>
            <div className="flex justify-end gap-2">
              <button
                className="px-3 py-1 rounded-full text-[11px] bg-white/5 hover:bg-white/10"
                onClick={() => handleAnswerApplied(false)}
              >
                Non
              </button>
              <button
                className="px-3 py-1 rounded-full text-[11px] bg-emerald-500/80 hover:bg-emerald-500 text-black font-medium"
                onClick={() => handleAnswerApplied(true)}
              >
                Oui, ajouter au suivi
              </button>
            </div>
          </div>
        </div>
      )}

      <header className="glass rounded-2xl p-5 space-y-3">
        <div className="flex flex-wrap items-center justify-between gap-2">
          <div>
            <h1 className="text-2xl font-semibold">Recherche & candidatures</h1>
            <p className="text-sm text-[var(--muted)] max-w-xl">
              1) Cherche des offres, 2) g√©n√®re CV + LM en 1 clic, 3) postule et mets √† jour ton suivi.
            </p>
          </div>
          <div className="text-[11px] rounded-full border border-[var(--border)] px-3 py-1 bg-[var(--bg-soft)]">
            Profil CV IA :{" "}
            <span className="font-medium">
              {loadingProfile ? "Chargement‚Ä¶" : profile ? profileName : "Non d√©tect√©"}
            </span>
          </div>
        </div>
      </header>

      <section className="glass rounded-2xl p-5 space-y-4">
        <div className="flex items-center justify-between gap-2">
          <h2 className="text-lg font-semibold">1. Rechercher des offres (Adzuna)</h2>
          <span className="text-[11px] text-[var(--muted)]">
            API via <code>/api/jobs</code>
          </span>
        </div>

        <form onSubmit={handleSearchJobs} className="grid md:grid-cols-4 gap-3 text-sm">
          <div className="md:col-span-2 relative">
            <label className="block text-[11px] font-medium text-[var(--muted)] mb-1">
              M√©tier / secteur
            </label>
            <input
              className="input w-full"
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value)}
              placeholder="Ex : kin√©, d√©veloppeur web, data‚Ä¶"
            />
            {jobAutocomplete.length > 0 && (
              <div className="absolute z-20 mt-1 w-full rounded-md border border-[var(--border)] bg-[var(--bg)] text-[11px] max-h-40 overflow-auto">
                {jobAutocomplete.map((s) => (
                  <button
                    key={s}
                    type="button"
                    className="w-full text-left px-2 py-1 hover:bg-white/5"
                    onClick={() => setSearchQuery(s)}
                  >
                    {s}
                  </button>
                ))}
              </div>
            )}
          </div>

          <div className="relative">
            <label className="block text-[11px] font-medium text-[var(--muted)] mb-1">
              Ville / zone
            </label>
            <input
              className="input w-full"
              value={searchLocation}
              onChange={(e) => setSearchLocation(e.target.value)}
              placeholder="Ex : Paris, Lyon, remote‚Ä¶"
            />
            {cityAutocomplete.length > 0 && (
              <div className="absolute z-20 mt-1 w-full rounded-md border border-[var(--border)] bg-[var(--bg)] text-[11px] max-h-40 overflow-auto">
                {cityAutocomplete.map((s) => (
                  <button
                    key={s}
                    type="button"
                    className="w-full text-left px-2 py-1 hover:bg-white/5"
                    onClick={() => setSearchLocation(s)}
                  >
                    {s}
                  </button>
                ))}
              </div>
            )}
          </div>

          <div>
            <label className="block text-[11px] font-medium text-[var(--muted)] mb-1">
              Pays
            </label>
            <select className="input w-full" value={searchCountry} onChange={(e) => setSearchCountry(e.target.value)}>
              {COUNTRY_CODES.map((c) => (
                <option key={c.code} value={c.code}>
                  {c.label} ({c.code})
                </option>
              ))}
            </select>
          </div>

          <div>
            <label className="block text-[11px] font-medium text-[var(--muted)] mb-1">
              Temps de travail
            </label>
            <select
              className="input w-full"
              value={contractTime}
              onChange={(e) => setContractTime(e.target.value as any)}
            >
              <option value="any">Indiff√©rent</option>
              <option value="full_time">Temps plein</option>
              <option value="part_time">Temps partiel</option>
            </select>
          </div>

          <div>
            <label className="block text-[11px] font-medium text-[var(--muted)] mb-1">
              Type de contrat
            </label>
            <select
              className="input w-full"
              value={contractType}
              onChange={(e) => setContractType(e.target.value as any)}
            >
              <option value="any">Indiff√©rent</option>
              <option value="permanent">CDI / permanent</option>
              <option value="contract">CDD / contract</option>
            </select>
          </div>

          <div>
            <label className="block text-[11px] font-medium text-[var(--muted)] mb-1">
              Salaire min (‚Ç¨/an)
            </label>
            <input className="input w-full" value={minSalary} onChange={(e) => setMinSalary(e.target.value)} placeholder="Ex : 30000" />
          </div>
          <div>
            <label className="block text-[11px] font-medium text-[var(--muted)] mb-1">
              Salaire max (‚Ç¨/an)
            </label>
            <input className="input w-full" value={maxSalary} onChange={(e) => setMaxSalary(e.target.value)} placeholder="Ex : 50000" />
          </div>

          <div>
            <label className="block text-[11px] font-medium text-[var(--muted)] mb-1">
              Offres publi√©es depuis
            </label>
            <select className="input w-full" value={publishedWithin} onChange={(e) => setPublishedWithin(e.target.value as any)}>
              <option value="any">Peu importe</option>
              <option value="1">24 heures</option>
              <option value="3">3 jours</option>
              <option value="7">7 jours</option>
              <option value="30">30 jours</option>
            </select>
          </div>

          <div className="flex flex-col justify-between gap-2">
            <label className="flex items-center gap-2 text-[11px] text-[var(--muted)] mt-1">
              <input
                type="checkbox"
                className="h-3.5 w-3.5"
                checked={remoteOnly}
                onChange={(e) => setRemoteOnly(e.target.checked)}
              />
              <span>T√©l√©travail / remote uniquement</span>
            </label>

            <label className="block text-[11px] font-medium text-[var(--muted)]">Nb max √† afficher</label>
            <select className="input w-full text-[11px]" value={maxDisplay} onChange={(e) => setMaxDisplay(Number(e.target.value))}>
              <option value={20}>20</option>
              <option value={30}>30</option>
              <option value={50}>50</option>
              <option value={100}>100</option>
            </select>
          </div>

          <div className="flex items-end md:justify-end md:col-span-2">
            <button type="submit" className="btn-primary w-full md:w-auto" disabled={searchLoading}>
              {searchLoading ? "Recherche en cours..." : "Chercher des offres"}
            </button>
          </div>
        </form>

        <div className="space-y-1 text-[11px] text-[var(--muted)] mt-1">
          <p>
            üí° R√©sultats tri√©s par <strong>score de match</strong> avec ton profil.
          </p>
          {searchError && <p className="text-red-400 text-[11px]">{searchError}</p>}
          {!!jobs.length && (
            <p>
              {jobs.length} offre(s) trouv√©e(s) ‚Äì {displayedJobs.length} affich√©e(s).
            </p>
          )}
        </div>

        <div className="mt-3 space-y-3 max-h-[420px] overflow-auto custom-scrollbar">
          {displayedJobs.map((job, index) => {
            const visited = visitedJobIds.includes(job.id);
            const createdDate = job.created ? new Date(job.created) : null;
            const rank = index + 1;

            return (
              <article
                key={job.id}
                className={`rounded-xl border p-3 text-sm transition-colors ${
                  visited
                    ? "border-[var(--border)] bg-white/5"
                    : "border-[var(--border-soft)] bg-black/20 hover:border-emerald-400/70"
                }`}
              >
                <div className="flex items-start justify-between gap-3">
                  <div>
                    <div className="flex items-center gap-2 flex-wrap">
                      <h3 className="font-semibold text-[13px]">{job.title}</h3>
                      <span className={`text-[10px] px-2 py-[2px] rounded-full border ${scoreBadgeClass(job.matchScore)}`}>
                        Match : <span className="font-semibold">{job.matchScore}%</span>
                      </span>
                      {rank <= 3 && (
                        <span className="text-[10px] px-2 py-[2px] rounded-full bg-emerald-500/10 text-emerald-300 border border-emerald-500/40">
                          Top {rank}
                        </span>
                      )}
                      {visited && (
                        <span className="text-[10px] px-2 py-[2px] rounded-full bg-white/10 text-[var(--muted)] border border-[var(--border)]/60">
                          D√©j√† consult√©e
                        </span>
                      )}
                    </div>
                    <p className="text-[11px] text-[var(--muted)]">
                      {job.company} ‚Ä¢ {job.location}
                    </p>
                    {job.salary && <p className="text-[11px] text-emerald-200 mt-1">Salaire estim√© : {job.salary}</p>}
                  </div>

                  <div className="flex flex-col items-end gap-2">
                    {createdDate && (
                      <span className="text-[10px] text-[var(--muted)]">
                        Publi√© le {createdDate.toLocaleDateString("fr-FR")}
                      </span>
                    )}

                    <div className="flex flex-wrap justify-end gap-1.5">
                      {job.url && (
                        <button
                          type="button"
                          className="text-[11px] px-2 py-1 rounded-full bg-white/10 hover:bg-white/20"
                          onClick={() => {
                            markJobVisited(job);
                            window.open(job.url, "_blank", "noopener,noreferrer");
                          }}
                        >
                          Ouvrir l&apos;offre ‚Üó
                        </button>
                      )}

                      <button
                        type="button"
                        className="text-[11px] px-2 py-1 rounded-full bg-[var(--bg)] border border-[var(--border)] hover:border-emerald-400/70"
                        onClick={() => generateCvForJob(job)}
                        disabled={cvJobLoadingId === job.id}
                      >
                        {cvJobLoadingId === job.id ? "CV..." : "CV 1 page"}
                      </button>

                      <button
                        type="button"
                        className="text-[11px] px-2 py-1 rounded-full bg-[var(--bg)] border border-[var(--border)] hover:border-emerald-400/70"
                        onClick={() => generateCvLmForJob(job)}
                        disabled={cvLmJobLoadingId === job.id}
                      >
                        {cvLmJobLoadingId === job.id ? "CV + LM..." : "CV + LM (ZIP)"}
                      </button>
                    </div>
                  </div>
                </div>

                {job.description && (
                  <p className="text-[11px] text-[var(--muted)] mt-2 line-clamp-3">
                    {job.description.replace(/<[^>]+>/g, "")}
                  </p>
                )}
              </article>
            );
          })}

          {!searchLoading && !jobs.length && !searchError && (
            <p className="text-xs text-[var(--muted)]">
              Aucun r√©sultat pour l&apos;instant. Lance une recherche.
            </p>
          )}
        </div>

        {jobs.length > displayedJobs.length && (
          <div className="pt-2 flex justify-center">
            <button
              type="button"
              className="text-[11px] px-3 py-1.5 rounded-full bg-white/5 hover:bg-white/10 border border-[var(--border)]"
              onClick={() => setMaxDisplay((m) => Math.min(m + 30, jobs.length))}
            >
              Afficher +30 offres (actuellement {displayedJobs.length}/{jobs.length})
            </button>
          </div>
        )}
      </section>
    </motion.div>
  );
}
````

## File: app/app/cv/CvTemplatePicker.tsx
````typescript
"use client";

import Image from "next/image";
import { getCvTemplates, type CvTemplateId } from "@/lib/pdf/templates/cvTemplates";

export function CvTemplatePicker({
  value,
  onChange,
}: {
  value: CvTemplateId;
  onChange: (id: CvTemplateId) => void;
}) {
  const templates = getCvTemplates();

  return (
    <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
      {templates.map((t) => {
        const selected = t.id === value;
        return (
          <button
            key={t.id}
            type="button"
            onClick={() => onChange(t.id)}
            className={[
              "text-left rounded-xl border p-3 hover:bg-gray-50 transition",
              selected ? "border-black ring-2 ring-black/10" : "border-gray-200",
            ].join(" ")}
          >
            <div className="relative w-full aspect-[4/3] rounded-lg overflow-hidden bg-gray-100">
              <Image
                src={t.previewSrc}
                alt={t.label}
                fill
                className="object-cover"
                sizes="(max-width: 768px) 50vw, 33vw"
              />
            </div>

            <div className="mt-2">
              <div className="flex items-center justify-between gap-2">
                <p className="font-medium">{t.label}</p>
                {selected ? (
                  <span className="text-xs px-2 py-1 rounded-full bg-black text-white">
                    S√©lectionn√©
                  </span>
                ) : null}
              </div>
              <p className="text-sm text-gray-600 mt-1">{t.description}</p>
            </div>
          </button>
        );
      })}
    </div>
  );
}
````

## File: app/app/history/page.tsx
````typescript
"use client";

export default function HistoryPage() {
  return (
    <div className="max-w-4xl mx-auto glass p-4">
      <h1 className="text-lg font-semibold mb-2">Section history</h1>
      <p className="text-sm text-[var(--muted)]">Historique de toutes tes g√©n√©rations IA.</p>
    </div>
  );
}
````

## File: app/app/interview/page.tsx
````typescript
// app/app/interview/page.tsx
"use client";

import { useEffect, useState } from "react";
import { useAuth } from "@/context/AuthContext";
import { db } from "@/lib/firebase";
import { doc, getDoc } from "firebase/firestore";
import {
  callGenerateInterviewQA,
  type GenerateInterviewQAResult,
} from "@/lib/gemini";
import InterviewChat from "@/components/InterviewChat";

type ExperienceLike = {
  company?: string;
  role?: string;
  title?: string;
  city?: string;
  location?: string;
  dates?: string;
  bullets?: string[];
};

type ProfileLike = {
  fullName?: string;
  profileHeadline?: string;
  title?: string;
  city?: string;
  experiences?: ExperienceLike[] | any;
  experience?: ExperienceLike[] | any;
  [key: string]: any;
};

type QaPair = {
  question: string;
  answer: string;
};

export default function InterviewPage() {
  const { user } = useAuth();

  const [profile, setProfile] = useState<ProfileLike | null>(null);
  const [loadingProfile, setLoadingProfile] = useState(true);
  const [loadError, setLoadError] = useState<string | null>(
    null
  );

  const [qaLang, setQaLang] = useState<"fr" | "en">("fr");
  const [selectedExpIndex, setSelectedExpIndex] =
    useState<string>("");
  const [qaLoading, setQaLoading] = useState(false);
  const [qaError, setQaError] = useState<string | null>(null);
  const [qaPairs, setQaPairs] = useState<QaPair[]>([]);

  const [copiedIndex, setCopiedIndex] = useState<number | null>(
    null
  );

  // Chargement profil CV
  useEffect(() => {
    const fetchProfile = async () => {
      if (!user) {
        setProfile(null);
        setLoadingProfile(false);
        return;
      }
      try {
        const ref = doc(db, "profiles", user.uid);
        const snap = await getDoc(ref);
        if (snap.exists()) {
          setProfile(snap.data() as ProfileLike);
        } else {
          setProfile(null);
        }
      } catch (e) {
        console.error(e);
        setLoadError("Impossible de charger ton profil CV.");
      } finally {
        setLoadingProfile(false);
      }
    };

    fetchProfile();
  }, [user]);

  // R√©cup√©ration robuste des exp√©riences
  const experiences: ExperienceLike[] = (() => {
    if (!profile) return [];
    const possible =
      (profile.experiences as any) ??
      (profile.experience as any) ??
      [];
    if (Array.isArray(possible))
      return possible as ExperienceLike[];
    return [];
  })();

  // Reset quand on change de langue ou d'exp√©rience
  useEffect(() => {
    setQaPairs([]);
    setQaError(null);
    setCopiedIndex(null);
  }, [selectedExpIndex, qaLang]);

  const handleGenerateQA = async () => {
    if (!profile) {
      setQaError(
        "Charge d'abord ton CV dans l‚Äôonglet Profil."
      );
      return;
    }
    if (!selectedExpIndex) {
      setQaError("S√©lectionne d'abord une exp√©rience.");
      return;
    }

    const index = parseInt(selectedExpIndex, 10);
    if (Number.isNaN(index) || !experiences[index]) {
      setQaError("Exp√©rience invalide.");
      return;
    }

    setQaError(null);
    setQaLoading(true);

    try {
      let result: GenerateInterviewQAResult;

      try {
        result = await callGenerateInterviewQA({
          profile,
          experienceIndex: index,
          lang: qaLang,
        });
      } catch (err: any) {
        console.error(
          "Erreur callGenerateInterviewQA:",
          err
        );
        setQaPairs([]);
        setQaError(
          err?.message ||
            "Erreur pendant la g√©n√©ration des questions (appel serveur)."
        );
        return;
      }

      const rawQuestions: any[] = Array.isArray(
        result.questions
      )
        ? result.questions
        : [];

      if (!rawQuestions.length) {
        console.error(
          "R√©ponse generateInterviewQA inattendue:",
          result
        );
        setQaPairs([]);
        setQaError(
          "L'IA n'a pas renvoy√© de questions exploitables. V√©rifie que l'exp√©rience contient bien des missions/bullets, ou r√©essaie plus tard."
        );
        return;
      }

      const mapped: QaPair[] = rawQuestions.map(
        (q: any, idx: number) => ({
          question:
            (q?.question ??
              q?.q ??
              `Question ${idx + 1}`) + "",
          answer: (q?.answer ?? q?.a ?? "") + "",
        })
      );

      setQaPairs(mapped);
      setCopiedIndex(null);
    } catch (err: any) {
      console.error("handleGenerateQA error:", err);
      setQaError(
        err?.message ||
          "Erreur inattendue pendant la g√©n√©ration des questions."
      );
      setQaPairs([]);
    } finally {
      setQaLoading(false);
    }
  };

  const handleCopyOne = async (idx: number) => {
    const qa = qaPairs[idx];
    if (!qa) return;

    const text = `Q: ${qa.question}\n\nR: ${qa.answer}`;
    try {
      if (navigator.clipboard?.writeText) {
        await navigator.clipboard.writeText(text);
      } else {
        const textarea = document.createElement("textarea");
        textarea.value = text;
        textarea.style.position = "fixed";
        textarea.style.opacity = "0";
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand("copy");
        document.body.removeChild(textarea);
      }
      setCopiedIndex(idx);
      setTimeout(() => setCopiedIndex(null), 1500);
    } catch (e) {
      console.error(e);
      alert("Impossible de copier automatiquement le texte.");
    }
  };

  const handleCopyAll = async () => {
    if (!qaPairs.length) return;
    const text = qaPairs
      .map(
        (qa, i) =>
          `Q${i + 1}. ${qa.question}\nR${i + 1}. ${
            qa.answer
          }\n`
      )
      .join("\n");

    try {
      if (navigator.clipboard?.writeText) {
        await navigator.clipboard.writeText(text);
      } else {
        const textarea = document.createElement("textarea");
        textarea.value = text;
        textarea.style.position = "fixed";
        textarea.style.opacity = "0";
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand("copy");
        document.body.removeChild(textarea);
      }
      setCopiedIndex(-1);
      setTimeout(() => setCopiedIndex(null), 1500);
    } catch (e) {
      console.error(e);
      alert("Impossible de copier automatiquement le texte.");
    }
  };

  // √âTATS GLOBALS PAGE
  if (loadingProfile) {
    return (
      <div className="max-w-5xl mx-auto glass p-6 rounded-2xl">
        <p className="text-sm text-[var(--muted)]">
          Chargement de ton profil CV...
        </p>
      </div>
    );
  }

  if (!profile) {
    return (
      <div className="max-w-5xl mx-auto glass p-6 rounded-2xl space-y-3">
        {loadError && (
          <p className="text-sm text-[var(--danger)]">
            {loadError}
          </p>
        )}
        <h1 className="text-xl font-semibold">
          Commence par analyser ton CV üìÑ
        </h1>
        <p className="text-sm text-[var(--muted)]">
          Va dans l&apos;onglet{" "}
          <span className="font-semibold">Profil CV</span> pour
          uploader ton CV. L&apos;IA utilisera ensuite ces
          informations pour g√©n√©rer des questions / r√©ponses et
          simuler des entretiens.
        </p>
      </div>
    );
  }

  // PAGE PRINCIPALE
  return (
    <div className="max-w-5xl mx-auto space-y-6">
      {/* Header g√©n√©ral */}
      <header className="glass rounded-2xl p-5 space-y-3">
        <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
          <div>
            <h1 className="text-2xl font-semibold mb-1">
              Pr√©parer ton entretien üé§
            </h1>
            <p className="text-sm text-[var(--muted)]">
              Utilise l&apos;IA pour g√©n√©rer des questions /
              r√©ponses √† partir de ton CV, puis entra√Æne-toi en
              conditions r√©elles avec un simulateur d&apos;entretien
              (texte + voix).
            </p>
          </div>
          <div className="text-right text-xs text-[var(--muted)]">
            <p className="font-semibold">
              {profile.fullName || "Profil"}
            </p>
            <p>
              {profile.profileHeadline ||
                profile.title ||
                "Candidat"}
            </p>
            {profile.city && <p>{profile.city}</p>}
          </div>
        </div>
      </header>

      {/* Bloc 1 : G√©n√©ration Q/R √† partir d'une exp√©rience */}
      <section className="glass rounded-2xl p-5 space-y-4">
        <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
          <div>
            <h2 className="text-lg font-semibold">
              Questions / R√©ponses sur une exp√©rience
            </h2>
            <p className="text-xs text-[var(--muted)]">
              Choisis une exp√©rience de ton CV. L&apos;assistant
              g√©n√©rera des questions cibl√©es (missions, r√©sultats,
              comp√©tences) avec des exemples de r√©ponses.
            </p>
          </div>
          <div className="flex items-center gap-2">
            <span className="text-xs text-[var(--muted)]">
              Langue
            </span>
            <select
              value={qaLang}
              onChange={(e) =>
                setQaLang(
                  e.target.value === "en" ? "en" : "fr"
                )
              }
              className="select-brand text-xs"
            >
              <option value="fr">Fran√ßais</option>
              <option value="en">English</option>
            </select>
          </div>
        </div>

        {experiences.length === 0 && (
          <p className="text-xs text-[var(--danger)]">
            Ton profil ne contient aucune exp√©rience. V√©rifie que
            l&apos;analyse de ton CV a bien d√©tect√© tes postes
            (section &quot;experiences&quot; dans le document
            Firestore{" "}
            <code>profiles/{user?.uid}</code>).
          </p>
        )}

        <div>
          <label className="block text-xs font-medium text-[var(--muted)] mb-1">
            Exp√©rience
          </label>
          <select
            className="select-brand w-full text-sm"
            value={selectedExpIndex}
            onChange={(e) =>
              setSelectedExpIndex(e.target.value)
            }
          >
            <option value="">
              -- S√©lectionne une exp√©rience --
            </option>
            {experiences.map((exp, idx) => {
              const role =
                exp.role || exp.title || "Poste";
              const company =
                exp.company || "Entreprise";
              const dates = exp.dates || "";
              const city =
                exp.city || exp.location || "";
              return (
                <option
                  key={idx}
                  value={idx.toString()}
                >
                  {role} ‚Äî {company}{" "}
                  {dates && `(${dates})`}{" "}
                  {city && `¬∑ ${city}`}
                </option>
              );
            })}
          </select>
        </div>

        {qaError && (
          <p className="text-xs text-[var(--danger)] whitespace-pre-line">
            {qaError}
          </p>
        )}

        <div className="flex justify-center">
          <button
            type="button"
            className="btn-primary min-w-[200px]"
            onClick={handleGenerateQA}
            disabled={qaLoading || !experiences.length}
          >
            {qaLoading
              ? qaLang === "en"
                ? "Generating..."
                : "G√©n√©ration en cours..."
              : "G√©n√©rer les questions ‚ú®"}
          </button>
        </div>

        {/* Liste Q&A */}
        <div className="mt-2 p-4 card-soft rounded-xl max-h-[420px] overflow-auto text-sm">
          <div className="flex items-center justify-between gap-3 mb-2">
            <h3 className="text-sm font-semibold">
              Questions d&apos;entretien g√©n√©r√©es
            </h3>
            <button
              type="button"
              className="btn-secondary text-[11px] px-3 py-1"
              onClick={handleCopyAll}
              disabled={!qaPairs.length}
            >
              {copiedIndex === -1
                ? "Tout copi√© ‚úî"
                : "Copier tout"}
            </button>
          </div>

          {qaLoading ? (
            <p className="text-center text-[var(--muted)]">
              {qaLang === "en"
                ? "Generating interview questions..."
                : "G√©n√©ration des questions en cours..."}
            </p>
          ) : !qaPairs.length ? (
            <p className="text-center text-[var(--muted)]">
              Les questions appara√Ætront ici apr√®s la
              g√©n√©ration. Utilise-les pour t&apos;entra√Æner √†
              r√©pondre √† l&apos;oral (m√©thode STAR, r√©sultats
              concrets, etc.).
            </p>
          ) : (
            <div className="space-y-4">
              {qaPairs.map((qa, idx) => (
                <div
                  key={idx}
                  className="border border-[var(--border-soft)] rounded-xl p-3 bg-black/20"
                >
                  <div className="flex items-center justify-between gap-2 mb-2">
                    <p className="font-semibold text-sm">
                      Q{idx + 1}. {qa.question}
                    </p>
                    <button
                      type="button"
                      className="btn-secondary text-[10px] px-2 py-1"
                      onClick={() =>
                        handleCopyOne(idx)
                      }
                    >
                      {copiedIndex === idx
                        ? "Copi√© ‚úî"
                        : "Copier Q/R"}
                    </button>
                  </div>
                  <p className="text-xs text-[var(--muted)] whitespace-pre-line">
                    {qa.answer}
                  </p>
                </div>
              ))}
            </div>
          )}
        </div>
      </section>

      {/* Bloc 2 : Simulateur d'entretien IA (texte + voix) */}
      {/* ‚ö†Ô∏è InterviewChat contient d√©j√† tout le layout (header, glass, etc.) */}
      <InterviewChat />
    </div>
  );
}
````

## File: app/app/pitch/page.tsx
````typescript
"use client";

export default function PitchPage() {
  return (
    <div className="max-w-4xl mx-auto glass p-4">
      <h1 className="text-lg font-semibold mb-2">Section pitch</h1>
      <p className="text-sm text-[var(--muted)]">Pitch oral IA pour pr√©parer tes entretiens.</p>
    </div>
  );
}
````

## File: app/app/settings/page.tsx
````typescript
"use client";

import { useState, type FormEvent } from "react";
import { useAuth } from "@/context/AuthContext";
import { updateEmail, sendEmailVerification } from "firebase/auth";

export default function SettingsPage() {
  const { user } = useAuth();
  const [newEmail, setNewEmail] = useState(user?.email ?? "");
  const [saving, setSaving] = useState(false);
  const [sendingVerification, setSendingVerification] = useState(false);
  const [info, setInfo] = useState<string | null>(null);
  const [error, setError] = useState<string | null>(null);

  // Si pas connect√©, on affiche juste un message (et on ne montre pas le reste de la page)
  if (!user) {
    return (
      <div className="max-w-4xl mx-auto glass p-4 text-sm">
        <p className="text-[var(--muted)]">
          Tu dois √™tre connect√© pour acc√©der √† tes param√®tres.
        </p>
      </div>
    );
  }

  async function handleResendVerification() {
    setError(null);
    setInfo(null);

    // üîê S√©curit√© + typage TS : on rev√©rifie que user existe
    if (!user) {
      setError("Tu dois √™tre connect√© pour envoyer un email de v√©rification.");
      return;
    }

    setSendingVerification(true);
    try {
      await sendEmailVerification(user);
      setInfo(
        `Un nouvel email de validation a √©t√© envoy√© √† ${user.email}. Pense √† v√©rifier tes spams.`
      );
    } catch (err) {
      console.error("Resend verification error:", err);
      setError(
        "Impossible d'envoyer l'email de validation pour le moment. Merci de r√©essayer plus tard."
      );
    } finally {
      setSendingVerification(false);
    }
  }

  async function handleChangeEmail(e: FormEvent<HTMLFormElement>) {
    e.preventDefault();
    setError(null);
    setInfo(null);
    setSaving(true);

    // üîê S√©curit√© + typage TS : on rev√©rifie que user existe
    if (!user) {
      setError(
        "Tu dois √™tre connect√© pour modifier ton adresse email."
      );
      setSaving(false);
      return;
    }

    try {
      if (!newEmail || newEmail === user.email) {
        setInfo("L'adresse email est d√©j√† √† jour.");
        setSaving(false);
        return;
      }

      await updateEmail(user, newEmail);

      try {
        await sendEmailVerification(user);
        setInfo(
          `Ton adresse email a √©t√© mise √† jour. Un email de validation a √©t√© envoy√© √† ${newEmail}.`
        );
      } catch (e) {
        console.error("sendEmailVerification apr√®s updateEmail:", e);
        setInfo(
          `Ton adresse email a √©t√© mise √† jour en ${newEmail}, mais l'email de validation n'a pas pu √™tre envoy√©.`
        );
      }
    } catch (err: any) {
      console.error("Update email error:", err);
      const code = err?.code as string | undefined;

      if (code === "auth/invalid-email") {
        setError("L'adresse email saisie n'est pas valide.");
      } else if (code === "auth/email-already-in-use") {
        setError("Cette adresse email est d√©j√† associ√©e √† un autre compte.");
      } else if (code === "auth/requires-recent-login") {
        setError(
          "Pour modifier ton adresse email, merci de te reconnecter puis de r√©essayer (mesure de s√©curit√©)."
        );
      } else {
        setError(
          "Impossible de mettre √† jour l'adresse email pour le moment. Merci de r√©essayer."
        );
      }
    } finally {
      setSaving(false);
    }
  }

  return (
    <div className="max-w-4xl mx-auto glass p-4 sm:p-6 text-sm">
      <h1 className="text-lg font-semibold mb-2">Profil & s√©curit√©</h1>
      <p className="text-xs text-[var(--muted)] mb-4">
        G√®re ton adresse email de connexion et le statut de validation de ton compte.
      </p>

      {info && (
        <p className="mb-3 text-xs text-emerald-400 bg-emerald-400/10 border border-emerald-400/40 rounded-md px-3 py-2">
          {info}
        </p>
      )}
      {error && (
        <p className="mb-3 text-xs text-red-400 bg-red-400/10 border border-red-400/40 rounded-md px-3 py-2">
          {error}
        </p>
      )}

      <div className="space-y-4">
        {/* Statut actuel */}
        <div>
          <h2 className="text-sm font-semibold mb-1">
            Statut de l&apos;adresse email
          </h2>
          <p className="text-xs text-[var(--muted)] mb-1">
            Adresse actuelle :{" "}
            <span className="font-medium text-[var(--ink)]">
              {user.email}
            </span>
          </p>
          <p className="text-xs">
            {user.emailVerified ? (
              <span className="text-emerald-400">
                ‚úÖ Adresse email v√©rifi√©e. Ton compte est pleinement activ√©.
              </span>
            ) : (
              <span className="text-amber-300">
                ‚ö†Ô∏è Adresse email non v√©rifi√©e. Certaines fonctionnalit√©s peuvent
                √™tre restreintes tant que tu n&apos;as pas valid√© ton email.
              </span>
            )}
          </p>

          {!user.emailVerified && (
            <button
              type="button"
              onClick={handleResendVerification}
              disabled={sendingVerification}
              className="btn-secondary mt-2 text-xs"
            >
              {sendingVerification
                ? "Envoi en cours..."
                : "Renvoyer l‚Äôemail de validation"}
            </button>
          )}
        </div>

        <hr className="border-[var(--border)]/60" />

        {/* Modification de l'email */}
        <div>
          <h2 className="text-sm font-semibold mb-2">
            Modifier mon adresse email
          </h2>
          <p className="text-xs text-[var(--muted)] mb-3">
            Utilise une adresse que tu consultes r√©guli√®rement. Pour des raisons
            de s√©curit√©, il est possible que nous te demandions de te reconnecter
            avant de valider le changement.
          </p>

          <form
            onSubmit={handleChangeEmail}
            className="space-y-2 text-sm max-w-sm"
          >
            <div>
              <label className="block mb-1 text-xs" htmlFor="newEmail">
                Nouvelle adresse email
              </label>
              <input
                id="newEmail"
                type="email"
                className="w-full rounded-lg bg-[var(--bg-soft)] border border-[var(--border)] px-3 py-2 text-xs"
                value={newEmail}
                onChange={(e) => setNewEmail(e.target.value)}
                required
              />
            </div>

            <button
              type="submit"
              disabled={saving}
              className="btn-primary mt-1"
            >
              {saving ? "Mise √† jour..." : "Mettre √† jour l'adresse email"}
            </button>
          </form>
        </div>
      </div>
    </div>
  );
}
````

## File: app/app/tracker/page.tsx
````typescript
"use client";

import { useEffect, useMemo, useState, FormEvent } from "react";
import { motion } from "framer-motion";
import { auth, db } from "@/lib/firebase";
import { onAuthStateChanged } from "firebase/auth";
import {
  collection,
  query,
  where,
  orderBy,
  onSnapshot,
  addDoc,
  serverTimestamp,
  doc,
  updateDoc,
  Timestamp,
} from "firebase/firestore";

// --- TYPES ---

type ApplicationStatus = "todo" | "sent" | "interview" | "offer" | "rejected";

type Application = {
  id: string;
  userId: string;
  company: string;
  jobTitle: string;
  status: ApplicationStatus;
  location?: string;
  contract?: string;
  source?: string; // LinkedIn, Indeed, R√©seau, etc.
  jobLink?: string;
  createdAt?: Date | null;
  updatedAt?: Date | null;
  lastActionDate?: Date | null;
  notes?: string;
  fromAutoCreate?: boolean; // cr√©√© depuis CV IA / LM
  hasCv?: boolean;
  hasLm?: boolean;
  hasPitch?: boolean;
  interviewAt?: Date | null; // üëâ date d'entretien
};

type FilterStatus = "all" | ApplicationStatus;
type IaFilter = "all" | "withCv" | "withLm" | "withPitch";

// --- Helpers dates ---

function formatDate(d?: Date | null) {
  if (!d) return "‚Äî";
  return d.toLocaleDateString("fr-FR", {
    day: "2-digit",
    month: "2-digit",
    year: "2-digit",
  });
}

function formatDateTime(d?: Date | null) {
  if (!d) return "Date √† pr√©ciser";
  return d.toLocaleString("fr-FR", {
    weekday: "short",
    day: "2-digit",
    month: "2-digit",
    hour: "2-digit",
    minute: "2-digit",
  });
}

function dateToInputValue(d?: Date | null): string {
  if (!d) return "";
  const pad = (n: number) => String(n).padStart(2, "0");
  const year = d.getFullYear();
  const month = pad(d.getMonth() + 1);
  const day = pad(d.getDate());
  const hour = pad(d.getHours());
  const minute = pad(d.getMinutes());
  return `${year}-${month}-${day}T${hour}:${minute}`;
}

// Convertit le format 'YYYY-MM-DDTHH:MM' du datetime-local en 'yyyymmddTHHMM'
function convertToApiDatetime(isoLocalString: string): string | null {
  if (!isoLocalString) return null;
  // Ex: "2025-11-24T20:00" -> "20251124T2000"
  return isoLocalString.replace(/[-:]/g, "").replace("T", "T");
}

// Label humain pour chaque statut
function statusLabel(status: ApplicationStatus): string {
  switch (status) {
    case "todo":
      return "√Ä envoyer";
    case "sent":
      return "Envoy√©e";
    case "interview":
      return "Entretien";
    case "offer":
      return "Offre";
    case "rejected":
      return "Refus";
    default:
      return status;
  }
}

// Couleurs tailwind pour le pill de statut
function statusClasses(status: ApplicationStatus): string {
  switch (status) {
    case "todo":
      return "bg-slate-800/80 text-slate-200 border-slate-600/80";
    case "sent":
      return "bg-sky-900/40 text-sky-200 border-sky-500/70";
    case "interview":
      return "bg-amber-900/40 text-amber-200 border-amber-500/70";
    case "offer":
      return "bg-emerald-900/40 text-emerald-200 border-emerald-500/70";
    case "rejected":
      return "bg-rose-900/40 text-rose-200 border-rose-500/70";
    default:
      return "bg-slate-800/80 text-slate-200 border-slate-600/80";
  }
}

export default function TrackerPage() {
  const [userId, setUserId] = useState<string | null>(null);
  const [userEmail, setUserEmail] = useState<string | null>(null);
  const [loadingAuth, setLoadingAuth] = useState(true);

  const [applications, setApplications] = useState<Application[]>([]);
  const [loadingApps, setLoadingApps] = useState(true);
  const [appsError, setAppsError] = useState<string | null>(null);

  // Pour √©viter certains probl√®mes d'hydratation (pagination)
  const [isMounted, setIsMounted] = useState(false);

  // Filtres
  const [filterStatus, setFilterStatus] = useState<FilterStatus>("all");
  const [iaFilter, setIaFilter] = useState<IaFilter>("all");
  const [searchTerm, setSearchTerm] = useState("");

  // Pagination
  const [itemsPerPage, setItemsPerPage] = useState<number>(10);
  const [currentPage, setCurrentPage] = useState<number>(1);

  // Formulaire "nouvelle candidature"
  const [showNewForm, setShowNewForm] = useState(false);
  const [savingNew, setSavingNew] = useState(false);

  const [newCompany, setNewCompany] = useState("");
  const [newJobTitle, setNewJobTitle] = useState("");
  const [newStatus, setNewStatus] = useState<ApplicationStatus>("todo");
  const [newLocation, setNewLocation] = useState("");
  const [newContract, setNewContract] = useState("");
  const [newSource, setNewSource] = useState("");
  const [newJobLink, setNewJobLink] = useState("");
  const [newNotes, setNewNotes] = useState("");
  const [newInterviewAt, setNewInterviewAt] = useState("");

  // √âdition d‚Äôune candidature (modale)
  const [editingApp, setEditingApp] = useState<Application | null>(null);
  const [editSaving, setEditSaving] = useState(false);
  const [editCompany, setEditCompany] = useState("");
  const [editJobTitle, setEditJobTitle] = useState("");
  const [editStatus, setEditStatus] = useState<ApplicationStatus>("todo");
  const [editLocation, setEditLocation] = useState("");
  const [editContract, setEditContract] = useState("");
  const [editSource, setEditSource] = useState("");
  const [editJobLink, setEditJobLink] = useState("");
  const [editNotes, setEditNotes] = useState("");
  const [editInterviewAt, setEditInterviewAt] = useState("");
  const [editHasCv, setEditHasCv] = useState(false);
  const [editHasLm, setEditHasLm] = useState(false);
  const [editHasPitch, setEditHasPitch] = useState(false);

  // --- Auth + chargement des candidatures ---

  useEffect(() => {
    setIsMounted(true);
  }, []);

  useEffect(() => {
    let unsubApps: (() => void) | null = null;

    const unsubAuth = onAuthStateChanged(auth, async (user) => {
      if (unsubApps) {
        unsubApps();
        unsubApps = null;
      }

      if (!user) {
        setUserId(null);
        setUserEmail(null);
        setApplications([]);
        setLoadingAuth(false);
        setLoadingApps(false);
        return;
      }

      setUserId(user.uid);
      setUserEmail(user.email ?? null);
      setLoadingAuth(false);

      const q = query(
        collection(db, "applications"),
        where("userId", "==", user.uid),
        orderBy("createdAt", "desc")
      );

      setLoadingApps(true);
      setAppsError(null);

      unsubApps = onSnapshot(
        q,
        (snap) => {
          const list: Application[] = snap.docs.map((docSnap) => {
            const data = docSnap.data() as any;
            return {
              id: docSnap.id,
              userId: data.userId,
              company: data.company || "",
              jobTitle: data.jobTitle || "",
              status: (data.status as ApplicationStatus) || "todo",
              location: data.location || "",
              contract: data.contract || data.contractType || "",
              source: data.source || "",
              jobLink: data.jobLink || "",
              notes: data.notes || "",
              fromAutoCreate: !!data.fromAutoCreate,
              hasCv: !!data.hasCv,
              hasLm: !!data.hasLm,
              hasPitch: !!data.hasPitch,
              createdAt: data.createdAt?.toDate ? data.createdAt.toDate() : null,
              updatedAt: data.updatedAt?.toDate ? data.updatedAt.toDate() : null,
              lastActionDate: data.lastActionDate?.toDate
                ? data.lastActionDate.toDate()
                : null,
              interviewAt: data.interviewAt?.toDate
                ? data.interviewAt.toDate()
                : null,
            };
          });
          setApplications(list);
          setLoadingApps(false);
        },
        (err) => {
          console.error("Erreur chargement candidatures:", err);
          setAppsError("Impossible de charger tes candidatures pour le moment.");
          setLoadingApps(false);
        }
      );
    });

    return () => {
      if (unsubApps) unsubApps();
      unsubAuth();
    };
  }, []);

  // --- Stats d√©riv√©es ---

  const {
    total,
    sentCount,
    interviewCount,
    offerCount,
    todoCount,
    trackedWithCv,
    trackedWithLm,
  } = useMemo(() => {
    const total = applications.length;
    let sentCount = 0;
    let interviewCount = 0;
    let offerCount = 0;
    let todoCount = 0;
    let trackedWithCv = 0;
    let trackedWithLm = 0;

    applications.forEach((app) => {
      if (app.status === "sent") sentCount++;
      if (app.status === "interview") interviewCount++;
      if (app.status === "offer") offerCount++;
      if (app.status === "todo") todoCount++;
      if (app.hasCv) trackedWithCv++;
      if (app.hasLm) trackedWithLm++;
    });

    return {
      total,
      sentCount,
      interviewCount,
      offerCount,
      todoCount,
      trackedWithCv,
      trackedWithLm,
    };
  }, [applications]);

  // Filtres combin√©s (statut + recherche + IA)
  const filteredApps = useMemo(() => {
    let list = [...applications];

    if (filterStatus !== "all") {
      list = list.filter((a) => a.status === filterStatus);
    }

    if (searchTerm.trim()) {
      const term = searchTerm.toLowerCase();
      list = list.filter(
        (a) =>
          a.company.toLowerCase().includes(term) ||
          a.jobTitle.toLowerCase().includes(term)
      );
    }

    if (iaFilter === "withCv") {
      list = list.filter((a) => a.hasCv);
    } else if (iaFilter === "withLm") {
      list = list.filter((a) => a.hasLm);
    } else if (iaFilter === "withPitch") {
      list = list.filter((a) => a.hasPitch);
    }

    return list;
  }, [applications, filterStatus, searchTerm, iaFilter]);

  // Pagination
  const totalPages = Math.max(
    1,
    Math.ceil((filteredApps.length || 1) / itemsPerPage)
  );

  useEffect(() => {
    setCurrentPage(1);
  }, [filterStatus, searchTerm, iaFilter, itemsPerPage]);

  const paginatedApps = useMemo(() => {
    const start = (currentPage - 1) * itemsPerPage;
    return filteredApps.slice(start, start + itemsPerPage);
  }, [filteredApps, currentPage, itemsPerPage]);

  // Agenda : entretiens √† venir
  const upcomingInterviews = useMemo(() => {
    const now = new Date();
    const withDate = applications.filter(
      (a) =>
        a.interviewAt &&
        a.interviewAt.getTime() >= now.getTime()
    );
    withDate.sort(
      (a, b) =>
        (a.interviewAt?.getTime() || 0) - (b.interviewAt?.getTime() || 0)
    );
    return withDate;
  }, [applications]);

  const visibilityLabel = userId ? "Associ√© √† ton compte" : "Invit√©";

  // --- Cr√©ation d'une nouvelle candidature (avec interviewAt) ---

  const handleAddApplication = async (e: FormEvent) => {
    e.preventDefault();
    if (!userId) return;

    if (!newCompany.trim() || !newJobTitle.trim()) {
      return;
    }

    setSavingNew(true);

    try {
      const interviewAtDate = newInterviewAt
        ? new Date(newInterviewAt)
        : null;

      const firestoreData: any = {
        userId,
        company: newCompany.trim(),
        jobTitle: newJobTitle.trim(),
        status: newStatus,
        location: newLocation.trim(),
        contract: newContract.trim(),
        source: newSource.trim(),
        jobLink: newJobLink.trim(),
        notes: newNotes.trim(),
        fromAutoCreate: false,
        hasCv: false,
        hasLm: false,
        hasPitch: false,
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp(),
        lastActionDate: serverTimestamp(),
      };

      if (interviewAtDate) {
        firestoreData.interviewAt = Timestamp.fromDate(interviewAtDate);
      }

      await addDoc(collection(db, "applications"), firestoreData);

      // Optionnel : simulation d'appel API calendrier
      if (newInterviewAt) {
        const start_datetime = convertToApiDatetime(newInterviewAt);
        if (start_datetime) {
          console.log("CALENDAR API: Create Event (New Application)", {
            title: `Entretien - ${newJobTitle.trim()} chez ${newCompany.trim()}`,
            start_datetime,
            duration: "1h",
            location: newLocation.trim(),
            description: `Lien: ${newJobLink.trim()} | Notes: ${newNotes.trim()}`,
          });
        }
      }

      // reset formulaire
      setNewCompany("");
      setNewJobTitle("");
      setNewStatus("todo");
      setNewLocation("");
      setNewContract("");
      setNewSource("");
      setNewJobLink("");
      setNewNotes("");
      setNewInterviewAt("");
      setShowNewForm(false);
    } catch (err) {
      console.error("Erreur ajout candidature:", err);
    } finally {
      setSavingNew(false);
    }
  };

  // --- Edition d'une candidature (modale) ---

  const openEditModal = (app: Application) => {
    setEditingApp(app);
    setEditCompany(app.company || "");
    setEditJobTitle(app.jobTitle || "");
    setEditStatus(app.status || "todo");
    setEditLocation(app.location || "");
    setEditContract(app.contract || "");
    setEditSource(app.source || "");
    setEditJobLink(app.jobLink || "");
    setEditNotes(app.notes || "");
    setEditInterviewAt(dateToInputValue(app.interviewAt || null));
    setEditHasCv(!!app.hasCv);
    setEditHasLm(!!app.hasLm);
    setEditHasPitch(!!app.hasPitch);
  };

  const closeEditModal = () => {
    setEditingApp(null);
  };

  const handleEditApplication = async (e: FormEvent) => {
    e.preventDefault();
    if (!userId || !editingApp) return;

    setEditSaving(true);

    try {
      const interviewAtDate = editInterviewAt
        ? new Date(editInterviewAt)
        : null;

      const updatedFields: any = {
        company: editCompany.trim(),
        jobTitle: editJobTitle.trim(),
        status: editStatus,
        location: editLocation.trim(),
        contract: editContract.trim(),
        source: editSource.trim(),
        jobLink: editJobLink.trim(),
        notes: editNotes.trim(),
        hasCv: editHasCv,
        hasLm: editHasLm,
        hasPitch: editHasPitch,
        updatedAt: serverTimestamp(),
        lastActionDate: serverTimestamp(),
      };

      if (interviewAtDate) {
        updatedFields.interviewAt = Timestamp.fromDate(interviewAtDate);
      } else {
        updatedFields.interviewAt = null;
      }

      await updateDoc(doc(db, "applications", editingApp.id), updatedFields);

      // Optionnel : simulation d'appel API calendrier
      if (editInterviewAt) {
        const start_datetime = convertToApiDatetime(editInterviewAt);
        if (start_datetime) {
          console.log("CALENDAR API: Create/Update Event (Edited Application)", {
            title: `Entretien - ${editJobTitle.trim()} chez ${editCompany.trim()}`,
            start_datetime,
            duration: "1h",
            location: editLocation.trim(),
            description: `Lien: ${editJobLink.trim()} | Notes: ${editNotes.trim()}`,
          });
        }
      }

      setEditingApp(null);
    } catch (err) {
      console.error("Erreur mise √† jour candidature:", err);
    } finally {
      setEditSaving(false);
    }
  };

  // --- Pagination buttons ---

  const paginationButtons = useMemo(() => {
    const pages: (number | string)[] = [];
    if (totalPages <= 6) {
      for (let i = 1; i <= totalPages; i++) pages.push(i);
    } else {
      pages.push(1);
      const left = Math.max(2, currentPage - 1);
      const right = Math.min(totalPages - 1, currentPage + 1);
      if (left > 2) pages.push("...");
      for (let i = left; i <= right; i++) pages.push(i);
      if (right < totalPages - 1) pages.push("...");
      pages.push(totalPages);
    }
    return pages;
  }, [currentPage, totalPages]);

  // --- RENDER ---

  if (!loadingAuth && !userId) {
    return (
      <motion.div
        initial={{ opacity: 0, y: 8 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ duration: 0.2 }}
        className="max-w-2xl mx-auto px-3 sm:px-4 py-8"
      >
        <section className="glass rounded-2xl border border-[var(--border)]/80 p-5 text-center space-y-3">
          <h1 className="text-lg sm:text-xl font-semibold">
            Suivi de candidatures
          </h1>
          <p className="text-sm text-[var(--muted)]">
            Connecte-toi pour voir et suivre toutes tes candidatures (CV + LM
            g√©n√©r√©s, entretiens, offres‚Ä¶).
          </p>
          <p className="text-xs text-[var(--muted)]">
            Depuis l&apos;assistant de candidature, coche l&apos;option{" "}
            <strong>‚ÄúCr√©er une entr√©e dans le Suivi üìå‚Äù</strong> pour qu&apos;une
            ligne soit cr√©√©e automatiquement ici.
          </p>
        </section>
      </motion.div>
    );
  }

  return (
    <motion.div
      initial={{ opacity: 0, y: 12 }}
      animate={{ opacity: 1, y: 0 }}
      transition={{ duration: 0.25 }}
      className="max-w-5xl mx-auto px-3 sm:px-4 py-5 sm:py-6 space-y-4"
    >
      {/* HEADER */}
      <section className="space-y-3">
        <div className="flex flex-wrap items-center justify-between gap-2">
          <p className="badge-muted flex items-center gap-1.5">
            <span className="w-1.5 h-1.5 rounded-full bg-emerald-400" />
            <span className="text-[11px] uppercase tracking-wider">
              Suivi de candidatures
            </span>
          </p>

          <div className="flex flex-wrap items-center gap-2 text-[11px]">
            <span className="inline-flex items-center rounded-full border border-[var(--border)] px-2 py-[2px]">
              Profil IA :{" "}
              <span className="ml-1 font-medium">
                {userEmail || "Connect√©"}
              </span>
            </span>
            <span className="inline-flex items-center rounded-full border border-[var(--border)] px-2 py-[2px]">
              Visibilit√© :{" "}
              <span className="ml-1 font-medium">{visibilityLabel}</span>
            </span>
          </div>
        </div>

        <div className="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
          <div className="space-y-1">
            <h1 className="text-lg sm:text-xl font-semibold">
              Ton tableau de bord de candidatures
            </h1>
            <p className="text-[12px] text-[var(--muted)] max-w-xl">
              Visualise o√π tu en es sur chaque candidature : envoy√©e, en
              attente, entretien, offre ou refus. Les candidatures cr√©√©es
              depuis l&apos;assistant de CV IA apparaissent automatiquement
              ici.
            </p>
          </div>

          <button
            type="button"
            onClick={() => setShowNewForm((v) => !v)}
            className="btn-primary text-xs sm:text-sm"
          >
            {showNewForm ? "Fermer le formulaire" : "Ajouter une candidature"}
          </button>
        </div>
      </section>

      {/* STATS */}
      <section className="grid grid-cols-2 sm:grid-cols-5 gap-2 sm:gap-3">
        <div className="glass border border-[var(--border)]/80 rounded-xl px-3 py-2.5 text-xs">
          <p className="text-[var(--muted)] mb-0.5">Total</p>
          <p className="text-lg font-semibold">{total}</p>
        </div>
        <div className="glass border border-[var(--border)]/80 rounded-xl px-3 py-2.5 text-xs">
          <p className="text-[var(--muted)] mb-0.5">√Ä envoyer</p>
          <p className="text-lg font-semibold">{todoCount}</p>
        </div>
        <div className="glass border border-[var(--border)]/80 rounded-xl px-3 py-2.5 text-xs">
          <p className="text-[var(--muted)] mb-0.5">Candidatures envoy√©es</p>
          <p className="text-lg font-semibold">{sentCount}</p>
        </div>
        <div className="glass border border-[var(--border)]/80 rounded-xl px-3 py-2.5 text-xs">
          <p className="text-[var(--muted)] mb-0.5">Entretiens</p>
          <p className="text-lg font-semibold">{interviewCount}</p>
        </div>
        <div className="glass border border-[var(--border)]/80 rounded-xl px-3 py-2.5 text-xs">
          <p className="text-[var(--muted)] mb-0.5">Offres</p>
          <p className="text-lg font-semibold">{offerCount}</p>
        </div>
      </section>

      {/* MINI STATS IA (CV / LM li√©s) */}
      <section className="grid grid-cols-2 sm:grid-cols-3 gap-2 sm:gap-3">
        <div className="glass border border-[var(--border)]/80 rounded-xl px-3 py-2.5 text-xs">
          <p className="text-[var(--muted)] mb-0.5">Candidatures avec CV IA</p>
          <p className="text-lg font-semibold">{trackedWithCv}</p>
          <p className="text-[10px] text-[var(--muted)] mt-0.5">
            Candidatures o√π tu as coch√© ou g√©n√©r√© un CV IA.
          </p>
        </div>
        <div className="glass border border-[var(--border)]/80 rounded-xl px-3 py-2.5 text-xs">
          <p className="text-[var(--muted)] mb-0.5">Candidatures avec LM IA</p>
          <p className="text-lg font-semibold">{trackedWithLm}</p>
          <p className="text-[10px] text-[var(--muted)] mt-0.5">
            Candidatures o√π tu as coch√© ou g√©n√©r√© une lettre IA.
          </p>
        </div>
        <div className="glass border border-[var(--border)]/80 rounded-xl px-3 py-2.5 text-xs">
          <p className="text-[var(--muted)] mb-0.5">Candidatures suivies</p>
          <p className="text-lg font-semibold">{total}</p>
          <p className="text-[10px] text-[var(--muted)] mt-0.5">
            Total de lignes dans ton tracker actuel.
          </p>
        </div>
      </section>

      {/* AGENDA ENTRETIENS √Ä VENIR */}
      <section className="glass border border-[var(--border)]/80 rounded-2xl p-4 sm:p-5 space-y-3">
        <div className="flex items-center justify-between gap-2">
          <div className="flex items-center gap-2">
            <span className="inline-flex h-7 w-7 items-center justify-center rounded-full bg-[var(--bg-soft)] border border-[var(--border)] text-sm">
              üìÖ
            </span>
            <div>
              <h2 className="text-sm sm:text-base font-semibold">
                Agenda ‚Äî Entretiens √† venir
              </h2>
              <p className="text-[11px] text-[var(--muted)]">
                Toutes les candidatures avec une date d&apos;entretien future
                apparaissent ici.
              </p>
            </div>
          </div>
          <span className="text-[11px] rounded-full border border-[var(--border)] px-2 py-[2px] text-[var(--muted)]">
            {upcomingInterviews.length} entretien
            {upcomingInterviews.length > 1 ? "s" : ""} √† venir
          </span>
        </div>

        {upcomingInterviews.length === 0 ? (
          <p className="text-[12px] text-[var(--muted)]">
            Aucun entretien programm√©. Quand tu ajoutes une date d&apos;entretien
            dans une candidature (champ &quot;Date / heure de l&apos;entretien&quot;),
            elle appara√Æt ici.
          </p>
        ) : (
          <div className="space-y-2 text-[12px]">
            {upcomingInterviews.slice(0, 5).map((app) => (
              <div
                key={app.id}
                className="flex items-start gap-3 rounded-lg border border-[var(--border)]/70 bg-[var(--bg-soft)] px-3 py-2.5"
              >
                <div className="mt-1 text-[18px]">üïí</div>
                <div className="flex-1 min-w-0">
                  <p className="font-medium truncate">
                    {app.jobTitle || "Poste"}{" "}
                    {app.company && (
                      <span className="text-[11px] text-[var(--muted)]">
                        ¬∑ {app.company}
                      </span>
                    )}
                  </p>
                  <p className="text-[11px] text-[var(--muted)]">
                    {formatDateTime(app.interviewAt)}
                  </p>
                  <div className="mt-1 flex flex-wrap gap-1.5 text-[10px] text-[var(--muted)]">
                    {app.location && (
                      <span className="inline-flex items-center gap-1 px-1.5 py-[1px] rounded-full bg-slate-900/70">
                        üìç {app.location}
                      </span>
                    )}
                    {app.source && (
                      <span className="inline-flex items-center gap-1 px-1.5 py-[1px] rounded-full bg-slate-900/70">
                        üåê {app.source}
                      </span>
                    )}
                  </div>
                </div>
              </div>
            ))}
          </div>
        )}
      </section>

      {/* FORMULAIRE NOUVELLE CANDIDATURE */}
      {showNewForm && (
        <section className="glass border border-[var(--border)]/80 rounded-2xl p-4 sm:p-5 space-y-3">
          <div className="flex items-center justify-between gap-2">
            <h2 className="text-base sm:text-lg font-semibold">
              Ajouter une candidature
            </h2>
            {savingNew && (
              <div className="flex items-center gap-2 text-[11px] text-[var(--muted)]">
                <div className="loader" />
                <span>Sauvegarde en cours‚Ä¶</span>
              </div>
            )}
          </div>

          <form
            onSubmit={handleAddApplication}
            className="space-y-3 text-[13px]"
          >
            <div className="grid sm:grid-cols-2 gap-3">
              <div>
                <label className="block text-[11px] mb-1 text-[var(--muted)]">
                  Entreprise
                </label>
                <input
                  type="text"
                  className="input text-[var(--ink)] bg-[var(--bg)] placeholder:text-[var(--muted)]"
                  placeholder="Ex : IMOGATE"
                  value={newCompany}
                  onChange={(e) => setNewCompany(e.target.value)}
                  required
                />
              </div>
              <div>
                <label className="block text-[11px] mb-1 text-[var(--muted)]">
                  Intitul√© du poste
                </label>
                <input
                  type="text"
                  className="input text-[var(--ink)] bg-[var(--bg)] placeholder:text-[var(--muted)]"
                  placeholder="Ex : Ing√©nieur R√©seaux & S√©curit√©"
                  value={newJobTitle}
                  onChange={(e) => setNewJobTitle(e.target.value)}
                  required
                />
              </div>
            </div>

            <div className="grid sm:grid-cols-3 gap-3">
              <div>
                <label className="block text-[11px] mb-1 text-[var(--muted)]">
                  Statut
                </label>
                <select
                  className="select-brand text-[var(--ink)] bg-[var(--bg-soft)]"
                  value={newStatus}
                  onChange={(e) =>
                    setNewStatus(e.target.value as ApplicationStatus)
                  }
                >
                  <option value="todo">√Ä envoyer</option>
                  <option value="sent">Envoy√©e</option>
                  <option value="interview">Entretien</option>
                  <option value="offer">Offre</option>
                  <option value="rejected">Refus</option>
                </select>
              </div>
              <div>
                <label className="block text-[11px] mb-1 text-[var(--muted)]">
                  Contrat (CDI, Stage‚Ä¶)
                </label>
                <input
                  type="text"
                  className="input text-[var(--ink)] bg-[var(--bg)] placeholder:text-[var(--muted)]"
                  placeholder="Ex : CDI, Alternance‚Ä¶"
                  value={newContract}
                  onChange={(e) => setNewContract(e.target.value)}
                />
              </div>
              <div>
                <label className="block text-[11px] mb-1 text-[var(--muted)]">
                  Lieu
                </label>
                <input
                  type="text"
                  className="input text-[var(--ink)] bg-[var(--bg)] placeholder:text-[var(--muted)]"
                  placeholder="Ex : Paris, Remote‚Ä¶"
                  value={newLocation}
                  onChange={(e) => setNewLocation(e.target.value)}
                />
              </div>
            </div>

            <div className="grid sm:grid-cols-2 gap-3">
              <div>
                <label className="block text-[11px] mb-1 text-[var(--muted)]">
                  Source
                </label>
                <input
                  type="text"
                  className="input text-[var(--ink)] bg-[var(--bg)] placeholder:text-[var(--muted)]"
                  placeholder="Ex : LinkedIn, Indeed, R√©seau‚Ä¶"
                  value={newSource}
                  onChange={(e) => setNewSource(e.target.value)}
                />
              </div>
              <div>
                <label className="block text-[11px] mb-1 text-[var(--muted)]">
                  Lien de l&apos;offre
                </label>
                <input
                  type="url"
                  className="input text-[var(--ink)] bg-[var(--bg)] placeholder:text-[var(--muted)]"
                  placeholder="https://"
                  value={newJobLink}
                  onChange={(e) => setNewJobLink(e.target.value)}
                />
              </div>
            </div>

            <div className="grid sm:grid-cols-2 gap-3">
              <div>
                <label className="block text-[11px] mb-1 text-[var(--muted)]">
                  Date / heure de l&apos;entretien (optionnel)
                </label>
                <input
                  type="datetime-local"
                  className="input text-[var(--ink)] bg-[var(--bg)]"
                  value={newInterviewAt}
                  onChange={(e) => setNewInterviewAt(e.target.value)}
                />
              </div>
            </div>

            <div>
              <label className="block text-[11px] mb-1 text-[var(--muted)]">
                Notes (rappels, contacts, prochaines √©tapes‚Ä¶)
              </label>
              <textarea
                rows={3}
                className="input textarea text-[var(--ink)] bg-[var(--bg)] placeholder:text-[var(--muted)]"
                placeholder="Ex : Relancer dans 5 jours, entretien technique pr√©vu, contact RH‚Ä¶"
                value={newNotes}
                onChange={(e) => setNewNotes(e.target.value)}
              />
            </div>

            <div className="flex flex-wrap gap-2 justify-end pt-1">
              <button
                type="button"
                onClick={() => setShowNewForm(false)}
                className="btn-secondary"
              >
                Annuler
              </button>
              <button
                type="submit"
                disabled={savingNew}
                className="btn-primary relative"
              >
                <span>
                  {savingNew ? "Ajout en cours..." : "Enregistrer la candidature"}
                </span>
                <div
                  className={`loader absolute inset-0 m-auto ${
                    savingNew ? "" : "hidden"
                  }`}
                />
              </button>
            </div>
          </form>
        </section>
      )}

      {/* RECHERCHE + FILTRES + LIMITE */}
      <section className="space-y-3">
        {/* Recherche + filtre statut */}
        <div className="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
          <div className="relative w-full sm:max-w-xs">
            <input
              type="text"
              className="input pl-8 text-[12px] bg-[var(--bg)] placeholder:text-[var(--muted)]"
              placeholder="Rechercher par entreprise ou poste‚Ä¶"
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
            />
            <span className="absolute left-2.5 top-1/2 -translate-y-1/2 text-[var(--muted)] text-[14px]">
              üîç
            </span>
          </div>

          <div className="flex flex-wrap gap-1.5 text-[11px]">
            {[
              { key: "all", label: "Toutes" },
              { key: "todo", label: "√Ä envoyer" },
              { key: "sent", label: "Envoy√©es" },
              { key: "interview", label: "Entretiens" },
              { key: "offer", label: "Offres" },
              { key: "rejected", label: "Refus" },
            ].map((f) => {
              const active = filterStatus === f.key;
              return (
                <button
                  key={f.key}
                  type="button"
                  onClick={() => setFilterStatus(f.key as FilterStatus)}
                  className={`inline-flex items-center gap-1 rounded-full border px-2.5 py-[4px] transition-colors ${
                    active
                      ? "border-[var(--brand)] bg-[var(--brand)]/10 text-[var(--ink)]"
                      : "border-[var(--border)]/80 text-[var(--muted)] hover:text-[var(--ink)] hover:bg-[var(--bg-soft)]"
                  }`}
                >
                  <span>{f.label}</span>
                  {f.key === "all" && total > 0 && (
                    <span className="text-[10px] opacity-80">({total})</span>
                  )}
                </button>
              );
            })}
          </div>
        </div>

        {/* Filtres IA + limite par page */}
        <div className="flex flex-wrap items-center justify-between gap-2 text-[11px]">
          <div className="flex flex-wrap gap-1.5">
            {[
              { key: "all", label: "Toutes" },
              { key: "withCv", label: "Avec CV IA" },
              { key: "withLm", label: "Avec LM IA" },
              { key: "withPitch", label: "Avec Pitch" },
            ].map((f) => {
              const active = iaFilter === f.key;
              return (
                <button
                  key={f.key}
                  type="button"
                  onClick={() => setIaFilter(f.key as IaFilter)}
                  className={`inline-flex items-center gap-1 rounded-full border px-2.5 py-[3px] transition-colors ${
                    active
                      ? "border-[var(--brand)] bg-[var(--brand)]/10 text-[var(--ink)]"
                      : "border-[var(--border)]/80 text-[var(--muted)] hover:text-[var(--ink)] hover:bg-[var(--bg-soft)]"
                  }`}
                >
                  <span>{f.label}</span>
                </button>
              );
            })}
          </div>

          <div className="flex items-center gap-1.5">
            <span className="text-[var(--muted)]">Par page :</span>
            <select
              className="border border-[var(--border)] bg-[var(--bg-soft)] rounded-full px-2 py-[3px] text-[11px]"
              value={itemsPerPage}
              onChange={(e) => setItemsPerPage(Number(e.target.value))}
            >
              <option value={10}>10</option>
              <option value={20}>20</option>
              <option value={50}>50</option>
            </select>
          </div>
        </div>

        {/* √âtat de chargement / erreurs */}
        {loadingApps && (
          <div className="glass border border-[var(--border)]/80 rounded-xl p-4 flex items-center gap-3 text-[13px] text-[var(--muted)]">
            <div className="loader" />
            <span>Chargement de tes candidatures‚Ä¶</span>
          </div>
        )}

        {appsError && (
          <div className="glass border border-rose-500/60 rounded-xl p-3 text-[12px] text-rose-200">
            {appsError}
          </div>
        )}

        {!loadingApps && !appsError && filteredApps.length === 0 && (
          <div className="glass border border-[var(--border)]/80 rounded-xl p-4 text-center text-[13px] text-[var(--muted)]">
            <p className="mb-1">Aucune candidature √† afficher pour ce filtre.</p>
            <p className="text-[11px]">
              Ajoute une candidature manuellement ou coche l&apos;option{" "}
              <strong>‚ÄúCr√©er une entr√©e dans le Suivi üìå‚Äù</strong> dans
              l&apos;assistant de CV IA.
            </p>
          </div>
        )}

        {/* Liste des candidatures */}
        <div className="space-y-2">
          {paginatedApps.map((app) => (
            <div
              key={app.id}
              className="glass border border-[var(--border)]/80 rounded-xl px-3.5 py-3 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2"
            >
              {/* Colonne gauche */}
              <div className="flex-1 min-w-0">
                <div className="flex flex-wrap items-center gap-1.5">
                  <p className="font-medium text-[14px] truncate">
                    {app.jobTitle || "Poste sans intitul√©"}
                  </p>
                  {app.company && (
                    <span className="text-[11px] text-[var(--muted)]">
                      ¬∑ {app.company}
                    </span>
                  )}
                </div>

                <div className="mt-1 flex flex-wrap gap-1.5 text-[10.5px] text-[var(--muted)]">
                  {app.location && (
                    <span className="inline-flex items-center gap-1 px-1.5 py-[1px] rounded-full bg-slate-900/70">
                      üìç {app.location}
                    </span>
                  )}
                  {app.contract && (
                    <span className="inline-flex items-center gap-1 px-1.5 py-[1px] rounded-full bg-slate-900/70">
                      üìÑ {app.contract}
                    </span>
                  )}
                  {app.source && (
                    <span className="inline-flex items-center gap-1 px-1.5 py-[1px] rounded-full bg-slate-900/70">
                      üåê {app.source}
                    </span>
                  )}
                  {app.fromAutoCreate && (
                    <span className="inline-flex items-center gap-1 px-1.5 py-[1px] rounded-full bg-[var(--brand)]/15 text-[var(--brand)] border border-[var(--brand)]/50">
                      ü§ñ Depuis CV IA
                    </span>
                  )}
                </div>

                <div className="mt-1 text-[11px] text-[var(--muted)] flex flex-wrap gap-2">
                  <span>
                    Cr√©√©e : <strong>{formatDate(app.createdAt)}</strong>
                  </span>
                  {app.lastActionDate && (
                    <span>
                      Derni√®re action :{" "}
                      <strong>{formatDate(app.lastActionDate)}</strong>
                    </span>
                  )}
                  {app.interviewAt && (
                    <span>
                      Entretien :{" "}
                      <strong>{formatDateTime(app.interviewAt)}</strong>
                    </span>
                  )}
                </div>

                {app.notes && (
                  <p className="mt-1 text-[11px] text-[var(--muted)] line-clamp-2">
                    {app.notes}
                  </p>
                )}

                {app.jobLink && (
                  <a
                    href={app.jobLink}
                    target="_blank"
                    rel="noreferrer"
                    className="mt-1 inline-flex items-center gap-1 text-[11px] text-[var(--brand)] hover:underline"
                  >
                    Voir l&apos;offre
                    <span aria-hidden>‚Üó</span>
                  </a>
                )}
              </div>

              {/* Colonne droite : statut + badges IA + bouton √©diter */}
              <div className="flex flex-col items-end gap-1 min-w-[170px]">
                <span
                  className={`inline-flex items-center justify-center px-2 py-[3px] text-[11px] border rounded-full ${statusClasses(
                    app.status
                  )}`}
                >
                  {statusLabel(app.status)}
                </span>

                <div className="flex flex-wrap justify-end gap-1 text-[10px] text-[var(--muted)] mt-1">
                  {app.hasCv && (
                    <span className="inline-flex items-center gap-1 px-1.5 py-[1px] rounded-full border border-[var(--border)] bg-[var(--bg-soft)]">
                      ‚úÖ CV IA
                    </span>
                  )}
                  {app.hasLm && (
                    <span className="inline-flex items-center gap-1 px-1.5 py-[1px] rounded-full border border-[var(--border)] bg-[var(--bg-soft)]">
                      ‚úâÔ∏è LM IA
                    </span>
                  )}
                  {app.hasPitch && (
                    <span className="inline-flex items-center gap-1 px-1.5 py-[1px] rounded-full border border-[var(--border)] bg-[var(--bg-soft)]">
                      üéôÔ∏è Pitch
                    </span>
                  )}
                </div>

                <button
                  type="button"
                  onClick={() => openEditModal(app)}
                  className="mt-1 inline-flex items-center gap-1 rounded-full border border-[var(--border)] bg-[var(--bg-soft)] px-2 py-[2px] text-[10px] text-[var(--muted)] hover:border-[var(--brand)] hover:text-[var(--brand)] transition-colors"
                >
                  <span className="text-[12px]">‚úèÔ∏è</span>
                  <span>Modifier</span>
                </button>
              </div>
            </div>
          ))}
        </div>

        {/* PAGINATION */}
        {filteredApps.length > 0 && isMounted && (
          <div className="max-w-5xl mx-auto mt-4 flex justify-center items-center gap-2 text-[11px]">
            <button
              type="button"
              className="px-2.5 py-1 rounded-full border border-[var(--border)] bg-[var(--bg-soft)] disabled:opacity-40 disabled:cursor-not-allowed hover:bg-[var(--bg)]"
              onClick={() =>
                setCurrentPage((p) => (p > 1 ? p - 1 : p))
              }
              disabled={currentPage === 1}
            >
              Pr√©c√©dent
            </button>

            {paginationButtons.map((p, idx) =>
              typeof p === "number" ? (
                <button
                  key={idx}
                  type="button"
                  onClick={() => setCurrentPage(p)}
                  className={`px-2.5 py-1 rounded-full border text-[11px] ${
                    p === currentPage
                      ? "border-[var(--brand)] bg-[var(--brand)]/20"
                      : "border-[var(--border)] bg-[var(--bg-soft)] hover:bg-[var(--bg)]"
                  }`}
                >
                  {p}
                </button>
              ) : (
                <span key={idx} className="px-2 py-1">
                  ‚Ä¶
                </span>
              )
            )}

            <button
              type="button"
              className="px-2.5 py-1 rounded-full border border-[var(--border)] bg-[var(--bg-soft)] disabled:opacity-40 disabled:cursor-not-allowed hover:bg-[var(--bg)]"
              onClick={() =>
                setCurrentPage((p) =>
                  p < totalPages ? p + 1 : p
                )
              }
              disabled={currentPage === totalPages}
            >
              Suivant
            </button>

            <div className="ml-4 text-[var(--muted)]">
              Page {currentPage} sur {totalPages}
            </div>
          </div>
        )}
      </section>

      {/* MODALE EDIT CANDIDATURE */}
      {editingApp && (
        <div className="fixed inset-0 z-40 flex items-center justify-center bg-black/60 px-3">
          <motion.form
            onSubmit={handleEditApplication}
            initial={{ opacity: 0, y: 16, scale: 0.97 }}
            animate={{ opacity: 1, y: 0, scale: 1 }}
            exit={{ opacity: 0, y: 16, scale: 0.97 }}
            className="w-full max-w-lg rounded-2xl bg-[var(--bg)] border border-[var(--border)] shadow-xl p-4 sm:p-5 space-y-4"
          >
            <div className="flex items-center justify-between gap-2">
              <h3 className="text-sm sm:text-base font-semibold">
                Modifier la candidature
              </h3>
              <button
                type="button"
                onClick={closeEditModal}
                className="rounded-full px-2 py-1 text-[11px] text-[var(--muted)] hover:bg-[var(--bg-soft)]"
              >
                ‚úï
              </button>
            </div>

            <div className="space-y-3 max-h-[70vh] overflow-auto pr-1 text-[13px]">
              <div className="grid sm:grid-cols-2 gap-3">
                <div>
                  <label className="block text-[11px] mb-1 text-[var(--muted)]">
                    Entreprise
                  </label>
                  <input
                    type="text"
                    className="input text-[var(--ink)] bg-[var(--bg-soft)]"
                    value={editCompany}
                    onChange={(e) => setEditCompany(e.target.value)}
                  />
                </div>
                <div>
                  <label className="block text-[11px] mb-1 text-[var(--muted)]">
                    Intitul√© du poste
                  </label>
                  <input
                    type="text"
                    className="input text-[var(--ink)] bg-[var(--bg-soft)]"
                    value={editJobTitle}
                    onChange={(e) => setEditJobTitle(e.target.value)}
                  />
                </div>
              </div>

              <div className="grid sm:grid-cols-3 gap-3">
                <div>
                  <label className="block text-[11px] mb-1 text-[var(--muted)]">
                    Statut
                  </label>
                  <select
                    className="select-brand text-[var(--ink)] bg-[var(--bg-soft)]"
                    value={editStatus}
                    onChange={(e) =>
                      setEditStatus(e.target.value as ApplicationStatus)
                    }
                  >
                    <option value="todo">√Ä envoyer</option>
                    <option value="sent">Envoy√©e</option>
                    <option value="interview">Entretien</option>
                    <option value="offer">Offre</option>
                    <option value="rejected">Refus</option>
                  </select>
                </div>
                <div>
                  <label className="block text-[11px] mb-1 text-[var(--muted)]">
                    Contrat
                  </label>
                  <input
                    type="text"
                    className="input text-[var(--ink)] bg-[var(--bg-soft)]"
                    value={editContract}
                    onChange={(e) => setEditContract(e.target.value)}
                  />
                </div>
                <div>
                  <label className="block text-[11px] mb-1 text-[var(--muted)]">
                    Lieu
                  </label>
                  <input
                    type="text"
                    className="input text-[var(--ink)] bg-[var(--bg-soft)]"
                    value={editLocation}
                    onChange={(e) => setEditLocation(e.target.value)}
                  />
                </div>
              </div>

              <div className="grid sm:grid-cols-2 gap-3">
                <div>
                  <label className="block text-[11px] mb-1 text-[var(--muted)]">
                    Source
                  </label>
                  <input
                    type="text"
                    className="input text-[var(--ink)] bg-[var(--bg-soft)]"
                    value={editSource}
                    onChange={(e) => setEditSource(e.target.value)}
                  />
                </div>
                <div>
                  <label className="block text-[11px] mb-1 text-[var(--muted)]">
                    Lien de l&apos;offre
                  </label>
                  <input
                    type="url"
                    className="input text-[var(--ink)] bg-[var(--bg-soft)]"
                    value={editJobLink}
                    onChange={(e) => setEditJobLink(e.target.value)}
                  />
                </div>
              </div>

              <div className="grid sm:grid-cols-2 gap-3">
                <div>
                  <label className="block text-[11px] mb-1 text-[var(--muted)]">
                    Date / heure de l&apos;entretien
                  </label>
                  <input
                    type="datetime-local"
                    className="input text-[var(--ink)] bg-[var(--bg-soft)]"
                    value={editInterviewAt}
                    onChange={(e) => setEditInterviewAt(e.target.value)}
                  />
                </div>
              </div>

              <div>
                <label className="block text-[11px] mb-1 text-[var(--muted)]">
                  Notes
                </label>
                <textarea
                  rows={3}
                  className="input textarea text-[var(--ink)] bg-[var(--bg-soft)]"
                  value={editNotes}
                  onChange={(e) => setEditNotes(e.target.value)}
                />
              </div>

              <div className="flex flex-wrap gap-3 text-[11px]">
                <label className="inline-flex items-center gap-1 cursor-pointer">
                  <input
                    type="checkbox"
                    className="h-3 w-3 rounded border-[var(--border)] bg-[var(--bg)]"
                    checked={editHasCv}
                    onChange={(e) => setEditHasCv(e.target.checked)}
                  />
                  <span>CV IA associ√©</span>
                </label>
                <label className="inline-flex items-center gap-1 cursor-pointer">
                  <input
                    type="checkbox"
                    className="h-3 w-3 rounded border-[var(--border)] bg-[var(--bg)]"
                    checked={editHasLm}
                    onChange={(e) => setEditHasLm(e.target.checked)}
                  />
                  <span>LM IA associ√©e</span>
                </label>
                <label className="inline-flex items-center gap-1 cursor-pointer">
                  <input
                    type="checkbox"
                    className="h-3 w-3 rounded border-[var(--border)] bg-[var(--bg)]"
                    checked={editHasPitch}
                    onChange={(e) => setEditHasPitch(e.target.checked)}
                  />
                  <span>Pitch IA associ√©</span>
                </label>
              </div>
            </div>

            <div className="flex justify-end gap-2 pt-2">
              <button
                type="button"
                onClick={closeEditModal}
                className="inline-flex items-center justify-center rounded-lg border border-[var(--border)] bg-[var(--bg-soft)] px-3 py-1.5 text-[12px] text-[var(--muted)] hover:bg-[var(--bg)] transition-colors"
              >
                Annuler
              </button>
              <button
                type="submit"
                disabled={editSaving}
                className="inline-flex items-center justify-center rounded-lg bg-[var(--brand)] hover:bg-[var(--brandDark)] px-3 py-1.5 text-[12px] font-medium text-white transition-colors relative"
              >
                <span>
                  {editSaving ? "Enregistrement..." : "Enregistrer"}
                </span>
                <div
                  className={`loader absolute inset-0 m-auto ${
                    editSaving ? "" : "hidden"
                  }`}
                />
              </button>
            </div>
          </motion.form>
        </div>
      )}
    </motion.div>
  );
}
````

## File: app/app/layout.tsx
````typescript
"use client";

import { ReactNode, useEffect, useState } from "react";
import Link from "next/link";
import { usePathname, useRouter } from "next/navigation";
import { doc, onSnapshot } from "firebase/firestore";

import { useAuth } from "@/context/AuthContext";
import { db } from "@/lib/firebase";
import { useUserCredits } from "@/hooks/useUserCredits";

const navLinks = [
  { href: "/app", label: "Profil CV IA", icon: "üìÑ" },
  { href: "/app/lm", label: "Assistant candidature", icon: "‚ú®" },
  { href: "/app/tracker", label: "Suivi candidatures", icon: "üìä" },
  { href: "/app/interview", label: "Pr√©parer entretien", icon: "üé§" },
  { href: "/app/apply", label: "Postuler", icon: "üì®" },
  { href: "/app/history", label: "Historique IA", icon: "üïí" },
  { href: "/app/credits", label: "Cr√©dits", icon: "‚ö°" },
];

export default function UserAppLayout({ children }: { children: ReactNode }) {
  const { user, loading, logout } = useAuth();
  const router = useRouter();
  const pathname = usePathname();
  const [sidebarOpen, setSidebarOpen] = useState(false);

  // ‚úÖ flag pour √™tre s√ªr qu'on est c√¥t√© client
  const [clientReady, setClientReady] = useState(false);
  useEffect(() => {
    setClientReady(true);
  }, []);

  // ‚úÖ Cr√©dits utilisateur via le hook (temps r√©el Firestore)
  const { credits, loading: creditsLoading } = useUserCredits();

  // üîí Protection des routes /app : login + email v√©rifi√©
  useEffect(() => {
    if (!clientReady) return;
    if (loading) return;

    if (!user) {
      router.replace("/login");
      return;
    }

    if (!user.emailVerified) {
      router.replace("/auth/verify-email");
      return;
    }
  }, [clientReady, user, loading, router]);

  // üõ° Surveillance du doc user : si blocked = true => d√©connexion imm√©diate
  useEffect(() => {
    if (!clientReady) return;
    if (!user) return;

    const ref = doc(db, "users", user.uid);

    const unsub = onSnapshot(
      ref,
      (snap) => {
        const data = snap.data() as any | undefined;
        if (data?.blocked) {
          // d√©connexion + redirection login avec message
          logout()
            .catch((e) =>
              console.error("Erreur d√©connexion apr√®s blocage :", e)
            )
            .finally(() => {
              router.replace("/login?blocked=1");
            });
        }
      },
      (err) => {
        console.error("Erreur surveillance blocage utilisateur :", err);
      }
    );

    return () => {
      unsub();
    };
  }, [clientReady, user, logout, router]);

  // ferme le menu mobile au changement de page
  useEffect(() => {
    setSidebarOpen(false);
  }, [pathname]);

  // ‚ö†Ô∏è Tant qu'on n'est pas pr√™t ou pas autoris√© ‚Üí on ne rend PAS le dashboard
  if (!clientReady || loading || !user || !user.emailVerified) {
    return null;
  }

  const handleLogout = async () => {
    try {
      await logout();
      router.replace("/login");
    } catch (e) {
      console.error("Erreur d√©connexion :", e);
    }
  };

  const currentNav = navLinks.find(
    (link) =>
      pathname === link.href || pathname.startsWith(link.href + "/")
  );
  const pageTitle = currentNav?.label ?? "Espace candidat";

  // üîπ petit composant inline pour le badge cr√©dits
  const CreditsBadge =
    creditsLoading || credits === undefined || credits === null ? (
      <div className="inline-flex items-center gap-1 rounded-full px-2 py-1 text-[11px] bg-[var(--bg-soft)] border border-[var(--border)]/80 text-[var(--muted)]">
        <span className="text-[13px]">‚ö°</span>
        <span>Chargement‚Ä¶</span>
      </div>
    ) : (
      <div className="inline-flex items-center gap-1 rounded-full px-2 py-1 text-[11px] bg-[var(--bg-soft)] border border-[var(--border)]/80 text-[var(--ink)]">
        <span className="text-[13px]">‚ö°</span>
        <span>
          <span className="font-semibold">{credits}</span> cr√©dits
        </span>
      </div>
    );

  return (
    <div className="min-h-screen flex bg-[var(--bg)] text-[var(--ink)]">
      {/* SIDEBAR DESKTOP */}
      <aside className="hidden md:flex w-60 shrink-0 flex-col border-r border-[var(--border)] bg-[var(--bg-soft)]/60">
        <div className="flex items-center gap-2 px-3 py-4 border-b border-[var(--border)]/70">
          <Link href="/app" className="flex items-center gap-2">
            <div className="w-9 h-9 rounded-2xl bg-[var(--brand)]/10 border border-[var(--brand)]/40 flex items-center justify-center text-lg">
              ‚ö°
            </div>
            <div className="flex flex-col">
              <span className="text-xs font-semibold">
                Assistant Candidature IA
              </span>
              <span className="text-[10px] text-[var(--muted)]">
                Espace candidat
              </span>
            </div>
          </Link>
        </div>

        <nav className="flex-1 px-2 py-3 space-y-1 text-[13px] overflow-y-auto">
          {navLinks.map((link) => {
            const active =
              pathname === link.href ||
              pathname.startsWith(link.href + "/");
            return (
              <Link
                key={link.href}
                href={link.href}
                className={[
                  "flex items-center gap-2 rounded-lg px-2 py-1.5 transition-colors border border-transparent",
                  active
                    ? "bg-[var(--bg)] text-[var(--ink)] border-[var(--brand)]/60"
                    : "text-[var(--muted)] hover:text-[var(--ink)] hover:bg-[var(--bg-soft)]",
                ].join(" ")}
              >
                <span className="w-5 text-center text-[13px]">
                  {link.icon}
                </span>
                <span>{link.label}</span>
              </Link>
            );
          })}
        </nav>

        <div className="border-t border-[var(--border)]/70 px-3 py-3 text-[11px] flex flex-col gap-2">
          {/* Badge cr√©dits en bas de la sidebar */}
          {CreditsBadge}

          {user?.email && (
            <p className="text-[var(--muted)]">
              Connect√©¬∑e :{" "}
              <span className="font-medium text-[var(--ink)]">
                {user.email}
              </span>
            </p>
          )}
          <button
            type="button"
            onClick={handleLogout}
            className="w-full text-[11px] rounded-full border border-[var(--border)] px-3 py-1.5 bg-[var(--bg)] hover:border-red-500 hover:text-red-300 transition-colors"
          >
            Se d√©connecter
          </button>
        </div>
      </aside>

      {/* COLONNE CONTENU */}
      <div className="flex-1 flex flex-col relative">
        <div className="pointer-events-none absolute inset-0 -z-10 bg-[radial-gradient(circle_at_top,_rgba(56,189,248,0.16),_transparent_55%),radial-gradient(circle_at_bottom,_rgba(94,234,212,0.12),_transparent_55%)]" />

        {/* TOPBAR */}
        <header className="sticky top-0 z-30 border-b border-[var(--border)]/80 bg-[var(--bg)]/95 backdrop-blur">
          <div className="flex items-center justify-between gap-3 px-3 sm:px-6 py-3">
            <div className="flex items-center gap-3">
              <button
                type="button"
                aria-label="Ouvrir la navigation"
                onClick={() => setSidebarOpen(true)}
                className="md:hidden rounded-full p-2 bg-[var(--bg-soft)] border border-[var(--border)]/80 shadow-sm focus:outline-none focus:ring-2 focus:ring-[var(--brand)]/60"
              >
                <div className={`menu-icon1 ${sidebarOpen ? "is-open" : ""}`}>
                  <div className="menu-icon1_line-top"></div>
                  <div className="menu-icon1_line-middle">
                    <div className="menu-icon1_line-middle-inner"></div>
                  </div>
                  <div className="menu-icon1_line-bottom"></div>
                </div>
              </button>

              <div className="flex flex-col">
                <span className="text-[11px] font-medium uppercase tracking-wide text-[var(--muted)]">
                  Tableau de bord
                </span>
                <span className="text-sm font-semibold">{pageTitle}</span>
              </div>
            </div>

            <div className="flex items-center gap-3">
              {/* Badge cr√©dits dans la topbar */}
              {CreditsBadge}

              {user?.email && (
                <span className="hidden sm:inline text-[11px] text-[var(--muted)]">
                  {user.email}
                </span>
              )}
              <button
                type="button"
                onClick={handleLogout}
                className="text-[11px] rounded-full border border-[var(--border)] px-3 py-1.5 bg-[var(--bg-soft)] hover:border-red-500 hover:text-red-300 transition-colors"
              >
                Se d√©connecter
              </button>
            </div>
          </div>
        </header>

        <main className="flex-1 overflow-y-auto">
          <div className="px-3 sm:px-6 lg:px-8 py-4 lg:py-6">
            <div className="max-w-6xl mx-auto space-y-4">{children}</div>
          </div>
        </main>
      </div>

      {/* MENU MOBILE (DRAWER) */}
      <div
        className={`fixed inset-0 z-40 md:hidden transition ${
          sidebarOpen ? "pointer-events-auto" : "pointer-events-none"
        }`}
      >
        <div
          className={`absolute inset-0 bg-black/50 transition-opacity ${
            sidebarOpen ? "opacity-100" : "opacity-0"
          }`}
          onClick={() => setSidebarOpen(false)}
        />

        <div
          className={`absolute left-0 top-0 h-full w-64 bg-[var(--bg)] border-r border-[var(--border)] shadow-xl transform transition-transform ${
            sidebarOpen ? "translate-x-0" : "-translate-x-full"
          }`}
        >
          <div className="flex items-center justify-between px-3 py-3 border-b border-[var(--border)]/80">
            <div className="flex items-center gap-2">
              <div className="menu-icon1">
                <div className="menu-icon1_line-top"></div>
                <div className="menu-icon1_line-middle">
                  <div className="menu-icon1_line-middle-inner"></div>
                </div>
                <div className="menu-icon1_line-bottom"></div>
              </div>
              <div className="flex flex-col">
                <span className="text-xs font-semibold">Menu</span>
                <span className="text-[10px] text-[var(--muted)]">
                  Navigation
                </span>
              </div>
            </div>
            <button
              type="button"
              onClick={() => setSidebarOpen(false)}
              className="text-[11px] rounded-full border border-[var(--border)] px-2 py-1 hover:bg-[var(--bg-soft)]"
            >
              ‚úï
            </button>
          </div>

          <nav className="px-2 py-3 flex flex-col gap-1 text-[13px] overflow-y-auto">
            {navLinks.map((link) => {
              const active =
                pathname === link.href ||
                pathname.startsWith(link.href + "/");
              return (
                <Link
                  key={link.href}
                  href={link.href}
                  className={[
                    "flex items-center gap-2 rounded-lg px-2 py-1.5 transition-colors border border-transparent",
                    active
                      ? "bg-[var(--bg)] text-[var(--ink)] border-[var(--brand)]/60"
                      : "text-[var(--muted)] hover:text-[var(--ink)] hover:bg-[var(--bg-soft)]",
                  ].join(" ")}
                >
                  <span className="w-5 text-center text-[13px]">
                    {link.icon}
                  </span>
                  <span>{link.label}</span>
                </Link>
              );
            })}
          </nav>

          <div className="border-t border-[var(--border)]/70 px-3 py-3 text-[11px] space-y-2">
            {/* Badge cr√©dits dans le menu mobile */}
            {CreditsBadge}

            {user?.email && (
              <p className="mb-1 text-[var(--muted)]">
                Connect√©¬∑e :{" "}
                <span className="font-medium text-[var(--ink)]">
                  {user.email}
                </span>
              </p>
            )}
            <button
              type="button"
              onClick={handleLogout}
              className="w-full text-[11px] rounded-full border border-[var(--border)] px-3 py-1.5 bg-[var(--bg)] hover:border-red-500 hover:text-red-300 transition-colors"
            >
              Se d√©connecter
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}
````

## File: app/assistance-candidature/page.tsx
````typescript
export default function AssistanceCandidaturePage() {
  // ...
}
````

## File: app/auth/verify-email/page.tsx
````typescript
"use client";

import { useEffect, useState, Suspense } from "react";
import { useSearchParams, useRouter } from "next/navigation";
import Link from "next/link";
import { applyActionCode, sendEmailVerification } from "firebase/auth";
import { auth } from "@/lib/firebase";
import { useAuth } from "@/context/AuthContext";

type Status = "idle" | "processing" | "success" | "error";

function VerifyEmailPageInner() {
  const searchParams = useSearchParams();
  const router = useRouter();
  const { user, logout } = useAuth();

  const [status, setStatus] = useState<Status>("idle");
  const [message, setMessage] = useState<string | null>(null);

  const oobCode = searchParams.get("oobCode");

  // Cas 1 : on arrive depuis le lien de v√©rification (oobCode dans l'URL)
  useEffect(() => {
    const verify = async () => {
      if (!oobCode) return;

      setStatus("processing");
      setMessage("V√©rification de ton email en cours...");

      try {
        await applyActionCode(auth, oobCode);

        if (auth.currentUser) {
          await auth.currentUser.reload();
        }

        setStatus("success");
        setMessage(
          "Email v√©rifi√© avec succ√®s. Tu peux maintenant acc√©der √† ton espace candidat."
        );
      } catch (err) {
        console.error("Erreur de v√©rification d‚Äôemail :", err);
        setStatus("error");
        setMessage(
          "Le lien de v√©rification est invalide ou expir√©. Demande un nouveau mail de v√©rification."
        );
      }
    };

    verify();
  }, [oobCode]);

  const handleResend = async () => {
    if (!user) {
      setStatus("error");
      setMessage(
        "Tu dois d‚Äôabord te connecter pour renvoyer l‚Äôemail de v√©rification."
      );
      return;
    }

    try {
      setStatus("processing");
      setMessage("Envoi d‚Äôun nouvel email de v√©rification...");
      await sendEmailVerification(user);
      setStatus("success");
      setMessage(
        "Email de v√©rification renvoy√©. V√©rifie ta bo√Æte de r√©ception."
      );
    } catch (err) {
      console.error("Erreur renvoi email :", err);
      setStatus("error");
      setMessage(
        "Impossible de renvoyer l‚Äôemail pour le moment. R√©essaie plus tard."
      );
    }
  };

  // üîÅ Bouton pour acc√©der √† l'espace candidat
  const handleGoToApp = async () => {
    if (!user) {
      setStatus("error");
      setMessage(
        "Tu dois √™tre connect√© pour acc√©der √† l‚Äôespace candidat. Connecte-toi puis reviens ici."
      );
      return;
    }

    try {
      setStatus("processing");
      setMessage("V√©rification de l‚Äô√©tat de ton email...");

      // on rafra√Æchit le user pour avoir le bon √©tat de emailVerified
      if (user.reload) {
        await user.reload();
      } else if (auth.currentUser) {
        await auth.currentUser.reload();
      }

      const refreshedUser = auth.currentUser ?? user;

      if (!refreshedUser.emailVerified) {
        setStatus("error");
        setMessage(
          "Ton email n‚Äôest toujours pas v√©rifi√©. Clique sur le lien dans l‚Äôemail re√ßu, puis r√©essaie."
        );
        return;
      }

      setStatus("idle");
      setMessage(null);
      router.push("/app");
    } catch (err) {
      console.error("Erreur lors du check emailVerified :", err);
      setStatus("error");
      setMessage(
        "Impossible de v√©rifier l‚Äô√©tat de ton email pour le moment. R√©essaie dans quelques instants."
      );
    }
  };

  // üîå Bouton de d√©connexion ‚Üí redirection vers /login
  const handleLogout = async () => {
    try {
      await logout();
      router.push("/login");
    } catch (err) {
      console.error("Erreur d√©connexion :", err);
    }
  };

  return (
    <div className="min-h-screen bg-[var(--page)] text-[var(--text)]">
      {/* fond l√©ger comme les autres pages */}
      <div className="pointer-events-none fixed inset-0 -z-10 bg-[radial-gradient(circle_at_top,_rgba(56,189,248,0.16),_transparent_55%),radial-gradient(circle_at_bottom,_rgba(94,234,212,0.12),_transparent_55%)]" />

      <div className="mx-auto flex min-h-screen max-w-6xl flex-col px-3 sm:px-4">
        {/* NAVBAR HAUT DE PAGE */}
        <header className="sticky top-0 z-20 flex items-center justify-between gap-3 border-b border-[var(--border)]/80 bg-[var(--page)]/90 px-0 py-3 backdrop-blur">
          {/* Logo + retour accueil */}
          <Link href="/" className="flex items-center gap-2">
            <div className="flex h-9 w-9 items-center justify-center rounded-2xl border border-[var(--brand)]/40 bg-[var(--brand)]/10 text-lg">
              ‚ö°
            </div>
            <div className="flex flex-col">
              <span className="text-xs font-semibold">
                Assistant Candidature IA
              </span>
              <span className="text-[10px] text-[var(--muted)]">
                Retour √† l&apos;accueil
              </span>
            </div>
          </Link>

          {/* Liens Connexion / Inscription / D√©connexion */}
          <div className="flex items-center gap-2 text-[11px]">
            {!user && (
              <>
                <Link
                  href="/login"
                  className="rounded-full border border-[var(--border)] bg-[var(--bg-soft)] px-3 py-1.5 text-[var(--muted)] transition-colors hover:border-[var(--brand)]/60 hover:text-[var(--ink)]"
                >
                  Se connecter
                </Link>
                <Link
                  href="/signup"
                  className="rounded-full border border-[var(--brand)]/70 bg-[var(--brand)]/20 px-3 py-1.5 text-[var(--ink)] transition-colors hover:bg-[var(--brand)]/30"
                >
                  S&apos;inscrire
                </Link>
              </>
            )}

            {user && (
              <button
                type="button"
                onClick={handleLogout}
                className="rounded-full border border-[var(--border)] bg-[var(--bg-soft)] px-3 py-1.5 text-[var(--muted)] transition-colors hover:border-red-500/70 hover:text-red-200"
              >
                Se d√©connecter
              </button>
            )}
          </div>
        </header>

        {/* CONTENU PRINCIPAL */}
        <main className="flex flex-1 items-center justify-center py-10">
          <div className="relative w-full max-w-md">
            {/* halo derri√®re la card */}
            <div className="pointer-events-none absolute -inset-6 -z-10 rounded-[32px] bg-[radial-gradient(circle_at_top,_rgba(56,189,248,0.25),_transparent_55%)] opacity-80" />

            <div className="glass space-y-5 rounded-2xl border border-[var(--border)]/80 bg-[var(--bg)]/85 px-6 py-6 shadow-[0_22px_50px_rgba(0,0,0,0.55)]">
              {/* badge √©tape */}
              <div className="inline-flex items-center gap-2 rounded-full border border-[var(--border)]/80 bg-[var(--bg-soft)] px-3 py-1 text-[10px] text-[var(--muted)]">
                <span className="inline-flex h-4 w-4 items-center justify-center rounded-full bg-[var(--brand)]/30 text-[9px]">
                  2
                </span>
                <span>√âtape 2 ¬∑ Validation du compte</span>
              </div>

              <div className="flex items-start gap-3">
                <div className="flex h-9 w-9 items-center justify-center rounded-2xl border border-[var(--brand)]/40 bg-[var(--brand)]/12 text-lg">
                  ‚úâÔ∏è
                </div>
                <div className="space-y-1">
                  <h1 className="text-sm font-semibold">
                    V√©rifie ton adresse email
                  </h1>
                  <p className="text-[11px] text-[var(--muted)] leading-relaxed">
                    Pour s√©curiser ton espace candidat et activer les fonctionnalit√©s
                    IA, nous devons v√©rifier ton adresse email.
                  </p>
                </div>
              </div>

              {message && (
                <div
                  className={[
                    "text-[12px] rounded-lg px-3 py-2 border leading-relaxed",
                    status === "error"
                      ? "border-red-500/60 bg-red-500/5 text-red-200"
                      : status === "success"
                      ? "border-emerald-500/60 bg-emerald-500/5 text-emerald-200"
                      : "border-[var(--border)]/80 bg-[var(--bg-soft)] text-[var(--muted)]",
                  ].join(" ")}
                >
                  {message}
                </div>
              )}

              {!oobCode && (
                <div className="space-y-2">
                  <p className="text-[11px] text-[var(--muted)] leading-relaxed">
                    Nous t‚Äôavons envoy√© un lien de v√©rification par email. Clique sur
                    le bouton dans l‚Äôemail pour valider ton compte, puis reviens sur
                    cette page.
                  </p>
                  <ul className="space-y-1 text-[11px] text-[var(--muted)]">
                    <li>‚Ä¢ V√©rifie aussi les spams / courriers ind√©sirables</li>
                    <li>‚Ä¢ Le lien est valable pendant un temps limit√©</li>
                  </ul>
                </div>
              )}

              <div className="flex flex-col gap-2 text-[12px]">
                <button
                  type="button"
                  onClick={handleResend}
                  className="w-full rounded-full border border-[var(--border)] bg-[var(--bg-soft)] px-3 py-2 text-[var(--muted)] transition-colors hover:border-[var(--brand)]/60 hover:text-[var(--ink)] disabled:opacity-60 disabled:cursor-not-allowed"
                  disabled={status === "processing"}
                >
                  Renvoyer l‚Äôemail de v√©rification
                </button>

                <button
                  type="button"
                  onClick={handleGoToApp}
                  className="w-full rounded-full border border-[var(--brand)]/70 bg-[var(--brand)]/20 px-3 py-2 text-[var(--ink)] transition-colors hover:bg-[var(--brand)]/30"
                >
                  Acc√©der √† l&apos;espace candidat
                </button>
              </div>

              <p className="text-center text-[10px] text-[var(--muted)]">
                Si tu ne vois pas l‚Äôemail, pense √† v√©rifier les spams ou l‚Äôonglet
                &quot;Promotions&quot; de ta bo√Æte de r√©ception.
              </p>
            </div>
          </div>
        </main>
      </div>
    </div>
  );
}

/**
 * Wrapper avec Suspense ‚Üí obligatoire quand on utilise useSearchParams
 * dans une page client pour que le build Next.js ne plante pas.
 */
export default function VerifyEmailPage() {
  return (
    <Suspense
      fallback={
        <div className="min-h-screen flex items-center justify-center text-sm text-slate-400">
          Chargement‚Ä¶
        </div>
      }
    >
      <VerifyEmailPageInner />
    </Suspense>
  );
}
````

## File: app/debug/polar/page.tsx
````typescript
// app/debug/polar/page.tsx
"use client";

import { useEffect, useState } from "react";
import type { CreditPackId } from "@/lib/polar";
import { auth, db } from "@/lib/firebase";
import { onAuthStateChanged } from "firebase/auth";
import { doc, getDoc } from "firebase/firestore";

type UserProfile = {
  id: string;
  email: string;
  displayName?: string;
  credits?: number;
};

type PackConfig = {
  id: CreditPackId;
  title: string;
  subtitle: string;
  credits: number;
  priceText: string;
  highlight?: boolean;
};

// ‚úÖ Packs align√©s avec tes produits Polar : 20 / 50 / 100
const PACKS: PackConfig[] = [
  {
    id: "20",
    title: "Pack 20 cr√©dits",
    subtitle: "‚âà 20 cr√©dits",
    credits: 20,
    priceText: "‚âà 10 $ (config Polar)",
  },
  {
    id: "50",
    title: "Pack 50 cr√©dits",
    subtitle: "‚âà 50 cr√©dits",
    credits: 50,
    priceText: "‚âà 25 $ (config Polar)",
    highlight: true,
  },
  {
    id: "100",
    title: "Pack 100 cr√©dits",
    subtitle: "‚âà 100 cr√©dits",
    credits: 100,
    priceText: "‚âà 40 $ (config Polar)",
  },
];

export default function PolarDebugPage() {
  const [firebaseUser, setFirebaseUser] = useState<any | null>(null);
  const [profile, setProfile] = useState<UserProfile | null>(null);
  const [loadingUser, setLoadingUser] = useState(true);

  const [loadingPack, setLoadingPack] = useState<CreditPackId | null>(null);
  const [message, setMessage] = useState<string | null>(null);
  const [rawResponse, setRawResponse] = useState<any>(null);
  const [showDetails, setShowDetails] = useState(false);
  const [lastPack, setLastPack] = useState<CreditPackId | null>(null);

  // üîê On r√©cup√®re l'utilisateur Firebase + son doc Firestore ("users/{uid}")
  useEffect(() => {
    const unsubscribe = onAuthStateChanged(auth, async (user) => {
      setFirebaseUser(user);
      if (!user) {
        setProfile(null);
        setLoadingUser(false);
        return;
      }

      try {
        const ref = doc(db, "users", user.uid);
        const snap = await getDoc(ref);
        const data = snap.exists() ? (snap.data() as any) : {};

        const credits =
          typeof data.credits === "number" ? (data.credits as number) : undefined;

        const displayName =
          data.displayName ??
          data.name ??
          data.fullName ??
          user.displayName ??
          undefined;

        const email = user.email ?? data.email ?? "";

        setProfile({
          id: user.uid,
          email,
          displayName,
          credits,
        });
      } catch (err) {
        console.error("[Debug Polar] Erreur chargement profil Firestore :", err);
      } finally {
        setLoadingUser(false);
      }
    });

    return () => unsubscribe();
  }, []);

  const handleBuy = async (packId: CreditPackId) => {
    try {
      setMessage(null);
      setRawResponse(null);
      setLoadingPack(packId);
      setLastPack(packId);

      if (!profile?.id || !profile.email) {
        setMessage(
          "‚ùå Impossible de lancer le paiement : utilisateur non connect√© ou email manquant."
        );
        return;
      }

      const res = await fetch("/api/polar/checkout", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          packId,
          userId: profile.id,
          email: profile.email,
        }),
      });

      const data = await res.json();
      console.error("R√©ponse /api/polar/checkout :", data);
      setRawResponse(data);

      if (!data.ok || !data.url) {
        const msg =
          data.error ||
          data.detail ||
          "‚ùå Erreur lors de la cr√©ation du paiement (r√©ponse API).";
        setMessage(msg);
        return;
      }

      // Redirection vers la page de paiement Polar
      window.location.href = data.url;
    } catch (error) {
      console.error("Erreur handleBuy:", error);
      setMessage("‚ùå Une erreur est survenue c√¥t√© client.");
    } finally {
      setLoadingPack(null);
    }
  };

  const isLoading = (pack: CreditPackId) => loadingPack === pack;
  const isAuthenticated = !!firebaseUser && !!profile;

  return (
    <main
      style={{
        minHeight: "100vh",
        margin: 0,
        padding: "2rem",
        fontFamily: "system-ui, -apple-system, BlinkMacSystemFont, sans-serif",
        background:
          "radial-gradient(circle at top, #111827 0, #020617 45%, #000 100%)",
        color: "#e5e7eb",
        display: "flex",
        justifyContent: "center",
      }}
    >
      <div style={{ width: "100%", maxWidth: "960px" }}>
        {/* Header */}
        <header
          style={{
            marginBottom: "1.5rem",
            display: "flex",
            justifyContent: "space-between",
            gap: "1rem",
            alignItems: "flex-start",
          }}
        >
          <div>
            <h1
              style={{
                fontSize: "1.8rem",
                marginBottom: "0.3rem",
                color: "#f9fafb",
              }}
            >
              Mode debug Polar
            </h1>
            <p style={{ margin: 0, color: "#9ca3af", maxWidth: "32rem" }}>
              Cette page te permet de tester les paiements Polar et le cr√©dit
              de l‚Äôutilisateur dans Firestore, sans toucher √† ton UI principale.
            </p>
          </div>

          <div
            style={{
              padding: "0.75rem 1rem",
              borderRadius: "0.75rem",
              backgroundColor: "rgba(15, 23, 42, 0.85)",
              border: "1px solid rgba(148, 163, 184, 0.4)",
              fontSize: "0.8rem",
              lineHeight: 1.35,
              minWidth: "220px",
            }}
          >
            <div style={{ marginBottom: "0.25rem", fontWeight: 600 }}>
              {loadingUser
                ? "Chargement utilisateur‚Ä¶"
                : isAuthenticated
                ? "Utilisateur connect√©"
                : "Aucun utilisateur connect√©"}
            </div>

            {isAuthenticated && profile && (
              <>
                {profile.displayName && (
                  <div>
                    <span style={{ color: "#9ca3af" }}>Nom :</span>{" "}
                    <strong>{profile.displayName}</strong>
                  </div>
                )}
                <div>
                  <span style={{ color: "#9ca3af" }}>Email :</span>{" "}
                  <strong>{profile.email}</strong>
                </div>
                <div>
                  <span style={{ color: "#9ca3af" }}>ID :</span>{" "}
                  <code
                    style={{
                      backgroundColor: "rgba(15,23,42,0.9)",
                      padding: "0.1rem 0.3rem",
                      borderRadius: "0.25rem",
                    }}
                  >
                    {profile.id}
                  </code>
                </div>
                {typeof profile.credits === "number" && (
                  <div style={{ marginTop: "0.25rem" }}>
                    <span style={{ color: "#9ca3af" }}>Cr√©dits :</span>{" "}
                    <strong>{profile.credits}</strong>
                  </div>
                )}
              </>
            )}

            {!loadingUser && !isAuthenticated && (
              <div style={{ color: "#f97316", marginTop: "0.3rem" }}>
                Connecte-toi dans l‚Äôapp pour tester les paiements.
              </div>
            )}
          </div>
        </header>

        {/* Boutons de contr√¥le */}
        <div
          style={{
            display: "flex",
            gap: "0.5rem",
            marginBottom: "1.5rem",
            flexWrap: "wrap",
          }}
        >
          <button
            type="button"
            onClick={() => setShowDetails((v) => !v)}
            style={{
              padding: "0.5rem 0.9rem",
              borderRadius: "999px",
              border: "1px solid rgba(148, 163, 184, 0.6)",
              backgroundColor: showDetails
                ? "rgba(34, 197, 94, 0.15)"
                : "rgba(15,23,42,0.9)",
              color: showDetails ? "#bbf7d0" : "#e5e7eb",
              fontSize: "0.8rem",
              cursor: "pointer",
            }}
          >
            {showDetails ? "Masquer les d√©tails API" : "Afficher les d√©tails API"}
          </button>

          {lastPack && (
            <button
              type="button"
              onClick={() => handleBuy(lastPack)}
              style={{
                padding: "0.5rem 0.9rem",
                borderRadius: "999px",
                border: "1px solid rgba(148, 163, 184, 0.4)",
                backgroundColor: "rgba(15,23,42,0.9)",
                color: "#e5e7eb",
                fontSize: "0.8rem",
                cursor: "pointer",
              }}
            >
              Relancer le pack test√© ({lastPack})
            </button>
          )}

          <button
            type="button"
            onClick={() => {
              setMessage(null);
              setRawResponse(null);
            }}
            style={{
              padding: "0.5rem 0.9rem",
              borderRadius: "999px",
              border: "1px solid rgba(55, 65, 81, 0.9)",
              backgroundColor: "transparent",
              color: "#9ca3af",
              fontSize: "0.8rem",
              cursor: "pointer",
            }}
          >
            Effacer les messages
          </button>
        </div>

        {/* Cartes de packs */}
        <section
          style={{
            display: "grid",
            gridTemplateColumns: "repeat(auto-fit, minmax(240px, 1fr))",
            gap: "1rem",
            marginBottom: "1.5rem",
          }}
        >
          {PACKS.map((pack) => {
            const loading = isLoading(pack.id);
            const disabled = !isAuthenticated || loading;

            return (
              <article
                key={pack.id}
                style={{
                  position: "relative",
                  borderRadius: "1rem",
                  padding: "1.1rem 1.1rem 1rem",
                  background:
                    "linear-gradient(145deg, rgba(15,23,42,0.96), rgba(15,23,42,0.9))",
                  border: pack.highlight
                    ? "1px solid rgba(96, 165, 250, 0.9)"
                    : "1px solid rgba(31, 41, 55, 1)",
                  boxShadow: pack.highlight
                    ? "0 0 0 1px rgba(59,130,246,0.3), 0 18px 40px rgba(15,23,42,0.9)"
                    : "0 14px 35px rgba(15,23,42,0.85)",
                  overflow: "hidden",
                }}
              >
                {pack.highlight && (
                  <div
                    style={{
                      position: "absolute",
                      top: "0.7rem",
                      right: "0.9rem",
                      fontSize: "0.7rem",
                      padding: "0.15rem 0.5rem",
                      borderRadius: "999px",
                      background:
                        "linear-gradient(to right, #2563eb, #22c55e)",
                      color: "#f9fafb",
                      fontWeight: 600,
                      letterSpacing: "0.04em",
                      textTransform: "uppercase",
                    }}
                  >
                    Recommand√©
                  </div>
                )}

                <div style={{ marginBottom: "0.75rem" }}>
                  <h2
                    style={{
                      fontSize: "1rem",
                      margin: 0,
                      color: "#f9fafb",
                    }}
                  >
                    {pack.title}
                  </h2>
                  <p
                    style={{
                      margin: "0.15rem 0 0",
                      fontSize: "0.8rem",
                      color: "#9ca3af",
                    }}
                  >
                    {pack.subtitle} ‚Ä¢ {pack.priceText}
                  </p>
                </div>

                <div
                  style={{
                    display: "flex",
                    alignItems: "baseline",
                    gap: "0.5rem",
                    marginBottom: "0.5rem",
                  }}
                >
                  <div style={{ fontSize: "2rem", fontWeight: 700 }}>
                    {pack.credits}
                  </div>
                  <div
                    style={{
                      fontSize: "0.8rem",
                      textTransform: "uppercase",
                      letterSpacing: "0.08em",
                      color: "#9ca3af",
                      fontWeight: 500,
                    }}
                  >
                    cr√©dits
                  </div>
                </div>

                <p
                  style={{
                    margin: 0,
                    fontSize: "0.8rem",
                    color: "#9ca3af",
                    minHeight: "2.4rem",
                  }}
                >
                  Cr√©dits utilisables pour les actions IA (analyse CV,
                  candidatures, etc.).
                </p>

                <div
                  style={{
                    marginTop: "0.9rem",
                    display: "flex",
                    justifyContent: "space-between",
                    alignItems: "center",
                    gap: "0.75rem",
                  }}
                >
                  <button
                    type="button"
                    onClick={() => handleBuy(pack.id)}
                    disabled={disabled}
                    style={{
                      flex: 1,
                      padding: "0.55rem 0.8rem",
                      borderRadius: "999px",
                      border: "none",
                      cursor: disabled ? "default" : "pointer",
                      background: pack.highlight
                        ? "linear-gradient(to right, #2563eb, #22c55e)"
                        : "linear-gradient(to right, #4b5563, #1f2937)",
                      color: "#f9fafb",
                      fontSize: "0.85rem",
                      fontWeight: 600,
                      textAlign: "center",
                      opacity: disabled ? 0.5 : 1,
                      transition:
                        "transform 0.12s ease, box-shadow 0.12s ease, opacity 0.12s ease",
                    }}
                  >
                    {loading
                      ? "Redirection..."
                      : isAuthenticated
                      ? "Tester ce pack"
                      : "Connexion requise"}
                  </button>

                  <div
                    style={{
                      fontSize: "0.7rem",
                      color: "#6b7280",
                      textAlign: "right",
                    }}
                  >
                    ID interne :{" "}
                    <code
                      style={{
                        backgroundColor: "rgba(15,23,42,0.9)",
                        padding: "0.15rem 0.35rem",
                        borderRadius: "999px",
                      }}
                    >
                      {pack.id}
                    </code>
                  </div>
                </div>
              </article>
            );
          })}
        </section>

        {/* Message d'erreur simple */}
        {message && (
          <div
            style={{
              marginBottom: "1rem",
              padding: "0.75rem 1rem",
              borderRadius: "0.75rem",
              backgroundColor: "rgba(127, 29, 29, 0.4)",
              border: "1px solid rgba(248, 113, 113, 0.7)",
              color: "#fecaca",
              fontSize: "0.85rem",
            }}
          >
            <strong style={{ display: "block", marginBottom: "0.15rem" }}>
              Erreur
            </strong>
            <span>{message}</span>
          </div>
        )}

        {/* D√©tails API (raw JSON) */}
        {showDetails && rawResponse && (
          <section>
            <h2
              style={{
                fontSize: "0.9rem",
                marginBottom: "0.4rem",
                color: "#e5e7eb",
              }}
            >
              D√©tails de la derni√®re r√©ponse API
            </h2>
            <pre
              style={{
                margin: 0,
                padding: "1rem",
                background:
                  "linear-gradient(135deg, rgba(15,23,42,0.98), rgba(15,23,42,0.95))",
                borderRadius: "0.75rem",
                fontSize: "0.78rem",
                overflowX: "auto",
                border: "1px solid rgba(31, 41, 55, 1)",
              }}
            >
{JSON.stringify(rawResponse, null, 2)}
            </pre>
          </section>
        )}
      </div>
    </main>
  );
}
````

## File: app/forgot-password/page.tsx
````typescript
"use client";

import { useState, FormEvent } from "react";
import Script from "next/script";
import Link from "next/link";
import { sendPasswordResetEmail } from "firebase/auth";
import { auth } from "@/lib/firebase";
import { getRecaptchaToken, verifyRecaptcha } from "@/lib/recaptcha";

export default function ForgotPasswordPage() {
  const [email, setEmail] = useState("");
  const [submitting, setSubmitting] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [info, setInfo] = useState<string | null>(null);

  const handleSubmit = async (e: FormEvent) => {
    e.preventDefault();
    setError(null);
    setInfo(null);
    setSubmitting(true);

    try {
      // ‚úÖ reCAPTCHA avant envoi reset email
      const action = "PASSWORD_RESET";
      let token = "";
      try {
        token = await getRecaptchaToken(action);
      } catch {
        setError(
          "S√©curit√©: impossible de valider reCAPTCHA (script bloqu√© ?). D√©sactive l'adblock et r√©essaie."
        );
        return;
      }

      const check = await verifyRecaptcha(token, action);
      if (!check.ok) {
        setError("Demande refus√©e par s√©curit√©. R√©essayez dans quelques secondes.");
        return;
      }

      await sendPasswordResetEmail(auth, email);
      setInfo(
        "Si un compte existe pour cette adresse email, un lien de r√©initialisation vient de t'√™tre envoy√©. Pense √† v√©rifier tes spams."
      );
    } catch (err: any) {
      console.error("Forgot password error:", err);
      const code = err?.code as string | undefined;

      if (code === "auth/invalid-email") {
        setError("Adresse email invalide.");
      } else {
        setError(
          "Impossible d'envoyer l'email de r√©initialisation pour le moment. R√©essaie dans quelques instants."
        );
      }
    } finally {
      setSubmitting(false);
    }
  };

  return (
    <div className="min-h-screen flex flex-col bg-gradient-to-b from-slate-950 via-slate-950/95 to-slate-900 text-slate-100">
      <Script
        src={`https://www.google.com/recaptcha/enterprise.js?render=${process.env.NEXT_PUBLIC_RECAPTCHA_SITE_KEY}`}
        strategy="afterInteractive"
      />

      <header className="border-b border-slate-800/80 bg-slate-950/80 backdrop-blur">
        <div className="max-w-5xl mx-auto px-4 sm:px-6 py-3 flex items-center justify-between gap-3">
          <div className="flex items-center gap-2">
            <div className="w-8 h-8 rounded-xl bg-gradient-to-br from-sky-500 to-sky-400 flex items-center justify-center text-[10px] font-semibold text-slate-950 shadow-lg shadow-sky-500/40">
              IA
            </div>
            <div className="flex flex-col">
              <span className="text-[10px] uppercase tracking-[0.18em] text-slate-400">
                Assistant candidatures
              </span>
              <span className="text-xs font-medium text-slate-100">Mot de passe oubli√©</span>
            </div>
          </div>
          <nav className="flex items-center gap-2 text-[11px]">
            <Link
              href="/"
              className="px-2 py-1 rounded-full border border-slate-700/80 hover:border-sky-500/80 text-slate-300 hover:text-sky-300 transition-colors"
            >
              ‚Üê Accueil
            </Link>
            <Link
              href="/login"
              className="px-3 py-1 rounded-full bg-sky-500/90 text-slate-950 font-medium hover:bg-sky-400 transition-colors"
            >
              Se connecter
            </Link>
            <Link
              href="/signup"
              className="px-3 py-1 rounded-full border border-slate-700/80 text-slate-300 hover:border-sky-500/80 hover:text-sky-300 transition-colors"
            >
              S&apos;inscrire
            </Link>
          </nav>
        </div>
      </header>

      <main className="flex-1 flex items-center justify-center px-4 py-6">
        <div className="glass max-w-md w-full p-6 sm:p-7 rounded-2xl border border-slate-800 bg-slate-950/80 shadow-2xl shadow-sky-900/40">
          <div className="mb-4">
            <p className="inline-flex items-center gap-2 rounded-full bg-slate-900/80 border border-slate-700 px-3 py-1 mb-2">
              <span className="text-xs">üí¨</span>
              <span className="text-[11px] uppercase tracking-[0.18em] text-slate-300">
                Mot de passe oubli√©
              </span>
            </p>
            <h1 className="text-lg sm:text-xl font-semibold text-slate-50">
              R√©initialiser ton mot de passe
            </h1>
            <p className="text-xs text-slate-400 mt-1">
              Entre l&apos;adresse email li√©e √† ton compte. Si elle existe, tu recevras un lien s√©curis√©.
            </p>
          </div>

          {info && (
            <div className="mb-2 rounded-lg border border-emerald-500/70 bg-emerald-500/10 px-3 py-2 text-[11px] text-emerald-100">
              {info}
            </div>
          )}

          {error && (
            <div className="mb-2 rounded-lg border border-rose-500/70 bg-rose-500/10 px-3 py-2 text-[11px] text-rose-100">
              {error}
            </div>
          )}

          <form onSubmit={handleSubmit} className="space-y-3 text-sm">
            <div>
              <label className="block mb-1 text-xs text-slate-300" htmlFor="email">
                Adresse email
              </label>
              <input
                id="email"
                type="email"
                required
                autoComplete="email"
                className="w-full rounded-lg bg-slate-900/80 border border-slate-700 px-3 py-2 text-xs text-slate-100 placeholder:text-slate-500 outline-none focus:ring-1 focus:ring-sky-500 focus:border-sky-500"
                placeholder="toi@example.com"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                disabled={submitting}
              />
            </div>

            <button
              type="submit"
              disabled={submitting}
              className="w-full inline-flex items-center justify-center rounded-lg bg-sky-500 hover:bg-sky-600 disabled:opacity-60 disabled:cursor-not-allowed text-xs font-medium text-white px-3 py-2 transition-colors mt-1"
            >
              {submitting ? "Envoi du lien..." : "Envoyer le lien de r√©initialisation"}
            </button>
          </form>

          <p className="mt-4 text-[11px] text-slate-400 text-center">
            Tu te souviens de ton mot de passe ?{" "}
            <Link href="/login" className="text-sky-400 hover:text-sky-300 hover:underline font-medium">
              Retour √† la connexion
            </Link>
          </p>
        </div>
      </main>
    </div>
  );
}
````

## File: app/login/page.tsx
````typescript
"use client";

import { Suspense, useState, useEffect, FormEvent } from "react";
import Script from "next/script";
import Link from "next/link";
import { useRouter, useSearchParams } from "next/navigation";
import {
  signInWithEmailAndPassword,
  signInWithPopup,
  GoogleAuthProvider,
} from "firebase/auth";
import { auth, googleProvider, db } from "@/lib/firebase";
import { doc, getDoc } from "firebase/firestore";
import { useAuth } from "@/context/AuthContext";
import { logAuthFailed } from "@/lib/logAuthFailed";
import { getRecaptchaToken, verifyRecaptcha } from "@/lib/recaptcha";

const MAX_ATTEMPTS = 5;
const LOCK_DURATION_MS = 60_000; // 1 minute

function LoginPageInner() {
  const router = useRouter();
  const searchParams = useSearchParams();

  const { user, loading, blocked } = useAuth();

  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [showPwd, setShowPwd] = useState(false);
  const [submitting, setSubmitting] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [info, setInfo] = useState<string | null>(null);

  const [attempts, setAttempts] = useState(0);
  const [isLocked, setIsLocked] = useState(false);
  const [lockEnd, setLockEnd] = useState<number | null>(null);
  const [lockRemaining, setLockRemaining] = useState(0);

  // ‚úÖ Affiche le message si compte bloqu√© (depuis AuthContext)
  useEffect(() => {
    if (!blocked) return;
    setInfo(null);
    setError(
      "Votre compte est bloqu√©. Si vous pensez que c'est une erreur, contactez l'administrateur."
    );
  }, [blocked]);

  // ‚úÖ Redirection auto si d√©j√† connect√© (mais PAS si blocked, ni pendant submit)
  useEffect(() => {
    if (loading) return;
    if (blocked) return;
    if (!user) return;
    if (submitting) return;

    const redirectTo = searchParams.get("redirect") || "/app";
    router.replace(redirectTo);
  }, [loading, blocked, user, searchParams, router, submitting]);

  // ‚úÖ Message query params
  useEffect(() => {
    const justSignedUp = searchParams.get("justSignedUp");
    const blockedParam = searchParams.get("blocked");

    if (blockedParam === "1") {
      setInfo(null);
      setError(
        "Votre compte a √©t√© bloqu√© par l'administrateur. Si vous pensez que c'est une erreur, contactez le support."
      );
    } else if (justSignedUp === "1") {
      setError(null);
      setInfo(
        "Votre compte a bien √©t√© cr√©√©. Pensez √† valider votre adresse email avant votre premi√®re connexion."
      );
    }
  }, [searchParams]);

  // ‚úÖ Recharge lock depuis localStorage
  useEffect(() => {
    if (typeof window === "undefined") return;

    const storedAttempts = window.localStorage.getItem("loginAttempts");
    const storedLockEnd = window.localStorage.getItem("loginLockEnd");
    const now = Date.now();

    if (storedAttempts) {
      const a = parseInt(storedAttempts, 10);
      if (!Number.isNaN(a)) setAttempts(a);
    }

    if (storedLockEnd) {
      const end = parseInt(storedLockEnd, 10);
      if (!Number.isNaN(end) && end > now) {
        setIsLocked(true);
        setLockEnd(end);
        setLockRemaining(Math.ceil((end - now) / 1000));
      } else {
        window.localStorage.removeItem("loginAttempts");
        window.localStorage.removeItem("loginLockEnd");
      }
    }
  }, []);

  // ‚úÖ Timer lock
  useEffect(() => {
    if (!isLocked || !lockEnd) return;

    const id = window.setInterval(() => {
      const diff = lockEnd - Date.now();
      if (diff <= 0) {
        setIsLocked(false);
        setAttempts(0);
        setLockEnd(null);
        setLockRemaining(0);

        window.localStorage.removeItem("loginAttempts");
        window.localStorage.removeItem("loginLockEnd");

        window.clearInterval(id);
      } else {
        setLockRemaining(Math.ceil(diff / 1000));
      }
    }, 1000);

    return () => window.clearInterval(id);
  }, [isLocked, lockEnd]);

  // -------------------------
  //  LOGIN EMAIL / PASSWORD
  // -------------------------
  const handleSubmit = async (e: FormEvent) => {
    e.preventDefault();
    if (isLocked) return;

    setError(null);
    setInfo(null);
    setSubmitting(true);

    try {
      // ‚úÖ reCAPTCHA avant Firebase Auth
      const action = "LOGIN";
      let token = "";
      try {
        token = await getRecaptchaToken(action);
      } catch {
        setError(
          "S√©curit√©: impossible de valider reCAPTCHA (script bloqu√© ?). D√©sactive l'adblock et r√©essaie."
        );
        return;
      }

      const check = await verifyRecaptcha(token, action);
      if (!check.ok) {
        setError("Connexion refus√©e par s√©curit√©. R√©essayez dans quelques secondes.");
        logAuthFailed({
          email,
          provider: "password",
          errorCode: `recaptcha:${check.reason}`,
          errorMessage: `score=${check.score ?? "?"}`,
        });
        return;
      }

      const cred = await signInWithEmailAndPassword(auth, email, password);

      // V√©rif blocage Firestore (optionnel, mais ok)
      const ref = doc(db, "users", cred.user.uid);
      const snap = await getDoc(ref);
      const data = snap.data() as any | undefined;

      if (data?.blocked) {
        await auth.signOut();
        setError(
          "Votre compte est bloqu√©. Si vous pensez que c'est une erreur, contactez l'administrateur."
        );
        return;
      }

      // ‚úÖ Reset lock
      setAttempts(0);
      setIsLocked(false);
      setLockEnd(null);
      setLockRemaining(0);
      window.localStorage.removeItem("loginAttempts");
      window.localStorage.removeItem("loginLockEnd");

      const redirectTo = searchParams.get("redirect") || "/app";
      router.replace(redirectTo);
    } catch (err: any) {
      console.error("Erreur login:", err);

      const code = err?.code as string | undefined;

      logAuthFailed({
        email,
        provider: "password",
        errorCode: code,
        errorMessage: err?.message,
      });

      setAttempts((prev) => {
        const next = prev + 1;
        window.localStorage.setItem("loginAttempts", String(next));

        if (next >= MAX_ATTEMPTS) {
          const end = Date.now() + LOCK_DURATION_MS;
          setIsLocked(true);
          setLockEnd(end);
          setLockRemaining(Math.ceil(LOCK_DURATION_MS / 1000));
          window.localStorage.setItem("loginLockEnd", String(end));
        }

        return next;
      });

      if (code === "auth/wrong-password" || code === "auth/user-not-found") {
        setError("Email ou mot de passe incorrect. V√©rifiez vos identifiants puis r√©essayez.");
      } else if (code === "auth/too-many-requests") {
        setError(
          "Trop de tentatives √©chou√©es. Votre compte est temporairement bloqu√© c√¥t√© serveur. R√©essayez dans quelques minutes ou r√©initialisez votre mot de passe."
        );
      } else if (code === "auth/network-request-failed") {
        setError("Probl√®me de connexion r√©seau. V√©rifiez votre connexion Internet.");
      } else {
        setError("Impossible de vous connecter pour le moment. R√©essayez dans quelques instants.");
      }
    } finally {
      setSubmitting(false);
    }
  };

  // -------------------------
  //  LOGIN GOOGLE
  // -------------------------
  const handleGoogleLogin = async () => {
    setError(null);
    setInfo(null);
    setSubmitting(true);

    try {
      // ‚úÖ reCAPTCHA avant Firebase Auth
      const action = "LOGIN_GOOGLE";
      let token = "";
      try {
        token = await getRecaptchaToken(action);
      } catch {
        setError(
          "S√©curit√©: impossible de valider reCAPTCHA (script bloqu√© ?). D√©sactive l'adblock et r√©essaie."
        );
        return;
      }

      const check = await verifyRecaptcha(token, action);
      if (!check.ok) {
        setError("Connexion refus√©e par s√©curit√©. R√©essayez dans quelques secondes.");
        logAuthFailed({
          email,
          provider: "google",
          errorCode: `recaptcha:${check.reason}`,
          errorMessage: `score=${check.score ?? "?"}`,
        });
        return;
      }

      const provider = googleProvider || new GoogleAuthProvider();
      const result = await signInWithPopup(auth, provider);
      const u = result.user;

      const ref = doc(db, "users", u.uid);
      const snap = await getDoc(ref);
      const data = snap.data() as any | undefined;

      if (data?.blocked) {
        await auth.signOut();
        setError(
          "Votre compte est bloqu√©. Si vous pensez que c'est une erreur, contactez l'administrateur."
        );
        return;
      }

      const displayName = u.displayName || u.email || "";
      setInfo(`Bienvenue ${displayName} üëã`);

      const redirectTo = searchParams.get("redirect") || "/app";
      router.replace(redirectTo);
    } catch (err: any) {
      console.error("Google login error:", err);
      const code = err?.code as string | undefined;

      logAuthFailed({
        email,
        provider: "google",
        errorCode: code,
        errorMessage: err?.message,
      });

      if (code === "auth/account-exists-with-different-credential") {
        setError(
          "Un compte existe d√©j√† pour cette adresse email avec une autre m√©thode de connexion. Essayez avec votre mot de passe habituel."
        );
      } else if (code === "auth/popup-closed-by-user") {
        setError("La fen√™tre Google a √©t√© ferm√©e avant la fin du processus.");
      } else if (code === "auth/network-request-failed") {
        setError("Probl√®me de connexion r√©seau. V√©rifiez votre connexion Internet.");
      } else {
        setError("Impossible de vous connecter avec Google pour le moment.");
      }
    } finally {
      setSubmitting(false);
    }
  };

  const attemptsLeft = Math.max(0, MAX_ATTEMPTS - attempts);

  if (loading) {
    return (
      <div className="min-h-screen flex items-center justify-center text-sm text-slate-400">
        Chargement‚Ä¶
      </div>
    );
  }

  return (
    <div className="min-h-screen flex flex-col bg-gradient-to-b from-slate-950 via-slate-950/95 to-slate-900 text-slate-100">
      <Script
        src={`https://www.google.com/recaptcha/enterprise.js?render=${process.env.NEXT_PUBLIC_RECAPTCHA_SITE_KEY}`}
        strategy="afterInteractive"
      />

      {/* NAVBAR */}
      <header className="border-b border-slate-800/80 bg-slate-950/80 backdrop-blur">
        <div className="max-w-5xl mx-auto px-4 sm:px-6 py-3 flex items-center justify-between gap-3">
          <div className="flex items-center gap-2">
            <div className="w-8 h-8 rounded-xl bg-gradient-to-br from-sky-500 to-sky-400 flex items-center justify-center text-[10px] font-semibold text-slate-950 shadow-lg shadow-sky-500/40">
              IA
            </div>
            <div className="flex flex-col">
              <span className="text-[10px] uppercase tracking-[0.18em] text-slate-400">
                Assistant candidatures
              </span>
              <span className="text-xs font-medium text-slate-100">Connexion</span>
            </div>
          </div>
          <nav className="flex items-center gap-2 text-[11px]">
            <Link
              href="/"
              className="px-2 py-1 rounded-full border border-slate-700/80 hover:border-sky-500/80 text-slate-300 hover:text-sky-300 transition-colors"
            >
              ‚Üê Retour accueil
            </Link>
            <Link
              href="/signup"
              className="px-3 py-1 rounded-full bg-sky-500/90 text-slate-950 font-medium hover:bg-sky-400 transition-colors"
            >
              S&apos;inscrire
            </Link>
          </nav>
        </div>
      </header>

      {/* CONTENU */}
      <main className="flex-1 flex items-center justify-center px-4 py-6">
        <div className="glass max-w-md w-full p-6 sm:p-7 rounded-2xl border border-slate-800 bg-slate-950/80 shadow-2xl shadow-sky-900/40">
          <div className="mb-4">
            <p className="inline-flex items-center gap-2 rounded-full bg-slate-900/80 border border-slate-700 px-3 py-1 mb-2">
              <span className="text-xs">üîê</span>
              <span className="text-[11px] uppercase tracking-[0.18em] text-slate-300">
                Connexion
              </span>
            </p>
            <h1 className="text-lg sm:text-xl font-semibold text-slate-50">
              Connexion √† votre espace
            </h1>
            <p className="text-xs text-slate-400 mt-1">
              Connectez-vous pour acc√©der √† votre tableau de bord, votre CV IA et vos candidatures.
            </p>
          </div>

          {info && (
            <div className="mb-2 rounded-lg border border-emerald-500/70 bg-emerald-500/10 px-3 py-2 text-[11px] text-emerald-100">
              {info}
            </div>
          )}

          {error && (
            <div className="mb-2 rounded-lg border border-rose-500/70 bg-rose-500/10 px-3 py-2 text-[11px] text-rose-100">
              {error}
            </div>
          )}

          {isLocked && lockRemaining > 0 && (
            <div className="mb-3 rounded-lg border border-amber-500/70 bg-amber-500/10 px-3 py-2 text-[11px] text-amber-100">
              <span className="font-semibold">Votre compte est temporairement bloqu√©.</span>{" "}
              Trop de tentatives √©chou√©es. R√©essayez dans environ {lockRemaining} seconde
              {lockRemaining > 1 ? "s" : ""} ou utilisez{" "}
              <span className="font-semibold">¬´ Mot de passe oubli√© ¬ª</span>.
            </div>
          )}

          {!isLocked && attempts > 0 && attemptsLeft > 0 && (
            <p className="mb-2 text-[10px] text-slate-400">
              Tentative √©chou√©e. Il vous reste{" "}
              <span className="font-semibold">{attemptsLeft}</span> tentative
              {attemptsLeft > 1 ? "s" : ""} avant le blocage temporaire.
            </p>
          )}

          <form onSubmit={handleSubmit} className="space-y-3 text-sm">
            <div>
              <label className="block mb-1 text-xs text-slate-300">Email</label>
              <input
                type="email"
                required
                autoComplete="email"
                className="w-full rounded-lg bg-slate-900/80 border border-slate-700 px-3 py-2 text-xs text-slate-100 placeholder:text-slate-500 outline-none focus:ring-1 focus:ring-sky-500 focus:border-sky-500"
                placeholder="vous@example.com"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                disabled={submitting || isLocked}
              />
            </div>

            <div>
              <label className="block mb-1 text-xs text-slate-300">Mot de passe</label>
              <div className="relative">
                <input
                  type={showPwd ? "text" : "password"}
                  required
                  autoComplete="current-password"
                  className="w-full rounded-lg bg-slate-900/80 border border-slate-700 px-3 py-2 text-xs text-slate-100 placeholder:text-slate-500 outline-none focus:ring-1 focus:ring-sky-500 focus:border-sky-500 pr-16"
                  placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  disabled={submitting || isLocked}
                />
                <button
                  type="button"
                  onClick={() => setShowPwd((v) => !v)}
                  className="absolute inset-y-0 right-2 flex items-center text-[11px] text-slate-400 hover:text-slate-200"
                >
                  {showPwd ? "Masquer" : "Afficher"}
                </button>
              </div>
              <div className="mt-1 flex justify-between items-center">
                <Link
                  href="/forgot-password"
                  className="text-[11px] text-sky-400 hover:text-sky-300 hover:underline"
                >
                  Mot de passe oubli√© ?
                </Link>
              </div>
            </div>

            <button
              type="submit"
              disabled={submitting || isLocked}
              className="w-full inline-flex items-center justify-center rounded-lg bg-sky-500 hover:bg-sky-600 disabled:opacity-60 disabled:cursor-not-allowed text-xs font-medium text-white px-3 py-2 transition-colors mt-1"
            >
              {isLocked ? "Compte temporairement bloqu√©" : submitting ? "Connexion..." : "Se connecter"}
            </button>
          </form>

          <div className="flex items-center gap-2 my-4">
            <div className="h-px flex-1 bg-slate-800" />
            <span className="text-[10px] text-slate-500 uppercase tracking-[0.16em]">ou</span>
            <div className="h-px flex-1 bg-slate-800" />
          </div>

          <button
            type="button"
            onClick={handleGoogleLogin}
            disabled={submitting}
            className="w-full inline-flex items-center justify-center rounded-lg bg-slate-900/80 border border-slate-700 hover:border-sky-500 text-xs font-medium text-slate-100 px-3 py-2.5 transition-colors"
          >
            Continuer avec <span className="font-semibold ml-1">Google</span>
          </button>

          <p className="mt-4 text-[11px] text-slate-400 text-center">
            Pas encore de compte ?{" "}
            <Link href="/signup" className="text-sky-400 hover:text-sky-300 hover:underline font-medium">
              Cr√©er un compte
            </Link>
          </p>
        </div>
      </main>
    </div>
  );
}

export default function LoginPage() {
  return (
    <Suspense
      fallback={
        <div className="min-h-screen flex items-center justify-center text-sm text-slate-400">
          Chargement‚Ä¶
        </div>
      }
    >
      <LoginPageInner />
    </Suspense>
  );
}
````

## File: app/signup/page.tsx
````typescript
"use client";

import { Suspense, useState, useMemo, FormEvent } from "react";
import Script from "next/script";
import { useRouter, useSearchParams } from "next/navigation";
import Link from "next/link";
import {
  createUserWithEmailAndPassword,
  updateProfile,
  sendEmailVerification,
  signInWithPopup,
  GoogleAuthProvider,
} from "firebase/auth";
import { auth, googleProvider } from "@/lib/firebase";
import { getRecaptchaToken, verifyRecaptcha } from "@/lib/recaptcha";

function checkPasswordRules(pwd: string) {
  const min = pwd.length >= 8;
  const upper = /[A-Z]/.test(pwd);
  const digit = /[0-9]/.test(pwd);
  const special = /[!@#$%^&*(),.?":{}|<>]/.test(pwd);
  const ok = min && upper && digit && special;
  return { min, upper, digit, special, ok };
}

function SignupPageInner() {
  const router = useRouter();
  const searchParams = useSearchParams();

  const [firstName, setFirstName] = useState("");
  const [lastName, setLastName] = useState("");

  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [showPwd, setShowPwd] = useState(false);

  const [error, setError] = useState<string | null>(null);
  const [info, setInfo] = useState<string | null>(null);
  const [loading, setLoading] = useState(false);

  const pwdRules = useMemo(() => checkPasswordRules(password), [password]);

  function mapSignupError(err: any) {
    const code = err?.code as string | undefined;

    if (code === "auth/email-already-in-use") {
      return "Cette adresse email est d√©j√† associ√©e √† un compte. Veuillez vous connecter.";
    }
    if (code === "auth/invalid-email") {
      return "Adresse email invalide.";
    }
    return "Une erreur est survenue lors de l'inscription. Merci de r√©essayer.";
  }

  async function handleSubmit(e: FormEvent) {
    e.preventDefault();
    setError(null);
    setInfo(null);

    if (!pwdRules.ok) {
      setError(
        "Le mot de passe ne respecte pas les r√®gles de s√©curit√©. V√©rifie les crit√®res en dessous du champ."
      );
      return;
    }

    setLoading(true);
    try {
      // ‚úÖ reCAPTCHA avant Firebase Auth
      const action = "SIGNUP";
      let token = "";
      try {
        token = await getRecaptchaToken(action);
      } catch {
        setError(
          "S√©curit√©: impossible de valider reCAPTCHA (script bloqu√© ?). D√©sactive l'adblock et r√©essaie."
        );
        return;
      }

      const check = await verifyRecaptcha(token, action);
      if (!check.ok) {
        setError("Inscription refus√©e par s√©curit√©. R√©essayez dans quelques secondes.");
        return;
      }

      const cred = await createUserWithEmailAndPassword(auth, email, password);

      const displayName = `${firstName} ${lastName}`.trim() || email;
      if (displayName) {
        await updateProfile(cred.user, { displayName });
      }

      await sendEmailVerification(cred.user);

      router.push("/login?justSignedUp=1");
    } catch (err: any) {
      console.error("Signup error:", err);
      setError(mapSignupError(err));
    } finally {
      setLoading(false);
    }
  }

  async function handleGoogleSignup() {
    setError(null);
    setInfo(null);
    setLoading(true);
    try {
      // ‚úÖ reCAPTCHA avant Firebase Auth (Google)
      const action = "SIGNUP_GOOGLE";
      let token = "";
      try {
        token = await getRecaptchaToken(action);
      } catch {
        setError(
          "S√©curit√©: impossible de valider reCAPTCHA (script bloqu√© ?). D√©sactive l'adblock et r√©essaie."
        );
        return;
      }

      const check = await verifyRecaptcha(token, action);
      if (!check.ok) {
        setError("Inscription refus√©e par s√©curit√©. R√©essayez dans quelques secondes.");
        return;
      }

      const provider = googleProvider || new GoogleAuthProvider();
      const result = await signInWithPopup(auth, provider);
      const user = result.user;

      const displayName = user.displayName || user.email || "";
      setInfo(`Bienvenue ${displayName} üëã`);

      // (Tu peux aussi respecter redirect si tu veux)
      const redirectTo = searchParams.get("redirect") || "/app";
      router.push(redirectTo);
    } catch (err: any) {
      console.error("Google signup error:", err);
      const code = err?.code as string | undefined;

      if (code === "auth/account-exists-with-different-credential") {
        setError(
          "Un compte existe d√©j√† pour cette adresse email. Veuillez vous connecter avec votre mot de passe habituel."
        );
      } else if (code === "auth/popup-closed-by-user") {
        setError("La fen√™tre Google a √©t√© ferm√©e avant la fin du processus.");
      } else {
        setError("Impossible de terminer l'inscription avec Google pour le moment.");
      }
    } finally {
      setLoading(false);
    }
  }

  return (
    <div className="min-h-screen flex flex-col bg-gradient-to-b from-slate-950 via-slate-950/95 to-slate-900 text-slate-100">
      <Script
        src={`https://www.google.com/recaptcha/enterprise.js?render=${process.env.NEXT_PUBLIC_RECAPTCHA_SITE_KEY}`}
        strategy="afterInteractive"
      />

      {/* NAVBAR */}
      <header className="border-b border-slate-800/80 bg-slate-950/80 backdrop-blur">
        <div className="max-w-5xl mx-auto px-4 sm:px-6 py-3 flex items-center justify-between gap-3">
          <div className="flex items-center gap-2">
            <div className="w-8 h-8 rounded-xl bg-gradient-to-br from-sky-500 to-sky-400 flex items-center justify-center text-[10px] font-semibold text-slate-950 shadow-lg shadow-sky-500/40">
              IA
            </div>
            <div className="flex flex-col">
              <span className="text-[10px] uppercase tracking-[0.18em] text-slate-400">
                Assistant candidatures
              </span>
              <span className="text-xs font-medium text-slate-100">Inscription</span>
            </div>
          </div>
          <nav className="flex items-center gap-2 text-[11px]">
            <Link
              href="/"
              className="px-2 py-1 rounded-full border border-slate-700/80 hover:border-sky-500/80 text-slate-300 hover:text-sky-300 transition-colors"
            >
              ‚Üê Retour accueil
            </Link>
            <Link
              href="/login"
              className="px-3 py-1 rounded-full bg-sky-500/90 text-slate-950 font-medium hover:bg-sky-400 transition-colors"
            >
              Se connecter
            </Link>
          </nav>
        </div>
      </header>

      {/* CONTENU */}
      <main className="flex-1 flex items-center justify-center px-4 py-6">
        <div className="glass max-w-md w-full p-6 sm:p-7 rounded-2xl border border-slate-800 bg-slate-950/80 shadow-2xl shadow-sky-900/40">
          <div className="mb-4">
            <p className="inline-flex items-center gap-2 rounded-full bg-slate-900/80 border border-slate-700 px-3 py-1 mb-2">
              <span className="text-xs">‚ú®</span>
              <span className="text-[11px] uppercase tracking-[0.18em] text-slate-300">
                Inscription
              </span>
            </p>
            <h1 className="text-lg sm:text-xl font-semibold text-slate-50">Cr√©er un compte</h1>
            <p className="text-xs text-slate-400 mt-1">
              Cr√©e ton compte, re√ßois des cr√©dits de bienvenue et commence √† g√©n√©rer tes candidatures.
              Tu devras d&apos;abord{" "}
              <span className="font-semibold text-slate-100">valider ton adresse email</span>.
            </p>
          </div>

          {info && (
            <p className="mb-2 text-xs text-emerald-100 bg-emerald-500/10 border border-emerald-500/40 rounded-md px-3 py-2">
              {info}
            </p>
          )}
          {error && (
            <p className="mb-2 text-xs text-rose-100 bg-rose-500/10 border border-rose-500/40 rounded-md px-3 py-2">
              {error}
            </p>
          )}

          <form onSubmit={handleSubmit} className="space-y-3 text-sm">
            <div className="grid grid-cols-2 gap-2">
              <div>
                <label className="block mb-1 text-xs text-slate-300" htmlFor="firstName">
                  Pr√©nom
                </label>
                <input
                  id="firstName"
                  type="text"
                  className="w-full rounded-lg bg-slate-900/80 border border-slate-700 px-3 py-2 text-xs text-slate-100 placeholder:text-slate-500 outline-none focus:ring-1 focus:ring-sky-500 focus:border-sky-500"
                  value={firstName}
                  onChange={(e) => setFirstName(e.target.value)}
                  required
                  placeholder="Jean"
                />
              </div>
              <div>
                <label className="block mb-1 text-xs text-slate-300" htmlFor="lastName">
                  Nom
                </label>
                <input
                  id="lastName"
                  type="text"
                  className="w-full rounded-lg bg-slate-900/80 border border-slate-700 px-3 py-2 text-xs text-slate-100 placeholder:text-slate-500 outline-none focus:ring-1 focus:ring-sky-500 focus:border-sky-500"
                  value={lastName}
                  onChange={(e) => setLastName(e.target.value)}
                  required
                  placeholder="Dupont"
                />
              </div>
            </div>

            <div>
              <label className="block mb-1 text-xs text-slate-300" htmlFor="email">
                Adresse email
              </label>
              <input
                id="email"
                type="email"
                autoComplete="email"
                className="w-full rounded-lg bg-slate-900/80 border border-slate-700 px-3 py-2 text-xs text-slate-100 placeholder:text-slate-500 outline-none focus:ring-1 focus:ring-sky-500 focus:border-sky-500"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                required
                placeholder="toi@example.com"
              />
            </div>

            <div>
              <label className="block mb-1 text-xs text-slate-300" htmlFor="password">
                Mot de passe
              </label>
              <div className="relative">
                <input
                  id="password"
                  type={showPwd ? "text" : "password"}
                  autoComplete="new-password"
                  className={`w-full rounded-lg bg-slate-900/80 border px-3 py-2 text-xs text-slate-100 placeholder:text-slate-500 outline-none focus:ring-1 focus:ring-sky-500 focus:border-sky-500 pr-16 transition-colors ${
                    password && !pwdRules.ok ? "border-rose-500/70" : "border-slate-700"
                  }`}
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  required
                  placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                />
                <button
                  type="button"
                  className="absolute inset-y-0 right-2 text-[11px] text-slate-400 hover:text-slate-200 flex items-center"
                  onClick={() => setShowPwd((v) => !v)}
                >
                  {showPwd ? "Masquer" : "Afficher"}
                </button>
              </div>

              <ul className="mt-2 text-[10px] space-y-0.5">
                <li className={`flex items-center gap-1 ${pwdRules.min ? "text-emerald-400" : "text-rose-400"}`}>
                  <span className="text-[12px]">{pwdRules.min ? "‚úî" : "‚Ä¢"}</span>
                  <span>Minimum 8 caract√®res</span>
                </li>
                <li className={`flex items-center gap-1 ${pwdRules.upper ? "text-emerald-400" : "text-rose-400"}`}>
                  <span className="text-[12px]">{pwdRules.upper ? "‚úî" : "‚Ä¢"}</span>
                  <span>Au moins une majuscule (A-Z)</span>
                </li>
                <li className={`flex items-center gap-1 ${pwdRules.digit ? "text-emerald-400" : "text-rose-400"}`}>
                  <span className="text-[12px]">{pwdRules.digit ? "‚úî" : "‚Ä¢"}</span>
                  <span>Au moins un chiffre (0-9)</span>
                </li>
                <li
                  className={`flex items-center gap-1 ${
                    pwdRules.special ? "text-emerald-400" : "text-rose-400"
                  }`}
                >
                  <span className="text-[12px]">{pwdRules.special ? "‚úî" : "‚Ä¢"}</span>
                  <span>Au moins un caract√®re sp√©cial (!, @, #, ...)</span>
                </li>
              </ul>
            </div>

            <button
              type="submit"
              disabled={loading}
              className="w-full inline-flex items-center justify-center rounded-lg bg-sky-500 hover:bg-sky-600 disabled:opacity-60 disabled:cursor-not-allowed text-xs font-medium text-white px-3 py-2 mt-1 transition-colors"
            >
              {loading ? "Inscription..." : "S'inscrire"}
            </button>
          </form>

          <div className="flex items-center gap-2 my-4">
            <div className="h-px flex-1 bg-slate-800" />
            <span className="text-[10px] text-slate-500 uppercase tracking-[0.16em]">ou</span>
            <div className="h-px flex-1 bg-slate-800" />
          </div>

          <button
            onClick={handleGoogleSignup}
            disabled={loading}
            className="w-full inline-flex items-center justify-center rounded-lg bg-slate-900/80 border border-slate-700 hover:border-sky-500 text-xs font-medium text-slate-100 px-3 py-2.5 transition-colors"
          >
            Continuer avec <span className="font-semibold ml-1">Google</span>
          </button>

          <p className="mt-4 text-[11px] text-center text-slate-400">
            <span>D√©j√† un compte ? </span>
            <Link href="/login" className="text-sky-400 hover:text-sky-300 font-semibold underline">
              Se connecter
            </Link>
          </p>
        </div>
      </main>
    </div>
  );
}

export default function SignupPage() {
  return (
    <Suspense
      fallback={
        <div className="min-h-screen flex items-center justify-center text-sm text-slate-400">
          Chargement de la page d‚Äôinscription...
        </div>
      }
    >
      <SignupPageInner />
    </Suspense>
  );
}
````

## File: app/tech/page.tsx
````typescript
"use client";

export default function TechPage() {
  return (
    <div className="min-h-screen px-4 sm:px-8 py-8">
      <div className="max-w-4xl mx-auto glass p-6">
        <h1 className="text-xl font-semibold mb-3">Technologies utilis√©es</h1>
        <p className="text-sm text-[var(--muted)] mb-4">
          Bien que le site lui-m√™me ne liste pas explicitement les technologies de son frontend
          dans le contenu visible, l'analyse du code source et des pratiques courantes pour ce
          type de plateforme moderne sugg√®re fortement l'utilisation de la pile suivante :
        </p>
        <ul className="list-disc pl-5 space-y-2 text-sm">
          <li>
            <span className="font-semibold">Frontend ‚Äî React / Next.js :</span>{" "}
            Framework JavaScript moderne pour construire l&apos;interface utilisateur,
            avec un routage optimis√© et un rendu performant.
          </li>
          <li>
            <span className="font-semibold">Styling ‚Äî Tailwind CSS :</span>{" "}
            Framework CSS utilitaire permettant de construire rapidement des designs
            r√©actifs et coh√©rents.
          </li>
          <li>
            <span className="font-semibold">Animations ‚Äî Framer Motion :</span>{" "}
            Biblioth√®que React d√©di√©e aux animations fluides, transitions interactives
            et gestes avanc√©s.
          </li>
        </ul>
        <p className="text-sm text-[var(--muted)] mt-4">
          Le style sombre, les cartes en verre (glassmorphism) et les transitions rapides
          sont caract√©ristiques d&apos;une approche bas√©e sur Next.js coupl√© √† Tailwind CSS
          et Framer Motion pour les effets au scroll et √† l&apos;interaction.
        </p>
      </div>
    </div>
  );
}
````

## File: app/globals.css
````css
@tailwind base;
@tailwind components;
@tailwind utilities;

/* =========================
   Th√®me global
   ========================= */
:root {
  --bg: #020617;              /* fond g√©n√©ral */
  --bg-soft: #020617;         /* blocs soft */
  --card-elevated: #020617;   /* cartes en relief */
  --ink: #f9fafb;             /* texte principal */
  --muted: #9ca3af;           /* texte secondaire */
  --brand: #60a5fa;           /* bleu principal */
  --brandDark: #1d4ed8;       /* bleu plus fonc√© */
  --border: #1f2933;          /* gris pour les bordures */
}

html,
body {
  padding: 0;
  margin: 0;
  min-height: 100%;
}

body {
  background:
    radial-gradient(circle at top, #020617 0, #020617 40%, #000 100%);
  color: var(--ink);
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Inter",
    sans-serif;
}

/* Pour que les sections soient bien fluides sur mobile */
body {
  overscroll-behavior-y: none;
}

/* =========================
   Scrollbar globale (droite)
   ========================= */

/* Firefox */
* {
  scrollbar-width: thin;
  scrollbar-color: var(--brand) transparent;
}

/* Chrome / Edge / Safari */
*::-webkit-scrollbar {
  width: 8px;
}

*::-webkit-scrollbar-track {
  background: transparent;
}

*::-webkit-scrollbar-thumb {
  background-image: linear-gradient(
    to bottom,
    var(--brand),
    var(--brandDark)
  );
  border-radius: 9999px;
}

/* Barre de progression en haut */
.scroll-progress-bar {
  border-radius: 9999px;
}

/* =========================
   Utilitaires UI
   ========================= */

.glass {
  background: radial-gradient(circle at top left, rgba(148, 163, 184, 0.16), transparent 55%),
    rgba(15, 23, 42, 0.92);
  backdrop-filter: blur(18px);
}

/* Bouton primaire */
.btn-primary {
  @apply inline-flex items-center justify-center px-4 py-2 rounded-full text-xs sm:text-sm font-medium;
  background-image: linear-gradient(to right, var(--brand), var(--brandDark));
  color: white;
  box-shadow: 0 10px 30px rgba(37, 99, 235, 0.4);
  transition: transform 0.12s ease-out, box-shadow 0.12s ease-out,
    filter 0.12s ease-out;
}

.btn-primary:hover {
  transform: translateY(-1px);
  box-shadow: 0 14px 32px rgba(37, 99, 235, 0.6);
  filter: brightness(1.05);
}

.btn-primary:active {
  transform: translateY(0);
  box-shadow: 0 8px 20px rgba(37, 99, 235, 0.4);
}

/* Bouton secondaire */
.btn-secondary {
  @apply inline-flex items-center justify-center px-4 py-2 rounded-full text-xs sm:text-sm font-medium border;
  border-color: rgba(148, 163, 184, 0.5);
  background: rgba(15, 23, 42, 0.8);
  color: var(--ink);
  transition: background-color 0.12s ease-out, border-color 0.12s ease-out,
    color 0.12s ease-out;
}

.btn-secondary:hover {
  border-color: var(--brand);
  color: white;
}

/* Petites helpers pour cartes etc. */
.card-border {
  border: 1px solid rgba(148, 163, 184, 0.35);
  border-radius: 0.75rem;
}

/* Lien hover subtil */
.link-soft {
  color: var(--muted);
  transition: color 0.12s ease-out;
}

.link-soft:hover {
  color: var(--ink);
}

/* Pour √©viter un flash de scroll bar trop claire au load */
::-webkit-scrollbar-corner {
  background: transparent;
}

/* Scrollbar verticale (container principal) */
main::-webkit-scrollbar {
  width: 6px;
}

main::-webkit-scrollbar-track {
  background: transparent;
}

main::-webkit-scrollbar-thumb {
  background: var(--brand);
  border-radius: 999px;
}

main {
  scrollbar-width: thin;               /* Firefox */
  scrollbar-color: var(--brand) transparent;
}

/* =========================
   FORM CONTROLS (inputs / selects / textareas)
   ========================= */

/* Champs de base */
.input,
textarea.input,
textarea.textarea,
select.select-brand {
  width: 100%;
  border-radius: 0.75rem;
  border: 1px solid var(--border);
  background-color: var(--bg-soft);
  color: var(--ink);
  font-size: 0.875rem;
  padding: 0.45rem 0.7rem;
  outline: none;
  transition: border-color 0.15s ease, box-shadow 0.15s ease,
    background-color 0.15s ease, color 0.15s ease;
}

/* Placeholders visibles */
.input::placeholder,
textarea.input::placeholder,
textarea.textarea::placeholder {
  color: var(--muted);
  opacity: 1;
}

/* Focus state */
.input:focus,
textarea.input:focus,
textarea.textarea:focus,
select.select-brand:focus {
  border-color: var(--brand);
  box-shadow: 0 0 0 1px color-mix(in srgb, var(--brand) 60%, transparent);
  background-color: #020617;
}

/* Textarea : redimension verticale seulement */
textarea.input,
textarea.textarea {
  resize: vertical;
  min-height: 3rem;
}

/* Select sur fond un peu diff√©rent */
select.select-brand {
  background-color: rgba(15, 23, 42, 0.9);
  padding-right: 2rem;
  appearance: none;
}

/* =========================
   BADGES / CARTES / TOGGLE
   ========================= */

.badge-muted {
  display: inline-flex;
  align-items: center;
  border-radius: 9999px;
  padding: 0.15rem 0.6rem;
  font-size: 0.7rem;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  background-color: rgba(15, 23, 42, 0.9);
  border: 1px solid rgba(148, 163, 184, 0.5);
  color: var(--muted);
}

/* Carte soft (used for LM / Pitch preview) */
.card-soft {
  background: rgba(15, 23, 42, 0.92);
}

/* Simple toggle checkbox (si tu ne l‚Äôas pas d√©j√†) */
.toggle-checkbox {
  width: 1rem;
  height: 1rem;
  border-radius: 0.3rem;
  border: 1px solid var(--border);
  background-color: #020617;
  accent-color: var(--brand);
}

/* =========================
   LOADER SPINNER
   ========================= */

.loader {
  border-radius: 9999px;
  border: 2px solid var(--border);
  border-top-color: var(--brand);
  width: 1.1rem;
  height: 1.1rem;
  animation: spin-loader 0.7s linear infinite;
}

@keyframes spin-loader {
  to {
    transform: rotate(360deg);
  }
}

/* =========================
   BANDEAU "L‚ÄôIA pr√©pare tes documents‚Ä¶"
   (optionnel, mais utile si tu utilises une classe d√©di√©e)
   ========================= */

.assistant-loading-bar {
  border-radius: 9999px;
  backdrop-filter: blur(10px);
}
/* app/globals.css */

/* Assure toi que html / body remplissent bien la hauteur */
html,
body {
  height: 100%;
}

body {
  min-height: 100%;
  /* √©vite les comportements bizarres de scroll sur mobile */
  overscroll-behavior-y: contain;
  -webkit-tap-highlight-color: transparent;
}

/* Emp√™che tout d√©bordement horizontal global */
html,
body {
  overflow-x: hidden;
}

/* Si tu utilises #__next (pages router) : garde √ßa, sinon tu peux l'ignorer */
#__next {
  min-height: 100%;
}

/* Tu peux garder ici toutes tes classes custom :
   .glass, .btn-primary, .badge-muted, etc. */
.grecaptcha-badge {
  visibility: hidden; /* ou display:none; mais visibility est plus ‚Äúsoft‚Äù */
}
````

## File: app/not-found.tsx
````typescript
"use client";

import Link from "next/link";
import { useAuth } from "@/context/AuthContext";

export default function NotFound() {
  const { user } = useAuth();

  return (
    <div className="min-h-screen flex flex-col items-center justify-center bg-[var(--bg)] text-[var(--ink)] px-4">
      <div className="glass max-w-md w-full p-6 border border-[var(--border)]/80 text-center">
        <h1 className="text-xl font-semibold mb-2">Page introuvable</h1>
        <p className="text-sm text-[var(--muted)] mb-4">
          Le lien que tu as suivi est invalide ou cette page n&apos;existe pas.
        </p>
        <div className="flex flex-wrap gap-3 justify-center">
          <Link href="/" className="btn-secondary text-xs sm:text-sm">
            Retour √† l&apos;accueil
          </Link>
          {user && (
            <Link href="/app" className="btn-primary text-xs sm:text-sm">
              Aller au dashboard
            </Link>
          )}
        </div>
      </div>
    </div>
  );
}
````

## File: components/assistant/CvPdfEditorModal.tsx
````typescript
"use client";

import { useEffect, useMemo, useRef, useState } from "react";
import { motion, AnimatePresence } from "framer-motion";
import type { CvDocModel } from "@/lib/pdf/templates/cvAts";
import { downloadBlob } from "@/lib/pdf/pdfmakeClient";

type SectionKey = "profile" | "skills" | "xp" | "education" | "certs" | "languages" | "hobbies";

type CvDocModelExt = CvDocModel & {
  __meta?: {
    hide?: Partial<Record<SectionKey, boolean>>;
  };
};

function safeText(v: any) {
  return String(v ?? "").replace(/\u00A0/g, " ").trim();
}

function Modal({
  open,
  title,
  onClose,
  children,
}: {
  open: boolean;
  title: string;
  onClose: () => void;
  children: React.ReactNode;
}) {
  return (
    <AnimatePresence>
      {open && (
        <motion.div
          className="fixed inset-0 z-[90] flex items-center justify-center px-2 sm:px-4"
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          exit={{ opacity: 0 }}
        >
          <div className="absolute inset-0 bg-black/55" onClick={onClose} />
          <motion.div
            className="relative w-full max-w-6xl h-[92vh] rounded-2xl border border-[var(--border)] bg-[var(--bg)] shadow-xl overflow-hidden"
            initial={{ y: 14, opacity: 0, scale: 0.99 }}
            animate={{ y: 0, opacity: 1, scale: 1 }}
            exit={{ y: 10, opacity: 0, scale: 0.99 }}
            transition={{ duration: 0.18 }}
          >
            <div className="flex items-center justify-between gap-3 border-b border-[var(--border)] px-4 py-3">
              <div>
                <p className="text-[12px] text-[var(--muted)]">√âditeur CV</p>
                <h3 className="text-[14px] font-semibold text-[var(--ink)]">{title}</h3>
              </div>
              <button className="btn-secondary" type="button" onClick={onClose}>
                Fermer
              </button>
            </div>

            <div className="h-[calc(92vh-56px)] grid grid-cols-1 lg:grid-cols-[420px_1fr]">
              {children}
            </div>
          </motion.div>
        </motion.div>
      )}
    </AnimatePresence>
  );
}

export default function CvPdfEditorModal({
  open,
  onClose,
  initialModel,
  title,
  fileName = "cv-ia.pdf",
  templateLabel,
  renderPdf,
  onSaveModel,
}: {
  open: boolean;
  onClose: () => void;
  initialModel: CvDocModel;
  title: string;
  fileName?: string;
  templateLabel?: string;
  renderPdf: (model: CvDocModel) => Promise<{ blob: Blob; bestScale: number }>;
  onSaveModel?: (model: CvDocModel) => void;
}) {
  const [model, setModel] = useState<CvDocModelExt>(initialModel as CvDocModelExt);

  const [busy, setBusy] = useState(false);
  const [err, setErr] = useState<string | null>(null);

  const [blob, setBlob] = useState<Blob | null>(null);
  const [bestScale, setBestScale] = useState<number | null>(null);

  const [blobUrl, setBlobUrl] = useState<string>("");

  const debounceRef = useRef<any>(null);

  // reset when open/initial changes
  useEffect(() => {
    if (!open) return;
    setModel(initialModel as CvDocModelExt);
  }, [open, initialModel]);

  // revoke old url
  useEffect(() => {
    return () => {
      if (blobUrl) URL.revokeObjectURL(blobUrl);
    };
  }, [blobUrl]);

  const hide = model.__meta?.hide || {};

  const setHide = (k: SectionKey, v: boolean) => {
    setModel((m) => ({
      ...m,
      __meta: { ...(m.__meta || {}), hide: { ...(m.__meta?.hide || {}), [k]: v } },
    }));
  };

  const regenerate = async (m: CvDocModel) => {
    setErr(null);
    setBusy(true);
    try {
      const out = await renderPdf(m);
      setBlob(out.blob);
      setBestScale(out.bestScale);
      const url = URL.createObjectURL(out.blob);
      setBlobUrl((prev) => {
        if (prev) URL.revokeObjectURL(prev);
        return url;
      });
    } catch (e: any) {
      setErr(e?.message || "Erreur g√©n√©ration PDF (preview).");
    } finally {
      setBusy(false);
    }
  };

  // ‚úÖ debounce regen on model change (while open)
  useEffect(() => {
    if (!open) return;
    if (debounceRef.current) clearTimeout(debounceRef.current);
    debounceRef.current = setTimeout(() => {
      regenerate(model);
    }, 350);
    return () => clearTimeout(debounceRef.current);
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [open, JSON.stringify(model)]);

  // first render when open
  useEffect(() => {
    if (!open) return;
    regenerate(model);
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [open]);

  const allSkills = useMemo(() => {
    const s: any = (model as any).skills || {};
    const pack = (k: string) => (Array.isArray(s[k]) ? s[k] : []);
    return {
      cloud: pack("cloud"),
      sec: pack("sec"),
      sys: pack("sys"),
      auto: pack("auto"),
      tools: pack("tools"),
      soft: pack("soft"),
    };
  }, [model]);

  const updateSkills = (key: keyof typeof allSkills, next: string[]) => {
    setModel((m: any) => ({
      ...m,
      skills: { ...(m.skills || {}), [key]: next },
    }));
  };

  const removeSkill = (key: keyof typeof allSkills, idx: number) => {
    const arr = [...(allSkills[key] || [])];
    arr.splice(idx, 1);
    updateSkills(key, arr);
  };

  const [skillDraft, setSkillDraft] = useState("");
  const [skillBucket, setSkillBucket] = useState<keyof typeof allSkills>("tools");

  useEffect(() => {
    if (!open) return;
    setSkillDraft("");
    setSkillBucket("tools");
  }, [open]);

  const addSkill = () => {
    const s = safeText(skillDraft);
    if (!s) return;
    const arr = [...(allSkills[skillBucket] || [])];
    arr.push(s);
    updateSkills(skillBucket, arr);
    setSkillDraft("");
  };

  const xp = Array.isArray((model as any).xp) ? ((model as any).xp as any[]) : [];
  const updateXp = (next: any[]) => setModel((m: any) => ({ ...m, xp: next }));

  const edu = Array.isArray((model as any).education) ? ((model as any).education as string[]) : [];
  const updateEdu = (next: string[]) => setModel((m: any) => ({ ...m, education: next }));

  return (
    <Modal
      open={open}
      onClose={onClose}
      title={title}
    >
      {/* LEFT: controls */}
      <div className="border-r border-[var(--border)] bg-[var(--bg-soft)] overflow-auto">
        <div className="p-4 space-y-3">
          <div className="rounded-xl border border-[var(--border)] bg-[var(--bg)] p-3">
            <div className="flex items-start justify-between gap-3">
              <div>
                <p className="text-[11px] text-[var(--muted)]">Template</p>
                <p className="text-[13px] font-semibold text-[var(--ink)]">{templateLabel || "CV"}</p>
                {bestScale != null && (
                  <p className="text-[11px] text-[var(--muted)] mt-1">Scale: {bestScale.toFixed(2)} (fit 1 page)</p>
                )}
              </div>

              <div className="flex flex-col gap-2">
                <button
                  type="button"
                  className="btn-primary"
                  disabled={!blob || busy}
                  onClick={() => blob && downloadBlob(blob, fileName)}
                >
                  {busy ? "G√©n√©ration‚Ä¶" : "T√©l√©charger"}
                </button>

                <button
                  type="button"
                  className="btn-secondary"
                  onClick={() => onSaveModel?.(model as CvDocModel)}
                >
                  Enregistrer
                </button>

                <button
                  type="button"
                  className="btn-secondary"
                  onClick={() => setModel(initialModel as CvDocModelExt)}
                >
                  R√©initialiser
                </button>
              </div>
            </div>

            {err && <p className="mt-2 text-[11px] text-red-400">{err}</p>}
          </div>

          {/* Hide toggles */}
          <div className="rounded-xl border border-[var(--border)] bg-[var(--bg)] p-3">
            <p className="text-[12px] font-semibold text-[var(--ink)] mb-2">Masquer des sections</p>
            <div className="grid grid-cols-2 gap-2 text-[12px]">
              {(
                [
                  ["profile", "Profil"],
                  ["skills", "Comp√©tences"],
                  ["education", "Formation"],
                  ["xp", "Exp√©rience"],
                  ["languages", "Langues"],
                  ["certs", "Certifs"],
                  ["hobbies", "Hobbies"],
                ] as Array<[SectionKey, string]>
              ).map(([k, label]) => (
                <label key={k} className="flex items-center gap-2 cursor-pointer">
                  <input
                    type="checkbox"
                    checked={!!hide[k]}
                    onChange={(e) => setHide(k, e.target.checked)}
                  />
                  <span className="text-[var(--muted)]">{label}</span>
                </label>
              ))}
            </div>
          </div>

          {/* General */}
          <div className="rounded-xl border border-[var(--border)] bg-[var(--bg)] p-3 space-y-2">
            <p className="text-[12px] font-semibold text-[var(--ink)]">Infos</p>
            <div>
              <label className="block text-[11px] text-[var(--muted)] mb-1">Nom</label>
              <input
                className="input w-full bg-[var(--bg)]"
                value={safeText((model as any).name)}
                onChange={(e) => setModel((m: any) => ({ ...m, name: e.target.value }))}
              />
            </div>
            <div>
              <label className="block text-[11px] text-[var(--muted)] mb-1">Titre</label>
              <input
                className="input w-full bg-[var(--bg)]"
                value={safeText((model as any).title)}
                onChange={(e) => setModel((m: any) => ({ ...m, title: e.target.value }))}
              />
            </div>
            <div>
              <label className="block text-[11px] text-[var(--muted)] mb-1">Ligne contact</label>
              <input
                className="input w-full bg-[var(--bg)]"
                value={safeText((model as any).contactLine)}
                onChange={(e) => setModel((m: any) => ({ ...m, contactLine: e.target.value }))}
              />
            </div>
          </div>

          {/* Profile */}
          <div className="rounded-xl border border-[var(--border)] bg-[var(--bg)] p-3 space-y-2">
            <p className="text-[12px] font-semibold text-[var(--ink)]">Profil</p>
            <textarea
              className="input textarea w-full bg-[var(--bg)] text-[13px]"
              rows={4}
              value={safeText((model as any).profile)}
              onChange={(e) => setModel((m: any) => ({ ...m, profile: e.target.value }))}
            />
          </div>

          {/* Skills */}
          <div className="rounded-xl border border-[var(--border)] bg-[var(--bg)] p-3 space-y-3">
            <div className="flex items-center justify-between">
              <p className="text-[12px] font-semibold text-[var(--ink)]">Comp√©tences</p>
              <div className="flex items-center gap-2">
                <select
                  className="select-brand bg-[var(--bg-soft)] text-[12px]"
                  value={skillBucket}
                  onChange={(e) => setSkillBucket(e.target.value as any)}
                >
                  <option value="tools">Tools</option>
                  <option value="cloud">Cloud</option>
                  <option value="sec">S√©curit√©</option>
                  <option value="sys">Syst√®mes</option>
                  <option value="auto">Auto/DevOps</option>
                  <option value="soft">Soft</option>
                </select>
              </div>
            </div>

            <div className="flex gap-2">
              <input
                className="input flex-1 bg-[var(--bg)]"
                placeholder="Ajouter une comp√©tence‚Ä¶"
                value={skillDraft}
                onChange={(e) => setSkillDraft(e.target.value)}
                onKeyDown={(e) => {
                  if (e.key === "Enter") {
                    e.preventDefault();
                    addSkill();
                  }
                }}
              />
              <button type="button" className="btn-secondary" onClick={addSkill}>
                Ajouter
              </button>
            </div>

            {(
              [
                ["cloud", "Cloud"],
                ["sec", "S√©curit√©"],
                ["sys", "Syst√®mes"],
                ["auto", "Auto/DevOps"],
                ["tools", "Tools"],
                ["soft", "Soft"],
              ] as Array<[keyof typeof allSkills, string]>
            ).map(([k, label]) => (
              <div key={k}>
                <p className="text-[11px] text-[var(--muted)] mb-2">{label}</p>
                <div className="flex flex-wrap gap-2">
                  {(allSkills[k] || []).map((it, idx) => (
                    <button
                      type="button"
                      key={`${k}-${idx}`}
                      className="text-[11px] px-2 py-[2px] rounded-full border border-[var(--border)] bg-[var(--bg-soft)] hover:border-red-400 hover:text-red-400 transition"
                      title="Cliquer pour supprimer"
                      onClick={() => removeSkill(k, idx)}
                    >
                      {it} <span className="ml-1">√ó</span>
                    </button>
                  ))}
                  {!allSkills[k]?.length && (
                    <span className="text-[11px] text-[var(--muted)]">‚Äî</span>
                  )}
                </div>
              </div>
            ))}
          </div>

          {/* Experience */}
          <div className="rounded-xl border border-[var(--border)] bg-[var(--bg)] p-3 space-y-3">
            <div className="flex items-center justify-between">
              <p className="text-[12px] font-semibold text-[var(--ink)]">Exp√©riences</p>
              <button
                type="button"
                className="btn-secondary"
                onClick={() =>
                  updateXp([
                    ...xp,
                    { role: "Poste", company: "Entreprise", dates: "2023‚Äì2025", city: "", bullets: ["Impact / r√©sultat chiffr√©"] },
                  ])
                }
              >
                + Ajouter
              </button>
            </div>

            <div className="space-y-3">
              {xp.map((x, i) => (
                <div key={i} className="rounded-xl border border-[var(--border)] bg-[var(--bg-soft)] p-3">
                  <div className="flex items-start justify-between gap-2">
                    <p className="text-[12px] font-semibold text-[var(--ink)]">EXP #{i + 1}</p>
                    <button
                      type="button"
                      className="text-[12px] text-red-400 hover:underline"
                      onClick={() => {
                        const next = [...xp];
                        next.splice(i, 1);
                        updateXp(next);
                      }}
                    >
                      Supprimer
                    </button>
                  </div>

                  <div className="grid grid-cols-2 gap-2 mt-2">
                    <div>
                      <label className="block text-[11px] text-[var(--muted)] mb-1">Poste</label>
                      <input
                        className="input w-full bg-[var(--bg)]"
                        value={safeText(x.role)}
                        onChange={(e) => {
                          const next = [...xp];
                          next[i] = { ...next[i], role: e.target.value };
                          updateXp(next);
                        }}
                      />
                    </div>
                    <div>
                      <label className="block text-[11px] text-[var(--muted)] mb-1">Entreprise</label>
                      <input
                        className="input w-full bg-[var(--bg)]"
                        value={safeText(x.company)}
                        onChange={(e) => {
                          const next = [...xp];
                          next[i] = { ...next[i], company: e.target.value };
                          updateXp(next);
                        }}
                      />
                    </div>
                    <div>
                      <label className="block text-[11px] text-[var(--muted)] mb-1">Dates</label>
                      <input
                        className="input w-full bg-[var(--bg)]"
                        value={safeText(x.dates)}
                        onChange={(e) => {
                          const next = [...xp];
                          next[i] = { ...next[i], dates: e.target.value };
                          updateXp(next);
                        }}
                      />
                    </div>
                    <div>
                      <label className="block text-[11px] text-[var(--muted)] mb-1">Ville</label>
                      <input
                        className="input w-full bg-[var(--bg)]"
                        value={safeText(x.city)}
                        onChange={(e) => {
                          const next = [...xp];
                          next[i] = { ...next[i], city: e.target.value };
                          updateXp(next);
                        }}
                      />
                    </div>
                  </div>

                  <div className="mt-2">
                    <label className="block text-[11px] text-[var(--muted)] mb-1">
                      Bullets (1 ligne = 1 bullet)
                    </label>
                    <textarea
                      className="input textarea w-full bg-[var(--bg)] text-[13px]"
                      rows={4}
                      value={Array.isArray(x.bullets) ? x.bullets.join("\n") : ""}
                      onChange={(e) => {
                        const next = [...xp];
                        next[i] = {
                          ...next[i],
                          bullets: e.target.value
                            .split("\n")
                            .map((l) => l.trim())
                            .filter(Boolean),
                        };
                        updateXp(next);
                      }}
                    />

                    <div className="flex gap-2 mt-2">
                      <button
                        type="button"
                        className="btn-secondary"
                        onClick={() => {
                          const next = [...xp];
                          const bullets = Array.isArray(next[i].bullets) ? [...next[i].bullets] : [];
                          bullets.push("Exemple : Automatisation / optimisation ‚Üí -30% temps de traitement");
                          next[i] = { ...next[i], bullets };
                          updateXp(next);
                        }}
                      >
                        + Exemple
                      </button>

                      <button
                        type="button"
                        className="btn-secondary"
                        onClick={() => {
                          const next = [...xp];
                          const bullets = Array.isArray(next[i].bullets) ? [...next[i].bullets] : [];
                          // nettoyage simple : unique + trim
                          const seen = new Set<string>();
                          const clean = bullets
                            .map((b) => b.trim())
                            .filter(Boolean)
                            .filter((b) => {
                              const k = b.toLowerCase();
                              if (seen.has(k)) return false;
                              seen.add(k);
                              return true;
                            });
                          next[i] = { ...next[i], bullets: clean };
                          updateXp(next);
                        }}
                      >
                        Nettoyer
                      </button>
                    </div>
                  </div>
                </div>
              ))}
              {!xp.length && <p className="text-[11px] text-[var(--muted)]">Aucune exp√©rience.</p>}
            </div>
          </div>

          {/* Education */}
          <div className="rounded-xl border border-[var(--border)] bg-[var(--bg)] p-3 space-y-3">
            <div className="flex items-center justify-between">
              <p className="text-[12px] font-semibold text-[var(--ink)]">Formation</p>
              <button
                type="button"
                className="btn-secondary"
                onClick={() => updateEdu([...edu, "Dipl√¥me ‚Äî √âcole ‚Äî 2022 ‚Äî Paris"])}
              >
                + Ajouter
              </button>
            </div>

            <div className="space-y-2">
              {edu.map((line, i) => (
                <div key={i} className="flex gap-2">
                  <input
                    className="input flex-1 bg-[var(--bg)]"
                    value={safeText(line)}
                    onChange={(e) => {
                      const next = [...edu];
                      next[i] = e.target.value;
                      updateEdu(next);
                    }}
                  />
                  <button
                    type="button"
                    className="btn-secondary"
                    onClick={() => {
                      const next = [...edu];
                      next.splice(i, 1);
                      updateEdu(next);
                    }}
                  >
                    √ó
                  </button>
                </div>
              ))}
              {!edu.length && <p className="text-[11px] text-[var(--muted)]">Aucune formation.</p>}
            </div>
          </div>

          {/* Lang / certs / hobbies */}
          <div className="rounded-xl border border-[var(--border)] bg-[var(--bg)] p-3 space-y-2">
            <p className="text-[12px] font-semibold text-[var(--ink)]">Langues / Certifs / Hobbies</p>

            <div>
              <label className="block text-[11px] text-[var(--muted)] mb-1">Langues (ligne)</label>
              <input
                className="input w-full bg-[var(--bg)]"
                value={safeText((model as any).langLine)}
                onChange={(e) => setModel((m: any) => ({ ...m, langLine: e.target.value }))}
              />
            </div>

            <div>
              <label className="block text-[11px] text-[var(--muted)] mb-1">Certifications</label>
              <textarea
                className="input textarea w-full bg-[var(--bg)] text-[13px]"
                rows={2}
                value={safeText((model as any).certs)}
                onChange={(e) => setModel((m: any) => ({ ...m, certs: e.target.value }))}
              />
            </div>

            <div>
              <label className="block text-[11px] text-[var(--muted)] mb-1">Hobbies (s√©par√©s par virgule)</label>
              <input
                className="input w-full bg-[var(--bg)]"
                value={Array.isArray((model as any).hobbies) ? (model as any).hobbies.join(", ") : ""}
                onChange={(e) =>
                  setModel((m: any) => ({
                    ...m,
                    hobbies: e.target.value
                      .split(",")
                      .map((x) => x.trim())
                      .filter(Boolean),
                  }))
                }
              />
            </div>
          </div>

          <p className="px-1 pb-3 text-[10px] text-[var(--muted)]">
            üí° Tout ce que tu modifies ici r√©g√©n√®re le PDF : tu ‚Äú√©dites‚Äù ton CV directement depuis ton site.
          </p>
        </div>
      </div>

      {/* RIGHT: preview */}
      <div className="bg-[var(--bg)] overflow-hidden">
        <div className="h-full w-full relative">
          {busy && (
            <div className="absolute inset-0 z-10 bg-white/40 backdrop-blur-[2px] flex items-center justify-center">
              <div className="rounded-full bg-[var(--bg)] border border-[var(--border)] px-3 py-2 text-[11px] text-[var(--muted)] flex items-center gap-2">
                <span className="inline-flex w-3 h-3 rounded-full border-2 border-[var(--brand)] border-t-transparent animate-spin" />
                <span>R√©g√©n√©ration PDF‚Ä¶</span>
              </div>
            </div>
          )}

          {blobUrl ? (
            <iframe title="cv-preview" src={blobUrl} className="w-full h-full" />
          ) : (
            <div className="h-full flex items-center justify-center text-[11px] text-[var(--muted)]">
              Preview PDF‚Ä¶
            </div>
          )}
        </div>
      </div>
    </Modal>
  );
}
````

## File: components/assistant/CvTemplatePicker.tsx
````typescript
"use client";

import { useMemo, useState } from "react";
import { motion, AnimatePresence } from "framer-motion";
import type { CvTemplateId, CvTemplateMeta } from "@/lib/pdf/templates/cvTemplates";

type Props = {
  templates: CvTemplateMeta[];
  value: CvTemplateId;
  onChange: (id: CvTemplateId) => void;
};

function Modal({
  open,
  title,
  onClose,
  children,
}: {
  open: boolean;
  title: string;
  onClose: () => void;
  children: React.ReactNode;
}) {
  return (
    <AnimatePresence>
      {open && (
        <motion.div
          className="fixed inset-0 z-[80] flex items-center justify-center px-3"
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          exit={{ opacity: 0 }}
        >
          <div className="absolute inset-0 bg-black/50" onClick={onClose} />
          <motion.div
            className="relative w-full max-w-4xl rounded-2xl border border-[var(--border)] bg-[var(--bg)] shadow-xl"
            initial={{ y: 14, opacity: 0, scale: 0.98 }}
            animate={{ y: 0, opacity: 1, scale: 1 }}
            exit={{ y: 10, opacity: 0, scale: 0.98 }}
            transition={{ duration: 0.18 }}
          >
            <div className="flex items-center justify-between gap-3 border-b border-[var(--border)] px-4 py-3">
              <div>
                <p className="text-[12px] text-[var(--muted)]">Choix du template</p>
                <h3 className="text-[14px] font-semibold text-[var(--ink)]">{title}</h3>
              </div>
              <button className="btn-secondary" type="button" onClick={onClose}>
                Fermer
              </button>
            </div>
            <div className="p-4">{children}</div>
          </motion.div>
        </motion.div>
      )}
    </AnimatePresence>
  );
}

function TemplateCard({
  t,
  active,
  onPick,
}: {
  t: CvTemplateMeta;
  active: boolean;
  onPick: () => void;
}) {
  return (
    <button
      type="button"
      onClick={onPick}
      className={`text-left rounded-xl border p-2 bg-[var(--bg-soft)] transition w-full
      ${active ? "border-[var(--brand)] ring-2 ring-[var(--brand)]/20" : "border-[var(--border)] hover:border-[var(--brand)]/50"}`}
    >
      <img
        src={t.previewSrc}
        alt={t.label}
        className="w-full h-[140px] object-cover rounded-lg border border-[var(--border)] bg-white"
      />
      <div className="mt-2">
        <p className="text-[12px] font-semibold text-[var(--ink)] flex items-center justify-between gap-2">
          <span>{t.label}</span>
          {active && (
            <span className="text-[10px] px-2 py-[2px] rounded-full bg-[var(--brand)]/10 text-[var(--brand)] border border-[var(--brand)]/20">
              S√©lectionn√©
            </span>
          )}
        </p>
        <p className="text-[10px] text-[var(--muted)]">{t.description}</p>
      </div>
    </button>
  );
}

export default function CvTemplatePicker({ templates, value, onChange }: Props) {
  const [open, setOpen] = useState(false);
  const [q, setQ] = useState("");

  const selected = templates.find((t) => t.id === value);

  // ‚úÖ 3 visibles : on force le template s√©lectionn√© + 2 autres
  const top3 = useMemo(() => {
    const others = templates.filter((t) => t.id !== value);
    return [selected, ...others.slice(0, 2)].filter(Boolean) as CvTemplateMeta[];
  }, [templates, value, selected]);

  const filtered = useMemo(() => {
    const s = q.trim().toLowerCase();
    if (!s) return templates;
    return templates.filter((t) => {
      const hay = `${t.label} ${t.description} ${t.id}`.toLowerCase();
      return hay.includes(s);
    });
  }, [templates, q]);

  return (
    <>
      <div className="grid grid-cols-2 sm:grid-cols-4 gap-3">
        {top3.map((t) => (
          <TemplateCard key={t.id} t={t} active={t.id === value} onPick={() => onChange(t.id)} />
        ))}

        {/* ‚úÖ "Voir plus" */}
        <button
          type="button"
          onClick={() => setOpen(true)}
          className="rounded-xl border border-[var(--border)] bg-[var(--bg-soft)] p-3 hover:border-[var(--brand)]/50 transition flex flex-col items-center justify-center gap-2"
        >
          <span className="w-9 h-9 rounded-xl bg-[var(--brand)]/10 text-[var(--brand)] flex items-center justify-center text-lg">
            +
          </span>
          <div className="text-center">
            <p className="text-[12px] font-semibold text-[var(--ink)]">Voir plus</p>
            <p className="text-[10px] text-[var(--muted)]">Tous les mod√®les</p>
          </div>
        </button>
      </div>

      <p className="mt-2 text-[10px] text-[var(--muted)]">
        Les images doivent √™tre dans <strong>/public/cv-templates/</strong> (ex:{" "}
        <span className="font-mono">/cv-templates/cv-template-modern.png</span>).
      </p>

      <Modal
        open={open}
        title="Tous les templates CV"
        onClose={() => setOpen(false)}
      >
        <div className="flex flex-col sm:flex-row gap-3 sm:items-center sm:justify-between mb-3">
          <input
            className="input w-full sm:max-w-sm bg-[var(--bg)]"
            placeholder="Rechercher un template‚Ä¶"
            value={q}
            onChange={(e) => setQ(e.target.value)}
          />
          {selected ? (
            <div className="text-[11px] text-[var(--muted)]">
              S√©lection actuelle : <span className="font-medium text-[var(--ink)]">{selected.label}</span>
            </div>
          ) : null}
        </div>

        <div className="grid grid-cols-2 sm:grid-cols-3 gap-3">
          {filtered.map((t) => (
            <TemplateCard
              key={t.id}
              t={t}
              active={t.id === value}
              onPick={() => {
                onChange(t.id);
                setOpen(false);
              }}
            />
          ))}
        </div>
      </Modal>
    </>
  );
}
````

## File: components/layout/AppLayout.tsx
````typescript
"use client";

import { ReactNode, useEffect, useState } from "react";
import Link from "next/link";
import { usePathname, useRouter } from "next/navigation";
import { useAuth } from "@/context/AuthContext";
import { db } from "@/lib/firebase";
import { doc, onSnapshot } from "firebase/firestore";

const navLinks = [
  { href: "/app", label: "Profil CV IA", icon: "üìÑ" },
  { href: "/app/lm", label: "Assistant candidature", icon: "‚ú®" },
  { href: "/app/tracker", label: "Suivi candidatures", icon: "üìä" },
  { href: "/app/interview", label: "Pr√©parer entretien", icon: "üé§" },
  { href: "/app/apply", label: "Postuler", icon: "üì®" },
  { href: "/app/history", label: "Historique IA", icon: "üïí" },
  { href: "/app/credits", label: "Cr√©dits", icon: "‚ö°" },
];

export default function UserAppLayout({ children }: { children: ReactNode }) {
  const { user, loading, logout } = useAuth();
  const router = useRouter();
  const pathname = usePathname();
  const [sidebarOpen, setSidebarOpen] = useState(false);

  // ‚úÖ flag pour √™tre s√ªr qu'on est c√¥t√© client
  const [clientReady, setClientReady] = useState(false);
  useEffect(() => {
    setClientReady(true);
  }, []);

  // ‚úÖ Cr√©dits utilisateur (Firestorm)
  const [credits, setCredits] = useState<number | null>(null);

  // üîí Protection des routes /app : login + email v√©rifi√©
  useEffect(() => {
    if (!clientReady) return;
    if (loading) return;

    if (!user) {
      router.replace("/login");
      return;
    }

    if (!user.emailVerified) {
      router.replace("/auth/verify-email");
      return;
    }
  }, [clientReady, user, loading, router]);

  // üõ° Surveillance du doc user : blocage + cr√©dits
  useEffect(() => {
    if (!clientReady) return;
    if (!user) return;

    const ref = doc(db, "users", user.uid);

    const unsub = onSnapshot(
      ref,
      (snap) => {
        const data = snap.data() as any | undefined;

        // blocage
        if (data?.blocked) {
          logout()
            .catch((e) =>
              console.error("Erreur d√©connexion apr√®s blocage :", e)
            )
            .finally(() => {
              router.replace("/login?blocked=1");
            });
          return;
        }

        // cr√©dits
        if (typeof data?.credits === "number") {
          setCredits(data.credits);
        } else {
          setCredits(0);
        }
      },
      (err) => {
        console.error("Erreur surveillance utilisateur :", err);
      }
    );

    return () => {
      unsub();
    };
  }, [clientReady, user, logout, router]);

  // ferme le menu mobile au changement de page
  useEffect(() => {
    setSidebarOpen(false);
  }, [pathname]);

  // ‚ö†Ô∏è Tant qu'on n'est pas pr√™t ou pas autoris√© ‚Üí on ne rend PAS le dashboard
  if (!clientReady || loading || !user || !user.emailVerified) {
    return null;
  }

  const handleLogout = async () => {
    try {
      await logout();
      router.replace("/login");
    } catch (e) {
      console.error("Erreur d√©connexion :", e);
    }
  };

  const currentNav = navLinks.find(
    (link) =>
      pathname === link.href || pathname.startsWith(link.href + "/")
  );
  const pageTitle = currentNav?.label ?? "Espace candidat";

  const CreditsBadge =
    credits === null ? null : (
      <div className="inline-flex items-center gap-1 rounded-full px-2 py-1 text-[11px] bg-[var(--bg-soft)] border border-[var(--border)]/80 text-[var(--ink)]">
        <span className="text-[13px]">‚ö°</span>
        <span>
          <span className="font-semibold">{credits}</span> cr√©dits
        </span>
      </div>
    );

  return (
    <div className="min-h-screen flex bg-[var(--bg)] text-[var(--ink)]">
      {/* SIDEBAR DESKTOP */}
      <aside className="hidden md:flex w-60 shrink-0 flex-col border-r border-[var(--border)] bg-[var(--bg-soft)]/60">
        <div className="flex items-center gap-2 px-3 py-4 border-b border-[var(--border)]/70">
          <Link href="/app" className="flex items-center gap-2">
            <div className="w-9 h-9 rounded-2xl bg-[var(--brand)]/10 border border-[var(--brand)]/40 flex items-center justify-center text-lg">
              ‚ö°
            </div>
            <div className="flex flex-col">
              <span className="text-xs font-semibold">
                Assistant Candidature IA
              </span>
              <span className="text-[10px] text-[var(--muted)]">
                Espace candidat
              </span>
            </div>
          </Link>
        </div>

        <nav className="flex-1 px-2 py-3 space-y-1 text-[13px] overflow-y-auto">
          {navLinks.map((link) => {
            const active =
              pathname === link.href ||
              pathname.startsWith(link.href + "/");
            return (
              <Link
                key={link.href}
                href={link.href}
                className={[
                  "flex items-center gap-2 rounded-lg px-2 py-1.5 transition-colors border border-transparent",
                  active
                    ? "bg-[var(--bg)] text-[var(--ink)] border-[var(--brand)]/60"
                    : "text-[var(--muted)] hover:text-[var(--ink)] hover:bg-[var(--bg-soft)]",
                ].join(" ")}
              >
                <span className="w-5 text-center text-[13px]">
                  {link.icon}
                </span>
                <span>{link.label}</span>
              </Link>
            );
          })}
        </nav>

        <div className="border-t border-[var(--border)]/70 px-3 py-3 text-[11px] flex flex-col gap-2">
          {/* Badge cr√©dits dans le bas de la sidebar */}
          {CreditsBadge}

          {user?.email && (
            <p className="text-[var(--muted)]">
              Connect√©¬∑e :{" "}
              <span className="font-medium text-[var(--ink)]">
                {user.email}
              </span>
            </p>
          )}
          <button
            type="button"
            onClick={handleLogout}
            className="w-full text-[11px] rounded-full border border-[var(--border)] px-3 py-1.5 bg-[var(--bg)] hover:border-red-500 hover:text-red-300 transition-colors"
          >
            Se d√©connecter
          </button>
        </div>
      </aside>

      {/* COLONNE CONTENU */}
      <div className="flex-1 flex flex-col relative">
        <div className="pointer-events-none absolute inset-0 -z-10 bg-[radial-gradient(circle_at_top,_rgba(56,189,248,0.16),_transparent_55%),radial-gradient(circle_at_bottom,_rgba(94,234,212,0.12),_transparent_55%)]" />

        {/* TOPBAR */}
        <header className="sticky top-0 z-30 border-b border-[var(--border)]/80 bg-[var(--bg)]/95 backdrop-blur">
          <div className="flex items-center justify-between gap-3 px-3 sm:px-6 py-3">
            <div className="flex items-center gap-3">
              <button
                type="button"
                aria-label="Ouvrir la navigation"
                onClick={() => setSidebarOpen(true)}
                className="md:hidden rounded-full p-2 bg-[var(--bg-soft)] border border-[var(--border)]/80 shadow-sm focus:outline-none focus:ring-2 focus:ring-[var(--brand)]/60"
              >
                <div className={`menu-icon1 ${sidebarOpen ? "is-open" : ""}`}>
                  <div className="menu-icon1_line-top"></div>
                  <div className="menu-icon1_line-middle">
                    <div className="menu-icon1_line-middle-inner"></div>
                  </div>
                  <div className="menu-icon1_line-bottom"></div>
                </div>
              </button>

              <div className="flex flex-col">
                <span className="text-[11px] font-medium uppercase tracking-wide text-[var(--muted)]">
                  Tableau de bord
                </span>
                <span className="text-sm font-semibold">{pageTitle}</span>
              </div>
            </div>

            <div className="flex items-center gap-3">
              {/* Badge cr√©dits visible dans la topbar */}
              {CreditsBadge}

              {user?.email && (
                <span className="hidden sm:inline text-[11px] text-[var(--muted)]">
                  {user.email}
                </span>
              )}
              <button
                type="button"
                onClick={handleLogout}
                className="text-[11px] rounded-full border border-[var(--border)] px-3 py-1.5 bg-[var(--bg-soft)] hover:border-red-500 hover:text-red-300 transition-colors"
              >
                Se d√©connecter
              </button>
            </div>
          </div>
        </header>

        <main className="flex-1 overflow-y-auto">
          <div className="px-3 sm:px-6 lg:px-8 py-4 lg:py-6">
            <div className="max-w-6xl mx-auto space-y-4">{children}</div>
          </div>
        </main>
      </div>

      {/* MENU MOBILE (DRAWER) */}
      <div
        className={`fixed inset-0 z-40 md:hidden transition ${
          sidebarOpen ? "pointer-events-auto" : "pointer-events-none"
        }`}
      >
        <div
          className={`absolute inset-0 bg-black/50 transition-opacity ${
            sidebarOpen ? "opacity-100" : "opacity-0"
          }`}
          onClick={() => setSidebarOpen(false)}
        />

        <div
          className={`absolute left-0 top-0 h-full w-64 bg-[var(--bg)] border-r border-[var(--border)] shadow-xl transform transition-transform ${
            sidebarOpen ? "translate-x-0" : "-translate-x-full"
          }`}
        >
          <div className="flex items-center justify-between px-3 py-3 border-b border-[var(--border)]/80">
            <div className="flex items-center gap-2">
              <div className="menu-icon1">
                <div className="menu-icon1_line-top"></div>
                <div className="menu-icon1_line-middle">
                  <div className="menu-icon1_line-middle-inner"></div>
                </div>
                <div className="menu-icon1_line-bottom"></div>
              </div>
              <div className="flex flex-col">
                <span className="text-xs font-semibold">Menu</span>
                <span className="text-[10px] text-[var(--muted)]">
                  Navigation
                </span>
              </div>
            </div>
            <button
              type="button"
              onClick={() => setSidebarOpen(false)}
              className="text-[11px] rounded-full border border-[var(--border)] px-2 py-1 hover:bg-[var(--bg-soft)]"
            >
              ‚úï
            </button>
          </div>

          <nav className="px-2 py-3 flex flex-col gap-1 text-[13px] overflow-y-auto">
            {navLinks.map((link) => {
              const active =
                pathname === link.href ||
                pathname.startsWith(link.href + "/");
              return (
                <Link
                  key={link.href}
                  href={link.href}
                  className={[
                    "flex items-center gap-2 rounded-lg px-2 py-1.5 transition-colors border border-transparent",
                    active
                      ? "bg-[var(--bg)] text-[var(--ink)] border-[var(--brand)]/60"
                      : "text-[var(--muted)] hover:text-[var(--ink)] hover:bg-[var(--bg-soft)]",
                  ].join(" ")}
                >
                  <span className="w-5 text-center text-[13px]">
                    {link.icon}
                  </span>
                  <span>{link.label}</span>
                </Link>
              );
            })}
          </nav>

          <div className="border-t border-[var(--border)]/70 px-3 py-3 text-[11px] space-y-2">
            {/* Badge cr√©dits aussi dans le menu mobile */}
            {CreditsBadge}

            {user?.email && (
              <p className="mb-1 text-[var(--muted)]">
                Connect√©¬∑e :{" "}
                <span className="font-medium text-[var(--ink)]">
                  {user.email}
                </span>
              </p>
            )}
            <button
              type="button"
              onClick={handleLogout}
              className="w-full text-[11px] rounded-full border border-[var(--border)] px-3 py-1.5 bg-[var(--bg)] hover:border-red-500 hover:text-red-300 transition-colors"
            >
              Se d√©connecter
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}
````

## File: components/pdf/PdfEditorModal.tsx
````typescript
"use client";

import { ReactNode } from "react";
import { motion } from "framer-motion";
import PdfViewer from "./PdfViewer";

type Props = {
  open: boolean;
  title: string;
  subtitle?: string;
  fileUrl: string | null;

  onClose: () => void;

  // ‚úÖ jamais d‚Äôauto-download : on t√©l√©charge uniquement sur clic
  onDownload: () => void;
  downloadDisabled?: boolean;

  leftPanel?: ReactNode; // ton √©diteur (CV ou LM)
};

export default function PdfEditorModal({
  open,
  title,
  subtitle,
  fileUrl,
  onClose,
  onDownload,
  downloadDisabled,
  leftPanel,
}: Props) {
  if (!open) return null;

  return (
    <div className="fixed inset-0 z-[80]">
      <div className="absolute inset-0 bg-black/70" onClick={onClose} />

      <motion.div
        initial={{ opacity: 0, y: 10, scale: 0.985 }}
        animate={{ opacity: 1, y: 0, scale: 1 }}
        transition={{ duration: 0.18 }}
        className="absolute inset-2 sm:inset-4 rounded-2xl border border-[var(--border)] bg-[var(--bg)] shadow-2xl overflow-hidden flex flex-col"
        role="dialog"
        aria-modal="true"
      >
        {/* Header */}
        <div className="flex items-center justify-between gap-2 p-3 sm:p-4 border-b border-[var(--border)] bg-[var(--bg-soft)]">
          <div>
            <p className="text-[13px] font-semibold text-[var(--ink)]">{title}</p>
            {subtitle ? <p className="text-[11px] text-[var(--muted)]">{subtitle}</p> : null}
          </div>

          <div className="flex items-center gap-2">
            <button
              type="button"
              className="btn-secondary !py-2 !px-3 text-[12px]"
              onClick={onClose}
            >
              Fermer
            </button>

            <button
              type="button"
              className="btn-primary !py-2 !px-3 text-[12px]"
              disabled={downloadDisabled}
              onClick={onDownload}
            >
              T√©l√©charger
            </button>
          </div>
        </div>

        {/* Body full height */}
        <div className="flex-1 min-h-0 grid grid-cols-1 lg:grid-cols-[440px_1fr]">
          {/* Left editor */}
          <div className="min-h-0 overflow-auto border-b lg:border-b-0 lg:border-r border-[var(--border)] bg-[var(--bg)] p-3 sm:p-4">
            {leftPanel ? (
              leftPanel
            ) : (
              <div className="text-[12px] text-[var(--muted)]">
                Aucun √©diteur fourni.
              </div>
            )}
          </div>

          {/* Right preview */}
          <div className="min-h-0 overflow-auto bg-[var(--bg)] p-3 sm:p-4">
            <PdfViewer fileUrl={fileUrl} />
          </div>
        </div>
      </motion.div>
    </div>
  );
}
````

## File: components/pdf/PdfViewer.tsx
````typescript
"use client";

import { useEffect, useMemo, useRef, useState } from "react";
import { Document, Page, pdfjs } from "react-pdf";

// ‚úÖ Worker pdf.js (Next 14 OK)
pdfjs.GlobalWorkerOptions.workerSrc = new URL(
  "pdfjs-dist/build/pdf.worker.min.mjs",
  import.meta.url
).toString();

type Props = {
  fileUrl: string | null; // objectURL (Blob) ou URL
  className?: string;
};

export default function PdfViewer({ fileUrl, className }: Props) {
  const wrapRef = useRef<HTMLDivElement | null>(null);
  const [wrapW, setWrapW] = useState(900);

  const [numPages, setNumPages] = useState(1);
  const [page, setPage] = useState(1);
  const [zoom, setZoom] = useState(1);

  useEffect(() => {
    if (!wrapRef.current) return;
    const el = wrapRef.current;

    const ro = new ResizeObserver(() => {
      const w = Math.floor(el.getBoundingClientRect().width);
      if (w > 50) setWrapW(w);
    });
    ro.observe(el);
    return () => ro.disconnect();
  }, []);

  useEffect(() => {
    // reset quand on change de fichier
    setPage(1);
    setZoom(1);
  }, [fileUrl]);

  const canPrev = page > 1;
  const canNext = page < numPages;

  const width = useMemo(() => {
    // un peu de marge interne
    return Math.max(200, Math.floor(wrapW - 24));
  }, [wrapW]);

  if (!fileUrl) {
    return (
      <div className={`rounded-xl border border-[var(--border)] bg-[var(--bg)] p-4 text-[12px] text-[var(--muted)] ${className || ""}`}>
        Aucun aper√ßu pour l‚Äôinstant.
      </div>
    );
  }

  return (
    <div ref={wrapRef} className={className}>
      {/* Toolbar custom (pas celle de Chrome) */}
      <div className="flex flex-wrap items-center justify-between gap-2 rounded-xl border border-[var(--border)] bg-[var(--bg-soft)] px-3 py-2">
        <div className="flex items-center gap-2 text-[11px] text-[var(--muted)]">
          <button
            type="button"
            className="btn-secondary !py-1 !px-2 text-[11px]"
            disabled={!canPrev}
            onClick={() => setPage((p) => Math.max(1, p - 1))}
          >
            ‚Üê
          </button>
          <span className="min-w-[80px] text-center">
            Page <span className="font-medium text-[var(--ink)]">{page}</span> / {numPages}
          </span>
          <button
            type="button"
            className="btn-secondary !py-1 !px-2 text-[11px]"
            disabled={!canNext}
            onClick={() => setPage((p) => Math.min(numPages, p + 1))}
          >
            ‚Üí
          </button>
        </div>

        <div className="flex items-center gap-2">
          <button
            type="button"
            className="btn-secondary !py-1 !px-2 text-[11px]"
            onClick={() => setZoom((z) => Math.max(0.6, +(z - 0.1).toFixed(2)))}
          >
            ‚àí
          </button>
          <span className="text-[11px] text-[var(--muted)] w-[54px] text-center">
            {(zoom * 100).toFixed(0)}%
          </span>
          <button
            type="button"
            className="btn-secondary !py-1 !px-2 text-[11px]"
            onClick={() => setZoom((z) => Math.min(2.0, +(z + 0.1).toFixed(2)))}
          >
            +
          </button>

          <button
            type="button"
            className="btn-secondary !py-1 !px-3 text-[11px]"
            onClick={() => setZoom(1)}
          >
            100%
          </button>
        </div>
      </div>

      <div className="mt-2 rounded-xl border border-[var(--border)] bg-white overflow-auto p-3">
        <Document
          file={fileUrl}
          loading={<div className="text-[12px] text-[var(--muted)]">Chargement du PDF‚Ä¶</div>}
          onLoadSuccess={(info) => {
            setNumPages(info.numPages || 1);
            setPage(1);
          }}
          onLoadError={(e) => console.error("PDF load error:", e)}
        >
          <Page
            pageNumber={page}
            width={width}
            scale={zoom}
            renderTextLayer={false}
            renderAnnotationLayer={false}
            loading={<div className="text-[12px] text-[var(--muted)]">Rendu‚Ä¶</div>}
          />
        </Document>
      </div>
    </div>
  );
}
````

## File: components/user/CreditsBadge.tsx
````typescript
"use client";

import { useUserCredits } from "@/hooks/useUserCredits";

export function CreditsBadge() {
  const { credits, loading } = useUserCredits();

  return (
    <div className="inline-flex items-center gap-1 rounded-full px-2 py-1 text-[11px] bg-[var(--bg-soft)] border border-[var(--border)]/80 text-[var(--ink)]">
      <span className="text-[13px]">‚ö°</span>
      {loading ? (
        <span className="opacity-70">Chargement‚Ä¶</span>
      ) : (
        <span>
          <span className="font-semibold">{credits}</span> cr√©dits
        </span>
      )}
    </div>
  );
}
````

## File: components/ActivityTracker.tsx
````typescript
// components/ActivityTracker.tsx
"use client";

import { useEffect } from "react";
import { useAuth } from "@/context/AuthContext";
import { updateLastActive } from "@/lib/userTracking";

/**
 * Composant invisible qui met √† jour lastActiveAt
 * toutes les 60 secondes tant que l'utilisateur est connect√©.
 * On en profite pour envoyer:
 *  - la page actuelle (path)
 *  - le device (iPhone / iPad / macOS / etc.)
 *  - l‚ÄôIP + pays + ville (via userTracking)
 */
export default function ActivityTracker() {
  const { user } = useAuth();

  useEffect(() => {
    if (!user) return;

    let cancelled = false;

    const tick = () => {
      if (!user || cancelled) return;

      const path =
        typeof window !== "undefined"
          ? window.location.pathname + window.location.search
          : undefined;

      updateLastActive(user, {
        path,
        action: "heartbeat",
      });
    };

    // premi√®re mise √† jour imm√©diate
    tick();
    const id = setInterval(tick, 60_000); // toutes les 60 secondes

    return () => {
      cancelled = true;
      clearInterval(id);
    };
  }, [user]);

  return null;
}
````

## File: components/AOSProvider.tsx
````typescript
"use client";

import { useEffect } from "react";
import AOS from "aos";
import "aos/dist/aos.css";

export default function AOSProvider({ children }: { children: React.ReactNode }) {
  useEffect(() => {
    AOS.init({
      duration: 1000, // dur√©e des animations
      once: true,     // n‚Äôanime qu‚Äôune seule fois
      easing: "ease-out-cubic",
      offset: 60
    });
  }, []);

  return <>{children}</>;
}
````

## File: components/BlockedOverlay.tsx
````typescript
// components/BlockedOverlay.tsx
"use client";

import { useAuth } from "@/context/AuthContext";
import { useUserProfile } from "@/hooks/useUserProfile";

/**
 * Affiche un overlay pleine page si le user est marqu√© "blocked" dans Firestore.
 * R√©sultat : impossible de cliquer / utiliser l'app.
 */
export default function BlockedOverlay() {
  const { user } = useAuth();
  const { profile, loading } = useUserProfile();

  // pas connect√© ou encore en chargement -> pas d'overlay
  if (!user || loading) return null;

  if (!profile?.blocked) return null;

  return (
    <div className="fixed inset-0 z-[9999] bg-black/80 backdrop-blur-sm flex items-center justify-center px-4">
      <div className="max-w-md w-full glass border border-red-500/40 rounded-2xl p-6 text-center">
        <h2 className="text-lg font-semibold mb-2 text-red-100">
          Acc√®s bloqu√©
        </h2>
        <p className="text-xs text-[var(--muted)] mb-4">
          Ton compte a √©t√© temporairement bloqu√© par l&apos;administration.
          Tu ne peux plus utiliser l&apos;assistant tant que le blocage est
          actif.
        </p>
        <p className="text-[11px] text-[var(--muted)] mb-4">
          Si tu penses qu&apos;il s&apos;agit d&apos;une erreur, contacte le
          support ou l&apos;administrateur.
        </p>
        <p className="text-[10px] text-[var(--muted)]/70">
          ID utilisateur :{" "}
          <span className="font-mono">
            {profile.id.slice(0, 8)}‚Ä¶
          </span>
        </p>
      </div>
    </div>
  );
}
````

## File: components/BuyCreditsButtons.tsx
````typescript
// src/components/BuyCreditsButtons.tsx
"use client";

import { useState } from "react";

type CreditPackId = "10" | "20" | "30";

interface BuyCreditsButtonsProps {
  user: {
    id: string;
    email: string;
  };
}

export function BuyCreditsButtons({ user }: BuyCreditsButtonsProps) {
  const [loadingPack, setLoadingPack] = useState<CreditPackId | null>(null);

  const handleBuy = async (packId: CreditPackId) => {
    try {
      setLoadingPack(packId);

      const res = await fetch("/api/polar/checkout", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          packId,
          email: user.email,
          userId: user.id,
        }),
      });

      const data = await res.json();

      if (!data.ok || !data.url) {
        console.error("Erreur r√©ponse API Polar:", data);
        alert("Erreur lors de la cr√©ation du paiement.");
        return;
      }

      // Redirection vers la page de paiement Polar
      window.location.href = data.url;
    } catch (error) {
      console.error("Erreur handleBuy:", error);
      alert("Une erreur est survenue.");
    } finally {
      setLoadingPack(null);
    }
  };

  const isLoading = (pack: CreditPackId) => loadingPack === pack;

  return (
    <div className="flex flex-col gap-3">
      <button onClick={() => handleBuy("10")} disabled={isLoading("10")}>
        {isLoading("10") ? "Redirection..." : "Acheter 10 cr√©dits"}
      </button>
      <button onClick={() => handleBuy("20")} disabled={isLoading("20")}>
        {isLoading("20") ? "Redirection..." : "Acheter 20 cr√©dits"}
      </button>
      <button onClick={() => handleBuy("30")} disabled={isLoading("30")}>
        {isLoading("30") ? "Redirection..." : "Acheter 30 cr√©dits"}
      </button>
    </div>
  );
}
````

## File: components/CvTemplatePicker.tsx
````typescript
// src/components/CvTemplatePicker.tsx
"use client";

import Image from "next/image";
import { getCvTemplates, type CvTemplateId } from "@/lib/pdf/templates/cvTemplates";

export function CvTemplatePicker({
  value,
  onChange,
}: {
  value: CvTemplateId;
  onChange: (id: CvTemplateId) => void;
}) {
  const templates = getCvTemplates();

  return (
    <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
      {templates.map((t) => {
        const selected = t.id === value;
        return (
          <button
            key={t.id}
            type="button"
            onClick={() => onChange(t.id)}
            className={[
              "text-left rounded-xl border p-3 hover:bg-[var(--bg-soft)] transition",
              selected ? "border-[var(--brand)] ring-2 ring-[var(--brand)]/20" : "border-[var(--border)]",
            ].join(" ")}
          >
            <div className="relative w-full aspect-[4/3] rounded-lg overflow-hidden bg-white border border-[var(--border)]">
              <Image
                src={t.previewSrc}
                alt={t.label}
                fill
                className="object-cover"
                sizes="(max-width: 768px) 50vw, 33vw"
              />
            </div>

            <div className="mt-2">
              <div className="flex items-center justify-between gap-2">
                <p className="font-medium text-[var(--ink)]">{t.label}</p>
                {selected ? (
                  <span className="text-[10px] px-2 py-1 rounded-full bg-[var(--brand)]/10 text-[var(--brand)] border border-[var(--brand)]/20">
                    S√©lectionn√©
                  </span>
                ) : null}
              </div>
              <p className="text-[11px] text-[var(--muted)] mt-1">{t.description}</p>
            </div>
          </button>
        );
      })}
    </div>
  );
}
````

## File: components/LandingFeatures.tsx
````typescript
"use client";

import { motion } from "framer-motion";

const features = [
  {
    title: "CV IA optimis√©",
    desc: "Importe ton CV PDF, laisse Gemini en extraire le profil et g√©n√®re un CV optimis√©."
  },
  {
    title: "Lettres sur-mesure",
    desc: "Colle une offre, obtiens une lettre adapt√©e √† ton profil et √† l'entreprise cibl√©e."
  },
  {
    title: "Suivi simplifi√©",
    desc: "Garde une trace de toutes tes candidatures avec un tracker clair et visuel."
  }
];

export default function LandingFeatures() {
  return (
    <section className="px-4 sm:px-8 pb-6">
      <div className="max-w-6xl mx-auto grid gap-3 md:grid-cols-3">
        {features.map((f, idx) => (
          <motion.div
            key={f.title}
            initial={{ opacity: 0, y: 8 }}
            whileInView={{ opacity: 1, y: 0 }}
            viewport={{ once: true, amount: 0.4 }}
            transition={{ duration: 0.2, delay: idx * 0.05 }}
            className="glass p-4 text-sm"
          >
            <h3 className="text-sm font-semibold mb-1">{f.title}</h3>
            <p className="text-xs text-[var(--muted)]">{f.desc}</p>
          </motion.div>
        ))}
      </div>
    </section>
  );
}
````

## File: components/LandingHero.tsx
````typescript
"use client";

import { motion } from "framer-motion";
import Link from "next/link";

export default function LandingHero() {
  return (
    <section className="px-4 sm:px-8 pt-8 pb-6">
      <div className="max-w-6xl mx-auto flex flex-col gap-6 md:flex-row md:items-center">
        <motion.div
          initial={{ opacity: 0, y: 12 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.25 }}
          className="flex-1"
        >
          <p className="badge-muted mb-3">
            <span className="w-1 h-1 rounded-full bg-emerald-400" />
            <span>IA appliqu√©e aux candidatures</span>
          </p>
          <h1 className="text-2xl sm:text-3xl md:text-4xl font-semibold leading-tight mb-3">
            Ton bureau de candidature, pilot√© par l&apos;IA.
          </h1>
          <p className="text-sm sm:text-base text-[var(--muted)] max-w-xl mb-4">
            Importe ton CV, g√©n√®re des lettres de motivation cibl√©es, pr√©pare ton pitch oral
            et suis toutes tes candidatures depuis un seul espace, pens√© pour les profils tech
            et cybers√©curit√©.
          </p>
          <div className="flex flex-wrap gap-2">
            <Link href="/signup" className="btn-primary text-xs sm:text-sm">
              Essayer gratuitement
            </Link>
            <Link href="/login" className="btn-secondary text-xs sm:text-sm">
              Se connecter
            </Link>
          </div>
        </motion.div>

        <motion.div
          initial={{ opacity: 0, y: 12 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.25, delay: 0.05 }}
          className="flex-1"
        >
          <div className="glass p-4 text-xs text-[var(--muted)]">
            <p className="mb-2 text-[11px] uppercase tracking-[0.18em]">
              Aper√ßu temps r√©el
            </p>
            <p>
              Un tableau de bord unique pour ton CV, tes LM, ton pitch et ton suivi de
              candidatures. Design inspir√© de ton interface actuelle, en Next.js + Tailwind CSS
              + Framer Motion.
            </p>
          </div>
        </motion.div>
      </div>
    </section>
  );
}
````

## File: components/LandingStack.tsx
````typescript
"use client";

import { motion } from "framer-motion";
import Link from "next/link";

export default function LandingStack() {
  return (
    <section className="px-4 sm:px-8 pb-10">
      <div className="max-w-6xl mx-auto glass p-4 sm:p-5">
        <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-3">
          <div>
            <p className="badge-muted mb-1">
              <span>Stack technique</span>
            </p>
            <h2 className="text-sm sm:text-base font-semibold">
              Une stack moderne pour une exp√©rience fluide
            </h2>
          </div>
          <Link href="/tech" className="text-[11px] text-[var(--brand)] underline">
            Voir les d√©tails techniques
          </Link>
        </div>
        <div className="grid gap-3 sm:grid-cols-3 text-xs sm:text-sm">
          <motion.div
            initial={{ opacity: 0, y: 8 }}
            whileInView={{ opacity: 1, y: 0 }}
            viewport={{ once: true }}
            transition={{ duration: 0.2 }}
          >
            <p className="font-semibold mb-1">Frontend ¬∑ React / Next.js</p>
            <p className="text-[var(--muted)]">
              Framework JavaScript moderne pour construire une interface rapide,
              SEO-friendly et bien rout√©e.
            </p>
          </motion.div>
          <motion.div
            initial={{ opacity: 0, y: 8 }}
            whileInView={{ opacity: 1, y: 0 }}
            viewport={{ once: true }}
            transition={{ duration: 0.2, delay: 0.05 }}
          >
            <p className="font-semibold mb-1">Styling ¬∑ Tailwind CSS</p>
            <p className="text-[var(--muted)]">
              Un framework utilitaire qui permet de d√©cliner ton design sombre actuel
              dans une grille coh√©rente et responsive.
            </p>
          </motion.div>
          <motion.div
            initial={{ opacity: 0, y: 8 }}
            whileInView={{ opacity: 1, y: 0 }}
            viewport={{ once: true }}
            transition={{ duration: 0.2, delay: 0.1 }}
          >
            <p className="font-semibold mb-1">Animations ¬∑ Framer Motion</p>
            <p className="text-[var(--muted)]">
              Des transitions douces et ma√Ætris√©es pour donner vie aux cartes,
              modales et panneaux comme dans ton design original.
            </p>
          </motion.div>
        </div>
      </div>
    </section>
  );
}
````

## File: components/PaymentHeader.jsx
````javascript
"use client";

import { useEffect } from "react";

export default function PaymentHeader({ onClose, autoCloseMs = 0 }) {
  useEffect(() => {
    if (!autoCloseMs) return;
    const t = setTimeout(() => onClose?.(), autoCloseMs);
    return () => clearTimeout(t);
  }, [autoCloseMs, onClose]);

  return (
    <div className="flex items-center justify-between px-4 py-2 border-b border-[var(--border)]/70 bg-[var(--bg-soft)]/80">
      <div className="flex flex-col">
        <span className="text-[12px] font-semibold text-[var(--ink)]">
          Paiement s√©curis√©
        </span>
        <span className="text-[11px] text-[var(--muted)]">
          Transaction g√©r√©e par Polar (Stripe)
        </span>
      </div>

      <button
        type="button"
        onClick={onClose}
        className="text-[11px] rounded-full border border-[var(--border)] px-2 py-1 hover:bg-[var(--bg)]"
        aria-label="Fermer"
      >
        ‚úï
      </button>
    </div>
  );
}
````

## File: components/PolarCheckoutModal.jsx
````javascript
"use client";

import { useEffect } from "react";
import PaymentHeader from "./PaymentHeader";

export default function PolarCheckoutModal({ open, url, onClose, onDone }) {
  useEffect(() => {
    if (!open) return;

    function handleMessage(e) {
      // On accepte uniquement les messages venant de NOTRE domaine
      if (e.origin !== window.location.origin) return;

      const data = e.data;
      if (!data || typeof data !== "object") return;
      if (data.type !== "POLAR_CHECKOUT_DONE") return;

      onDone?.(data.status);
      onClose?.();
    }

    window.addEventListener("message", handleMessage);
    return () => window.removeEventListener("message", handleMessage);
  }, [open, onClose, onDone]);

  if (!open) return null;

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/40 p-4">
      <div className="w-full max-w-3xl overflow-hidden rounded-2xl bg-white shadow-xl">
        <PaymentHeader onClose={onClose} />

        <div className="h-[80vh] bg-white">
          {url ? (
            <iframe
              title="Polar checkout"
              src={url}
              className="h-full w-full"
              allow="payment *"
            />
          ) : (
            <div className="p-4 text-sm">Chargement‚Ä¶</div>
          )}
        </div>
      </div>
    </div>
  );
}
````

## File: components/SidebarUser.tsx
````typescript
"use client";

import Link from "next/link";
import { usePathname } from "next/navigation";
import { useState } from "react";

type AppLink = {
  href: string;
  label: string;
  icon?: string;
};

// Liens principaux
const MAIN_LINKS: AppLink[] = [
  { href: "/app", label: "Profil CV IA", icon: "üìÑ" },
  { href: "/app/lm", label: "Assistant candidature", icon: "‚ú®" },
  { href: "/app/tracker", label: "Suivi candidatures", icon: "üìä" },
  { href: "/app/interview", label: "Pr√©parer entretien", icon: "üé§" },
  { href: "/app/apply", label: "Postuler", icon: "üì®" },
  { href: "/app/history", label: "Historique IA", icon: "üïí" },
  { href: "/app/credits", label: "Cr√©dits", icon: "‚ö°" },
];

const SETTINGS_LINK: AppLink = {
  href: "/app/settings",
  label: "Param√®tres",
  icon: "‚öôÔ∏è",
};

export default function SidebarUser() {
  const pathname = usePathname();

  // Desktop collapse
  const [collapsed, setCollapsed] = useState(false);

  // Mobile sidebar
  const [mobileOpen, setMobileOpen] = useState(false);

  const baseItem =
    "flex items-center gap-2 rounded-lg px-2 py-1.5 text-[11px] transition-colors";

  const isLinkActive = (href: string) =>
    pathname === href || pathname.startsWith(href + "/");

  return (
    <>
      {/* === BOUTON HAMBURGER MOBILE === */}
      <button
        className="menu-icon1 md:hidden fixed top-3 left-3 z-50"
        onClick={() => setMobileOpen((o) => !o)}
      >
        <div className="menu-icon1_line-top"></div>
        <div className="menu-icon1_line-middle">
          <div className="menu-icon1_line-middle-inner"></div>
        </div>
        <div className="menu-icon1_line-bottom"></div>
      </button>

      {/* === OVERLAY MOBILE (clic pour fermer) === */}
      {mobileOpen && (
        <div
          className="fixed inset-0 bg-black/40 backdrop-blur-sm z-40 md:hidden"
          onClick={() => setMobileOpen(false)}
        ></div>
      )}

      {/* === SIDEBAR === */}
      <aside
        className={`
          bg-[var(--bg-soft)]
          border-r border-[var(--border)]/80
          h-screen
          flex flex-col
          sticky top-0
          z-50
          transition-all duration-300

          md:w-[210px] md:relative md:translate-x-0
          ${collapsed ? "md:w-[60px]" : "md:w-[210px]"}
          
          /* Mobile offcanvas */
          fixed top-0 left-0 w-[230px]
          md:static
          ${mobileOpen ? "translate-x-0" : "-translate-x-full"}
        `}
      >
        {/* Header Desktop (bouton collapse) */}
        <div className="hidden md:flex items-center justify-start px-2 py-3 border-b border-[var(--border)]/70">
          <button
            type="button"
            onClick={() => setCollapsed((c) => !c)}
            aria-label={collapsed ? "D√©plier navigation" : "Replier navigation"}
            className="menu-icon1 inline-flex items-center justify-center w-7 h-7 rounded-lg border border-[var(--border)] bg-[var(--bg)] text-[var(--muted)] hover:text-[var(--ink)] hover:bg-[var(--bg-soft)] text-[11px]"
          >
            {collapsed ? "¬ª" : "¬´"}
          </button>
        </div>

        {/* Mobile : petit espace en haut */}
        <div className="md:hidden h-[60px]"></div>

        {/* Liens */}
        <nav className="flex-1 px-2 py-3 flex flex-col gap-1 overflow-y-auto">
          {MAIN_LINKS.map((link) => {
            const active = isLinkActive(link.href);
            return (
              <Link
                key={link.href}
                href={link.href}
                onClick={() => setMobileOpen(false)} // fermer sidebar mobile
                className={
                  active
                    ? `${baseItem} bg-[var(--bg)] text-[var(--ink)] border border-[var(--brand)]/60`
                    : `${baseItem} text-[var(--muted)] hover:text-[var(--ink)] hover:bg-[var(--bg)]`
                }
              >
                <span className="w-5 text-center text-[12px]">
                  {link.icon ?? "‚Ä¢"}
                </span>
                {!collapsed && <span>{link.label}</span>}
              </Link>
            );
          })}
        </nav>

        {/* Param√®tres */}
        <div className="px-2 py-3 border-t border-[var(--border)]/70">
          <Link
            href={SETTINGS_LINK.href}
            onClick={() => setMobileOpen(false)}
            className={
              isLinkActive(SETTINGS_LINK.href)
                ? `${baseItem} bg-[var(--bg)] text-[var(--ink)] border border-[var(--brand)]/60`
                : `${baseItem} text-[var(--muted)] hover:text-[var(--ink)] hover:bg-[var(--bg)]`
            }
          >
            <span className="w-5 text-center text-[12px]">
              {SETTINGS_LINK.icon}
            </span>
            {!collapsed && <span>{SETTINGS_LINK.label}</span>}
          </Link>
        </div>
      </aside>
    </>
  );
}
````

## File: components/TopbarUser.tsx
````typescript
"use client";

import Link from "next/link";
import { useRouter } from "next/navigation";
import { useAuth } from "@/context/AuthContext";

export default function TopbarUser() {
  const router = useRouter();
  const { user, logout } = useAuth();

  const handleLogout = async () => {
    try {
      await logout(); // ou ton signOut(auth) dans le contexte
      router.push("/login");
    } catch (err) {
      console.error("Erreur d√©connexion :", err);
    }
  };

  // On privil√©gie le displayName (Pr√©nom Nom)
  const displayName =
    user?.displayName ||
    (user?.email ? user.email.split("@")[0] : "Utilisateur");

  return (
    <header className="sticky top-0 z-30 bg-[var(--bg)]/90 backdrop-blur-xl border-b border-[var(--border)]/70">
      <div className="max-w-6xl mx-auto px-4 sm:px-8 h-14 flex items-center justify-between gap-4">
        {/* Logo + mini titre √† gauche */}
        <Link href="/app" className="flex items-center gap-2 shrink-0">
          <div className="w-8 h-8 rounded-2xl bg-gradient-to-br from-[var(--brand)] to-[var(--brandDark)] shadow-lg shadow-[var(--brand)]/30 flex items-center justify-center text-[11px] font-semibold">
            AI
          </div>
          <div className="hidden sm:flex flex-col leading-tight">
            <span className="text-[11px] uppercase tracking-[0.22em] text-[var(--muted)]">
              Assistant candidatures
            </span>
            <span className="text-xs font-medium">Espace connect√©</span>
          </div>
        </Link>

        {/* √Ä droite : connect√© en tant que + bouton d√©connexion */}
        <div className="flex items-center gap-3 ml-auto">
          {user && (
            <div className="flex flex-col items-end leading-tight text-[10px] sm:text-[11px]">
              <span className="text-[var(--muted)] hidden sm:inline">
                Connect√©¬∑e en tant que
              </span>
              <span className="text-[var(--ink)] font-medium max-w-[160px] truncate">
                {displayName}
              </span>
            </div>
          )}

          <button
            type="button"
            onClick={handleLogout}
            className="inline-flex items-center justify-center text-[11px] sm:text-[12px] px-3 py-1.5 rounded-full border border-[var(--border)] bg-[var(--bg-soft)] hover:bg-[var(--bg)] text-[var(--muted)] hover:text-[var(--ink)] transition-colors"
          >
            Se d√©connecter
          </button>
        </div>
      </div>
    </header>
  );
}
````

## File: context/AuthContext.tsx
````typescript
"use client";

import {
  createContext,
  useContext,
  useEffect,
  useState,
  type ReactNode,
} from "react";
import {
  onIdTokenChanged,
  signOut,
  type User,
  getIdTokenResult,
} from "firebase/auth";
import { auth, db } from "@/lib/firebase";
import { doc, getDoc } from "firebase/firestore";

type AuthContextType = {
  user: User | null;
  loading: boolean;
  isAdmin: boolean;
  blocked: boolean;
  logout: () => Promise<void>;
};

const AuthContext = createContext<AuthContextType>({
  user: null,
  loading: true,
  isAdmin: false,
  blocked: false,
  logout: async () => {},
});

export function AuthProvider({ children }: { children: ReactNode }) {
  const [user, setUser] = useState<User | null>(null);
  const [loading, setLoading] = useState(true);
  const [isAdmin, setIsAdmin] = useState(false);
  const [blocked, setBlocked] = useState(false);

  useEffect(() => {
    const unsub = onIdTokenChanged(auth, async (firebaseUser) => {
      setLoading(true);

      // D√©connect√©
      if (!firebaseUser) {
        setUser(null);
        setIsAdmin(false);
        // IMPORTANT: on ne force pas blocked=false ici,
        // comme √ßa si un compte vient d‚Äô√™tre rejet√© car bloqu√©,
        // la page /login peut garder le message.
        setLoading(false);
        return;
      }

      // 1) ‚úÖ V√©rif Firestore AVANT d‚Äôexposer user
      try {
        const ref = doc(db, "users", firebaseUser.uid);
        const snap = await getDoc(ref);
        const data = snap.data() as any | undefined;

        if (data?.blocked) {
          // üîí Compte bloqu√© : on rejette la session AVANT toute redirection / rendu /app
          setBlocked(true);
          setUser(null);
          setIsAdmin(false);
          setLoading(false);

          try {
            await signOut(auth);
          } catch (e) {
            console.error("Erreur signOut (blocked):", e);
          }
          return;
        }

        // Compte OK ‚Üí on reset blocked
        setBlocked(false);
      } catch (e) {
        // üîê Par s√©curit√© + pour √©viter le flash,
        // si la v√©rif Firestore plante, on refuse la session.
        console.error("Erreur v√©rification blocked:", e);

        setBlocked(true);
        setUser(null);
        setIsAdmin(false);
        setLoading(false);

        try {
          await signOut(auth);
        } catch (err) {
          console.error("Erreur signOut (firestore check failed):", err);
        }
        return;
      }

      // 2) ‚úÖ Admin claims (apr√®s validation blocked)
      try {
        const tokenResult = await getIdTokenResult(firebaseUser, true);
        const claims = tokenResult.claims || {};
        const adminFlag =
          claims.isAdmin === true || claims.email === "aakane0105@gmail.com";
        setIsAdmin(adminFlag);
      } catch (e) {
        console.error("Erreur r√©cup√©ration des custom claims:", e);
        setIsAdmin(false);
      }

      // 3) ‚úÖ On expose user seulement maintenant
      setUser(firebaseUser);
      setLoading(false);
    });

    return () => unsub();
  }, []);

  const logout = async () => {
    // logout volontaire => on efface le statut blocked UI
    setBlocked(false);
    await signOut(auth);
  };

  return (
    <AuthContext.Provider value={{ user, loading, isAdmin, blocked, logout }}>
      {children}
    </AuthContext.Provider>
  );
}

export function useAuth() {
  return useContext(AuthContext);
}
````

## File: context/CreditsContext.tsx
````typescript
"use client";

import { createContext, useContext, useEffect, useState } from "react";
import { useAuth } from "@/context/AuthContext";
// TODO: brancher Firestore pour √©couter les cr√©dits en temps r√©el

interface CreditsContextValue {
  credits: number | null;
}

const CreditsContext = createContext<CreditsContextValue>({
  credits: null
});

export function CreditsProvider({ children }: { children: React.ReactNode }) {
  const { user } = useAuth();
  const [credits, setCredits] = useState<number | null>(null);

  useEffect(() => {
    if (!user) {
      setCredits(null);
      return;
    }
    // TODO: √©couter doc Firestore "users/{uid}" et lire le champ credits
  }, [user]);

  return (
    <CreditsContext.Provider value={{ credits }}>
      {children}
    </CreditsContext.Provider>
  );
}

export const useCredits = () => useContext(CreditsContext);
````

## File: context/LangContext.tsx
````typescript
"use client";

import { createContext, useContext, useEffect, useState } from "react";

type LangCode =
  | "fr"
  | "en"
  | "es"
  | "de"
  | "pt"
  | "it"
  | "ru"
  | "zh"
  | "ar"
  | "ja";

type LangContextValue = {
  lang: LangCode;
  setLang: (l: LangCode) => void;
};

const LangContext = createContext<LangContextValue | undefined>(undefined);

export function LangProvider({ children }: { children: React.ReactNode }) {
  const [lang, setLangState] = useState<LangCode>("fr");

  useEffect(() => {
    // 1) r√©cup√©rer la langue du localStorage si dispo
    const stored = typeof window !== "undefined"
      ? (localStorage.getItem("lang") as LangCode | null)
      : null;
    if (stored) {
      setLangState(stored);
      return;
    }

    // 2) sinon essayer de d√©tecter la langue du navigateur
    if (typeof window !== "undefined") {
      const navLang = window.navigator.language.slice(0, 2).toLowerCase();
      const supported: LangCode[] = [
        "fr",
        "en",
        "es",
        "de",
        "pt",
        "it",
        "ru",
        "zh",
        "ar",
        "ja",
      ];
      if (supported.includes(navLang as LangCode)) {
        setLangState(navLang as LangCode);
        localStorage.setItem("lang", navLang);
      }
    }
  }, []);

  const setLang = (l: LangCode) => {
    setLangState(l);
    if (typeof window !== "undefined") {
      localStorage.setItem("lang", l);
    }
  };

  return (
    <LangContext.Provider value={{ lang, setLang }}>
      {children}
    </LangContext.Provider>
  );
}

export function useLang() {
  const ctx = useContext(LangContext);
  if (!ctx) {
    throw new Error("useLang must be used inside LangProvider");
  }
  return ctx;
}
````

## File: functions/recaptcha-interview.js
````javascript
"use strict";

const functions = require("firebase-functions");
const admin = require("firebase-admin");
const { RecaptchaEnterpriseServiceClient } = require("@google-cloud/recaptcha-enterprise");

// Init Admin
if (!admin.apps.length) admin.initializeApp();

const recaptchaClient = new RecaptchaEnterpriseServiceClient();

/* ============================
   CORS (Hosting + localhost)
   ============================ */
function setCors(req, res) {
  const origin = req.headers.origin || "";
  const allowed = [
    "http://localhost:3000",
    "http://127.0.0.1:3000",
    "https://assistant-ia-v4.web.app",
    "https://assistant-ia-v4.firebaseapp.com",
  ];

  if (allowed.includes(origin)) {
    res.set("Access-Control-Allow-Origin", origin);
  } else {
    // (Option) tu peux mettre ton domaine custom ici si tu en as un
    // res.set("Access-Control-Allow-Origin", "https://tondomaine.com");
  }

  res.set("Vary", "Origin");
  res.set("Access-Control-Allow-Methods", "POST, OPTIONS");
  res.set("Access-Control-Allow-Headers", "Content-Type, Authorization");
}

/* ============================
   reCAPTCHA config
   ============================ */
function getRecaptchaConfig() {
  const cfg = (functions.config && functions.config() && functions.config().recaptcha) || {};
  const projectId = cfg.project_id || process.env.RECAPTCHA_PROJECT_ID || "";
  const siteKey = cfg.site_key || process.env.RECAPTCHA_SITE_KEY || "";
  const thresholdRaw = cfg.threshold || process.env.RECAPTCHA_THRESHOLD || "0.5";

  const threshold = Number(thresholdRaw);
  return {
    projectId,
    siteKey,
    threshold: Number.isFinite(threshold) ? threshold : 0.5,
  };
}

function getClientIp(req) {
  const xf = req.headers["x-forwarded-for"];
  if (typeof xf === "string" && xf.trim()) return xf.split(",")[0].trim();
  return (
    req.ip ||
    (req.connection && req.connection.remoteAddress) ||
    (req.socket && req.socket.remoteAddress) ||
    ""
  );
}

function normalizeAction(action) {
  return String(action || "").trim().toLowerCase();
}

/**
 * V√©rifie un token reCAPTCHA Enterprise
 */
async function verifyRecaptchaToken({ token, expectedAction, req }) {
  const { projectId, siteKey, threshold } = getRecaptchaConfig();

  // Si pas configur√©, on ne bloque pas (mais on log)
  if (!projectId || !siteKey) {
    console.warn("[recaptcha] NOT CONFIGURED -> bypass (projectId/siteKey missing)");
    return { ok: true, bypass: true, score: null, threshold };
  }

  if (!token) return { ok: false, reason: "missing_token" };

  const userIp = getClientIp(req);
  const userAgent = String(req.headers["user-agent"] || "");

  const parent = `projects/${projectId}`;

  const [assessment] = await recaptchaClient.createAssessment({
    parent,
    assessment: {
      event: {
        token,
        siteKey,
        expectedAction: expectedAction || undefined,
        userAgent: userAgent || undefined,
        userIpAddress: userIp || undefined,
      },
    },
  });

  const tokenProps = assessment && assessment.tokenProperties;
  if (!tokenProps || tokenProps.valid !== true) {
    return {
      ok: false,
      reason: "invalid_token",
      invalidReason: tokenProps ? tokenProps.invalidReason : null,
    };
  }

  // Action check (reCAPTCHA est case-sensitive)
  if (expectedAction && tokenProps.action && String(tokenProps.action) !== String(expectedAction)) {
    return {
      ok: false,
      reason: "action_mismatch",
      expected: expectedAction,
      got: tokenProps.action,
    };
  }

  const score =
    assessment &&
    assessment.riskAnalysis &&
    typeof assessment.riskAnalysis.score === "number"
      ? assessment.riskAnalysis.score
      : null;

  if (typeof score === "number" && score < threshold) {
    return { ok: false, reason: "low_score", score, threshold };
  }

  return { ok: true, score, threshold };
}

/* ============================
   1) Endpoint public: /recaptchaVerify
   ============================ */
exports.recaptchaVerify = functions
  .region("europe-west1")
  .https.onRequest(async (req, res) => {
    setCors(req, res);
    if (req.method === "OPTIONS") return res.status(204).send("");

    if (req.method !== "POST") {
      return res.status(405).json({ ok: false, reason: "method_not_allowed" });
    }
    if (!req.is("application/json")) {
      return res.status(400).json({ ok: false, reason: "invalid_content_type" });
    }

    try {
      const { token, action } = req.body || {};
      const expectedAction = normalizeAction(action);

      if (!token || !expectedAction) {
        return res.status(400).json({ ok: false, reason: "missing_token_or_action" });
      }

      const r = await verifyRecaptchaToken({ token, expectedAction, req });

      if (!r.ok) {
        return res.status(401).json({ ok: false, reason: r.reason, details: r });
      }

      return res.status(200).json({ ok: true, score: r.score ?? null });
    } catch (e) {
      console.error("recaptchaVerify error:", e);
      return res.status(500).json({ ok: false, reason: "server_error" });
    }
  });

/* ============================
   2) Cloud Function: interview (prot√©g√©e par reCAPTCHA)
   ============================ */
exports.interview = functions
  .region("europe-west1")
  .https.onRequest(async (req, res) => {
    setCors(req, res);
    if (req.method === "OPTIONS") return res.status(204).send("");

    if (req.method !== "POST") {
      return res.status(405).json({ error: "method_not_allowed" });
    }
    if (!req.is("application/json")) {
      return res.status(400).json({ error: "invalid_content_type" });
    }

    try {
      const body = req.body || {};

      // ‚úÖ on accepte plusieurs noms c√¥t√© front
      const token =
        body.recaptchaToken ||
        body.token ||
        (body.recaptcha && body.recaptcha.token) ||
        null;

      // ‚úÖ action: on force une convention stable
      // IMPORTANT : le front doit g√©n√©rer un token avec CETTE action
      const expectedAction = normalizeAction(body.recaptchaAction || body.actionName || "interview");

      if (!token) {
        return res.status(403).json({
          error: "reCAPTCHA failed",
          details: "token_missing_or_invalid",
          expectedAction,
        });
      }

      const r = await verifyRecaptchaToken({ token, expectedAction, req });
      if (!r.ok) {
        return res.status(403).json({
          error: "reCAPTCHA failed",
          details: r.reason,
          score: r.score ?? null,
          expectedAction,
          extra: r,
        });
      }

      // ‚úÖ Ici, tu continues TON code interview (Gemini / sessions / credits etc.)
      // Pour que √ßa compile direct, je renvoie juste un OK:
      // Remplace cette partie par ton handler actuel (start/answer) si tu l‚Äôas d√©j√† ici.

      return res.status(200).json({ ok: true, message: "interview OK", score: r.score ?? null });
    } catch (e) {
      console.error("interview error:", e);
      return res.status(500).json({ error: "internal_error" });
    }
  });
````

## File: hooks/useAdminGuard.ts
````typescript
// src/hooks/useAdminGuard.ts
"use client";

import { useEffect } from "react";
import { useRouter, usePathname } from "next/navigation";
import type { User } from "firebase/auth";
import { useAuth } from "@/context/AuthContext";

// üëâ Emails qui sont admin "hardcod√©s" en plus du custom claim isAdmin
const ADMIN_EMAILS = ["aakane0105@gmail.com"];

export type UseAdminGuardResult = {
  loading: boolean;
  isAdmin: boolean;
  user: User | null;
};

export function useAdminGuard(): UseAdminGuardResult {
  const { user, loading, isAdmin: isAdminFromContext } = useAuth();
  const router = useRouter();
  const pathname = usePathname();

  // fallback : si jamais le claim n'est pas encore set, mais que l'email est dans la whitelist
  const email = (user?.email || "").toLowerCase();
  const hasAdminEmail = ADMIN_EMAILS.includes(email);

  const isAdmin = isAdminFromContext || hasAdminEmail;

  useEffect(() => {
    if (loading) return;

    const onAdminRoute = pathname?.startsWith("/admin");

    // Pas connect√© et route /admin ‚Üí renvoie vers /admin/login
    if (!user && onAdminRoute) {
      router.push("/admin/login");
      return;
    }

    // Connect√© mais pas admin et route /admin (hors /admin/login) ‚Üí renvoie vers /
    if (
      user &&
      !isAdmin &&
      onAdminRoute &&
      pathname !== "/admin/login"
    ) {
      router.push("/");
    }
  }, [user, loading, isAdmin, pathname, router]);

  return { loading, isAdmin, user };
}
````

## File: hooks/useRechargeHistory.ts
````typescript
"use client";

import { useEffect, useState } from "react";
import { collection, limit, onSnapshot, orderBy, query, Timestamp } from "firebase/firestore";
import { db } from "@/lib/firebase";
import { useAuth } from "@/context/AuthContext";

export type RechargeHistoryItem = {
  id: string;
  provider?: string;
  orderId?: string | null;
  checkoutId?: string | null;

  creditsAdded?: number;

  // si Polar renvoie des montants en cents (souvent), on stocke tel quel et on affiche /100
  amount?: number | null;
  currency?: string | null;

  status?: string | null;
  eventType?: string | null;

  productIds?: string[];
  priceIds?: string[];

  createdAt?: number; // ms
};

function toMillis(v: unknown): number | undefined {
  if (!v) return undefined;
  if (typeof v === "number") return v;
  if (v instanceof Date) return v.getTime();
  if (typeof v === "object" && (v as any).toMillis) return (v as Timestamp).toMillis();
  return undefined;
}

export function useRechargeHistory(maxItems = 30) {
  const { user } = useAuth();
  const [items, setItems] = useState<RechargeHistoryItem[]>([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    if (!user?.uid) {
      setItems([]);
      setLoading(false);
      setError(null);
      return;
    }

    setLoading(true);

    const q = query(
      collection(db, "users", user.uid, "rechargeHistory"),
      orderBy("createdAt", "desc"),
      limit(maxItems)
    );

    const unsub = onSnapshot(
      q,
      (snap) => {
        const list = snap.docs.map((d) => {
          const data = d.data() as any;
          return {
            id: d.id,
            ...data,
            createdAt: toMillis(data.createdAt),
          } as RechargeHistoryItem;
        });
        setItems(list);
        setLoading(false);
      },
      (e) => {
        console.error("useRechargeHistory:", e);
        setError(e?.message || "Erreur chargement historique");
        setLoading(false);
      }
    );

    return () => unsub();
  }, [user?.uid, maxItems]);

  return { items, loading, error };
}
````

## File: hooks/useUserCredits.ts
````typescript
"use client";

import { useEffect, useState } from "react";
import { doc, onSnapshot } from "firebase/firestore";
import { db } from "@/lib/firebase";
import { useAuth } from "@/context/AuthContext";

type CreditsState = {
  credits: number;
  loading: boolean;
  error: string | null;
};

export function useUserCredits(): CreditsState {
  const { user } = useAuth();
  const [credits, setCredits] = useState<number>(0);
  const [loading, setLoading] = useState<boolean>(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    // reset √† chaque changement d'user
    setError(null);

    if (!user?.uid) {
      setCredits(0);
      setLoading(false);
      return;
    }

    setLoading(true);

    const ref = doc(db, "users", user.uid);

    const unsub = onSnapshot(
      ref,
      (snap) => {
        const data = snap.exists() ? (snap.data() as any) : {};
        const value = typeof data?.credits === "number" ? data.credits : 0;

        setCredits(value);
        setLoading(false);
      },
      (err) => {
        console.error("Erreur Firestore (credits):", err);
        setError("Impossible de charger les cr√©dits.");
        setLoading(false);
      }
    );

    return () => unsub();
  }, [user?.uid]);

  return { credits, loading, error };
}
````

## File: hooks/useUserProfile.ts
````typescript
"use client";

import { useEffect, useState } from "react";
import { doc, onSnapshot } from "firebase/firestore";
import { db } from "@/lib/firebase";
import { useAuth } from "@/context/AuthContext";

export interface UserProfile {
  id: string;
  email?: string | null;
  displayName?: string | null;
  credits?: number;
  blocked?: boolean;
  ip?: string | null;
  city?: string | null;
  country?: string | null;
  emailVerified?: boolean;
  lastLoginAt?: Date | null;
  lastActiveAt?: Date | null;
}

export function useUserProfile() {
  const { user } = useAuth();
  const [profile, setProfile] = useState<UserProfile | null>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    if (!user) {
      setProfile(null);
      setLoading(false);
      return;
    }

    const ref = doc(db, "users", user.uid);

    const unsub = onSnapshot(
      ref,
      (snap) => {
        if (!snap.exists()) {
          setProfile({
            id: user.uid,
            email: user.email ?? null,
            displayName: user.displayName ?? null,
          });
          setLoading(false);
          return;
        }

        const data = snap.data() as any;

        const lastLoginAt =
          data.lastLoginAt?.toDate?.() &&
          typeof data.lastLoginAt.toDate === "function"
            ? data.lastLoginAt.toDate()
            : null;

        const lastActiveAt =
          data.lastActiveAt?.toDate?.() &&
          typeof data.lastActiveAt.toDate === "function"
            ? data.lastActiveAt.toDate()
            : null;

        const profile: UserProfile = {
          id: snap.id,
          email: data.email ?? user.email ?? null,
          displayName: data.displayName ?? user.displayName ?? null,
          credits:
            typeof data.credits === "number"
              ? data.credits
              : data.credits
              ? Number(data.credits)
              : undefined,
          blocked: data.blocked === true,
          ip: data.ip ?? null,
          city: data.city ?? null,
          country: data.country ?? null,
          emailVerified:
            typeof data.emailVerified === "boolean"
              ? data.emailVerified
              : user.emailVerified ?? false,
          lastLoginAt,
          lastActiveAt,
        };

        setProfile(profile);
        setLoading(false);
      },
      (error) => {
        console.error("Erreur onSnapshot user profile:", error);
        setProfile(null);
        setLoading(false);
      }
    );

    return () => unsub();
  }, [user]);

  return { profile, loading };
}
````

## File: lib/pdf/templates/cvAts.ts
````typescript
// src/lib/pdf/templates/cvAts.ts
import type { PdfColors } from "../colors";

export type CvDocModel = {
  name: string;
  title: string;
  contactLine: string;
  profile: string;

  skills: {
    cloud?: string[];
    sec?: string[];
    sys?: string[];
    auto?: string[];
    tools?: string[];
    soft?: string[];
  };

  xp: Array<{
    company: string;
    city?: string;
    role: string;
    dates: string;
    bullets: string[];
  }>;

  education: string[];
  certs?: string;
  langLine?: string;
  hobbies?: string[];
};

function stripMd(s: string) {
  return String(s || "")
    .replace(/\*\*(.*?)\*\*/g, "$1")
    .replace(/\*(.*?)\*/g, "$1")
    .replace(/`(.*?)`/g, "$1")
    .replace(/\[(.*?)\]\(.*?\)/g, "$1")
    .trim();
}

function cleanBullet(s: string) {
  return stripMd(s).replace(/^[‚Ä¢\-‚Äì]\s*/, "").trim();
}

function smartCompactProfile(profile: string, est: number) {
  const p = stripMd(profile);
  // petit ‚Äúcompact‚Äù si beaucoup de contenu (m√™me id√©e que ton HTML auto) :contentReference[oaicite:3]{index=3}
  if (est > 3600 && p.length > 420) return p.slice(0, 420).replace(/\s+\S*$/, "‚Ä¶");
  if (est > 3000 && p.length > 480) return p.slice(0, 480).replace(/\s+\S*$/, "‚Ä¶");
  return p;
}

// CV A4 1 page ‚Äî style auto/compact/expanded + scale (zoom global)
export function buildCvAtsPdf(
  cv: CvDocModel,
  lang: "fr" | "en",
  colors: PdfColors,
  styleMode: "auto" | "compact" | "expanded" = "auto",
  scale = 1
) {
  const est =
    (cv.profile?.length || 0) +
    (cv.certs?.length || 0) +
    (cv.langLine?.length || 0) +
    (cv.hobbies || []).join(" ").length +
    (cv.education || []).join(" ").length +
    (cv.xp || [])
      .map((x) => (x.role || "") + (x.company || "") + (x.city || "") + (x.dates || "") + (x.bullets || []).join(" "))
      .join(" ").length +
    Object.values(cv.skills || {})
      .flat()
      .join(" ").length;

  let fontSize: number, headSize: number, titleSize: number, lineH: number, margins: number[];

  if (styleMode === "compact") {
    fontSize = 9.0; headSize = 18.0; titleSize = 11.8; lineH = 1.04; margins = [16, 12, 16, 12];
  } else if (styleMode === "expanded") {
    fontSize = 11.4; headSize = 22.5; titleSize = 15.2; lineH = 1.26; margins = [30, 26, 30, 28];
  } else {
    if (est < 1900) { fontSize = 11.4; headSize = 22.5; titleSize = 15.2; lineH = 1.26; margins = [30, 26, 30, 28]; }
    else if (est < 2200) { fontSize = 11.1; headSize = 22.0; titleSize = 14.8; lineH = 1.22; margins = [28, 24, 28, 26]; }
    else if (est < 2600) { fontSize = 10.8; headSize = 21.2; titleSize = 14.4; lineH = 1.18; margins = [26, 22, 26, 24]; }
    else if (est < 3000) { fontSize = 10.5; headSize = 20.6; titleSize = 14.0; lineH = 1.15; margins = [24, 20, 24, 22]; }
    else if (est < 3400) { fontSize = 10.1; headSize = 19.8; titleSize = 13.4; lineH = 1.12; margins = [22, 18, 22, 18]; }
    else if (est < 3800) { fontSize = 9.8; headSize = 19.2; titleSize = 12.8; lineH = 1.08; margins = [20, 16, 20, 16]; }
    else if (est < 4300) { fontSize = 9.4; headSize = 18.6; titleSize = 12.4; lineH = 1.06; margins = [18, 14, 18, 14]; }
    else { fontSize = 9.0; headSize = 18.0; titleSize = 11.8; lineH = 1.04; margins = [16, 12, 16, 12]; }
  }

  // zoom global
  fontSize = +(fontSize * scale).toFixed(2);
  headSize = +(headSize * scale).toFixed(2);
  titleSize = +(titleSize * scale).toFixed(2);
  lineH = +(1 + (lineH - 1) * (0.8 + 0.2 * scale)).toFixed(3);
  margins = margins.map((m) => Math.max(12, Math.round(m * (0.95 + 0.05 * scale))));

  const profileText = smartCompactProfile(cv.profile, est);

  const H = (t: string) => ({
    text: t,
    color: colors.brand,
    bold: true,
    fontSize: Math.max(10.6, fontSize + 0.6),
    margin: [0, 6, 0, 3],
  });

  const thin = {
    canvas: [{ type: "line", x1: 0, y1: 0, x2: 515, y2: 0, lineWidth: 0.7, lineColor: colors.border }],
    margin: [0, 2, 0, 6],
  };

  const s = cv.skills || {};
  const skillsGrid = {
    columns: [
      {
        width: "*",
        stack: [
          { text: lang === "fr" ? "Architecture & Cloud" : "Architecture & Cloud", bold: true, color: colors.muted, margin: [0, 0, 0, 1] },
          { text: (s.cloud || []).join(", "), alignment: "justify" },

          { text: lang === "fr" ? "Cybers√©curit√©" : "Cybersecurity", bold: true, color: colors.muted, margin: [0, 5, 0, 1] },
          { text: (s.sec || []).join(", "), alignment: "justify" },

          { text: lang === "fr" ? "Soft skills" : "Soft skills", bold: true, color: colors.muted, margin: [0, 5, 0, 1] },
          { text: (s.soft || []).join(", "), alignment: "justify" },
        ],
      },
      {
        width: "*",
        stack: [
          { text: lang === "fr" ? "Syst√®mes & R√©seaux" : "Systems & Networks", bold: true, color: colors.muted, margin: [0, 0, 0, 1] },
          { text: (s.sys || []).join(", "), alignment: "justify" },

          { text: lang === "fr" ? "Automatisation & Outils (IA/API)" : "Automation & Tools (AI/API)", bold: true, color: colors.muted, margin: [0, 5, 0, 1] },
          { text: ([...(s.auto || []), ...(s.tools || [])]).join(", "), alignment: "justify" },
        ],
      },
    ],
    columnGap: 14,
  };

  function xpBlock(x: CvDocModel["xp"][number]) {
    const header = {
      text: `${x.company}${x.city ? " ‚Äî " + x.city : ""} ‚Äî ${x.role} | ${x.dates}`,
      margin: [0, 0.5, 0, 1],
      bold: true,
    };
    const bullets = (x.bullets || []).map((b) => ({
      text: `- ${cleanBullet(b)}`,
      margin: [0, 0, 0, 0.4],
      alignment: "justify",
    }));
    return [header, ...bullets];
  }

  const content: any[] = [
    { text: cv.name, fontSize: headSize, bold: true, alignment: "center", margin: [0, 0, 0, 0] },
    { text: cv.title, fontSize: titleSize, color: colors.brand, bold: true, alignment: "center", margin: [0, 1, 0, 3] },
    { text: stripMd(cv.contactLine), bold: true, margin: [0, 0, 0, 4], alignment: "center" },
    thin,

    H(lang === "fr" ? "Profil" : "Profile"),
    { text: profileText, margin: [0, 0, 0, 2], alignment: "justify" },

    H(lang === "fr" ? "Comp√©tences cl√©s" : "Key Skills"),
    skillsGrid,

    H(lang === "fr" ? "Exp√©riences professionnelles" : "Professional Experience"),
    ...(cv.xp || []).flatMap(xpBlock),

    H(lang === "fr" ? "Formation" : "Education"),
    { ul: (cv.education || []).map((e) => stripMd(e)), margin: [0, 0, 0, 1] },

    H(lang === "fr" ? "Certifications" : "Certifications"),
    { text: stripMd(cv.certs || ""), margin: [0, 0, 0, 1], alignment: "justify" },

    H(lang === "fr" ? "Langues" : "Languages"),
    { text: stripMd(cv.langLine || "") },
  ];

  if (Array.isArray(cv.hobbies) && cv.hobbies.length) {
    content.push(H(lang === "fr" ? "Centres d‚Äôint√©r√™t / Hobbies" : "Interests"));
    content.push({ text: cv.hobbies.join(" ‚Ä¢ "), margin: [0, 0, 0, 1] });
  }

  return {
    pageSize: "A4",
    pageMargins: margins,
    defaultStyle: { font: "Roboto", fontSize, lineHeight: lineH, color: colors.ink },
    content,
  };
}
````

## File: lib/pdf/templates/cvTemplates.ts
````typescript
// src/lib/pdf/templates/cvTemplates.ts
import { buildCvAtsPdf, type CvDocModel } from "@/lib/pdf/templates/cvAts";

export type Lang = "fr" | "en";

export type CvTemplateId =
  | "ats"
  | "classic"
  | "modern"
  | "minimalist"
  | "creative"
  | "elegant"
  | "tech"
  | "pro_max";

export type PdfColorsLike = Record<string, string | undefined> & {
  brand?: string;
  ink?: string;
  muted?: string;
  line?: string;
  bg?: string;
  bgSoft?: string;
  white?: string;
};

export type CvTemplateMeta = {
  id: CvTemplateId;
  label: string;
  description: string;
  previewSrc: string; // ex: "/cv-templates/cv-template-modern.png"
  badge?: string;
};

// ----------------------------------------------------
// Liste des templates disponibles (UI)
// ----------------------------------------------------

export const CV_TEMPLATES: CvTemplateMeta[] = [
  {
    id: "ats",
    label: "ATS (Standard)",
    description: "Template 1 colonne tr√®s lisible, optimis√© pour les ATS.",
    previewSrc: "/cv-templates/cv-template-ats.png",
    badge: "Recommand√©",
  },
  {
    id: "classic",
    label: "Classic (Sidebar)",
    description: "Colonne lat√©rale, structure pro et lisible.",
    previewSrc: "/cv-templates/cv-template-classic.png",
  },
  {
    id: "modern",
    label: "Modern (Design)",
    description: "Header moderne, blocs a√©r√©s, id√©al profils tech/produit.",
    previewSrc: "/cv-templates/cv-template-modern.png",
  },
  {
    id: "minimalist",
    label: "Minimalist",
    description: "CV ultra √©pur√©, typographie clean, parfait pour cabinets.",
    previewSrc: "/cv-templates/cv-template-minimalist.png",
  },
  {
    id: "creative",
    label: "Creative",
    description: "Mise en page en cartes / blocs, look plus dynamique.",
    previewSrc: "/cv-templates/cv-template-creative.png",
  },
  {
    id: "elegant",
    label: "Elegant",
    description: "Style plus premium, hi√©rarchie douce, tr√®s corporate.",
    previewSrc: "/cv-templates/cv-template-elegant.png",
  },
  {
    id: "tech",
    label: "Tech (Dark)",
    description: "Palette sombre, vibe engineering / cybers√©curit√©.",
    previewSrc: "/cv-templates/cv-template-tech.png",
  },
  {
    id: "pro_max",
    label: "Pro Max",
    description: "Version premium inspir√©e des CV design (header fort, cartes).",
    previewSrc: "/cv-templates/cv-template-pro-max.png",
    badge: "Nouveau",
  },
];

// utilis√© par l‚ÄôUI
export function getCvTemplates(): CvTemplateMeta[] {
  return CV_TEMPLATES;
}

// ----------------------------------------------------
// Helpers g√©n√©riques
// ----------------------------------------------------

function normLang(lang: Lang): Lang {
  return lang === "en" ? "en" : "fr";
}

function clamp(value: number, min: number, max: number): number {
  return Math.min(max, Math.max(min, value));
}

function safeText(v: unknown): string {
  return String(v ?? "")
    .replace(/\u00A0/g, " ")
    .trim();
}

function pick(colors: PdfColorsLike | undefined, key: keyof PdfColorsLike, fallback: string): string {
  if (!colors) return fallback;
  const v = colors[key];
  return typeof v === "string" && v ? v : fallback;
}

function joinDot(list: string[] | undefined, maxChars = 80): string {
  const arr = Array.isArray(list)
    ? list.map((s: string) => safeText(s)).filter(Boolean)
    : [];

  if (!arr.length) return "‚Äî";

  const out: string[] = [];
  let used = 0;

  for (const item of arr) {
    const extra = (out.length ? 3 : 0) + item.length; // " ‚Ä¢ "
    if (out.length && used + extra > maxChars) break;
    out.push(item);
    used += extra;
  }

  return out.join(" ‚Ä¢ ");
}

function hr(scale: number, color: string) {
  return {
    canvas: [
      {
        type: "line",
        x1: 0,
        y1: 0,
        x2: 515,
        y2: 0,
        lineWidth: 0.6,
        lineColor: color,
      },
    ],
    margin: [0, 4 * scale, 0, 4 * scale],
  };
}

function sectionTitle(label: string, scale: number, color: string) {
  return {
    text: label,
    fontSize: 10.5 * scale,
    bold: true,
    color,
    margin: [0, 4 * scale, 0, 3 * scale],
  };
}

function collectSkills(model: CvDocModel): string[] {
  const s: any = (model as any).skills || {};
  const keys = ["cloud", "sec", "sys", "auto", "tools", "soft"];
  const out: string[] = [];

  for (const key of keys) {
    const value = s[key];
    if (Array.isArray(value)) {
      for (const item of value as string[]) {
        const txt = safeText(item);
        if (txt) out.push(txt);
      }
    }
  }

  return out;
}

function renderXp(model: CvDocModel, scale: number, ink: string, muted: string) {
  const xpRaw: unknown = (model as any).xp;
  const xpArr: CvDocModel["xp"] = Array.isArray(xpRaw) ? (xpRaw as CvDocModel["xp"]) : [];

  if (!xpArr.length) {
    return [
      {
        text: "‚Äî",
        fontSize: 9 * scale,
        color: muted,
      },
    ];
  }

  return xpArr.map((x: CvDocModel["xp"][number]) => {
    const titleParts: string[] = [];
    if (x.role) titleParts.push(safeText(x.role));
    if (x.company) titleParts.push(safeText(x.company));
    const title = titleParts.join(" ‚Äî ") || "‚Äî";

    const metaParts: string[] = [];
    if (x.city) metaParts.push(safeText(x.city));
    if (x.dates) metaParts.push(safeText(x.dates));
    const meta = metaParts.join(" ‚Ä¢ ");

    const bulletsRaw: unknown = x.bullets;
    const bullets: string[] = Array.isArray(bulletsRaw)
      ? (bulletsRaw as string[]).map((b: string) => safeText(b)).filter(Boolean)
      : [];

    const stack: any[] = [
      {
        text: title,
        fontSize: 9.8 * scale,
        bold: true,
        color: ink,
        margin: [0, 0, 0, 1.5 * scale],
      },
    ];

    if (meta) {
      stack.push({
        text: meta,
        fontSize: 9 * scale,
        color: muted,
        margin: [0, 0, 0, 2 * scale],
      });
    }

    if (bullets.length) {
      stack.push({
        ul: bullets,
        fontSize: 9 * scale,
        color: ink,
        margin: [0, 0, 0, 4 * scale],
      });
    }

    return { stack };
  });
}

function renderEducation(model: CvDocModel, scale: number, ink: string, muted: string) {
  const eduRaw: unknown = (model as any).education;
  let eduArr: string[] = [];

  if (Array.isArray(eduRaw)) {
    eduArr = (eduRaw as unknown as string[]).map((v: string) => safeText(v)).filter(Boolean);
  } else {
    const one = safeText(eduRaw);
    if (one) {
      eduArr = one
        .split("\n")
        .map((l: string) => l.trim())
        .filter(Boolean);
    }
  }

  if (!eduArr.length) {
    return [
      {
        text: "‚Äî",
        fontSize: 9 * scale,
        color: muted,
      },
    ];
  }

  return eduArr.slice(0, 4).map((line: string) => ({
    text: line,
    fontSize: 9 * scale,
    color: ink,
    margin: [0, 0, 0, 4 * scale],
  }));
}

// ----------------------------------------------------
// Base docDefinition
// ----------------------------------------------------

function baseDocDefinition(
  _model: CvDocModel,
  colors: PdfColorsLike,
  scale: number,
  pageMargins: [number, number, number, number]
) {
  const brand = pick(colors, "brand", "#2563eb");
  const ink = pick(colors, "ink", "#111827");
  const muted = pick(colors, "muted", "#6b7280");
  const line = pick(colors, "line", "#e5e7eb");
  const bgSoft = pick(colors, "bgSoft", "#f3f4f6");
  const white = pick(colors, "white", "#ffffff");

  return {
    pageSize: "A4",
    pageMargins,
    defaultStyle: { font: "Roboto", fontSize: 10 * scale, color: ink },
    styles: {
      name: { fontSize: 18 * scale, bold: true, color: ink },
      title: { fontSize: 11 * scale, bold: true, color: brand },
      contact: { fontSize: 9 * scale, color: muted },
      section: { fontSize: 10.5 * scale, bold: true, color: ink },
      small: { fontSize: 9 * scale, color: muted },
    },
    _palette: { brand, ink, muted, line, bgSoft, white },
    content: [] as any[],
  } as any;
}

// ----------------------------------------------------
// Templates
// ----------------------------------------------------

function buildClassic(model: CvDocModel, lang: Lang, colors: PdfColorsLike, scale: number) {
  const L = normLang(lang);
  const brand = pick(colors, "brand", "#ef4444");
  const ink = pick(colors, "ink", "#111827");
  const muted = pick(colors, "muted", "#6b7280");
  const line = pick(colors, "line", "#e5e7eb");

  const doc = baseDocDefinition(model, colors, scale, [
    34 * scale,
    30 * scale,
    34 * scale,
    26 * scale,
  ]);

  const leftWidth = 170 * scale;

  const skills = collectSkills(model);

  (doc.content as any[]).push({
    columns: [
      {
        width: leftWidth,
        stack: [
          {
            text: safeText(model.name),
            style: "name",
          },
          {
            text: safeText((model as any).title),
            style: "title",
            margin: [0, 2 * scale, 0, 0],
          },
          {
            text: safeText((model as any).contactLine ?? (model as any).contact),
            style: "contact",
            margin: [0, 6 * scale, 0, 8 * scale],
          },
          hr(scale, line),

          sectionTitle(L === "en" ? "Skills" : "Comp√©tences", scale, ink),
          {
            text: joinDot(skills, 120),
            fontSize: 9 * scale,
            color: muted,
            margin: [0, 2 * scale, 0, 6 * scale],
          },

          sectionTitle(L === "en" ? "Languages" : "Langues", scale, ink),
          {
            text: safeText((model as any).langLine),
            fontSize: 9 * scale,
            color: muted,
            margin: [0, 2 * scale, 0, 6 * scale],
          },

          sectionTitle(L === "en" ? "Interests" : "Centres d‚Äôint√©r√™t", scale, ink),
          {
            text: joinDot((model as any).hobbies as string[] | undefined, 120),
            fontSize: 9 * scale,
            color: muted,
            margin: [0, 2 * scale, 0, 0],
          },
        ],
      },
      {
        width: "*",
        stack: [
          sectionTitle(L === "en" ? "Profile" : "Profil", scale, ink),
          {
            text: safeText((model as any).profile),
            fontSize: 9.5 * scale,
            color: ink,
            margin: [0, 2 * scale, 0, 8 * scale],
            alignment: "justify",
          },

          hr(scale, line),

          sectionTitle(L === "en" ? "Experience" : "Exp√©rience professionnelle", scale, ink),
          {
            stack: renderXp(model, scale, ink, muted),
          },

          hr(scale, line),

          sectionTitle(L === "en" ? "Education" : "Formation", scale, ink),
          {
            stack: renderEducation(model, scale, ink, muted),
          },

          sectionTitle(L === "en" ? "Certifications" : "Certifications", scale, ink),
          {
            text: safeText((model as any).certs),
            fontSize: 9 * scale,
            color: ink,
            margin: [0, 2 * scale, 0, 0],
          },
        ],
      },
    ],
    columnGap: 18 * scale,
  });

  return doc;
}

function buildModern(model: CvDocModel, lang: Lang, colors: PdfColorsLike, scale: number) {
  const L = normLang(lang);
  const brand = pick(colors, "brand", "#2563eb");
  const ink = pick(colors, "ink", "#0f172a");
  const muted = pick(colors, "muted", "#6b7280");
  const line = pick(colors, "line", "#e5e7eb");
  const bgSoft = pick(colors, "bgSoft", "#eff6ff");

  const doc = baseDocDefinition(model, colors, scale, [
    30 * scale,
    28 * scale,
    30 * scale,
    28 * scale,
  ]);

  const skills = collectSkills(model);

  (doc.content as any[]).push(
    {
      // Header bande color√©e
      table: {
        widths: ["*", "*"],
        body: [
          [
            {
              stack: [
                {
                  text: safeText(model.name),
                  fontSize: 20 * scale,
                  bold: true,
                  color: ink,
                },
                {
                  text: safeText((model as any).title),
                  fontSize: 11 * scale,
                  bold: true,
                  color: brand,
                  margin: [0, 2 * scale, 0, 0],
                },
              ],
            },
            {
              stack: [
                {
                  text: safeText((model as any).contactLine ?? (model as any).contact),
                  fontSize: 9 * scale,
                  color: muted,
                  alignment: "right",
                },
                {
                  text: safeText((model as any).langLine),
                  fontSize: 9 * scale,
                  color: muted,
                  alignment: "right",
                  margin: [0, 2 * scale, 0, 0],
                },
              ],
            },
          ],
        ],
      },
      layout: "noBorders",
      fillColor: bgSoft,
      margin: [-6 * scale, -6 * scale, -6 * scale, 10 * scale],
    },

    {
      columns: [
        {
          width: "*",
          stack: [
            sectionTitle(L === "en" ? "Profile" : "Profil", scale, ink),
            {
              text: safeText((model as any).profile),
              fontSize: 9.5 * scale,
              color: ink,
              margin: [0, 2 * scale, 0, 6 * scale],
              alignment: "justify",
            },

            sectionTitle(L === "en" ? "Experience" : "Exp√©rience", scale, ink),
            {
              stack: renderXp(model, scale, ink, muted),
            },
          ],
        },
        {
          width: 180 * scale,
          margin: [16 * scale, 0, 0, 0],
          stack: [
            sectionTitle(L === "en" ? "Key Skills" : "Comp√©tences cl√©s", scale, ink),
            {
              text: joinDot(skills, 140),
              fontSize: 9 * scale,
              color: muted,
              margin: [0, 2 * scale, 0, 6 * scale],
            },

            sectionTitle(L === "en" ? "Education" : "Formation", scale, ink),
            {
              stack: renderEducation(model, scale, ink, muted),
            },

            sectionTitle(L === "en" ? "Certifications" : "Certifications", scale, ink),
            {
              text: safeText((model as any).certs),
              fontSize: 9 * scale,
              color: muted,
              margin: [0, 2 * scale, 0, 6 * scale],
            },

            sectionTitle(L === "en" ? "Interests" : "Centres d‚Äôint√©r√™t", scale, ink),
            {
              text: joinDot((model as any).hobbies as string[] | undefined, 140),
              fontSize: 9 * scale,
              color: muted,
            },
          ],
        },
      ],
      columnGap: 18 * scale,
    }
  );

  return doc;
}

function buildMinimalist(model: CvDocModel, lang: Lang, colors: PdfColorsLike, scale: number) {
  const L = normLang(lang);
  const ink = pick(colors, "ink", "#111827");
  const muted = pick(colors, "muted", "#6b7280");
  const line = pick(colors, "line", "#e5e7eb");

  const doc = baseDocDefinition(model, colors, scale, [
    40 * scale,
    32 * scale,
    40 * scale,
    32 * scale,
  ]);

  const skills = collectSkills(model);

  (doc.content as any[]).push(
    {
      text: safeText(model.name),
      fontSize: 20 * scale,
      bold: true,
      color: ink,
      margin: [0, 0, 0, 2 * scale],
    },
    {
      text: safeText((model as any).title),
      fontSize: 11 * scale,
      color: muted,
      margin: [0, 0, 0, 4 * scale],
    },
    {
      text: safeText((model as any).contactLine ?? (model as any).contact),
      fontSize: 9 * scale,
      color: muted,
      margin: [0, 0, 0, 8 * scale],
    },
    hr(scale, line),
    sectionTitle(L === "en" ? "Profile" : "Profil", scale, ink),
    {
      text: safeText((model as any).profile),
      fontSize: 9.5 * scale,
      color: ink,
      margin: [0, 2 * scale, 0, 6 * scale],
      alignment: "justify",
    },
    sectionTitle(L === "en" ? "Experience" : "Exp√©rience", scale, ink),
    {
      stack: renderXp(model, scale, ink, muted),
      margin: [0, 0, 0, 4 * scale],
    },
    sectionTitle(L === "en" ? "Education" : "Formation", scale, ink),
    {
      stack: renderEducation(model, scale, ink, muted),
    },
    sectionTitle(L === "en" ? "Skills" : "Comp√©tences", scale, ink),
    {
      text: joinDot(skills, 160),
      fontSize: 9 * scale,
      color: muted,
      margin: [0, 2 * scale, 0, 4 * scale],
    },
    sectionTitle(L === "en" ? "Languages" : "Langues", scale, ink),
    {
      text: safeText((model as any).langLine),
      fontSize: 9 * scale,
      color: muted,
      margin: [0, 2 * scale, 0, 4 * scale],
    },
    sectionTitle(L === "en" ? "Interests" : "Centres d‚Äôint√©r√™t", scale, ink),
    {
      text: joinDot((model as any).hobbies as string[] | undefined, 160),
      fontSize: 9 * scale,
      color: muted,
    }
  );

  return doc;
}

// pour l‚Äôinstant, on r√©utilise les layouts existants
function buildCreative(model: CvDocModel, lang: Lang, colors: PdfColorsLike, scale: number) {
  // Style plus "design" : on r√©utilise Modern (tu pourras raffiner plus tard)
  return buildModern(model, lang, colors, scale);
}

function buildElegant(model: CvDocModel, lang: Lang, colors: PdfColorsLike, scale: number) {
  // Style premium mais sobre : on part du Classic
  return buildClassic(model, lang, colors, scale);
}

function buildTech(model: CvDocModel, lang: Lang, colors: PdfColorsLike, scale: number) {
  // Palette plus sombre pour un look "tech"
  const overridden: PdfColorsLike = {
    ...colors,
    brand: colors.brand || "#22c55e",
    ink: colors.ink || "#f9fafb",
    muted: colors.muted || "#94a3b8",
    bgSoft: colors.bgSoft || "#020617",
    line: colors.line || "#1e293b",
  };
  return buildModern(model, lang, overridden, scale);
}

function buildProMax(model: CvDocModel, lang: Lang, colors: PdfColorsLike, scale: number) {
  // Version "premium" bas√©e sur Modern, avec l√©ger zoom
  const overridden: PdfColorsLike = {
    ...colors,
    brand: colors.brand || "#0ea5e9",
  };
  const boostedScale = clamp(scale * 1.02, 0.75, 1.6);
  return buildModern(model, lang, overridden, boostedScale);
}

// ----------------------------------------------------
// Public API
// ----------------------------------------------------

export function buildCvPdf(
  templateId: CvTemplateId,
  model: CvDocModel,
  lang: Lang,
  colors: PdfColorsLike,
  layout: "auto" | "tight" | "spacious" = "auto",
  scale = 1
) {
  const L = normLang(lang);

  // mapping layout -> styleMode attendu par buildCvAtsPdf
  const styleMode: "auto" | "compact" | "expanded" =
    layout === "tight" ? "compact" : layout === "spacious" ? "expanded" : "auto";

  // ATS = ton template existant
  if (templateId === "ats") {
    return buildCvAtsPdf(model, L, colors as any, styleMode, scale);
  }

  // ajustement global de l‚Äô√©chelle selon layout
  const mul = layout === "tight" ? 0.92 : layout === "spacious" ? 1.08 : 1.0;
  const s = clamp(scale * mul, 0.75, 1.6);

  switch (templateId) {
    case "classic":
      return buildClassic(model, L, colors, s);
    case "modern":
      return buildModern(model, L, colors, s);
    case "minimalist":
      return buildMinimalist(model, L, colors, s);
    case "creative":
      return buildCreative(model, L, colors, s);
    case "elegant":
      return buildElegant(model, L, colors, s);
    case "tech":
      return buildTech(model, L, colors, s);
    case "pro_max":
      return buildProMax(model, L, colors, s);
    default:
      // fallback safe
      return buildClassic(model, L, colors, s);
  }
}
````

## File: lib/pdf/templates/types.ts
````typescript
// src/lib/pdf/templates/types.ts
export type Lang = "fr" | "en";

export type CvDocModel = {
  name: string;
  title: string;
  contact: string; // "Paris | +33... | mail | linkedin"
  profile: string;

  skills: {
    cloud?: string[];
    sec?: string[];
    sys?: string[];
    auto?: string[];
    tools?: string[];
    soft?: string[];
  };

  xp: Array<{
    company: string;
    city?: string;
    role: string;
    dates: string;
    bullets: string[];
  }>;

  education: string[];
  certs: string;
  langLine: string;
  hobbies?: string[];
};

export type LmModel = {
  lang: Lang;
  name: string;
  contactLines: string[]; // ["T√©l√©phone: ...", "Email: ..."]
  service: string;
  companyName: string;
  companyAddr?: string; // multi-line
  city: string;
  dateStr: string;
  aPrefix: string; // "√Ä " (FR) / "At " (EN)
  subject: string;
  salutation: string;
  body: string; // paragraphes s√©par√©s par \n\n
  closing: string;
  signature: string;
};
````

## File: lib/pdf/colors.ts
````typescript
// lib/pdf/colors.ts
export type PdfColors = {
  brand: string;
  brandDark: string;
  ink: string;
  muted: string;
  border: string;
  bgSoft: string;
  hair: string; // ‚úÖ requis par letter.ts
};

function clamp(n: number, a: number, b: number) {
  return Math.max(a, Math.min(b, n));
}

function normalizeHex(hex: string) {
  let h = (hex || "").trim();
  if (!h.startsWith("#")) h = `#${h}`;
  if (h.length === 4) {
    // #RGB -> #RRGGBB
    h = `#${h[1]}${h[1]}${h[2]}${h[2]}${h[3]}${h[3]}`;
  }
  if (!/^#[0-9a-fA-F]{6}$/.test(h)) return "#2563eb";
  return h.toLowerCase();
}

function hexToRgb(hex: string) {
  const h = normalizeHex(hex).slice(1);
  return {
    r: parseInt(h.slice(0, 2), 16),
    g: parseInt(h.slice(2, 4), 16),
    b: parseInt(h.slice(4, 6), 16),
  };
}

function rgbToHex(r: number, g: number, b: number) {
  const to = (x: number) =>
    clamp(Math.round(x), 0, 255).toString(16).padStart(2, "0");
  return `#${to(r)}${to(g)}${to(b)}`;
}

function darken(hex: string, amount = 28) {
  const { r, g, b } = hexToRgb(hex);
  return rgbToHex(r - amount, g - amount, b - amount);
}

export function makePdfColors(brandHex: string): PdfColors {
  const brand = normalizeHex(brandHex);
  return {
    brand,
    brandDark: darken(brand, 28),

    ink: "#0f172a", // slate-900
    muted: "#475569", // slate-600
    border: "#e2e8f0", // slate-200
    bgSoft: "#f1f5f9", // slate-100
    hair: "#cbd5e1", // slate-300 (ligne fine)
  };
}
````

## File: lib/pdf/fitOnePage.ts
````typescript
// src/lib/pdf/fitOnePage.ts
import { PDFDocument } from "pdf-lib";
import { pdfMakeToBlob } from "./pdfmakeClient";

export async function countPdfPages(blob: Blob): Promise<number> {
  const ab = await blob.arrayBuffer();
  const pdf = await PDFDocument.load(ab);
  return pdf.getPageCount();
}

export async function fitOnePage(
  buildDoc: (scale: number) => any,
  opts?: { min?: number; max?: number; iterations?: number; initial?: number }
): Promise<{ blob: Blob; bestScale: number }> {
  const min = opts?.min ?? 0.8;
  const max = opts?.max ?? 1.6;
  const iterations = opts?.iterations ?? 8;
  const initial = opts?.initial ?? 1.0;

  let low = min;
  let high = max;

  // test initial
  let bestBlob: Blob | null = null;
  let bestScale = initial;

  let testBlob = await pdfMakeToBlob(buildDoc(initial));
  let pages = await countPdfPages(testBlob);

  if (pages > 1) {
    high = initial;
  } else {
    bestBlob = testBlob;
    low = initial;
  }

  for (let i = 0; i < iterations; i++) {
    const mid = +(((low + high) / 2)).toFixed(3);
    const blob = await pdfMakeToBlob(buildDoc(mid));
    const n = await countPdfPages(blob);

    if (n > 1) {
      high = mid - 0.01;
    } else {
      bestBlob = blob;
      bestScale = mid;
      low = mid + 0.01;
    }
    if (high - low < 0.01) break;
  }

  if (!bestBlob) {
    bestBlob = await pdfMakeToBlob(buildDoc(min));
    bestScale = min;
  }

  return { blob: bestBlob, bestScale };
}
````

## File: lib/pdf/mergePdfs.ts
````typescript
// src/lib/pdf/mergePdfs.ts
import { PDFDocument } from "pdf-lib";

/**
 * Merge plusieurs PDFs (Blob) en un seul PDF (Blob).
 * Compatible Next.js / TS: √©vite le type Uint8Array<ArrayBufferLike> non accept√© par BlobPart.
 */
export async function mergePdfBlobs(blobs: Blob[]): Promise<Blob> {
  const merged = await PDFDocument.create();

  for (const b of blobs) {
    const ab = await b.arrayBuffer();
    const pdf = await PDFDocument.load(ab);

    const pages = await merged.copyPages(pdf, pdf.getPageIndices());
    for (const p of pages) merged.addPage(p);
  }

  const bytes = await merged.save();

  // ‚úÖ Cast s√ªr pour BlobPart (ArrayBuffer-backed)
  const safeBytes = new Uint8Array(bytes);

  return new Blob([safeBytes], { type: "application/pdf" });
}
````

## File: lib/server/credits.ts
````typescript
// lib/server/credits.ts
//
// VERSION DEV SANS FIRESTORE
// --------------------------
// On simule juste des cr√©dits illimit√©s pour tous les utilisateurs.
// √áa √©vite les erreurs Firebase Admin en local.
// Quand tu voudras brancher Firestore c√¥t√© serveur, tu pourras
// r√©tablir la logique avec firebase-admin ici.

type DevUser = {
  id: string;
  credits: number;
};

export async function verifyUserAndCredits(
  userId: string
): Promise<DevUser | null> {
  if (!userId) return null;

  // En DEV : tous les users sont autoris√©s, avec beaucoup de cr√©dits.
  return {
    id: userId,
    credits: 9999,
  };
}

export async function consumeCredit(
  userId: string,
  amount = 1
): Promise<void> {
  // En DEV : on ne fait rien, on log juste.
  console.log(
    `[DEV][credits] Consommation simul√©e de ${amount} cr√©dit(s) pour l'utilisateur ${userId}`
  );
}
````

## File: lib/apiClient.ts
````typescript
"use client";

import { API_BASE, tryGetRecaptchaToken } from "@/lib/recaptcha";

type JsonHeaders = Record<string, string>;

function normalizePath(path: string) {
  return (path || "").replace(/^\/+/, "");
}

function buildRecaptchaError(action: string) {
  return new Error(
    `reCAPTCHA indisponible pour l‚Äôaction "${action}". ` +
      `V√©rifie : (1) NEXT_PUBLIC_RECAPTCHA_SITE_KEY, (2) script charg√©, (3) adblock, (4) domaine autoris√© c√¥t√© Google.`
  );
}

export async function postJsonWithRecaptcha<T>(
  path: string,
  action: string,
  body: any,
  extraHeaders: JsonHeaders = {}
): Promise<T> {
  const token = await tryGetRecaptchaToken(action);
  if (!token) throw buildRecaptchaError(action);

  const res = await fetch(`${API_BASE}/${normalizePath(path)}`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-Recaptcha-Token": token,
      ...extraHeaders,
    },
    body: JSON.stringify({
      ...body,
      recaptchaToken: token, // ‚úÖ compatible avec ton backend
      recaptchaAction: action,
    }),
    cache: "no-store",
  });

  const text = await res.text();
  let data: any = null;
  try {
    data = text ? JSON.parse(text) : null;
  } catch {
    // si le backend renvoie pas du JSON
  }

  if (!res.ok) {
    const msg =
      (data && (data.error || data.message)) ||
      text ||
      `HTTP ${res.status}`;
    throw new Error(msg);
  }

  return data as T;
}

export async function postBlobWithRecaptcha(
  path: string,
  action: string,
  body: any,
  extraHeaders: JsonHeaders = {}
): Promise<Blob> {
  const token = await tryGetRecaptchaToken(action);
  if (!token) throw buildRecaptchaError(action);

  const res = await fetch(`${API_BASE}/${normalizePath(path)}`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-Recaptcha-Token": token,
      ...extraHeaders,
    },
    body: JSON.stringify({
      ...body,
      recaptchaToken: token,
      recaptchaAction: action,
    }),
    cache: "no-store",
  });

  if (!res.ok) {
    const text = await res.text().catch(() => "");
    let data: any = null;
    try {
      data = text ? JSON.parse(text) : null;
    } catch {}
    const msg =
      (data && (data.error || data.message)) ||
      text ||
      `HTTP ${res.status}`;
    throw new Error(msg);
  }

  return await res.blob();
}
````

## File: lib/auth.ts
````typescript
"use client";

import { auth } from "./firebase";
import {
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  signOut,
  updateProfile,
  sendEmailVerification,
} from "firebase/auth";

export async function signupWithEmail(
  firstName: string,
  lastName: string,
  email: string,
  password: string
) {
  const cred = await createUserWithEmailAndPassword(auth, email, password);

  await updateProfile(cred.user, {
    displayName: `${firstName} ${lastName}`.trim(),
  });

  // üëâ ICI : on laisse Firebase envoyer son email standard
  await sendEmailVerification(cred.user);

  return cred;
}

export async function loginWithEmail(email: string, password: string) {
  return signInWithEmailAndPassword(auth, email, password);
}

export async function logout() {
  return signOut(auth);
}
````

## File: lib/credits.ts
````typescript
// src/lib/credits.ts
import {
  collection,
  doc,
  getDoc,
  getDocs,
  increment,
  query,
  setDoc,
  updateDoc,
  where,
} from "firebase/firestore";
import { db } from "@/lib/firebase";

/**
 * Ajoute des cr√©dits √† un utilisateur identifi√© par son userId (document users/{userId}).
 */
export async function addCreditsToUserById(
  userId: string,
  creditsToAdd: number
): Promise<void> {
  if (!userId) {
    console.error("[credits] userId manquant");
    return;
  }
  if (!creditsToAdd || creditsToAdd <= 0) {
    console.warn("[credits] creditsToAdd <= 0, rien √† ajouter", {
      userId,
      creditsToAdd,
    });
    return;
  }

  const ref = doc(db, "users", userId);
  const snap = await getDoc(ref);

  if (!snap.exists()) {
    console.warn(
      "[credits] Doc user inexistant, cr√©ation avec cr√©dits initiaux",
      { userId, creditsToAdd }
    );
    await setDoc(ref, {
      credits: creditsToAdd,
      createdAt: new Date(),
    });
    return;
  }

  console.log("[credits] Ajout de cr√©dits par userId", { userId, creditsToAdd });

  await updateDoc(ref, {
    credits: increment(creditsToAdd),
  });
}

/**
 * Ajoute des cr√©dits √† (tous) les utilisateurs qui ont cet email.
 * Fallback si on n‚Äôa pas externalId dans l‚Äôevent Polar.
 */
export async function addCreditsToUserByEmail(
  email: string,
  creditsToAdd: number
): Promise<void> {
  if (!email) {
    console.error("[credits] email manquant");
    return;
  }
  if (!creditsToAdd || creditsToAdd <= 0) {
    console.warn("[credits] creditsToAdd <= 0, rien √† ajouter", {
      email,
      creditsToAdd,
    });
    return;
  }

  const usersCol = collection(db, "users");
  const q = query(usersCol, where("email", "==", email));
  const qs = await getDocs(q);

  if (qs.empty) {
    console.warn(
      "[credits] Aucun user trouv√© avec cet email, cr√©ation impossible",
      { email, creditsToAdd }
    );
    return;
  }

  console.log(
    "[credits] Ajout de cr√©dits par email (tous les users trouv√©s)",
    { email, creditsToAdd, count: qs.size }
  );

  const promises: Promise<any>[] = [];
  qs.forEach((docSnap) => {
    promises.push(
      updateDoc(docSnap.ref, {
        credits: increment(creditsToAdd),
      })
    );
  });

  await Promise.all(promises);
}

/**
 * Consomme des cr√©dits pour un utilisateur.
 *
 * Pour √™tre flexible avec ton code existant, cette fonction accepte :
 *  - consumeCredits(userId, 3)
 *  - consumeCredits({ userId: "xxx", amount: 3 })
 *  - consumeCredits({ userId: "xxx", credits: 3 })
 */
export async function consumeCredits(arg1: any, arg2?: any): Promise<void> {
  let userId: string | undefined;
  let toConsume = 0;

  if (typeof arg1 === "string") {
    userId = arg1;
    toConsume = typeof arg2 === "number" ? arg2 : 0;
  } else if (typeof arg1 === "object" && arg1 !== null) {
    userId = arg1.userId || arg1.uid;
    toConsume =
      arg1.amount ?? arg1.credits ?? arg1.count ?? arg1.nb ?? 0;
  }

  if (!userId || !toConsume || toConsume <= 0) {
    console.warn(
      "[credits] consumeCredits appel√© sans param√®tres valides",
      { arg1, arg2 }
    );
    return;
  }

  const ref = doc(db, "users", userId);
  const snap = await getDoc(ref);

  if (!snap.exists()) {
    console.warn(
      "[credits] user inexistant pour consumeCredits, aucun d√©bit",
      { userId }
    );
    return;
  }

  console.log("[credits] Consommation de cr√©dits", {
    userId,
    toConsume,
  });

  await updateDoc(ref, {
    credits: increment(-toConsume),
  });
}
````

## File: lib/firebaseAdmin.ts
````typescript
// lib/firebaseAdmin.ts
import admin from "firebase-admin";

if (!admin.apps.length) {
  const projectId = process.env.FIREBASE_PROJECT_ID;
  const clientEmail = process.env.FIREBASE_CLIENT_EMAIL;
  const rawPrivateKey = process.env.FIREBASE_PRIVATE_KEY;

  if (projectId && clientEmail && rawPrivateKey) {
    const privateKey = rawPrivateKey.replace(/\\n/g, "\n");
    try {
      admin.initializeApp({
        credential: admin.credential.cert({
          projectId,
          clientEmail,
          privateKey,
        }),
      });
      console.log("[firebaseAdmin] Initialis√© avec les variables d'env");
    } catch (err) {
      console.error("[firebaseAdmin] Erreur d'initialisation :", err);
    }
  } else {
    console.warn(
      "[firebaseAdmin] Variables d'env manquantes. Admin ne sera pas initialis√© (OK en DEV)."
    );
  }
}

export default admin;
````

## File: lib/firestore.ts
````typescript
import { db } from "./firebase";
import {
  collection,
  doc,
  getDoc,
  getDocs,
  setDoc,
  updateDoc,
  addDoc,
  query,
  where
} from "firebase/firestore";

// Placeholders pour tes futures fonctions Firestore (users, candidatures, etc.)
export {
  db,
  collection,
  doc,
  getDoc,
  getDocs,
  setDoc,
  updateDoc,
  addDoc,
  query,
  where
};
````

## File: lib/interviewPrompt.ts
````typescript
// lib/interviewPrompt.ts

// Canal de l'entretien : √©crit (chat) ou oral (avec micro + TTS plus tard)
export type InterviewChannel = "written" | "oral";

// Niveau de difficult√© / s√©niorit√©
export type InterviewLevel = "junior" | "intermediate" | "senior";

// √âl√©ment d'historique √©chang√© pendant l'entretien
export type HistoryItem = {
  role: "interviewer" | "candidate";
  text: string;
  createdAt?: string; // <-- IMPORTANT pour ne plus avoir createdAt en rouge
  analysis?: string | null;
};

export type BuildPromptArgs = {
  cvSummary: string;
  jobDesc: string;
  mode: string; // "mixed" | "tech" | "rh" | "hard" etc.
  level: InterviewLevel;
  channel: InterviewChannel;
  history: HistoryItem[];
  step: number;
};

/**
 * Construit le prompt envoy√© √† Gemini pour g√©n√©rer :
 * - la prochaine question
 * - l'analyse rapide de la r√©ponse pr√©c√©dente
 * - le r√©sum√© final + score quand l'IA estime avoir assez d'informations
 */
export function buildPrompt({
  cvSummary,
  jobDesc,
  mode,
  level,
  channel,
  history,
  step,
}: BuildPromptArgs): string {
  const historyText =
    history.length === 0
      ? "Aucun √©change pour le moment (d√©but d'entretien)."
      : history
          .map((h) => {
            const who =
              h.role === "interviewer" ? "INTERVIEWER" : "CANDIDAT";
            return `- [${who}] ${h.text}`;
          })
          .join("\n");

  let modeDescription = "";
  switch (mode) {
    case "tech":
      modeDescription =
        "Pose principalement des questions techniques (cloud, s√©curit√©, r√©seau, etc.).";
      break;
    case "rh":
      modeDescription =
        "Pose surtout des questions RH, motivation, soft-skills, culture d'entreprise.";
      break;
    case "hard":
      modeDescription =
        "Sois tr√®s exigeant, avec des questions difficiles, de relance et de mise en situation.";
      break;
    default:
      modeDescription =
        "M√©lange de questions techniques et RH/motivation.";
  }

  let levelDescription = "";
  switch (level) {
    case "junior":
      levelDescription =
        "Consid√®re un profil plut√¥t junior : √©value le potentiel, la motivation et les bases techniques.";
      break;
    case "intermediate":
      levelDescription =
        "Consid√®re un profil interm√©diaire : quelques ann√©es d'exp√©rience, autonomie moyenne.";
      break;
    case "senior":
      levelDescription =
        "Consid√®re un profil senior : forte expertise, autonomie, leadership possible.";
      break;
  }

  const channelDescription =
    channel === "oral"
      ? "Le candidat r√©pond √† l'oral. Les questions doivent √™tre plut√¥t courtes, conversationnelles, comme dans un vrai √©change vocal."
      : "Le candidat r√©pond √† l'√©crit via un chat. Tu peux poser des questions un peu plus d√©taill√©es mais reste concis.";

  return `
Tu joues le r√¥le d'un recruteur humain qui fait passer un entretien d'embauche en fran√ßais.

Contexte candidat (r√©sum√© de CV) :
${cvSummary || "Non renseign√©."}

Contexte poste (fiche de poste / offre) :
${jobDesc || "Non renseign√©."}

Mode d'entretien : ${mode}
${modeDescription}

Niveau d'entretien : ${level}
${levelDescription}

Canal : ${channel}
${channelDescription}

√âtape actuelle de l'entretien : ${step}
Historique des √©changes (du plus ancien au plus r√©cent) :
${historyText}

OBJECTIF :
- Poser des questions pertinentes par rapport au poste et au profil.
- √ätre honn√™te et exigeant sur la compatibilit√© avec la fiche de poste.
- Quand tu estimes avoir assez d'informations, produire un r√©sum√© final d√©taill√© + un score global de compatibilit√© sur 100.

‚ö†Ô∏è TR√àS IMPORTANT : FORMAT DE R√âPONSE OBLIGATOIRE ‚ö†Ô∏è
Tu dois r√©pondre STRICTEMENT en JSON valide, sans texte autour, sans Markdown, sans commentaires, sans \`\`\`.

Format exact attendu :

{
  "next_question": string | null,
  "short_analysis": string | null,
  "final_summary": string | null,
  "final_score": number | null
}

R√®gles :
- Tant que l'entretien continue :
  - "next_question" = la prochaine question √† poser au candidat (en fran√ßais).
  - "short_analysis" = une analyse tr√®s courte (2-3 phrases max) de la derni√®re r√©ponse du candidat.
  - "final_summary" = null
  - "final_score" = null
- Quand tu estimes que l'entretien est termin√© :
  - "next_question" = null
  - "short_analysis" = une courte phrase de conclusion si tu veux
  - "final_summary" = un r√©sum√© structur√© de la performance du candidat, points forts / points faibles, recommandation (oui / non / √† voir).
  - "final_score" = un nombre entier de 0 √† 100 repr√©sentant la compatibilit√© globale avec la fiche de poste.

Ta r√©ponse DOIT √™tre un JSON pur, directement parsable par JSON.parse en JavaScript.
  `.trim();
}
````

## File: lib/ipLocation.ts
````typescript
// lib/ipLocation.ts
// R√©cup√®re IP + pays + ville c√¥t√© client, avec un petit cache en sessionStorage

export type ClientLocation = {
  ip: string | null;
  country: string | null;
  city: string | null;
};

let inMemoryLocation: ClientLocation | null = null;
let inFlightPromise: Promise<ClientLocation | null> | null = null;

function loadFromSession(): ClientLocation | null {
  if (typeof window === "undefined") return null;
  try {
    const raw = window.sessionStorage.getItem("smartcv_location_cache");
    if (!raw) return null;
    const parsed = JSON.parse(raw);
    if (
      typeof parsed === "object" &&
      parsed !== null &&
      "ip" in parsed &&
      "country" in parsed &&
      "city" in parsed
    ) {
      return parsed as ClientLocation;
    }
  } catch {
    // ignore
  }
  return null;
}

function saveToSession(loc: ClientLocation) {
  if (typeof window === "undefined") return;
  try {
    window.sessionStorage.setItem(
      "smartcv_location_cache",
      JSON.stringify(loc)
    );
  } catch {
    // ignore
  }
}

export async function getClientLocation(): Promise<ClientLocation | null> {
  if (typeof window === "undefined") return null;

  if (inMemoryLocation) return inMemoryLocation;

  const cached = loadFromSession();
  if (cached) {
    inMemoryLocation = cached;
    return cached;
  }

  if (inFlightPromise) return inFlightPromise;

  inFlightPromise = (async () => {
    try {
      const res = await fetch("https://ipapi.co/json/");
      if (!res.ok) throw new Error("IP API error");
      const data = await res.json();

      const loc: ClientLocation = {
        ip: data.ip || null,
        country: data.country_name || data.country || null,
        city: data.city || null,
      };

      inMemoryLocation = loc;
      saveToSession(loc);
      return loc;
    } catch (e) {
      console.error("Erreur getClientLocation:", e);
      const loc: ClientLocation = {
        ip: null,
        country: null,
        city: null,
      };
      inMemoryLocation = loc;
      saveToSession(loc);
      return loc;
    }
  })();

  return inFlightPromise;
}
````

## File: lib/linkedin.ts
````typescript
// Fichier : lib/auth.ts

// Vous devez vous assurer que ces imports sont valides dans votre structure
import { auth } from "@/lib/firebase"; // Import de l'instance d'authentification Firebase
import { signInWithCustomToken, UserCredential } from "firebase/auth";

// üëâ Login via LinkedIn
// idToken ici est le Custom Token Firebase g√©n√©r√© par votre Cloud Function.
export async function loginWithLinkedInIdToken(idToken: string): Promise<UserCredential> {
  console.log(
    "[auth] Tentative de connexion via Custom Token LinkedIn...",
    idToken
  );

  try {
    // 1. Utilisez le Custom Token pour connecter l'utilisateur Firebase.
    const credential = await signInWithCustomToken(auth, idToken);
    
    console.log("[auth] Connexion LinkedIn r√©ussie:", credential.user.uid);
    
    // Le Custom Token est √©chang√© contre une session utilisateur compl√®te.
    return credential; 
    
  } catch (error) {
    console.error("[auth] Erreur lors de la connexion via Custom Token:", error);
    throw new Error("Impossible de se connecter √† Firebase avec le Custom Token fourni.");
  }
}
````

## File: lib/logAuthFailed.ts
````typescript
// src/lib/logAuthFailed.ts
import { addDoc, collection, serverTimestamp } from "firebase/firestore";
import { db } from "@/lib/firebase";

export interface LogAuthFailedParams {
  email?: string;
  provider?: string;
  errorCode?: string;
  errorMessage?: string;
}

/**
 * D√©tection OS / device / navigateur √† partir du userAgent
 */
function parseUserAgent(uaRaw: string | null | undefined) {
  const ua = (uaRaw ?? "").toLowerCase();

  let deviceType: string | null = null;
  let os: string | null = null;
  let browser: string | null = null;

  // --- Device ---
  if (ua.includes("iphone")) {
    deviceType = "iphone";
  } else if (ua.includes("ipad")) {
    deviceType = "ipad";
  } else if (ua.includes("android") && ua.includes("mobile")) {
    deviceType = "mobile";
  } else if (ua.includes("android")) {
    deviceType = "tablet";
  } else if (ua.includes("macintosh") || ua.includes("mac os x")) {
    deviceType = "desktop";
  } else if (ua.includes("windows")) {
    deviceType = "desktop";
  } else {
    deviceType = "desktop";
  }

  // --- OS ---
  if (ua.includes("iphone") || ua.includes("ipad") || ua.includes("ipod")) {
    os = "iOS";
  } else if (ua.includes("android")) {
    os = "Android";
  } else if (ua.includes("mac os x") || ua.includes("macintosh")) {
    os = "macOS";
  } else if (ua.includes("windows nt")) {
    os = "Windows";
  } else if (ua.includes("linux")) {
    os = "Linux";
  }

  // --- Navigateur ---
  if (ua.includes("safari") && !ua.includes("chrome") && !ua.includes("crios")) {
    browser = "Safari";
  } else if (
    (ua.includes("chrome") || ua.includes("crios")) &&
    !ua.includes("edge") &&
    !ua.includes("edg/")
  ) {
    browser = "Chrome";
  } else if (ua.includes("firefox") || ua.includes("fxios")) {
    browser = "Firefox";
  } else if (ua.includes("edg/")) {
    browser = "Edge";
  } else if (ua.includes("opera") || ua.includes("opr/")) {
    browser = "Opera";
  }

  return { deviceType, os, browser };
}

/**
 * R√©cup√®re l'IP + ville + pays via un petit service public
 * (tu peux changer pour ton propre endpoint si tu veux).
 */
async function fetchIpInfo() {
  if (typeof window === "undefined") return null;

  try {
    const res = await fetch("https://ipapi.co/json/");
    if (!res.ok) return null;
    const json: any = await res.json();

    return {
      ip: json.ip || null,
      country: json.country_name || null,
      city: json.city || null,
    };
  } catch {
    return null;
  }
}

/**
 * Log d'une tentative de connexion √©chou√©e (auth_failed)
 * ‚Üí √©crit dans la collection "usageLogs"
 * ‚Üí enrichi avec IP, pays, ville, device, OS, navigateur, path
 */
export async function logAuthFailed(params: LogAuthFailedParams) {
  try {
    const ua =
      typeof window !== "undefined"
        ? window.navigator.userAgent || ""
        : "";

    const path =
      typeof window !== "undefined"
        ? window.location.pathname + window.location.search
        : "";

    const { deviceType, os, browser } = parseUserAgent(ua);

    const geo = await fetchIpInfo();

    await addDoc(collection(db, "usageLogs"), {
      action: "auth_failed",
      userId: null, // pas connect√©
      email: params.email || "",
      provider: params.provider || "password",
      errorCode: params.errorCode || "",
      errorMessage: params.errorMessage || "",

      // contexte technique
      ua,
      path,
      deviceType: deviceType ?? null,
      os: os ?? null,
      browser: browser ?? null,

      // g√©oloc basique
      ip: geo?.ip ?? null,
      country: geo?.country ?? null,
      city: geo?.city ?? null,

      createdAt: serverTimestamp(),
    });
  } catch (e) {
    // On ne bloque pas l'utilisateur si le log plante
    console.error("Erreur logAuthFailed:", e);
  }
}
````

## File: lib/logUsage.ts
````typescript
// src/lib/logUsage.ts
import {
  addDoc,
  collection,
  doc,
  updateDoc,
  increment,
} from "firebase/firestore";
import { db } from "@/lib/firebase";
import type { User } from "firebase/auth";

export type UsageDocType = "lm" | "cv" | "other";

interface LogUsageOptions {
  user: User;
  action: string;      // ex: "generate_document", "download_document"
  docType?: UsageDocType; // "lm" | "cv" | "other"
  eventType?: string;  // ex: "generate", "download"
  tool?: string;       // ex: "generateLetterAndPitch", "generateCvPdf"
  creditsDelta?: number; // ex: -1 si tu consommes 1 cr√©dit
  path?: string;       // path courant (optionnel)
}

/**
 * Log d'usage IA c√¥t√© client :
 * - cr√©e un document dans "usageLogs"
 * - met √† jour les compteurs dans "users/{uid}"
 *
 * ‚Üí Permet √† ton admin d'afficher :
 *   - LM g√©n√©r√©es (logs) : docType = "lm"
 *   - CV g√©n√©r√©s (logs) : docType = "cv"
 *   - totalIaCalls, totalDocumentsGenerated, totalLmGenerated, totalCvGenerated
 */
export async function logUsage(options: LogUsageOptions) {
  const {
    user,
    action,
    docType = "other",
    eventType,
    tool,
    creditsDelta,
  } = options;

  try {
    const now = Date.now();
    const path =
      options.path ||
      (typeof window !== "undefined"
        ? window.location.pathname + window.location.search
        : "");

    // 1) LOG dans usageLogs
    await addDoc(collection(db, "usageLogs"), {
      userId: user.uid,
      email: user.email ?? "",
      action,         // ex: "generate_document"
      docType,        // "lm" | "cv" | "other"
      eventType: eventType ?? null, // ex: "generate"
      tool: tool ?? null,           // ex: "generateCvPdf"

      creditsDelta: typeof creditsDelta === "number" ? creditsDelta : null,

      path,
      createdAt: now, // number ‚Üí ton admin new Date(createdAt)

      ip: null,
      country: null,
      city: null,
      deviceType: null,
      os: null,
      browser: null,
    });

    // 2) Mise √† jour des compteurs dans users/{uid}
    const userRef = doc(db, "users", user.uid);

    const updates: Record<string, any> = {
      totalIaCalls: increment(1),
    };

    // Document IA ‚Üí compteur global
    if (docType === "lm" || docType === "cv") {
      updates.totalDocumentsGenerated = increment(1);
    }

    if (docType === "lm") {
      updates.totalLmGenerated = increment(1);
    }
    if (docType === "cv") {
      updates.totalCvGenerated = increment(1);
    }

    if (typeof creditsDelta === "number" && creditsDelta !== 0) {
      updates.credits = increment(creditsDelta);
    }

    await updateDoc(userRef, updates);
  } catch (err) {
    console.error("Erreur logUsage:", err);
    // on ne bloque JAMAIS l'utilisateur si le log plante
  }
}
````

## File: lib/polar-checkout.ts
````typescript
// src/lib/polar-checkout.ts
import { polar } from "@/lib/polar";

// Mappe les packs utilis√©s dans ton app vers les Product IDs Polar
// Ici on suppose trois packs : 10, 20, 30 cr√©dits
const PACK_TO_PRODUCT_ID: Record<string, string> = {
  "10": process.env.POLAR_PRODUCT_10_ID || "",
  "20": process.env.POLAR_PRODUCT_20_ID || "",
  "30": process.env.POLAR_PRODUCT_30_ID || "",
};

const APP_URL =
  process.env.NEXT_PUBLIC_APP_URL ?? "https://assistant-ia-v4.web.app";

export type CreditPackId = "10" | "20" | "30";

export interface CreateCheckoutOptions {
  customerEmail?: string;
  externalCustomerId?: string; // ex: id utilisateur (Firebase, Supabase, etc.)
}

/**
 * Cr√©e une session de paiement Polar pour un pack donn√©.
 *
 * @param packId - "10", "20" ou "30" (nombre de cr√©dits du pack)
 * @param opts - infos client (email, id externe)
 */
export async function createPolarCheckout(
  packId: CreditPackId,
  opts?: CreateCheckoutOptions
) {
  const productId = PACK_TO_PRODUCT_ID[packId];

  if (!productId) {
    throw new Error(
      `Pack inconnu c√¥t√© Polar : "${packId}". V√©rifie PACK_TO_PRODUCT_ID dans src/lib/polar-checkout.ts`
    );
  }

  // Polar remplace {CHECKOUT_ID} par l'id r√©el du checkout
  const successUrl = `${APP_URL}/paiement/success?checkout_id={CHECKOUT_ID}`;
  const returnUrl = `${APP_URL}/paiement/canceled`;

  const checkout = await polar.checkouts.create({
    products: [productId],
    successUrl,
    returnUrl,
    customerEmail: opts?.customerEmail,
    externalCustomerId: opts?.externalCustomerId,
  });

  if (!checkout.url) {
    throw new Error("Polar n'a pas renvoy√© d'URL de checkout");
  }

  return { url: checkout.url };
}
````

## File: lib/polar.ts
````typescript
// src/lib/polar.ts
import { Polar } from "@polar-sh/sdk";

const server =
  process.env.POLAR_ENV === "production" ? "production" : "sandbox";

if (!process.env.POLAR_ACCESS_TOKEN) {
  throw new Error("POLAR_ACCESS_TOKEN manquant dans .env");
}

// Instance Polar
export const polar = new Polar({
  accessToken: process.env.POLAR_ACCESS_TOKEN,
  // @ts-ignore : selon la version du SDK, server peut √™tre optionnel
  server,
});

// ‚ö†Ô∏è Packs align√©s avec ton UI : 20 / 50 / 100 cr√©dits
export type CreditPackId = "20" | "50" | "100";

// ‚úÖ IDs produits li√©s aux packs, aliment√©s par tes variables d'env
const PACK_TO_PRODUCT_ID: Record<CreditPackId, string> = {
  "20": process.env.POLAR_PRODUCT_20_ID ?? "",
  "50": process.env.POLAR_PRODUCT_50_ID ?? "",
  "100": process.env.POLAR_PRODUCT_100_ID ?? "",
};

function getProductIdForPack(packId: CreditPackId): string {
  const productId = PACK_TO_PRODUCT_ID[packId];
  if (!productId) {
    throw new Error(
      `Aucun POLAR_PRODUCT_${packId}_ID configur√© dans les variables d'env pour le pack "${packId}".`
    );
  }
  return productId;
}

interface CreateCheckoutOptions {
  packId: CreditPackId;
  userId: string;
  email: string;
}

/**
 * Cr√©e un checkout Polar pour un pack de cr√©dits et renvoie l'URL de paiement.
 * Fonctionne autant en sandbox qu'en production (selon POLAR_ENV + les IDs).
 * Cette URL sera utilis√©e dans l'Embedded Checkout (pop-up dans ton site).
 */
export async function createPolarCheckout(options: CreateCheckoutOptions) {
  const { packId, userId, email } = options;

  const productId = getProductIdForPack(packId);

  const baseAppUrl =
    process.env.NEXT_PUBLIC_APP_URL || "http://localhost:3000";

  // üëâ utilis√© pour la redirection *si tu laisses Polar rediriger*
  const successUrl = `${baseAppUrl}/app/credits?status=success&pack=${packId}`;
  const returnUrl = `${baseAppUrl}/app/credits?status=cancel`;

  // üëâ tr√®s important pour l'Embedded Checkout
  // Polar docs : embed_origin = origin de la page qui int√®gre le checkout :contentReference[oaicite:1]{index=1}
  const embedOrigin = baseAppUrl; // NEXT_PUBLIC_APP_URL doit √™tre du style https://mon-site.com

  console.log("[Polar] Cr√©ation checkout", {
    env: process.env.POLAR_ENV,
    packId,
    productId,
    userId,
    email,
    successUrl,
    returnUrl,
    embedOrigin,
  });

  const payload: any = {
    products: [productId],
    success_url: successUrl,
    return_url: returnUrl,
    embed_origin: embedOrigin,
    customer_email: email, // ‚ö†Ô∏è vrai email
    external_customer_id: userId,

    allow_discount_codes: true,
    require_billing_address: false,
    allow_trial: true,
    is_business_customer: false,
  };

  const checkout = await (polar as any).checkouts.create(payload);

  if (!checkout?.url) {
    console.error(
      "[Polar] Checkout cr√©√© mais pas d'URL dans la r√©ponse:",
      checkout
    );
    throw new Error("Checkout Polar cr√©√© mais URL manquante.");
  }

  console.log("[Polar] Checkout URL:", checkout.url);

  return {
    url: checkout.url as string,
    checkout,
  };
}
````

## File: lib/userTracking.ts
````typescript
// lib/userTracking.ts
import { User } from "firebase/auth";
import {
  collection,
  addDoc,
  doc,
  setDoc,
  increment,
} from "firebase/firestore";
import { db } from "@/lib/firebase";

/**
 * Infos IP / localisation
 */
type IpInfo = {
  ip: string;
  country: string;
  city: string;
};

// Cache en m√©moire pour √©viter d'appeler l'API √† chaque fois
let ipInfoCache: IpInfo | null = null;
let ipInfoPromise: Promise<IpInfo | null> | null = null;

async function getIpInfo(): Promise<IpInfo | null> {
  if (ipInfoCache) return ipInfoCache;
  if (typeof window === "undefined") return null;

  if (ipInfoPromise) return ipInfoPromise;

  ipInfoPromise = (async () => {
    try {
      // API publique simple, tu peux la changer si besoin
      const res = await fetch("https://ipapi.co/json/");
      if (!res.ok) throw new Error("IP API error");
      const data = await res.json();
      const info: IpInfo = {
        ip: data.ip,
        country: data.country_name,
        city: data.city,
      };
      ipInfoCache = info;
      return info;
    } catch (e) {
      console.error("Erreur getIpInfo:", e);
      return null;
    } finally {
      ipInfoPromise = null;
    }
  })();

  return ipInfoPromise;
}

/**
 * Infos device / OS / navigateur
 * ‚ûú diff√©rencie iPhone / iPad / macOS / Android / Windows‚Ä¶
 */
type DeviceInfo = {
  deviceType: string; // "iphone" | "ipad" | "mac" | "mobile" | "tablet" | "desktop" | "unknown"
  os: string;
  browser: string;
};

function detectDeviceInfo(): DeviceInfo {
  if (typeof navigator === "undefined") {
    return { deviceType: "unknown", os: "unknown", browser: "unknown" };
  }

  const ua = navigator.userAgent || "";
  const lower = ua.toLowerCase();

  let deviceType = "unknown";
  let os = "unknown";
  let browser = "unknown";

  // --- OS + device ---
  if (/iphone/i.test(ua)) {
    deviceType = "iphone";
    os = "iOS";
  } else if (/ipad/i.test(ua)) {
    deviceType = "ipad";
    os = "iPadOS";
  } else if (/android/i.test(ua)) {
    os = "Android";
    deviceType = /mobile/i.test(ua) ? "mobile" : "tablet";
  } else if (/macintosh|mac os x/i.test(ua)) {
    os = "macOS";
    deviceType = "mac";
  } else if (/windows/i.test(ua)) {
    os = "Windows";
    deviceType = "desktop";
  } else if (/linux/i.test(ua)) {
    os = "Linux";
    deviceType = "desktop";
  }

  // --- navigateur ---
  if (lower.includes("edg/")) {
    browser = "Edge";
  } else if (lower.includes("opr/") || lower.includes("opera")) {
    browser = "Opera";
  } else if (lower.includes("firefox")) {
    browser = "Firefox";
  } else if (lower.includes("chrome") && !lower.includes("edge") && !lower.includes("opr")) {
    browser = "Chrome";
  } else if (lower.includes("safari") && !lower.includes("chrome")) {
    browser = "Safari";
  }

  return { deviceType, os, browser };
}

/**
 * Mise √† jour du doc "users/{uid}" pour suivre :
 * - derni√®re activit√©
 * - derni√®re page
 * - IP / pays / ville
 * - device / OS / navigateur
 */
export async function updateLastActive(
  user: User,
  extra?: { path?: string; action?: string }
) {
  if (!user) return;

  try {
    const [ipInfo, device] = await Promise.all([
      getIpInfo(),
      Promise.resolve(detectDeviceInfo()),
    ]);

    const ref = doc(db, "users", user.uid);

    const path =
      extra?.path ??
      (typeof window !== "undefined"
        ? window.location.pathname + window.location.search
        : null);

    const now = Date.now();

    const payload: any = {
      email: user.email ?? null,
      displayName: user.displayName ?? null,
      lastSeenAt: now,
      lastSeenPage: path,
      lastDeviceType: device.deviceType,
      lastOs: device.os,
      lastBrowser: device.browser,
    };

    if (user.metadata?.lastSignInTime) {
      payload.lastLoginAt = new Date(
        user.metadata.lastSignInTime
      ).getTime();
    }

    if (ipInfo) {
      payload.lastSeenIp = ipInfo.ip;
      payload.lastSeenCountry = ipInfo.country;
      payload.lastSeenCity = ipInfo.city;
    }

    if (extra?.action) {
      payload.lastAction = extra.action;
      payload.lastActionAt = now;
    }

    await setDoc(ref, payload, { merge: true });
  } catch (e) {
    console.error("Erreur updateLastActive:", e);
  }
}

/**
 * Options pour les logs d‚Äôusage
 * - action = nom de l‚Äô√©v√®nement (ex: "lm_generate", "lm_download", "cv_generate")
 * - docType = "lm" | "cv" | "pitch"...
 * - eventType = "generate" | "download" | "view"...
 * - tool = comment tu cat√©gorises ton outil (ex: "lm", "cv", "assistant")
 * - creditsDelta = variation de cr√©dits (ex: -1 quand tu consommes 1 cr√©dit)
 *
 * ‚ûú gr√¢ce √† [key: string]: any, tu peux passer
 *    feature, template, lang, contract, targetJob, companyName, etc.
 */
export type LogUsageOptions = {
  tool?: string;
  docType?: "lm" | "cv" | "pitch" | string;
  eventType?: "generate" | "download" | "view" | "auth" | string;
  creditsDelta?: number;
  path?: string;
  meta?: Record<string, any>;
  // pour autoriser des cl√©s libres (feature, template, lang, etc.)
  [key: string]: any;
};

/**
 * Log d‚Äôun √©v√©nement important (appel IA, g√©n√©ration LM/CV, t√©l√©chargement‚Ä¶)
 * ‚ûú cr√©e un doc dans usageLogs
 * ‚ûú met √† jour les compteurs dans users
 *
 * Tous les champs suppl√©mentaires (feature, template, lang, jobTitle, etc.)
 * sont rang√©s dans log.meta.
 */
export async function logUsage(
  user: User | null,
  action: string,
  options?: LogUsageOptions
) {
  if (!user) return;

  try {
    const [ipInfo, device] = await Promise.all([
      getIpInfo(),
      Promise.resolve(detectDeviceInfo()),
    ]);

    const now = Date.now();

    // On extrait les options "connues" et on met le reste dans `rest`
    const {
      tool,
      docType,
      eventType,
      creditsDelta,
      path: optPath,
      meta,
      ...rest
    } = options ?? {};

    const path =
      optPath ??
      (typeof window !== "undefined"
        ? window.location.pathname + window.location.search
        : null);

    // --- 1) Cr√©er un document dans usageLogs ---
    const log: any = {
      userId: user.uid,
      email: user.email ?? null,
      action,
      tool: tool ?? null,
      docType: docType ?? null,
      eventType: eventType ?? null,
      createdAt: now,
      path,
      creditsDelta:
        typeof creditsDelta === "number" ? creditsDelta : null,
      deviceType: device.deviceType,
      os: device.os,
      browser: device.browser,
    };

    if (ipInfo) {
      log.ip = ipInfo.ip;
      log.country = ipInfo.country;
      log.city = ipInfo.city;
    }

    // Fusionne meta + toutes les autres cl√©s libres (feature, template, ...)
    if (meta || Object.keys(rest).length > 0) {
      log.meta = {
        ...(meta || {}),
        ...rest,
      };
    }

    const logsRef = collection(db, "usageLogs");
    await addDoc(logsRef, log);

    // --- 2) Mettre √† jour les compteurs dans users/{uid} ---
    const userRef = doc(db, "users", user.uid);

    const update: any = {
      lastSeenAt: now,
      lastSeenPage: path,
      lastDeviceType: device.deviceType,
      lastOs: device.os,
      lastBrowser: device.browser,
    };

    if (ipInfo) {
      update.lastSeenIp = ipInfo.ip;
      update.lastSeenCountry = ipInfo.country;
      update.lastSeenCity = ipInfo.city;
    }

    const inc: any = {};

    // Appels IA
    if (tool) {
      inc.totalIaCalls = increment(1);
    }

    // Documents g√©n√©r√©s
    if (docType) {
      inc.totalDocumentsGenerated = increment(1);
      if (docType === "lm") {
        inc.totalLmGenerated = increment(1);
      }
      if (docType === "cv") {
        inc.totalCvGenerated = increment(1);
      }
    }

    // Cr√©dits consomm√©s / ajout√©s
    if (typeof creditsDelta === "number") {
      inc.credits = increment(creditsDelta);
    }

    Object.assign(update, inc);

    await setDoc(userRef, update, { merge: true });
  } catch (e) {
    console.error("Erreur logUsage:", e);
  }
}
````

## File: public/manifest.webmanifest
````
{
  "name": "SmartCV",
  "short_name": "SmartCV",
  "start_url": "/",
  "display": "standalone",
  "background_color": "#020617",
  "theme_color": "#0ea5e9",
  "icons": []
}
````

## File: types/cv.ts
````typescript
// types/cv.ts

export type CvSkills = {
  // Comp√©tences m√©tier (finance, RH, IT, marketing, etc.)
  domain?: string[];
  // Outils / logiciels (Excel, Word, PowerPoint, SAP, Canva, etc.)
  tools?: string[];
};

export type CvExperience = {
  company?: string;
  role?: string;
  location?: string;
  dates?: string;
  bullets?: string[];
};

export type CvProfile = {
  fullName?: string;
  email?: string;
  phone?: string;
  linkedin?: string;
  contractType?: string;

  // R√©sum√© court du profil (max 3 phrases)
  profileSummary?: string;

  // Ligne compacte pour les langues : "Fran√ßais (natif) ¬∑ Anglais (B2 ‚Äì TOEIC) ¬∑ ..."
  langLine?: string;

  skills?: CvSkills;

  // Formation courte, lignes pr√™tes √† afficher
  // ex: "2022‚Äì2024 ¬∑ MSc Expert Financier ‚Äì ESAM, Paris"
  educationShort?: string[];

  // Certifications principales
  certifications?: string[];

  // Centres d'int√©r√™t d√©taill√©s
  interests?: string[];

  // Centres d'int√©r√™t sur une seule ligne : "Musique, piano, voyages, ..."
  interestsLine?: string;

  // Exp√©riences d√©taill√©es (utile plus tard pour les LM, pitch, etc.)
  experiences?: CvExperience[];
};

export type CvApiResponse = {
  success: boolean;
  profile?: CvProfile;
  error?: string;
};
````

## File: .firebaserc
````
{
  "projects": {
    "a": "assistant-ia-v4"
  },
  "targets": {},
  "etags": {}
}
````

## File: .gitignore
````
node_modules/
.next/
out/
.env
.env.*
serviceAccountKey.json
*.log
.DS_Store
serviceAccountKey*.json
````

## File: api.txt
````
SMTP et API
Serveur SMTP
smtp-relay.brevo.com
Port
587
Connexion
9c1210001@smtp-brevo.com
STARTTLS
key: bskt8NcPaWFVZUh

firebase functions:config:set smtp.host="smtp-relay.brevo.com"
firebase functions:config:set smtp.port="587"
firebase functions:config:set smtp.secure="false"
firebase functions:config:set smtp.user="9c1210001@smtp-brevo.com"
firebase functions:config:set smtp.pass="bskt8NcPaWFVZUh"
firebase functions:config:set smtp.from='"Assistant IA" <aakane0105@gmail.com>'
firebase functions:config:set smtp.from='"Assistant IA" <no-reply@tondomaine.com>'
firebase functions:config:set smtp.from='"Assistant IA" <no-reply@assistant-ia-v4.com>'
````

## File: firestore.indexes.json
````json
{
  "indexes": [
    {
      "collectionGroup": "applications",
      "queryScope": "COLLECTION",
      "fields": [
        { "fieldPath": "userId", "order": "ASCENDING" },
        { "fieldPath": "createdAt", "order": "DESCENDING" }
      ]
    }
  ],
  "fieldOverrides": []
}
````

## File: firestore.rules
````
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helpers ---
    function isSignedIn() {
      return request.auth != null;
    }

    function isAdmin() {
      return isSignedIn() && (
        request.auth.token.isAdmin == true ||
        request.auth.token.email == "aakane0105@gmail.com"
      );
    }

    // --- COLLECTION users ---
    match /users/{userId} {
      // L'utilisateur peut lire/√©crire uniquement SON doc
      allow read, write: if isSignedIn() && request.auth.uid == userId;

      // L'admin peut tout lire/√©crire
      allow read, write: if isAdmin();
    }

    // --- COLLECTION profiles ---
    match /profiles/{userId} {
      // L'utilisateur g√®re son profil
      allow read, write: if isSignedIn() && request.auth.uid == userId;

      // Admin peut tout lire/√©crire
      allow read, write: if isAdmin();
    }

    // --- COLLECTION applications ---
    match /applications/{appId} {
      // Cr√©ation d'une candidature : userId dans le doc = auth.uid
      allow create: if isSignedIn()
        && request.resource.data.userId == request.auth.uid;

      // Lecture / update / delete par le propri√©taire
      allow read, update, delete: if isSignedIn()
        && resource.data.userId == request.auth.uid;

      // Admin : lecture/√©criture si besoin (stats, corrections, etc.)
      allow read, write: if isAdmin();
    }

    // --- COLLECTION usageLogs ---
    match /usageLogs/{logId} {
      // 1) logs normaux d'un user connect√© (LM, CV, etc.)
      // 2) logs d'√©chec de connexion (auth_failed) AVANT login (pas d'auth)
      allow create: if
        (
          isSignedIn() &&
          request.resource.data.userId == request.auth.uid
        )
        ||
        (
          !isSignedIn() &&
          request.resource.data.action == "auth_failed"
        );

      // lecture / modif / suppression : admin uniquement
      allow read, update, delete: if isAdmin();
    }

    // --- CATCH-ALL ADMIN ---
    match /{document=**} {
      allow read, write: if isAdmin();
    }
  }
}
````

## File: next-env.d.ts
````typescript
/// <reference types="next" />
/// <reference types="next/image-types/global" />

// NOTE: This file should not be edited
// see https://nextjs.org/docs/app/building-your-application/configuring/typescript for more information.
````

## File: postcss.config.js
````javascript
module.exports = {
  plugins: {
    tailwindcss: {},
    autoprefixer: {}
  }
};
````

## File: setAdmin.js
````javascript
// setAdmin.js
const admin = require("firebase-admin");
const serviceAccount = require("./serviceAccountKey.json");

admin.initializeApp({
  credential: admin.credential.cert(serviceAccount),
});

async function main() {
  // üëâ Mets ici l'email EXACT utilis√© dans Firebase Authentication
  const email = "aakane0105@gmail.com"; // <--- NE PAS OUBLIER LE GUILLEMET DE FIN

  try {
    // On r√©cup√®re l'utilisateur via son email
    const userRecord = await admin.auth().getUserByEmail(email);
    console.log("Utilisateur trouv√© ‚úÖ");
    console.log("UID :", userRecord.uid);
    console.log("Email :", userRecord.email);

    // On lui ajoute le r√¥le admin
    await admin.auth().setCustomUserClaims(userRecord.uid, { isAdmin: true });

    console.log("‚úÖ isAdmin = true pour :", userRecord.uid);
  } catch (err) {
    console.error("Erreur setAdmin:", err);
  }
}

main();
````

## File: syncAuthUsersToFirestore.js
````javascript
// syncAuthUsersToFirestore.js
//
// Script une fois pour toutes : synchronise tous les comptes Firebase Auth
// vers la collection Firestore "users", pour qu'ils apparaissent dans ton admin.

const admin = require("firebase-admin");
const serviceAccount = require("./serviceAccountKey.json");

admin.initializeApp({
  credential: admin.credential.cert(serviceAccount),
});

const db = admin.firestore();

function toMillis(str) {
  if (!str) return null;
  const t = Date.parse(str);
  return Number.isNaN(t) ? null : t;
}

async function syncAllUsers(nextPageToken) {
  const result = await admin.auth().listUsers(1000, nextPageToken);

  for (const user of result.users) {
    const uid = user.uid;
    const ref = db.collection("users").doc(uid);
    const snap = await ref.get();

    const baseData = {
      email: user.email || null,
      displayName: user.displayName || null,
      emailVerified: user.emailVerified || false,
      provider:
        (user.providerData[0] && user.providerData[0].providerId) ||
        "password",
      createdAt: toMillis(user.metadata.creationTime) || Date.now(),
      lastLoginAt: toMillis(user.metadata.lastSignInTime) || null,
    };

    if (!snap.exists) {
      // Nouveau doc user cr√©√©
      await ref.set({
        ...baseData,
        credits: 0,
        blocked: false,
      });
      console.log("‚úÖ Cr√©√© doc users pour", uid, baseData.email);
    } else {
      // Doc d√©j√† existant ‚Üí on ne touche pas aux cr√©dits / blocked
      await ref.set(baseData, { merge: true });
      console.log("üîÅ Mis √† jour doc users pour", uid, baseData.email);
    }
  }

  if (result.pageToken) {
    await syncAllUsers(result.pageToken);
  }
}

async function main() {
  await syncAllUsers();
  console.log("üéâ Sync termin√©");
  process.exit(0);
}

main().catch((err) => {
  console.error("Erreur syncAllUsers:", err);
  process.exit(1);
});
````

## File: tailwind.config.js
````javascript
/** @type {import('tailwindcss').Config} */
module.exports = {
  content: [
    "./app/**/*.{js,ts,jsx,tsx}",
    "./components/**/*.{js,ts,jsx,tsx}"
  ],
  theme: {
    extend: {}
  },
  plugins: []
}
````

## File: tsconfig.json
````json
{
  "compilerOptions": {
    "target": "ESNext",
    "lib": [
      "DOM",
      "DOM.Iterable",
      "ESNext"
    ],
    "allowJs": false,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "ESNext",
    "moduleResolution": "Node",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "preserve",
    "paths": {
      "@/*": [
        "./*"
      ]
    },
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ]
  },
  "include": [
    "next-env.d.ts",
    "**/*.ts",
    "**/*.tsx",
    ".next/types/**/*.ts"
  ],
  "exclude": [
    "node_modules"
  ]
}
````

## File: .firebase/hosting.b3V0.cache
````
tech.txt,1766516748973,3cc77dc7579ee301c79c58a1da5d988087fb019c57e0d78f73a119a26fc00a4d
tech.html,1766516748967,70478536984048f8c6baf85a4058f211be215908aa302b25aaed9a52c5f222ac
signup.txt,1766516748973,67d7b353b52eddfad89558b7f87fa0ed0a8b9d01d3ac4a26af8f5c46c0aaaec0
signup.html,1766516748966,13a430bdcfa6a23c937d07424d9976cba1c378d7fba5af9d709247d55dbae711
manifest.webmanifest,1766516747523,b125a9afb1b3c4b81daaf5442dd9d589e2367c37c2fd3305fa23247173975337
login.txt,1766516748972,caa566efee024b3a35054ae05a6f221d8495f025d7f380ea77aff75eb5fb3d5e
login.html,1766516748966,d3998e585966bec43ed93623d16627486f69f8fab60f572b28cae0418e40727f
index.txt,1766516748972,b0952ef67cb6b99e6c2afeaba613ffad79cb81f327adcc17ba2d877afab592dc
index.html,1766516748965,9b9072f01f7c7b5092cee0c56e4e838dc370c49d1045768f26997eea029c3b26
forgot-password.txt,1766516748971,88c0dd789a3046334a7199dcfcc9854cfc2551f6e0a3d67bde03695847b139c7
forgot-password.html,1766516748964,c7999480bd7f5ecd38846e31c73bbc5a4d85cbdd954181b7b45e85e724dbcad9
assistance-candidature.txt,1766516748972,571b66de82c739ba22388b13fa2683eeae37641c1f05ae600f98f1b66317d7b8
assistance-candidature.html,1766516748964,497d9247344cccd26da023e712845771c7462cde598b6fe5e82f9c1d6435265c
app.txt,1766516748972,7850b8a9e9ba265b34809ed488fba35e5e68db7e503f661eb1ac59a346b9067a
app.html,1766516748966,73a6efe79ce7b661efb9f95998c80a538a98e79b73297ddf15162766e1fa4f58
admin.txt,1766516748970,f803e183918a3f2766bc90dd598061cee600d5c7ee28285e0baf519cfd6cf810
admin.html,1766516748962,e27231a563db9416d934f284b9a06cf556c887632aad85a59678fdbc833e139d
404.html,1766516748361,0626120cd6599b9be504fa03b62df50001f4d6b7ad6f8cb18f42ef5bff48a7f3
debug/polar.txt,1766516748967,162c79c96a088d3835c7deff2f7ee56b4824f4ff666e9cc3950531bb47524fc4
debug/polar.html,1766516748960,9c12de9b764a377658e9776ec0b1b788f9a210cdbad24e04cb26a23b14ad27ac
auth/verify-email.txt,1766516748967,63b1366132c2b0e2c175635e0649c2db808d8ec7667749d2639f53b758e377c7
auth/verify-email.html,1766516748960,2f2ee707b9bc799fd433a74e7cb6dc81852665f6465c45576704e0988b31b106
app/tracker.txt,1766516748970,18126b57901f775004395836548f7a73751e83b18b81872442dee1c87370dc22
app/tracker.html,1766516748963,30b6204034b11845cb893ff05443198864a7adb00070b9adb7dd2ec98b08bcb3
app/settings.txt,1766516748973,ccef11346e1bbd3e3b7ae52f767cba6a1aa6d92d4fcfd3793593ee8b7d9ccde9
app/settings.html,1766516748966,5266df0af37d8fa6709cc6d2c863bbe4ab89b08efcac97998501d65a9b3d7b7b
app/pitch.txt,1766516748969,36f5315cfc294be3857aa266a1740f5221496df763e9778ec8725bffd1a03544
app/pitch.html,1766516748962,d6a772b420bd301d88a2ca95ae58b8e8cef8f1066b195f6141c8c37d3ecb53bf
app/lm.txt,1766516748972,ab8e094152014d928f4b1837948edf892f04ac8a19b3a353a6ad42582165eb2f
app/lm.html,1766516748964,e1ff1821ef676c6bba3853b7351d77bae4a3d321d16d9266707ecd3b0bf1f180
app/interview.txt,1766516748971,fe4689f8802db6b00679134b9ee6b202e9e5f04e9f4bdc8cb6f1fa5920467554
app/interview.html,1766516748964,f58af150bc197f2fd5351b159b958ad7c3d3a6b7f0aef7b7786cece06b0249f1
app/history.txt,1766516748969,3d99fecc6e8369deb2ac7ff03c4b17d90cde33080bbc48ca2ca6cb30c8515953
app/history.html,1766516748962,e13c02f140849dbd105464a044416fd5cecaf07c72d7f3cc9f9be4f1a2d5789a
app/cv.txt,1766516748971,ae59d2a5c6c8bc3d41dca902c3119ff1dc33b3aeb63bef75758cf15824c15d58
app/cv.html,1766516748964,6527edd251c87b7ca2c2310a42dca7da53e14ecb664b1e3d287d6616514f81c1
app/credits.txt,1766516748968,24d4978dee084c63c1cbb323155cd4c70f6d02ca243de961f90d7e6b467f71fe
app/credits.html,1766516748961,3cc63222ed5df58478beb80f7efb773c4d3b47f4af69d398f621ff2b2208e337
app/apply.txt,1766516748969,8ea0c8e96099d408f8d6335b00bfa7124ac76c0c6c83be7dccd9dddfc4190d81
app/apply.html,1766516748961,71be18f951c8b9bdf78fa5ffd11e7d108a8b6ef4ef461e65298d54e759f3f5e4
api/polar/test,1766516748967,35d1b34b7807696b8413c672871fcf26b35d968667e349dfbe811cedc67ac17a
admin/logs.txt,1766516748968,4193cfac968d950cd1d60e21536d13877be82d5fda4b328877374dcf3ffb6bbf
admin/logs.html,1766516748961,7d85f1598fa19eb04fd7f41d2319e17fca3b8c1d30c79ba2e78bae763e7b8d1a
admin/login.txt,1766516748966,fc9efe2a6fb3cbc9a59bc9c9a6f15f8407bc4554cb41a0b9a83ad59717910c6a
admin/login.html,1766516748959,b77fe6a483e5cc895e0545a8dfa15d00ad77e642c37809d773749102a7da8e24
_next/static/css/faac00ea2ad55afa.css,1766516747505,6d7858f4fcc4e1e9989a644e8cf8a19bb627645fdf7cac7bb293cc4e6ae1ada3
_next/static/chunks/webpack-94aa307a0c675022.js,1766516747501,39d51b0f67df400cf90160e3e74e56e3b3ac0d30af506085df8bee1092e91cab
_next/static/chunks/polyfills-42372ed130431b0a.js,1766516747505,67dee1c02c6a6700d63b5c1898cf2df618101a68a395db469192763d24925a23
_next/static/chunks/main-app-7466cb2517b2ac24.js,1766516747498,3dad6f439d8b157d2427b4087aaeff0fef56e1e1041ee3b5f0fad10bf506a92d
_next/static/chunks/main-76e1bcb595671093.js,1766516747504,bbcdc180a07d600a7f8dcfa6d3267afdec0b918f9bc722e4764b72782a68d238
_next/static/chunks/framework-aec844d2ccbe7592.js,1766516747501,36f12099915a78862f76158596a2aac7e86dd87ba94f4d3b896a7749c5e4c9d6
_next/static/chunks/fd9d1056-b4129a380d1be68f.js,1766516747498,8b73f2ae4babb3d70adf200a16329555cd03b390ca97f3fa3368428ebc73c549
_next/static/chunks/ebf8faf4-eb27ebf8c37d4d67.js,1766516747497,a107c6566fbc2f52b78a30e52b2ae3b7b84b0da4ffe8d15f24849c217e372a5d
_next/static/chunks/ca377847-044365abace2608d.js,1766516747496,c6e43c770559cc5ee6605295131dc3e9de57d9fda82d7043e9b70b2f97bc8002
_next/static/chunks/941-da853eb9ae4bc965.js,1766516747494,f4b97a2711ed98aa8723dcc66969fec23e3ebc576ff38e09fd1f1cd10bd20a82
_next/static/chunks/810-039b9229cc1a2fae.js,1766516747488,2f29a61132b062dab1e63516e7337a67aede0bce268795b569dfccfc5c400bab
_next/static/chunks/7508b87c-2affb3ad7b55ab3d.js,1766516747486,798ec3d71f923e838d157bf4dd01e76244b35e1c9634e28e77c89c9df89a676d
_next/static/chunks/648-a41745ebae293ba3.js,1766516747483,d08de5f20a30c50b96e1cb68dfbec730d23ae67cba384f345e34c09b6adddaf3
_next/static/chunks/63b94182.662a1bbff33f68c9.js,1766516747489,86c28eeebf9d1883bb5afe89168408b3ccf891d873e2ac67eec46ef5baa42a41
_next/static/chunks/600-2ae2ab76ace4e875.js,1766516747480,ea47caf34ad27d1a524604c65a1c0ecc0f6fb1f64426749920e60ac529a33563
_next/static/chunks/5493da1b.e7544b77cf3a7468.js,1766516747486,76cae2b4134f6f89522b80ad97b81eb8b093f50a047c7faa2e0512533d603784
_next/static/chunks/500-c984c19836bde651.js,1766516747477,94a6d0ca98e707e577d1f1b6336dcdf87e35f2c1be72c787845aad3abfdab19b
_next/static/chunks/323-54d09e3358a73f44.js,1766516747481,2aae14a1d235667a06206f344a3f76216206cb0f4697ccc38edc1923e27c5d58
_next/static/chunks/276-a01f3bf27c64a121.js,1766516747479,7959269d2568322cb0a6253c58e7242b54d27d373aa32b7b0c05474bf95e8fd1
_next/static/chunks/pages/_error-7ba65e1336b92748.js,1766516747506,0402d6340a70945d851b2d22e156d955fbee54c1d8ec8b379f35fd464a8d08bf
_next/static/chunks/pages/_app-72b849fbd24ac258.js,1766516747506,dae29acdf0128939e571909a9228115276818bce739f4d0f98c1da8ed68ba91d
_next/static/chunks/app/page-04078e5e4ba66b1d.js,1766516747506,fd845f84ec7c187a3bb3e82cd5a690aa75f0b4ca0c53a65495ea449a96c15991
_next/static/chunks/app/not-found-74a90fc08ab9437a.js,1766516747506,8ec8fde655d80c0e5d37c7714dac9911aa99f5add99e26b2820f5afcda111b2a
_next/static/chunks/app/layout-9e322ebc6c69974b.js,1766516747505,57a38ab6c6c143610c4c5c55fe368f60c5aed79c207f486eb9d75bf8763d6394
_next/static/chunks/app/tech/page-cc145f1ea41d0f3b.js,1766516747515,9782dc820a4127292f16e053f0bcc1695227f9ba956897623c527946b7b8fdc5
_next/static/chunks/app/signup/page-8c48925c3f3c52ca.js,1766516747512,636d7396bfba3179391c46dc2cadcfe85fcd5c9955e05cb88622170aa8b44f23
_next/static/chunks/app/login/page-8a1f8646938577f8.js,1766516747512,45da851b1c759ecdc39470f681d20a1f67bd96b97ce88568df91a0aff4ca6696
_next/static/chunks/app/forgot-password/page-7ba7f56b957b3ead.js,1766516747512,59c307ab28b715a638e9ac9d484b2d73ac8bd3b271b1db0fb16ce4716a556865
_next/static/chunks/app/debug/polar/page-e28997809c70dae8.js,1766516747519,eae0b7def982e0bf3068fde94e7f0f34defeceee17e2646fb7a9cb846c72169e
_next/static/chunks/app/auth/verify-email/page-c03af4984154988e.js,1766516747519,6b22e7525d83798f87b4b2b1d90798e6972b3edc575929ee1352938bfa718515
_next/static/chunks/app/assistance-candidature/page-f38626f0664fd689.js,1766516747510,81d9766776f30fbac7fbd008ba3ab85a44d797761bc1a6972d105a47c69f101f
_next/static/chunks/app/app/page-3d33f0691cc7052c.js,1766516747512,f79254300ae18826e790c276848a5aa9223b69f41cb2b8516b8841a1e43a435b
_next/static/chunks/app/app/layout-7aa6ad0f76d78662.js,1766516747509,47da4ba9f8b5600fd9cb70eb46bf190b3ea02b503488dfb3560c83c2a3d7b7b8
_next/static/chunks/app/app/tracker/page-8f13d48cb47ca503.js,1766516747519,0b68abda42bcfe86ea7274e10859d1964851010b96b165ed852ecfd58ae16571
_next/static/chunks/app/app/settings/page-654d883b731b8e6b.js,1766516747518,a65265b14afa8476fb7b78ff2f3f18b8989aec6b6b50f4b02960185d8fca1d76
_next/static/chunks/app/app/pitch/page-a42bf5337283b380.js,1766516747517,8bb08510d6cd6129e33e6ec8e6fbd346c590b1fce79e8c3fd1af1c8492f985d1
_next/static/chunks/app/app/lm/page-a1057059c1ffab1f.js,1766516747518,34ed764c2ca1bf552158c78b6a6350f2cdd4411a752d4d7b3661952c6d1772f2
_next/static/chunks/app/app/interview/page-5d2b46a3565c14fc.js,1766516747517,e004acddbc6b4612633faad87f187fd7fccee1994dfd7a383d0134b3ba6e8e69
_next/static/chunks/app/app/history/page-b44f1b622671fb6b.js,1766516747516,2b50c7db092b6dc9ae36249d114bd85396746f0b795a72f18bc9e9432fdd325b
_next/static/chunks/app/app/cv/page-492c1c2b5ea110d3.js,1766516747517,27b93316c1ef03d32314815e1199788b00fbc1166d05264ad35be6c9b1aed703
_next/static/chunks/app/app/credits/page-afe0ce4cf8da1f59.js,1766516747516,7572d8149de19adcb718582a8fbe62aacc563f5bf5998fc4683b678a5ad3af9c
_next/static/chunks/app/app/apply/page-cf0ee0e768561642.js,1766516747516,1b88d79376396f77cdfb2520e7eec3848bd4533744dcf0d4638c8768c5073c5f
_next/static/chunks/app/admin/page-f161718d3c048788.js,1766516747509,8bc2d31560e4e32b0c29fd167e4bda2a4c421fdbf15a83fe5ad1253555f62b2a
_next/static/chunks/app/admin/logs/page-e8c5c4ae49457b18.js,1766516747515,554379c156358ee21df7e2bad9172a59004c4a34179d606eec21ae1da9d2e808
_next/static/chunks/app/admin/login/page-d0fa36fddfc7acd4.js,1766516747515,b90b810232b2619ad3be8ca04464545ed5bee12883d847e4577c1320ac8f4e14
_next/static/chunks/app/_not-found/page-7494094633467ef3.js,1766516747508,dcfa115b285fc1e7d920913e1a0464349f8c270c107df17678afbcaee62abec0
_next/static/IlA4IUG3fQpM1zdQiAMyW/_ssgManifest.js,1766516747501,02dbc1aeab6ef0a6ff2ff9a1643158cf9bb38929945eaa343a3627dee9ba6778
_next/static/IlA4IUG3fQpM1zdQiAMyW/_buildManifest.js,1766516747503,f46b17d6e2e887329d388286773626796e64b52f4cd965c9b0fe037e97f3ad58
````

## File: app/api/generate-cv/route.ts
````typescript
import { NextResponse } from "next/server";

export const runtime = "nodejs";
export const dynamic = "force-dynamic";

// URL de ta Cloud Function Google
const UPSTREAM =
  process.env.GENERATE_LETTER_UPSTREAM ||
  "https://europe-west1-assistant-ia-v4.cloudfunctions.net/generateLetterAndPitch";

export async function POST(req: Request) {
  try {
    // 1. R√©cup√©ration des headers (Auth + Recaptcha)
    const auth = req.headers.get("authorization") || "";
    const headerRecaptcha = req.headers.get("x-recaptcha-token") || "";

    const body = await req.json().catch(() => null);
    if (!body) {
      return NextResponse.json({ error: "Body JSON invalide." }, { status: 400 });
    }

    // 2. Support recaptcha dans header OU body
    const bodyRecaptcha =
      typeof body?.recaptchaToken === "string" ? body.recaptchaToken : "";
    const recaptcha = headerRecaptcha || bodyRecaptcha;

    // 3. Appel Cloud Function (Server-to-Server)
    const upstreamRes = await fetch(UPSTREAM, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        ...(auth ? { Authorization: auth } : {}), // On transmet le token
        ...(recaptcha ? { "X-Recaptcha-Token": recaptcha } : {}),
      },
      body: JSON.stringify(body),
      cache: "no-store",
    });

    // 4. Renvoi de la r√©ponse
    const contentType =
      upstreamRes.headers.get("content-type") || "application/json";
    const text = await upstreamRes.text();

    return new NextResponse(text, {
      status: upstreamRes.status,
      headers: { "Content-Type": contentType },
    });
  } catch (e: any) {
    console.error("API /generateLetterAndPitch error:", e);
    return NextResponse.json({ error: "internal_error" }, { status: 500 });
  }
}
````

## File: app/api/generate-zip/route.ts
````typescript
// app/api/generate-zip/route.ts

import { NextResponse } from "next/server";
import { getApps, initializeApp, applicationDefault, cert } from "firebase-admin/app";
import { getAuth } from "firebase-admin/auth";
import { getFirestore, FieldValue } from "firebase-admin/firestore";
import JSZip from "jszip";
import { PDFDocument, StandardFonts, rgb } from "pdf-lib";

// ‚ö†Ô∏è Pour typer proprement le cast √† la fin
type BodyInitCompat = BodyInit | null | undefined;

export const runtime = "nodejs";
export const dynamic = "force-dynamic";

function getAdminApp() {
  if (getApps().length) return getApps()[0];

  const projectId = process.env.FIREBASE_ADMIN_PROJECT_ID || process.env.FIREBASE_PROJECT_ID;
  const clientEmail = process.env.FIREBASE_ADMIN_CLIENT_EMAIL;
  const privateKeyRaw = process.env.FIREBASE_ADMIN_PRIVATE_KEY;

  if (projectId && clientEmail && privateKeyRaw) {
    const privateKey = privateKeyRaw.replace(/\\n/g, "\n");
    return initializeApp({
      credential: cert({ projectId, clientEmail, privateKey }),
    });
  }

  return initializeApp({
    credential: applicationDefault(),
  });
}

async function requireUser(req: Request) {
  getAdminApp();

  const authHeader = req.headers.get("authorization") || "";
  const token = authHeader.startsWith("Bearer ") ? authHeader.slice(7).trim() : "";

  if (!token) {
    return { ok: false as const, status: 401, error: "Missing Authorization Bearer token" };
  }

  try {
    const decoded = await getAuth().verifyIdToken(token);
    return { ok: true as const, uid: decoded.uid, email: decoded.email || "" };
  } catch (e) {
    console.error("verifyIdToken error:", e);
    return { ok: false as const, status: 401, error: "Invalid token" };
  }
}

async function consumeCreditsAndLog(params: {
  uid: string;
  email: string;
  cost: number; // ex 2
  tool: string; // generateCvLmZip
  docType: "cv" | "lm" | "other";
  meta?: any;
}) {
  getAdminApp();
  const db = getFirestore();

  const userRef = db.collection("users").doc(params.uid);
  const usageRef = db.collection("usageLogs").doc();
  const now = Date.now();

  await db.runTransaction(async (tx) => {
    const snap = await tx.get(userRef);
    const data = snap.exists ? snap.data() || {} : {};
    const currentCredits = typeof data.credits === "number" ? data.credits : 0;

    if (currentCredits < params.cost) {
      const err: any = new Error("NO_CREDITS");
      err.code = "NO_CREDITS";
      throw err;
    }

    tx.set(
      userRef,
      {
        credits: currentCredits - params.cost,
        totalIaCalls: FieldValue.increment(1),
        totalDocumentsGenerated: FieldValue.increment(2), // zip = 2 docs (cv + lm)
        totalCvGenerated: FieldValue.increment(1),
        totalLmGenerated: FieldValue.increment(1),
        updatedAt: FieldValue.serverTimestamp(),
      },
      { merge: true }
    );

    tx.set(
      usageRef,
      {
        userId: params.uid,
        email: params.email || "",
        action: "generate_document",
        docType: params.docType,
        eventType: "generate",
        tool: params.tool,
        creditsDelta: -params.cost,
        meta: params.meta || null,
        createdAt: now,
        createdAtServer: FieldValue.serverTimestamp(),
      },
      { merge: true }
    );
  });
}

function buildProfileContextForIA(profile: any) {
  const p = profile || {};

  let skillsArr: any[] = [];
  if (Array.isArray(p.skills)) {
    skillsArr = p.skills;
  } else if (p.skills && typeof p.skills === "object") {
    if (Array.isArray(p.skills.sections)) {
      p.skills.sections.forEach((sec: any) => {
        if (Array.isArray(sec.items)) skillsArr = skillsArr.concat(sec.items);
      });
    }
    if (Array.isArray(p.skills.tools)) skillsArr = skillsArr.concat(p.skills.tools);
  }

  const skillsStr = (skillsArr || []).join(", ");

  const expStr = Array.isArray(p.experiences)
    ? p.experiences
        .map(
          (e: any) =>
            `${e.role || e.title || ""} chez ${e.company || ""} (${e.dates || ""}): ${(e.bullets || []).join(" ")}`
        )
        .join("; \n")
    : "";

  const eduStr = Array.isArray(p.education)
    ? p.education
        .map((e: any) => `${e.degree || e.title || ""} - ${e.school || e.institution || ""} (${e.dates || ""})`)
        .join("; \n")
    : "";

  return `Nom: ${p.fullName || p.name || ""}
Titre: ${p.profileHeadline || p.title || ""}
Contact: ${p.email || ""} | ${p.phone || ""} | ${p.linkedin || ""} | ${p.city || ""}
R√©sum√© de profil: ${p.profileSummary || p.summary || ""}
Comp√©tences: ${skillsStr}
Exp√©riences: 
${expStr}
Formations: 
${eduStr}
Certifications: ${p.certs || ""}
Langues: ${p.langLine || p.lang || ""}`.trim();
}

async function callGeminiText(
  prompt: string,
  apiKey: string,
  temperature = 0.65,
  maxOutputTokens = 1400
) {
  const endpoint = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent";

  const body = {
    contents: [{ role: "user", parts: [{ text: prompt }] }],
    generationConfig: { temperature, maxOutputTokens },
  };

  const resp = await fetch(endpoint, {
    method: "POST",
    headers: { "Content-Type": "application/json", "x-goog-api-key": apiKey },
    body: JSON.stringify(body),
  });

  if (!resp.ok) {
    const errorText = await resp.text();
    throw new Error("Erreur Gemini (texte): " + errorText);
  }

  const data = await resp.json();
  const parts = data?.candidates?.[0]?.content?.parts || [];
  const text = parts
    .map((p: any) => (typeof p.text === "string" ? p.text : ""))
    .join("\n")
    .trim();

  if (!text) throw new Error("R√©ponse Gemini (texte) vide");
  return text;
}

function buildFallbackLetterBody(profile: any, jobTitle: string, companyName: string, lang: string) {
  const p = profile || {};
  const primaryDomain = p.primaryDomain || "";
  const summary = p.profileSummary || "";
  const firstExp = Array.isArray(p.experiences) && p.experiences.length ? p.experiences[0] : null;
  const role = firstExp?.role || firstExp?.title || "";
  const company = firstExp?.company || "";
  const years = Array.isArray(p.experiences) && p.experiences.length > 0 ? p.experiences.length : null;

  if (lang === "en") {
    return `I am writing to express my interest in the position of ${jobTitle || "your advertised role"} at ${
      companyName || "your company"
    }. ${summary || ""}

With ${years ? years + " years of experience" : "solid experience"} in ${primaryDomain || "my field"}, I have developed skills relevant to this opportunity.

In my previous experience at ${company || "my last company"}, I contributed to projects and collaborated with different stakeholders.

I would be delighted to discuss how I can contribute to your team.`;
  }

  return `Je vous √©cris pour vous faire part de mon int√©r√™t pour le poste de ${jobTitle || "..."} au sein de ${
    companyName || "votre entreprise"
  }. ${summary || ""}

Avec ${years ? years + " ans d‚Äôexp√©rience" : "une exp√©rience significative"} ${
    primaryDomain ? "dans " + primaryDomain : "dans mon domaine"
  }, j‚Äôai d√©velopp√© des comp√©tences solides en ${role || "gestion de projets, collaboration et suivi d‚Äôobjectifs"}.

Je serais ravi(e) d‚Äô√©changer plus en d√©tail lors d‚Äôun entretien.`;
}

async function createSimpleCvPdf(profile: any, options: any) {
  const { targetJob = "", lang = "fr", contract = "", jobLink = "", jobDescription = "" } = options || {};

  const p = profile || {};
  const pdfDoc = await PDFDocument.create();
  const page = pdfDoc.addPage([595.28, 841.89]); // A4
  const font = await pdfDoc.embedFont(StandardFonts.Helvetica);
  const fontBold = await pdfDoc.embedFont(StandardFonts.HelveticaBold);

  const { width, height } = page.getSize();
  const marginX = 50;
  let y = height - 60;

  function drawLine(text: string, size = 11, bold = false) {
    if (!text || y < 50) return;
    const f = bold ? fontBold : font;
    page.drawText(text, { x: marginX, y, size, font: f, color: rgb(0.1, 0.12, 0.16) });
    y -= size + 4;
  }

  function drawParagraph(text: string, size = 10) {
    if (!text) return;
    const f = font;
    const maxWidth = width - marginX * 2;
    const paragraphs = text.split(/\n{2,}/);

    for (const paragraph of paragraphs) {
      const words = paragraph.split(/\s+/);
      let line = "";

      for (const w of words) {
        const testLine = line ? line + " " + w : w;
        const testWidth = f.widthOfTextAtSize(testLine, size);
        if (testWidth > maxWidth) {
          if (y < 50) return;
          page.drawText(line, { x: marginX, y, size, font: f, color: rgb(0.1, 0.12, 0.16) });
          y -= size + 3;
          line = w;
        } else {
          line = testLine;
        }
      }

      if (line && y >= 50) {
        page.drawText(line, { x: marginX, y, size, font: f, color: rgb(0.1, 0.12, 0.16) });
        y -= size + 6;
      }
      y -= 2;
    }
  }

  function drawSectionTitle(title: string) {
    if (!title || y < 60) return;
    page.drawText(title, { x: marginX, y, size: 11, font: fontBold, color: rgb(0.08, 0.15, 0.45) });
    y -= 14;
  }

  function drawBullet(text: string, size = 9) {
    if (!text || y < 50) return;
    const f = font;
    const bulletX = marginX + 8;
    const maxWidth = width - marginX * 2 - 10;
    const words = text.split(/\s+/);
    let line = "";
    let firstLine = true;

    for (const w of words) {
      const testLine = line ? line + " " + w : w;
      const testWidth = f.widthOfTextAtSize(testLine, size);
      if (testWidth > maxWidth) {
        if (y < 50) return;
        page.drawText(firstLine ? "‚Ä¢ " + line : "  " + line, {
          x: bulletX,
          y,
          size,
          font: f,
          color: rgb(0.1, 0.12, 0.16),
        });
        y -= size + 3;
        line = w;
        firstLine = false;
      } else {
        line = testLine;
      }
    }

    if (line && y >= 50) {
      page.drawText(firstLine ? "‚Ä¢ " + line : "  " + line, {
        x: bulletX,
        y,
        size,
        font: f,
        color: rgb(0.1, 0.12, 0.16),
      });
      y -= size + 3;
    }
  }

  // Header
  drawLine(p.fullName || "", 16, true);
  const jobLine = targetJob || contract || p.contractType || (lang === "en" ? "Target position" : "Poste recherch√©");
  drawLine(jobLine, 11, false);

  const contactParts = [p.email || "", p.phone || "", p.city || "", p.linkedin || ""].filter(Boolean);
  if (contactParts.length) drawLine(contactParts.join(" ¬∑ "), 9, false);

  if (jobLink) drawLine((lang === "en" ? "Job link: " : "Lien de l'offre : ") + jobLink, 8, false);

  y -= 6;

  if (p.profileSummary) {
    drawSectionTitle(lang === "en" ? "Profile" : "Profil");
    drawParagraph(p.profileSummary, 9.5);
    y -= 4;
  }

  if (p.skills && Array.isArray(p.skills.sections) && p.skills.sections.length) {
    drawSectionTitle(lang === "en" ? "Key skills" : "Comp√©tences cl√©s");
    p.skills.sections.forEach((sec: any) => {
      if (!sec || (!sec.title && !Array.isArray(sec.items))) return;
      if (sec.title) drawLine(sec.title, 9.5, true);
      if (Array.isArray(sec.items)) drawParagraph(sec.items.join(" ¬∑ "), 9);
      y -= 2;
    });
  }

  if (Array.isArray(p.experiences) && p.experiences.length) {
    drawSectionTitle(lang === "en" ? "Experience" : "Exp√©riences professionnelles");
    p.experiences.forEach((exp: any) => {
      if (y < 90) return;
      const header = [exp.role, exp.company].filter(Boolean).join(" ‚Äî ");
      if (header) drawLine(header, 10, true);
      if (exp.dates) drawLine(exp.dates, 8.5, false);
      if (Array.isArray(exp.bullets)) exp.bullets.slice(0, 4).forEach((b: string) => drawBullet(b, 8.5));
      y -= 4;
    });
  }

  if (Array.isArray(p.education) && p.education.length && y > 80) {
    drawSectionTitle(lang === "en" ? "Education" : "Formation");
    p.education.forEach((ed: any) => {
      if (y < 60) return;
      const header = [ed.degree, ed.school].filter(Boolean).join(" ‚Äî ");
      if (header) drawLine(header, 9.5, true);
      if (ed.dates) drawLine(ed.dates, 8.5, false);
      y -= 4;
    });
  }

  if (p.langLine && y > 60) {
    drawSectionTitle(lang === "en" ? "Languages" : "Langues");
    drawParagraph(p.langLine, 9);
  }

  if (Array.isArray(p.hobbies) && p.hobbies.length && y > 60) {
    drawSectionTitle(lang === "en" ? "Interests" : "Centres d'int√©r√™t");
    drawParagraph(p.hobbies.join(" ¬∑ "), 9);
  }

  const pdfBytes = await pdfDoc.save();
  return Buffer.from(pdfBytes);
}

async function createLetterPdf(coverLetter: string, meta: any) {
  const { jobTitle = "", companyName = "", candidateName = "", lang = "fr" } = meta || {};

  const pdfDoc = await PDFDocument.create();
  const page = pdfDoc.addPage([595.28, 841.89]); // A4
  const font = await pdfDoc.embedFont(StandardFonts.Helvetica);
  const fontBold = await pdfDoc.embedFont(StandardFonts.HelveticaBold);

  const { width, height } = page.getSize();
  const marginX = 60;
  let y = height - 70;

  function drawLine(text: string, size = 11, bold = false) {
    if (!text || y < 60) return;
    const f = bold ? fontBold : font;
    page.drawText(text, { x: marginX, y, size, font: f, color: rgb(0.15, 0.17, 0.23) });
    y -= size + 4;
  }

  function drawParagraph(text: string, size = 11) {
    if (!text) return;
    const f = font;
    const maxWidth = width - marginX * 2;
    const paragraphs = text.split(/\n{2,}/);

    for (const paragraph of paragraphs) {
      const words = paragraph.split(/\s+/);
      let line = "";

      for (const w of words) {
        const testLine = line ? line + " " + w : w;
        const testWidth = f.widthOfTextAtSize(testLine, size);
        if (testWidth > maxWidth) {
          if (y < 60) return;
          page.drawText(line, { x: marginX, y, size, font: f, color: rgb(0.15, 0.17, 0.23) });
          y -= size + 4;
          line = w;
        } else {
          line = testLine;
        }
      }

      if (line && y >= 60) {
        page.drawText(line, { x: marginX, y, size, font: f, color: rgb(0.15, 0.17, 0.23) });
        y -= size + 8;
      }

      y -= 4;
    }
  }

  if (candidateName) drawLine(candidateName, 14, true);

  if (jobTitle || companyName) {
    const titleLine =
      lang === "en"
        ? `Application for ${jobTitle || "the position"} ‚Äì ${companyName || "Company"}`
        : `Candidature : ${jobTitle || "poste"} ‚Äì ${companyName || "Entreprise"}`;
    drawLine(titleLine, 11, false);
  }

  y -= 10;
  drawParagraph(coverLetter, 11);

  const pdfBytes = await pdfDoc.save();
  return Buffer.from(pdfBytes);
}

export async function POST(req: Request) {
  const auth = await requireUser(req);
  if (!auth.ok) return NextResponse.json({ ok: false, error: auth.error }, { status: auth.status });

  let body: any = null;
  try {
    body = await req.json();
  } catch {
    return NextResponse.json({ ok: false, error: "Invalid JSON body" }, { status: 400 });
  }

  const profile = body?.profile;
  const targetJob = body?.targetJob || "";
  const langRaw = body?.lang || "fr";
  const contract = body?.contract || "";
  const jobLink = body?.jobLink || "";
  const jobDescription = body?.jobDescription || "";

  const lm = body?.lm || {};
  const companyName = lm?.companyName || "";
  const jobTitle = lm?.jobTitle || targetJob || "";
  const lmJobDescription = lm?.jobDescription || jobDescription || "";
  const lmLangRaw = lm?.lang || langRaw;

  const lang = String(langRaw).toLowerCase().startsWith("en") ? "en" : "fr";
  const lmLang = String(lmLangRaw).toLowerCase().startsWith("en") ? "en" : "fr";

  if (!profile) return NextResponse.json({ ok: false, error: "Missing profile" }, { status: 400 });

  // ‚úÖ D√©bit -2 cr√©dits (CV + LM) + log
  try {
    await consumeCreditsAndLog({
      uid: auth.uid,
      email: auth.email,
      cost: 2,
      tool: "generateCvLmZip",
      docType: "other",
      meta: { targetJob, jobTitle, companyName, lang, lmLang },
    });
  } catch (e: any) {
    if (e?.code === "NO_CREDITS" || e?.message === "NO_CREDITS") {
      return NextResponse.json({ ok: false, error: "NO_CREDITS" }, { status: 402 });
    }
    console.error("consumeCreditsAndLog error:", e);
    return NextResponse.json({ ok: false, error: "CREDITS_ERROR" }, { status: 500 });
  }

  // CV PDF
  let cvBuffer: Buffer;
  try {
    cvBuffer = await createSimpleCvPdf(profile, {
      targetJob,
      lang,
      contract,
      jobLink,
      jobDescription,
    });
  } catch (e: any) {
    console.error("CV PDF error:", e);
    return NextResponse.json({ ok: false, error: e?.message || "CV_PDF_ERROR" }, { status: 500 });
  }

  // LM BODY via Gemini
  const GEMINI_API_KEY = process.env.GEMINI_API_KEY || "";
  const cvText = buildProfileContextForIA(profile);

  let coverLetterBody = "";

  if (GEMINI_API_KEY) {
    const promptLm =
      lmLang === "en"
        ? `
You are a senior career coach and recruiter.

TASK:
Write ONLY the BODY of a cover letter tailored to the job, using ONLY the provided information (CV + job description).

INPUTS:
- Job title: "${jobTitle || "the role"}"
- Company: "${companyName || "your company"}"
- Job description:
${lmJobDescription || "‚Äî"}

- Candidate profile (source of truth):
${cvText}

STRICT RULES:
- Do NOT invent facts (no fake metrics, clients, tools, dates).
- 3 to 5 paragraphs separated by ONE blank line.
- No header, no subject line, no greeting, no signature.
- Output MUST be STRICT JSON only:
{ "body": "..." }
`.trim()
        : `
Tu es un coach carri√®res senior et recruteur.

MISSION :
R√©dige UNIQUEMENT le CORPS d‚Äôune lettre de motivation adapt√©e au poste, bas√©e UNIQUEMENT sur les infos fournies (CV + fiche de poste).

ENTR√âES :
- Intitul√© : "${jobTitle || targetJob || "le poste"}"
- Entreprise : "${companyName || "votre entreprise"}"
- Fiche de poste :
${lmJobDescription || "‚Äî"}

- Profil candidat :
${cvText}

R√àGLES :
- Ne pas inventer (pas de chiffres/clients/technos non pr√©sents).
- 3 √† 5 paragraphes s√©par√©s par une ligne vide.
- Pas d‚Äôen-t√™te, pas d‚Äôobjet, pas de salutation, pas de signature.
- R√©ponds STRICTEMENT en JSON :
{ "body": "..." }
`.trim();

    try {
      const rawLm = await callGeminiText(promptLm, GEMINI_API_KEY, 0.65, 1400);
      const cleaned = String(rawLm).replace(/```json|```/gi, "").trim();
      try {
        const parsed = JSON.parse(cleaned);
        coverLetterBody = typeof parsed.body === "string" ? parsed.body.trim() : "";
      } catch {
        coverLetterBody = String(rawLm || "").trim();
      }
    } catch (e) {
      console.error("Gemini LM error:", e);
    }
  }

  if (!coverLetterBody) {
    coverLetterBody = buildFallbackLetterBody(profile, jobTitle, companyName, lmLang);
  }

  // LM PDF
  let lmBuffer: Buffer;
  try {
    lmBuffer = await createLetterPdf(coverLetterBody, {
      jobTitle,
      companyName,
      candidateName: profile.fullName || "",
      lang: lmLang,
    });
  } catch (e: any) {
    console.error("LM PDF error:", e);
    return NextResponse.json({ ok: false, error: e?.message || "LM_PDF_ERROR" }, { status: 500 });
  }

  // ZIP ‚úÖ (avec cast pour calmer TypeScript)
  try {
    const zip = new JSZip();
    zip.file("cv-ia.pdf", cvBuffer);
    zip.file(lmLang === "en" ? "cover-letter.pdf" : "lettre-motivation.pdf", lmBuffer);

    const zipContent = await zip.generateAsync({ type: "uint8array" });

    return new NextResponse(zipContent as unknown as BodyInitCompat, {
      status: 200,
      headers: {
        "Content-Type": "application/zip",
        "Content-Disposition": 'attachment; filename="cv-lm-ia.zip"',
        "Content-Length": String(zipContent.byteLength),
      },
    });
  } catch (e: any) {
    console.error("ZIP error:", e);
    return NextResponse.json({ ok: false, error: e?.message || "ZIP_ERROR" }, { status: 500 });
  }
}
````

## File: app/api/interview/route.ts
````typescript
// app/api/interview/route.ts
import { NextRequest, NextResponse } from "next/server";
import {
  buildPrompt,
  InterviewLevel,
  InterviewChannel,
  HistoryItem,
} from "@/lib/interviewPrompt";
import { verifyUserAndCredits, consumeCredit } from "@/lib/server/credits";

export const runtime = "nodejs";

/**
 * ‚úÖ reCAPTCHA OFF par d√©faut
 * -> Active uniquement si INTERVIEW_REQUIRE_RECAPTCHA=true
 */
const REQUIRE_RECAPTCHA =
  (process.env.INTERVIEW_REQUIRE_RECAPTCHA || "").toLowerCase().trim() ===
  "true";

// ---- Sessions en m√©moire (DEV) ---- //
type InterviewSession = {
  userId: string;
  createdAt: string;
  lastUpdated: string;
  jobDesc: string;
  cvSummary: string;
  mode: string;
  level: InterviewLevel;
  channel: InterviewChannel;
  status: "active" | "completed";
  currentStep: number;
  history: HistoryItem[];
  score?: number | null;
  finalSummary?: string | null;
};

const memorySessions = new Map<string, InterviewSession>();

function createSessionId() {
  try {
    // @ts-ignore
    return crypto.randomUUID();
  } catch {
    return Math.random().toString(36).slice(2) + "-" + Date.now().toString(36);
  }
}

function purgeOldSessions(maxAgeMs = 1000 * 60 * 60 * 6) {
  const now = Date.now();
  for (const [sid, s] of memorySessions.entries()) {
    const t = Date.parse(s.lastUpdated || s.createdAt);
    if (!Number.isNaN(t) && now - t > maxAgeMs) memorySessions.delete(sid);
  }
}

// ---------------- reCAPTCHA (Enterprise via CF recaptchaVerify) ----------------
type RecaptchaVerifyResult =
  | { ok: true; score?: number }
  | { ok: false; reason: string; score?: number };

function stripTrailingSlash(s: string) {
  return s.endsWith("/") ? s.slice(0, -1) : s;
}

function getApiBaseServer(): string {
  return stripTrailingSlash(
    process.env.CLOUD_FUNCTIONS_BASE_URL ||
      process.env.API_BASE_URL ||
      "https://europe-west1-assistant-ia-v4.cloudfunctions.net"
  );
}

async function verifyRecaptchaEnterpriseViaCF(
  token: string,
  action: string
): Promise<RecaptchaVerifyResult> {
  const base = getApiBaseServer();
  try {
    const res = await fetch(`${base}/recaptchaVerify`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ token, action: (action || "").trim() }),
      cache: "no-store",
    });

    const data: any = await res.json().catch(() => null);

    if (!res.ok || !data?.ok) {
      return {
        ok: false,
        reason: String(data?.reason || data?.error || "recaptcha_failed"),
        score: typeof data?.score === "number" ? data.score : undefined,
      };
    }

    return {
      ok: true,
      score: typeof data?.score === "number" ? data.score : undefined,
    };
  } catch (e: any) {
    return { ok: false, reason: e?.message || "network_error" };
  }
}

// ---- Handler principal ---- //
export async function POST(req: NextRequest) {
  try {
    purgeOldSessions();

    const body = await req.json().catch(() => null);
    if (!body || typeof body !== "object") {
      return NextResponse.json({ error: "Invalid JSON body" }, { status: 400 });
    }

    const { action } = body as any;

    // ‚úÖ token peut venir de plusieurs endroits (selon ton front)
    const recaptchaToken =
      (body as any)?.recaptchaToken ||
      (body as any)?.token ||
      (body as any)?.recaptcha?.token ||
      null;

    const recaptchaAction =
      (body as any)?.recaptchaAction ||
      (body as any)?.recaptcha?.action ||
      "interview";

    // ‚úÖ reCAPTCHA (optionnel)
    if (REQUIRE_RECAPTCHA) {
      if (!recaptchaToken || typeof recaptchaToken !== "string") {
        return NextResponse.json(
          {
            error: "reCAPTCHA failed",
            details: "token_missing_or_invalid",
            requireRecaptcha: true,
            expectedAction: recaptchaAction,
          },
          { status: 403 }
        );
      }

      const rec = await verifyRecaptchaEnterpriseViaCF(
        recaptchaToken,
        recaptchaAction
      );

      if (!rec.ok) {
        return NextResponse.json(
          {
            error: "reCAPTCHA failed",
            details: rec.reason,
            score: rec.score ?? null,
            requireRecaptcha: true,
            expectedAction: recaptchaAction,
          },
          { status: 403 }
        );
      }
    }

    // ---------- START ---------- //
    if (action === "start") {
      const { userId, jobDesc, cvSummary, mode, channel, level } = body as any;

      if (!userId) {
        return NextResponse.json({ error: "Missing userId" }, { status: 400 });
      }

      const user = await verifyUserAndCredits(userId);
      if (!user) {
        return NextResponse.json(
          { error: "Unauthorized or no credits" },
          { status: 401 }
        );
      }

      const nowIso = new Date().toISOString();
      const safeMode = (mode || "mixed") as string;
      const safeChannel = (channel || "written") as InterviewChannel;
      const safeLevel = (level || "junior") as InterviewLevel;

      const sessionId = createSessionId();

      const sessionData: InterviewSession = {
        userId,
        createdAt: nowIso,
        lastUpdated: nowIso,
        jobDesc: jobDesc || "",
        cvSummary: cvSummary || "",
        mode: safeMode,
        level: safeLevel,
        channel: safeChannel,
        status: "active",
        currentStep: 1,
        history: [],
      };

      memorySessions.set(sessionId, sessionData);

      const prompt = buildPrompt({
        cvSummary: sessionData.cvSummary,
        jobDesc: sessionData.jobDesc,
        mode: sessionData.mode,
        level: sessionData.level,
        channel: sessionData.channel,
        history: [],
        step: 1,
      });

      const llmResponseText = await callLLM(prompt);

      let parsed: any;
      try {
        parsed = JSON.parse(llmResponseText);
      } catch {
        parsed = { next_question: "Parlez-moi de vous.", short_analysis: null };
      }

      const firstQuestion = parsed.next_question || "Parlez-moi de vous.";

      const historyItem: HistoryItem = {
        role: "interviewer",
        text: firstQuestion,
        createdAt: new Date().toISOString(),
      };

      const updatedSession = memorySessions.get(sessionId);
      if (updatedSession) {
        updatedSession.history.push(historyItem);
        updatedSession.currentStep = 1;
        updatedSession.lastUpdated = new Date().toISOString();
        memorySessions.set(sessionId, updatedSession);
      }

      await consumeCredit(userId);

      return NextResponse.json({
        sessionId,
        firstQuestion,
        shortAnalysis: parsed.short_analysis ?? null,
      });
    }

    // ---------- ANSWER ---------- //
    if (action === "answer") {
      const { userId, sessionId, userMessage, channel, step } = body as any;

      if (!userId || !sessionId || !userMessage?.trim()) {
        return NextResponse.json(
          { error: "Missing userId, sessionId or userMessage" },
          { status: 400 }
        );
      }

      const user = await verifyUserAndCredits(userId);
      if (!user) {
        return NextResponse.json(
          { error: "Unauthorized or no credits" },
          { status: 401 }
        );
      }

      const session = memorySessions.get(sessionId);
      if (!session) {
        return NextResponse.json({ error: "Session not found" }, { status: 404 });
      }

      if (session.userId !== userId) {
        return NextResponse.json({ error: "Forbidden" }, { status: 403 });
      }

      const history = Array.isArray(session.history) ? [...session.history] : [];

      history.push({
        role: "candidate",
        text: userMessage,
        createdAt: new Date().toISOString(),
      });

      const nextStep =
        typeof step === "number" && Number.isFinite(step)
          ? step
          : (session.currentStep || 1) + 1;

      const prompt = buildPrompt({
        cvSummary: session.cvSummary,
        jobDesc: session.jobDesc,
        mode: session.mode,
        level: (session.level || "junior") as InterviewLevel,
        channel: (channel || session.channel || "written") as InterviewChannel,
        history,
        step: nextStep,
      });

      const llmResponseText = await callLLM(prompt);

      let parsed: any;
      try {
        parsed = JSON.parse(llmResponseText);
      } catch {
        parsed = {
          next_question: "Merci. Peux-tu illustrer avec un exemple concret ?",
          short_analysis: "",
          final_summary: null,
          final_score: null,
        };
      }

      const nextQuestion =
        parsed.next_question || "Merci, l‚Äôentretien est termin√©.";
      const shortAnalysis = parsed.short_analysis ?? "";
      const isFinal = Boolean(parsed.final_summary);

      history.push({
        role: "interviewer",
        text: nextQuestion,
        createdAt: new Date().toISOString(),
      });

      const updated: InterviewSession = {
        ...session,
        history,
        lastUpdated: new Date().toISOString(),
        currentStep: nextStep,
      };

      if (isFinal) {
        updated.status = "completed";
        updated.score = parsed.final_score ?? null;
        updated.finalSummary = parsed.final_summary ?? null;
      }

      memorySessions.set(sessionId, updated);

      await consumeCredit(userId);

      return NextResponse.json({
        nextQuestion,
        shortAnalysis,
        finalSummary: parsed.final_summary ?? null,
        finalScore: parsed.final_score ?? null,
        isFinal,
      });
    }

    return NextResponse.json({ error: "Unknown action" }, { status: 400 });
  } catch (err) {
    console.error("Interview API error:", err);
    return NextResponse.json({ error: "Internal error" }, { status: 500 });
  }
}

// ---- APPEL GEMINI ---- //
async function callLLM(prompt: string): Promise<string> {
  const apiKey = process.env.GEMINI_API_KEY;

  if (!apiKey) {
    return JSON.stringify({
      next_question:
        "Mode d√©mo : peux-tu me r√©sumer ton exp√©rience la plus r√©cente en lien avec ce poste ?",
      short_analysis:
        "Mode d√©mo sans Gemini : configure GEMINI_API_KEY pour avoir l‚Äôanalyse r√©elle.",
      final_summary: null,
      final_score: null,
    });
  }

  const modelRaw = process.env.GEMINI_MODEL || "models/gemini-2.5-flash";
  const model = modelRaw.startsWith("models/") ? modelRaw : `models/${modelRaw}`;
  const url = `https://generativelanguage.googleapis.com/v1beta/${model}:generateContent?key=${apiKey}`;

  const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };

  const resp = await fetch(url, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload),
  });

  if (!resp.ok) {
    const errorText = await resp.text().catch(() => "");
    console.error("Gemini error (interview):", resp.status, errorText);
    return JSON.stringify({
      next_question:
        "Je n'arrive pas √† joindre l‚ÄôIA. Donne-moi : contexte / actions / r√©sultats (STAR).",
      short_analysis: `Fallback Gemini HTTP ${resp.status}`,
      final_summary: null,
      final_score: null,
    });
  }

  const data = await resp.json().catch(() => null);

  const textRaw: string =
    data?.candidates?.[0]?.content?.parts
      ?.map((p: any) => p.text || "")
      .join("")
      .trim() || "";

  if (!textRaw) {
    return JSON.stringify({
      next_question: "Peux-tu pr√©ciser ?",
      short_analysis: "",
      final_summary: null,
      final_score: null,
    });
  }

  return textRaw.trim();
}
````

## File: app/app/credits/page.tsx
````typescript
"use client";

import { useEffect, useRef, useState } from "react";
import { useUserCredits } from "@/hooks/useUserCredits";
import { useAuth } from "@/context/AuthContext";
import { getRecaptchaToken } from "@/lib/recaptcha";
import { useRechargeHistory } from "@/hooks/useRechargeHistory";

type PackKey = "20" | "50" | "100";

const CREDIT_PACKS: {
  key: PackKey;
  label: string;
  credits: number;
  desc: string;
}[] = [
  {
    key: "20",
    credits: 20,
    label: "Pack D√©couverte",
    desc: "Id√©al pour tester les fonctionnalit√©s IA.",
  },
  {
    key: "50",
    credits: 50,
    label: "Pack Boost",
    desc: "Parfait pour une phase active de recherche.",
  },
  {
    key: "100",
    credits: 100,
    label: "Pack Intensif",
    desc: "Pour candidatures + entretiens √† fond.",
  },
];

// ‚öôÔ∏è Base de l'API :
// - en prod : Cloud Functions
// - en dev : tu peux override avec NEXT_PUBLIC_API_BASE_URL dans .env.local
const DEFAULT_API_BASE = "https://europe-west1-assistant-ia-v4.cloudfunctions.net";

const API_BASE = (process.env.NEXT_PUBLIC_API_BASE_URL || DEFAULT_API_BASE).replace(/\/+$/, "");

export default function CreditsPage() {
  const { user } = useAuth();
  const { credits, loading, error } = useUserCredits();

  const [buyLoading, setBuyLoading] = useState<PackKey | null>(null);
  const [buyError, setBuyError] = useState<string | null>(null);

  // üëâ URL d‚Äôembed du checkout Polar (quand non null, on affiche la popup)
  const [embedUrl, setEmbedUrl] = useState<string | null>(null);
  const iframeRef = useRef<HTMLIFrameElement | null>(null);

  // üéâ Animation / bandeau succ√®s dans la page
  const [showSuccessAnimation, setShowSuccessAnimation] = useState(false);

  // Pour info, si un jour tu veux savoir quel pack a √©t√© d√©marr√©
  const [lastPack, setLastPack] = useState<PackKey | null>(null);

  // Message global en haut de page (success / cancel)
  const [statusMessage, setStatusMessage] = useState<string | null>(null);

  // ‚úÖ IMPORTANT (Option B) :
  // on m√©morise le solde AVANT l‚Äôachat, puis on ferme automatiquement la popup
  // d√®s que credits > soldeAvant (webhook OK -> Firestore se met √† jour)
  const [creditsBeforePurchase, setCreditsBeforePurchase] = useState<number | null>(null);

  // ‚úÖ Historique des recharges
  const { items: recharges, loading: rechargesLoading, error: rechargesError } = useRechargeHistory(30);

  const triggerSuccessClose = (message?: string) => {
    setEmbedUrl(null);
    setBuyLoading(null);
    setLastPack(null);
    setCreditsBeforePurchase(null);

    setShowSuccessAnimation(true);
    window.setTimeout(() => setShowSuccessAnimation(false), 4000);

    setStatusMessage(message || "‚úÖ Paiement confirm√© ! Tes cr√©dits ont √©t√© ajout√©s √† ton compte.");
  };

  const handleBuy = async (pack: PackKey) => {
    try {
      setBuyError(null);
      setStatusMessage(null);

      if (!user?.uid || !user.email) {
        setBuyError("Tu dois √™tre connect√© pour recharger tes cr√©dits.");
        return;
      }

      setBuyLoading(pack);
      setLastPack(pack);

      // On capture le solde actuel pour d√©tecter l‚Äôaugmentation apr√®s webhook
      if (typeof credits === "number") {
        setCreditsBeforePurchase(credits);
      } else {
        setCreditsBeforePurchase(0);
      }

      // üëâ Appel √† ta Cloud Function HTTPS : /polarCheckout
      const endpoint = `${API_BASE}/polarCheckout`;

      // ‚úÖ reCAPTCHA token
      let recaptchaToken = "";
      try {
        recaptchaToken = await getRecaptchaToken("polar_checkout");
      } catch {
        setBuyError(
          "S√©curit√©: impossible de valider reCAPTCHA (script bloqu√© ?). D√©sactive l'adblock et r√©essaie."
        );
        setBuyLoading(null);
        setCreditsBeforePurchase(null);
        return;
      }

      const res = await fetch(endpoint, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          packId: pack, // "20" | "50" | "100"
          userId: user.uid, // pour externalCustomerId
          email: user.email, // pour customerEmail
          recaptchaToken, // ‚úÖ ajout√©
        }),
      });

      const contentType = res.headers.get("content-type") || "";
      let data: any = null;

      if (contentType.includes("application/json")) {
        data = await res.json();
      } else {
        const text = await res.text();
        console.error("[Credits] R√©ponse non JSON de /polarCheckout :", text.slice(0, 300));
        throw new Error(
          "Le serveur de paiement a renvoy√© une r√©ponse invalide (HTML). V√©rifie la fonction polarCheckout."
        );
      }

      if (!res.ok || !data?.url) {
        console.error("Erreur API /polarCheckout :", data);
        throw new Error(data?.error || "Impossible de cr√©er le paiement Polar.");
      }

      // üëâ On ajoute les params d‚Äôembed : embed=true & embed_origin=...
      const origin = window.location.origin;
      const urlBase = data.url as string;
      const sep = urlBase.includes("?") ? "&" : "?";
      const fullEmbedUrl = `${urlBase}${sep}embed=true&embed_origin=${encodeURIComponent(origin)}`;

      setEmbedUrl(fullEmbedUrl); // ouvre la popup
    } catch (e: any) {
      console.error("Erreur checkout Polar (iframe) :", e);
      setBuyError(
        e?.message || "Erreur lors de la cr√©ation du paiement. Essaie √† nouveau dans quelques instants."
      );
      setBuyLoading(null);
      setCreditsBeforePurchase(null);
    }
  };

  // üîê (Option A / bonus) : si un jour Polar redirige l‚Äôiframe vers ton domaine,
  // on peut fermer via status=success. Mais actuellement l‚Äôiframe reste chez Polar,
  // donc √ßa ne marche pas (cross-origin).
  const handleIframeLoad = () => {
    const iframe = iframeRef.current;
    if (!iframe) return;

    try {
      const win = iframe.contentWindow;
      if (!win) return;

      const href = win.location.href; // accessible seulement si m√™me origine

      if (href.includes("/app/credits") && href.includes("status=success")) {
        triggerSuccessClose("‚úÖ Paiement confirm√© ! Tes cr√©dits vont se mettre √† jour dans quelques instants.");
      }

      if (href.includes("/app/credits") && href.includes("status=cancel")) {
        setEmbedUrl(null);
        setBuyLoading(null);
        setLastPack(null);
        setCreditsBeforePurchase(null);
        setStatusMessage("Paiement annul√©.");
      }
    } catch {
      // cross-origin -> normal
    }
  };

  // ‚úÖ LA FERMETURE AUTO (Option B) :
  // D√®s que les cr√©dits augmentent apr√®s l‚Äôachat, on ferme la popup.
  useEffect(() => {
    if (!embedUrl) return;
    if (creditsBeforePurchase === null) return;
    if (loading) return;
    if (typeof credits !== "number") return;

    if (credits > creditsBeforePurchase) {
      triggerSuccessClose("‚úÖ Paiement confirm√© ! Tes cr√©dits ont √©t√© ajout√©s.");
    }
  }, [credits, loading, embedUrl, creditsBeforePurchase]);

  const closeModal = () => {
    setEmbedUrl(null);
    setBuyLoading(null);
    setLastPack(null);
    setCreditsBeforePurchase(null);
  };

  // Si on arrive sur /app/credits?status=success dans la page normale (sans iframe)
  useEffect(() => {
    if (typeof window === "undefined") return;
    const url = new URL(window.location.href);
    const status = url.searchParams.get("status");

    if (status === "success") {
      setStatusMessage("‚úÖ Paiement confirm√© ! Tes cr√©dits ont √©t√© pris en compte.");
      setShowSuccessAnimation(true);
      setTimeout(() => setShowSuccessAnimation(false), 4000);
    } else if (status === "cancel") {
      setStatusMessage("Paiement annul√©.");
    }
  }, []);

  return (
    <div className="space-y-6">
      {/* Animation succ√®s flottante */}
      {showSuccessAnimation && (
        <div className="fixed top-4 left-1/2 z-40 -translate-x-1/2">
          <div className="rounded-full border border-emerald-400/70 bg-emerald-500/10 px-4 py-2 shadow-lg backdrop-blur flex items-center gap-2 animate-[fadeInOut_4s_ease-in-out]">
            <span className="text-lg">‚ö°</span>
            <span className="text-[13px] text-emerald-200">Cr√©dits ajout√©s √† ton compte !</span>
          </div>
        </div>
      )}

      {/* Titre + r√©sum√© */}
      <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
        <div>
          <h1 className="text-lg sm:text-xl font-semibold text-[var(--ink)]">Cr√©dits IA</h1>
          <p className="text-[12px] text-[var(--muted)]">
            Utilise tes cr√©dits pour analyser ton CV, g√©n√©rer des lettres de motivation, des pitchs, et pr√©parer tes
            entretiens.
          </p>
        </div>

        {/* Petit r√©cap du solde */}
        <div className="inline-flex flex-col items-end gap-1">
          <span className="text-[11px] text-[var(--muted)]">Solde actuel</span>
          <div className="inline-flex items-center gap-2 rounded-full px-3 py-1.5 text-[12px] bg-[var(--bg-soft)] border border-[var(--border)]/80">
            <span className="text-[15px]">‚ö°</span>
            {loading ? (
              <span className="text-[var(--muted)]">Chargement‚Ä¶</span>
            ) : (
              <span className="font-semibold text-[var(--ink)]">{credits} cr√©dits</span>
            )}
          </div>
        </div>
      </div>

      {statusMessage && <p className="text-[12px] text-emerald-400">{statusMessage}</p>}
      {error && <p className="text-[12px] text-red-400">{error}</p>}

      {/* Packs de rechargement */}
      <section className="glass border border-[var(--border)]/80 rounded-2xl p-4 sm:p-5 space-y-4">
        <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
          <div>
            <h2 className="text-base font-semibold text-[var(--ink)]">Recharger mes cr√©dits</h2>
            <p className="text-[12px] text-[var(--muted)]">
              Choisis un pack ci-dessous pour ajouter des cr√©dits √† ton compte. Paiement s√©curis√© via Polar.
            </p>
          </div>

          <button
            type="button"
            onClick={() => {
              const el = document.getElementById("credit-packs");
              if (el) el.scrollIntoView({ behavior: "smooth", block: "start" });
            }}
            className="btn-primary text-[12px] px-3 py-1.5"
          >
            Ajouter du cr√©dit
          </button>
        </div>

        <div id="credit-packs" className="grid grid-cols-1 sm:grid-cols-3 gap-3 sm:gap-4 mt-2">
          {CREDIT_PACKS.map((pack) => (
            <div
              key={pack.key}
              className="card-soft border border-[var(--border)]/80 rounded-2xl p-3 sm:p-4 flex flex-col justify-between"
            >
              <div className="space-y-1">
                <div className="flex items-center justify-between gap-2">
                  <h3 className="text-[13px] font-semibold text-[var(--ink)]">{pack.label}</h3>
                  <span className="inline-flex items-center rounded-full px-2 py-[2px] text-[11px] bg-[var(--bg)] border border-[var(--border)]/80">
                    ‚ö° {pack.credits} cr√©dits
                  </span>
                </div>
                <p className="text-[12px] text-[var(--muted)]">{pack.desc}</p>
              </div>

              <div className="mt-3 flex flex-col gap-1">
                <button
                  type="button"
                  onClick={() => handleBuy(pack.key)}
                  disabled={buyLoading === pack.key}
                  className="btn-primary w-full text-[12px] flex items-center justify-center gap-2 disabled:opacity-60 disabled:cursor-not-allowed"
                >
                  {buyLoading === pack.key ? (
                    <>
                      <span className="loader" />
                      <span>Ouverture du paiement‚Ä¶</span>
                    </>
                  ) : (
                    <>
                      <span>Recharger</span>
                      <span className="text-[13px]">‚Üí</span>
                    </>
                  )}
                </button>
                <span className="text-[10px] text-[var(--muted)] text-center">
                  Paiement unique, pas d‚Äôabonnement.
                </span>
              </div>
            </div>
          ))}
        </div>

        {buyError && <p className="text-[12px] text-red-400">{buyError}</p>}
      </section>

      {/* Explication d‚Äôusage */}
      <section className="text-[11px] text-[var(--muted)] space-y-1">
        <p>1 cr√©dit ‚âà 1 action IA (analyse CV, g√©n√©ration de lettre, pitch, Q&A entretien‚Ä¶).</p>
        <p>
          Ton solde est mis √† jour automatiquement apr√®s chaque achat d√®s que le paiement est confirm√© (via le webhook
          Polar).
        </p>
      </section>

      {/* ‚úÖ Historique des recharges */}
      <section className="glass border border-[var(--border)]/80 rounded-2xl p-4 sm:p-5 space-y-3">
        <div>
          <h2 className="text-base font-semibold text-[var(--ink)]">Historique des recharges</h2>
          <p className="text-[12px] text-[var(--muted)]">
            Liste des rechargements cr√©dit√©s sur ton compte (webhook Polar).
          </p>
        </div>

        {rechargesError && <p className="text-[12px] text-red-400">{rechargesError}</p>}

        {rechargesLoading ? (
          <p className="text-[12px] text-[var(--muted)]">Chargement‚Ä¶</p>
        ) : recharges.length === 0 ? (
          <p className="text-[12px] text-[var(--muted)]">Aucune recharge pour le moment.</p>
        ) : (
          <div className="overflow-x-auto">
            <table className="w-full text-[12px]">
              <thead className="text-[var(--muted)]">
                <tr className="text-left">
                  <th className="py-2 pr-4">Date</th>
                  <th className="py-2 pr-4">Cr√©dits</th>
                  <th className="py-2 pr-4">Montant</th>
                  <th className="py-2 pr-4">Statut</th>
                </tr>
              </thead>
              <tbody>
                {recharges.map((r) => {
                  const d = r.createdAt ? new Date(r.createdAt) : null;
                  const amount = typeof r.amount === "number" ? (r.amount / 100).toFixed(2) : null;
                  const cur = r.currency ? String(r.currency).toUpperCase() : "";
                  return (
                    <tr key={r.id} className="border-t border-[var(--border)]/80">
                      <td className="py-2 pr-4">{d ? d.toLocaleString("fr-FR") : "‚Äî"}</td>
                      <td className="py-2 pr-4">
                        {typeof r.creditsAdded === "number" ? `+${r.creditsAdded}` : "‚Äî"}
                      </td>
                      <td className="py-2 pr-4">{amount ? `${amount} ${cur}` : "‚Äî"}</td>
                      <td className="py-2 pr-4">{r.status || "‚Äî"}</td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>
        )}
      </section>

      {/* üî• POPUP CHECKOUT POLAR EN IFRAME */}
      {embedUrl && (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm">
          <div className="relative w-full max-w-lg h-[520px] sm:h-[580px] bg-[var(--bg)] border border-[var(--border)]/80 rounded-2xl shadow-2xl flex flex-col overflow-hidden">
            <div className="flex items-center justify-between px-4 py-2 border-b border-[var(--border)]/70 bg-[var(--bg-soft)]/80">
              <div className="flex flex-col">
                <span className="text-[12px] font-semibold text-[var(--ink)]">Paiement s√©curis√©</span>
                <span className="text-[11px] text-[var(--muted)]">Transaction g√©r√©e par Polar (Stripe)</span>
              </div>
              <button
                type="button"
                onClick={closeModal}
                className="text-[11px] rounded-full border border-[var(--border)] px-2 py-1 hover:bg-[var(--bg)]"
              >
                ‚úï
              </button>
            </div>

            <iframe
              ref={iframeRef}
              src={embedUrl}
              onLoad={handleIframeLoad}
              className="flex-1 w-full border-0"
              title="Paiement Polar"
              allow="payment *; publickey-credentials-get *"
            />
          </div>
        </div>
      )}
    </div>
  );
}
````

## File: app/app/cv/page.tsx
````typescript
// app/app/cv/page.tsx
"use client";

export default function CvPage() {
  return (
    <div className="max-w-4xl mx-auto glass p-4">
      <h1 className="text-lg font-semibold mb-2">Section CV</h1>
      <p className="text-sm text-[var(--muted)]">
        CV IA ‚Äî upload de ton PDF et extraction du profil par Gemini.
      </p>
    </div>
  );
}
````

## File: app/app/page.tsx
````typescript
"use client";

import { useState, useEffect, useRef, ChangeEvent, FormEvent } from "react";
import { motion } from "framer-motion";
import { auth, db } from "@/lib/firebase";
import { onAuthStateChanged } from "firebase/auth";
import {
  doc,
  getDoc,
  setDoc,
  collection,
  query,
  where,
  onSnapshot,
} from "firebase/firestore";
import Chart from "chart.js/auto";
import { useAuth } from "@/context/AuthContext";
import { useUserProfile } from "@/hooks/useUserProfile";
import { consumeCredits } from "@/lib/credits";
import { logUsage } from "@/lib/userTracking";
import { getRecaptchaToken } from "@/lib/recaptcha";

// --- TYPES ---

type CvSkillsSection = {
  title: string;
  items: string[];
};

type CvSkills = {
  sections: CvSkillsSection[];
  tools: string[];
};

type CvExperience = {
  company: string;
  role: string;
  dates: string;
  bullets: string[];
  location?: string;
};

type CvEducation = {
  school: string;
  degree: string;
  dates: string;
  location?: string;
};

type CvProfile = {
  fullName: string;
  email: string;
  phone: string;
  linkedin: string;
  profileSummary: string;

  city?: string;
  address?: string;

  contractType: string;
  contractTypeStandard?: string;
  contractTypeFull?: string;

  primaryDomain?: string;
  secondaryDomains?: string[];
  softSkills?: string[];

  drivingLicense?: string;
  vehicle?: string;

  skills: CvSkills;
  experiences: CvExperience[];
  education: CvEducation[];
  educationShort: string[];
  certs: string;
  langLine: string;
  hobbies: string[];
  updatedAt?: number;
};

type DashboardCounts = {
  totalApps: number;
  cvCount: number;
  lmCount: number;
};

// ‚úÖ Appelle le proxy Next.js (pas la Cloud Function en direct)
const WORKER_URL = "/api/extractProfile";

// --- HELPERS G√âN√âRAUX ---

function getInitials(name?: string) {
  if (!name) return "?";
  const parts = name.trim().split(/\s+/);
  if (parts.length === 0) return "?";
  if (parts.length === 1) return (parts[0][0] || "?").toUpperCase();
  return (
    ((parts[0][0] || "") + (parts[parts.length - 1][0] || "")).toUpperCase()
  );
}

function formatUpdatedAt(ts?: number) {
  if (!ts) return "";
  const d = new Date(ts);
  return new Intl.DateTimeFormat("fr-FR", {
    day: "2-digit",
    month: "short",
    year: "numeric",
    hour: "2-digit",
    minute: "2-digit",
  }).format(d);
}

function normalizeText(str: string): string {
  return str
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .toLowerCase();
}

// üåê Drapeaux langues (robuste, ignore natif/bilingue/etc.)
function getFlagEmoji(langPart: string): string {
  if (!langPart) return "üåê";

  const lower = langPart.toLowerCase();

  // On enl√®ve ce qu'il y a entre parenth√®ses (souvent le niveau)
  let base = lower.replace(/\(.*?\)/g, " ").trim();

  const levelWords = [
    "natif",
    "bilingue",
    "courant",
    "interm√©diaire",
    "intermediaire",
    "d√©butant",
    "debutant",
    "langue maternelle",
    "maternelle",
    "maternel",
    "c1",
    "c2",
    "b1",
    "b2",
    "a1",
    "a2",
  ];

  levelWords.forEach((w) => {
    base = base.replace(new RegExp("\\b" + w + "\\b", "g"), " ");
  });

  base = base.trim();
  if (!base) base = lower;

  if (base.match(/\bfran√ßais\b|\bfrancais\b|\bfrench\b/)) return "üá´üá∑";
  if (base.match(/\banglais\b|\benglish\b/)) return "üá¨üáß";
  if (base.match(/\bamericain\b|\b√©tats-unis\b|\busa\b|\bamerican\b/))
    return "üá∫üá∏";

  if (base.match(/\bespagnol\b|\bspanish\b/)) return "üá™üá∏";
  if (base.match(/\ballemand\b|\bgerman\b/)) return "üá©üá™";
  if (base.match(/\bitalien\b|\bitalian\b/)) return "üáÆüáπ";
  if (base.match(/\bportugais\b|\bportuguese\b/)) return "üáµüáπ";
  if (base.match(/\bn√©erlandais\b|\bneerlandais\b|\bdutch\b/)) return "üá≥üá±";

  if (base.match(/\barabe\b|\barabic\b|\barab\b/)) return "üá∏üá¶";
  if (base.match(/\bchinois\b|\bmandarin\b|\bchinese\b/)) return "üá®üá≥";
  if (base.match(/\brusse\b|\brussian\b/)) return "üá∑üá∫";
  if (base.match(/\bjaponais\b|\bjapanese\b/)) return "üáØüáµ";
  if (base.match(/\bcor√©en\b|\bcoreen\b|\bkorean\b/)) return "üá∞üá∑";
  if (base.match(/\bhindi\b|\bhindou\b/)) return "üáÆüá≥";
  if (base.match(/\bturc\b|\bturkish\b/)) return "üáπüá∑";

  return "üåê";
}

// üåê Parse le champ langLine en { flag, text }[]
function parseLangLine(langLine: string): { flag: string; text: string }[] {
  if (!langLine) return [];
  const parts = langLine
    .split("¬∑")
    .join("|")
    .split(",")
    .join("|")
    .split("|")
    .map((p) => p.trim())
    .filter((p) => p.length > 0);

  return parts.map((part) => ({
    flag: getFlagEmoji(part),
    text: part,
  }));
}

// üéØ Emoji pour les hobbies
function getHobbyEmoji(hobby: string): string {
  const p = hobby.toLowerCase();
  if (p.includes("football") || p.includes("foot")) return "‚öΩ";
  if (p.includes("basket") || p.includes("basketball")) return "üèÄ";
  if (p.includes("sport") || p.includes("fitness") || p.includes("gym"))
    return "üí™";
  if (p.includes("musique") || p.includes("guitare") || p.includes("piano"))
    return "üéµ";
  if (p.includes("lecture") || p.includes("livre")) return "üìö";
  if (p.includes("cin√©ma") || p.includes("cinema") || p.includes("film"))
    return "üé¨";
  if (p.includes("jeu vid√©o") || p.includes("jeux vid√©o") || p.includes("gaming"))
    return "üéÆ";
  if (p.includes("voyage") || p.includes("travel")) return "‚úàÔ∏è";
  if (p.includes("cuisine") || p.includes("cooking")) return "üç≥";
  if (p.includes("photo") || p.includes("photographie")) return "üì∏";
  if (p.includes("dessin") || p.includes("peinture") || p.includes("art"))
    return "üé®";
  if (p.includes("randonn√©e") || p.includes("rando") || p.includes("hiking"))
    return "ü•æ";
  return "‚≠ê";
}

// --- RADAR G√âN√âRIQUE (multi-m√©tiers, robuste) ---

type RadarAxisDef = {
  id: string;
  label: string;
  keywords: string[];
};

const DOMAIN_AXES: RadarAxisDef[] = [
  {
    id: "finance",
    label: "Finance & Contr√¥le",
    keywords: [
      "finance",
      "financier",
      "controle de gestion",
      "contr√¥le de gestion",
      "controle interne",
      "contr√¥le interne",
      "audit",
      "conformite",
      "conformit√©",
      "risque",
      "risques",
      "reporting",
      "budget",
      "bilan",
      "comptable",
      "tresorerie",
      "tr√©sorerie",
      "analyse financiere",
      "analyse financi√®re",
      "cfa",
      "ifrs",
    ],
  },
  {
    id: "it_dev",
    label: "IT & D√©veloppement",
    keywords: [
      "developpement",
      "d√©veloppement",
      "javascript",
      "typescript",
      "python",
      "java",
      "c++",
      "c#",
      "php",
      "go",
      "react",
      "node",
      "angular",
      "vue",
      "api",
      "application",
      "fullstack",
      "frontend",
      "backend",
      "devops",
      "git",
      "docker",
      "kubernetes",
    ],
  },
  {
    id: "cyber",
    label: "Cybers√©curit√© & R√©seaux",
    keywords: [
      "cyber",
      "cybersecurite",
      "cybers√©curit√©",
      "pentest",
      "penetration test",
      "vulnerabilite",
      "vuln√©rabilit√©",
      "soc",
      "firewall",
      "pare feu",
      "pare-feu",
      "vpn",
      "ids",
      "ips",
      "wireshark",
      "nmap",
      "kali",
      "siem",
      "owasp",
    ],
  },
  {
    id: "data",
    label: "Data & Analytics",
    keywords: [
      "data",
      "donnees",
      "donn√©es",
      "sql",
      "power bi",
      "tableau",
      "statistique",
      "statistiques",
      "machine learning",
      "intelligence artificielle",
      "ia ",
      "analyse de donnees",
      "analyse de donn√©es",
      "data analyst",
      "data engineer",
      "pandas",
      "numpy",
    ],
  },
  {
    id: "marketing",
    label: "Marketing & Communication",
    keywords: [
      "marketing",
      "communication",
      "social media",
      "r√©seaux sociaux",
      "reseaux sociaux",
      "seo",
      "sea",
      "content",
      "contenu",
      "campagne",
      "publicite",
      "publicit√©",
      "branding",
      "influence",
      "community manager",
    ],
  },
  {
    id: "sales",
    label: "Commerce & Vente",
    keywords: [
      "commercial",
      "vente",
      "business developer",
      "account manager",
      "prospection",
      "negociation",
      "n√©gociation",
      "pipeline",
      "portefeuille clients",
      "chiffre d affaires",
      "ca ",
      "b2b",
      "b2c",
    ],
  },
  {
    id: "hr",
    label: "RH & Recrutement",
    keywords: [
      "ressources humaines",
      "rh",
      "recrutement",
      "onboarding",
      "formation",
      "gestion du personnel",
      "talent acquisition",
      "people",
      "paie",
      "gestion des talents",
    ],
  },
  {
    id: "project",
    label: "Gestion de projet",
    keywords: [
      "chef de projet",
      "gestion de projet",
      "project manager",
      "planning",
      "pilotage",
      "agile",
      "scrum",
      "kanban",
      "coordination",
      "roadmap",
      "livrable",
      "livrables",
      "planning",
    ],
  },
  {
    id: "ops",
    label: "Op√©rations & Logistique",
    keywords: [
      "logistique",
      "supply chain",
      "transport",
      "flux",
      "optimisation des processus",
      "lean",
      "maintenance",
      "production",
      "magasinier",
      "preparation de commandes",
      "exploitation",
    ],
  },
  {
    id: "health",
    label: "Sant√© & Social",
    keywords: [
      "infirmier",
      "infirmi√®re",
      "aide soignant",
      "aide-soignant",
      "medecin",
      "m√©decin",
      "paramedical",
      "param√©dical",
      "social",
      "accompagnement",
      "patients",
      "soins",
      "assistante sociale",
      "assistant social",
      "ehpad",
    ],
  },
  {
    id: "education",
    label: "√âducation & Formation",
    keywords: [
      "enseignant",
      "professeur",
      "formateur",
      "formatrice",
      "pedagogie",
      "p√©dagogie",
      "cours",
      "formation",
      "apprentissage",
      "eleves",
      "√©l√®ves",
      "etudiants",
      "√©tudiants",
      "√©ducation",
    ],
  },
];

const DOMAIN_CORE_KEYWORDS: Record<string, string[]> = {
  finance: [
    "comptable",
    "controle de gestion",
    "contr√¥le de gestion",
    "controle interne",
    "contr√¥le interne",
    "audit",
    "bilan",
    "compte de resultat",
    "compte de r√©sultat",
    "tresorerie",
    "tr√©sorerie",
    "analyse financiere",
    "analyse financi√®re",
    "cfa",
    "ifrs",
  ],
  it_dev: [
    "developpement",
    "d√©veloppement",
    "javascript",
    "typescript",
    "python",
    "java",
    "c++",
    "c#",
    "php",
    "react",
    "node",
    "angular",
    "vue",
    "fullstack",
    "frontend",
    "backend",
    "devops",
    "docker",
    "kubernetes",
  ],
  cyber: [
    "pentest",
    "penetration test",
    "wireshark",
    "nmap",
    "kali",
    "ids",
    "ips",
    "soc",
    "siem",
    "owasp",
    "firewall",
    "pare feu",
    "pare-feu",
  ],
  data: [
    "data analyst",
    "data engineer",
    "power bi",
    "tableau",
    "sql",
    "pandas",
    "numpy",
    "machine learning",
    "intelligence artificielle",
  ],
  marketing: [
    "seo",
    "sea",
    "community manager",
    "social media",
    "campagne",
    "branding",
    "communication digitale",
  ],
  sales: [
    "business developer",
    "account manager",
    "commercial",
    "prospection",
    "negociation",
    "n√©gociation",
    "pipeline",
  ],
  hr: [
    "ressources humaines",
    "rh",
    "recrutement",
    "talent acquisition",
    "gestion de la paie",
    "gestion du personnel",
  ],
  project: [
    "chef de projet",
    "project manager",
    "scrum master",
    "agile",
    "gestion de projet",
  ],
  ops: ["supply chain", "logistique", "exploitation", "maintenance", "production"],
  health: ["infirmier", "infirmi√®re", "medecin", "m√©decin", "aide soignant", "aide-soignant", "soins", "patients"],
  education: ["enseignant", "professeur", "formateur", "formatrice", "pedagogie", "p√©dagogie", "eleves", "√©l√®ves", "etudiants", "√©tudiants"],
};

const SOFT_SKILLS_KEYWORDS = [
  "communication",
  "travail en equipe",
  "travail en √©quipe",
  "collaboration",
  "autonome",
  "autonomie",
  "rigoureux",
  "rigoureuse",
  "organise",
  "organis√©",
  "organisee",
  "organis√©e",
  "adaptabilite",
  "adaptabilit√©",
  "gestion du stress",
  "leadership",
  "esprit d analyse",
  "esprit d'analyse",
  "empathie",
  "relationnel",
];

function countHits(keywords: string[], text: string): number {
  let hits = 0;
  for (const k of keywords) {
    const normK = normalizeText(k);
    if (text.includes(normK)) hits++;
  }
  return hits;
}

function scaleScore(hits: number): number {
  if (hits <= 0) return 3;
  if (hits === 1) return 5;
  if (hits === 2) return 7;
  if (hits === 3) return 9;
  return 10;
}

// üîé construit les donn√©es du radar √† partir du profil (g√©n√©rique multi-m√©tiers)
function buildRadarData(profile: CvProfile | null) {
  const defaultLabels = [
    "Analyse / R√©solution",
    "Organisation & Processus",
    "Outils & Tech",
    "Apprentissage",
    "Soft skills",
  ];

  if (!profile) {
    return { labels: defaultLabels, data: [3, 3, 3, 3, 3] };
  }

  const rawText =
    JSON.stringify(profile.skills.sections || "") +
    JSON.stringify(profile.skills.tools || "") +
    JSON.stringify(profile.experiences || "") +
    JSON.stringify(profile.education || "") +
    (profile.profileSummary || "") +
    (profile.contractType || "") +
    (profile.certs || "") +
    (profile.langLine || "");

  const lower = normalizeText(rawText);

  const aiDomainIds: string[] = [];
  if (profile.primaryDomain && profile.primaryDomain !== "autre") {
    aiDomainIds.push(profile.primaryDomain);
  }
  if (Array.isArray(profile.secondaryDomains)) {
    for (const d of profile.secondaryDomains) {
      if (d && d !== "autre" && !aiDomainIds.includes(d)) {
        aiDomainIds.push(d);
      }
    }
  }

  let relevant: {
    axis: RadarAxisDef;
    totalHits: number;
    coreHits: number;
    score: number;
  }[] = [];

  if (aiDomainIds.length > 0) {
    relevant = aiDomainIds
      .map((id) => {
        const axis = DOMAIN_AXES.find((a) => a.id === id);
        if (!axis) return null;

        const totalHits = countHits(axis.keywords, lower);
        const coreKeywords = DOMAIN_CORE_KEYWORDS[axis.id] || axis.keywords;
        const coreHits = countHits(coreKeywords, lower);

        const rawHits = Math.max(totalHits, coreHits);
        const score = scaleScore(rawHits);

        return { axis, totalHits, coreHits, score };
      })
      .filter(
        (
          x
        ): x is {
          axis: RadarAxisDef;
          totalHits: number;
          coreHits: number;
          score: number;
        } => !!x
      );
  } else {
    const domainScores = DOMAIN_AXES.map((axis) => {
      const totalHits = countHits(axis.keywords, lower);
      const coreKeywords = DOMAIN_CORE_KEYWORDS[axis.id] || axis.keywords;
      const coreHits = countHits(coreKeywords, lower);

      const isRelevant = coreHits > 0 && totalHits > 0;
      const score = isRelevant ? scaleScore(totalHits) : 0;

      return { axis, totalHits, coreHits, isRelevant, score };
    });

    relevant = domainScores
      .filter((d) => d.isRelevant)
      .sort((a, b) => b.totalHits - a.totalHits)
      .slice(0, 4) as any;
  }

  let softHits = countHits(SOFT_SKILLS_KEYWORDS, lower);
  const softSkillsCount = Array.isArray(profile.softSkills)
    ? profile.softSkills.length
    : 0;

  if (softSkillsCount > 0) {
    softHits += Math.min(4, Math.floor(softSkillsCount / 2));
  }

  const softScore = scaleScore(softHits);

  if (!relevant.length) {
    const generic = [
      scaleScore(countHits(["analyse", "diagnostic"], lower)),
      scaleScore(countHits(["processus", "organisation"], lower)),
      scaleScore(countHits(["outil", "logiciel", "technique"], lower)),
      scaleScore(countHits(["apprentissage", "formation", "veille"], lower)),
    ];
    return {
      labels: defaultLabels,
      data: [...generic, softScore],
    };
  }

  const labels = relevant.map((r) => r.axis.label).concat("Soft skills");
  const data = relevant.map((r) => r.score).concat(softScore);

  console.debug(
    "[Radar IA] Domaines retenus :",
    relevant.map((r) => ({
      id: r.axis.id,
      label: r.axis.label,
      hits: r.totalHits,
      score: r.score,
    })),
    "SoftSkillsCount:",
    softSkillsCount,
    "SoftScore:",
    softScore
  );

  return { labels, data };
}

// Items pour la navigation rapide
const navItems = [
  { id: "infos-personnelles", label: "Infos & CV" },
  { id: "competences", label: "Comp√©tences & Outils" },
  { id: "experience", label: "Exp√©rience" },
  { id: "formation", label: "Formation & Certifs" },
  { id: "langues", label: "Langues" },
  { id: "hobbies", label: "Centres d'int√©r√™t" },
];

type ActiveModal =
  | "infos"
  | "skills"
  | "experience"
  | "education"
  | "languages"
  | "hobbies"
  | null;

type ExperienceDraft = {
  company: string;
  role: string;
  dates: string;
  bulletsText: string;
};

type EducationDraft = {
  school: string;
  degree: string;
  dates: string;
  location: string;
};

type LanguageDraft = {
  language: string;
  level: string;
};

const LANGUAGE_OPTIONS = [
  "Fran√ßais",
  "Anglais",
  "Espagnol",
  "Allemand",
  "Italien",
  "Portugais",
  "N√©erlandais",
  "Arabe",
  "Russe",
  "Chinois (Mandarin)",
  "Japonais",
  "Cor√©en",
  "Hindi",
  "Turc",
];

const LANGUAGE_LEVEL_OPTIONS = [
  "Natif / Bilingue (C2)",
  "Courant (C1)",
  "Interm√©diaire (B2)",
  "Op√©rationnel (B1)",
  "D√©butant (A2 - A1)",
];

const CERTIFICATION_OPTIONS = [
  "TOEIC",
  "TOEFL",
  "IELTS",
  "CCNA",
  "CCNP",
  "CompTIA Security+",
  "CompTIA Network+",
  "AWS Cloud Practitioner",
  "AWS Solutions Architect Associate",
  "Azure AZ-900",
  "Azure AZ-104",
  "Azure AZ-500",
  "Azure SC-900",
  "Azure MS-900",
  "Google Cloud Digital Leader",
  "PMI PMP",
  "Prince2 Foundation",
  "Prince2 Practitioner",
  "ITIL Foundation",
  "CFA Niveau 1",
  "AMF",
  "Tosa Excel",
];

const HOBBY_OPTIONS = [
  "Voyage",
  "Lecture",
  "Musique",
  "Piano",
  "Guitare",
  "Sport (Football)",
  "Sport (Basketball)",
  "Fitness / Musculation",
  "Course √† pied",
  "Randonn√©e",
  "Natation",
  "Cin√©ma",
  "S√©ries",
  "Jeux vid√©o",
  "Photographie",
  "Cuisine",
  "P√¢tisserie",
  "Dessin",
  "Peinture",
  "Art digital",
  "B√©n√©volat",
  "Entrepreneuriat",
  "Technologie / veille tech",
  "√âchecs",
  "Podcasts",
];

const CONTRACT_TYPE_OPTIONS = [
  "CDI",
  "CDD",
  "Int√©rim",
  "Alternance",
  "Stage",
  "Freelance",
  "Temps plein",
  "Temps partiel",
  "Ind√©pendant",
  "Contrat pro",
];

// --- COMPOSANT PRINCIPAL ---

export default function DashboardPage() {
  const [file, setFile] = useState<File | null>(null);
  const [uploading, setUploading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [profile, setProfile] = useState<CvProfile | null>(null);

  const radarCanvasRef = useRef<HTMLCanvasElement | null>(null);

  const [userId, setUserId] = useState<string | null>(null);
  const [userEmail, setUserEmail] = useState<string | null>(null);
  const [loadingProfileFromDb, setLoadingProfileFromDb] =
    useState<boolean>(true);

  const [dashboardCounts, setDashboardCounts] = useState<DashboardCounts>({
    totalApps: 0,
    cvCount: 0,
    lmCount: 0,
  });
  const [loadingCounts, setLoadingCounts] = useState<boolean>(true);

  // --- √âTATS MODALES ---

  const [activeModal, setActiveModal] = useState<ActiveModal>(null);

  const [infosDraft, setInfosDraft] = useState({
    fullName: "",
    email: "",
    phone: "",
    linkedin: "",
    contractType: "",
    profileSummary: "",
    drivingLicense: "",
    vehicle: "",
    address: "",
  });

  const [skillsSectionsText, setSkillsSectionsText] = useState("");
  const [skillsToolsText, setSkillsToolsText] = useState("");

  const [experiencesDraft, setExperiencesDraft] = useState<ExperienceDraft[]>(
    []
  );

  const [educationDrafts, setEducationDrafts] = useState<EducationDraft[]>([]);
  const [certsList, setCertsList] = useState<string[]>([]);
  const [certInput, setCertInput] = useState("");

  const [languagesDraft, setLanguagesDraft] = useState<LanguageDraft[]>([]);
  const [hobbiesList, setHobbiesList] = useState<string[]>([]);
  const [hobbyInput, setHobbyInput] = useState("");

  const { user } = useAuth();
  const { profile: accountProfile, loading: loadingAccountProfile } =
    useUserProfile();
  const remainingCredits = accountProfile?.credits ?? 0;
  const isBlocked = accountProfile?.blocked === true;

  // üîê Auth + chargement du profil Firestore + stats candidatures
  useEffect(() => {
    let unsubApps: (() => void) | null = null;

    const unsubAuth = onAuthStateChanged(auth, async (user) => {
      if (unsubApps) {
        unsubApps();
        unsubApps = null;
      }

      if (!user) {
        setUserId(null);
        setUserEmail(null);
        setProfile(null);
        setLoadingProfileFromDb(false);
        setDashboardCounts({ totalApps: 0, cvCount: 0, lmCount: 0 });
        setLoadingCounts(false);
        return;
      }

      setUserId(user.uid);
      setUserEmail(user.email ?? null);

      // --- Chargement du profil
      try {
        const ref = doc(db, "profiles", user.uid);
        const snap = await getDoc(ref);
        if (snap.exists()) {
          const data = snap.data() as any;

          const loadedProfile: CvProfile = {
            fullName: data.fullName || "",
            email: data.email || "",
            phone: data.phone || "",
            linkedin: data.linkedin || "",
            profileSummary: data.profileSummary || "",
            city: data.city || "",
            address: data.address || "",
            contractType: data.contractType || data.contractTypeStandard || "",
            contractTypeStandard: data.contractTypeStandard || "",
            contractTypeFull: data.contractTypeFull || "",
            primaryDomain: data.primaryDomain || "",
            secondaryDomains: Array.isArray(data.secondaryDomains)
              ? data.secondaryDomains
              : [],
            softSkills: Array.isArray(data.softSkills) ? data.softSkills : [],
            drivingLicense: data.drivingLicense || "",
            vehicle: data.vehicle || "",
            skills: {
              sections: Array.isArray(data.skills?.sections)
                ? data.skills.sections
                : [],
              tools: Array.isArray(data.skills?.tools) ? data.skills.tools : [],
            },
            experiences: Array.isArray(data.experiences) ? data.experiences : [],
            education: Array.isArray(data.education) ? data.education : [],
            educationShort: Array.isArray(data.educationShort)
              ? data.educationShort
              : [],
            certs: data.certs || "",
            langLine: data.langLine || "",
            hobbies: Array.isArray(data.hobbies) ? data.hobbies : [],
            updatedAt:
              typeof data.updatedAt === "number" ? data.updatedAt : undefined,
          };

          setProfile(loadedProfile);
        } else {
          setProfile(null);
        }
      } catch (e) {
        console.error("Erreur chargement profil Firestore:", e);
      } finally {
        setLoadingProfileFromDb(false);
      }

      // --- Stats candidatures
      setLoadingCounts(true);

      const q = query(
        collection(db, "applications"),
        where("userId", "==", user.uid)
      );

      unsubApps = onSnapshot(
        q,
        (snap) => {
          let totalApps = 0;
          let cvCount = 0;
          let lmCount = 0;

          snap.docs.forEach((docSnap) => {
            const data = docSnap.data() as any;
            totalApps++;
            if (data.hasCv) cvCount++;
            if (data.hasLm) lmCount++;
          });

          setDashboardCounts({ totalApps, cvCount, lmCount });
          setLoadingCounts(false);
        },
        (err) => {
          console.error("Erreur chargement stats dashboard:", err);
          setLoadingCounts(false);
        }
      );
    });

    return () => {
      if (unsubApps) unsubApps();
      unsubAuth();
    };
  }, []);

  // üíæ sauvegarde du profil en base (Firestore)
  const saveProfileToDb = async (p: CvProfile) => {
    if (!userId) return;
    const ref = doc(db, "profiles", userId);
    const payload = {
      ...p,
      ownerUid: userId,
      ownerEmail: userEmail ?? null,
      updatedAt: Date.now(),
    };
    await setDoc(ref, payload, { merge: true });
  };

  // üéØ Radar Chart
  useEffect(() => {
    if (!radarCanvasRef.current || !profile) return;

    const ctx = radarCanvasRef.current.getContext("2d");
    if (!ctx) return;

    const existingChart = Chart.getChart(radarCanvasRef.current as any);
    if (existingChart) {
      existingChart.destroy();
    }

    const { labels, data } = buildRadarData(profile);

    const chartInstance = new Chart(ctx, {
      type: "radar",
      data: {
        labels,
        datasets: [
          {
            label: "Niveau estim√©",
            data,
            backgroundColor: "rgba(56, 189, 248, 0.25)",
            borderColor: "rgba(56, 189, 248, 0.9)",
            borderWidth: 2,
            pointBackgroundColor: "rgba(56, 189, 248, 1)",
            pointRadius: 3,
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          r: {
            beginAtZero: true,
            min: 0,
            max: 10,
            ticks: {
              stepSize: 2,
              showLabelBackdrop: false,
              display: false,
            },
            grid: {
              color: "rgba(148, 163, 184, 0.35)",
            },
            angleLines: {
              color: "rgba(148, 163, 184, 0.35)",
            },
            pointLabels: {
              font: { size: 11 },
              color: "#e5e7eb",
            },
          },
        },
        plugins: {
          legend: { display: false },
        },
      },
    });

    return () => {
      chartInstance.destroy();
    };
  }, [profile]);

  // --- UPLOAD CV ---

  const handleFileChange = (e: ChangeEvent<HTMLInputElement>) => {
    setError(null);
    const f = e.target.files?.[0];
    if (!f) return;

    if (!f.type.includes("pdf")) {
      setError("Merci d'importer un CV au format PDF.");
      return;
    }

    setFile(f);
  };

  const fileToBase64 = (file: File): Promise<string> => {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onerror = () => reject(new Error("Impossible de lire le fichier."));
      reader.onload = () => {
        const result = reader.result as string;
        const base64 = result.split(",")[1];
        if (!base64) {
          reject(new Error("Encodage base64 invalide."));
        } else {
          resolve(base64);
        }
      };
      reader.readAsDataURL(file);
    });
  };

  const handleUpload = async () => {
    if (!file) {
      setError("Choisis d'abord un CV au format PDF.");
      return;
    }

    if (!user) {
      setError("Tu dois √™tre connect√© pour analyser ton CV.");
      return;
    }

    if (loadingAccountProfile) {
      setError(
        "Ton profil utilisateur est en cours de chargement, r√©essaie dans un instant."
      );
      return;
    }

    if (isBlocked) {
      setError(
        "Ton compte est bloqu√©. Contacte l'administrateur pour en savoir plus."
      );
      return;
    }

    const cost = 1; // üí∞ co√ªt d'une analyse de CV
    if (remainingCredits < cost) {
      setError(
        "Tu n'as plus assez de cr√©dits pour analyser un CV. Contacte l'administrateur."
      );
      return;
    }

    setError(null);
    setUploading(true);

    try {
      // 1) Consommation des cr√©dits (transaction Firestore)
      await consumeCredits(user.uid, cost);

      // 2) Log d'usage
      await logUsage(user, "cv_analyze", {
        fileName: file.name,
        fileSize: file.size,
        feature: "dashboard-cv-upload",
      });

      // 3) Appel via l'API Next.js (‚úÖ auth + recaptcha)
      const base64Pdf = await fileToBase64(file);

      const idToken = await user.getIdToken();
      const recaptchaToken = await getRecaptchaToken("extract_profile");

      const res = await fetch(WORKER_URL, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${idToken}`,
          "X-Recaptcha-Token": recaptchaToken,
        },
        body: JSON.stringify({
          base64Pdf,
          meta: {
            fileName: file.name,
            fileSize: file.size,
            feature: "dashboard-cv-upload",
          },
        }),
      });

      const json = await res.json().catch(() => null);

      if (!res.ok) {
        const msg = (json && (json.error || json.message)) || `HTTP ${res.status}`;
        if (res.status === 401 || msg === "unauthenticated") {
          throw new Error("unauthenticated");
        }
        throw new Error(msg);
      }

      const now = Date.now();
      const rawProfile = json?.profile ?? json;

      const receivedProfile: CvProfile = {
        fullName: rawProfile.fullName || "",
        email: rawProfile.email || "",
        phone: rawProfile.phone || "",
        linkedin: rawProfile.linkedin || "",
        profileSummary: rawProfile.profileSummary || "",
        city: rawProfile.city || "",
        address: rawProfile.address || "",
        contractType:
          rawProfile.contractType || rawProfile.contractTypeStandard || "",
        contractTypeStandard: rawProfile.contractTypeStandard || "",
        contractTypeFull: rawProfile.contractTypeFull || "",
        primaryDomain: rawProfile.primaryDomain || "",
        secondaryDomains: Array.isArray(rawProfile.secondaryDomains)
          ? rawProfile.secondaryDomains
          : [],
        softSkills: Array.isArray(rawProfile.softSkills)
          ? rawProfile.softSkills
          : [],
        drivingLicense: rawProfile.drivingLicense || "",
        vehicle: rawProfile.vehicle || "",
        skills: {
          sections: Array.isArray(rawProfile.skills?.sections)
            ? rawProfile.skills.sections
            : [],
          tools: Array.isArray(rawProfile.skills?.tools)
            ? rawProfile.skills.tools
            : [],
        },
        experiences: Array.isArray(rawProfile.experiences)
          ? rawProfile.experiences
          : [],
        education: Array.isArray(rawProfile.education)
          ? rawProfile.education
          : [],
        educationShort: Array.isArray(rawProfile.educationShort)
          ? rawProfile.educationShort
          : [],
        certs: rawProfile.certs || "",
        langLine: rawProfile.langLine || "",
        hobbies: Array.isArray(rawProfile.hobbies) ? rawProfile.hobbies : [],
        updatedAt: now,
      };

      setProfile(receivedProfile);

      if (userId) {
        await saveProfileToDb(receivedProfile);
      }
    } catch (err: any) {
      console.error(err);
      if (err instanceof Error) {
        if (err.message === "unauthenticated") {
          setError("Session expir√©e. D√©connecte-toi / reconnecte-toi puis r√©essaie.");
        } else if (err.message === "NOT_ENOUGH_CREDITS" || err.message === "NO_CREDITS") {
          setError(
            "Tu n'as plus assez de cr√©dits pour analyser un CV. Contacte l'administrateur."
          );
        } else if (err.message === "USER_BLOCKED") {
          setError(
            "Ton compte est bloqu√©. Contacte l'administrateur pour en savoir plus."
          );
        } else if (err.message === "USER_DOC_NOT_FOUND") {
          setError(
            "Profil utilisateur introuvable dans la base. Contacte l'administrateur."
          );
        } else {
          setError(err.message || "Impossible d'analyser ton CV pour le moment.");
        }
      } else {
        setError("Impossible d'analyser ton CV pour le moment.");
      }
    } finally {
      setUploading(false);
    }
  };

  // --- MODALES : OUVERTURE ---

  const openInfosModal = () => {
    if (!profile) return;
    setInfosDraft({
      fullName: profile.fullName,
      email: profile.email || userEmail || "",
      phone: profile.phone || "",
      linkedin: profile.linkedin || "",
      contractType:
        profile.contractType || profile.contractTypeStandard || "",
      profileSummary: profile.profileSummary || "",
      drivingLicense: profile.drivingLicense || "",
      vehicle: profile.vehicle || "",
      address: profile.address || profile.city || "",
    });
    setActiveModal("infos");
  };

  const openSkillsModal = () => {
    if (!profile) return;
    const sectionsText = (profile.skills.sections || [])
      .map((sec) => `${sec.title}: ${sec.items.join(", ")}`)
      .join("\n");
    const toolsText = (profile.skills.tools || []).join(", ");

    setSkillsSectionsText(sectionsText);
    setSkillsToolsText(toolsText);
    setActiveModal("skills");
  };

  const openExperienceModal = () => {
    if (!profile) return;
    const drafts: ExperienceDraft[] =
      profile.experiences?.map((exp) => ({
        company: exp.company || "",
        role: exp.role || "",
        dates: exp.dates || "",
        bulletsText: (exp.bullets || []).join("\n"),
      })) || [];

    if (drafts.length === 0) {
      drafts.push({ company: "", role: "", dates: "", bulletsText: "" });
    }

    setExperiencesDraft(drafts);
    setActiveModal("experience");
  };

  const addExperienceDraft = () => {
    setExperiencesDraft((prev) => [
      ...prev,
      { company: "", role: "", dates: "", bulletsText: "" },
    ]);
  };

  const updateExperienceDraft = (
    index: number,
    field: keyof ExperienceDraft,
    value: string
  ) => {
    setExperiencesDraft((prev) =>
      prev.map((exp, i) =>
        i === index
          ? {
              ...exp,
              [field]: value,
            }
          : exp
      )
    );
  };

  const openEducationModal = () => {
    if (!profile) return;

    const drafts: EducationDraft[] =
      Array.isArray(profile.education) && profile.education.length > 0
        ? profile.education.map((edu) => ({
            school: edu.school || "",
            degree: edu.degree || "",
            dates: edu.dates || "",
            location: (edu as any).location || "",
          }))
        : [
            {
              school: "",
              degree: "",
              dates: "",
              location: "",
            },
          ];

    setEducationDrafts(drafts);

    const list =
      profile.certs
        ?.split(/[,\n]/)
        .map((c: string) => c.trim())
        .filter((c: string) => c.length > 0) || [];
    setCertsList(list);
    setCertInput("");

    setActiveModal("education");
  };

  const addEducationDraft = () => {
    setEducationDrafts((prev) => [
      ...prev,
      { school: "", degree: "", dates: "", location: "" },
    ]);
  };

  const updateEducationDraft = (
    index: number,
    field: keyof EducationDraft,
    value: string
  ) => {
    setEducationDrafts((prev) =>
      prev.map((edu, i) =>
        i === index
          ? {
              ...edu,
              [field]: value,
            }
          : edu
      )
    );
  };

  const openLanguagesModal = () => {
    if (!profile) return;

    const parsed = parseLangLine(profile.langLine || "");
    let drafts: LanguageDraft[] = [];

    if (parsed.length > 0) {
      drafts = parsed.map((p) => {
        const txt = p.text;
        const match = txt.match(/^(.*?)\s*\((.*)\)$/);
        if (match) {
          return {
            language: match[1].trim(),
            level: match[2].trim(),
          };
        }
        return {
          language: txt,
          level: "",
        };
      });
    }

    if (drafts.length === 0) {
      drafts = [{ language: "", level: "" }];
    }

    setLanguagesDraft(drafts);
    setActiveModal("languages");
  };

  const openHobbiesModal = () => {
    if (!profile) return;
    setHobbiesList(profile.hobbies || []);
    setHobbyInput("");
    setActiveModal("hobbies");
  };

  // --- MODALES : SAUVEGARDE ---

  const handleModalSave = async (e?: FormEvent) => {
    if (e) e.preventDefault();
    if (!profile || !activeModal) {
      setActiveModal(null);
      return;
    }

    let updated: CvProfile = { ...profile };

    if (activeModal === "infos") {
      updated = {
        ...profile,
        fullName: infosDraft.fullName.trim(),
        email: infosDraft.email.trim(),
        phone: infosDraft.phone.trim(),
        linkedin: infosDraft.linkedin.trim(),
        contractType: infosDraft.contractType.trim(),
        profileSummary: infosDraft.profileSummary.trim(),
        drivingLicense: infosDraft.drivingLicense.trim(),
        vehicle: infosDraft.vehicle.trim(),
        address: infosDraft.address.trim(),
        city:
          infosDraft.address.trim().split(",")[0].trim() ||
          profile.city ||
          "",
      };
    }

    if (activeModal === "skills") {
      const sections: CvSkillsSection[] = skillsSectionsText
        .split("\n")
        .map((l) => l.trim())
        .filter(Boolean)
        .map((line) => {
          const [titlePart, itemsPart] = line.split(":");
          const title = (titlePart || "Comp√©tences").trim();
          const items = itemsPart
            ? itemsPart
                .split(",")
                .map((s) => s.trim())
                .filter(Boolean)
            : [];
          return { title, items };
        });

      const tools = skillsToolsText
        .split(",")
        .map((t) => t.trim())
        .filter(Boolean);

      updated = {
        ...profile,
        skills: {
          sections,
          tools,
        },
      };
    }

    if (activeModal === "experience") {
      const experiences: CvExperience[] = experiencesDraft
        .map((d) => ({
          company: d.company.trim(),
          role: d.role.trim(),
          dates: d.dates.trim(),
          bullets: d.bulletsText
            .split("\n")
            .map((b) => b.trim())
            .filter(Boolean),
        }))
        .filter(
          (exp) =>
            exp.company || exp.role || exp.dates || exp.bullets.length > 0
        );

      updated = {
        ...profile,
        experiences,
      };
    }

    if (activeModal === "education") {
      const education: CvEducation[] = educationDrafts
        .map((d) => ({
          school: d.school.trim(),
          degree: d.degree.trim(),
          dates: d.dates.trim(),
          location: d.location.trim(),
        }))
        .filter(
          (e) => e.school || e.degree || e.dates || (e.location ?? "").length
        );

      const educationShort = education.map((e) => {
        const parts: string[] = [];
        if (e.dates) parts.push(e.dates);
        let main = "";
        if (e.degree && e.school) main = `${e.degree} ‚Äì ${e.school}`;
        else if (e.degree) main = e.degree;
        else if (e.school) main = e.school;
        if (main) parts.push(main);
        if (e.location) {
          if (parts.length > 1) {
            parts[parts.length - 1] = `${parts[parts.length - 1]} (${e.location})`;
          } else {
            parts.push(`(${e.location})`);
          }
        }
        return parts.join(" ¬∑ ");
      });

      const certsJoined = certsList.join(", ");

      updated = {
        ...profile,
        education,
        educationShort,
        certs: certsJoined,
      };
    }

    if (activeModal === "languages") {
      const cleaned = languagesDraft
        .map((l) => ({
          language: l.language.trim(),
          level: l.level.trim(),
        }))
        .filter((l) => l.language.length > 0);

      const langLine = cleaned
        .map((l) => (l.level ? `${l.language} (${l.level})` : `${l.language}`))
        .join(" ¬∑ ");

      updated = {
        ...profile,
        langLine,
      };
    }

    if (activeModal === "hobbies") {
      const hobbies = hobbiesList
        .map((h) => h.trim())
        .filter((h) => h.length > 0);
      updated = {
        ...profile,
        hobbies,
      };
    }

    setProfile(updated);
    if (userId) {
      await saveProfileToDb(updated);
    }
    setActiveModal(null);
  };

  const handleModalCancel = () => {
    setActiveModal(null);
  };

  const headline =
    profile?.profileSummary?.split(".")[0] ||
    (profile?.contractType
      ? profile.contractType
      : "Profil en cours de configuration");

  const updatedLabel = profile?.updatedAt
    ? `Profil mis √† jour le ${formatUpdatedAt(profile.updatedAt)}`
    : "Profil non encore enregistr√©";

  const langDisplay = parseLangLine(profile?.langLine || "");
  const visibilityLabel = userId ? "Associ√© √† ton compte" : "Invit√©";

  // --- RENDER ---

  return (
    <motion.div
      initial={{ opacity: 0, y: 12 }}
      animate={{ opacity: 1, y: 0 }}
      transition={{ duration: 0.25 }}
      className="max-w-6xl mx-auto px-3 sm:px-4 py-5 sm:py-6 space-y-5"
    >
      {/* 1. VUE D'ENSEMBLE + STATS */}
      <section className="space-y-4">
        <div>
          <p className="badge-muted mb-2 flex items-center gap-1.5">
            <span className="w-1.5 h-1.5 rounded-full bg-emerald-400" />
            <span className="text-[11px] uppercase tracking-wider text-[var(--muted)]">
              Vue d&apos;ensemble
            </span>
          </p>
          <h1 className="text-xl sm:text-2xl font-semibold">
            Ton tableau de bord de candidatures
          </h1>
          <p className="text-xs sm:text-sm text-[var(--muted)] mt-1 max-w-xl">
            Acc√®de rapidement √† ton CV IA et √† toutes les infos qui serviront √†
            g√©n√©rer ton CV, tes lettres de motivation et ton pitch.
          </p>
        </div>

        {/* STATS CARDS */}
        <div className="grid gap-3 md:grid-cols-4">
          {/* Cr√©dits */}
          <div className="glass p-4 rounded-2xl border border-[var(--border)]/80">
            <p className="text-[11px] uppercase tracking-[0.18em] text-[var(--muted)] mb-1">
              Cr√©dits restants
            </p>
            <p className="text-2xl font-semibold">
              {loadingAccountProfile ? "‚Ä¶" : remainingCredits}
            </p>
            <p className="text-[11px] text-[var(--muted)]">
              Utilis√©s pour analyser ton CV et g√©n√©rer des contenus.
            </p>
          </div>

          {/* CV g√©n√©r√©s */}
          <div className="glass p-4 rounded-2xl border border-[var(--border)]/80">
            <p className="text-[11px] uppercase tracking-[0.18em] text-[var(--muted)] mb-1">
              CV g√©n√©r√©s
            </p>
            <p className="text-2xl font-semibold">
              {loadingCounts ? "‚Ä¶" : dashboardCounts.cvCount}
            </p>
            <p className="text-[11px] text-[var(--muted)]">
              Nombre de candidatures o√π un <strong>CV IA</strong> est associ√©
              (coch√© ou g√©n√©r√©).
            </p>
          </div>

          {/* LM IA g√©n√©r√©es */}
          <div className="glass p-4 rounded-2xl border border-[var(--border)]/80">
            <p className="text-[11px] uppercase tracking-[0.18em] text-[var(--muted)] mb-1">
              LM IA g√©n√©r√©es
            </p>
            <p className="text-2xl font-semibold">
              {loadingCounts ? "‚Ä¶" : dashboardCounts.lmCount}
            </p>
            <p className="text-[11px] text-[var(--muted)]">
              Nombre de candidatures avec une <strong>lettre IA</strong>{" "}
              associ√©e.
            </p>
          </div>

          {/* Candidatures suivies */}
          <div className="glass p-4 rounded-2xl border border-[var(--border)]/80">
            <p className="text-[11px] uppercase tracking-[0.18em] text-[var(--muted)] mb-1">
              Candidatures suivies
            </p>
            <p className="text-2xl font-semibold">
              {loadingCounts ? "‚Ä¶" : dashboardCounts.totalApps}
            </p>
            <p className="text-[11px] text-[var(--muted)]">
              Total de lignes dans ton{" "}
              <strong>tracker de candidatures</strong>.
            </p>
          </div>
        </div>
      </section>

      {/* 2. HEADER PROFIL + MON CV + RADAR */}
      <header
        id="infos-personnelles"
        className="glass border border-[var(--border)]/80 rounded-2xl p-4 sm:p-5 flex flex-col lg:flex-row gap-4 md:items-stretch"
      >
        {/* Colonne gauche : identit√©, r√©sum√©, CV, infos cl√©s */}
        <div className="flex flex-col flex-1 gap-3">
          {/* Identit√© */}
          <div className="flex items-center gap-3 sm:gap-4">
            <div className="flex h-14 w-14 sm:h-16 sm:w-16 items-center justify-center rounded-full bg-[var(--bg-soft)] border border-[var(--border)] text-base sm:text-lg font-semibold">
              {getInitials(profile?.fullName || userEmail || "")}
            </div>
            <div className="space-y-1">
              <div className="flex flex-wrap items-center gap-1.5">
                <h2 className="text-base sm:text-lg font-semibold">
                  {profile?.fullName || "Ton profil candidat"}
                </h2>
                {userEmail && (
                  <span className="rounded-full border border-[var(--border)] px-2 py-[2px] text-[10px] text-[var(--muted)]">
                    Connect√©¬∑e en tant que{" "}
                    <span className="font-medium text-[11px] text-white">
                      {userEmail}
                    </span>
                  </span>
                )}
              </div>
              <p className="text-[12px] text-[var(--muted)] line-clamp-2">
                {headline}
              </p>
              {(profile?.address || profile?.city) && (
                <p className="text-[11px] text-[var(--muted)]">
                  {profile.address || profile.city}
                </p>
              )}
              <p className="text-[11px] text-[var(--muted)]">{updatedLabel}</p>
            </div>
          </div>

          {/* Mon CV */}
          <section className="rounded-xl border border-[var(--border)]/80 bg-[var(--bg-soft)] p-3 sm:p-3.5 flex flex-col md:flex-row gap-3 md:items-center">
            <div className="flex-1 space-y-1">
              <div className="flex items-center gap-2 flex-wrap">
                <span className="inline-flex items-center rounded-full border border-[var(--border)] bg-[var(--bg)] px-2 py-[2px] text-[11px]">
                  Mon CV
                </span>
                <p className="text-[11px] text-[var(--muted)]">
                  {profile
                    ? "Ton CV a √©t√© analys√© et ton profil est sauvegard√©."
                    : "Aucun CV analys√© pour le moment."}
                </p>
              </div>
              {loadingProfileFromDb && (
                <p className="text-[11px] text-[var(--muted)]">
                  Chargement de ton profil sauvegard√©...
                </p>
              )}
            </div>

            <div className="flex flex-col sm:flex-row gap-2 items-stretch sm:items-center md:ml-auto">
              <label className="flex-1 cursor-pointer">
                <div className="w-full rounded-lg border border-dashed border-[var(--border)] bg-[var(--bg)] px-3 py-2.5 text-[12px] text-[var(--muted)] hover:border-[var(--brand)]/80 hover:bg-[var(--bg-soft)] transition-colors">
                  {file ? (
                    <div className="flex items-center justify-between gap-2">
                      <span className="truncate">{file.name}</span>
                      <span className="text-[11px] text-[var(--muted)]">
                        {(file.size / 1024 / 1024).toFixed(2)} Mo
                      </span>
                    </div>
                  ) : (
                    <span>Choisir un CV (PDF)</span>
                  )}
                </div>
                <input
                  type="file"
                  accept="application/pdf"
                  className="hidden"
                  onChange={handleFileChange}
                />
              </label>

              <button
                type="button"
                onClick={handleUpload}
                disabled={
                  uploading ||
                  !file ||
                  loadingAccountProfile ||
                  isBlocked ||
                  remainingCredits <= 0
                }
                className="sm:w-[160px] inline-flex items-center justify-center rounded-lg bg-[var(--brand)] hover:bg-[var(--brandDark)] disabled:opacity-60 disabled:cursor-not-allowed text-[13px] font-medium text-white px-3 py-2 transition-colors"
              >
                {uploading
                  ? "Analyse en cours..."
                  : isBlocked
                  ? "Compte bloqu√©"
                  : remainingCredits <= 0
                  ? "Plus de cr√©dits"
                  : "Analyser / Mettre √† jour"}
              </button>
            </div>
          </section>

          {/* Informations cl√©s */}
          {profile && (
            <div className="rounded-xl border border-[var(--border)]/60 bg-[var(--bg-soft)] p-3 space-y-2">
              <div className="flex items-center justify-between gap-2">
                <p className="text-[11px] text-[var(--muted)] font-medium">
                  Informations cl√©s
                </p>
                <button
                  type="button"
                  onClick={openInfosModal}
                  className="inline-flex items-center gap-1 rounded-full border border-[var(--border)] bg-[var(--bg)] px-2.5 py-1 text-[11px] text-[var(--muted)] hover:border-[var(--brand)] hover:text-[var(--brand)] transition-colors"
                >
                  <span className="text-[13px]">‚úèÔ∏è</span>
                  <span>Modifier / ajouter</span>
                </button>
              </div>
              <div className="grid gap-3 sm:grid-cols-2 text-[12px]">
                <div>
                  <p className="text-[11px] text-[var(--muted)]">Email</p>
                  <p className="font-medium">
                    {profile.email || userEmail || "‚Äî"}
                  </p>
                </div>
                <div>
                  <p className="text-[11px] text-[var(--muted)]">T√©l√©phone</p>
                  <p className="font-medium">{profile.phone || "‚Äî"}</p>
                </div>
                <div>
                  <p className="text-[11px] text-[var(--muted)]">LinkedIn</p>
                  <p className="font-medium break-all">
                    {profile.linkedin || "‚Äî"}
                  </p>
                </div>
                <div>
                  <p className="text-[11px] text-[var(--muted)]">Adresse</p>
                  <p className="font-medium line-clamp-2">
                    {profile.address || profile.city || "‚Äî"}
                  </p>
                </div>
                <div>
                  <p className="text-[11px] text-[var(--muted)]">
                    Contrat recherch√©
                  </p>
                  <p className="font-medium line-clamp-2">
                    {profile.contractType || "Non renseign√©"}
                  </p>
                </div>
                <div>
                  <p className="text-[11px] text-[var(--muted)]">
                    Permis de conduire
                  </p>
                  <p className="font-medium">
                    {profile.drivingLicense || "‚Äî"}
                  </p>
                </div>
                <div>
                  <p className="text-[11px] text-[var(--muted)]">V√©hicule</p>
                  <p className="font-medium">{profile.vehicle || "‚Äî"}</p>
                </div>
              </div>
            </div>
          )}

          {error && (
            <div className="mt-1 w-full rounded-lg border border-red-500/40 bg-red-500/10 px-3 py-2 text-[11px] text-red-100">
              {error}
            </div>
          )}

          {/* Visibilit√© */}
          <div className="text-[11px] text-[var(--muted)]">
            Visibilit√© :{" "}
            <span className="font-medium text-[var(--text)]">
              {visibilityLabel}
            </span>
          </div>
        </div>

        {/* Colonne droite : RADAR */}
        <div className="md:w-[320px] lg:w-[360px] flex-shrink-0">
          <div className="rounded-2xl bg-[var(--bg-soft)] border border-[var(--border)]/80 px-3 py-3 sm:p-4 h-full flex flex-col">
            <p className="text-[11px] text-[var(--muted)] mb-2">
              Radar de comp√©tences estim√©
            </p>
            <div className="relative flex-1 min-h-[210px]">
              <canvas
                id="skillsRadarChart"
                ref={radarCanvasRef}
                className="w-full h-full"
              />
            </div>
          </div>
        </div>
      </header>

      {/* 3. CONTENU PRINCIPAL : NAV GAUCHE + SECTIONS */}
      <div className="lg:grid lg:grid-cols-[220px,1fr] gap-4 sm:gap-5">
        {/* Sidebar navigation */}
        <aside className="mb-3 lg:mb-0">
          <motion.nav
            initial={{ opacity: 0, y: 10 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ duration: 0.35 }}
            className="glass border border-[var(--border)]/80 rounded-2xl py-3 text-[12px] sticky top-20 lg:top-24"
          >
            <p className="px-3 pb-1 text-[11px] text-[var(--muted)]">
              Navigation rapide
            </p>
            <ul className="space-y-0.5">
              {navItems.map((item, idx) => (
                <motion.li
                  key={item.id}
                  initial={{ opacity: 0, x: -8 }}
                  animate={{ opacity: 1, x: 0 }}
                  transition={{ delay: 0.1 + idx * 0.05 }}
                >
                  <a
                    href={`#${item.id}`}
                    className="flex items-center justify-between px-3 py-2 hover:bg-[var(--bg-soft)] text-[12px] rounded-md transition-colors"
                  >
                    <span>{item.label}</span>
                    <motion.span
                      whileHover={{ x: 2 }}
                      className="text-[10px] text-[var(--muted)]"
                    >
                      ‚Üó
                    </motion.span>
                  </a>
                </motion.li>
              ))}
            </ul>
          </motion.nav>
        </aside>

        {/* Main content */}
        <main className="space-y-4 sm:space-y-5">
          {/* Comp√©tences */}
          {profile?.skills && (
            <section
              id="competences"
              className="glass border border-[var(--border)]/80 rounded-2xl p-4 sm:p-5 space-y-4"
            >
              <div className="flex items-center justify-between gap-2 mb-1">
                <h2 className="text-sm sm:text-base font-semibold">
                  Comp√©tences &amp; Outils
                </h2>
                <button
                  type="button"
                  onClick={openSkillsModal}
                  className="inline-flex items-center gap-1 rounded-full border border-[var(--border)] bg-[var(--bg-soft)] px-2.5 py-1 text-[11px] text-[var(--muted)] hover:border-[var(--brand)] hover:text-[var(--brand)] transition-colors"
                >
                  <span className="text-[13px]">‚úèÔ∏è</span>
                  <span>Modifier / ajouter</span>
                </button>
              </div>

              {profile.skills.sections?.length > 0 && (
                <div className="space-y-4">
                  {profile.skills.sections.map((section, idx) => (
                    <div key={idx} className="space-y-1">
                      <p className="text-[11px] uppercase tracking-wide text-[var(--muted)]">
                        {section.title}
                      </p>
                      <div className="flex flex-wrap gap-2 text-[12px]">
                        {section.items.map((s, i) => (
                          <span key={i} className="badge">
                            {s}
                          </span>
                        ))}
                      </div>
                    </div>
                  ))}
                </div>
              )}

              {profile.skills.tools?.length > 0 && (
                <div className="space-y-1 pt-2 border-t border-[var(--border)]/80">
                  <p className="text-[11px] uppercase tracking-wide text-[var(--muted)]">
                    Outils / logiciels
                  </p>
                  <div className="flex flex-wrap gap-2 text-[12px]">
                    {profile.skills.tools.map((tool, idx) => (
                      <span key={idx} className="badge">
                        {tool}
                      </span>
                    ))}
                  </div>
                </div>
              )}
            </section>
          )}

          {/* Exp√©rience */}
          {profile?.experiences?.length ? (
            <section
              id="experience"
              className="glass border border-[var(--border)]/80 rounded-2xl p-4 sm:p-5"
            >
              <div className="flex items-center justify-between gap-2 mb-2">
                <h2 className="text-sm sm:text-base font-semibold">
                  Exp√©riences principales
                </h2>
                <button
                  type="button"
                  onClick={openExperienceModal}
                  className="inline-flex items-center gap-1 rounded-full border border-[var(--border)] bg-[var(--bg-soft)] px-2.5 py-1 text-[11px] text-[var(--muted)] hover:border-[var(--brand)] hover:text-[var(--brand)] transition-colors"
                >
                  <span className="text-[13px]">‚úèÔ∏è</span>
                  <span>Modifier / ajouter</span>
                </button>
              </div>

              <ul className="space-y-3 text-[12px]">
                {profile.experiences.map((exp, idx) => (
                  <li
                    key={idx}
                    className="rounded-lg bg-[var(--bg-soft)] border border-[var(--border)]/70 px-3 py-3"
                  >
                    <p className="font-medium">
                      {exp.role || "Poste"} ¬∑ {exp.company || "Entreprise"}
                    </p>
                    <p className="text-[11px] text-[var(--muted)]">
                      {exp.dates || ""}
                    </p>
                    {exp.bullets?.length > 0 && (
                      <ul className="mt-1 list-disc list-inside space-y-0.5">
                        {exp.bullets.map((b, i) => (
                          <li key={i}>{b}</li>
                        ))}
                      </ul>
                    )}
                  </li>
                ))}
              </ul>
            </section>
          ) : null}

          {/* Formation & certifs */}
          {profile && (profile.educationShort?.length || profile.certs) && (
            <section
              id="formation"
              className="glass border border-[var(--border)]/80 rounded-2xl p-4 sm:p-5 space-y-4"
            >
              <div className="flex items-center justify-between gap-2 mb-2">
                <h2 className="text-sm sm:text-base font-semibold">
                  Formation &amp; Certifications
                </h2>
                <button
                  type="button"
                  onClick={openEducationModal}
                  className="inline-flex items-center gap-1 rounded-full border border-[var(--border)] bg-[var(--bg-soft)] px-2.5 py-1 text-[11px] text-[var(--muted)] hover:border-[var(--brand)] hover:text-[var(--brand)] transition-colors"
                >
                  <span className="text-[13px]">‚úèÔ∏è</span>
                  <span>Modifier / ajouter</span>
                </button>
              </div>

              {profile?.educationShort?.length ? (
                <div>
                  <ul className="space-y-1.5 text-[12px]">
                    {profile.educationShort.map((line, idx) => (
                      <li key={idx}>{line}</li>
                    ))}
                  </ul>
                </div>
              ) : null}

              {profile?.certs && (
                <div>
                  <p className="text-[11px] text-[var(--muted)] mb-1">
                    Certifications
                  </p>
                  <p className="text-[12px]">{profile.certs}</p>
                </div>
              )}
            </section>
          )}

          {/* Langues */}
          {profile && (
            <section
              id="langues"
              className="glass border border-[var(--border)]/80 rounded-2xl p-4 sm:p-5 space-y-3"
            >
              <div className="flex items-center justify-between gap-2 mb-1">
                <h2 className="text-sm sm:text-base font-semibold">Langues</h2>
                <button
                  type="button"
                  onClick={openLanguagesModal}
                  className="inline-flex items-center gap-1 rounded-full border border-[var(--border)] bg-[var(--bg-soft)] px-2.5 py-1 text-[11px] text-[var(--muted)] hover:border-[var(--brand)] hover:text-[var(--brand)] transition-colors"
                >
                  <span className="text-[13px]">‚úèÔ∏è</span>
                  <span>Modifier / ajouter</span>
                </button>
              </div>
              {langDisplay.length > 0 ? (
                <div className="flex flex-wrap gap-x-6 gap-y-3 text-[13px]">
                  {langDisplay.map((lang, idx) => (
                    <div key={idx} className="flex items-center gap-2">
                      <span className="text-2xl">{lang.flag}</span>
                      <span className="font-medium text-[var(--text)]">
                        {lang.text}
                      </span>
                    </div>
                  ))}
                </div>
              ) : (
                <p className="text-[12px] text-[var(--muted)]">
                  Aucune langue renseign√©e pour le moment.
                </p>
              )}
            </section>
          )}

          {/* Hobbies */}
          {profile && (
            <section
              id="hobbies"
              className="glass border border-[var(--border)]/80 rounded-2xl p-4 sm:p-5"
            >
              <div className="flex items-center justify-between gap-2 mb-2">
                <h2 className="text-sm sm:text-base font-semibold">
                  Centres d&apos;int√©r√™t
                </h2>
                <button
                  type="button"
                  onClick={openHobbiesModal}
                  className="inline-flex items-center gap-1 rounded-full border border-[var(--border)] bg-[var(--bg-soft)] px-2.5 py-1 text-[11px] text-[var(--muted)] hover:border-[var(--brand)] hover:text-[var(--brand)] transition-colors"
                >
                  <span className="text-[13px]">‚úèÔ∏è</span>
                  <span>Modifier / ajouter</span>
                </button>
              </div>
              {profile.hobbies?.length ? (
                <div className="flex flex-wrap gap-2 text-[12px]">
                  {profile.hobbies.map((hobby) => (
                    <span
                      key={hobby}
                      className="inline-flex items-center gap-1 rounded-full border border-[var(--border)] bg-[var(--bg-soft)] px-2 py-[3px]"
                    >
                      <span>{getHobbyEmoji(hobby)}</span>
                      <span>{hobby}</span>
                    </span>
                  ))}
                </div>
              ) : (
                <p className="text-[12px] text-[var(--muted)]">
                  Aucun centre d&apos;int√©r√™t renseign√© pour le moment.
                </p>
              )}
            </section>
          )}
        </main>
      </div>

      {/* Message si aucun profil */}
      {!profile && !loadingProfileFromDb && (
        <div className="text-center p-10 glass border border-[var(--border)]/80 rounded-2xl">
          <h3 className="text-lg font-semibold mb-2">
            Aucun profil enregistr√© ou analys√©
          </h3>
          <p className="text-[13px] text-[var(--muted)]">
            Veuille uploader un CV PDF dans le header ci-dessus pour initialiser
            ton profil candidat IA.
          </p>
        </div>
      )}

      {/* --- MODALE G√âN√âRIQUE D'√âDITION --- */}
      {activeModal && (
        <div className="fixed inset-0 z-40 flex items-center justify-center bg-black/40 px-3">
          <motion.form
            onSubmit={handleModalSave}
            initial={{ opacity: 0, y: 16, scale: 0.97 }}
            animate={{ opacity: 1, y: 0, scale: 1 }}
            exit={{ opacity: 0, y: 16, scale: 0.97 }}
            className="w-full max-w-lg rounded-2xl bg-[var(--bg)] border border-[var(--border)] shadow-xl p-4 sm:p-5 space-y-4"
          >
            <div className="flex items-center justify-between gap-2">
              <h3 className="text-sm sm:text-base font-semibold">
                {activeModal === "infos" && "Modifier tes informations cl√©s"}
                {activeModal === "skills" && "Modifier tes comp√©tences & outils"}
                {activeModal === "experience" &&
                  "Modifier tes exp√©riences principales"}
                {activeModal === "education" &&
                  "Modifier ta formation & tes certifications"}
                {activeModal === "languages" && "Modifier tes langues"}
                {activeModal === "hobbies" && "Modifier tes centres d‚Äôint√©r√™t"}
              </h3>
              <button
                type="button"
                onClick={handleModalCancel}
                className="rounded-full px-2 py-1 text-[11px] text-[var(--muted)] hover:bg-[var(--bg-soft)]"
              >
                ‚úï
              </button>
            </div>

            <div className="space-y-3 max-h-[60vh] overflow-auto pr-1">
              {/* INFOS */}
              {activeModal === "infos" && (
                <>
                  <div className="grid sm:grid-cols-2 gap-3 text-[12px]">
                    <div>
                      <label className="text-[11px] text-[var(--muted)]">
                        Nom complet
                      </label>
                      <input
                        className="mt-1 w-full rounded-md border border-[var(--border)] bg-[var(--bg-soft)] px-2 py-1.5 text-[12px] outline-none focus:ring-1 focus:ring-[var(--brand)]"
                        value={infosDraft.fullName}
                        onChange={(e) =>
                          setInfosDraft((p) => ({
                            ...p,
                            fullName: e.target.value,
                          }))
                        }
                      />
                    </div>
                    <div>
                      <label className="text-[11px] text-[var(--muted)]">
                        Email
                      </label>
                      <input
                        className="mt-1 w-full rounded-md border border-[var(--border)] bg-[var(--bg-soft)] px-2 py-1.5 text-[12px] outline-none focus:ring-1 focus:ring-[var(--brand)]"
                        value={infosDraft.email}
                        onChange={(e) =>
                          setInfosDraft((p) => ({
                            ...p,
                            email: e.target.value,
                          }))
                        }
                      />
                    </div>
                    <div>
                      <label className="text-[11px] text-[var(--muted)]">
                        T√©l√©phone
                      </label>
                      <input
                        className="mt-1 w-full rounded-md border border-[var(--border)] bg-[var(--bg-soft)] px-2 py-1.5 text-[12px] outline-none focus:ring-1 focus:ring-[var(--brand)]"
                        value={infosDraft.phone}
                        onChange={(e) =>
                          setInfosDraft((p) => ({
                            ...p,
                            phone: e.target.value,
                          }))
                        }
                      />
                    </div>
                    <div>
                      <label className="text-[11px] text-[var(--muted)]">
                        LinkedIn
                      </label>
                      <input
                        className="mt-1 w-full rounded-md border border-[var(--border)] bg-[var(--bg-soft)] px-2 py-1.5 text-[12px] outline-none focus:ring-1 focus:ring-[var(--brand)]"
                        value={infosDraft.linkedin}
                        onChange={(e) =>
                          setInfosDraft((p) => ({
                            ...p,
                            linkedin: e.target.value,
                          }))
                        }
                      />
                    </div>
                    <div>
                      <label className="text-[11px] text-[var(--muted)]">
                        Permis (ex : Permis B)
                      </label>
                      <input
                        className="mt-1 w-full rounded-md border border-[var(--border)] bg-[var(--bg-soft)] px-2 py-1.5 text-[12px] outline-none focus:ring-1 focus:ring-[var(--brand)]"
                        value={infosDraft.drivingLicense}
                        onChange={(e) =>
                          setInfosDraft((p) => ({
                            ...p,
                            drivingLicense: e.target.value,
                          }))
                        }
                      />
                    </div>
                    <div>
                      <label className="text-[11px] text-[var(--muted)]">
                        V√©hicule (ex : V√©hicul√©)
                      </label>
                      <input
                        className="mt-1 w-full rounded-md border border-[var(--border)] bg-[var(--bg-soft)] px-2 py-1.5 text-[12px] outline-none focus:ring-1 focus:ring-[var(--brand)]"
                        value={infosDraft.vehicle}
                        onChange={(e) =>
                          setInfosDraft((p) => ({
                            ...p,
                            vehicle: e.target.value,
                          }))
                        }
                      />
                    </div>
                    <div className="sm:col-span-2">
                      <label className="text-[11px] text-[var(--muted)]">
                        Adresse (ville, code postal, etc.)
                      </label>
                      <input
                        className="mt-1 w-full rounded-md border border-[var(--border)] bg-[var(--bg-soft)] px-2 py-1.5 text-[12px] outline-none focus:ring-1 focus:ring-[var(--brand)]"
                        placeholder="Ex : 12 rue Exemple, 75000 Paris"
                        value={infosDraft.address}
                        onChange={(e) =>
                          setInfosDraft((p) => ({
                            ...p,
                            address: e.target.value,
                          }))
                        }
                      />
                    </div>
                  </div>
                  <div className="text-[12px]">
                    <label className="text-[11px] text-[var(--muted)]">
                      Contrat recherch√©
                    </label>
                    <input
                      list="contract-type-options"
                      className="mt-1 w-full rounded-md border border-[var(--border)] bg-[var(--bg-soft)] px-2 py-1.5 text-[12px] outline-none focus:ring-1 focus:ring-[var(--brand)]"
                      placeholder="Ex : CDI, Alternance, Stage, Freelance..."
                      value={infosDraft.contractType}
                      onChange={(e) =>
                        setInfosDraft((p) => ({
                          ...p,
                          contractType: e.target.value,
                        }))
                      }
                    />
                    <datalist id="contract-type-options">
                      {CONTRACT_TYPE_OPTIONS.map((c) => (
                        <option key={c} value={c} />
                      ))}
                    </datalist>
                  </div>
                  <div className="text-[12px]">
                    <label className="text-[11px] text-[var(--muted)]">
                      R√©sum√© de profil / Pitch
                    </label>
                    <textarea
                      rows={4}
                      className="mt-1 w-full rounded-md border border-[var(--border)] bg-[var(--bg-soft)] px-2 py-1.5 text-[12px] outline-none focus:ring-1 focus:ring-[var(--brand)] resize-vertical"
                      value={infosDraft.profileSummary}
                      onChange={(e) =>
                        setInfosDraft((p) => ({
                          ...p,
                          profileSummary: e.target.value,
                        }))
                      }
                    />
                  </div>
                </>
              )}

              {/* COMP√âTENCES */}
              {activeModal === "skills" && (
                <>
                  <div className="text-[12px] space-y-1">
                    <label className="text-[11px] text-[var(--muted)]">
                      Sections de comp√©tences
                    </label>
                    <p className="text-[11px] text-[var(--muted)]">
                      Format conseill√© : une ligne par section. Exemple :
                      <br />
                      <span className="italic">
                        &quot;Comp√©tences analytiques : Analyse financi√®re,
                        Reporting, Budget&quot;
                      </span>
                    </p>
                    <textarea
                      rows={5}
                      className="mt-1 w-full rounded-md border border-[var(--border)] bg-[var(--bg-soft)] px-2 py-1.5 text-[12px] outline-none focus:ring-1 focus:ring-[var(--brand)] resize-vertical"
                      value={skillsSectionsText}
                      onChange={(e) => setSkillsSectionsText(e.target.value)}
                    />
                  </div>
                  <div className="text-[12px] space-y-1">
                    <label className="text-[11px] text-[var(--muted)]">
                      Outils / logiciels (s√©par√©s par des virgules)
                    </label>
                    <textarea
                      rows={2}
                      className="mt-1 w-full rounded-md border border-[var(--border)] bg-[var(--bg-soft)] px-2 py-1.5 text-[12px] outline-none focus:ring-1 focus:ring-[var(--brand)] resize-vertical"
                      value={skillsToolsText}
                      onChange={(e) => setSkillsToolsText(e.target.value)}
                    />
                  </div>
                </>
              )}

              {/* EXP√âRIENCE */}
              {activeModal === "experience" && (
                <div className="space-y-3 text-[12px]">
                  {experiencesDraft.map((exp, idx) => (
                    <div
                      key={idx}
                      className="rounded-lg border border-[var(--border)]/70 bg-[var(--bg-soft)] p-3 space-y-2"
                    >
                      <div className="grid sm:grid-cols-2 gap-2">
                        <div>
                          <label className="text-[11px] text-[var(--muted)]">
                            Poste
                          </label>
                          <input
                            className="mt-1 w-full rounded-md border border-[var(--border)] bg-[var(--bg)] px-2 py-1.5 text-[12px] outline-none focus:ring-1 focus:ring-[var(--brand)]"
                            value={exp.role}
                            onChange={(e) =>
                              updateExperienceDraft(idx, "role", e.target.value)
                            }
                          />
                        </div>
                        <div>
                          <label className="text-[11px] text-[var(--muted)]">
                            Entreprise
                          </label>
                          <input
                            className="mt-1 w-full rounded-md border border-[var(--border)] bg-[var(--bg)] px-2 py-1.5 text-[12px] outline-none focus:ring-1 focus:ring-[var(--brand)]"
                            value={exp.company}
                            onChange={(e) =>
                              updateExperienceDraft(
                                idx,
                                "company",
                                e.target.value
                              )
                            }
                          />
                        </div>
                        <div>
                          <label className="text-[11px] text-[var(--muted)]">
                            Dates
                          </label>
                          <input
                            className="mt-1 w-full rounded-md border border-[var(--border)] bg-[var(--bg)] px-2 py-1.5 text-[12px] outline-none focus:ring-1 focus:ring-[var(--brand)]"
                            value={exp.dates}
                            onChange={(e) =>
                              updateExperienceDraft(
                                idx,
                                "dates",
                                e.target.value
                              )
                            }
                          />
                        </div>
                      </div>
                      <div>
                        <label className="text-[11px] text-[var(--muted)]">
                          Missions / R√©alisations (une par ligne)
                        </label>
                        <textarea
                          rows={3}
                          className="mt-1 w-full rounded-md border border-[var(--border)] bg-[var(--bg)] px-2 py-1.5 text-[12px] outline-none focus:ring-1 focus:ring-[var(--brand)] resize-vertical"
                          value={exp.bulletsText}
                          onChange={(e) =>
                            updateExperienceDraft(
                              idx,
                              "bulletsText",
                              e.target.value
                            )
                          }
                        />
                      </div>
                    </div>
                  ))}

                  <button
                    type="button"
                    onClick={addExperienceDraft}
                    className="inline-flex items-center gap-1 rounded-full border border-dashed border-[var(--border)] bg-[var(--bg-soft)] px-3 py-1.5 text-[11px] text-[var(--muted)] hover:border-[var(--brand)] hover:text-[var(--brand)] transition-colors"
                  >
                    <span className="text-[14px]">Ôºã</span>
                    <span>Ajouter une exp√©rience</span>
                  </button>
                </div>
              )}

              {/* FORMATION & CERTIFS */}
              {activeModal === "education" && (
                <>
                  <div className="space-y-3 text-[12px]">
                    {educationDrafts.map((edu, idx) => (
                      <div
                        key={idx}
                        className="rounded-lg border border-[var(--border)]/70 bg-[var(--bg-soft)] p-3 space-y-2"
                      >
                        <div className="grid sm:grid-cols-2 gap-2">
                          <div>
                            <label className="text-[11px] text-[var(--muted)]">
                              Dipl√¥me
                            </label>
                            <input
                              className="mt-1 w-full rounded-md border border-[var(--border)] bg-[var(--bg)] px-2 py-1.5 text-[12px] outline-none focus:ring-1 focus:ring-[var(--brand)]"
                              value={edu.degree}
                              onChange={(e) =>
                                updateEducationDraft(
                                  idx,
                                  "degree",
                                  e.target.value
                                )
                              }
                            />
                          </div>
                          <div>
                            <label className="text-[11px] text-[var(--muted)]">
                              √âcole / Universit√©
                            </label>
                            <input
                              className="mt-1 w-full rounded-md border border-[var(--border)] bg-[var(--bg)] px-2 py-1.5 text-[12px] outline-none focus:ring-1 focus:ring-[var(--brand)]"
                              value={edu.school}
                              onChange={(e) =>
                                updateEducationDraft(
                                  idx,
                                  "school",
                                  e.target.value
                                )
                              }
                            />
                          </div>
                          <div>
                            <label className="text-[11px] text-[var(--muted)]">
                              Lieu (optionnel)
                            </label>
                            <input
                              className="mt-1 w-full rounded-md border border-[var(--border)] bg-[var(--bg)] px-2 py-1.5 text-[12px] outline-none focus:ring-1 focus:ring-[var(--brand)]"
                              value={edu.location}
                              onChange={(e) =>
                                updateEducationDraft(
                                  idx,
                                  "location",
                                  e.target.value
                                )
                              }
                            />
                          </div>
                          <div>
                            <label className="text-[11px] text-[var(--muted)]">
                              Dates
                            </label>
                            <input
                              className="mt-1 w-full rounded-md border border-[var(--border)] bg-[var(--bg)] px-2 py-1.5 text-[12px] outline-none focus:ring-1 focus:ring-[var(--brand)]"
                              placeholder="Ex : 2022‚Äì2024"
                              value={edu.dates}
                              onChange={(e) =>
                                updateEducationDraft(
                                  idx,
                                  "dates",
                                  e.target.value
                                )
                              }
                            />
                          </div>
                        </div>
                        {educationDrafts.length > 1 && (
                          <div className="flex justify-end">
                            <button
                              type="button"
                              onClick={() =>
                                setEducationDrafts((prev) =>
                                  prev.filter((_, i) => i !== idx)
                                )
                              }
                              className="text-[11px] text-[var(--muted)] hover:text-red-400"
                            >
                              Supprimer cette formation
                            </button>
                          </div>
                        )}
                      </div>
                    ))}

                    <button
                      type="button"
                      onClick={addEducationDraft}
                      className="inline-flex items-center gap-1 rounded-full border border-dashed border-[var(--border)] bg-[var(--bg-soft)] px-3 py-1.5 text-[11px] text-[var(--muted)] hover:border-[var(--brand)] hover:text-[var(--brand)] transition-colors"
                    >
                      <span className="text-[14px]">Ôºã</span>
                      <span>Ajouter une formation</span>
                    </button>
                  </div>

                  {/* Certifications */}
                  <div className="text-[12px] space-y-2 pt-3">
                    <label className="text-[11px] text-[var(--muted)]">
                      Certifications (avec auto-compl√©tion)
                    </label>
                    <div className="flex gap-2">
                      <input
                        list="certification-options"
                        className="flex-1 rounded-md border border-[var(--border)] bg-[var(--bg-soft)] px-2 py-1.5 text-[12px] outline-none focus:ring-1 focus:ring-[var(--brand)]"
                        placeholder="Ex : Tosa Excel, Azure AZ-900..."
                        value={certInput}
                        onChange={(e) => setCertInput(e.target.value)}
                      />
                      <button
                        type="button"
                        onClick={() => {
                          const val = certInput.trim();
                          if (!val) return;
                          if (!certsList.includes(val)) {
                            setCertsList((prev) => [...prev, val]);
                          }
                          setCertInput("");
                        }}
                        className="rounded-md bg-[var(--brand)] hover:bg-[var(--brandDark)] px-3 py-1.5 text-[12px] text-white"
                      >
                        Ajouter
                      </button>
                      <datalist id="certification-options">
                        {CERTIFICATION_OPTIONS.map((c) => (
                          <option key={c} value={c} />
                        ))}
                      </datalist>
                    </div>

                    {certsList.length > 0 && (
                      <div className="flex flex-wrap gap-2 mt-1">
                        {certsList.map((cert) => (
                          <span
                            key={cert}
                            className="inline-flex items-center gap-1 rounded-full border border-[var(--border)] bg-[var(--bg-soft)] px-2 py-[2px] text-[11px]"
                          >
                            {cert}
                            <button
                              type="button"
                              onClick={() =>
                                setCertsList((prev) =>
                                  prev.filter((c) => c !== cert)
                                )
                              }
                              className="text-[10px] text-[var(--muted)] hover:text-red-400"
                            >
                              ‚úï
                            </button>
                          </span>
                        ))}
                      </div>
                    )}
                  </div>
                </>
              )}

              {/* LANGUES */}
              {activeModal === "languages" && (
                <div className="text-[12px] space-y-3">
                  <p className="text-[11px] text-[var(--muted)]">
                    Ajoute tes langues avec leur niveau. Tu peux choisir dans la
                    liste ou taper manuellement.
                  </p>
                  {languagesDraft.map((lang, idx) => {
                    const flag =
                      lang.language.trim() !== ""
                        ? getFlagEmoji(lang.language)
                        : "üåê";
                    return (
                      <div
                        key={idx}
                        className="flex items-center gap-2 rounded-lg border border-[var(--border)]/70 bg-[var(--bg-soft)] px-2.5 py-2"
                      >
                        <span className="text-xl w-7 text-center">{flag}</span>
                        <div className="flex-1 grid grid-cols-1 sm:grid-cols-2 gap-2">
                          <div>
                            <label className="text-[11px] text-[var(--muted)]">
                              Langue
                            </label>
                            <input
                              list="language-options"
                              className="mt-1 w-full rounded-md border border-[var(--border)] bg-[var(--bg)] px-2 py-1.5 text-[12px] outline-none focus:ring-1 focus:ring-[var(--brand)]"
                              value={lang.language}
                              onChange={(e) =>
                                setLanguagesDraft((prev) =>
                                  prev.map((l, i) =>
                                    i === idx
                                      ? { ...l, language: e.target.value }
                                      : l
                                  )
                                )
                              }
                            />
                          </div>
                          <div>
                            <label className="text-[11px] text-[var(--muted)]">
                              Niveau
                            </label>
                            <select
                              className="mt-1 w-full rounded-md border border-[var(--border)] bg-[var(--bg)] px-2 py-1.5 text-[12px] outline-none focus:ring-1 focus:ring-[var(--brand)]"
                              value={lang.level}
                              onChange={(e) =>
                                setLanguagesDraft((prev) =>
                                  prev.map((l, i) =>
                                    i === idx
                                      ? { ...l, level: e.target.value }
                                      : l
                                  )
                                )
                              }
                            >
                              <option value="">S√©lectionner un niveau</option>
                              {LANGUAGE_LEVEL_OPTIONS.map((lvl) => (
                                <option key={lvl} value={lvl}>
                                  {lvl}
                                </option>
                              ))}
                            </select>
                          </div>
                        </div>
                        {languagesDraft.length > 1 && (
                          <button
                            type="button"
                            onClick={() =>
                              setLanguagesDraft((prev) =>
                                prev.filter((_, i) => i !== idx)
                              )
                            }
                            className="ml-1 text-[11px] text-[var(--muted)] hover:text-red-400"
                          >
                            ‚úï
                          </button>
                        )}
                      </div>
                    );
                  })}

                  <datalist id="language-options">
                    {LANGUAGE_OPTIONS.map((l) => (
                      <option key={l} value={l} />
                    ))}
                  </datalist>

                  <button
                    type="button"
                    onClick={() =>
                      setLanguagesDraft((prev) => [
                        ...prev,
                        { language: "", level: "" },
                      ])
                    }
                    className="inline-flex items-center gap-1 rounded-full border border-dashed border-[var(--border)] bg-[var(--bg-soft)] px-3 py-1.5 text-[11px] text-[var(--muted)] hover:border-[var(--brand)] hover:text-[var(--brand)] transition-colors"
                  >
                    <span className="text-[14px]">Ôºã</span>
                    <span>Ajouter une langue</span>
                  </button>
                </div>
              )}

              {/* HOBBIES */}
              {activeModal === "hobbies" && (
                <div className="text-[12px] space-y-2">
                  <label className="text-[11px] text-[var(--muted)]">
                    Centres d&apos;int√©r√™t (avec auto-compl√©tion)
                  </label>
                  <div className="flex gap-2">
                    <input
                      list="hobby-options"
                      className="flex-1 rounded-md border border-[var(--border)] bg-[var(--bg-soft)] px-2 py-1.5 text-[12px] outline-none focus:ring-1 focus:ring-[var(--brand)]"
                      placeholder="Ex : Voyage, Football, Lecture..."
                      value={hobbyInput}
                      onChange={(e) => setHobbyInput(e.target.value)}
                    />
                    <button
                      type="button"
                      onClick={() => {
                        const val = hobbyInput.trim();
                        if (!val) return;
                        if (!hobbiesList.includes(val)) {
                          setHobbiesList((prev) => [...prev, val]);
                        }
                        setHobbyInput("");
                      }}
                      className="rounded-md bg-[var(--brand)] hover:bg-[var(--brandDark)] px-3 py-1.5 text-[12px] text-white"
                    >
                      Ajouter
                    </button>
                    <datalist id="hobby-options">
                      {HOBBY_OPTIONS.map((h) => (
                        <option key={h} value={h} />
                      ))}
                    </datalist>
                  </div>

                  {hobbiesList.length > 0 ? (
                    <div className="flex flex-wrap gap-2 mt-2">
                      {hobbiesList.map((hobby) => (
                        <span
                          key={hobby}
                          className="inline-flex items-center gap-1 rounded-full border border-[var(--border)] bg-[var(--bg-soft)] px-2 py-[2px] text-[11px]"
                        >
                          <span>{getHobbyEmoji(hobby)}</span>
                          <span>{hobby}</span>
                          <button
                            type="button"
                            onClick={() =>
                              setHobbiesList((prev) =>
                                prev.filter((h) => h !== hobby)
                              )
                            }
                            className="text-[10px] text-[var(--muted)] hover:text-red-400"
                          >
                            ‚úï
                          </button>
                        </span>
                      ))}
                    </div>
                  ) : (
                    <p className="text-[11px] text-[var(--muted)] mt-1">
                      Aucun centre d&apos;int√©r√™t ajout√© pour le moment.
                    </p>
                  )}
                </div>
              )}
            </div>

            <div className="flex justify-end gap-2 pt-2">
              <button
                type="button"
                onClick={handleModalCancel}
                className="inline-flex items-center justify-center rounded-lg border border-[var(--border)] bg-[var(--bg-soft)] px-3 py-1.5 text-[12px] text-[var(--muted)] hover:bg-[var(--bg)] transition-colors"
              >
                Annuler
              </button>
              <button
                type="submit"
                className="inline-flex items-center justify-center rounded-lg bg-[var(--brand)] hover:bg-[var(--brandDark)] px-3 py-1.5 text-[12px] font-medium text-white transition-colors"
              >
                Enregistrer
              </button>
            </div>
          </motion.form>
        </div>
      )}
    </motion.div>
  );
}
````

## File: app/layout.tsx
````typescript
// app/layout.tsx
import "./globals.css";
import type { Metadata, Viewport } from "next";
import Script from "next/script";
import { AuthProvider } from "@/context/AuthContext";
import ActivityTracker from "@/components/ActivityTracker";

export const metadata: Metadata = {
  title: "Assistant Candidatures IA",
  description: "Tableau de bord CV / LM / candidatures",
};

export const viewport: Viewport = {
  width: "device-width",
  initialScale: 1,
  maximumScale: 1,
  viewportFit: "cover",
};

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  const siteKey = process.env.NEXT_PUBLIC_RECAPTCHA_SITE_KEY || "";
  const useEnterprise =
    (process.env.NEXT_PUBLIC_RECAPTCHA_ENTERPRISE || "")
      .toLowerCase()
      .trim() === "true";

  const recaptchaSrc = siteKey
    ? useEnterprise
      ? `https://www.google.com/recaptcha/enterprise.js?render=${encodeURIComponent(
          siteKey
        )}`
      : `https://www.google.com/recaptcha/api.js?render=${encodeURIComponent(
          siteKey
        )}`
    : "";

  return (
    <html lang="fr">
      <head>
        <link rel="manifest" href="/manifest.webmanifest" />
        <meta name="theme-color" content="#020617" />
        <meta name="mobile-web-app-capable" content="yes" />
        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta
          name="apple-mobile-web-app-status-bar-style"
          content="black-translucent"
        />
      </head>

      <body
        className="
          min-h-screen
          bg-[var(--bg)]
          text-[var(--text)]
          overflow-x-hidden
          antialiased
        "
      >
        {/* ‚úÖ Charge reCAPTCHA v3 (standard ou enterprise selon env) */}
        {siteKey ? (
          <Script
            src={recaptchaSrc}
            strategy="afterInteractive"
            data-recaptcha={useEnterprise ? "enterprise" : "v3"}
          />
        ) : null}

        <AuthProvider>
          <ActivityTracker />
          <div className="min-h-screen flex flex-col">{children}</div>
        </AuthProvider>
      </body>
    </html>
  );
}
````

## File: app/page.tsx
````typescript
"use client";

import Link from "next/link";
import { motion } from "framer-motion";
import { useRef, useState, UIEvent, useEffect } from "react";
import { useRouter } from "next/navigation";
import { onAuthStateChanged, type User } from "firebase/auth";
import { auth } from "@/lib/firebase";

const fadeUp = (delay = 0) => ({
  initial: { opacity: 0, y: 20 },
  whileInView: { opacity: 1, y: 0 },
  transition: { duration: 0.4, delay },
  viewport: { once: false, amount: 0.4 },
});

const SECTION_IDS: string[] = ["hero", "features", "how", "pricing", "stack", "faq"];

export default function LandingPage() {
  const scrollRef = useRef<HTMLDivElement | null>(null);
  const [progress, setProgress] = useState(0);
  const [activeSection, setActiveSection] = useState<string>("hero");

  // üîê √©tat d'auth Firebase
  const [currentUser, setCurrentUser] = useState<User | null>(null);
  const [navigating, setNavigating] = useState(false);
  const router = useRouter();

  useEffect(() => {
    const unsub = onAuthStateChanged(auth, (user) => {
      setCurrentUser(user);
    });
    return () => unsub();
  }, []);

  /**
   * ‚úÖ Debug reCAPTCHA (facultatif)
   * Si tu as bien mis le Script enterprise.js dans app/layout.tsx,
   * tu dois voir window.grecaptcha apr√®s quelques ms.
   */
  useEffect(() => {
    const t = window.setTimeout(() => {
      const g = (window as any).grecaptcha;
      // console.log("[recaptcha] loaded?", !!g, "enterprise?", !!g?.enterprise);
    }, 1200);
    return () => window.clearTimeout(t);
  }, []);

  const handleSmartLoginClick = () => {
    if (navigating) return;
    setNavigating(true);
    if (currentUser) router.push("/app");
    else router.push("/login");
  };

  const handleScroll = (e: UIEvent<HTMLDivElement>) => {
    const el = e.currentTarget;
    const maxScroll = el.scrollHeight - el.clientHeight;

    if (maxScroll <= 0) setProgress(0);
    else setProgress((el.scrollTop / maxScroll) * 100);

    const containerRect = el.getBoundingClientRect();
    let closestId: string = activeSection;
    let minDelta = Infinity;

    SECTION_IDS.forEach((id) => {
      const sec = document.getElementById(id) as HTMLElement | null;
      if (!sec) return;
      const rect = sec.getBoundingClientRect();
      const delta = Math.abs(rect.top - containerRect.top);
      if (delta < minDelta) {
        minDelta = delta;
        closestId = id;
      }
    });

    if (closestId !== activeSection) setActiveSection(closestId);
  };

  const baseNavLink =
    "relative inline-flex items-center gap-1 text-[11px] px-2 py-1 rounded-full transition-colors";

  const scrollToSection =
    (id: string) => (e: React.MouseEvent<HTMLAnchorElement>) => {
      e.preventDefault();
      const sec = document.getElementById(id);
      if (sec) sec.scrollIntoView({ behavior: "smooth", block: "start" });
    };

  return (
    <div className="min-h-screen bg-[var(--bg)] text-[var(--ink)] flex flex-col overflow-x-hidden">
      {/* NAVBAR FIXE */}
      <header className="fixed top-0 left-0 right-0 z-40 bg-[var(--bg)]/90 backdrop-blur-xl">
        <div className="max-w-6xl mx-auto px-4 sm:px-8 h-14 flex items-center justify-between">
          {/* Logo + titre */}
          <div className="flex items-center gap-2">
            <div className="w-8 h-8 rounded-2xl bg-gradient-to-br from-[var(--brand)] to-[var(--brandDark)] shadow-lg shadow-[var(--brand)]/30 flex items-center justify-center text-[11px] font-semibold">
              AI
            </div>
            <div className="flex flex-col leading-tight">
              <span className="text-[11px] uppercase tracking-[0.22em] text-[var(--muted)]">
                Assistant candidatures
              </span>
              <span className="text-xs font-medium">Smart CV ¬∑ LM ¬∑ Pitch</span>
            </div>
          </div>

          {/* Liens + CTA */}
          <nav className="hidden sm:flex items-center gap-4 text-[11px]">
            <a
              href="#hero"
              onClick={scrollToSection("hero")}
              className={
                activeSection === "hero"
                  ? `${baseNavLink} bg-[var(--bg-soft)] text-[var(--ink)]`
                  : `${baseNavLink} text-[var(--muted)] hover:text-[var(--ink)]`
              }
            >
              {activeSection === "hero" && (
                <span className="inline-flex w-1.5 h-1.5 rounded-full bg-[var(--brand)] animate-pulse" />
              )}
              <span>Accueil</span>
            </a>

            <a
              href="#features"
              onClick={scrollToSection("features")}
              className={
                activeSection === "features"
                  ? `${baseNavLink} bg-[var(--bg-soft)] text-[var(--ink)]`
                  : `${baseNavLink} text-[var(--muted)] hover:text-[var(--ink)]`
              }
            >
              {activeSection === "features" && (
                <span className="inline-flex w-1.5 h-1.5 rounded-full bg-[var(--brand)] animate-pulse" />
              )}
              <span>Fonctionnalit√©s</span>
            </a>

            <a
              href="#how"
              onClick={scrollToSection("how")}
              className={
                activeSection === "how"
                  ? `${baseNavLink} bg-[var(--bg-soft)] text-[var(--ink)]`
                  : `${baseNavLink} text-[var(--muted)] hover:text-[var(--ink)]`
              }
            >
              {activeSection === "how" && (
                <span className="inline-flex w-1.5 h-1.5 rounded-full bg-[var(--brand)] animate-pulse" />
              )}
              <span>Comment √ßa marche</span>
            </a>

            <a
              href="#pricing"
              onClick={scrollToSection("pricing")}
              className={
                activeSection === "pricing"
                  ? `${baseNavLink} bg-[var(--bg-soft)] text-[var(--ink)]`
                  : `${baseNavLink} text-[var(--muted)] hover:text-[var(--ink)]`
              }
            >
              {activeSection === "pricing" && (
                <span className="inline-flex w-1.5 h-1.5 rounded-full bg-[var(--brand)] animate-pulse" />
              )}
              <span>Tarifs</span>
            </a>

            <a
              href="#stack"
              onClick={scrollToSection("stack")}
              className={
                activeSection === "stack"
                  ? `${baseNavLink} bg-[var(--bg-soft)] text-[var(--ink)]`
                  : `${baseNavLink} text-[var(--muted)] hover:text-[var(--ink)]`
              }
            >
              {activeSection === "stack" && (
                <span className="inline-flex w-1.5 h-1.5 rounded-full bg-[var(--brand)] animate-pulse" />
              )}
              <span>Tech</span>
            </a>

            <a
              href="#faq"
              onClick={scrollToSection("faq")}
              className={
                activeSection === "faq"
                  ? `${baseNavLink} bg-[var(--bg-soft)] text-[var(--ink)]`
                  : `${baseNavLink} text-[var(--muted)] hover:text-[var(--ink)]`
              }
            >
              {activeSection === "faq" && (
                <span className="inline-flex w-1.5 h-1.5 rounded-full bg-[var(--brand)] animate-pulse" />
              )}
              <span>Questions fr√©quentes</span>
            </a>
          </nav>

          <div className="flex items-center gap-2">
            <button
              type="button"
              onClick={handleSmartLoginClick}
              disabled={navigating}
              className="hidden sm:inline-flex text-[11px] text-[var(--muted)] hover:text-[var(--ink)] disabled:opacity-50"
            >
              Se connecter
            </button>

            <Link
              href="/signup"
              className="inline-flex items-center justify-center text-[11px] sm:text-xs px-3 sm:px-4 py-1.5 rounded-full bg-[var(--brand)] hover:bg-[var(--brandDark)] text-white shadow-lg shadow-[var(--brand)]/40 transition-colors"
            >
              Essayer gratuitement
            </Link>
          </div>
        </div>
      </header>

      {/* CONTENU */}
      <div className="flex-1 pt-14">
        {/* Barre de progression */}
        <div className="hidden md:block h-[2px] w-full bg-[var(--border)]/40 sticky top-14 z-30">
          <div
            className="scroll-progress-bar h-full bg-[var(--brand)] transition-[width] duration-150"
            style={{ width: `${progress}%` }}
          />
        </div>

        <main
          ref={scrollRef}
          onScroll={handleScroll}
          className="
            snap-none 
            md:snap-y md:snap-mandatory
            md:h-[calc(100vh-3.5rem-2px)] md:overflow-y-scroll
            scroll-smooth
          "
        >
          {/* HERO */}
          <section
            id="hero"
            className="md:snap-start md:min-h-[calc(100vh-3.5rem-2px)] flex items-center px-4 sm:px-8 py-10 md:py-0"
          >
            <div className="max-w-6xl mx-auto grid gap-8 md:grid-cols-[1.1fr,0.9fr] items-center">
              <motion.div {...fadeUp(0)}>
                <div className="inline-flex items-center gap-2 rounded-full border border-[var(--border)] bg-[var(--bg-soft)] px-2 py-1 mb-4">
                  <span className="inline-flex h-4 w-4 rounded-full bg-emerald-400/20 border border-emerald-400/50">
                    <span className="m-auto h-2 w-2 rounded-full bg-emerald-400" />
                  </span>
                  <span className="text-[11px] text-[var(--muted)]">
                    Gagne jusqu&apos;√†{" "}
                    <span className="text-[var(--ink)] font-medium">4h par semaine</span>{" "}
                    sur tes candidatures.
                  </span>
                </div>

                <h1 className="text-[1.9rem] sm:text-3xl md:text-[2.6rem] font-semibold leading-tight mb-3">
                  L&apos;assistant IA pour candidater comme un pro,
                  <span className="text-[var(--brand)]"> sans y passer tes soir√©es.</span>
                </h1>

                <p className="text-sm sm:text-base text-[var(--muted)] max-w-xl mb-5">
                  Importe ton CV, colle une offre d‚Äôemploi, laisse l‚ÄôIA g√©n√©rer une lettre de motivation
                  cibl√©e, un pitch oral et suis toutes tes candidatures depuis un tableau de bord unique.
                </p>

                <div className="flex flex-wrap items-center gap-3 mb-4">
                  <Link href="/signup" className="btn-primary text-xs sm:text-sm">
                    Essayer gratuitement
                  </Link>

                  <button
                    type="button"
                    onClick={handleSmartLoginClick}
                    disabled={navigating}
                    className="btn-secondary text-xs sm:text-sm disabled:opacity-50"
                  >
                    Se connecter
                  </button>
                </div>

                <p className="text-[11px] text-[var(--muted)]">
                  Aucun CB requise ‚Ä¢ Cr√©dits offerts √† l‚Äôinscription ‚Ä¢ Pens√© pour les profils tech & cybers√©curit√©
                </p>
              </motion.div>

              <motion.div {...fadeUp(0.1)} className="relative">
                <div className="glass rounded-2xl p-4 text-[11px] sm:text-xs shadow-2xl shadow-black/60 border border-[var(--border)]/80">
                  <div className="flex items-center justify-between mb-3">
                    <div>
                      <p className="text-[10px] uppercase tracking-[0.18em] text-[var(--muted)]">
                        Aper√ßu du dashboard
                      </p>
                      <p className="text-xs font-medium mt-1">
                        CV, lettres, pitch & suivi en un coup d&apos;≈ìil.
                      </p>
                    </div>
                    <span className="px-2 py-1 rounded-full bg-emerald-400/10 text-emerald-300 border border-emerald-400/40 text-[10px]">
                      IA activ√©e
                    </span>
                  </div>

                  <div className="grid gap-2 sm:grid-cols-3 mb-3">
                    <div className="rounded-xl bg-[var(--bg-soft)] border border-[var(--border)]/80 px-3 py-2">
                      <p className="text-[10px] text-[var(--muted)] mb-1">Cr√©dits restants</p>
                      <p className="text-lg font-semibold">124</p>
                      <p className="text-[10px] text-[var(--muted)]">~ 30 lettres + 15 pitchs</p>
                    </div>
                    <div className="rounded-xl bg-[var(--bg-soft)] border border-[var(--border)]/80 px-3 py-2">
                      <p className="text-[10px] text-[var(--muted)] mb-1">Candidatures envoy√©es</p>
                      <p className="text-lg font-semibold">18</p>
                      <p className="text-[10px] text-[var(--muted)]">5 en entretien üî•</p>
                    </div>
                    <div className="rounded-xl bg-[var(--bg-soft)] border border-[var(--border)]/80 px-3 py-2">
                      <p className="text-[10px] text-[var(--muted)] mb-1">Temps √©conomis√©</p>
                      <p className="text-lg font-semibold">7h / semaine</p>
                      <p className="text-[10px] text-[var(--muted)]">vs candidatures manuelles</p>
                    </div>
                  </div>

                  <div className="rounded-xl bg-gradient-to-br from-[var(--bg-soft)] to-[var(--card-elevated)] border border-[var(--border)]/90 p-3 space-y-2">
                    <div className="flex items-center justify-between text-[10px] text-[var(--muted)]">
                      <span>Offre ¬∑ Ing√©nieur cybers√©curit√©</span>
                      <span>
                        Match profil :{" "}
                        <span className="text-emerald-300 font-semibold">92%</span>
                      </span>
                    </div>
                    <div className="h-1.5 w-full rounded-full bg-[var(--bg-soft)] overflow-hidden">
                      <div className="h-full w-[92%] bg-gradient-to-r from-emerald-400 to-[var(--brand)]" />
                    </div>
                    <div className="flex flex-wrap gap-2 text-[10px]">
                      <span className="px-2 py-1 rounded-full bg-emerald-400/10 text-emerald-200 border border-emerald-400/40">
                        LM g√©n√©r√©e
                      </span>
                      <span className="px-2 py-1 rounded-full bg-[var(--brand)]/10 text-[var(--brand)] border border-[var(--brand)]/40">
                        Pitch pr√™t
                      </span>
                      <span className="px-2 py-1 rounded-full bg-[var(--bg-soft)] text-[var(--muted)] border border-[var(--border)]/70">
                        Suivi : En cours
                      </span>
                    </div>
                  </div>
                </div>

                <div className="pointer-events-none absolute -inset-10 -z-10 bg-[radial-gradient(circle_at_top,_rgba(88,166,255,0.35),_transparent_60%),radial-gradient(circle_at_bottom,_rgba(16,185,129,0.2),_transparent_55%)] opacity-80" />
              </motion.div>
            </div>
          </section>

          {/* FEATURES */}
          <section
            id="features"
            className="md:snap-start md:min-h-[calc(100vh-3.5rem-2px)] flex items-center px-4 sm:px-8 py-10 md:py-0"
          >
            <div className="max-w-6xl mx-auto w-full">
              <motion.div
                {...fadeUp(0)}
                className="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-3 mb-6"
              >
                <div>
                  <p className="text-[11px] uppercase tracking-[0.22em] text-[var(--muted)] mb-1">
                    Pens√© pour ton quotidien
                  </p>
                  <h2 className="text-lg sm:text-xl font-semibold">
                    Tout ce dont tu as besoin pour candidater au calme.
                  </h2>
                </div>
              </motion.div>

              <div className="grid gap-4 md:grid-cols-3">
                {[
                  {
                    title: "CV IA optimis√©",
                    desc: "Importe ton CV PDF, l‚ÄôIA extrait ton profil et te propose une version claire et impactante pour les recruteurs.",
                  },
                  {
                    title: "Lettres cibl√©es",
                    desc: "Colle une offre d‚Äôemploi, l‚Äôassistant adapte ta lettre √† l‚Äôentreprise, au poste et √† ton parcours.",
                  },
                  {
                    title: "Pitch d‚Äôentretien",
                    desc: "G√©n√®re un pitch oral structur√© pour te pr√©senter en 30 √† 90 secondes en entretien ou en r√©seautage.",
                  },
                  {
                    title: "Tracker de candidatures",
                    desc: "Garde la main sur tout : qui t‚Äôa r√©pondu, o√π tu en es, quelles relances tu dois faire.",
                  },
                  {
                    title: "Historique IA",
                    desc: "Retrouve facilement tes lettres, tes pitchs et les versions de ton CV, sans te perdre dans les dossiers.",
                  },
                  {
                    title: "Cr√©dits flexibles",
                    desc: "Des packs adapt√©s √† ton rythme : quelques candidatures cibl√©es ou une vraie campagne d‚Äôattaque.",
                  },
                ].map((f, i) => (
                  <motion.div
                    key={f.title}
                    {...fadeUp(0.05 * i)}
                    className="glass p-4 border border-[var(--border)]/80 hover:border-[var(--brand)]/60 transition-colors"
                  >
                    <h3 className="text-sm font-semibold mb-1">{f.title}</h3>
                    <p className="text-[11px] sm:text-xs text-[var(--muted)]">{f.desc}</p>
                  </motion.div>
                ))}
              </div>
            </div>
          </section>

          {/* HOW */}
          <section
            id="how"
            className="md:snap-start md:min-h-[calc(100vh-3.5rem-2px)] flex items-center px-4 sm:px-8 py-10 md:py-0"
          >
            <div className="max-w-6xl mx-auto grid gap-6 md:grid-cols-[1.1fr,0.9fr] items-start">
              <motion.div {...fadeUp(0)}>
                <p className="text-[11px] uppercase tracking-[0.22em] text-[var(--muted)] mb-1">
                  En pratique
                </p>
                <h2 className="text-lg sm:text-xl font-semibold mb-3">
                  3 √©tapes pour transformer ton process de candidature.
                </h2>
                <p className="text-sm text-[var(--muted)] max-w-xl mb-4">
                  L‚Äôobjectif : que tu passes moins de temps √† lutter avec tes lettres, et plus de temps √† pr√©parer tes entretiens.
                </p>

                <ol className="space-y-3 text-sm">
                  <li className="flex gap-3">
                    <span className="mt-0.5 h-6 w-6 rounded-full bg-[var(--brand)]/15 border border-[var(--brand)]/60 text-[10px] flex items-center justify-center">
                      1
                    </span>
                    <div>
                      <p className="font-medium mb-1">Tu importes ton CV & les offres</p>
                      <p className="text-[12px] text-[var(--muted)]">
                        PDF de ton CV, lien d‚Äôoffre ou texte copi√©/coll√© : tout part de ton vrai parcours.
                      </p>
                    </div>
                  </li>
                  <li className="flex gap-3">
                    <span className="mt-0.5 h-6 w-6 rounded-full bg-[var(--brand)]/15 border border-[var(--brand)]/60 text-[10px] flex items-center justify-center">
                      2
                    </span>
                    <div>
                      <p className="font-medium mb-1">L‚ÄôIA g√©n√®re lettres, pitchs & matchs</p>
                      <p className="text-[12px] text-[var(--muted)]">
                        Tu valides, ajustes, c‚Äôest toi qui garde le contr√¥le du ton et des infos.
                      </p>
                    </div>
                  </li>
                  <li className="flex gap-3">
                    <span className="mt-0.5 h-6 w-6 rounded-full bg-[var(--brand)]/15 border border-[var(--brand)]/60 text-[10px] flex items-center justify-center">
                      3
                    </span>
                    <div>
                      <p className="font-medium mb-1">Tu suis tout depuis le dashboard</p>
                      <p className="text-[12px] text-[var(--muted)]">
                        Tableau de bord, statut des candidatures, relances, historique : tout est centralis√©.
                      </p>
                    </div>
                  </li>
                </ol>
              </motion.div>

              <motion.div {...fadeUp(0.1)} className="glass p-4 border border-[var(--border)]/80">
                <p className="text-[11px] uppercase tracking-[0.18em] text-[var(--muted)] mb-2">
                  Pour qui ?
                </p>
                <ul className="space-y-2 text-[12px] text-[var(--muted)]">
                  <li>‚Ä¢ √âtudiants & juniors qui veulent des candidatures propres sans y passer leurs nuits.</li>
                  <li>‚Ä¢ Profils tech / cybers√©curit√© qui veulent aller droit au but avec un ton pro.</li>
                  <li>‚Ä¢ Pros en reconversion ou en veille qui envoient plusieurs candidatures par semaine.</li>
                </ul>
                <div className="mt-4 border-t border-[var(--border)]/70 pt-3 text-[11px]">
                  <p className="text-[var(--muted)] mb-1">Tu n‚Äôes pas oblig√© de tout automatiser.</p>
                  <p>
                    Utilise l‚ÄôIA comme un acc√©l√©rateur : tu gardes le contr√¥le, l‚Äôassistant fait le gros du texte.
                  </p>
                </div>
              </motion.div>
            </div>
          </section>

          {/* PRICING */}
          <section
            id="pricing"
            className="md:snap-start md:min-h-[calc(100vh-3.5rem-2px)] flex items-center px-4 sm:px-8 py-10 md:py-0"
          >
            <div className="max-w-6xl mx-auto w-full">
              <motion.div {...fadeUp(0)} className="text-center mb-8 max-w-2xl mx-auto">
                <p className="text-[11px] uppercase tracking-[0.22em] text-[var(--muted)] mb-1">Tarifs</p>
                <h2 className="text-lg sm:text-xl font-semibold mb-2">Des cr√©dits simples, adapt√©s √† ton rythme.</h2>
                <p className="text-sm text-[var(--muted)]">
                  Commence avec les cr√©dits gratuits. Tu ne paies que si l‚Äôoutil t‚Äôaide vraiment.
                </p>
              </motion.div>

              <div className="grid gap-4 md:grid-cols-3">
                <motion.div {...fadeUp(0.05)} className="glass p-4 border border-[var(--border)]/90">
                  <p className="text-[11px] uppercase tracking-[0.18em] text-[var(--muted)] mb-1">D√©couverte</p>
                  <h3 className="text-sm font-semibold mb-1">Gratuit ‚Ä¢ Pour tester</h3>
                  <p className="text-[12px] text-[var(--muted)] mb-3">Id√©al pour voir si le flow te convient.</p>
                  <p className="text-2xl font-semibold mb-3">0 ‚Ç¨</p>
                  <ul className="text-[11px] text-[var(--muted)] space-y-1.5 mb-4">
                    <li>‚Ä¢ X cr√©dits offerts √† l‚Äôinscription</li>
                    <li>‚Ä¢ 2 lettres de motivation IA</li>
                    <li>‚Ä¢ 1 pitch d‚Äôentretien</li>
                    <li>‚Ä¢ Acc√®s au tracker de candidatures</li>
                  </ul>
                  <Link href="/signup" className="btn-secondary w-full text-center text-xs">
                    Commencer gratuitement
                  </Link>
                </motion.div>

                <motion.div
                  {...fadeUp(0.1)}
                  className="glass p-4 border border-[var(--brand)]/80 relative overflow-hidden"
                >
                  <div className="absolute inset-0 bg-[radial-gradient(circle_at_top,_rgba(88,166,255,0.12),_transparent_55%)] pointer-events-none" />
                  <div className="relative">
                    <p className="text-[11px] uppercase tracking-[0.18em] text-[var(--muted)] mb-1">Plus populaire</p>
                    <h3 className="text-sm font-semibold mb-1">Campagne cibl√©e</h3>
                    <p className="text-[12px] text-[var(--muted)] mb-3">Pour une vraie recherche active de poste.</p>
                    <p className="text-2xl font-semibold mb-3">
                      19 ‚Ç¨ <span className="text-[11px] text-[var(--muted)]">/ une fois</span>
                    </p>
                    <ul className="text-[11px] text-[var(--muted)] space-y-1.5 mb-4">
                      <li>‚Ä¢ Cr√©dits pour ~25 lettres</li>
                      <li>‚Ä¢ Pitchs illimit√©s pour les offres g√©n√©r√©es</li>
                      <li>‚Ä¢ Suivi avanc√© des candidatures</li>
                      <li>‚Ä¢ Priorit√© sur les am√©liorations de templates</li>
                    </ul>
                    <Link href="/app/credits" className="btn-primary w-full text-center text-xs">
                      Acheter des cr√©dits
                    </Link>
                  </div>
                </motion.div>

                <motion.div {...fadeUp(0.15)} className="glass p-4 border border-[var(--border)]/90">
                  <p className="text-[11px] uppercase tracking-[0.18em] text-[var(--muted)] mb-1">Intensif</p>
                  <h3 className="text-sm font-semibold mb-1">Pro / reconversion</h3>
                  <p className="text-[12px] text-[var(--muted)] mb-3">Pour les p√©riodes de candidatures massives.</p>
                  <p className="text-2xl font-semibold mb-3">
                    39 ‚Ç¨ <span className="text-[11px] text-[var(--muted)]">/ une fois</span>
                  </p>
                  <ul className="text-[11px] text-[var(--muted)] space-y-1.5 mb-4">
                    <li>‚Ä¢ Cr√©dits pour ~60 lettres</li>
                    <li>‚Ä¢ Pitchs √©tendus + variantes</li>
                    <li>‚Ä¢ Support prioritaire</li>
                    <li>‚Ä¢ Id√©al pour changer de pays / secteur</li>
                  </ul>
                  <Link href="/app/credits" className="btn-secondary w-full text-center text-xs">
                    Voir ce pack plus tard
                  </Link>
                </motion.div>
              </div>
            </div>
          </section>

          {/* STACK */}
          <section
            id="stack"
            className="md:snap-start md:min-h-[calc(100vh-3.5rem-2px)] flex items-center px-4 sm:px-8 py-10 md:py-0"
          >
            <div className="max-w-6xl mx-auto grid gap-6 md:grid-cols-2">
              <motion.div {...fadeUp(0)}>
                <p className="text-[11px] uppercase tracking-[0.22em] text-[var(--muted)] mb-1">Sous le capot</p>
                <h2 className="text-lg sm:text-xl font-semibold mb-2">
                  Une stack moderne, optimis√©e pour la vitesse.
                </h2>
                <p className="text-sm text-[var(--muted)] mb-3">
                  Tu profites d‚Äôune interface fluide, sans te soucier de la technique. Mais si √ßa t‚Äôint√©resse :
                </p>
                <ul className="text-[12px] text-[var(--muted)] space-y-1.5">
                  <li>
                    ‚Ä¢ <span className="text-[var(--ink)] font-medium">Next.js</span> pour le frontend & le routing.
                  </li>
                  <li>
                    ‚Ä¢ <span className="text-[var(--ink)] font-medium">Tailwind CSS</span> pour le design dark moderne.
                  </li>
                  <li>
                    ‚Ä¢ <span className="text-[var(--ink)] font-medium">Framer Motion</span> pour les animations fluides.
                  </li>
                  <li>
                    ‚Ä¢ <span className="text-[var(--ink)] font-medium">Firebase</span> pour l‚Äôauth s√©curis√©e & le stockage.
                  </li>
                  <li>
                    ‚Ä¢ <span className="text-[var(--ink)] font-medium">Gemini</span> pour l‚Äôanalyse de CV & la g√©n√©ration IA.
                  </li>
                </ul>
              </motion.div>

              <motion.div {...fadeUp(0.1)} className="glass p-4 border border-[var(--border)]/80 text-[11px] sm:text-xs">
                <p className="text-[11px] uppercase tracking-[0.18em] text-[var(--muted)] mb-2">
                  Pourquoi c&apos;est important pour toi ?
                </p>
                <p className="text-[var(--muted)] mb-2">
                  Parce que √ßa veut dire : moins de chargements lents, moins de bugs bizarres, et une interface qui r√©agit comme un vrai outil pro.
                </p>
                <p className="text-[var(--muted)]">
                  Et si tu es curieux¬∑se c√¥t√© dev, la structure du projet est pens√©e pour √™tre lisible, extensible, et d√©ployable facilement sur Firebase Hosting.
                </p>
              </motion.div>
            </div>
          </section>

          {/* FAQ */}
          <section
            id="faq"
            className="md:snap-start md:min-h-[calc(100vh-3.5rem-2px)] flex items-center px-4 sm:px-8 pb-12 pt-10 md:py-0"
          >
            <div className="max-w-4xl mx-auto w-full">
              <motion.div {...fadeUp(0)} className="text-center mb-6">
                <p className="text-[11px] uppercase tracking-[0.22em] text-[var(--muted)] mb-1">Questions fr√©quentes</p>
                <h2 className="text-lg sm:text-xl font-semibold mb-2">Et si tu te poses encore la question‚Ä¶</h2>
              </motion.div>

              <div className="space-y-3 text-sm">
                <motion.div {...fadeUp(0.05)} className="glass p-3 border border-[var(--border)]/80">
                  <p className="font-medium mb-1">Est-ce que les textes sont vraiment uniques ?</p>
                  <p className="text-[12px] text-[var(--muted)]">
                    Oui, chaque g√©n√©ration est bas√©e sur ton CV, l‚Äôoffre coll√©e et les param√®tres que tu choisis.
                  </p>
                </motion.div>

                <motion.div {...fadeUp(0.1)} className="glass p-3 border border-[var(--border)]/80">
                  <p className="font-medium mb-1">Est-ce que l‚Äôoutil remplace compl√®tement mon travail ?</p>
                  <p className="text-[12px] text-[var(--muted)]">
                    Non. L‚Äôid√©e est de te donner une base solide (0‚Üí80%), puis tu ajustes les derniers 20%.
                  </p>
                </motion.div>

                <motion.div {...fadeUp(0.15)} className="glass p-3 border border-[var(--border)]/80">
                  <p className="font-medium mb-1">Je peux arr√™ter quand je veux ?</p>
                  <p className="text-[12px] text-[var(--muted)]">
                    Oui, les cr√©dits ne t&apos;engagent pas dans un abonnement. Tu recharges uniquement quand tu en as besoin.
                  </p>
                </motion.div>
              </div>

              <motion.div {...fadeUp(0.2)} className="mt-8 glass p-5 border border-[var(--border)]/90 text-center">
                <p className="text-[11px] uppercase tracking-[0.22em] text-[var(--muted)] mb-2">Pr√™t √† tester ?</p>
                <h3 className="text-base sm:text-lg font-semibold mb-2">
                  Tu peux cr√©er ton compte en 30 secondes et tester avec de vrais cas.
                </h3>
                <p className="text-[12px] text-[var(--muted)] mb-4">
                  Tu gardes la main sur tout, l‚ÄôIA est l√† pour acc√©l√©rer ton travail, pas pour te remplacer.
                </p>
                <div className="flex flex-wrap gap-3 justify-center">
                  <Link href="/signup" className="btn-primary text-xs sm:text-sm">
                    Essayer gratuitement
                  </Link>

                  <button
                    type="button"
                    onClick={handleSmartLoginClick}
                    disabled={navigating}
                    className="btn-secondary text-xs sm:text-sm disabled:opacity-50"
                  >
                    J&apos;ai d√©j√† un compte
                  </button>
                </div>
              </motion.div>
            </div>
          </section>
        </main>
      </div>
    </div>
  );
}
````

## File: components/InterviewChat.tsx
````typescript
// components/InterviewChat.tsx
"use client";

import { useState, useEffect, useRef } from "react";
import { useAuth } from "@/context/AuthContext";

// ‚úÖ AJOUT reCAPTCHA
import { tryGetRecaptchaToken } from "@/lib/recaptcha";

type Message = {
  role: "interviewer" | "candidate" | "system";
  text: string;
};

type InterviewMode = "complet" | "rapide" | "technique" | "comportemental";
type Difficulty = "facile" | "standard" | "difficile";
type VoiceProfileId = "femme" | "homme";
type RecruiterGender = "f" | "m";

const INTERVIEW_QUESTION_PLAN: Record<InterviewMode, number> = {
  complet: 8,
  rapide: 4,
  technique: 6,
  comportemental: 6,
};

const VOICE_PROFILES: Record<
  VoiceProfileId,
  { label: string; pitch: number; rate: number }
> = {
  femme: {
    label: "Voix f√©minine",
    pitch: 1.1,
    rate: 1.0,
  },
  homme: {
    label: "Voix masculine",
    pitch: 0.9,
    rate: 0.98,
  },
};

const AVG_MIN_PER_QUESTION = 1.5;

// ‚úÖ reCAPTCHA action unique attendue c√¥t√© serveur (Cloud Function + /api/interview)
const RECAPTCHA_ACTION = "interview";

// --- Helper : r√©cup nom c√¥t√© client (Firebase Auth) ---
const getCandidateNameFromAuth = (user: any): string | null => {
  if (!user) return null;
  const possible =
    user.displayName ||
    user.fullName ||
    user.name ||
    user.email?.split("@")[0] ||
    "";
  const trimmed = (possible || "").toString().trim();
  return trimmed || null;
};

// --- Helper : nettoie & personnalise les questions contenant [Nom du candidat...] ---
const personalizeQuestionClient = (
  raw: string | null | undefined,
  user: any
): string => {
  if (!raw) return "";
  let q = raw;

  const safeName = getCandidateNameFromAuth(user) || "";
  const firstName = safeName.split(" ")[0] || safeName;

  if (safeName) {
    q = q.replace(/\[Nom du candidat[^\]]*\]/gi, safeName);
    q = q.replace(/\[Pr√©nom du candidat[^\]]*\]/gi, firstName);
    q = q.replace(/\[Name of the candidate[^\]]*\]/gi, safeName);
    q = q.replace(/\[First name of the candidate[^\]]*\]/gi, firstName);
  } else {
    q = q.replace(/\[Nom du candidat[^\]]*\]/gi, "");
    q = q.replace(/\[Pr√©nom du candidat[^\]]*\]/gi, "");
    q = q.replace(/\[Name of the candidate[^\]]*\]/gi, "");
    q = q.replace(/\[First name of the candidate[^\]]*\]/gi, "");
  }

  q = q.replace(/\s+,/g, ",");
  q = q.replace(/\s{2,}/g, " ").trim();
  q = q.replace(/^,\s*/, "");
  q = q.replace(/^Bonjour\s*,/i, "Bonjour,");
  q = q.replace(/^Bonjour\s+$/, "Bonjour,");

  return q.trim();
};

export default function InterviewChat() {
  const { user } = useAuth();

  const [sessionId, setSessionId] = useState<string | null>(null);
  const [history, setHistory] = useState<Message[]>([]);
  const [input, setInput] = useState("");
  const [loading, setLoading] = useState(false);

  const [started, setStarted] = useState(false);
  const [finished, setFinished] = useState(false);

  const [jobTitle, setJobTitle] = useState("");
  const [jobDesc, setJobDesc] = useState("");
  const [interviewMode, setInterviewMode] =
    useState<InterviewMode>("complet");
  const [difficulty, setDifficulty] = useState<Difficulty>("standard");

  const [voiceProfile, setVoiceProfile] =
    useState<VoiceProfileId>("femme");
  const [recruiterGender, setRecruiterGender] =
    useState<RecruiterGender>("f");

  const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);
  const [totalQuestions, setTotalQuestions] = useState(
    INTERVIEW_QUESTION_PLAN["complet"]
  );

  const [listening, setListening] = useState(false);
  const recognitionRef = useRef<any>(null);
  const [speechSupported, setSpeechSupported] = useState(false);
  const [recognitionSupported, setRecognitionSupported] =
    useState(false);
  const [aiSpeaking, setAiSpeaking] = useState(false);

  const [finalSummary, setFinalSummary] = useState<string | null>(null);
  const [finalScore, setFinalScore] = useState<number | null>(null);
  const [finalDecision, setFinalDecision] = useState<string | null>(null);

  const [typing, setTyping] = useState(false);
  const [typingIndex, setTypingIndex] = useState(0);

  const chatRef = useRef<HTMLDivElement | null>(null);

  // ‚úÖ Helper fetch /api/interview + reCAPTCHA
  const postInterview = async (payload: any) => {
    const recaptchaToken = await tryGetRecaptchaToken(RECAPTCHA_ACTION).catch(
      () => null
    );

    const headers: Record<string, string> = {
      "Content-Type": "application/json",
    };
    if (recaptchaToken) headers["X-Recaptcha-Token"] = recaptchaToken;

    const body = {
      ...payload,
      recaptchaToken: recaptchaToken || undefined,
      recaptchaAction: RECAPTCHA_ACTION,
    };

    const res = await fetch("/api/interview", {
      method: "POST",
      headers,
      body: JSON.stringify(body),
    });

    const contentType = res.headers.get("content-type") || "";
    const data = contentType.includes("application/json")
      ? await res.json().catch(() => null)
      : await res.text().catch(() => "");

    if (!res.ok) {
      const errMsg =
        typeof data === "object" && data
          ? data.error ||
            `HTTP ${res.status}` +
              (data.details ? ` ‚Äî ${JSON.stringify(data.details)}` : "")
          : typeof data === "string"
          ? data || `HTTP ${res.status}`
          : `HTTP ${res.status}`;

      throw new Error(errMsg);
    }

    return data;
  };

  // --- INIT VOIX (TTS) ---
  useEffect(() => {
    if (typeof window === "undefined") return;
    if ("speechSynthesis" in window) {
      setSpeechSupported(true);
    } else {
      setSpeechSupported(false);
    }
  }, []);

  // --- AUTO-SCROLL DU CHAT ---
  useEffect(() => {
    const el = chatRef.current;
    if (!el) return;
    el.scrollTop = el.scrollHeight;
  }, [history, loading]);

  const lastInterviewerIndex =
    history.length > 0
      ? [...history]
          .map((m, i) => ({ m, i }))
          .reverse()
          .find(({ m }) => m.role === "interviewer")?.i ?? -1
      : -1;

  const lastInterviewerMessage =
    lastInterviewerIndex >= 0
      ? history[lastInterviewerIndex]?.text || ""
      : "";

  // --- TYPEWRITER ---
  useEffect(() => {
    if (!typing) return;
    if (lastInterviewerIndex === -1) return;
    const msg = history[lastInterviewerIndex];
    if (!msg) return;

    if (typingIndex >= msg.text.length) {
      setTyping(false);
      return;
    }

    const interval = setInterval(() => {
      setTypingIndex((prev) => prev + 2);
    }, 15);

    return () => clearInterval(interval);
  }, [typing, typingIndex, history, lastInterviewerIndex]);

  // --- BEEP MIC ---
  const playMicBeep = () => {
    try {
      const W = window as any;
      const AudioContext =
        W.AudioContext || W.webkitAudioContext;
      if (!AudioContext) return;
      const ctx = new AudioContext();
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.type = "sine";
      osc.frequency.value = 1000;
      gain.gain.value = 0.06;
      osc.connect(gain);
      gain.connect(ctx.destination);
      osc.start();
      setTimeout(() => {
        osc.stop();
        ctx.close();
      }, 120);
    } catch (e) {
      console.warn("Impossible de jouer le beep micro", e);
    }
  };

  // --- PARLER (TTS) ---
  const speak = (text: string) => {
    if (typeof window === "undefined") return;
    const toSpeak = (text || "").trim();
    if (!toSpeak) return;
    if (!("speechSynthesis" in window)) {
      console.warn("speechSynthesis non support√©");
      return;
    }

    try {
      const utterance = new SpeechSynthesisUtterance(toSpeak);
      utterance.lang = "fr-FR";

      const profile = VOICE_PROFILES[voiceProfile];
      if (profile) {
        utterance.pitch = profile.pitch;
        utterance.rate = profile.rate;
      }

      utterance.onstart = () => setAiSpeaking(true);
      utterance.onend = () => setAiSpeaking(false);
      utterance.onerror = (e) => {
        console.error("Erreur TTS:", e);
        setAiSpeaking(false);
      };

      try {
        window.speechSynthesis.cancel();
      } catch {
        // ignore
      }
      window.speechSynthesis.speak(utterance);
    } catch (e) {
      console.error("Erreur synth√®se vocale:", e);
      setAiSpeaking(false);
    }
  };

  // --- PARSE payload backend ---
  const parseInterviewPayload = (raw: any): {
    nextQuestion: string | null;
    shortAnalysis: string | null;
    finalSummary: string | null;
    finalScore: number | null;
  } => {
    let obj: any = raw;

    const tryParseString = (txt: string | null | undefined): any => {
      if (!txt) return null;
      let inner = txt.trim();

      if (inner.startsWith("```")) {
        inner = inner
          .replace(/^```[a-zA-Z]*\s*\n?/, "")
          .replace(/```$/, "")
          .trim();
      }

      try {
        const parsed = JSON.parse(inner);
        return parsed;
      } catch {
        const result: any = {};

        const extractField = (field: string, source: string): string | null => {
          const doubleQuote =
            source.match(
              new RegExp(`"${field}"\\s*:\\s*"([^"]*)"`, "s")
            ) ||
            source.match(
              new RegExp(`"${field}"\\s*:\\s*\\"([^"]*)\\"`, "s")
            );
          const singleQuote = source.match(
            new RegExp(`'${field}'\\s*:\\s*'([^']*)'`, "s")
          );
          const m = doubleQuote || singleQuote;
          if (!m) return null;
          return m[1].replace(/\\"/g, '"');
        };

        const nextQ =
          extractField("next_question", inner) ??
          extractField("nextQuestion", inner);
        const shortA =
          extractField("short_analysis", inner) ??
          extractField("shortAnalysis", inner);
        const finalSum =
          extractField("final_summary", inner) ??
          extractField("finalSummary", inner);
        const finalScoreStr =
          extractField("final_score", inner) ??
          extractField("finalScore", inner);

        if (nextQ) result.next_question = nextQ;
        if (shortA) result.short_analysis = shortA;
        if (finalSum) result.final_summary = finalSum;
        if (finalScoreStr) {
          const num = parseFloat(finalScoreStr);
          if (!Number.isNaN(num)) result.final_score = num;
        }

        if (Object.keys(result).length > 0) return result;
        return { next_question: inner };
      }
    };

    if (typeof obj === "string") obj = tryParseString(obj);

    if (obj && typeof obj === "object") {
      if (typeof obj.nextQuestion === "string" && obj.nextQuestion.trim().startsWith("```")) {
        const nested = tryParseString(obj.nextQuestion);
        if (nested && typeof nested === "object") {
          const q = (nested as any).next_question ?? (nested as any).nextQuestion ?? null;
          obj = { ...obj, ...nested, next_question: q ?? obj.next_question, nextQuestion: q ?? obj.nextQuestion };
        }
      }
      if (typeof obj.next_question === "string" && obj.next_question.trim().startsWith("```")) {
        const nested = tryParseString(obj.next_question);
        if (nested && typeof nested === "object") {
          const q = (nested as any).next_question ?? (nested as any).nextQuestion ?? null;
          obj = { ...obj, ...nested, next_question: q ?? obj.next_question, nextQuestion: q ?? obj.nextQuestion };
        }
      }
    }

    const nextQuestionRaw =
      obj?.next_question || obj?.nextQuestion || obj?.question || null;
    const shortAnalysis = obj?.short_analysis || obj?.shortAnalysis || null;
    const finalSummary = obj?.final_summary || obj?.finalSummary || null;
    const finalScoreRaw = obj?.final_score ?? obj?.finalScore ?? null;

    const nextQuestionText =
      typeof nextQuestionRaw === "string" ? nextQuestionRaw.trim() : null;

    let cleanNextQuestion = nextQuestionText;
    if (cleanNextQuestion) {
      cleanNextQuestion = cleanNextQuestion
        .replace(/```[a-zA-Z]*\s*\n?[\s\S]*?```/g, "")
        .trim();
    }

    const scoreNum =
      typeof finalScoreRaw === "number"
        ? finalScoreRaw
        : typeof finalScoreRaw === "string"
        ? parseFloat(finalScoreRaw)
        : null;

    return {
      nextQuestion: cleanNextQuestion,
      shortAnalysis: typeof shortAnalysis === "string" ? shortAnalysis.trim() : null,
      finalSummary: typeof finalSummary === "string" ? finalSummary.trim() : null,
      finalScore: Number.isNaN(scoreNum) ? null : scoreNum,
    };
  };

  // --- START ---
  const startInterview = async () => {
    if (!user) {
      alert("Connecte-toi d'abord pour lancer la simulation.");
      return;
    }

    try {
      if (typeof window !== "undefined" && "speechSynthesis" in window) {
        const silent = new SpeechSynthesisUtterance(" ");
        silent.volume = 0;
        silent.rate = 1;
        silent.pitch = 1;
        window.speechSynthesis.speak(silent);
      }
    } catch (e) {
      console.warn("Impossible de d√©bloquer TTS", e);
    }

    setLoading(true);
    setHistory([]);
    setFinished(false);
    setFinalSummary(null);
    setFinalScore(null);
    setFinalDecision(null);
    setCurrentQuestionIndex(0);
    setTotalQuestions(INTERVIEW_QUESTION_PLAN[interviewMode]);

    try {
      // ‚úÖ utilise postInterview (avec reCAPTCHA)
      const data = await postInterview({
        action: "start",
        userId: user.uid,
        jobTitle,
        jobDesc,
        interviewMode,
        difficulty,
        channel: "oral",
      });

      const rawFirst =
        (data as any)?.firstQuestion ||
        (data as any)?.first_question ||
        (data as any)?.nextQuestion ||
        (data as any)?.next_question ||
        data;

      const { nextQuestion, shortAnalysis, finalSummary, finalScore } =
        parseInterviewPayload(rawFirst);

      const firstQ = personalizeQuestionClient(
        nextQuestion ||
          "Bonjour ! Pour commencer, pouvez-vous vous pr√©senter en quelques phrases ?",
        user
      );

      setSessionId((data as any)?.sessionId || (data as any)?.session_id || null);
      setStarted(true);
      setCurrentQuestionIndex(1);

      const newHistory: Message[] = [{ role: "interviewer", text: firstQ }];

      if (shortAnalysis) {
        newHistory.push({
          role: "system",
          text: `üí≠ Ce que pense le recruteur : ${shortAnalysis}`,
        });
      }

      setHistory(newHistory);

      if (finalSummary) {
        setFinalSummary(finalSummary);
        if (finalScore !== null) setFinalScore(finalScore);
        setFinished(true);
      }

      setTypingIndex(0);
      setTyping(true);
      speak(firstQ);
    } catch (e: any) {
      console.error(e);
      alert(e?.message || "Erreur lors du d√©marrage de la simulation.");
      setStarted(false);
      setSessionId(null);
    } finally {
      setLoading(false);
    }
  };

  // --- R√âPONDRE ---
  const sendAnswer = async (text: string) => {
    const answer = text.trim();
    if (!answer) return;

    if (!started || !sessionId) {
      console.warn("R√©ponse ignor√©e : entretien non d√©marr√© ou sessionId manquant.");
      return;
    }

    setHistory((prev) => [...prev, { role: "candidate", text: answer } as Message]);
    setInput("");
    setLoading(true);

    try {
      // ‚úÖ utilise postInterview (avec reCAPTCHA)
      const data = await postInterview({
        action: "answer",
        userId: user?.uid,
        sessionId,
        userMessage: answer,
        interviewMode,
        difficulty,
      });

      const payload = (() => {
        if (
          (data as any)?.nextQuestion ||
          (data as any)?.next_question ||
          (data as any)?.final_summary ||
          (data as any)?.finalSummary
        ) {
          return parseInterviewPayload(data);
        }
        if ((data as any)?.payload) return parseInterviewPayload((data as any).payload);
        if (typeof data === "string") return parseInterviewPayload(data);
        return parseInterviewPayload(data);
      })();

      const { nextQuestion, shortAnalysis, finalSummary, finalScore } = payload;

      const nextQClean = nextQuestion
        ? personalizeQuestionClient(nextQuestion, user)
        : null;

      setHistory((prev) => {
        const newHistory = [...prev];

        if (shortAnalysis) {
          newHistory.push({
            role: "system",
            text: `üí≠ Ce que pense le recruteur : ${shortAnalysis}`,
          });
        }

        if (nextQClean && !finalSummary) {
          newHistory.push({ role: "interviewer", text: nextQClean });
        }

        return newHistory;
      });

      if (finalSummary || typeof finalScore === "number") {
        if (finalSummary) setFinalSummary(finalSummary);
        if (typeof finalScore === "number") setFinalScore(finalScore);

        if (typeof finalScore === "number") {
          let decision: string;
          if (finalScore >= 80) {
            decision =
              "Tr√®s bon entretien : tu aurais de fortes chances d'√™tre retenu(e) pour le poste. üéâ";
          } else if (finalScore >= 60) {
            decision =
              "Entretien correct : tu pourrais passer √† l'√©tape suivante, mais il y a encore des axes d'am√©lioration.";
          } else {
            decision =
              "Entretien en dessous des attentes : il faudrait retravailler certains points cl√©s avant de postuler.";
          }
          setFinalDecision(decision);
        }

        setFinished(true);
      }

      if (nextQClean && !finalSummary) {
        setCurrentQuestionIndex((prev) => Math.min(prev + 1, totalQuestions));
        setTypingIndex(0);
        setTyping(true);
        speak(nextQClean);
      }
    } catch (e: any) {
      console.error(e);
      alert(e?.message || "Erreur lors de l'envoi de ta r√©ponse.");
    } finally {
      setLoading(false);
    }
  };

  // --- INIT RECONNAISSANCE VOCALE ---
  useEffect(() => {
    if (typeof window === "undefined") return;

    const w = window as any;
    const SpeechRecognition = w.SpeechRecognition || w.webkitSpeechRecognition;

    if (!SpeechRecognition) {
      setRecognitionSupported(false);
      recognitionRef.current = null;
      return;
    }

    setRecognitionSupported(true);

    const recognition = new SpeechRecognition();
    recognition.lang = "fr-FR";
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;

    recognition.onresult = (event: any) => {
      const text = event.results[0][0].transcript;
      if (text) {
        sendAnswer(text);
      }
    };
    recognition.onend = () => {
      setListening(false);
    };
    recognition.onerror = (e: any) => {
      console.error("Speech recognition error:", e);
      setListening(false);
    };

    recognitionRef.current = recognition;

    return () => {
      try {
        recognition.stop();
      } catch {
        // ignore
      }
    };
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [started, sessionId]);

  const toggleMic = () => {
    if (!started) {
      alert("Lance d'abord la simulation avant d'utiliser le micro.");
      return;
    }

    if (!recognitionRef.current) {
      alert(
        "La reconnaissance vocale n'est pas disponible sur ce navigateur / appareil (par exemple iOS Safari). Tu peux toujours r√©pondre au clavier."
      );
      return;
    }

    if (listening) {
      try {
        recognitionRef.current.stop();
      } catch (e) {
        console.error(e);
      }
    } else {
      setListening(true);
      playMicBeep();
      try {
        recognitionRef.current.start();
      } catch (e) {
        console.error(e);
        setListening(false);
      }
    }
  };

  const stopSession = () => {
    try {
      if (typeof window !== "undefined" && "speechSynthesis" in window) {
        window.speechSynthesis.cancel();
      }
    } catch {
      // ignore
    }
    if (recognitionRef.current && listening) {
      try {
        recognitionRef.current.stop();
      } catch {
        // ignore
      }
    }
    setStarted(false);
    setSessionId(null);
    setHistory([]);
    setListening(false);
    setFinished(false);
    setFinalSummary(null);
    setFinalScore(null);
    setFinalDecision(null);
    setCurrentQuestionIndex(0);
    setTyping(false);
    setTypingIndex(0);
  };

  const progressPercent =
    totalQuestions > 0
      ? Math.min((currentQuestionIndex / totalQuestions) * 100, 100)
      : 0;

  const showConfig = !started || finished;
  const showInterviewPanel = started || finished;

  const stepVisual = !started ? 1 : finished || finalSummary || finalScore !== null ? 3 : 2;

  const questionsLeft = Math.max(totalQuestions - currentQuestionIndex, 0);
  const estimatedMinutesLeft = questionsLeft * AVG_MIN_PER_QUESTION;
  const estimatedMinutesRounded = questionsLeft > 0 ? Math.max(1, Math.round(estimatedMinutesLeft)) : 0;

  return (
    <section className="glass rounded-2xl p-5 space-y-4">
      {/* Titre + intro */}
      <div className="space-y-1">
        <h2 className="text-lg font-semibold">
          Simulateur d&apos;entretien IA (mode vocal)
        </h2>
        <p className="text-[11px] text-[var(--muted)] max-w-2xl">
          L&apos;IA joue le r√¥le du recruteur : elle te pose des questions adapt√©es au poste et √† ton profil √† l&apos;oral,
          tu r√©ponds √† l&apos;oral ou √† l&apos;√©crit, et elle lit ensuite ses messages √† voix haute.
        </p>
      </div>

      <div className="space-y-4">
        {/* STEPPER 1/2/3 */}
        <div className="flex flex-wrap items-center gap-3 text-xs">
          {[
            { id: 1, label: "Configuration" },
            { id: 2, label: "Entretien" },
            { id: 3, label: "Bilan" },
          ].map((step) => (
            <div key={step.id} className="flex items-center gap-1">
              <div
                className={`h-5 w-5 rounded-full flex items-center justify-center text-[11px] ${
                  stepVisual === step.id
                    ? "bg-emerald-500 text-black"
                    : stepVisual > step.id
                    ? "bg-emerald-900/60 text-emerald-200"
                    : "bg-white/5 text-[var(--muted)]"
                }`}
              >
                {step.id}
              </div>
              <span className={stepVisual === step.id ? "text-emerald-300" : "text-[var(--muted)]"}>
                {step.label}
              </span>
            </div>
          ))}
        </div>

        {/* Bloc configuration */}
        {showConfig && (
          <div className="glass p-4 rounded-2xl border border-white/10 space-y-3">
            <p className="text-sm text-[var(--muted)]">
              Configure ton entretien, choisis le type de simulation et le profil du recruteur (voix + apparence),
              puis lance le mode vocal.
            </p>

            <div className="grid gap-3 md:grid-cols-2">
              <div className="space-y-2">
                <label className="block text-xs font-medium text-[var(--muted)]">
                  Poste vis√©
                </label>
                <input
                  className="w-full bg-black/20 border border-white/10 rounded-lg p-2 text-sm"
                  placeholder="Ex : D√©veloppeur WordPress, Charg√© de recrutement..."
                  value={jobTitle}
                  disabled={loading || started}
                  onChange={(e) => setJobTitle(e.target.value)}
                />

                <label className="block text-xs font-medium text-[var(--muted)] mt-2">
                  Descriptif de poste (facultatif)
                </label>
                <textarea
                  className="w-full bg-black/20 border border-white/10 rounded-lg p-2 text-xs min-h-[100px]"
                  placeholder="Colle ici l'annonce ou un extrait..."
                  value={jobDesc}
                  disabled={loading || started}
                  onChange={(e) => setJobDesc(e.target.value)}
                />
              </div>

              <div className="space-y-2">
                <div>
                  <label className="block text-xs font-medium text-[var(--muted)]">
                    Type d&apos;entretien
                  </label>
                  <select
                    className="w-full bg-black/20 border border-white/10 rounded-lg p-2 text-xs"
                    value={interviewMode}
                    disabled={loading || started}
                    onChange={(e) => setInterviewMode(e.target.value as InterviewMode)}
                  >
                    <option value="complet">Entretien complet (g√©n√©ral + motivation + comp√©tences)</option>
                    <option value="rapide">Flash 10 minutes (questions essentielles)</option>
                    <option value="technique">Focalis√© comp√©tences / technique</option>
                    <option value="comportemental">Comportemental (soft skills, situations)</option>
                  </select>
                </div>

                <div>
                  <label className="block text-xs font-medium text-[var(--muted)]">
                    Niveau de difficult√©
                  </label>
                  <select
                    className="w-full bg-black/20 border border-white/10 rounded-lg p-2 text-xs"
                    value={difficulty}
                    disabled={loading || started}
                    onChange={(e) => setDifficulty(e.target.value as Difficulty)}
                  >
                    <option value="facile">Facile / d√©butant</option>
                    <option value="standard">Standard</option>
                    <option value="difficile">Exigeant (questions pouss√©es)</option>
                  </select>
                </div>

                <div className="mt-1">
                  <label className="block text-xs font-medium text-[var(--muted)]">
                    Profil du recruteur (voix + apparence)
                  </label>
                  <div className="flex gap-2 mt-1">
                    <button
                      type="button"
                      disabled={loading || started}
                      onClick={() => {
                        setRecruiterGender("m");
                        setVoiceProfile("homme");
                      }}
                      className={`flex-1 text-xs rounded-lg border px-2 py-2 flex items-center justify-center gap-2 ${
                        recruiterGender === "m"
                          ? "border-emerald-400 bg-emerald-500/10"
                          : "border-white/10 bg-black/20"
                      }`}
                    >
                      <span className="text-lg">üë®‚Äçüíº</span>
                      <span className="text-left">
                        Recruteur homme
                        <br />
                        <span className="text-[10px] text-[var(--muted)]">Voix masculine</span>
                      </span>
                    </button>
                    <button
                      type="button"
                      disabled={loading || started}
                      onClick={() => {
                        setRecruiterGender("f");
                        setVoiceProfile("femme");
                      }}
                      className={`flex-1 text-xs rounded-lg border px-2 py-2 flex items-center justify-center gap-2 ${
                        recruiterGender === "f"
                          ? "border-emerald-400 bg-emerald-500/10"
                          : "border-white/10 bg-black/20"
                      }`}
                    >
                      <span className="text-lg">üë©‚Äçüíº</span>
                      <span className="text-left">
                        Recruteuse femme
                        <br />
                        <span className="text-[10px] text-[var(--muted)]">Voix f√©minine</span>
                      </span>
                    </button>
                  </div>
                </div>

                <p className="text-[10px] text-[var(--muted)] mt-1">
                  L&apos;entretien durera environ{" "}
                  <span className="font-semibold">{INTERVIEW_QUESTION_PLAN[interviewMode]} questions</span>.
                </p>

                {!recognitionSupported && (
                  <p className="text-[10px] text-[var(--muted)] mt-1">
                    ‚ö†Ô∏è La reconnaissance vocale n&apos;est pas disponible sur ce navigateur / appareil.
                  </p>
                )}

                {!speechSupported && (
                  <p className="text-[10px] text-[var(--muted)] mt-1">
                    ‚ö†Ô∏è La synth√®se vocale n&apos;est pas support√©e ici.
                  </p>
                )}
              </div>
            </div>

            <button
              onClick={startInterview}
              disabled={loading || !user}
              className="btn-primary w-full mt-2"
              type="button"
            >
              {loading ? "Pr√©paration de la simulation..." : "Lancer la simulation vocale üéôÔ∏è"}
            </button>

            {!user && (
              <p className="text-[10px] text-[var(--muted)]">
                Tu dois √™tre connect√© pour utiliser le simulateur d&apos;entretien.
              </p>
            )}
          </div>
        )}

        {/* Bloc entretien */}
        {showInterviewPanel && (
          <div className="glass p-4 rounded-2xl border border-white/10 h-[520px] flex flex-col">
            <div className="flex justify-between items-start mb-4 border-b border-white/5 pb-2 gap-3">
              <div className="flex items-center gap-3">
                <div
                  className={`w-10 h-10 rounded-full bg-gradient-to-br from-emerald-400/70 to-cyan-500/80 flex items-center justify-center shadow-lg ${
                    aiSpeaking ? "animate-pulse" : ""
                  }`}
                >
                  <span className="text-2xl">{recruiterGender === "f" ? "üë©‚Äçüíº" : "üë®‚Äçüíº"}</span>
                </div>
                <div className="text-xs text-[var(--muted)]">
                  <p className="font-semibold">{recruiterGender === "f" ? "Recruteuse IA" : "Recruteur IA"}</p>
                  <p className="text-[11px]">
                    {aiSpeaking ? "Te pose une question..." : finished ? "Entretien termin√©" : "Attend ta r√©ponse"}
                  </p>
                  {lastInterviewerMessage && (
                    <button
                      type="button"
                      onClick={() => speak(lastInterviewerMessage)}
                      className="mt-1 inline-flex items-center gap-1 text-[10px] px-2 py-[2px] rounded-full bg-white/5 hover:bg-white/10"
                    >
                      üîä R√©√©couter la question
                    </button>
                  )}
                </div>
              </div>

              <div className="flex flex-col items-end gap-1">
                <span className="text-[10px] font-semibold text-emerald-400 uppercase tracking-wider">En direct</span>
                <span className="text-[10px] text-[var(--muted)]">
                  {finished ? "Entretien termin√©" : `Question ${Math.max(1, currentQuestionIndex)} sur ${totalQuestions}`}
                </span>
                <div className="w-32 h-1.5 bg-white/10 rounded-full overflow-hidden">
                  <div className="h-full bg-emerald-400 transition-all" style={{ width: `${progressPercent}%` }} />
                </div>

                {!finished && questionsLeft > 0 && (
                  <span className="text-[10px] text-[var(--muted)]">
                    Il reste environ <span className="font-semibold">{questionsLeft} questions</span> (~
                    {estimatedMinutesRounded} min)
                  </span>
                )}

                {finished && (
                  <span className="text-[10px] text-[var(--muted)]">
                    Entretien termin√© ‚Ä¢ Bilan disponible ci-dessous
                  </span>
                )}

                <button onClick={stopSession} className="text-[11px] text-red-400 hover:underline mt-1" type="button">
                  Arr√™ter l&apos;entretien
                </button>
              </div>
            </div>

            <div ref={chatRef} className="flex-1 overflow-y-auto space-y-4 custom-scrollbar pr-2">
              {history.map((m, i) => {
                const isLastInterviewer = m.role === "interviewer" && i === lastInterviewerIndex;
                const showText = isLastInterviewer && typing ? m.text.slice(0, typingIndex) : m.text;

                return (
                  <div key={i} className={`flex ${m.role === "candidate" ? "justify-end" : "justify-start"}`}>
                    <div
                      className={`max-w-[85%] p-3 rounded-2xl text-sm ${
                        m.role === "candidate"
                          ? "bg-blue-600/20 text-blue-100 rounded-br-none border border-blue-500/30"
                          : m.role === "interviewer"
                          ? "bg-white/5 text-slate-200 rounded-bl-none border border-white/10"
                          : "bg-white/5 text-[var(--muted)] border border-white/5 text-[11px] italic"
                      }`}
                    >
                      {showText}
                    </div>
                  </div>
                );
              })}

              {loading && (
                <div className="text-xs text-[var(--muted)] flex items-center gap-2">
                  <span className="inline-flex h-2 w-2 rounded-full bg-emerald-400 animate-pulse" />
                  L&apos;IA r√©fl√©chit...
                </div>
              )}

              {finished && (finalSummary || finalScore !== null) && (
                <div className="mt-3 rounded-xl border border-emerald-500/40 bg-emerald-500/10 p-3 text-[11px] space-y-2">
                  <p className="text-xs font-semibold text-emerald-300">Bilan de l&apos;entretien</p>
                  {typeof finalScore === "number" && (
                    <p>
                      <span className="font-semibold">Note globale :</span> {Math.round(finalScore)}/100
                    </p>
                  )}
                  {finalSummary && (
                    <p className="whitespace-pre-line">
                      <span className="font-semibold">Synth√®se :</span> {finalSummary}
                    </p>
                  )}
                  {finalDecision && (
                    <p className="whitespace-pre-line">
                      <span className="font-semibold">D√©cision probable :</span> {finalDecision}
                    </p>
                  )}
                </div>
              )}
            </div>

            <div className="mt-4 pt-4 border-t border-white/10 flex flex-col gap-2">
              <div className="flex items-center gap-2">
                <button
                  onClick={toggleMic}
                  disabled={!started || loading}
                  type="button"
                  className={`p-3 rounded-full transition-colors flex items-center justify-center ${
                    listening
                      ? "bg-red-500/80 animate-pulse ring-2 ring-red-300/60"
                      : "bg-white/10 hover:bg-white/20"
                  } ${!started || loading ? "opacity-50 cursor-not-allowed" : ""}`}
                >
                  <span>üé§</span>
                  {listening && (
                    <span className="ml-1 text-[10px] uppercase tracking-widest text-red-100">REC</span>
                  )}
                </button>

                {listening && (
                  <div className="flex gap-[3px] h-4 items-end">
                    <span className="w-[3px] bg-red-100 rounded-sm animate-[ping_0.7s_ease-in-out_infinite]" />
                    <span className="w-[3px] bg-red-200 rounded-sm animate-[ping_0.8s_ease-in-out_infinite]" />
                    <span className="w-[3px] bg-red-300 rounded-sm animate-[ping_0.6s_ease-in-out_infinite]" />
                    <span className="w-[3px] bg-red-200 rounded-sm animate-[ping_0.9s_ease-in-out_infinite]" />
                  </div>
                )}
              </div>

              <div className="flex gap-2">
                <input
                  className="flex-1 bg-black/20 border border-white/10 rounded-full px-4 text-sm"
                  placeholder={started ? "Parle ou √©cris ta r√©ponse..." : "Lance la simulation pour commencer l'entretien"}
                  value={input}
                  disabled={!started || loading}
                  onChange={(e) => setInput(e.target.value)}
                  onKeyDown={(e) => started && e.key === "Enter" && sendAnswer(input)}
                />
                <button
                  onClick={() => sendAnswer(input)}
                  disabled={!started || loading}
                  type="button"
                  className="p-2 px-4 bg-white/10 rounded-full text-sm hover:bg-white/20 disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  ‚û§
                </button>
              </div>
            </div>
          </div>
        )}
      </div>
    </section>
  );
}
````

## File: functions/package.json
````json
{
  "name": "assistant-candidatures-functions",
  "main": "index.js",
  "engines": {
    "node": "20"
  },
  "dependencies": {
    "@google-cloud/recaptcha-enterprise": "^6.3.1",
    "@google/genai": "^1.30.0",
    "@polar-sh/sdk": "^0.41.5",
    "busboy": "^1.6.0",
    "cors": "^2.8.5",
    "firebase-admin": "^12.7.0",
    "firebase-functions": "^5.1.1",
    "jszip": "^3.10.1",
    "node-fetch": "^3.3.2",
    "nodemailer": "^7.0.10",
    "pdf-lib": "^1.17.1",
    "pdf-parse": "^2.4.5",
    "pdfjs-dist": "^5.4.394",
    "pdfmake": "^0.2.21"
  }
}
````

## File: lib/pdf/templates/letter.ts
````typescript
// lib/pdf/templates/letter.ts
import type { PdfColors } from "../colors";
export type { PdfColors } from "../colors";

import type { CvTemplateId } from "./cvTemplates"; // ‚úÖ pour matcher th√®me CV

export type LmModel = {
  lang: "fr" | "en";
  name: string;
  contactLines: string[];
  service: string;
  companyName: string;
  companyAddr?: string;
  city: string;
  dateStr: string;
  subject: string;
  salutation: string;
  body: string; // corps uniquement
  closing: string;
  signature: string;
};

function splitParas(text: string) {
  return (text || "")
    .replace(/\n{3,}/g, "\n\n")
    .split(/\n\s*\n/)
    .map((p) => p.trim())
    .filter(Boolean);
}

const DEFAULT_COLORS: PdfColors = {
  brand: "#2563eb",
  brandDark: "#1e40af",
  ink: "#0f172a",
  muted: "#475569",
  border: "#e2e8f0",
  bgSoft: "#f1f5f9",
  hair: "#cbd5e1",
};

function safeText(v: any) {
  return String(v ?? "").replace(/\u00A0/g, " ").trim();
}

function pickColor(colors: PdfColors, key: keyof PdfColors, fallback: string) {
  const v = colors?.[key];
  return typeof v === "string" && v.trim() ? v.trim() : fallback;
}

function hexToRgb(hex: string) {
  const h = hex.replace("#", "").trim();
  if (h.length === 3) {
    const r = parseInt(h[0] + h[0], 16);
    const g = parseInt(h[1] + h[1], 16);
    const b = parseInt(h[2] + h[2], 16);
    return { r, g, b };
  }
  return {
    r: parseInt(h.slice(0, 2), 16),
    g: parseInt(h.slice(2, 4), 16),
    b: parseInt(h.slice(4, 6), 16),
  };
}
function rgbToHex(r: number, g: number, b: number) {
  const to = (x: number) =>
    Math.max(0, Math.min(255, Math.round(x)))
      .toString(16)
      .padStart(2, "0");
  return `#${to(r)}${to(g)}${to(b)}`;
}
function mixHex(a: string, b: string, t: number) {
  const A = hexToRgb(a);
  const B = hexToRgb(b);
  return rgbToHex(A.r + (B.r - A.r) * t, A.g + (B.g - A.g) * t, A.b + (B.b - A.b) * t);
}

function themeUsesHeaderBand(theme: CvTemplateId) {
  return theme === "modern" || theme === "pro_max" || theme === "tech";
}

function themeHeaderBg(theme: CvTemplateId, brand: string) {
  if (theme === "tech") return "#0b1220";
  if (theme === "pro_max") return brand; // on fera d√©grad√© via background
  if (theme === "modern") return brand;
  return brand;
}

function themeBackground(theme: CvTemplateId, brand: string, pageSize: any, scale: number) {
  const w = pageSize?.width ?? 595;
  const h = pageSize?.height ?? 842;

  if (theme === "pro_max") {
    const brand2 = mixHex(brand, "#ffffff", 0.35);
    const bands = Array.from({ length: 18 }).map((_, i) => ({
      type: "rect",
      x: (w / 18) * i,
      y: 0,
      w: w / 18 + 1,
      h: 140 * scale,
      color: mixHex(brand, brand2, i / 17),
      opacity: 0.96,
    }));

    const dots = Array.from({ length: 180 }).map((_, i) => {
      const cols = 18;
      const x = 18 + (i % cols) * 30;
      const y = 16 + Math.floor(i / cols) * 14;
      return { type: "ellipse", x, y, r1: 1.4, r2: 1.4, color: "#ffffff", opacity: 0.35 };
    });

    return [
      { canvas: bands },
      { canvas: dots },
      { canvas: [{ type: "rect", x: 0, y: h - 10, w, h: 10, color: brand }] },
    ];
  }

  if (theme === "modern") {
    const headerH = 130 * scale;
    const dots = Array.from({ length: 96 }).map((_, i) => {
      const cols = 12;
      const x = w - 36 - (i % cols) * 18;
      const y = 18 + Math.floor(i / cols) * 14;
      return { type: "ellipse", x, y, r1: 1.4, r2: 1.4, color: "#ffffff", opacity: 0.25 };
    });

    return [
      { canvas: [{ type: "rect", x: 0, y: 0, w, h: headerH, color: brand }] },
      { canvas: dots },
      { canvas: [{ type: "rect", x: 0, y: h - 10, w, h: 10, color: brand }] },
    ];
  }

  if (theme === "tech") {
    return [
      { canvas: [{ type: "rect", x: 0, y: 0, w, h: 95 * scale, color: "#0b1220" }] },
      { canvas: [{ type: "rect", x: 0, y: 95 * scale, w, h: 4 * scale, color: brand }] },
    ];
  }

  if (theme === "minimalist" || theme === "elegant") {
    return [{ canvas: [{ type: "rect", x: 0, y: 0, w, h: 6 * scale, color: brand }] }];
  }

  // ats / classic / creative : sobre
  return [];
}

/**
 * ‚úÖ LM styl√©e avec th√®me (optionnel) ‚Äî compatible avec tes appels existants
 * buildLmStyledPdf(lm, colors, scale)
 * buildLmStyledPdf(lm, colors, scale, cvTemplate)
 */
export function buildLmStyledPdf(
  lm: LmModel,
  colors: PdfColors,
  scale = 1,
  theme: CvTemplateId = "ats"
) {
  const bodyParas = splitParas(lm.body);

  const brandColor = pickColor(colors, "brand", DEFAULT_COLORS.brand);
  const mutedColor = pickColor(colors, "muted", DEFAULT_COLORS.muted);
  const borderColor = pickColor(colors, "border", DEFAULT_COLORS.border);
  const hairColor = pickColor(colors, "hair", DEFAULT_COLORS.hair);
  const inkColor = pickColor(colors, "ink", DEFAULT_COLORS.ink);

  const baseFs = 10.5 * scale;
  const nameFs = 12 * scale;

  const dateLine =
    lm.lang === "en"
      ? `At ${safeText(lm.city)}, ${safeText(lm.dateStr)}`
      : `√Ä ${safeText(lm.city)}, le ${safeText(lm.dateStr)}`;

  const rightStack: any[] = [
    { text: safeText(lm.service), color: mutedColor },
    { text: safeText(lm.companyName), bold: true, color: mutedColor },
    ...(lm.companyAddr ? safeText(lm.companyAddr).split(/\n+/).map((l) => ({ text: l })) : []),
  ];

  const leftMargin = 40 * scale;
  const rightMargin = 40 * scale;
  const bottomMargin = 36 * scale;
  const topMargin = themeUsesHeaderBand(theme) ? 110 * scale : 36 * scale;

  const pageW = 595;
  const lineW = pageW - leftMargin - rightMargin;

  const headerOnBand = themeUsesHeaderBand(theme);
  const headerNameColor = headerOnBand ? "#ffffff" : mutedColor;
  const headerMetaColor = headerOnBand ? "#ffffff" : inkColor;
  const headerMetaOpacity = headerOnBand ? 0.92 : 1;

  const brandBar = headerOnBand
    ? null
    : {
        canvas: [{ type: "line", x1: 0, y1: 0, x2: lineW, y2: 0, lineWidth: 3 * scale, lineColor: brandColor }],
        margin: [0, 0, 0, 10 * scale],
      };

  const hair = {
    canvas: [
      { type: "line", x1: 0, y1: 0, x2: lineW, y2: 0, lineWidth: 1, lineColor: hairColor },
    ],
    margin: [0, 6 * scale, 0, 10 * scale],
  };

  const headerBlock = {
    columns: [
      {
        width: "*",
        stack: [
          { text: safeText(lm.name), bold: true, fontSize: nameFs, color: headerNameColor },
          ...(lm.contactLines || []).map((t) => ({
            text: safeText(t),
            color: headerMetaColor,
            opacity: headerMetaOpacity,
            fontSize: 9.6 * scale,
          })),
        ],
      },
      {
        width: "auto",
        alignment: "right",
        stack: rightStack.map((x) => ({
          ...x,
          color: headerOnBand ? "#ffffff" : x.color,
          opacity: headerMetaOpacity,
          fontSize: 9.6 * scale,
        })),
        margin: [0, 28 * scale, 0, 0],
      },
    ],
    columnGap: 15 * scale,
    margin: [0, headerOnBand ? -78 * scale : 0, 0, 0],
  };

  return {
    pageSize: "A4",
    pageMargins: [leftMargin, topMargin, rightMargin, bottomMargin],
    background: (currentPage: number, pageSize: any) => {
      if (currentPage !== 1) return null;
      return themeBackground(theme, themeHeaderBg(theme, brandColor), pageSize, scale);
    },
    defaultStyle: {
      font: "Roboto",
      fontSize: baseFs,
      lineHeight: 1.24,
      color: inkColor,
    },
    content: [
      ...(brandBar ? [brandBar] : []),

      headerBlock,

      headerOnBand
        ? {
            canvas: [
              {
                type: "line",
                x1: 0,
                y1: 0,
                x2: lineW,
                y2: 0,
                lineWidth: 1,
                lineColor: mixHex(borderColor, "#ffffff", 0.25),
              },
            ],
            margin: [0, 10 * scale, 0, 12 * scale],
          }
        : hair,

      { text: dateLine, margin: [0, 0, 0, 8 * scale], color: mutedColor },
      { text: safeText(lm.subject), bold: true, color: brandColor, margin: [0, 0, 0, 10 * scale] },
      { text: safeText(lm.salutation), margin: [0, 0, 0, 8 * scale] },

      ...bodyParas.map((p) => ({ text: p, margin: [0, 0, 0, 6 * scale] })),

      { text: safeText(lm.closing), margin: [0, 12 * scale, 0, 2 * scale], alignment: "right" },
      { text: safeText(lm.signature), bold: true, alignment: "right" },
    ],
  };
}

/**
 * ‚úÖ Fallback qui accepte:
 * - un LmModel (structur√©)
 * - OU un string (texte brut)
 *
 * + optionnel: theme pour matcher CV
 */
export function buildLmFallbackPdf(text: string, colors: PdfColors, scale?: number, theme?: CvTemplateId): any;
export function buildLmFallbackPdf(lm: LmModel, colors: PdfColors, scale?: number, theme?: CvTemplateId): any;
export function buildLmFallbackPdf(text: string, scale?: number, theme?: CvTemplateId): any;
export function buildLmFallbackPdf(lm: LmModel, scale?: number, theme?: CvTemplateId): any;
export function buildLmFallbackPdf(
  first: string | LmModel,
  second?: PdfColors | number,
  third?: number | CvTemplateId,
  fourth?: CvTemplateId
) {
  const colors: PdfColors = typeof second === "object" && second ? second : DEFAULT_COLORS;

  const scale = typeof second === "number" ? second : typeof third === "number" ? third : 1;

  const theme: CvTemplateId =
    (typeof third === "string" ? third : typeof fourth === "string" ? fourth : "ats") as CvTemplateId;

  // Si on a un mod√®le structur√© -> rendu exact (th√©m√©)
  if (typeof first === "object" && first) {
    return buildLmStyledPdf(first, colors, scale, theme);
  }

  // Sinon texte brut (string) ‚Äî fallback simple mais avec background du th√®me
  const rawText = String(first || "");
  const paras = splitParas(rawText);

  const brandColor = pickColor(colors, "brand", DEFAULT_COLORS.brand);
  const hairColor = pickColor(colors, "hair", DEFAULT_COLORS.hair);
  const inkColor = pickColor(colors, "ink", DEFAULT_COLORS.ink);

  const leftMargin = 40 * scale;
  const rightMargin = 40 * scale;
  const bottomMargin = 36 * scale;
  const topMargin = themeUsesHeaderBand(theme) ? 90 * scale : 36 * scale;

  const pageW = 595;
  const lineW = pageW - leftMargin - rightMargin;

  const baseFs = 10.5 * scale;

  return {
    pageSize: "A4",
    pageMargins: [leftMargin, topMargin, rightMargin, bottomMargin],
    background: (currentPage: number, pageSize: any) => {
      if (currentPage !== 1) return null;
      return themeBackground(theme, themeHeaderBg(theme, brandColor), pageSize, scale);
    },
    defaultStyle: {
      font: "Roboto",
      fontSize: baseFs,
      lineHeight: 1.26,
      color: inkColor,
    },
    content: [
      ...(themeUsesHeaderBand(theme)
        ? []
        : [
            {
              canvas: [
                { type: "line", x1: 0, y1: 0, x2: lineW, y2: 0, lineWidth: 3 * scale, lineColor: brandColor },
              ],
              margin: [0, 0, 0, 10 * scale],
            },
          ]),

      {
        canvas: [{ type: "line", x1: 0, y1: 0, x2: lineW, y2: 0, lineWidth: 1, lineColor: hairColor }],
        margin: [0, 0, 0, 12 * scale],
      },

      ...(paras.length ? paras : [""]).map((p) => ({ text: p, margin: [0, 0, 0, 7 * scale] })),
    ],
  };
}
````

## File: lib/pdf/generateCvLm.ts
````typescript
// src/lib/pdf/generateCvLm.ts
import { makePdfColors } from "./colors";
import { fitOnePage } from "./fitOnePage";
import { mergePdfBlobs } from "./mergePdfs";
import { downloadBlob } from "./pdfmakeClient";
import { buildCvAtsPdf, type CvDocModel } from "./templates/cvAts";
import { buildLmStyledPdf, buildLmFallbackPdf, type LmModel } from "./templates/letter";

export async function generateAndDownloadCvLmPdf(params: {
  brandHex: string;
  cv: CvDocModel;
  cvLang: "fr" | "en";
  // LM: soit mod√®le structur√©, soit texte brut
  lm?: LmModel;
  lmTextFallback?: string;
  filename?: string;
}) {
  const colors = makePdfColors(params.brandHex);

  // 1) CV -> fit 1 page
  const cvFit = await fitOnePage((scale) =>
    buildCvAtsPdf(params.cv, params.cvLang, colors, "auto", scale)
  );

  // 2) LM -> fit 1 page
  const lmFit = await fitOnePage(
    (scale) => {
      if (params.lm) return buildLmStyledPdf(params.lm, colors, scale);
      return buildLmFallbackPdf(params.lmTextFallback || "", colors, scale);
    },
    { min: 0.85, max: 1.6, iterations: 6, initial: 1.0 }
  );

  // 3) fusion (2 pages)
  const merged = await mergePdfBlobs([cvFit.blob, lmFit.blob]);

  downloadBlob(merged, params.filename || `CV_LM_${new Date().toISOString().slice(0, 10)}.pdf`);
}
````

## File: lib/pdf/pdfmakeClient.ts
````typescript
"use client";

import pdfMakeMod from "pdfmake/build/pdfmake";
import pdfFontsMod from "pdfmake/build/vfs_fonts";

let cached: any | null = null;

function buildVfsFromModule(mod: any) {
  if (!mod) return null;

  const classic =
    mod?.pdfMake?.vfs ??
    mod?.default?.pdfMake?.vfs ??
    mod?.default?.vfs ??
    mod?.vfs;

  if (classic && typeof classic === "object") return classic;

  const candidate = typeof mod === "object" ? mod : null;
  if (!candidate) return null;

  const vfs: Record<string, string> = {};

  for (const [k, v] of Object.entries(candidate)) {
    if (k === "default") continue;
    if (!k.toLowerCase().endsWith(".ttf")) continue;
    if (typeof v !== "string") continue;
    vfs[k] = v;
  }

  const def = candidate?.default;
  if (def && typeof def === "object") {
    for (const [k, v] of Object.entries(def)) {
      if (!k.toLowerCase().endsWith(".ttf")) continue;
      if (typeof v !== "string") continue;
      vfs[k] = v;
    }
  }

  return Object.keys(vfs).length ? vfs : null;
}

export async function getPdfMake() {
  if (cached) return cached;

  const pdfMake = (pdfMakeMod as any).default ?? (pdfMakeMod as any);
  const vfs = buildVfsFromModule(pdfFontsMod);

  if (!vfs) {
    console.error("vfs_fonts module keys:", Object.keys((pdfFontsMod as any) || {}));
    console.error("vfs_fonts.default keys:", Object.keys((pdfFontsMod as any)?.default || {}));
    throw new Error("pdfmake vfs_fonts introuvable (vfs).");
  }

  // injecte vfs une seule fois
  if (!pdfMake.vfs) pdfMake.vfs = vfs;

  pdfMake.fonts = {
    Roboto: {
      normal: "Roboto-Regular.ttf",
      bold: "Roboto-Medium.ttf",
      italics: "Roboto-Italic.ttf",
      bolditalics: "Roboto-MediumItalic.ttf",
    },
  };

  cached = pdfMake;
  return pdfMake;
}

export async function pdfMakeToBlob(docDef: any): Promise<Blob> {
  const pdfMake = await getPdfMake();
  return new Promise((resolve, reject) => {
    try {
      pdfMake.createPdf(docDef).getBlob((blob: Blob) => resolve(blob));
    } catch (e) {
      reject(e);
    }
  });
}

export function downloadBlob(blob: Blob, filename: string) {
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(() => URL.revokeObjectURL(url), 2500);
}
````

## File: lib/firebase.ts
````typescript
// lib/firebase.ts
"use client";

import { initializeApp, getApps, getApp } from "firebase/app";
import { getAuth, GoogleAuthProvider } from "firebase/auth";
import { getFirestore } from "firebase/firestore";
import { getFunctions } from "firebase/functions";

// Firebase config (publique)
const firebaseConfig = {
  apiKey: "AIzaSyCNb2cU0yhUeBGOk-8IK3TGNbjL6wSYMRs",
  authDomain: "assistant-ia-v4.firebaseapp.com",
  projectId: "assistant-ia-v4",
  storageBucket: "assistant-ia-v4.firebasestorage.app",
  messagingSenderId: "500826253198",
  appId: "1:500826253198:web:4bc5bd2402d7dd286326df",
  measurementId: "G-61HCNNZBTN",
};

export const app = getApps().length ? getApp() : initializeApp(firebaseConfig);

export const auth = getAuth(app);
export const db = getFirestore(app);

// Functions dans la m√™me r√©gion que tes Cloud Functions
export const functions = getFunctions(app, "europe-west1");

// Provider Google (pour popup)
export const googleProvider = new GoogleAuthProvider();
googleProvider.setCustomParameters({ prompt: "select_account" });
````

## File: lib/recaptcha.ts
````typescript
// lib/recaptcha.ts
"use client";

/**
 * ‚úÖ Single source of truth reCAPTCHA (v3 standard ou Enterprise)
 * - Loader robuste (si script pas encore charg√©)
 * - tryGetRecaptchaToken(): non bloquant => retourne null si adblock/timeout‚Ä¶
 * - getRecaptchaToken(): strict => throw si impossible
 * - verifyRecaptcha(): optionnel via ton endpoint CF /recaptchaVerify (Enterprise)
 */

declare global {
  interface Window {
    grecaptcha?: GrecaptchaRoot;
  }
}

type GrecaptchaClient = {
  ready?: (cb: () => void) => void;
  execute: (siteKey: string, opts: { action: string }) => Promise<string>;
};

type GrecaptchaRoot = GrecaptchaClient & {
  enterprise?: GrecaptchaClient;
};

export type VerifyResult =
  | { ok: true; score?: number }
  | { ok: false; reason: string; score?: number };

const DEFAULT_API_BASE =
  "https://europe-west1-assistant-ia-v4.cloudfunctions.net";

export const API_BASE = (
  process.env.NEXT_PUBLIC_API_BASE_URL || DEFAULT_API_BASE
).replace(/\/+$/, "");

const SITE_KEY =
  process.env.NEXT_PUBLIC_RECAPTCHA_SITE_KEY ||
  process.env.NEXT_PUBLIC_RECAPTCHA_KEY ||
  "";

const USE_ENTERPRISE =
  (process.env.NEXT_PUBLIC_RECAPTCHA_ENTERPRISE || "")
    .toLowerCase()
    .trim() === "true";

let recaptchaLoadPromise: Promise<void> | null = null;

function isBrowser() {
  return typeof window !== "undefined" && typeof document !== "undefined";
}

function normalizeAction(action: string) {
  return (action || "").trim().toLowerCase();
}

function describeRecaptchaLoadFailure() {
  return [
    "S√©curit√©: impossible de valider reCAPTCHA.",
    "Le script reCAPTCHA n‚Äôa pas pu √™tre charg√© ou est bloqu√©.",
    "Causes fr√©quentes: bloqueur de pubs, DNS filtrant, proxy/corporate, CSP trop stricte, ou r√©seau qui bloque google.com.",
  ].join(" ");
}

function hasUsableRecaptcha(): boolean {
  const g = window.grecaptcha;
  if (!g) return false;

  if (USE_ENTERPRISE) {
    return Boolean(g.enterprise && typeof g.enterprise.execute === "function");
  }

  return typeof g.execute === "function";
}

function pickRecaptchaClient(): GrecaptchaClient | null {
  const g = window.grecaptcha;
  if (!g) return null;

  if (USE_ENTERPRISE) {
    if (g.enterprise && typeof g.enterprise.execute === "function") return g.enterprise;
    return null;
  }

  if (typeof g.execute === "function") return g;
  return null;
}

/**
 * ‚úÖ Loader robuste:
 * - attend que grecaptcha soit r√©ellement dispo (poll)
 * - retentable (reset promise en cas d‚Äô√©chec)
 */
async function ensureRecaptchaLoaded(): Promise<void> {
  if (!isBrowser()) {
    throw new Error("reCAPTCHA: appel√© c√¥t√© serveur (SSR).");
  }
  if (!SITE_KEY) {
    throw new Error("reCAPTCHA: NEXT_PUBLIC_RECAPTCHA_SITE_KEY manquant.");
  }
  if (hasUsableRecaptcha()) return;
  if (recaptchaLoadPromise) return recaptchaLoadPromise;

  recaptchaLoadPromise = new Promise<void>((resolve, reject) => {
    const selector = USE_ENTERPRISE
      ? 'script[data-recaptcha="enterprise"]'
      : 'script[data-recaptcha="v3"]';

    const existing = document.querySelector<HTMLScriptElement>(selector);

    const pollUntilReady = (ms: number) => {
      const t0 = Date.now();
      const tick = () => {
        if (hasUsableRecaptcha()) return resolve();
        if (Date.now() - t0 > ms) return reject(new Error(describeRecaptchaLoadFailure()));
        requestAnimationFrame(tick);
      };
      tick();
    };

    // Script d√©j√† pr√©sent => on attend juste l'exposition de grecaptcha
    if (existing) {
      pollUntilReady(10_000);
      return;
    }

    const script = document.createElement("script");
    script.async = true;
    script.defer = true;
    script.setAttribute("data-recaptcha", USE_ENTERPRISE ? "enterprise" : "v3");

    const base = USE_ENTERPRISE
      ? "https://www.google.com/recaptcha/enterprise.js"
      : "https://www.google.com/recaptcha/api.js";

    script.src = `${base}?render=${encodeURIComponent(SITE_KEY)}`;

    const timeout = window.setTimeout(() => {
      reject(new Error(describeRecaptchaLoadFailure()));
    }, 12_000);

    script.onload = () => {
      window.clearTimeout(timeout);
      pollUntilReady(8_000);
    };

    script.onerror = () => {
      window.clearTimeout(timeout);
      reject(new Error(describeRecaptchaLoadFailure()));
    };

    document.head.appendChild(script);
  }).catch((e) => {
    recaptchaLoadPromise = null; // ‚úÖ retentable
    throw e;
  });

  return recaptchaLoadPromise;
}

/**
 * ‚úÖ Non bloquant :
 * - retourne un token si possible
 * - sinon null (adblock, script bloqu√©, timeout‚Ä¶)
 */
export async function tryGetRecaptchaToken(action: string): Promise<string | null> {
  if (!isBrowser()) return null;
  if (!SITE_KEY) return null;

  const normalizedAction = normalizeAction(action);
  if (!normalizedAction) return null;

  try {
    await ensureRecaptchaLoaded();
    const client = pickRecaptchaClient();
    if (!client) return null;

    const token = await new Promise<string>((resolve, reject) => {
      const runExecute = () => {
        client
          .execute(SITE_KEY, { action: normalizedAction })
          .then((t) => resolve(t))
          .catch(reject);
      };

      try {
        if (typeof client.ready === "function") client.ready(runExecute);
        else runExecute();
      } catch (e) {
        reject(e);
      }
    });

    return typeof token === "string" && token ? token : null;
  } catch {
    return null;
  }
}

/** Version stricte */
export async function getRecaptchaToken(action: string): Promise<string> {
  const token = await tryGetRecaptchaToken(action);
  if (!token) {
    throw new Error(describeRecaptchaLoadFailure());
  }
  return token;
}

export async function warmupRecaptcha(): Promise<void> {
  await ensureRecaptchaLoaded();
}

/** V√©rif optionnelle via endpoint /recaptchaVerify */
export async function verifyRecaptcha(token: string, action: string): Promise<VerifyResult> {
  const normalizedAction = normalizeAction(action);

  if (!token) return { ok: false, reason: "missing_token" };
  if (!normalizedAction) return { ok: false, reason: "missing_action" };

  try {
    const res = await fetch(`${API_BASE}/recaptchaVerify`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ token, action: normalizedAction }),
      cache: "no-store",
    });

    const data: any = await res.json().catch(() => ({}));

    if (!res.ok || !data?.ok) {
      return {
        ok: false,
        reason: String(data?.reason || data?.details?.reason || "recaptcha_failed"),
        score: typeof data?.score === "number"
          ? data.score
          : typeof data?.details?.score === "number"
            ? data.details.score
            : undefined,
      };
    }

    return { ok: true, score: typeof data?.score === "number" ? data.score : undefined };
  } catch {
    return { ok: false, reason: "network_error" };
  }
}
````

## File: firebase.json
````json
{
  "hosting": {
    "site": "assistant-ia-v4",
    "public": "out",
    "ignore": [
      "firebase.json",
      "**/.*",
      "**/node_modules/**"
    ],
    "rewrites": [
      { "source": "/api/recaptchaVerify", "function": "recaptchaVerify" },

      { "source": "/api/interview", "function": "interview" },
      { "source": "/api/extractProfile", "function": "extractProfile" },

      { "source": "/api/generateLetterAndPitch", "function": "generateLetterAndPitch" },
      { "source": "/api/generateInterviewQA", "function": "generateInterviewQA" },
      { "source": "/api/generateCvPdf", "function": "generateCvPdf" },
      { "source": "/api/generateCvLmZip", "function": "generateCvLmZip" },
      { "source": "/api/generateLetterPdf", "function": "generateLetterPdf" },

      { "source": "/api/jobs", "function": "jobs" },

      { "source": "/api/polar/checkout", "function": "polarCheckout" },
      { "source": "/api/polar/webhook", "function": "polarWebhook" },

      { "source": "**", "destination": "/index.html" }
    ],
    "cleanUrls": true,
    "trailingSlash": false
  },
  "firestore": {
    "rules": "firestore.rules",
    "indexes": "firestore.indexes.json"
  },
  "functions": {
    "source": "functions"
  }
}
````

## File: next.config.mjs
````javascript
/** @type {import('next').NextConfig} */
const nextConfig = {
  reactStrictMode: true,

  // üî¥ IMPORTANT : active le mode export statique
  // => `next build` va g√©n√©rer un dossier `out/`
  output: "export",

  // üî¥ IMPORTANT pour un h√©bergement statique (Firebase Hosting)
  // Pas d'image optimizer c√¥t√© serveur
  images: {
    unoptimized: true,
  },

  // Tu l'avais d√©j√† pour pdfjs
  transpilePackages: ["pdfjs-dist"],

  webpack: (config, { dev, isServer }) => {
    // Workaround qui √©tait d√©j√† dans ton projet
    if (dev && !isServer) {
      config.devtool = "source-map"; // ou "cheap-module-source-map"
    }
    return config;
  },

  experimental: {},
};

export default nextConfig;
````

## File: functions/index.js
````javascript
"use strict";

/**
 * ‚úÖ VERSION "FULL IA CONNECT√âE" (Smart2) ‚Äî FIXED + PATCH COMPLET
 *
 * Fix inclus :
 * - ‚úÖ LM/PITCH via IA en JSON strict (response_mime_type) + parsing robuste (AI_BAD_JSON)
 * - ‚úÖ Plus de "<body>" dans la lettre (prompt + nettoyage)
 * - ‚úÖ Lettre mieux cibl√©e (limite de mots + anti-copie + JD mieux nettoy√©e)
 * - ‚úÖ Signatures en double/triple : normalisation + d√©dup renforc√©e
 * - ‚úÖ En-t√™tes duplicats (Service Recrutement / Entreprise) : sanitization
 * - ‚úÖ reCAPTCHA 403 : bypass si user authentifi√© + action mismatch non bloquant (configurable)
 * - ‚úÖ PATCH: generateLetterAndPitch prot√©g√© par reCAPTCHA (action "generate_letter_pitch")
 * - ‚úÖ PATCH: looksLikeFullLetter() FR corrig√© (regex \b autour de virgule supprim√©)
 * - ‚úÖ PATCH: sanitizeLmBodyFromModel() am√©liore <br> + suppression HTML r√©siduel
 *
 * IMPORTANT :
 * - Les PROMPTS IA demandent "corps uniquement" (sans salutation, sans signature).
 * - Le serveur peut recomposer une lettre compl√®te "exemple" via composeFullCoverLetterDoc().
 */

const functions = require("firebase-functions/v1");
const admin = require("firebase-admin");
const { PDFDocument, StandardFonts, rgb } = require("pdf-lib");
const JSZip = require("jszip");
const { Polar } = require("@polar-sh/sdk");
const { RecaptchaEnterpriseServiceClient } = require("@google-cloud/recaptcha-enterprise");

// =============================
// Firebase Admin init
// =============================
if (!admin.apps.length) {
  admin.initializeApp();
}
const db = admin.firestore();

// =============================
// Helper fetch (Node 18+)
// =============================
const fetchFn = globalThis.fetch;
if (!fetchFn) {
  console.warn(
    "‚ö†Ô∏è globalThis.fetch introuvable. Mets Node 18+ dans functions/package.json (engines.node=18)."
  );
}

// ======================================================
// ‚úÖ PROMPTS INLINE (LM/PITCH JSON strict + CV TAILOR)
// ======================================================
const TEMPLATE_LETTER_PITCH_FR = `
Tu es un recruteur senior et un coach carri√®re.

Retourne STRICTEMENT un JSON valide :
{ "coverLetterBody": "string", "pitch": "string" }

R√àGLES LETTRE (coverLetterBody) :
- UNIQUEMENT le CORPS (pas d‚Äôen-t√™te, pas d‚Äôobjet, pas de formule d‚Äôappel, pas de signature).
- 3 √† 4 paragraphes (s√©par√©s par UNE ligne vide).
- Longueur : 220 √† 320 mots.
- Ton professionnel, concret, pas de blabla.
- Utilise explicitement 2 √† 3 exp√©riences du candidat (missions / r√©alisations) AVEC outils/technos d√©j√† pr√©sents dans le profil.
- Ne pas inventer (entreprises/outils/chiffres).
- Ne recopie PAS la fiche de poste : pas plus de 10‚Äì12 mots identiques d‚Äôaffil√©e.
- Ignore totalement les blocs ‚ÄúUI‚Äù d‚Äôoffres copi√©es/coll√©es (Indeed/LinkedIn) du type :
  ‚ÄúInformations sur le profil‚Äù, ‚ÄúCorrespondance‚Ä¶‚Äù, ‚ÄúD√©tails de l‚Äôemploi‚Äù, ‚ÄúComp√©tences‚Äù, ‚ÄúFormation‚Äù, etc.
- Base-toi UNIQUEMENT sur le profil candidat + les √©l√©ments utiles de la fiche de poste.

R√àGLES PITCH :
- 2 √† 4 phrases max.
- Sp√©cifique au poste et √† l‚Äôentreprise.
- Ne pas inventer.

PROFIL CANDIDAT (source de v√©rit√©) :
{{cvText}}

FICHE DE POSTE (ne pas copier, juste s'en inspirer) :
{{jobDescription}}

INTITUL√â : {{jobTitle}}
ENTREPRISE : {{companyName}}
`.trim();

const TEMPLATE_LETTER_PITCH_EN = `
You are a senior recruiter and career coach.

Return STRICTLY valid JSON:
{ "coverLetterBody": "string", "pitch": "string" }

COVER LETTER RULES (coverLetterBody):
- ONLY the BODY (no header, no subject, no greeting, no signature).
- 3 to 4 paragraphs separated by ONE blank line.
- Length: 220 to 320 words.
- Professional, concrete, no fluff.
- Explicitly reference 2 to 3 candidate experiences (impact / responsibilities) using ONLY tools already present in the profile.
- Do not invent facts, companies, tools, numbers.
- Do NOT copy the job description: no more than 10‚Äì12 consecutive identical words.
- Ignore any job-board UI fragments pasted from Indeed/LinkedIn such as:
  ‚ÄúProfile information‚Äù, ‚ÄúMatch between‚Ä¶‚Äù, ‚ÄúJob details‚Äù, ‚ÄúSkills‚Äù, ‚ÄúEducation‚Äù, etc.
- Use ONLY the candidate profile and the job description (as hints).

PITCH RULES:
- 2 to 4 sentences max.
- Specific to the role and the company.
- Do not invent.

CANDIDATE PROFILE (source of truth):
{{cvText}}

JOB DESCRIPTION (do not copy; use as hints):
{{jobDescription}}

JOB TITLE: {{jobTitle}}
COMPANY: {{companyName}}
`.trim();

/**
 * ‚úÖ CV tailoring (optionnel) : r√©sume + comp√©tences cibl√©es
 * -> ne change PAS les exp√©riences, juste aide √† "restructurer" le haut du CV.
 */
const TEMPLATE_CV_TAILOR_FR = `
Tu es un expert CV (recruteur senior).

Retourne STRICTEMENT ce JSON :
{
  "tailoredSummary": "string",
  "tailoredKeySkills": ["string", "..."]
}

R√àGLES :
- tailoredSummary : 3 √† 5 lignes max, sp√©cifique au poste.
- tailoredKeySkills : 8 √† 14 √©l√©ments max, UNIQUEMENT des comp√©tences/outils pr√©sents dans le profil candidat.
- Ne pas inventer.
- Base-toi UNIQUEMENT sur le profil candidat + la fiche de poste.

INTITUL√â : {{jobTitle}}
ENTREPRISE : {{companyName}}

FICHE DE POSTE :
{{jobDescription}}

PROFIL CANDIDAT :
{{cvText}}
`.trim();

const TEMPLATE_CV_TAILOR_EN = `
You are a senior recruiter and CV expert.

Return STRICTLY this JSON:
{
  "tailoredSummary": "string",
  "tailoredKeySkills": ["string", "..."]
}

RULES:
- tailoredSummary: 3 to 5 lines max, specific to the job.
- tailoredKeySkills: 8 to 14 items max, ONLY skills/tools that exist in the candidate profile.
- Do not invent.
- Use ONLY the candidate profile and the job description.

JOB TITLE: {{jobTitle}}
COMPANY: {{companyName}}

JOB DESCRIPTION:
{{jobDescription}}

CANDIDATE PROFILE:
{{cvText}}
`.trim();

function normalizeLang(langRaw) {
  const l = String(langRaw || "fr").toLowerCase();
  return l.startsWith("en") ? "en" : "fr";
}

function fillTemplate(template, vars) {
  return template.replace(/\{\{(\w+)\}\}/g, (_, k) =>
    String(vars && Object.prototype.hasOwnProperty.call(vars, k) ? vars[k] : "")
  );
}

function buildLetterAndPitchPrompt({ lang, cvText, jobDescription, jobTitle, companyName }) {
  const L = normalizeLang(lang);
  const tpl = L === "en" ? TEMPLATE_LETTER_PITCH_EN : TEMPLATE_LETTER_PITCH_FR;

  return fillTemplate(tpl, {
    cvText: cvText || "",
    jobDescription: sanitizeJobDescription(jobDescription) || "‚Äî",
    jobTitle: jobTitle || (L === "en" ? "the role" : "le poste"),
    companyName: companyName || (L === "en" ? "your company" : "votre entreprise"),
  });
}

function buildCvTailorPrompt({ lang, cvText, jobDescription, jobTitle, companyName }) {
  const L = normalizeLang(lang);
  const tpl = L === "en" ? TEMPLATE_CV_TAILOR_EN : TEMPLATE_CV_TAILOR_FR;

  return fillTemplate(tpl, {
    cvText: cvText || "",
    jobDescription: sanitizeJobDescription(jobDescription) || "‚Äî",
    jobTitle: jobTitle || (L === "en" ? "the role" : "le poste"),
    companyName: companyName || (L === "en" ? "your company" : "votre entreprise"),
  });
}

// =============================
// ‚úÖ Nettoyage jobDescription (HTML / UI)
// =============================
function decodeHtmlEntities(input) {
  let s = String(input || "");
  s = s
    .replace(/&nbsp;/gi, " ")
    .replace(/&amp;/gi, "&")
    .replace(/&quot;/gi, '"')
    .replace(/&#39;/gi, "'")
    .replace(/&lt;/gi, "<")
    .replace(/&gt;/gi, ">");

  s = s.replace(/&#(\d+);/g, (_, n) => {
    const code = parseInt(n, 10);
    return Number.isFinite(code) ? String.fromCharCode(code) : "";
  });
  s = s.replace(/&#x([0-9a-f]+);/gi, (_, n) => {
    const code = parseInt(n, 16);
    return Number.isFinite(code) ? String.fromCharCode(code) : "";
  });

  return s;
}

function stripHtmlTags(input) {
  let s = String(input || "");
  s = s.replace(/<script[\s\S]*?<\/script>/gi, " ");
  s = s.replace(/<style[\s\S]*?<\/style>/gi, " ");
  s = s.replace(/<\/?[^>]+>/g, " ");
  return s;
}

function sanitizeJobDescription(raw) {
  let t = String(raw || "");
  if (!t.trim()) return "";

  t = decodeHtmlEntities(t);
  t = stripHtmlTags(t);

  t = t.replace(/\r/g, "\n");
  t = t.replace(/[ \t]+/g, " ");
  t = t.replace(/\n{3,}/g, "\n\n").trim();

  // Supprime titres trop "coll√©s"
  t = t.replace(/^\s*(description du poste|job description)\s*:?/gim, "").trim();

  const cutPatterns = [
    /informations sur le profil/i,
    /correspondance entre/i,
    /d[√©e]tails de l['‚Äô]emploi/i,
    /^\s*comp[√©e]tences\s*$/im,
    /^\s*formation\s*$/im,
    /avez-vous de l['‚Äô]exp[√©e]rience/i,
    /^\s*avantages\s*$/im,
    /type d['‚Äô]emploi/i,
    /r[√©e]mun[√©e]ration/i,
    /lieu du poste/i,
    /mutuelle/i,
    /prime/i,
    /accord d['‚Äô]int[√©e]ressement/i,
  ];

  let cutAt = -1;
  for (const re of cutPatterns) {
    const idx = t.search(re);
    if (idx !== -1) cutAt = cutAt === -1 ? idx : Math.min(cutAt, idx);
  }
  if (cutAt !== -1) t = t.slice(0, cutAt).trim();

  // limite (√©vite que l'IA recopie)
  if (t.length > 1600) t = t.slice(0, 1600).trim() + "‚Ä¶";
  return t;
}

// =============================
// ‚úÖ Normalisation lettre : pas de double/triple signature
// =============================
function escapeRegExp(s) {
  return String(s).replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
}

function stripMarkdownAndBullets(text) {
  let t = String(text || "").replace(/\r/g, "").trim();
  if (!t) return "";

  // remove code fences
  if (t.startsWith("```")) {
    t = t.replace(/^```[a-zA-Z]*\s*/, "").replace(/```$/g, "").trim();
  }

  // light markdown cleanup
  t = t.replace(/\*\*(.*?)\*\*/g, "$1").replace(/__(.*?)__/g, "$1").replace(/`([^`]+)`/g, "$1");

  // bullets at start of lines
  t = t
    .split("\n")
    .map((line) => line.replace(/^\s*[-‚Ä¢]\s+/, "").trimEnd())
    .join("\n")
    .trim();

  // shrink huge blank blocks
  t = t.replace(/\n{3,}/g, "\n\n").trim();

  return t;
}

// ‚úÖ PATCH: looksLikeFullLetter() FR corrig√© (pas de \b autour de la virgule)
function looksLikeFullLetter(text, lang) {
  const t = String(text || "").trim();
  if (!t) return false;

  if (lang === "en") {
    return (
      /^dear\s+/i.test(t) ||
      /sincerely,/i.test(t) ||
      /kind regards,/i.test(t) ||
      /best regards,/i.test(t)
    );
  }

  return (
    /^madame,\s+monsieur,/i.test(t) ||
    /^bonjour\s+/i.test(t) ||
    /cordialement,/i.test(t) ||
    /bien cordialement,/i.test(t) ||
    /salutations,/i.test(t)
  );
}

/**
 * ‚úÖ D√©dup bloc signature √† la fin (closing + name r√©p√©t√©s)
 */
function dedupeClosingBlockAtEnd(text, lang, candidateName) {
  const L = normalizeLang(lang);
  const name = String(candidateName || "").trim();
  if (!text) return "";

  const closing = L === "en" ? "Sincerely," : "Cordialement,";
  const closingEsc = escapeRegExp(closing);

  let t = String(text).replace(/\r/g, "").trim();

  // supprime r√©p√©titions exactes de blocs de fin
  if (name) {
    const nameEsc = escapeRegExp(name);
    t = t.replace(
      new RegExp(`(?:\\n\\s*${closingEsc}\\s*\\n\\s*${nameEsc}\\s*){2,}$`, "i"),
      `\n\n${closing}\n${name}`
    );
  } else {
    t = t.replace(new RegExp(`(?:\\n\\s*${closingEsc}\\s*){2,}$`, "i"), `\n\n${closing}`);
  }

  t = t.replace(/\n{3,}/g, "\n\n").trim();
  return t;
}

/**
 * Transforme un "body only" en lettre compl√®te :
 * - Ajoute greeting
 * - Ajoute signature
 * - ‚úÖ D√©duplique si d√©j√† pr√©sent
 */
function ensureFullLetterFormat({ letter, lang, candidateName }) {
  let t = stripMarkdownAndBullets(letter || "");
  if (!t) return "";

  const L = normalizeLang(lang);
  const name = (candidateName || (L === "en" ? "The candidate" : "Le candidat")).trim();

  // greeting
  if (!looksLikeFullLetter(t, L)) {
    const greeting = L === "en" ? "Dear Hiring Manager," : "Madame, Monsieur,";
    t = `${greeting}\n\n${t}`;
  }

  // closing
  const closing = L === "en" ? "Sincerely," : "Cordialement,";
  const closingEsc = escapeRegExp(closing);

  // ‚úÖ FIX: no \b around comma
  const hasClosing = new RegExp(`(?:^|\\n)\\s*${closingEsc}\\s*(?:\\n|$)`, "i").test(t);

  if (!hasClosing) {
    t = `${t}\n\n${closing}\n${name}`;
  } else {
    // If closing exists but no name right after, add it
    const lines = t.split("\n");
    for (let i = 0; i < lines.length; i++) {
      if (lines[i].trim().toLowerCase() === closing.toLowerCase()) {
        const next = (lines[i + 1] || "").trim();
        if (!next) lines[i + 1] = name;
        break;
      }
    }
    t = lines.join("\n");
  }

  // ‚úÖ De-dup repeated closing+name at end
  t = dedupeClosingBlockAtEnd(t, L, name);
  return t;
}

// =============================
// ‚úÖ Nettoyage "body LM" (anti header/greeting/signature doubl√©s)
// =============================
function sanitizeLmBodyOnly(raw, lang, candidateName) {
  const L = normalizeLang(lang);
  const name = String(candidateName || "").trim();
  let t = stripMarkdownAndBullets(raw || "");
  if (!t) return "";

  // supprime tags body si jamais
  t = t.replace(/<\/?body>/gi, "").trim();

  // Supprime lignes d'en-t√™te possibles (Objet / Subject)
  t = t.replace(/^\s*(objet|subject)\s*:\s*.*$/gim, "").trim();

  // Supprime salutations si pr√©sentes
  if (L === "fr") {
    t = t.replace(/^\s*madame,\s+monsieur,?\s*/i, "").trim();
    t = t.replace(/^\s*(madame|monsieur)\s*,?\s*(monsieur|madame)?\s*,?\s*$/i, "").trim();
  } else {
    t = t.replace(/^\s*dear\s+.*,\s*/i, "").trim();
  }

  // Supprime closing + tout ce qui suit (souvent signature)
  const closings =
    L === "fr"
      ? ["cordialement,", "bien cordialement,", "salutations,", "respectueusement,"]
      : ["sincerely,", "kind regards,", "best regards,"];

  for (const c of closings) {
    const cEsc = escapeRegExp(c);
    t = t.replace(new RegExp(`\\n\\s*${cEsc}[\\s\\S]*$`, "i"), "").trim();
  }

  // supprime une signature finale = nom seul sur 1 ligne
  if (name) {
    const nEsc = escapeRegExp(name);
    t = t.replace(new RegExp(`\\n\\s*${nEsc}\\s*$`, "i"), "").trim();
  }

  t = t.replace(/\n{3,}/g, "\n\n").trim();
  return t;
}

// ‚úÖ PATCH: Nettoyage "texte brut mod√®le" (anti HTML/parasites + <br> + tags r√©siduels)
function sanitizeLmBodyFromModel(raw) {
  if (!raw) return "";
  return String(raw)
    .replace(/\r/g, "")
    .replace(/<br\s*\/?>/gi, "\n") // ‚úÖ important
    .replace(/<\/?p>/gi, "")
    .replace(/<\/?body>/gi, "")
    .replace(/^\s*<body>\s*$/gim, "")
    .replace(/^\s*<\/body>\s*$/gim, "")
    .replace(/^\s*body\s*$/gim, "")
    .replace(/<\/?[^>]+>/g, "") // ‚úÖ supprime HTML r√©siduel
    .replace(/^\s*aper√ßu\b.*$/gim, "") // "Aper√ßu de la lettre..."
    .replace(/\[[^\]]*\]/g, "")
    .replace(/\*+/g, "")
    .replace(/^-{2,}.*$/gmi, "")
    .replace(/^\s*(note|remarque|important|disclaimer|attention|nb)\b.*$/gmi, "")
    .replace(/^\s*objet\s*:.*$/gmi, "")
    .replace(/^\s*(madame|monsieur|dear)[^\n]*$/gmi, "")
    .replace(/[‚Äú‚Äù¬´¬ª]/g, "")
    .replace(/^\s*"+|"+\s*$/gm, "")
    .replace(/\s"+/g, " ")
    .replace(/["+]\s*/g, " ")
    .replace(/[ \t]+\n/g, "\n")
    .replace(/\n{3,}/g, "\n\n")
    .trim();
}

// =============================
// ‚úÖ Date FR/EN (timezone Europe/Paris)
// =============================
function formatLetterDateLine({ city, lang }) {
  const L = normalizeLang(lang);
  const tz = "Europe/Paris";
  const d = new Date();

  if (L === "fr") {
    const dateFr = new Intl.DateTimeFormat("fr-FR", {
      timeZone: tz,
      day: "numeric",
      month: "long",
      year: "numeric",
    }).format(d);

    const c = String(city || "").trim();
    return c ? `√Ä ${c}, ${dateFr}` : `Le ${dateFr}`;
  }

  const dateEn = new Intl.DateTimeFormat("en-GB", {
    timeZone: tz,
    day: "numeric",
    month: "long",
    year: "numeric",
  }).format(d);

  const c = String(city || "").trim();
  return c ? `${c}, ${dateEn}` : `${dateEn}`;
}

// =============================
// ‚úÖ Sanitize company name header (√©vite doublons "Service Recrutement ...")
// =============================
function sanitizeCompanyNameForHeader(companyName) {
  let c = String(companyName || "").replace(/\r/g, "").trim();
  if (!c) return "";
  // supprime phrases parasites possibles
  c = c.replace(/\s+/g, " ").trim();
  c = c.replace(/^(service recrutement|recruitment team)\s*[-:|]?\s*/i, "").trim();
  // supprime si l'utilisateur a coll√© deux fois
  c = c.replace(/(.+?)\s+\1$/i, "$1").trim();
  return c;
}

function uniqueLines(lines) {
  const out = [];
  const seen = new Set();
  for (const l of lines) {
    const s = String(l || "").trim();
    if (!s) continue;
    const k = s.toLowerCase();
    if (seen.has(k)) continue;
    seen.add(k);
    out.push(s);
  }
  return out;
}

// =============================
// ‚úÖ Compose lettre "style exemple" (en-t√™te + objet + salutation + body + signature)
// =============================
function composeFullCoverLetterDoc({ profile, jobTitle, companyName, lang, bodyOnly }) {
  const L = normalizeLang(lang);
  const p = profile || {};

  const fullName = String(p.fullName || "").trim() || (L === "en" ? "The candidate" : "Le candidat");
  const phone = String(p.phone || "").trim();
  const email = String(p.email || "").trim();
  const linkedin = String(p.linkedin || "").trim();
  const city = String(p.city || "").trim();

  const compRaw = String(companyName || "").trim() || (L === "en" ? "Your company" : "Votre entreprise");
  const comp = sanitizeCompanyNameForHeader(compRaw) || compRaw;

  const role = String(jobTitle || "").trim() || (L === "en" ? "the position" : "le poste");

  const headerLeft = uniqueLines([
    fullName,
    phone ? (L === "en" ? `Phone: ${phone}` : `${phone}`) : "",
    email ? (L === "en" ? `Email: ${email}` : `${email}`) : "",
    linkedin ? `LinkedIn: ${linkedin}` : "",
  ]).join("\n");

  const headerRightLines = uniqueLines([L === "en" ? "Recruitment Team" : "Service Recrutement", comp]);
  const headerRight = headerRightLines.join("\n");

  const dateLine = formatLetterDateLine({ city, lang: L });

  const subjectLine = L === "en" ? `Subject: Application for ${role}` : `Objet : Candidature au poste de ${role}`;

  const greeting = L === "en" ? "Dear Hiring Manager," : "Madame, Monsieur,";
  const closing = L === "en" ? "Sincerely," : "Cordialement,";

  const cleanBody = sanitizeLmBodyFromModel(String(bodyOnly || "")).trim();

  let doc = [
    headerLeft,
    "",
    headerRight,
    "",
    dateLine,
    "",
    subjectLine,
    "",
    greeting,
    "",
    cleanBody,
    "",
    closing,
    "",
    fullName,
  ]
    .join("\n")
    .replace(/\n{3,}/g, "\n\n")
    .trim();

  doc = dedupeClosingBlockAtEnd(doc, L, fullName);
  return doc;
}

// =============================
// ‚úÖ D√©tection lettre d√©j√† compl√®te format "exemple"
// =============================
function looksLikeFormattedLetterDoc(text) {
  const t = String(text || "").trim();
  if (!t) return false;

  const hasSubject = /(objet\s*:|subject\s*:)/i.test(t);
  const hasGreeting = /(madame,\s+monsieur,|dear\s+)/i.test(t);
  return hasSubject && hasGreeting;
}

// =============================
// reCAPTCHA Enterprise
// =============================
const recaptchaClient = new RecaptchaEnterpriseServiceClient();

function getRecaptchaConfig() {
  const cfg = (functions.config && functions.config() && functions.config().recaptcha) || {};

  const projectId = cfg.project_id || process.env.RECAPTCHA_PROJECT_ID || "";
  const siteKey = cfg.site_key || process.env.RECAPTCHA_SITE_KEY || "";
  const thresholdRaw = cfg.threshold || process.env.RECAPTCHA_THRESHOLD || "0.5";
  const threshold = Number(thresholdRaw);

  const bypassRaw = cfg.bypass || process.env.RECAPTCHA_BYPASS || "false";
  const bypass = String(bypassRaw).toLowerCase() === "true";

  // ‚úÖ action strict toggle (par d√©faut OFF pour √©viter les 403)
  const strictActionRaw = cfg.strict_action || process.env.RECAPTCHA_STRICT_ACTION || "false";
  const strictAction = String(strictActionRaw).toLowerCase() === "true";

  return {
    projectId,
    siteKey,
    threshold: Number.isFinite(threshold) ? threshold : 0.5,
    bypass,
    strictAction,
  };
}

function isEmulator() {
  return process.env.FUNCTIONS_EMULATOR === "true" || !!process.env.FIREBASE_EMULATOR_HUB;
}

function getClientIp(req) {
  const xf = req.headers["x-forwarded-for"];
  if (typeof xf === "string" && xf.trim()) return xf.split(",")[0].trim();

  const ip =
    req.ip ||
    (req.connection && req.connection.remoteAddress) ||
    (req.socket && req.socket.remoteAddress) ||
    "";
  return typeof ip === "string" ? ip : "";
}

// =============================
// AUTH helper (HTTP)
// =============================
function getBearerToken(req) {
  const h = req.headers["authorization"] || req.headers["Authorization"] || "";
  const s = typeof h === "string" ? h : Array.isArray(h) ? h[0] : "";
  if (!s) return "";
  if (s.startsWith("Bearer ")) return s.slice(7).trim();
  return "";
}

async function tryFirebaseUser(req) {
  const token = getBearerToken(req);
  if (!token) return null;
  try {
    const decoded = await admin.auth().verifyIdToken(token);
    return { uid: decoded.uid, email: decoded.email || "" };
  } catch {
    return null;
  }
}

async function requireFirebaseUser(req) {
  const token = getBearerToken(req);
  if (!token) {
    const err = new Error("MISSING_AUTH");
    err.code = "MISSING_AUTH";
    throw err;
  }
  try {
    const decoded = await admin.auth().verifyIdToken(token);
    return { uid: decoded.uid, email: decoded.email || "" };
  } catch (e) {
    const err = new Error("INVALID_AUTH");
    err.code = "INVALID_AUTH";
    throw err;
  }
}

async function verifyRecaptchaToken({ token, expectedAction, req }) {
  const { projectId, siteKey, threshold, bypass, strictAction } = getRecaptchaConfig();

  // ‚úÖ bypass en dev/emulator
  if (bypass && (isEmulator() || process.env.NODE_ENV !== "production")) {
    return { ok: true, bypass: true, score: null, threshold };
  }

  if (!projectId || !siteKey) {
    console.warn("reCAPTCHA non configur√© (project_id / site_key manquants) => bypass.");
    return { ok: true, bypass: true, score: null, threshold };
  }

  if (!token) return { ok: false, reason: "missing_token" };

  try {
    const userIp = getClientIp(req);
    const userAgent = String(req.headers["user-agent"] || "");

    const request = {
      parent: `projects/${projectId}`,
      assessment: {
        event: {
          token,
          siteKey,
          expectedAction: expectedAction || undefined,
          userAgent: userAgent || undefined,
          userIpAddress: userIp || undefined,
        },
      },
    };

    const [response] = await recaptchaClient.createAssessment(request);

    const tokenProps = response && response.tokenProperties;
    if (!tokenProps || tokenProps.valid !== true) {
      return {
        ok: false,
        reason: "invalid_token",
        invalidReason: tokenProps ? tokenProps.invalidReason : null,
      };
    }

    // ‚úÖ action mismatch : bloquant seulement si strictAction=true
    if (expectedAction && tokenProps.action && String(tokenProps.action) !== String(expectedAction)) {
      if (strictAction) {
        return {
          ok: false,
          reason: "action_mismatch",
          got: tokenProps.action,
          expected: expectedAction,
        };
      }
      console.warn("reCAPTCHA action mismatch (non bloquant):", {
        got: tokenProps.action,
        expected: expectedAction,
      });
    }

    const score =
      response && response.riskAnalysis && typeof response.riskAnalysis.score === "number"
        ? response.riskAnalysis.score
        : null;

    if (typeof score === "number" && score < threshold) {
      return { ok: false, reason: "low_score", score, threshold };
    }

    return { ok: true, score, threshold };
  } catch (err) {
    console.error("Erreur reCAPTCHA Enterprise:", err);
    return { ok: false, reason: "recaptcha_error" };
  }
}

async function enforceRecaptchaOrReturn(req, res, expectedAction) {
  // ‚úÖ Bypass si l'utilisateur est authentifi√© (r√©duit les 403 en prod)
  const authed = await tryFirebaseUser(req);
  if (authed && authed.uid) {
    return null;
  }

  const token =
    (req.body && (req.body.recaptchaToken || req.body.token)) ||
    req.headers["x-recaptcha-token"] ||
    req.headers["x-recaptchatoken"] ||
    "";

  const actionFromBody = (req.body && (req.body.recaptchaAction || req.body.actionRecaptcha || req.body.action)) || "";

  const action = expectedAction || actionFromBody || "";

  const result = await verifyRecaptchaToken({
    token: typeof token === "string" ? token : String(token),
    expectedAction: typeof action === "string" ? action : String(action),
    req,
  });

  if (!result.ok) return res.status(403).json({ error: "reCAPTCHA failed", details: result });
  return null;
}

// =============================
// CORS
// =============================
function getAllowedOrigins() {
  const raw =
    process.env.CORS_ALLOW_ORIGINS ||
    (functions.config &&
      functions.config() &&
      functions.config().app &&
      functions.config().app.cors_allow_origins) ||
    "";
  return raw
    .split(",")
    .map((s) => s.trim())
    .filter(Boolean);
}

function setCors(req, res) {
  const origin = req.headers.origin;
  const allowlist = getAllowedOrigins();

  if (origin && allowlist.length > 0) {
    if (allowlist.includes(origin)) {
      res.set("Access-Control-Allow-Origin", origin);
      res.set("Vary", "Origin");
    }
  } else {
    res.set("Access-Control-Allow-Origin", "*");
  }

  res.set("Access-Control-Allow-Methods", "POST, OPTIONS");
  res.set(
    "Access-Control-Allow-Headers",
    "Content-Type, Authorization, Polar-Signature, polar-signature, X-Recaptcha-Token, x-recaptcha-token"
  );
}

// =============================
// Helpers (profil, contrat)
// =============================
function normalizeString(str) {
  if (!str) return "";
  return str
    .toString()
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .toLowerCase();
}

function inferContractTypeStandard(raw) {
  const norm = normalizeString(raw);
  if (!norm) return "";

  if (norm.includes("alternance") || norm.includes("apprentissage")) return "Alternance";
  if (norm.includes("stage") || norm.includes("intern")) return "Stage";
  if (norm.includes("freelance") || norm.includes("independant") || norm.includes("auto-entrepreneur"))
    return "Freelance";
  if (norm.includes("cdd") || norm.includes("duree determinee") || norm.includes("dur√©e determinee"))
    return "CDD";
  if (norm.includes("cdi") || norm.includes("duree indeterminee") || norm.includes("dur√©e indeterminee"))
    return "CDI";
  if (norm.includes("interim") || norm.includes("int√©rim")) return "Int√©rim";

  return "";
}

// =============================
// Admin helpers
// =============================
function assertIsAdmin(context) {
  if (!context.auth) {
    throw new functions.https.HttpsError("unauthenticated", "Tu dois √™tre connect√©.");
  }

  const token = context.auth.token || {};
  const isAdmin = token.isAdmin === true || token.email === "aakane0105@gmail.com";

  if (!isAdmin) {
    throw new functions.https.HttpsError("permission-denied", "Acc√®s r√©serv√© √† l'administrateur.");
  }
}

exports.setAdminRole = functions
  .region("europe-west1")
  .https.onCall(async (data, context) => {
    assertIsAdmin(context);

    const uid = data && data.uid;
    const isAdmin = data && data.isAdmin;

    if (!uid || typeof isAdmin !== "boolean") {
      throw new functions.https.HttpsError("invalid-argument", "uid (string) et isAdmin (boolean) sont requis.");
    }

    await admin.auth().setCustomUserClaims(uid, { isAdmin });
    return { success: true, uid, isAdmin };
  });

exports.adminUpdateCredits = functions
  .region("europe-west1")
  .https.onCall(async (data, context) => {
    assertIsAdmin(context);

    const userId = data && data.userId;
    const credits = data && data.credits;

    if (!userId || typeof credits !== "number") {
      throw new functions.https.HttpsError("invalid-argument", "userId (string) et credits (number) sont requis.");
    }

    const userRef = db.collection("users").doc(userId);

    await userRef.set({ credits, updatedAt: admin.firestore.FieldValue.serverTimestamp() }, { merge: true });

    return { success: true, userId, credits };
  });

// ======================================================
// ‚úÖ JSON helpers (robuste) ‚Äî FIX AI_BAD_JSON
// ======================================================
function normalizeSmartQuotes(s) {
  return String(s || "")
    .replace(/[‚Äú‚Äù]/g, '"')
    .replace(/[‚Äò‚Äô]/g, "'");
}

function stripCodeFences(s) {
  let t = String(s || "").trim();
  if (t.startsWith("```")) {
    t = t.replace(/^```[a-zA-Z]*\s*/, "");
    t = t.replace(/```$/g, "");
  }
  return t.trim();
}

function extractFirstJsonBlock(s) {
  const text = String(s || "");
  const startIdx = text.search(/[\{\[]/);
  if (startIdx === -1) return null;

  const stack = [];
  for (let i = startIdx; i < text.length; i++) {
    const ch = text[i];
    if (ch === "{" || ch === "[") stack.push(ch);
    else if (ch === "}" || ch === "]") {
      const last = stack.pop();
      if (!last) return null;
      if ((last === "{" && ch !== "}") || (last === "[" && ch !== "]")) return null;
      if (stack.length === 0) return text.slice(startIdx, i + 1);
    }
  }
  return null;
}

function repairJsonString(s) {
  let t = normalizeSmartQuotes(s);
  t = t.replace(/,\s*([}\]])/g, "$1"); // trailing commas
  return t.trim();
}

function safeJsonParseFromModel(raw) {
  let t = stripCodeFences(raw);
  t = repairJsonString(t);

  try {
    return JSON.parse(t);
  } catch {}

  const extracted = extractFirstJsonBlock(t) || extractFirstJsonBlock(raw);
  if (extracted) {
    const fixed = repairJsonString(stripCodeFences(extracted));
    try {
      return JSON.parse(fixed);
    } catch {}
  }
  return null;
}

// =============================
// Gemini helpers
// =============================
async function callGeminiText(prompt, apiKey, temperature = 0.7, maxOutputTokens = 2400, responseMimeType = null) {
  if (!fetchFn) throw new Error("fetch indisponible. Mets Node 18+.");

  const endpoint = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent";

  const generationConfig = { temperature, maxOutputTokens };
  if (responseMimeType) generationConfig.response_mime_type = responseMimeType;

  const body = {
    contents: [{ role: "user", parts: [{ text: prompt }] }],
    generationConfig,
  };

  const resp = await fetchFn(endpoint, {
    method: "POST",
    headers: { "Content-Type": "application/json", "x-goog-api-key": apiKey },
    body: JSON.stringify(body),
  });

  if (!resp.ok) {
    const errorText = await resp.text();
    throw new Error("Erreur Gemini (texte): " + errorText);
  }

  const data = await resp.json();
  const parts = data?.candidates?.[0]?.content?.parts || [];
  const text = parts
    .map((p) => (typeof p.text === "string" ? p.text : ""))
    .join("\n")
    .trim();

  if (!text) throw new Error("R√©ponse Gemini (texte) vide");
  return text;
}

async function callGeminiJson(prompt, apiKey, temperature = 0.6, maxOutputTokens = 2200) {
  const raw = await callGeminiText(prompt, apiKey, temperature, maxOutputTokens, "application/json");
  const parsed = safeJsonParseFromModel(raw);
  if (parsed === null || parsed === undefined || typeof parsed !== "object") {
    const err = new Error("AI_BAD_JSON");
    err.code = "AI_BAD_JSON";
    err.raw = raw;
    throw err;
  }
  return parsed;
}

// =============================
// callGeminiWithCv (PDF->JSON)
// =============================
async function callGeminiWithCv(base64Pdf, apiKey) {
  if (!fetchFn) throw new Error("fetch indisponible. Mets Node 18+.");

  const endpoint = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent";

  const body = {
    contents: [
      {
        role: "user",
        parts: [
          { inline_data: { mime_type: "application/pdf", data: base64Pdf } },
          {
            text: `Lis ce CV et renvoie STRICTEMENT un JSON valide avec exactement ce sch√©ma :

{
  "fullName": string,
  "email": string,
  "phone": string,
  "linkedin": string,
  "profileSummary": string,

  "city": string,
  "address": string,

  "contractType": string,
  "contractTypeStandard": string,
  "contractTypeFull": string,
  "primaryDomain": string,
  "secondaryDomains": string[],
  "skills": {
    "sections": [
      { "title": string, "items": string[] }
    ],
    "tools": string[]
  },
  "softSkills": string[],
  "experiences": [
    { "company": string, "role": string, "dates": string, "bullets": string[] }
  ],
  "education": [
    { "school": string, "degree": string, "dates": string }
  ],
  "educationShort": string[],
  "certs": string,
  "langLine": string,
  "hobbies": string[],

  "drivingLicense": string,
  "vehicle": string
}

R√àGLES IMPORTANTES :
- Ne pas inventer.
- Si une info est absente -> "" ou [].
- RENVOIE UNIQUEMENT ce JSON, sans texte autour.
`.trim(),
          },
        ],
      },
    ],
    generationConfig: { response_mime_type: "application/json" },
  };

  const resp = await fetchFn(endpoint, {
    method: "POST",
    headers: { "Content-Type": "application/json", "x-goog-api-key": apiKey },
    body: JSON.stringify(body),
  });

  if (!resp.ok) {
    const errorText = await resp.text();
    throw new Error("Erreur Gemini: " + errorText);
  }

  const data = await resp.json();

  let parsed = null;
  const text = data?.candidates?.[0]?.content?.parts?.[0]?.text;

  if (typeof text === "string" && text.trim()) {
    parsed = safeJsonParseFromModel(text);
    if (!parsed) {
      console.error("JSON Gemini invalide dans le champ text:", text);
      throw new Error("JSON Gemini invalide (Parsing text) : " + text);
    }
  } else {
    parsed = data;
  }

  let sectionsRaw = Array.isArray(parsed?.skills?.sections) ? parsed.skills.sections : [];
  let tools = Array.isArray(parsed?.skills?.tools) ? parsed.skills.tools : [];
  let softSkillsArr = Array.isArray(parsed?.softSkills) ? parsed.softSkills : [];

  const softSeen = new Set();
  softSkillsArr = softSkillsArr
    .filter((s) => typeof s === "string")
    .map((s) => s.trim())
    .filter((s) => {
      const key = s.toLowerCase();
      if (!s || softSeen.has(key)) return false;
      softSeen.add(key);
      return true;
    });

  if (softSkillsArr.length > 0) {
    let idx = sectionsRaw.findIndex(
      (sec) => sec && typeof sec.title === "string" && /soft|transversal|comportement|relationnel/i.test(sec.title)
    );

    if (idx === -1) {
      sectionsRaw.push({ title: "Soft skills", items: softSkillsArr });
    } else {
      const items = Array.isArray(sectionsRaw[idx].items) ? sectionsRaw[idx].items : [];
      const seenLocal = new Set(items.filter((x) => typeof x === "string").map((x) => x.toLowerCase().trim()));
      sectionsRaw[idx].items = [...items, ...softSkillsArr.filter((s) => !seenLocal.has(s.toLowerCase().trim()))];
    }
  }

  const sections = sectionsRaw
    .map((sec) => {
      const seen = new Set();
      const items = Array.isArray(sec.items) ? sec.items : [];
      const cleanItems = [];
      for (const raw of items) {
        if (typeof raw !== "string") continue;
        const trimmed = raw.trim();
        const key = trimmed.toLowerCase();
        if (!trimmed || seen.has(key)) continue;
        seen.add(key);
        cleanItems.push(trimmed);
      }
      return {
        title: typeof sec.title === "string" ? sec.title.trim() : "",
        items: cleanItems,
      };
    })
    .filter((sec) => sec.title || sec.items.length);

  const cleanTools = [];
  const seenTools = new Set();
  for (const raw of tools) {
    if (typeof raw !== "string") continue;
    const trimmed = raw.trim();
    const key = trimmed.toLowerCase();
    if (!trimmed || seenTools.has(key)) continue;
    seenTools.add(key);
    cleanTools.push(trimmed);
  }
  tools = cleanTools;

  const sectionItemSet = new Set();
  sections.forEach((sec) => sec.items.forEach((it) => sectionItemSet.add(String(it).toLowerCase())));
  tools = tools.filter((t) => !sectionItemSet.has(String(t).toLowerCase()));

  const contractTypeFull = parsed?.contractTypeFull || parsed?.contractType || "";
  let contractTypeStandard = parsed?.contractTypeStandard || "";
  if (!contractTypeStandard) contractTypeStandard = inferContractTypeStandard(contractTypeFull);
  const contractTypeFinal = contractTypeStandard || contractTypeFull || "";

  return {
    fullName: parsed?.fullName || "",
    email: parsed?.email || "",
    phone: parsed?.phone || "",
    linkedin: parsed?.linkedin || "",
    profileSummary: parsed?.profileSummary || "",
    city: parsed?.city || "",
    address: parsed?.address || "",
    contractType: contractTypeFinal,
    contractTypeStandard,
    contractTypeFull,
    primaryDomain: parsed?.primaryDomain || "",
    secondaryDomains: Array.isArray(parsed?.secondaryDomains) ? parsed.secondaryDomains : [],
    softSkills: softSkillsArr,
    drivingLicense: parsed?.drivingLicense || "",
    vehicle: parsed?.vehicle || "",
    skills: { sections, tools },
    experiences: Array.isArray(parsed?.experiences) ? parsed.experiences : [],
    education: Array.isArray(parsed?.education) ? parsed.education : [],
    educationShort: Array.isArray(parsed?.educationShort) ? parsed.educationShort : [],
    certs: parsed?.certs || "",
    langLine: parsed?.langLine || "",
    hobbies: Array.isArray(parsed?.hobbies) ? parsed.hobbies : [],
  };
}

// =============================
// extractProfile (reCAPTCHA ou auth bypass)
// =============================
exports.extractProfile = functions
  .runWith({ secrets: ["GEMINI_API_KEY"] })
  .region("europe-west1")
  .https.onRequest(async (req, res) => {
    setCors(req, res);

    if (req.method === "OPTIONS") return res.status(204).send("");
    if (req.method !== "POST") return res.status(405).json({ error: "M√©thode non autoris√©e" });
    if (!req.is("application/json")) return res.status(400).json({ error: "Content-Type invalide. Envoie du JSON." });

    const deny = await enforceRecaptchaOrReturn(req, res, "extract_profile");
    if (deny) return;

    try {
      const base64Pdf = req.body?.base64Pdf;
      if (!base64Pdf) return res.status(400).json({ error: "Champ 'base64Pdf' manquant." });

      const GEMINI_API_KEY = process.env.GEMINI_API_KEY;

      if (!GEMINI_API_KEY) {
        return res.status(500).json({
          error: "Cl√© Gemini manquante c√¥t√© serveur. Configure le secret GEMINI_API_KEY.",
        });
      }

      const profile = await callGeminiWithCv(base64Pdf, GEMINI_API_KEY);
      return res.status(200).json(profile);
    } catch (err) {
      console.error("Erreur analyse CV :", err);
      const msg = String(err?.message || "");
      return res.status(500).json({
        error: msg.startsWith("Erreur Gemini:") ? msg : "Erreur pendant l'analyse du CV.",
      });
    }
  });

// =============================
// Build profile context for IA
// =============================
function buildProfileContextForIA(profile) {
  const p = profile || {};

  let skillsArr;
  if (Array.isArray(p.skills)) {
    skillsArr = p.skills;
  } else if (p.skills && typeof p.skills === "object") {
    skillsArr = [];
    if (Array.isArray(p.skills.sections)) {
      p.skills.sections.forEach((sec) => {
        if (Array.isArray(sec.items)) skillsArr = skillsArr.concat(sec.items);
      });
    }
    if (Array.isArray(p.skills.tools)) skillsArr = skillsArr.concat(p.skills.tools);
  } else {
    skillsArr = [];
  }

  const skillsStr = (skillsArr || []).join(", ");

  const expStr = Array.isArray(p.experiences)
    ? p.experiences
        .map(
          (e) =>
            `${e.role || e.title || ""} chez ${e.company || ""} (${e.dates || ""}): ${(e.bullets || []).join(" ")}`
        )
        .join("; \n")
    : "";

  const eduStr = Array.isArray(p.education)
    ? p.education
        .map((e) => `${e.degree || e.title || ""} - ${e.school || e.institution || ""} (${e.dates || ""})`)
        .join("; \n")
    : "";

  return `Nom: ${p.fullName || p.name || ""}
Contact: ${p.email || ""} | ${p.phone || ""} | ${p.linkedin || ""} | ${p.city || ""}
R√©sum√© de profil: ${p.profileSummary || p.summary || ""}
Comp√©tences: ${skillsStr}
Exp√©riences:
${expStr}
Formations:
${eduStr}
Certifications: ${p.certs || ""}
Langues: ${p.langLine || p.lang || ""}`.trim();
}

// =============================
// ‚úÖ CV tailoring via IA (optionnel)
// =============================
async function tailorCvForJob({ profile, jobTitle, companyName, jobDescription, lang, apiKey }) {
  try {
    const cvText = buildProfileContextForIA(profile);

    const prompt = buildCvTailorPrompt({
      lang,
      cvText,
      jobTitle,
      companyName,
      jobDescription: sanitizeJobDescription(jobDescription),
    });

    const parsed = await callGeminiJson(prompt, apiKey, 0.4, 1200);

    const tailoredSummary = typeof parsed?.tailoredSummary === "string" ? parsed.tailoredSummary.trim() : "";
    const tailoredKeySkills = Array.isArray(parsed?.tailoredKeySkills)
      ? parsed.tailoredKeySkills
          .map((x) => String(x).trim())
          .filter(Boolean)
          .slice(0, 14)
      : [];

    return { tailoredSummary, tailoredKeySkills };
  } catch (e) {
    console.warn("tailorCvForJob (IA) failed:", e?.message || e);
    return { tailoredSummary: "", tailoredKeySkills: [] };
  }
}

// =============================
// PDF helpers (CV)
// =============================
async function createSimpleCvPdf(profile, options) {
  const {
    targetJob = "",
    lang = "fr",
    contract = "",
    jobLink = "",
    jobDescription = "",
    tailoredSummary = "",
    tailoredKeySkills = [],
  } = options || {};

  const p = profile || {};
  const pdfDoc = await PDFDocument.create();
  const page = pdfDoc.addPage([595.28, 841.89]); // A4
  const font = await pdfDoc.embedFont(StandardFonts.Helvetica);
  const fontBold = await pdfDoc.embedFont(StandardFonts.HelveticaBold);

  const { width, height } = page.getSize();
  const marginX = 50;
  let y = height - 60;

  function drawLine(text, size = 11, bold = false) {
    if (!text || y < 50) return;
    const f = bold ? fontBold : font;
    page.drawText(text, { x: marginX, y, size, font: f, color: rgb(0.1, 0.12, 0.16) });
    y -= size + 4;
  }

  function drawParagraph(text, size = 10) {
    if (!text) return;
    const f = font;
    const maxWidth = width - marginX * 2;
    const paragraphs = String(text).split(/\n{2,}/);

    for (const paragraph of paragraphs) {
      const words = paragraph.split(/\s+/);
      let line = "";

      for (const w of words) {
        const testLine = line ? line + " " + w : w;
        const testWidth = f.widthOfTextAtSize(testLine, size);
        if (testWidth > maxWidth) {
          if (y < 50) return;
          page.drawText(line, {
            x: marginX,
            y,
            size,
            font: f,
            color: rgb(0.1, 0.12, 0.16),
          });
          y -= size + 3;
          line = w;
        } else {
          line = testLine;
        }
      }

      if (line && y >= 50) {
        page.drawText(line, { x: marginX, y, size, font: f, color: rgb(0.1, 0.12, 0.16) });
        y -= size + 6;
      }
      y -= 2;
    }
  }

  function drawSectionTitle(title) {
    if (!title || y < 60) return;
    page.drawText(title, {
      x: marginX,
      y,
      size: 11,
      font: fontBold,
      color: rgb(0.08, 0.15, 0.45),
    });
    y -= 14;
  }

  function drawBullet(text, size = 9) {
    if (!text || y < 50) return;
    const f = font;
    const bulletX = marginX + 8;
    const maxWidth = width - marginX * 2 - 10;
    const words = String(text).split(/\s+/);
    let line = "";
    let firstLine = true;

    for (const w of words) {
      const testLine = line ? line + " " + w : w;
      const testWidth = f.widthOfTextAtSize(testLine, size);
      if (testWidth > maxWidth) {
        if (y < 50) return;
        page.drawText(firstLine ? "‚Ä¢ " + line : "  " + line, {
          x: bulletX,
          y,
          size,
          font: f,
          color: rgb(0.1, 0.12, 0.16),
        });
        y -= size + 3;
        line = w;
        firstLine = false;
      } else {
        line = testLine;
      }
    }

    if (line && y >= 50) {
      page.drawText(firstLine ? "‚Ä¢ " + line : "  " + line, {
        x: bulletX,
        y,
        size,
        font: f,
        color: rgb(0.1, 0.12, 0.16),
      });
      y -= size + 3;
    }
  }

  // Header
  drawLine(p.fullName || "", 16, true);
  const jobLine = targetJob || contract || p.contractType || (lang === "en" ? "Target position" : "Poste recherch√©");
  drawLine(jobLine, 11, false);

  const contactParts = [p.email || "", p.phone || "", p.city || "", p.linkedin || ""].filter(Boolean);
  if (contactParts.length) drawLine(contactParts.join(" ¬∑ "), 9, false);

  if (jobLink) drawLine((lang === "en" ? "Job link: " : "Lien de l'offre : ") + jobLink, 8, false);

  y -= 6;

  // Tailored summary first (if any), else profile summary
  const summaryToUse = tailoredSummary || p.profileSummary;
  if (summaryToUse) {
    drawSectionTitle(lang === "en" ? "Profile" : "Profil");
    drawParagraph(summaryToUse, 9.5);
    y -= 4;
  }

  if (Array.isArray(tailoredKeySkills) && tailoredKeySkills.length) {
    drawSectionTitle(lang === "en" ? "Targeted skills" : "Comp√©tences cibl√©es");
    drawParagraph(tailoredKeySkills.join(" ¬∑ "), 9);
    y -= 4;
  }

  if (p.skills && Array.isArray(p.skills.sections) && p.skills.sections.length) {
    drawSectionTitle(lang === "en" ? "Key skills" : "Comp√©tences cl√©s");
    p.skills.sections.forEach((sec) => {
      if (!sec || (!sec.title && !Array.isArray(sec.items))) return;
      if (sec.title) drawLine(sec.title, 9.5, true);
      if (Array.isArray(sec.items)) drawParagraph(sec.items.join(" ¬∑ "), 9);
      y -= 2;
    });
  }

  if (Array.isArray(p.experiences) && p.experiences.length) {
    drawSectionTitle(lang === "en" ? "Experience" : "Exp√©riences professionnelles");
    p.experiences.forEach((exp) => {
      if (y < 90) return;
      const header = [exp.role, exp.company].filter(Boolean).join(" ‚Äî ");
      if (header) drawLine(header, 10, true);
      if (exp.dates) drawLine(exp.dates, 8.5, false);
      if (Array.isArray(exp.bullets)) exp.bullets.slice(0, 4).forEach((b) => drawBullet(b, 8.5));
      y -= 4;
    });
  }

  if (Array.isArray(p.education) && p.education.length && y > 80) {
    drawSectionTitle(lang === "en" ? "Education" : "Formation");
    p.education.forEach((ed) => {
      if (y < 60) return;
      const header = [ed.degree, ed.school].filter(Boolean).join(" ‚Äî ");
      if (header) drawLine(header, 9.5, true);
      if (ed.dates) drawLine(ed.dates, 8.5, false);
      y -= 4;
    });
  }

  if (p.langLine && y > 60) {
    drawSectionTitle(lang === "en" ? "Languages" : "Langues");
    drawParagraph(p.langLine, 9);
  }

  if (Array.isArray(p.hobbies) && p.hobbies.length && y > 60) {
    drawSectionTitle(lang === "en" ? "Interests" : "Centres d'int√©r√™t");
    drawParagraph(p.hobbies.join(" ¬∑ "), 9);
  }

  const pdfBytes = await pdfDoc.save();
  return Buffer.from(pdfBytes);
}

// =============================
// PDF helper (Lettre)
// =============================
async function createLetterPdf(coverLetterFull, meta) {
  const { jobTitle = "", companyName = "", candidateName = "", lang = "fr" } = meta || {};

  // ‚úÖ d√©dup final avant rendu
  let letterText = String(coverLetterFull || "").trim();
  letterText = dedupeClosingBlockAtEnd(letterText, lang, candidateName);

  const pdfDoc = await PDFDocument.create();
  const page = pdfDoc.addPage([595.28, 841.89]); // A4
  const font = await pdfDoc.embedFont(StandardFonts.Helvetica);
  const fontBold = await pdfDoc.embedFont(StandardFonts.HelveticaBold);

  const { width, height } = page.getSize();
  const marginX = 60;
  let y = height - 70;

  function drawLine(text, size = 11, bold = false) {
    if (!text || y < 60) return;
    const f = bold ? fontBold : font;
    page.drawText(text, { x: marginX, y, size, font: f, color: rgb(0.15, 0.17, 0.23) });
    y -= size + 4;
  }

  function drawParagraph(text, size = 11) {
    if (!text) return;
    const f = font;
    const maxWidth = width - marginX * 2;
    const paragraphs = String(text).split(/\n{2,}/);

    for (const paragraph of paragraphs) {
      const words = paragraph.split(/\s+/);
      let line = "";

      for (const w of words) {
        const testLine = line ? line + " " + w : w;
        const testWidth = f.widthOfTextAtSize(testLine, size);
        if (testWidth > maxWidth) {
          if (y < 60) return;
          page.drawText(line, { x: marginX, y, size, font: f, color: rgb(0.15, 0.17, 0.23) });
          y -= size + 4;
          line = w;
        } else {
          line = testLine;
        }
      }

      if (line && y >= 60) {
        page.drawText(line, { x: marginX, y, size, font: f, color: rgb(0.15, 0.17, 0.23) });
        y -= size + 8;
      }
      y -= 4;
    }
  }

  const alreadyFormatted = looksLikeFormattedLetterDoc(letterText);

  if (!alreadyFormatted) {
    if (candidateName) drawLine(candidateName, 14, true);

    if (jobTitle || companyName) {
      const titleLine =
        lang === "en"
          ? `Application for ${jobTitle || "the position"} ‚Äì ${companyName || "Company"}`
          : `Candidature : ${jobTitle || "poste"} ‚Äì ${companyName || "Entreprise"}`;
      drawLine(titleLine, 11, false);
    }

    y -= 10;
  }

  drawParagraph(letterText, 11);

  const pdfBytes = await pdfDoc.save();
  return Buffer.from(pdfBytes);
}

// ======================================================
// Fallback lettre/pitch (BODY ONLY)
// ======================================================
function buildFallbackLetterAndPitchBody(profile, jobTitle, companyName, jobDescription, lang) {
  const p = profile || {};
  const companyLabel = companyName || (lang === "en" ? "your company" : "votre entreprise");
  const roleLabel = jobTitle || (lang === "en" ? "the role" : "le poste");
  const experiences = Array.isArray(p.experiences) ? p.experiences : [];

  const flatSkills = [];
  if (p.skills) {
    if (Array.isArray(p.skills)) flatSkills.push(...p.skills);
    else {
      if (Array.isArray(p.skills.sections)) {
        p.skills.sections.forEach((sec) => Array.isArray(sec.items) && flatSkills.push(...sec.items));
      }
      if (Array.isArray(p.skills.tools)) flatSkills.push(...p.skills.tools);
    }
  }

  const mainSkills = flatSkills
    .filter((x) => typeof x === "string")
    .map((x) => x.trim())
    .filter(Boolean)
    .slice(0, 8)
    .join(", ");

  const xp1 = experiences[0];
  const xp2 = experiences[1];

  function xpLineFr(xp) {
    if (!xp) return "";
    const company = xp.company || "";
    const role = xp.role || xp.title || "";
    const dates = xp.dates || "";
    const bullet = Array.isArray(xp.bullets) && xp.bullets.length ? xp.bullets[0] : "";
    const base = [role, company].filter(Boolean).join(" chez ");
    const meta = [dates].filter(Boolean).join(" ¬∑ ");
    const bulletPart = bullet ? ` (ex: ${bullet})` : "";
    return `${base}${meta ? ` ‚Äî ${meta}` : ""}${bulletPart}`;
  }

  function xpLineEn(xp) {
    if (!xp) return "";
    const company = xp.company || "";
    const role = xp.role || xp.title || "";
    const dates = xp.dates || "";
    const bullet = Array.isArray(xp.bullets) && xp.bullets.length ? xp.bullets[0] : "";
    const base = [role, company].filter(Boolean).join(" at ");
    const meta = [dates].filter(Boolean).join(" ¬∑ ");
    const bulletPart = bullet ? ` (e.g. ${bullet})` : "";
    return `${base}${meta ? ` ‚Äî ${meta}` : ""}${bulletPart}`;
  }

  const jdClean = sanitizeJobDescription(jobDescription || "");
  const hasJd = !!(jdClean && jdClean.trim());

  if (lang === "en") {
    const body = [
      `I am applying for the ${roleLabel} position at ${companyLabel}. My background has given me strong experience with ${
        mainSkills || "security, delivery, and collaboration"
      } and a practical, operational approach.`,
      "",
      xp1 || xp2
        ? `Recently, I worked on concrete projects such as: ${[xpLineEn(xp1), xpLineEn(xp2)].filter(Boolean).join(
            " | "
          )}.`
        : `In my recent roles, I delivered end-to-end tasks with a focus on reliability and security.`,
      "",
      hasJd
        ? `Your needs described in the job posting align with my skills and motivation. I am eager to contribute with pragmatic, maintainable improvements.`
        : `The responsibilities of this role align with my experience and my motivation to contribute.`,
      "",
      `I would be happy to discuss how I can contribute to your projects.`,
    ].join("\n");

    const pitch =
      (p.profileSummary && String(p.profileSummary).trim()) ||
      `Motivated candidate applying for ${roleLabel} at ${companyLabel}, with practical skills in ${
        mainSkills || "security and delivery"
      }.`;

    return { body, pitch };
  }

  const bodyFr = [
    `Je souhaite vous proposer ma candidature au poste de ${roleLabel} au sein de ${companyLabel}. Mon parcours m‚Äôa permis de d√©velopper une expertise solide sur ${
      mainSkills || "la s√©curit√©, le delivery et la collaboration"
    }, avec une approche orient√©e r√©sultats.`,
    "",
    xp1 || xp2
      ? `Au cours de mes derni√®res exp√©riences, j‚Äôai men√© des missions concr√®tes, notamment : ${[
          xpLineFr(xp1),
          xpLineFr(xp2),
        ]
          .filter(Boolean)
          .join(" | ")}.`
      : `Au cours de mes exp√©riences, j‚Äôai pris en charge des missions de bout en bout avec un objectif de fiabilit√© et de s√©curit√©.`,
    "",
    hasJd
      ? `Les missions d√©crites dans votre offre font √©cho √† mon parcours : je peux contribuer avec des actions pragmatiques, maintenables et orient√©es service.`
      : `Les responsabilit√©s associ√©es √† ce poste correspondent √† mon objectif : contribuer avec des actions pragmatiques et maintenables.`,
    "",
    `Je serais ravi d‚Äô√©changer pour d√©tailler la mani√®re dont je peux contribuer √† vos projets.`,
  ].join("\n");

  const pitchFr =
    (p.profileSummary && String(p.profileSummary).trim()) ||
    `Candidat(e) motiv√©(e) pour le poste de ${roleLabel} chez ${companyLabel}, avec des comp√©tences en ${
      mainSkills || "s√©curit√© et delivery"
    }.`;

  return { body: bodyFr, pitch: pitchFr };
}

// =============================
// generateLetterAndPitch ‚úÖ (IA JSON strict + bodyOnly + lettre format exemple)
// =============================
exports.generateLetterAndPitch = functions
  .runWith({ secrets: ["GEMINI_API_KEY"] })
  .region("europe-west1")
  .https.onRequest(async (req, res) => {
    setCors(req, res);

    if (req.method === "OPTIONS") return res.status(204).send("");
    if (req.method !== "POST") return res.status(405).json({ error: "M√©thode non autoris√©e" });
    if (!req.is("application/json"))
      return res.status(400).json({ error: "Content-Type invalide. Envoie du JSON." });

    // ‚úÖ PATCH: reCAPTCHA sur cet endpoint aussi (bypass auto si user authentifi√©)
    const deny = await enforceRecaptchaOrReturn(req, res, "generate_letter_pitch");
    if (deny) return;

    try {
      const body = req.body || {};
      const profile = body.profile;
      const jobDescriptionRaw = body.jobDescription || "";
      const jobTitle = (body.jobTitle || "").toString().trim();
      const companyName = (body.companyName || "").toString().trim();
      const lang = normalizeLang(body.lang || "fr");

      if (!profile) return res.status(400).json({ error: "Champ 'profile' manquant." });
      if (!jobTitle && !jobDescriptionRaw) {
        return res.status(400).json({
          error: "Ajoute au moins l'intitul√© du poste ou un extrait de la description.",
        });
      }

      const GEMINI_API_KEY = process.env.GEMINI_API_KEY;
      if (!GEMINI_API_KEY) {
        return res.status(503).json({
          error: "AI_UNAVAILABLE",
          message: "IA indisponible (GEMINI_API_KEY manquant).",
        });
      }

      const jobDescription = sanitizeJobDescription(jobDescriptionRaw || "");
      const cvText = buildProfileContextForIA(profile);

      const prompt = buildLetterAndPitchPrompt({
        lang,
        cvText,
        jobDescription,
        jobTitle: jobTitle || (lang === "en" ? "the role" : "le poste"),
        companyName: companyName || (lang === "en" ? "your company" : "votre entreprise"),
      });

      let coverLetterBody = "";
      let pitch = "";

      try {
        const parsed = await callGeminiJson(prompt, GEMINI_API_KEY, 0.55, 1800);

        coverLetterBody = typeof parsed?.coverLetterBody === "string" ? parsed.coverLetterBody.trim() : "";
        pitch = typeof parsed?.pitch === "string" ? parsed.pitch.trim() : "";
      } catch (e) {
        console.error("Gemini JSON letter/pitch failed:", e?.message || e);
      }

      // fallback si IA KO
      if (!coverLetterBody || !pitch) {
        const fb = buildFallbackLetterAndPitchBody(profile, jobTitle, companyName, jobDescription, lang);
        if (!coverLetterBody) coverLetterBody = fb.body;
        if (!pitch) pitch = fb.pitch;
      }

      // Nettoyage robuste
      const cleanedFromModel = sanitizeLmBodyFromModel(coverLetterBody);
      const bodyOnly = sanitizeLmBodyOnly(cleanedFromModel, lang, profile?.fullName || "");

      if (!bodyOnly) {
        return res.status(502).json({ error: "AI_EMPTY", message: "Lettre vide apr√®s nettoyage." });
      }

      // ‚úÖ Lettre compl√®te format exemple (identique attendu c√¥t√© PDF)
      const coverLetter = composeFullCoverLetterDoc({
        profile,
        jobTitle,
        companyName,
        lang,
        bodyOnly,
      });

      return res.status(200).json({
        lang,
        // ‚úÖ renvoie le body SEUL pour √©dition front (recommand√©)
        letterBody: bodyOnly,
        // ‚úÖ renvoie aussi la lettre compl√®te pour compat
        coverLetter,
        pitch,
      });
    } catch (err) {
      console.error("Erreur generateLetterAndPitch:", err);
      return res.status(500).json({ error: err?.message || "Erreur interne." });
    }
  });

/* =============================
   ‚úÖ LE RESTE DE TON FICHIER EST IDENTIQUE √Ä TA VERSION
   (interview, generateInterviewQA, credits/logs, recaptchaVerify, generateCvPdf,
    generateCvLmZip, generateLetterPdf, jobs, polarCheckout, polarWebhook)
   ============================= */

/**
 * NOTE:
 * Tu peux conserver EXACTEMENT la suite de ton index.js comme tu l'avais.
 * Si tu veux que je te recolle aussi TOUTE la fin (Polar/Webhook/etc.) dans ce m√™me bloc,
 * dis juste "COLLE LA SUITE" et je te la poste d‚Äôun coup (sans rien changer).
 *
 * Ici je m‚Äôarr√™te volontairement pour √©viter une r√©ponse tronqu√©e par la limite de chat.
 */
// =============================
// Interview (simulation) ‚úÖ IA
// =============================
const INTERVIEW_QUESTION_PLAN = {
  complet: 8,
  rapide: 4,
  technique: 6,
  comportemental: 6,
};

function createInterviewSessionId() {
  return Math.random().toString(36).slice(2) + "-" + Date.now().toString(36);
}

const interviewSessions = new Map();

function extractInterviewJson(raw) {
  if (!raw || typeof raw !== "string") return null;
  let t = raw.trim();

  if (t.startsWith("```")) {
    t = t.replace(/^```[a-zA-Z]*\s*/, "").replace(/```$/, "").trim();
  }

  const direct = safeJsonParseFromModel(t);
  if (direct && typeof direct === "object") return direct;

  const match = t.match(/\{[\s\S]*\}/);
  if (match) {
    const inner = safeJsonParseFromModel(match[0]);
    if (inner && typeof inner === "object") return inner;
  }
  return null;
}

function buildInterviewPrompt(session, lastUserAnswer) {
  const total = session.totalQuestions || 8;
  const step = session.currentStep || 1;

  const modeLabelMap = {
    complet: "entretien complet (g√©n√©ral + motivation + comp√©tences)",
    rapide: "entretien flash (questions essentielles)",
    technique: "entretien focalis√© sur les comp√©tences techniques",
    comportemental: "entretien focalis√© sur les soft skills / situations",
  };

  const modeLabel = modeLabelMap[session.interviewMode] || "entretien g√©n√©ral";

  const historyLines = (session.history || [])
    .map((h) => {
      const who = h.role === "candidate" ? "Candidat" : "Recruteur";
      return `- ${who} : ${h.text}`;
    })
    .join("\n");

  const base = `Tu es un recruteur humain exp√©riment√© qui m√®ne un entretien d'embauche en FRAN√áAIS pour le poste suivant :

Intitul√© du poste : ${session.jobTitle || "(non pr√©cis√©)"}
Contexte / description du poste : ${session.jobDesc || "(non pr√©cis√©)"}

Mode d'entretien : ${modeLabel}.
Niveau de difficult√© : ${session.difficulty || "standard"}.

Tu m√®nes un entretien structur√© avec environ ${total} questions maximum.`;

  const histBlock = historyLines
    ? `Historique de l'entretien (questions / r√©ponses) :
${historyLines}`
    : `L'entretien commence, tu vas poser la premi√®re question.`;

  const stepInfo = `Nous en sommes √† l'√©tape ${step} sur ${total}.
${lastUserAnswer ? `Derni√®re r√©ponse du candidat : "${lastUserAnswer}".` : ""}

SI nous ne sommes PAS √† la derni√®re √©tape (√©tape < ${total}) :
1) Analyse tr√®s bri√®vement la r√©ponse pr√©c√©dente du candidat (ou son profil au d√©marrage).
2) Propose la prochaine question d'entretien adapt√©e au poste.

SI nous SOMMES √† la derni√®re √©tape (√©tape >= ${total}) :
1) Fais un bilan synth√©tique (points forts / axes d'am√©lioration).
2) Donne un score global sur 100 (final_score).

Ta R√âPONSE DOIT √™tre STRICTEMENT un objet JSON VALIDE, sans aucun texte autour, EXACTEMENT :

{
  "next_question": "string ou null",
  "short_analysis": "string",
  "final_summary": "string ou null",
  "final_score": nombre ou null
}`;

  return `${base}\n\n${histBlock}\n\n${stepInfo}`;
}

exports.interview = functions
  .runWith({ secrets: ["GEMINI_API_KEY"] })
  .region("europe-west1")
  .https.onRequest(async (req, res) => {
    setCors(req, res);

    if (req.method === "OPTIONS") return res.status(204).send("");
    if (req.method !== "POST") return res.status(405).json({ error: "M√©thode non autoris√©e" });
    if (!req.is("application/json"))
      return res.status(400).json({ error: "Content-Type invalide. Envoie du JSON." });

    const deny = await enforceRecaptchaOrReturn(req, res, "interview");
    if (deny) return;

    try {
      const body = req.body || {};
      const action = body.action;

      if (!action)
        return res
          .status(400)
          .json({ error: "Champ 'action' manquant ('start' ou 'answer')." });

      const GEMINI_API_KEY = process.env.GEMINI_API_KEY;

      if (action === "start") {
        const userId = body.userId || "";
        const jobTitle = body.jobTitle || "";
        const jobDesc = sanitizeJobDescription(body.jobDesc || "");
        const interviewMode = body.interviewMode || "complet";
        const difficulty = body.difficulty || "standard";

        if (!userId) return res.status(400).json({ error: "Champ 'userId' manquant." });

        const totalQuestions =
          INTERVIEW_QUESTION_PLAN[interviewMode] || INTERVIEW_QUESTION_PLAN.complet;
        const sessionId = createInterviewSessionId();
        const nowIso = new Date().toISOString();

        const session = {
          sessionId,
          userId,
          jobTitle,
          jobDesc,
          interviewMode,
          difficulty,
          totalQuestions,
          currentStep: 1,
          history: [],
          createdAt: nowIso,
          updatedAt: nowIso,
          finished: false,
        };

        interviewSessions.set(sessionId, session);

        let nextQuestion = null;
        let shortAnalysis = "";
        let finalSummary = null;
        let finalScore = null;

        try {
          if (!GEMINI_API_KEY) throw new Error("GEMINI_API_KEY manquante");

          const prompt = buildInterviewPrompt(session, null);
          const raw = await callGeminiText(
            prompt,
            GEMINI_API_KEY,
            0.6,
            1200,
            "application/json"
          );

          const parsed = extractInterviewJson(raw) || {};
          if (typeof parsed.next_question === "string" && parsed.next_question.trim())
            nextQuestion = parsed.next_question.trim();
          if (typeof parsed.short_analysis === "string")
            shortAnalysis = parsed.short_analysis.trim();
          if (typeof parsed.final_summary === "string" && parsed.final_summary.trim())
            finalSummary = parsed.final_summary.trim();
          if (typeof parsed.final_score === "number" || typeof parsed.final_score === "string") {
            const num = Number(parsed.final_score);
            if (!Number.isNaN(num)) finalScore = num;
          }
        } catch (err) {
          console.error("Erreur Gemini (interview/start):", err);
        }

        if (!nextQuestion) {
          nextQuestion = jobTitle
            ? `Bonjour ! Pour commencer, pouvez-vous vous pr√©senter et m'expliquer pourquoi vous ciblez le poste de ${jobTitle} ?`
            : "Bonjour ! Pour commencer, pouvez-vous vous pr√©senter en quelques phrases ?";
          if (!shortAnalysis)
            shortAnalysis =
              "Mode d√©grad√© sans analyse IA d√©taill√©e (erreur ou quota Gemini).";
        }

        session.history.push({ role: "interviewer", text: nextQuestion, createdAt: nowIso });
        if (finalSummary) session.finished = true;

        session.updatedAt = new Date().toISOString();
        interviewSessions.set(sessionId, session);

        return res.status(200).json({
          sessionId,
          step: session.currentStep,
          totalQuestions: session.totalQuestions,
          next_question: nextQuestion,
          short_analysis: shortAnalysis,
          final_summary: finalSummary,
          final_score: finalScore,
        });
      }

      if (action === "answer") {
        const userId = body.userId || "";
        const sessionId = body.sessionId || "";
        const userMessage = (body.userMessage || "").toString().trim();

        if (!userId || !sessionId || !userMessage) {
          return res.status(400).json({
            error: "Champs 'userId', 'sessionId' ou 'userMessage' manquants.",
          });
        }

        const session = interviewSessions.get(sessionId);
        if (!session) {
          return res.status(404).json({
            error:
              "Session d'entretien introuvable ou expir√©e (instance de fonction diff√©rente).",
          });
        }

        if (session.userId && session.userId !== userId) {
          return res.status(403).json({ error: "Cette session ne correspond pas √† cet utilisateur." });
        }

        session.history.push({
          role: "candidate",
          text: userMessage,
          createdAt: new Date().toISOString(),
        });

        const nextStep = Math.min(
          (session.currentStep || 1) + 1,
          session.totalQuestions || INTERVIEW_QUESTION_PLAN.complet
        );
        session.currentStep = nextStep;

        let nextQuestion = null;
        let shortAnalysis = "";
        let finalSummary = null;
        let finalScore = null;

        try {
          if (!GEMINI_API_KEY) throw new Error("GEMINI_API_KEY manquante");

          const prompt = buildInterviewPrompt(session, userMessage);
          const raw = await callGeminiText(
            prompt,
            GEMINI_API_KEY,
            0.6,
            1200,
            "application/json"
          );

          const parsed = extractInterviewJson(raw) || {};
          if (typeof parsed.next_question === "string" && parsed.next_question.trim())
            nextQuestion = parsed.next_question.trim();
          if (typeof parsed.short_analysis === "string")
            shortAnalysis = parsed.short_analysis.trim();
          if (typeof parsed.final_summary === "string" && parsed.final_summary.trim())
            finalSummary = parsed.final_summary.trim();
          if (typeof parsed.final_score === "number" || typeof parsed.final_score === "string") {
            const num = Number(parsed.final_score);
            if (!Number.isNaN(num)) finalScore = num;
          }
        } catch (err) {
          console.error("Erreur Gemini (interview/answer):", err);
        }

        const isLastStep =
          session.currentStep >= (session.totalQuestions || INTERVIEW_QUESTION_PLAN.complet);

        if (!nextQuestion && !finalSummary) {
          if (isLastStep) {
            nextQuestion = "Merci pour tes r√©ponses, l'entretien est termin√©.";
            finalSummary =
              "Mode d√©grad√© : le bilan d√©taill√© n'a pas pu √™tre g√©n√©r√© car l'API IA n'√©tait pas disponible.";
          } else {
            nextQuestion =
              "Merci pour ta r√©ponse. Peux-tu me donner un exemple encore plus concret en lien avec ce poste ?";
            shortAnalysis =
              shortAnalysis || "Mode d√©grad√© sans analyse IA d√©taill√©e (erreur ou quota Gemini).";
          }
        }

        if (nextQuestion) {
          session.history.push({
            role: "interviewer",
            text: nextQuestion,
            createdAt: new Date().toISOString(),
          });
        }

        if (finalSummary || isLastStep) session.finished = true;

        session.updatedAt = new Date().toISOString();
        interviewSessions.set(sessionId, session);

        return res.status(200).json({
          sessionId,
          step: session.currentStep,
          totalQuestions: session.totalQuestions,
          next_question: nextQuestion,
          short_analysis: shortAnalysis,
          final_summary: finalSummary,
          final_score: finalScore,
        });
      }

      return res.status(400).json({ error: "Action invalide. Utilise 'start' ou 'answer'." });
    } catch (err) {
      console.error("Erreur interne /interview:", err);
      return res.status(500).json({ error: "Erreur interne lors de la simulation d'entretien." });
    }
  });

// =============================
// generateInterviewQA ‚úÖ IA (inchang√©)
// =============================
function buildFallbackQuestions(lang, role, company, city, dates, bullets) {
  const missions = (Array.isArray(bullets) ? bullets : [])
    .filter((b) => typeof b === "string")
    .slice(0, 3);

  if (lang === "en") {
    return [
      {
        question: `Can you describe your role as ${role} at ${company}?`,
        answer: `In my position as ${role} at ${company}${city ? " in " + city : ""}${
          dates ? " (" + dates + ")" : ""
        }, I was responsible for ${missions[0] || "several key tasks related to this role"}.`,
      },
      {
        question: `Tell me about a concrete achievement in this role.`,
        answer: missions[1]
          ? `One strong achievement was: ${missions[1]}`
          : `One of my main achievements was delivering key tasks with measurable impact.`,
      },
      {
        question: `Which tools or technologies did you use most often?`,
        answer: missions[2]
          ? `I regularly used tools/technologies such as: ${missions[2]}.`
          : `I used the main tools and workflows of the role on a daily basis.`,
      },
    ];
  }

  return [
    {
      question: `Pouvez-vous me d√©crire votre r√¥le de ${role} chez ${company} ?`,
      answer: `Dans ce poste de ${role} chez ${company}${city ? " √† " + city : ""}${
        dates ? " (" + dates + ")" : ""
      }, j'√©tais principalement en charge de ${
        missions[0] || "missions cl√©s en lien avec le poste (projets, coordination, suivi, etc.)"
      }.`,
    },
    {
      question: `Parlez-moi d'une r√©alisation concr√®te dont vous √™tes fier(e).`,
      answer: missions[1]
        ? `Une r√©alisation marquante : ${missions[1]}`
        : `Une de mes r√©alisations majeures a eu un impact positif mesurable sur l'√©quipe et/ou l'entreprise.`,
    },
    {
      question: `Quels outils ou technologies utilisiez-vous le plus souvent ?`,
      answer: missions[2]
        ? `J'utilisais notamment ${missions[2]} au quotidien.`
        : `J'utilisais au quotidien les principaux outils li√©s √† ce poste.`,
    },
  ];
}

exports.generateInterviewQA = functions
  .runWith({ secrets: ["GEMINI_API_KEY"] })
  .region("europe-west1")
  .https.onRequest(async (req, res) => {
    setCors(req, res);

    if (req.method === "OPTIONS") return res.status(204).send("");
    if (!req.is("application/json"))
      return res.status(400).json({ error: "Content-Type invalide. Envoie du JSON." });

    const deny = await enforceRecaptchaOrReturn(req, res, "generate_interview_qa");
    if (deny) return;

    try {
      const body = req.body || {};
      const profile = body.profile;
      const experienceIndex = body.experienceIndex;
      const lang = normalizeLang(body.lang || "fr");

      if (!profile || !Array.isArray(profile.experiences)) {
        return res.status(400).json({
          error: "Profil ou exp√©riences manquants. Assure-toi d'avoir bien analys√© ton CV.",
        });
      }

      const idx = Number.isInteger(experienceIndex) ? experienceIndex : parseInt(experienceIndex, 10);
      if (Number.isNaN(idx) || !profile.experiences[idx])
        return res.status(400).json({ error: "Indice d'exp√©rience invalide." });

      const exp = profile.experiences[idx] || {};
      const role = exp.role || exp.title || (lang === "en" ? "Role" : "Poste");
      const company = exp.company || "";
      const city = exp.city || exp.location || "";
      const dates = exp.dates || "";
      const bullets = Array.isArray(exp.bullets) ? exp.bullets : [];

      const GEMINI_API_KEY = process.env.GEMINI_API_KEY;
      const cvText = buildProfileContextForIA(profile);

      if (!GEMINI_API_KEY) {
        const questions = buildFallbackQuestions(lang, role, company, city, dates, bullets);
        return res.status(200).json({ questions, lang });
      }

      const prompt =
        lang === "en"
          ? `You are an interview coach.
Return STRICTLY a JSON array of EXACTLY 3 objects:
[
  { "question": "string", "answer": "string" },
  { "question": "string", "answer": "string" },
  { "question": "string", "answer": "string" }
]

Rules:
- Answers must be concrete, aligned with the missions.
- Do not invent facts.

Context:
- Role: ${role} ‚Äî ${company} ‚Äî ${city} ‚Äî ${dates}
- Missions: ${bullets.join(" ")}
- Candidate profile:
${cvText}`
          : `Tu es un coach d'entretien.
Retourne STRICTEMENT un tableau JSON de EXACTEMENT 3 objets :
[
  { "question": "string", "answer": "string" },
  { "question": "string", "answer": "string" },
  { "question": "string", "answer": "string" }
]

R√®gles:
- R√©ponses concr√®tes, align√©es avec les missions.
- Ne pas inventer.

Contexte :
- ${role} ‚Äî ${company} ‚Äî ${city} ‚Äî ${dates}
- Missions : ${bullets.join(" ")}
- Profil candidat :
${cvText}`;

      let questions = null;

      try {
        const parsed = await callGeminiJson(prompt, GEMINI_API_KEY, 0.55, 1200);

        if (Array.isArray(parsed)) {
          questions = parsed
            .map((item) => ({
              question: (item.question || item.q || "").toString().trim(),
              answer: (item.answer || item.a || "").toString().trim(),
            }))
            .filter((qa) => qa.question && qa.answer)
            .slice(0, 3);
        }
      } catch (e) {
        console.error("Erreur Gemini generateInterviewQA:", e);
      }

      if (!questions || questions.length !== 3) {
        questions = buildFallbackQuestions(lang, role, company, city, dates, bullets);
      }

      return res.status(200).json({ questions, lang });
    } catch (err) {
      console.error("Erreur generateInterviewQA:", err);
      return res.status(500).json({ error: "Erreur interne lors de la g√©n√©ration des Q&A." });
    }
  });

// =============================
// Credits / Logs (inchang√©)
// =============================
function getReqPath(req) {
  try {
    return (req.originalUrl || req.path || "") + "";
  } catch {
    return "";
  }
}

async function debitCreditsAndLog({
  uid,
  email,
  cost,
  tool,
  docType,
  docsGenerated,
  cvGenerated,
  lmGenerated,
  req,
  meta,
}) {
  const userRef = db.collection("users").doc(uid);
  const usageRef = db.collection("usageLogs").doc();
  const now = Date.now();
  const ip = getClientIp(req);
  const userAgent = String(req.headers["user-agent"] || "");
  const path = getReqPath(req);

  await db.runTransaction(async (tx) => {
    const snap = await tx.get(userRef);
    const data = snap.exists ? snap.data() || {} : {};
    const currentCredits = typeof data.credits === "number" ? data.credits : 0;

    if (currentCredits < cost) {
      const err = new Error("NO_CREDITS");
      err.code = "NO_CREDITS";
      throw err;
    }

    const updates = {
      credits: currentCredits - cost,
      totalIaCalls: admin.firestore.FieldValue.increment(1),
      updatedAt: admin.firestore.FieldValue.serverTimestamp(),
    };

    if (docsGenerated && docsGenerated > 0) {
      updates.totalDocumentsGenerated = admin.firestore.FieldValue.increment(docsGenerated);
    }
    if (cvGenerated && cvGenerated > 0) {
      updates.totalCvGenerated = admin.firestore.FieldValue.increment(cvGenerated);
    }
    if (lmGenerated && lmGenerated > 0) {
      updates.totalLmGenerated = admin.firestore.FieldValue.increment(lmGenerated);
    }

    tx.set(userRef, updates, { merge: true });

    tx.set(
      usageRef,
      {
        userId: uid,
        email: email || "",
        action: "generate_document",
        docType: docType || "other",
        eventType: "generate",
        tool: tool || null,
        creditsDelta: -cost,
        meta: meta || null,
        path: path || null,
        createdAt: now,
        createdAtServer: admin.firestore.FieldValue.serverTimestamp(),
        ip: ip || null,
        userAgent: userAgent || null,
      },
      { merge: true }
    );
  });
}

// =============================
// recaptchaVerify endpoint (inchang√©)
// =============================
exports.recaptchaVerify = functions
  .region("europe-west1")
  .https.onRequest(async (req, res) => {
    setCors(req, res);

    if (req.method === "OPTIONS") return res.status(204).send("");
    if (req.method !== "POST") return res.status(405).json({ ok: false, reason: "method_not_allowed" });
    if (!req.is("application/json")) return res.status(400).json({ ok: false, reason: "bad_content_type" });

    const token = String(req.body?.token || "");
    const action = String(req.body?.action || "").trim();

    if (!token) return res.status(400).json({ ok: false, reason: "missing_token" });
    if (!action) return res.status(400).json({ ok: false, reason: "missing_action" });

    const result = await verifyRecaptchaToken({ token, expectedAction: action, req });

    if (!result.ok) {
      return res.status(403).json({
        ok: false,
        reason: result.reason || "recaptcha_failed",
        score: typeof result.score === "number" ? result.score : undefined,
      });
    }

    return res.status(200).json({
      ok: true,
      score: typeof result.score === "number" ? result.score : undefined,
    });
  });

// =============================
// generateCvPdf (auth + credits + recaptcha) ‚úÖ
// =============================
exports.generateCvPdf = functions
  .runWith({ secrets: ["GEMINI_API_KEY"] })
  .region("europe-west1")
  .https.onRequest(async (req, res) => {
    setCors(req, res);

    if (req.method === "OPTIONS") return res.status(204).send("");
    if (req.method !== "POST") return res.status(405).json({ error: "M√©thode non autoris√©e" });
    if (!req.is("application/json"))
      return res.status(400).json({ error: "Content-Type invalide. Envoie du JSON." });

    const deny = await enforceRecaptchaOrReturn(req, res, "generate_cv_pdf");
    if (deny) return;

    let authUser = null;
    try {
      authUser = await requireFirebaseUser(req);
    } catch (e) {
      const code = e?.code || e?.message;
      if (code === "MISSING_AUTH") return res.status(401).json({ error: "unauthenticated" });
      return res.status(401).json({ error: "invalid_auth" });
    }

    try {
      const body = req.body || {};
      const profile = body.profile;
      const targetJob = body.targetJob || "";
      const lang = normalizeLang(body.lang || "fr");
      const contract = body.contract || "";
      const jobLink = body.jobLink || "";
      const jobDescription = sanitizeJobDescription(body.jobDescription || "");
      const companyName = body.companyName || "";

      if (!profile) return res.status(400).json({ error: "Champ 'profile' manquant." });

      try {
        await debitCreditsAndLog({
          uid: authUser.uid,
          email: authUser.email,
          cost: 1,
          tool: "generateCvPdf",
          docType: "cv",
          docsGenerated: 1,
          cvGenerated: 1,
          lmGenerated: 0,
          req,
          meta: { targetJob, lang },
        });
      } catch (e) {
        if (e?.code === "NO_CREDITS" || e?.message === "NO_CREDITS")
          return res.status(402).json({ error: "NO_CREDITS" });
        console.error("D√©bit cr√©dits (CV) error:", e);
        return res.status(500).json({ error: "credits_error" });
      }

      const GEMINI_API_KEY = process.env.GEMINI_API_KEY;

      let tailoredSummary = "";
      let tailoredKeySkills = [];

      if (GEMINI_API_KEY && (targetJob || jobDescription)) {
        const t = await tailorCvForJob({
          profile,
          jobTitle: targetJob,
          companyName,
          jobDescription,
          lang,
          apiKey: GEMINI_API_KEY,
        });
        tailoredSummary = t.tailoredSummary || "";
        tailoredKeySkills = t.tailoredKeySkills || [];
      }

      const pdfBuffer = await createSimpleCvPdf(profile, {
        targetJob,
        lang,
        contract,
        jobLink,
        jobDescription,
        tailoredSummary,
        tailoredKeySkills,
      });

      res.setHeader("Content-Type", "application/pdf");
      res.setHeader("Content-Disposition", 'attachment; filename="cv-ia.pdf"');
      return res.status(200).send(pdfBuffer);
    } catch (err) {
      console.error("Erreur generateCvPdf:", err);
      return res.status(500).json({ error: err?.message || "Erreur interne." });
    }
  });

// =============================
// generateCvLmZip ‚úÖ (auth + credits + recaptcha) ‚Äî LM via generateLetterAndPitch JSON
// =============================
exports.generateCvLmZip = functions
  .runWith({ secrets: ["GEMINI_API_KEY"] })
  .region("europe-west1")
  .https.onRequest(async (req, res) => {
    setCors(req, res);

    if (req.method === "OPTIONS") return res.status(204).send("");
    if (!req.is("application/json"))
      return res.status(400).json({ error: "Content-Type invalide. Envoie du JSON." });

    const deny = await enforceRecaptchaOrReturn(req, res, "generate_cv_lm_zip");
    if (deny) return;

    let authUser = null;
    try {
      authUser = await requireFirebaseUser(req);
    } catch (e) {
      const code = e?.code || e?.message;
      if (code === "MISSING_AUTH") return res.status(401).json({ error: "unauthenticated" });
      return res.status(401).json({ error: "invalid_auth" });
    }

    try {
      const body = req.body || {};
      const profile = body.profile;
      const targetJob = body.targetJob || "";
      const lang = normalizeLang(body.lang || "fr");
      const contract = body.contract || "";
      const jobLink = body.jobLink || "";
      const jobDescription = sanitizeJobDescription(body.jobDescription || "");
      const lm = body.lm || {};

      if (!profile) return res.status(400).json({ error: "Champ 'profile' manquant." });

      try {
        await debitCreditsAndLog({
          uid: authUser.uid,
          email: authUser.email,
          cost: 2,
          tool: "generateCvLmZip",
          docType: "other",
          docsGenerated: 2,
          cvGenerated: 1,
          lmGenerated: 1,
          req,
          meta: { targetJob, lang },
        });
      } catch (e) {
        if (e?.code === "NO_CREDITS" || e?.message === "NO_CREDITS")
          return res.status(402).json({ error: "NO_CREDITS" });
        console.error("D√©bit cr√©dits (ZIP) error:", e);
        return res.status(500).json({ error: "credits_error" });
      }

      const GEMINI_API_KEY = process.env.GEMINI_API_KEY;

      // CV tailor
      let tailoredSummary = "";
      let tailoredKeySkills = [];
      if (GEMINI_API_KEY && (targetJob || jobDescription)) {
        const t = await tailorCvForJob({
          profile,
          jobTitle: targetJob,
          companyName: lm.companyName || "",
          jobDescription: sanitizeJobDescription(lm.jobDescription || jobDescription || ""),
          lang,
          apiKey: GEMINI_API_KEY,
        });
        tailoredSummary = t.tailoredSummary || "";
        tailoredKeySkills = t.tailoredKeySkills || [];
      }

      const cvBuffer = await createSimpleCvPdf(profile, {
        targetJob,
        lang,
        contract,
        jobLink,
        jobDescription,
        tailoredSummary,
        tailoredKeySkills,
      });

      if (!GEMINI_API_KEY) {
        return res.status(500).json({
          error: "Cl√© Gemini manquante c√¥t√© serveur. Configure le secret GEMINI_API_KEY.",
        });
      }

      const companyName = lm.companyName || "";
      const jobTitle = lm.jobTitle || targetJob || "";
      const lmJobDescription = sanitizeJobDescription(lm.jobDescription || jobDescription || "");
      const lmLang = normalizeLang(lm.lang || lang);

      // ‚úÖ G√©n√®re body+pitch via JSON strict
      const cvText = buildProfileContextForIA(profile);
      const prompt = buildLetterAndPitchPrompt({
        lang: lmLang,
        cvText,
        jobDescription: lmJobDescription,
        jobTitle: jobTitle || (lmLang === "en" ? "the role" : "le poste"),
        companyName: companyName || (lmLang === "en" ? "your company" : "votre entreprise"),
      });

      let parsed = null;
      try {
        parsed = await callGeminiJson(prompt, GEMINI_API_KEY, 0.55, 1800);
      } catch (e) {
        console.error("Erreur Gemini JSON (ZIP LM):", e);
      }

      let coverBody = parsed && typeof parsed.coverLetterBody === "string" ? parsed.coverLetterBody : "";
      coverBody = sanitizeLmBodyOnly(
        sanitizeLmBodyFromModel(coverBody),
        lmLang,
        profile.fullName || ""
      );
      if (!coverBody) {
        const fb = buildFallbackLetterAndPitchBody(profile, jobTitle, companyName, lmJobDescription, lmLang);
        coverBody = fb.body;
      }

      const coverLetterFull = composeFullCoverLetterDoc({
        profile,
        jobTitle,
        companyName,
        lang: lmLang,
        bodyOnly: coverBody,
      });

      const lmBuffer = await createLetterPdf(coverLetterFull, {
        jobTitle,
        companyName,
        candidateName: profile.fullName || "",
        lang: lmLang,
      });

      const zip = new JSZip();
      zip.file("cv-ia.pdf", cvBuffer);
      zip.file(lmLang === "en" ? "cover-letter.pdf" : "lettre-motivation.pdf", lmBuffer);

      const zipContent = await zip.generateAsync({ type: "nodebuffer" });

      res.setHeader("Content-Type", "application/zip");
      res.setHeader("Content-Disposition", 'attachment; filename="cv-lm-ia.zip"');
      return res.status(200).send(zipContent);
    } catch (err) {
      console.error("Erreur generateCvLmZip:", err);
      return res.status(500).json({ error: err?.message || "Erreur interne." });
    }
  });

// =============================
// generateLetterPdf ‚úÖ (recaptcha) ‚Äî respect format exemple + dedupe
// =============================
exports.generateLetterPdf = functions
  .region("europe-west1")
  .https.onRequest(async (req, res) => {
    setCors(req, res);

    if (req.method === "OPTIONS") return res.status(204).send("");
    if (!req.is("application/json"))
      return res.status(400).json({ error: "Content-Type invalide. Envoie du JSON." });

    const deny = await enforceRecaptchaOrReturn(req, res, "generate_letter_pdf");
    if (deny) return;

    try {
      const body = req.body || {};
      const coverLetterRaw = (body.coverLetter || "").toString().trim();
      const jobTitle = (body.jobTitle || "").toString().trim();
      const companyName = (body.companyName || "").toString().trim();
      const candidateName = (body.candidateName || "").toString().trim();
      const lang = normalizeLang(body.lang || "fr");

      if (!coverLetterRaw)
        return res.status(400).json({ error: "Champ 'coverLetter' manquant ou vide." });

      const coverLetterFull = looksLikeFormattedLetterDoc(coverLetterRaw)
        ? coverLetterRaw
        : ensureFullLetterFormat({
            letter: coverLetterRaw,
            lang,
            candidateName,
          });

      const pdfBuffer = await createLetterPdf(coverLetterFull, {
        jobTitle,
        companyName,
        candidateName,
        lang,
      });

      const safeJob = jobTitle
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, "-")
        .replace(/^-+|-+$/g, "");

      const filename =
        (lang === "en" ? "cover-letter" : "lettre-motivation") +
        (safeJob ? `-${safeJob}` : "") +
        ".pdf";

      res.setHeader("Content-Type", "application/pdf");
      res.setHeader("Content-Disposition", `attachment; filename="${filename}"`);
      return res.status(200).send(pdfBuffer);
    } catch (err) {
      console.error("Erreur generateLetterPdf:", err);
      return res.status(500).json({ error: "Erreur interne lors de la g√©n√©ration du PDF." });
    }
  });

// =============================
// jobs (Adzuna) ‚Äî inchang√©
// =============================
exports.jobs = functions
  .region("europe-west1")
  .https.onRequest(async (req, res) => {
    setCors(req, res);

    if (req.method === "OPTIONS") return res.status(204).send("");
    if (!req.is("application/json"))
      return res.status(400).json({ error: "Content-Type invalide. Envoie du JSON." });

    const deny = await enforceRecaptchaOrReturn(req, res, "jobs_search");
    if (deny) return;

    try {
      if (!fetchFn) throw new Error("fetch indisponible. Mets Node 18+.");

      const body = req.body || {};
      const query = (body.query || "").toString().trim();
      const location = (body.location || "").toString().trim();
      const pageRaw = body.page;

      if (!query && !location) {
        return res.status(400).json({ error: "Ajoute au moins un mot-cl√© (query) ou un lieu (location)." });
      }

      const ADZUNA_APP_ID =
        (functions.config().adzuna && functions.config().adzuna.app_id) || process.env.ADZUNA_APP_ID;
      const ADZUNA_APP_KEY =
        (functions.config().adzuna && functions.config().adzuna.app_key) || process.env.ADZUNA_APP_KEY;

      if (!ADZUNA_APP_ID || !ADZUNA_APP_KEY)
        return res.status(500).json({ error: "Cl√©s Adzuna manquantes c√¥t√© serveur." });

      const page =
        typeof pageRaw === "number" && pageRaw > 0
          ? pageRaw
          : parseInt(pageRaw, 10) > 0
          ? parseInt(pageRaw, 10)
          : 1;

      const params = new URLSearchParams();
      params.set("app_id", ADZUNA_APP_ID);
      params.set("app_key", ADZUNA_APP_KEY);
      params.set("results_per_page", "20");
      params.set("content-type", "application/json");
      if (query) params.set("what", query);
      if (location) params.set("where", location);

      const url = `https://api.adzuna.com/v1/api/jobs/fr/search/${page}?${params.toString()}`;

      const resp = await fetchFn(url, { method: "GET", headers: { Accept: "application/json" } });
      if (!resp.ok) {
        const textErr = await resp.text();
        console.error("Erreur Adzuna:", resp.status, textErr);
        return res.status(500).json({ error: "Erreur lors de l'appel √† l'API Adzuna." });
      }

      const data = await resp.json();
      const results = Array.isArray(data.results) ? data.results : [];

      const jobs = results.map((job, index) => {
        const salaryMin = job.salary_min || 0;
        const salaryMax = job.salary_max || 0;
        const hasSalary = salaryMin > 0 || salaryMax > 0;

        return {
          id: job.id || `job-${index}`,
          title: job.title || "Offre sans titre",
          company:
            job.company && job.company.display_name ? job.company.display_name : "Entreprise non renseign√©e",
          location:
            job.location && job.location.display_name ? job.location.display_name : "Lieu non pr√©cis√©",
          url: job.redirect_url || "",
          description: job.description || "",
          created: job.created || "",
          salary: hasSalary
            ? `${salaryMin.toLocaleString("fr-FR")} ‚Äì ${salaryMax.toLocaleString("fr-FR")} ‚Ç¨`
            : null,
        };
      });

      return res.status(200).json({ jobs });
    } catch (err) {
      console.error("Erreur /jobs:", err);
      return res.status(500).json({ error: "Erreur interne lors de la recherche d'offres (Adzuna /jobs)." });
    }
  });

// =============================
// Polar checkout + webhook ‚Äî inchang√© (coll√© tel quel)
// =============================
const POLAR_ACCESS_TOKEN_BOOT =
  process.env.POLAR_ACCESS_TOKEN || (functions.config().polar && functions.config().polar.access_token);

if (!POLAR_ACCESS_TOKEN_BOOT) {
  console.warn("‚ö†Ô∏è POLAR_ACCESS_TOKEN manquant. Les paiements ne fonctionneront pas.");
}

exports.polarCheckout = functions
  .region("europe-west1")
  .https.onRequest(async (req, res) => {
    setCors(req, res);

    if (req.method === "OPTIONS") return res.status(204).send("");
    if (req.method !== "POST") return res.status(405).json({ error: "M√©thode non autoris√©e" });

    const deny = await enforceRecaptchaOrReturn(req, res, "polar_checkout");
    if (deny) return;

    try {
      const body = req.body || {};
      const packId = body.packId;
      const userId = body.userId;
      const email = body.email;

      if (!packId || !userId || !email) {
        return res.status(400).json({
          ok: false,
          error: "Param√®tres manquants : packId, userId et email sont obligatoires.",
        });
      }

      const polarAccessToken =
        process.env.POLAR_ACCESS_TOKEN || (functions.config().polar && functions.config().polar.access_token);

      const polarEnv =
        process.env.POLAR_ENV || (functions.config().polar && functions.config().polar.env) || "sandbox";

      const product20 =
        process.env.POLAR_PRODUCT_20_ID || (functions.config().polar && functions.config().polar.product_20_id);
      const product50 =
        process.env.POLAR_PRODUCT_50_ID || (functions.config().polar && functions.config().polar.product_50_id);
      const product100 =
        process.env.POLAR_PRODUCT_100_ID || (functions.config().polar && functions.config().polar.product_100_id);

      if (!polarAccessToken)
        return res.status(500).json({ ok: false, error: "Configuration Polar manquante c√¥t√© serveur." });

      const server = polarEnv === "production" ? "production" : "sandbox";
      const polar = new Polar({ accessToken: polarAccessToken, server });

      const mapPackToProduct = { "20": product20, "50": product50, "100": product100 };
      const productId = mapPackToProduct[String(packId)];

      if (!productId) {
        return res.status(400).json({
          ok: false,
          error: `Pack invalide ou productId non configur√© pour "${packId}".`,
        });
      }

      const baseUrl =
        process.env.NEXT_PUBLIC_APP_URL ||
        (functions.config().app && functions.config().app.base_url) ||
        "https://assistant-ia-v4.web.app";

      const successUrl = `${baseUrl}/app/credits?status=success`;
      const returnUrl = `${baseUrl}/app/credits?status=cancel`;

      const payload = {
        products: [productId],
        success_url: successUrl,
        return_url: returnUrl,
        customer_email: email,
        external_customer_id: userId,
        allow_discount_codes: true,
        require_billing_address: false,
        allow_trial: true,
        is_business_customer: false,
        metadata: { firebase_uid: String(userId), pack_id: String(packId), app: "assistant-ia-v4" },
      };

      const checkout = await polar.checkouts.create(payload);

      if (!checkout || !checkout.url)
        return res.status(500).json({ ok: false, error: "Checkout Polar cr√©√© mais URL manquante." });

      try {
        const checkoutId = checkout.id ? String(checkout.id) : null;
        const customerId = checkout.customer_id ? String(checkout.customer_id) : null;
        const productPriceId = checkout.product_price_id || checkout.productPriceId || null;

        if (checkoutId) {
          await db.collection("polar_checkouts").doc(checkoutId).set(
            {
              userId: String(userId),
              email: String(email),
              packId: String(packId),
              productId: String(productId),
              productPriceId: productPriceId ? String(productPriceId) : null,
              customerId: customerId ? String(customerId) : null,
              env: server,
              status: checkout.status || null,
              createdAt: admin.firestore.FieldValue.serverTimestamp(),
              updatedAt: admin.firestore.FieldValue.serverTimestamp(),
            },
            { merge: true }
          );
        }

        if (customerId) {
          await db.collection("polar_customers").doc(customerId).set(
            { userId: String(userId), email: String(email), updatedAt: admin.firestore.FieldValue.serverTimestamp() },
            { merge: true }
          );
        }
      } catch (e) {
        console.warn("Impossible d'√©crire le mapping polar_checkouts:", e);
      }

      return res.status(200).json({ ok: true, url: checkout.url });
    } catch (err) {
      console.error("Erreur polarCheckout:", err);
      return res.status(500).json({ ok: false, error: "Erreur interne lors de la cr√©ation du checkout Polar." });
    }
  });

function deepFindByKey(obj, keyNames) {
  if (!obj || typeof obj !== "object") return null;
  const keys = Array.isArray(keyNames) ? keyNames : [keyNames];

  for (const k of Object.keys(obj)) {
    const lower = k.toLowerCase();
    const found = keys.find((target) => lower === target.toLowerCase());
    if (found) {
      const val = obj[k];
      if (val !== undefined && val !== null && val !== "") return val;
    }
    const child = obj[k];
    if (child && typeof child === "object") {
      const result = deepFindByKey(child, keys);
      if (result !== null && result !== undefined) return result;
    }
  }
  return null;
}

function deepCollectByKey(obj, keyNames, acc = []) {
  if (!obj || typeof obj !== "object") return acc;
  const keys = Array.isArray(keyNames) ? keyNames : [keyNames];

  for (const k of Object.keys(obj)) {
    const lower = k.toLowerCase();
    const isMatch = keys.some((target) => lower === target.toLowerCase());
    const val = obj[k];

    if (isMatch) {
      if (val !== undefined && val !== null && val !== "") acc.push(val);
    }

    if (val && typeof val === "object") deepCollectByKey(val, keyNames, acc);
  }
  return acc;
}

function inferCreditsFromText(text) {
  if (!text || typeof text !== "string") return 0;
  const m = text.match(/(\d+)\s*credits?/i);
  if (!m) return 0;
  const n = parseInt(m[1], 10);
  if ([20, 50, 100].includes(n)) return n;
  return 0;
}

exports.polarWebhook = functions
  .region("europe-west1")
  .https.onRequest(async (req, res) => {
    setCors(req, res);

    if (req.method === "OPTIONS") return res.status(204).send("");
    if (req.method !== "POST") return res.status(405).json({ ok: false, error: "M√©thode non autoris√©e" });

    try {
      const event = req.body || {};
      console.log("Webhook Polar re√ßu :", JSON.stringify(event, null, 2));

      if (!event || !event.type)
        return res.status(400).json({ ok: false, error: "Event Polar invalide (type manquant)." });
      if (event.type !== "order.paid") return res.status(200).json({ ok: true, ignored: true });

      const product20 =
        process.env.POLAR_PRODUCT_20_ID || (functions.config().polar && functions.config().polar.product_20_id);
      const product50 =
        process.env.POLAR_PRODUCT_50_ID || (functions.config().polar && functions.config().polar.product_50_id);
      const product100 =
        process.env.POLAR_PRODUCT_100_ID || (functions.config().polar && functions.config().polar.product_100_id);

      const price20 =
        process.env.POLAR_PRICE_20_ID || (functions.config().polar && functions.config().polar.price_20_id);
      const price50 =
        process.env.POLAR_PRICE_50_ID || (functions.config().polar && functions.config().polar.price_50_id);
      const price100 =
        process.env.POLAR_PRICE_100_ID || (functions.config().polar && functions.config().polar.price_100_id);

      const CREDITS_BY_PRODUCT_ID = {};
      if (product20) CREDITS_BY_PRODUCT_ID[String(product20)] = 20;
      if (product50) CREDITS_BY_PRODUCT_ID[String(product50)] = 50;
      if (product100) CREDITS_BY_PRODUCT_ID[String(product100)] = 100;

      const CREDITS_BY_PRICE_ID = {};
      if (price20) CREDITS_BY_PRICE_ID[String(price20)] = 20;
      if (price50) CREDITS_BY_PRICE_ID[String(price50)] = 50;
      if (price100) CREDITS_BY_PRICE_ID[String(price100)] = 100;

      const data = event.data || {};
      const priceIds = deepCollectByKey(data, ["product_price_id", "productPriceId"]).map(String);
      const productIds = deepCollectByKey(data, ["product_id", "productId"]).map(String);

      let creditsToAdd = 0;

      for (const pid of priceIds) {
        if (CREDITS_BY_PRICE_ID[pid]) {
          creditsToAdd = CREDITS_BY_PRICE_ID[pid];
          break;
        }
      }
      if (!creditsToAdd) {
        for (const id of productIds) {
          if (CREDITS_BY_PRODUCT_ID[id]) {
            creditsToAdd = CREDITS_BY_PRODUCT_ID[id];
            break;
          }
        }
      }
      if (!creditsToAdd) {
        const labels = deepCollectByKey(data, ["label", "description", "name"])
          .filter((x) => typeof x === "string")
          .map((x) => x.trim());
        for (const t of labels) {
          const n = inferCreditsFromText(t);
          if (n) {
            creditsToAdd = n;
            break;
          }
        }
      }

      if (!creditsToAdd) {
        return res.status(200).json({
          ok: true,
          ignored: true,
          reason: "credits introuvables",
          found: { priceIds, productIds },
        });
      }

      let userId =
        deepFindByKey(data, ["external_customer_id", "customer_external_id"]) ||
        deepFindByKey(data, ["firebase_uid", "firebaseUid"]) ||
        (deepFindByKey(data, ["custom_field_data"]) || {})?.firebase_uid ||
        null;

      if (userId && typeof userId !== "string") userId = String(userId);

      if (!userId) {
        const customerId = deepFindByKey(data, ["customer_id", "customerId"]) || null;
        if (customerId) {
          const snap = await db.collection("polar_customers").doc(String(customerId)).get();
          if (snap.exists) userId = String((snap.data() || {}).userId || "");
        }
      }

      if (!userId) {
        const checkoutId = deepFindByKey(data, ["checkout_id", "checkoutId"]) || null;
        if (checkoutId) {
          const snap = await db.collection("polar_checkouts").doc(String(checkoutId)).get();
          if (snap.exists) userId = String((snap.data() || {}).userId || "");
        }
      }

      if (!userId) {
        const email = deepFindByKey(data, ["customer_email", "email"]) || null;
        if (email && typeof email === "string") {
          try {
            const u = await admin.auth().getUserByEmail(email);
            if (u?.uid) userId = u.uid;
          } catch (e) {
            console.warn("Fallback email->uid impossible:", e);
          }
        }
      }

      if (!userId)
        return res.status(200).json({ ok: true, ignored: true, reason: "userId introuvable" });

      const orderId = (data && (data.id || data.order_id || data.orderId)) || event.id || null;
      const ledgerRef = orderId ? db.collection("polar_orders").doc(String(orderId)) : null;

      await db.runTransaction(async (tx) => {
        if (ledgerRef) {
          const ledgerSnap = await tx.get(ledgerRef);
          if (ledgerSnap.exists) return;
        }

        const userRef = db.collection("users").doc(userId);
        const userSnap = await tx.get(userRef);
        const userData = userSnap.exists ? userSnap.data() || {} : {};
        const currentCredits = typeof userData.credits === "number" ? userData.credits : 0;

        const newCredits = currentCredits + creditsToAdd;

        tx.set(
          userRef,
          { credits: newCredits, updatedAt: admin.firestore.FieldValue.serverTimestamp() },
          { merge: true }
        );

        if (ledgerRef) {
          tx.set(ledgerRef, {
            processed: true,
            userId,
            creditsAdded: creditsToAdd,
            productIds,
            priceIds,
            eventType: event.type,
            createdAt: admin.firestore.FieldValue.serverTimestamp(),
          });
        }

        const rechargeId = orderId ? String(orderId) : `${event.type}_${Date.now()}`;
        const rechargeRef = db.collection("users").doc(userId).collection("rechargeHistory").doc(rechargeId);

        tx.set(
          rechargeRef,
          {
            provider: "polar",
            orderId: orderId ? String(orderId) : null,
            checkoutId: deepFindByKey(data, ["checkout_id", "checkoutId"]) || null,
            creditsAdded: creditsToAdd,
            productIds,
            priceIds,
            amount: deepFindByKey(data, ["amount", "price_amount", "total_amount"]) || null,
            currency: deepFindByKey(data, ["currency", "price_currency"]) || null,
            status: deepFindByKey(data, ["status", "payment_status"]) || null,
            eventType: event.type,
            createdAt: admin.firestore.FieldValue.serverTimestamp(),
          },
          { merge: true }
        );

        console.log(`Cr√©dits ajout√©s: +${creditsToAdd} (total=${newCredits}) userId=${userId}`);
      });

      return res.status(200).json({ ok: true, processed: true });
    } catch (err) {
      console.error("Erreur polarWebhook:", err);
      return res.status(500).json({ ok: false, error: "Erreur interne lors du traitement du webhook Polar." });
    }
  });
````

## File: lib/gemini.ts
````typescript
// lib/gemini.ts
"use client";

// Client-side helpers: Cloud Functions / API routes + reCAPTCHA via lib/recaptcha.ts
// ‚ö†Ô∏è Ce fichier ne doit contenir AUCUN JSX/React. Uniquement du TypeScript.

import { getRecaptchaToken } from "@/lib/recaptcha";

export type Language = "fr" | "en";

/** ------ Types domaine ------ */
export type ProfileData = {
  fullName?: string;
  email?: string;
  phone?: string;
  location?: string;
  title?: string;
  summary?: string;

  links?: Array<{ label?: string; url: string }>;
  skills?: string[];
  languages?: Array<{ name: string; level?: string }>;

  experiences?: Array<{
    company?: string;
    title?: string;
    role?: string; // compat
    location?: string;
    city?: string; // compat
    startDate?: string;
    endDate?: string;
    dates?: string; // compat
    description?: string;
    bullets?: string[];
  }>;
  experience?: any; // compat
  [key: string]: any;
};

export type LetterAndPitchResponse = {
  coverLetter: string;
  pitch: string;
};

export type InterviewQAResponse = {
  questions: Array<{
    question: string;
    expectedPoints?: string[];
    sampleAnswer?: string;
    answer?: string;
    a?: string;
    q?: string;
  }>;
  lang: Language;
};

/** Compat : ancienne page importait ce type */
export type GenerateInterviewQAResult = InterviewQAResponse;

/** ------ Config URLs ------ */
function stripTrailingSlash(s: string) {
  return s.endsWith("/") ? s.slice(0, -1) : s;
}

const CF_BASE =
  stripTrailingSlash(
    process.env.NEXT_PUBLIC_CLOUD_FUNCTIONS_BASE_URL ||
      "https://europe-west1-assistant-ia-v4.cloudfunctions.net"
  ) || "https://europe-west1-assistant-ia-v4.cloudfunctions.net";

const URL_EXTRACT_PROFILE = `${CF_BASE}/extractProfile`;
const URL_GENERATE_INTERVIEW_QA = `${CF_BASE}/generateInterviewQA`;
const URL_GENERATE_CV_PDF = `${CF_BASE}/generateCvPdf`;
const URL_GENERATE_CV_LM_ZIP = `${CF_BASE}/generateCvLmZip`;
const URL_GENERATE_LETTER_AND_PITCH_CF = `${CF_BASE}/generateLetterAndPitch`;
const URL_GENERATE_LETTER_PDF = `${CF_BASE}/generateLetterPdf`;

// App Route (Next.js) ‚Äî si tu utilises /api/letterAndPitch c√¥t√© serveur
const URL_LETTER_AND_PITCH_API = "/api/letterAndPitch";

/** ------ Fetch helpers ------ */
type FetchJsonOptions = {
  timeoutMs?: number;
  headers?: Record<string, string>;
};

async function readErrorBody(res: Response): Promise<string> {
  const ct = res.headers.get("content-type") || "";
  try {
    if (ct.includes("application/json")) {
      const j = await res.json().catch(() => null);
      if (j && typeof j === "object") {
        const msg =
          (j as any).error ||
          (j as any).message ||
          JSON.stringify(j).slice(0, 2000);
        return msg;
      }
    }
    const t = await res.text().catch(() => "");
    return t || `HTTP ${res.status}`;
  } catch {
    return `HTTP ${res.status}`;
  }
}

async function fetchJson<T>(
  url: string,
  body: unknown,
  opts: FetchJsonOptions = {}
): Promise<T> {
  const controller = opts.timeoutMs ? new AbortController() : undefined;
  const timer =
    controller && opts.timeoutMs
      ? window.setTimeout(() => controller.abort(), opts.timeoutMs)
      : undefined;

  try {
    const res = await fetch(url, {
      method: "POST",
      headers: {
        "content-type": "application/json",
        ...(opts.headers || {}),
      },
      body: JSON.stringify(body),
      signal: controller?.signal,
    });

    if (!res.ok) {
      const msg = await readErrorBody(res);
      throw new Error(`HTTP ${res.status}: ${msg}`);
    }

    return (await res.json()) as T;
  } finally {
    if (timer) window.clearTimeout(timer);
  }
}

async function fetchBinary(
  url: string,
  body: unknown,
  opts: FetchJsonOptions = {}
): Promise<Blob> {
  const controller = opts.timeoutMs ? new AbortController() : undefined;
  const timer =
    controller && opts.timeoutMs
      ? window.setTimeout(() => controller.abort(), opts.timeoutMs)
      : undefined;

  try {
    const res = await fetch(url, {
      method: "POST",
      headers: {
        "content-type": "application/json",
        ...(opts.headers || {}),
      },
      body: JSON.stringify(body),
      signal: controller?.signal,
    });

    if (!res.ok) {
      const msg = await readErrorBody(res);
      throw new Error(`HTTP ${res.status}: ${msg}`);
    }

    return await res.blob();
  } finally {
    if (timer) window.clearTimeout(timer);
  }
}

/** ------ Domain helpers ------ */
function getExperiencesArray(profile: ProfileData): any[] {
  const a = (profile as any)?.experiences ?? (profile as any)?.experience ?? [];
  return Array.isArray(a) ? a : [];
}

function buildExperienceJobDescription(
  profile: ProfileData,
  experienceIndex: number
): {
  jobTitle: string;
  companyName: string;
  jobDescription: string;
  experience: any;
} {
  const experiences = getExperiencesArray(profile);

  if (
    typeof experienceIndex !== "number" ||
    Number.isNaN(experienceIndex) ||
    experienceIndex < 0 ||
    experienceIndex >= experiences.length
  ) {
    throw new Error("Indice d'exp√©rience invalide.");
  }

  const exp = experiences[experienceIndex];

  const jobTitle =
    String(exp?.title || exp?.role || "").trim() ||
    String(profile.title || "").trim() ||
    "Poste (non renseign√©)";

  const companyName =
    String(exp?.company || "").trim() || "Entreprise (non renseign√©e)";

  const lines: string[] = [];
  lines.push(`Exp√©rience cibl√©e: ${jobTitle} chez ${companyName}`);

  const location = exp?.location || exp?.city || profile.location || "";
  if (location) lines.push(`Lieu: ${String(location)}`);

  const period =
    exp?.dates ||
    ((exp?.startDate || exp?.endDate)
      ? `${exp?.startDate || "?"} ‚Üí ${exp?.endDate || "?"}`
      : "");
  if (period) lines.push(`P√©riode: ${String(period)}`);

  if (exp?.description) {
    lines.push("");
    lines.push(String(exp.description));
  }

  if (Array.isArray(exp?.bullets) && exp.bullets.length) {
    lines.push("");
    lines.push("Points cl√©s:");
    for (const b of exp.bullets) {
      const t = String(b || "").trim();
      if (t) lines.push(`- ${t}`);
    }
  }

  if (profile.skills?.length) {
    lines.push("");
    lines.push(`Comp√©tences (extrait): ${profile.skills.slice(0, 12).join(", ")}`);
  }

  if (profile.summary?.trim()) {
    lines.push("");
    lines.push(`R√©sum√© candidat: ${profile.summary.trim()}`);
  }

  const jobDescription = lines.join("\n").trim() || "Description non disponible.";
  return { jobTitle, companyName, jobDescription, experience: exp };
}

/** ------ Public API ------ */
export async function callExtractProfile(profileText: string): Promise<ProfileData> {
  const recaptchaToken = await getRecaptchaToken("extract_profile");
  return await fetchJson<ProfileData>(
    URL_EXTRACT_PROFILE,
    { text: profileText, recaptchaToken },
    { timeoutMs: 60_000 }
  );
}

export async function callGenerateLetterAndPitch(
  profile: ProfileData,
  jobOffer: {
    companyName: string;
    jobTitle: string;
    jobDescription: string;
    location?: string;
  }
): Promise<LetterAndPitchResponse> {
  return await fetchJson<LetterAndPitchResponse>(
    URL_LETTER_AND_PITCH_API,
    { profile, jobOffer },
    { timeoutMs: 90_000 }
  );
}

export async function callGenerateLetterAndPitchCF(
  profile: ProfileData,
  jobOffer: {
    companyName: string;
    jobTitle: string;
    jobDescription: string;
    location?: string;
  },
  lang: Language = "fr"
): Promise<LetterAndPitchResponse> {
  const recaptchaToken = await getRecaptchaToken("generate_letter_pitch");
  return await fetchJson<LetterAndPitchResponse>(
    URL_GENERATE_LETTER_AND_PITCH_CF,
    { profile, jobOffer, lang, recaptchaToken },
    { timeoutMs: 120_000 }
  );
}

/** ‚úÖ Q/R entretien sur une exp√©rience (Cloud Function) */
export async function callGenerateInterviewQA(params: {
  profile: ProfileData;
  experienceIndex: number;
  lang?: Language;
}): Promise<InterviewQAResponse> {
  const { profile, experienceIndex, lang = "fr" } = params;

  const { jobTitle, companyName, jobDescription, experience } =
    buildExperienceJobDescription(profile, experienceIndex);

  const recaptchaToken = await getRecaptchaToken("generate_interview_qa");

  return await fetchJson<InterviewQAResponse>(
    URL_GENERATE_INTERVIEW_QA,
    {
      experienceIndex, // ‚úÖ important
      profile,
      experience,
      jobTitle,
      companyName,
      jobDescription,
      lang,
      recaptchaToken,
    },
    { timeoutMs: 120_000 }
  );
}

export async function callGenerateCvPdf(cvJson: unknown): Promise<Blob> {
  const recaptchaToken = await getRecaptchaToken("generate_cv_pdf");
  return await fetchBinary(
    URL_GENERATE_CV_PDF,
    { cvJson, recaptchaToken },
    { timeoutMs: 120_000 }
  );
}

export async function callGenerateCvLmZip(cvJson: unknown): Promise<Blob> {
  const recaptchaToken = await getRecaptchaToken("generate_cv_lm_zip");
  return await fetchBinary(
    URL_GENERATE_CV_LM_ZIP,
    { cvJson, recaptchaToken },
    { timeoutMs: 180_000 }
  );
}

export async function callGenerateLetterPdf(params: {
  letterText: string;
  candidateName?: string;
  jobTitle?: string;
  companyName?: string;
  lang?: Language;
}): Promise<Blob> {
  const {
    letterText,
    candidateName = "",
    jobTitle = "",
    companyName = "",
    lang = "fr",
  } = params;

  const recaptchaToken = await getRecaptchaToken("generate_letter_pdf");

  return await fetchBinary(
    URL_GENERATE_LETTER_PDF,
    { letterText, candidateName, jobTitle, companyName, lang, recaptchaToken },
    { timeoutMs: 120_000 }
  );
}
````

## File: package.json
````json
{
  "name": "assistant-candidatures",
  "version": "1.0.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "next lint"
  },
  "dependencies": {
    "@polar-sh/checkout": "^0.1.14",
    "@polar-sh/sdk": "^0.41.5",
    "aos": "^2.3.4",
    "chart.js": "^4.5.1",
    "firebase": "^12.7.0",
    "firebase-admin": "^13.6.0",
    "firebase-functions": "^7.0.2",
    "framer-motion": "^11.0.0",
    "jszip": "^3.10.1",
    "next": "^14.2.35",
    "next-intl": "^4.5.5",
    "node-fetch": "^3.3.2",
    "openai": "^6.10.0",
    "pdf-lib": "^1.17.1",
    "pdfjs-dist": "^5.4.530",
    "pdfmake": "^0.2.21",
    "react": "18.2.0",
    "react-dom": "18.2.0",
    "react-pdf": "^10.2.0"
  },
  "devDependencies": {
    "@types/aos": "^3.0.7",
    "@types/jszip": "^3.4.0",
    "@types/node": "^20.12.7",
    "@types/pdfmake": "^0.2.12",
    "@types/react": "^18.2.66",
    "autoprefixer": "^10.4.19",
    "postcss": "^8.4.38",
    "tailwindcss": "^3.4.4",
    "typescript": "^5.5.0"
  }
}
````

## File: app/api/generateLetterAndPitch/route.ts
````typescript
// app/api/generateLetterAndPitch/route.ts
import { NextResponse } from "next/server";

export const runtime = "nodejs";
export const dynamic = "force-dynamic";

const CF_LETTER_AND_PITCH_URL =
  process.env.FUNCTIONS_BASE_URL
    ? `${process.env.FUNCTIONS_BASE_URL}/generateLetterAndPitch`
    : "https://europe-west1-assistant-ia-v4.cloudfunctions.net/generateLetterAndPitch";

// --------------------
// Helpers (server)
// --------------------
function safeText(v: any) {
  return String(v ?? "").trim();
}

function cleanGeneratedLetter(raw: string): string {
  if (!raw) return "";
  let txt = String(raw);

  txt = txt.replace(/<\/?body[^>]*>/gi, "");
  txt = txt.replace(/<\/?html[^>]*>/gi, "");
  txt = txt.replace(/<\/?head[^>]*>[\s\S]*?<\/head>/gi, "");
  txt = txt.replace(/<\/?[^>]+>/g, "");

  return txt.replace(/\r\n/g, "\n").replace(/\n{3,}/g, "\n\n").trim();
}

function extractBodyFromLetterText(letterText: string, lang: "fr" | "en", fullName?: string) {
  const raw = safeText(letterText);
  if (!raw) return "";

  const lines = raw
    .split(/\r?\n/)
    .map((l) => l.trim())
    .filter(Boolean);

  if (!lines.length) return raw;

  const first = lines[0].toLowerCase();
  const isGreeting =
    (lang === "fr" && (first.startsWith("madame") || first.startsWith("bonjour"))) ||
    (lang === "en" && (first.startsWith("dear") || first.startsWith("hello")));

  if (isGreeting) lines.shift();

  while (lines.length) {
    const last = lines[lines.length - 1].toLowerCase();

    if (
      last.includes("cordialement") ||
      last.includes("bien cordialement") ||
      last.includes("salutations") ||
      last.includes("sincerely") ||
      last.includes("best regards") ||
      last.includes("kind regards")
    ) {
      lines.pop();
      continue;
    }

    if (fullName && last.includes(fullName.toLowerCase())) {
      lines.pop();
      continue;
    }

    break;
  }

  return lines.join("\n\n").trim() || raw;
}

// --------------------
// Route
// --------------------
export async function POST(req: Request) {
  // 1) Parse JSON
  let body: any = null;
  try {
    body = await req.json();
  } catch {
    return NextResponse.json({ error: "Corps JSON invalide." }, { status: 400 });
  }

  try {
    // 2) Headers vers Cloud Function
    const headers: Record<string, string> = {
      "Content-Type": "application/json",
    };

    const authHeader = req.headers.get("authorization");
    if (authHeader) headers["Authorization"] = authHeader;

    // ‚úÖ reCAPTCHA : body OU header (front envoie souvent dans le body)
    const recaptchaFromHeader =
      req.headers.get("x-recaptcha-token") || req.headers.get("X-Recaptcha-Token");

    const recaptchaFromBody = typeof body?.recaptchaToken === "string" ? body.recaptchaToken.trim() : "";

    const recaptchaToken = recaptchaFromBody || recaptchaFromHeader || "";
    if (recaptchaToken) headers["X-Recaptcha-Token"] = recaptchaToken;

    // optionnel mais propre : ne pas forward le token dans le body si la CF attend un header
    if (body && "recaptchaToken" in body) delete body.recaptchaToken;

    // 3) Timeout (√©vite req qui pend)
    const controller = new AbortController();
    const timeout = setTimeout(() => controller.abort(), 45_000);

    const cfRes = await fetch(CF_LETTER_AND_PITCH_URL, {
      method: "POST",
      headers,
      body: JSON.stringify(body),
      signal: controller.signal,
    }).finally(() => clearTimeout(timeout));

    const status = cfRes.status;
    const contentType = cfRes.headers.get("content-type") || "";

    // 4) Si pas JSON -> erreur explicite
    if (!contentType.includes("application/json")) {
      const text = await cfRes.text().catch(() => "");
      return NextResponse.json(
        {
          error: "La Cloud Function generateLetterAndPitch ne renvoie pas de JSON.",
          status,
          rawBody: text.slice(0, 800),
        },
        { status: status || 500 }
      );
    }

    const json = await cfRes.json().catch(() => null);

    // 5) Propager erreur backend CF
    if (!cfRes.ok) {
      return NextResponse.json(json || { error: "Erreur backend generateLetterAndPitch" }, { status });
    }

    // 6) ‚úÖ Normalisation : garantir letterBody c√¥t√© front
    // - si la CF renvoie d√©j√† letterBody : on le clean
    // - sinon fallback coverLetter -> on extrait un body propre
    const lang = (body?.lang === "en" ? "en" : "fr") as "fr" | "en";
    const fullName = safeText(body?.profile?.fullName);

    const apiLetterBody = typeof json?.letterBody === "string" ? json.letterBody : "";
    const apiCoverLetter = typeof json?.coverLetter === "string" ? json.coverLetter : "";

    const cleanedPrimary = cleanGeneratedLetter(apiLetterBody || apiCoverLetter);
    const bodyOnly = extractBodyFromLetterText(cleanedPrimary, lang, fullName);

    const out = {
      ...json,
      // ‚úÖ on force un champ stable
      letterBody: bodyOnly || cleanedPrimary || "",
      // (optionnel) on garde coverLetter intact si tu l‚Äôutilises ailleurs
      coverLetter: typeof json?.coverLetter === "string" ? json.coverLetter : apiCoverLetter || "",
    };

    return NextResponse.json(out, { status });
  } catch (e: any) {
    const isAbort = e?.name === "AbortError";
    console.error("Erreur proxy /api/generateLetterAndPitch :", e);

    return NextResponse.json(
      {
        error: isAbort
          ? "Timeout lors de l'appel √† generateLetterAndPitch."
          : "Erreur interne dans la route Next /api/generateLetterAndPitch (proxy).",
        details: e?.message ?? String(e),
      },
      { status: isAbort ? 504 : 500 }
    );
  }
}
````

## File: app/app/lm/page.tsx
````typescript
// app/app/assistant-candidature/page.tsx
"use client";

import { logUsage } from "@/lib/logUsage";
import { useEffect, useMemo, useRef, useState, FormEvent } from "react";
import type { ReactNode } from "react";
import { motion } from "framer-motion";
import { auth, db } from "@/lib/firebase";
import { onAuthStateChanged } from "firebase/auth";
import { doc, getDoc, collection, addDoc, serverTimestamp } from "firebase/firestore";

import { getRecaptchaToken } from "@/lib/recaptcha";

import { makePdfColors } from "@/lib/pdf/colors";
import { fitOnePage } from "@/lib/pdf/fitOnePage";
import { mergePdfBlobs } from "@/lib/pdf/mergePdfs";
import { downloadBlob } from "@/lib/pdf/pdfmakeClient";

import type { CvDocModel } from "@/lib/pdf/templates/cvAts";
import { buildCvPdf, getCvTemplates, type CvTemplateId } from "@/lib/pdf/templates/cvTemplates";

import { buildLmStyledPdf, type LmModel } from "@/lib/pdf/templates/letter";

// üîó ENDPOINT LOCAL (Proxy Next.js)
const LETTER_AND_PITCH_URL = "/api/generateLetterAndPitch";

// --- TYPES ---
type CvSkillsSection = { title: string; items: string[] };
type CvSkills = { sections: CvSkillsSection[]; tools: string[] };

type CvExperience = {
  company: string;
  role: string;
  dates: string;
  bullets: string[];
  location?: string;
};

type CvEducation = {
  school: string;
  degree: string;
  dates: string;
  location?: string;
};

type CvProfile = {
  fullName: string;
  email: string;
  phone: string;
  linkedin: string;
  profileSummary: string;

  city?: string;
  address?: string;

  contractType: string;
  contractTypeStandard?: string;
  contractTypeFull?: string;

  primaryDomain?: string;
  secondaryDomains?: string[];
  softSkills?: string[];

  drivingLicense?: string;
  vehicle?: string;

  skills: CvSkills;
  experiences: CvExperience[];
  education: CvEducation[];
  educationShort: string[];
  certs: string;
  langLine: string;
  hobbies: string[];
  updatedAt?: number;
};

type Lang = "fr" | "en";

// =============================
// ‚úÖ Helpers (texte & PDF)
// =============================
function safeText(v: any) {
  return String(v ?? "").replace(/\u00A0/g, " ").trim();
}
function normalizeSpaces(s: string) {
  return safeText(s).replace(/[ \t]+/g, " ").trim();
}
function sanitizeCompanyHeaderName(name: string) {
  let s = safeText(name);
  if (!s) return "";
  s = s.replace(/^(service recrutement|recruitment team)\s*[-:|]?\s*/i, "");
  s = s.replace(/\s+/g, " ").trim();
  s = s.replace(/(.+?)\s+\1$/i, "$1").trim();
  return s;
}
function buildContactLine(p: CvProfile) {
  const parts: string[] = [];
  if (p.city) parts.push(safeText(p.city));
  if (p.phone) parts.push(safeText(p.phone));
  if (p.email) parts.push(safeText(p.email));
  if (p.linkedin) parts.push(safeText(p.linkedin));
  return parts.filter(Boolean).join(" | ");
}

function categorizeSkills(profile: CvProfile) {
  const cloud: string[] = [];
  const sec: string[] = [];
  const sys: string[] = [];
  const auto: string[] = [];
  const tools: string[] = [];
  const soft: string[] = Array.isArray(profile.softSkills) ? profile.softSkills : [];

  const sections = profile.skills?.sections || [];
  for (const s of sections) {
    const title = (s?.title || "").toLowerCase();
    const items = (s?.items || []).filter(Boolean);

    const pushAll = (arr: string[], vals: string[]) => vals.forEach((x) => arr.push(x));

    if (title.includes("cloud") || title.includes("azure") || title.includes("aws") || title.includes("gcp")) {
      pushAll(cloud, items);
    } else if (title.includes("s√©cu") || title.includes("secu") || title.includes("security") || title.includes("cyber")) {
      pushAll(sec, items);
    } else if (
      title.includes("r√©seau") ||
      title.includes("reseau") ||
      title.includes("system") ||
      title.includes("syst√®me") ||
      title.includes("sys")
    ) {
      pushAll(sys, items);
    } else if (title.includes("autom") || title.includes("devops") || title.includes("ia") || title.includes("api")) {
      pushAll(auto, items);
    } else {
      pushAll(tools, items);
    }
  }

  const extraTools = Array.isArray(profile.skills?.tools) ? profile.skills.tools : [];
  extraTools.forEach((t) => tools.push(t));

  const uniq = (arr: string[]) => Array.from(new Set(arr.map((x) => safeText(x)).filter(Boolean)));

  return {
    cloud: uniq(cloud),
    sec: uniq(sec),
    sys: uniq(sys),
    auto: uniq(auto),
    tools: uniq(tools),
    soft: uniq(soft),
  };
}

function profileToCvDocModel(profile: CvProfile, params: { targetJob: string; contract: string }): CvDocModel {
  const titleParts: string[] = [];
  if (params.targetJob?.trim()) titleParts.push(params.targetJob.trim());
  if (params.contract?.trim()) titleParts.push(params.contract.trim());
  const title = titleParts.length > 0 ? titleParts.join(" ‚Äî ") : profile.contractType || "Candidature";

  const skills = categorizeSkills(profile);

  const xp = (profile.experiences || []).map((x) => ({
    company: safeText(x.company),
    city: safeText(x.location || ""),
    role: safeText(x.role),
    dates: safeText(x.dates),
    bullets: Array.isArray(x.bullets) ? x.bullets.map(safeText).filter(Boolean) : [],
  }));

  const educationLines =
    Array.isArray(profile.educationShort) && profile.educationShort.length
      ? profile.educationShort.map(safeText).filter(Boolean)
      : (profile.education || []).map((e) => {
          const a = safeText(e.degree);
          const b = safeText(e.school);
          const c = safeText(e.dates);
          const d = safeText(e.location || "");
          return [a, b, c, d].filter(Boolean).join(" ‚Äî ");
        });

  return {
    name: safeText(profile.fullName) || safeText(profile.email) || "Candidat",
    title,
    contactLine: buildContactLine(profile),
    profile: safeText(profile.profileSummary),
    skills,
    xp,
    education: educationLines,
    certs: safeText(profile.certs),
    langLine: safeText(profile.langLine),
    hobbies: Array.isArray(profile.hobbies) ? profile.hobbies.map(safeText).filter(Boolean) : [],
  };
}

// =============================
// ‚úÖ ‚ÄúCERVEAU‚Äù LM : prompt strict + sanitize
// =============================
function buildProfileContext(profile: CvProfile) {
  const fullName = safeText(profile.fullName);
  const summary = safeText(profile.profileSummary);

  const sections = Array.isArray(profile.skills?.sections) ? profile.skills.sections : [];
  const tools = Array.isArray(profile.skills?.tools) ? profile.skills.tools : [];

  const skillsLines = sections
    .filter((s) => s && (s.title || (Array.isArray(s.items) && s.items.length)))
    .slice(0, 8)
    .map((s) => {
      const title = normalizeSpaces(s.title || "Comp√©tences");
      const items = Array.isArray(s.items) ? s.items.map(safeText).filter(Boolean).slice(0, 18) : [];
      return `- ${title}: ${items.join(", ")}`.trim();
    })
    .filter(Boolean);

  const toolsLine = tools.map(safeText).filter(Boolean).slice(0, 25).join(", ");

  const experiences = Array.isArray(profile.experiences) ? profile.experiences : [];
  const xpLines = experiences.slice(0, 5).map((xp, idx) => {
    const role = normalizeSpaces(xp?.role || "");
    const company = normalizeSpaces(xp?.company || "");
    const dates = normalizeSpaces(xp?.dates || "");
    const location = normalizeSpaces(xp?.location || "");
    const bullets = Array.isArray(xp?.bullets) ? xp.bullets.map(safeText).filter(Boolean).slice(0, 6) : [];

    const header = `EXP${idx + 1}: ${role}${company ? ` ‚Äî ${company}` : ""}${dates ? ` (${dates})` : ""}${location ? ` ‚Äî ${location}` : ""}`.trim();
    const bulletBlock = bullets.length ? bullets.map((b) => `  ‚Ä¢ ${b}`).join("\n") : "  ‚Ä¢ (d√©tails non fournis)";
    return `${header}\n${bulletBlock}`;
  });

  const educationShort = Array.isArray(profile.educationShort) ? profile.educationShort.map(safeText).filter(Boolean) : [];
  const education = Array.isArray(profile.education) ? profile.education : [];

  const eduLines =
    educationShort.length
      ? educationShort.slice(0, 6)
      : education
          .slice(0, 6)
          .map((e) => [e?.degree, e?.school, e?.dates, e?.location].map(safeText).filter(Boolean).join(" ‚Äî "))
          .filter(Boolean);

  const certs = safeText(profile.certs);
  const langLine = safeText(profile.langLine);
  const soft = Array.isArray(profile.softSkills) ? profile.softSkills.map(safeText).filter(Boolean).slice(0, 12) : [];

  return [
    `CANDIDAT: ${fullName || "(nom non fourni)"}`,
    summary ? `RESUME: ${summary}` : `RESUME: (non fourni)`,
    "",
    "COMPETENCES (sections):",
    skillsLines.length ? skillsLines.join("\n") : "- (non fournies)",
    "",
    `OUTILS: ${toolsLine || "(non fournis)"}`,
    soft.length ? `SOFT SKILLS: ${soft.join(", ")}` : "",
    "",
    "EXPERIENCES:",
    xpLines.length ? xpLines.join("\n\n") : "(non fournies)",
    "",
    "FORMATION:",
    eduLines.length ? eduLines.map((l) => `- ${l}`).join("\n") : "- (non fournie)",
    "",
    certs ? `CERTIFICATIONS: ${certs}` : "",
    langLine ? `LANGUES: ${langLine}` : "",
  ]
    .filter(Boolean)
    .join("\n")
    .trim();
}

function buildLmPrompt(args: {
  lang: Lang;
  jobTitle: string;
  companyName: string;
  profileContext: string;
  jobDescription: string;
  jobLink: string;
}) {
  const L = args.lang === "en" ? "en" : "fr";
  const title = normalizeSpaces(args.jobTitle || "");
  const company = normalizeSpaces(args.companyName || "");
  const jd = safeText(args.jobDescription || "");
  const link = safeText(args.jobLink || "");

  if (L === "en") {
    return `
Role: You are an expert recruitment assistant.
Task: Write ONLY the BODY text (no header, no address, no date, no subject line, no signature) of a professional, clear, punchy cover letter.

Format constraints:
- Output plain text (no Markdown, no HTML).
- 3 to 5 short, impactful paragraphs.
- Align to the role of "${title || "the role"}" at "${company || "the company"}".
- Do NOT copy/paste the job description.
- Do NOT list tools/skills as a raw catalog; integrate them naturally into sentences.
- Tone: professional, confident, concrete, results-oriented.
- Avoid generic fluff. Avoid invented experience.
- Target length: ~320‚Äì450 words.

JOB_URL: ${link || "(not provided)"}

Candidate data:
${args.profileContext || "(no candidate context provided)"}

Job offer hints:
${jd || "(no job description provided)"}

Language: English
`.trim();
  }

  return `
R√¥le : Tu es un assistant expert en recrutement.
T√¢che : R√©dige UNIQUEMENT le CORPS du texte (sans en-t√™te, sans adresse, sans date, sans objet, sans signature) d‚Äôune lettre de motivation professionnelle, claire et percutante.

Contraintes de format :
- Rendu en texte brut (sans Markdown, sans HTML).
- 3 √† 5 paragraphes courts et impactants.
- Aligne le discours sur le poste "${title || "le poste"}" chez "${company || "l‚Äôentreprise"}".
- Ne copie pas mot pour mot le descriptif du poste.
- N‚Äô√©num√®re pas les outils/skills en catalogue : int√®gre-les naturellement dans des phrases.
- Ton professionnel, d√©termin√©, concret, orient√© r√©sultats.
- Pas de blabla g√©n√©rique. N‚Äôinvente aucune exp√©rience.
- Longueur cible : ~320‚Äì450 mots.

OFFRE_URL: ${link || "(non fournie)"}

Donn√©es du candidat :
${args.profileContext || "(contexte candidat non fourni)"}

D√©tails de l‚Äôoffre (indices) :
${jd || "(description de poste non fournie)"}

Langue de r√©daction : Fran√ßais
`.trim();
}

function sanitizeLM(raw: string): string {
  if (!raw) return "";
  let txt = String(raw);

  txt = txt.replace(/^\uFEFF/, "").replace(/\u200B/g, "");
  txt = txt.replace(/```[\s\S]*?```/g, " ");
  txt = txt.replace(/<\/?body[^>]*>/gi, "\n");
  txt = txt.replace(/<\/?html[^>]*>/gi, "\n");
  txt = txt.replace(/<\/?head[^>]*>[\s\S]*?<\/head>/gi, "\n");
  txt = txt.replace(/<\/?[^>]+>/g, "");

  txt = txt.replace(/^#{1,6}\s+/gm, "");
  txt = txt.replace(/\*\*(.*?)\*\*/g, "$1");
  txt = txt.replace(/__(.*?)__/g, "$1");
  txt = txt.replace(/\*(.*?)\*/g, "$1");
  txt = txt.replace(/_(.*?)_/g, "$1");

  txt = txt
    .split(/\r?\n/)
    .filter((line) => {
      const l = line.trim();
      if (!l) return true;
      return !/^(note|remarque|explication|instruction|exemple)\s*[:\-]/i.test(l);
    })
    .join("\n");

  txt = txt.replace(/^\s*[-‚Ä¢*]\s+/gm, "");
  txt = txt.replace(/\r\n/g, "\n");
  txt = txt.replace(/[ \t]+\n/g, "\n");
  txt = txt.replace(/\n{3,}/g, "\n\n");
  txt = txt.trim();

  return txt;
}

function extractBodyOnly(text: string, lang: Lang, fullName: string) {
  const raw = sanitizeLM(text);
  if (!raw) return "";

  const L = lang === "en" ? "en" : "fr";
  const lines = raw
    .split("\n")
    .map((l) => l.trim())
    .filter(Boolean);

  while (lines.length && /^(objet|subject)\s*:/i.test(lines[0])) lines.shift();

  if (lines.length) {
    const first = lines[0].toLowerCase();
    const isGreeting =
      (L === "fr" && (first.startsWith("madame") || first.startsWith("monsieur") || first.startsWith("bonjour"))) ||
      (L === "en" && (first.startsWith("dear") || first.startsWith("hello")));
    if (isGreeting) lines.shift();
  }

  const name = safeText(fullName).toLowerCase();
  while (lines.length) {
    const last = lines[lines.length - 1].toLowerCase();
    if (
      last.includes("cordialement") ||
      last.includes("bien cordialement") ||
      last.includes("salutations") ||
      last.includes("sincerely") ||
      last.includes("best regards") ||
      last.includes("kind regards")
    ) {
      lines.pop();
      continue;
    }
    if (name && last.includes(name)) {
      lines.pop();
      continue;
    }
    break;
  }

  return lines.join("\n\n").trim();
}

function buildLmModel(profile: CvProfile, lang: Lang, companyNameInput: string, jobTitle: string, letterBodyOnly: string): LmModel {
  const name = safeText(profile.fullName) || "Candidat";

  const contactLines: string[] = [];
  if (profile.phone)
    contactLines.push(lang === "fr" ? `T√©l√©phone : ${safeText(profile.phone)}` : `Phone: ${safeText(profile.phone)}`);
  if (profile.email) contactLines.push(lang === "fr" ? `Email : ${safeText(profile.email)}` : `Email: ${safeText(profile.email)}`);
  if (profile.linkedin)
    contactLines.push(lang === "fr" ? `LinkedIn : ${safeText(profile.linkedin)}` : `LinkedIn: ${safeText(profile.linkedin)}`);

  const city = safeText(profile.city) || "Paris";
  const dateStr = lang === "fr" ? new Date().toLocaleDateString("fr-FR") : new Date().toLocaleDateString("en-GB");

  const subject = lang === "fr" ? `Objet : Candidature ‚Äì ${jobTitle || "poste"}` : `Subject: Application ‚Äì ${jobTitle || "role"}`;
  const salutation = lang === "fr" ? "Madame, Monsieur," : "Dear Hiring Manager,";
  const closing = lang === "fr" ? "Cordialement," : "Sincerely,";

  const cleaned = sanitizeLM(letterBodyOnly);
  const bodyOnly = extractBodyOnly(cleaned, lang, name) || cleaned;

  return {
    lang,
    name,
    contactLines,
    service: lang === "fr" ? "Service Recrutement" : "Recruitment Team",
    companyName: sanitizeCompanyHeaderName(companyNameInput) || (lang === "fr" ? "Entreprise" : "Company"),
    companyAddr: "",
    city,
    dateStr,
    subject,
    salutation,
    body: bodyOnly,
    closing,
    signature: name,
  };
}

// =============================
// ‚úÖ Edition CV (draft)
// =============================
type CvSectionKey = "profile" | "xp" | "education" | "skills" | "certs" | "languages" | "hobbies";

const DEFAULT_CV_SECTIONS: Record<CvSectionKey, boolean> = {
  profile: true,
  xp: true,
  education: true,
  skills: true,
  certs: true,
  languages: true,
  hobbies: true,
};

const splitList = (s: string) =>
  String(s || "")
    .split(/[,\n;|‚Ä¢]+/g)
    .map((x) => x.trim())
    .filter(Boolean);

const joinList = (arr: string[]) => (Array.isArray(arr) ? arr.filter(Boolean).join(", ") : "");

const textToLines = (t: string) =>
  String(t || "")
    .split(/\r?\n/g)
    .map((x) => x.trim())
    .filter(Boolean);

const linesToText = (lines: string[]) => (Array.isArray(lines) ? lines.filter(Boolean).join("\n") : "");

const bulletsToText = (bullets: string[]) => linesToText(Array.isArray(bullets) ? bullets : []);
const textToBullets = (t: string) => textToLines(t);

function emptySkillsLike(base: any) {
  const keys = ["cloud", "sec", "sys", "auto", "tools", "soft"];
  const out: any = {};
  for (const k of keys) out[k] = [];
  if (!base) return out;
  for (const k of Object.keys(base)) {
    if (Array.isArray(base[k])) out[k] = [];
  }
  return out;
}

// =============================
// ‚úÖ Full screen modal
// =============================
function useLockBodyScroll(locked: boolean) {
  useEffect(() => {
    if (!locked) return;
    const prev = document.body.style.overflow;
    document.body.style.overflow = "hidden";
    return () => {
      document.body.style.overflow = prev;
    };
  }, [locked]);
}

function FullScreenModal({
  open,
  title,
  onClose,
  actions,
  children,
}: {
  open: boolean;
  title: string;
  onClose: () => void;
  actions?: ReactNode;
  children: ReactNode;
}) {
  useLockBodyScroll(open);

  useEffect(() => {
    if (!open) return;
    const onKey = (e: KeyboardEvent) => {
      if (e.key === "Escape") onClose();
    };
    window.addEventListener("keydown", onKey);
    return () => window.removeEventListener("keydown", onKey);
  }, [open, onClose]);

  if (!open) return null;

  return (
    <div className="fixed inset-0 z-[80]" role="dialog" aria-modal="true">
      <div className="absolute inset-0 bg-black/60" onClick={onClose} />
      <div className="absolute inset-0 p-2 sm:p-4">
        <div className="h-full w-full rounded-2xl border border-[var(--border)] bg-[var(--bg)] shadow-xl overflow-hidden flex flex-col">
          <div className="p-3 sm:p-4 border-b border-[var(--border)] bg-[var(--bg-soft)] flex items-center justify-between gap-2">
            <div>
              <p className="text-[13px] font-semibold text-[var(--ink)]">{title}</p>
              <p className="text-[10px] text-[var(--muted)]">ESC pour fermer</p>
            </div>
            <div className="flex items-center gap-2">
              {actions}
              <button type="button" className="btn-secondary !py-2 !px-3 text-[12px]" onClick={onClose}>
                Fermer
              </button>
            </div>
          </div>

          <div className="flex-1 min-h-0">{children}</div>
        </div>
      </div>
    </div>
  );
}

// =============================
// ‚úÖ PDF VIEWER (sans toolbar Chrome) via PDF.js CDN
// =============================
let __pdfjsReady = false;
let __pdfjs: any = null;
let __pdfjsLoading: Promise<any> | null = null;

async function ensurePdfJs() {
  if (__pdfjsReady && __pdfjs) return __pdfjs;
  if (__pdfjsLoading) return __pdfjsLoading;

  __pdfjsLoading = (async () => {
    if (typeof window === "undefined") {
      throw new Error("PDF.js doit √™tre charg√© c√¥t√© client.");
    }

    // Version PDF.js utilis√©e via CDN
    const PDFJS_VERSION = "4.0.379";

    const pdfjs: any = await import(
      /* webpackIgnore: true */ `https://cdn.jsdelivr.net/npm/pdfjs-dist@${PDFJS_VERSION}/build/pdf.mjs`
    );

    // Worker PDF.js √©galement via CDN
    pdfjs.GlobalWorkerOptions.workerSrc = `https://cdn.jsdelivr.net/npm/pdfjs-dist@${PDFJS_VERSION}/build/pdf.worker.min.mjs`;

    __pdfjs = pdfjs;
    __pdfjsReady = true;
    return pdfjs;
  })();

  return __pdfjsLoading;
}

function PdfCanvasViewer({
  fileUrl,
  className,
}: {
  fileUrl: string | null;
  className?: string;
}) {
  const wrapRef = useRef<HTMLDivElement | null>(null);
  const canvasRef = useRef<HTMLCanvasElement | null>(null);

  const [pdf, setPdf] = useState<any>(null);
  const [numPages, setNumPages] = useState(1);
  const [page, setPage] = useState(1);
  const [scale, setScale] = useState(1.1);
  const [rendering, setRendering] = useState(false);
  const [err, setErr] = useState<string | null>(null);

  // load doc
  useEffect(() => {
    let cancelled = false;

    (async () => {
      setErr(null);
      setPdf(null);
      setNumPages(1);
      setPage(1);

      if (!fileUrl) return;

      try {
        const pdfjs = await ensurePdfJs();

        // On passe un objet { url } (plus robuste)
        const task = (pdfjs as any).getDocument({ url: fileUrl });
        const doc = await task.promise;
        if (cancelled) return;

        setPdf(doc);
        setNumPages(doc.numPages || 1);
      } catch (e: any) {
        if (cancelled) return;
        setErr(e?.message || "Impossible d‚Äôouvrir le PDF.");
      }
    })();

    return () => {
      cancelled = true;
    };
  }, [fileUrl]);

  // render page
  useEffect(() => {
    let cancelled = false;

    (async () => {
      if (!pdf || !canvasRef.current) return;
      setRendering(true);

      try {
        const p = await pdf.getPage(page);
        if (cancelled) return;

        const dpr = typeof window !== "undefined" ? window.devicePixelRatio || 1 : 1;
        const viewport = p.getViewport({ scale });

        const canvas = canvasRef.current!;
        const ctx = canvas.getContext("2d");
        if (!ctx) throw new Error("Canvas context indisponible.");

        canvas.width = Math.floor(viewport.width * dpr);
        canvas.height = Math.floor(viewport.height * dpr);
        canvas.style.width = `${Math.floor(viewport.width)}px`;
        canvas.style.height = `${Math.floor(viewport.height)}px`;

        ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

        const renderTask = p.render({ canvasContext: ctx, viewport });
        await renderTask.promise;

        if (!cancelled) setErr(null);
      } catch (e: any) {
        if (!cancelled) setErr(e?.message || "Erreur rendu PDF.");
      } finally {
        if (!cancelled) setRendering(false);
      }
    })();

    return () => {
      cancelled = true;
    };
  }, [pdf, page, scale]);

  const canPrev = page > 1;
  const canNext = page < numPages;

  const fitWidth = async () => {
    if (!pdf || !wrapRef.current) return;
    try {
      const p = await pdf.getPage(page);
      const viewport1 = p.getViewport({ scale: 1 });
      const pad = 24; // marge int√©rieure
      const w = Math.max(320, wrapRef.current.clientWidth - pad);
      const next = w / viewport1.width;
      setScale(Math.max(0.4, Math.min(2.2, next)));
    } catch {
      // ignore
    }
  };

  return (
    <div className={["h-full min-h-0 flex flex-col", className || ""].join(" ")}>
      <div className="px-3 py-2 border-b border-[var(--border)] bg-[var(--bg-soft)] flex flex-wrap items-center justify-between gap-2">
        <div className="flex items-center gap-2 text-[11px] text-[var(--muted)]">
          <span className="inline-flex items-center gap-1">
            <span className="font-medium text-[var(--ink)]">Page</span>
            <input
              className="input !py-1 !px-2 !text-[11px] w-[58px] bg-[var(--bg)]"
              value={String(page)}
              onChange={(e) => {
                const n = Number(e.target.value || "1");
                if (!Number.isFinite(n)) return;
                setPage(Math.max(1, Math.min(numPages, Math.floor(n))));
              }}
            />
            <span>/ {numPages}</span>
          </span>

          {rendering && (
            <span className="inline-flex items-center gap-1">
              <span className="inline-flex w-3 h-3 rounded-full border-2 border-[var(--brand)] border-t-transparent animate-spin" />
              rendu‚Ä¶
            </span>
          )}
        </div>

        <div className="flex items-center gap-2">
          <button
            type="button"
            className="btn-secondary !py-1.5 !px-3 text-[11px]"
            onClick={() => canPrev && setPage((p) => p - 1)}
            disabled={!canPrev}
          >
            ‚Üê
          </button>
          <button
            type="button"
            className="btn-secondary !py-1.5 !px-3 text-[11px]"
            onClick={() => canNext && setPage((p) => p + 1)}
            disabled={!canNext}
          >
            ‚Üí
          </button>

          <span className="w-[1px] h-5 bg-[var(--border)] mx-1" />

          <button
            type="button"
            className="btn-secondary !py-1.5 !px-3 text-[11px]"
            onClick={() => setScale((s) => Math.max(0.4, Number((s - 0.1).toFixed(2))))}
          >
            -
          </button>
          <span className="text-[11px] text-[var(--muted)] w-[54px] text-center">{Math.round(scale * 100)}%</span>
          <button
            type="button"
            className="btn-secondary !py-1.5 !px-3 text-[11px]"
            onClick={() => setScale((s) => Math.min(2.2, Number((s + 0.1).toFixed(2))))}
          >
            +
          </button>

          <button type="button" className="btn-secondary !py-1.5 !px-3 text-[11px]" onClick={fitWidth}>
            Ajuster largeur
          </button>
        </div>
      </div>

      <div ref={wrapRef} className="flex-1 min-h-0 overflow-auto bg-white">
        {err ? (
          <div className="p-4 text-[11px] text-red-400">{err}</div>
        ) : !fileUrl ? (
          <div className="h-full flex items-center justify-center text-[11px] text-[var(--muted)]">Aucun PDF √† afficher.</div>
        ) : (
          <div className="p-3 flex justify-center">
            <canvas ref={canvasRef} className="shadow-sm border border-black/10 rounded-lg bg-white" />
          </div>
        )}
      </div>
    </div>
  );
}

// =============================
// PAGE
// =============================
export default function AssistanceCandidaturePage() {
  // --- PROFIL ---
  const [userId, setUserId] = useState<string | null>(null);
  const [userEmail, setUserEmail] = useState<string | null>(null);
  const [profile, setProfile] = useState<CvProfile | null>(null);
  const [loadingProfile, setLoadingProfile] = useState(true);

  const [globalLoadingMessage, setGlobalLoadingMessage] = useState<string | null>(null);

  useEffect(() => {
    const unsub = onAuthStateChanged(auth, async (user) => {
      if (!user) {
        setUserId(null);
        setUserEmail(null);
        setProfile(null);
        setLoadingProfile(false);
        return;
      }

      setUserId(user.uid);
      setUserEmail(user.email ?? null);

      try {
        const ref = doc(db, "profiles", user.uid);
        const snap = await getDoc(ref);

        if (snap.exists()) {
          const data = snap.data() as any;

          const loadedProfile: CvProfile = {
            fullName: data.fullName || "",
            email: data.email || "",
            phone: data.phone || "",
            linkedin: data.linkedin || "",
            profileSummary: data.profileSummary || "",
            city: data.city || "",
            address: data.address || "",
            contractType: data.contractType || data.contractTypeStandard || "",
            contractTypeStandard: data.contractTypeStandard || "",
            contractTypeFull: data.contractTypeFull || "",
            primaryDomain: data.primaryDomain || "",
            secondaryDomains: Array.isArray(data.secondaryDomains) ? data.secondaryDomains : [],
            softSkills: Array.isArray(data.softSkills) ? data.softSkills : [],
            drivingLicense: data.drivingLicense || "",
            vehicle: data.vehicle || "",
            skills: {
              sections: Array.isArray(data.skills?.sections) ? data.skills.sections : [],
              tools: Array.isArray(data.skills?.tools) ? data.skills.tools : [],
            },
            experiences: Array.isArray(data.experiences) ? data.experiences : [],
            education: Array.isArray(data.education) ? data.education : [],
            educationShort: Array.isArray(data.educationShort) ? data.educationShort : [],
            certs: data.certs || "",
            langLine: data.langLine || "",
            hobbies: Array.isArray(data.hobbies) ? data.hobbies : [],
            updatedAt: typeof data.updatedAt === "number" ? data.updatedAt : undefined,
          };

          setProfile(loadedProfile);
        } else {
          setProfile(null);
        }
      } catch (e) {
        console.error("Erreur chargement profil Firestore (assistance):", e);
      } finally {
        setLoadingProfile(false);
      }
    });

    return () => unsub();
  }, []);

  // --- CV ---
  const [cvTargetJob, setCvTargetJob] = useState("");
  const [cvTemplate, setCvTemplate] = useState<CvTemplateId>("ats");
  const [cvLang, setCvLang] = useState<Lang>("fr");
  const [cvContract, setCvContract] = useState("CDI");

  const [cvLoading, setCvLoading] = useState(false);
  const [cvStatus, setCvStatus] = useState<string | null>(null);
  const [cvError, setCvError] = useState<string | null>(null);

  // ‚úÖ Couleur PDF (CV + LM)
  const [pdfBrand, setPdfBrand] = useState("#ef4444");

  // Templates
  const [templatesModalOpen, setTemplatesModalOpen] = useState(false);
  const [templateSearch, setTemplateSearch] = useState("");

  // Draft + sections
  const [cvSections, setCvSections] = useState<Record<CvSectionKey, boolean>>(DEFAULT_CV_SECTIONS);
  const [cvDraft, setCvDraft] = useState<CvDocModel | null>(null);
  const [cvDraftDirty, setCvDraftDirty] = useState(false);

  // Preview blobs (no auto download)
  const [cvLastBlob, setCvLastBlob] = useState<Blob | null>(null);
  const [cvPreviewUrl, setCvPreviewUrl] = useState<string | null>(null);

  const [cvLmLastBlob, setCvLmLastBlob] = useState<Blob | null>(null);
  const [cvLmPreviewUrl, setCvLmPreviewUrl] = useState<string | null>(null);

  // Fullscreen modals
  const [cvEditorOpen, setCvEditorOpen] = useState(false);
  const [cvLmViewerOpen, setCvLmViewerOpen] = useState(false);

  // --- LM ---
  const [lmLang, setLmLang] = useState<Lang>("fr");
  const [companyName, setCompanyName] = useState("");
  const [jobTitle, setJobTitle] = useState("");
  const [jobDescription, setJobDescription] = useState("");
  const [jobLink, setJobLink] = useState("");

  const [letterBody, setLetterBody] = useState("");
  const [lmLoading, setLmLoading] = useState(false);
  const [lmError, setLmError] = useState<string | null>(null);

  const [lmPdfLoading, setLmPdfLoading] = useState(false);
  const [lmPdfError, setLmPdfError] = useState<string | null>(null);

  const [lmLastBlob, setLmLastBlob] = useState<Blob | null>(null);
  const [lmPreviewUrl, setLmPreviewUrl] = useState<string | null>(null);
  const [lmEditorOpen, setLmEditorOpen] = useState(false);

  // --- PITCH ---
  const [pitchLang, setPitchLang] = useState<Lang>("fr");
  const [pitchText, setPitchText] = useState("");
  const [pitchLoading, setPitchLoading] = useState(false);
  const [pitchError, setPitchError] = useState<string | null>(null);
  const [pitchCopied, setPitchCopied] = useState(false);

  // --- MAIL ---
  const [recruiterName, setRecruiterName] = useState("");
  const [emailTone, setEmailTone] = useState<"standard" | "court" | "pro">("standard");
  const [emailPreview, setEmailPreview] = useState("");
  const [subjectPreview, setSubjectPreview] = useState("");
  const [emailCopied, setEmailCopied] = useState(false);

  // --- Auto create
  const [cvAutoCreate, setCvAutoCreate] = useState(true);

  // =============================
  // ‚úÖ Derived
  // =============================
  const visibilityLabel = userId ? "Associ√© √† ton compte" : "Invit√©";
  const profileName = profile?.fullName || userEmail || "Profil non d√©tect√©";
  const miniHeadline =
    profile?.profileSummary?.split(".")[0] || profile?.contractType || "Analyse ton CV PDF dans ¬´ CV IA ¬ª pour activer l‚Äôassistant.";

  const targetedJob = jobTitle || cvTargetJob || "Poste cible non renseign√©";
  const targetedCompany = companyName || "Entreprise non renseign√©e";

  const cvTemplates = useMemo(() => getCvTemplates(), []);
  const colors = useMemo(() => makePdfColors(pdfBrand), [pdfBrand]);

  const baseCvModel = useMemo(() => {
    if (!profile) return null;
    return profileToCvDocModel(profile, { targetJob: cvTargetJob, contract: cvContract });
  }, [profile, cvTargetJob, cvContract]);

  // sync draft tant que pas dirty
  useEffect(() => {
    if (!baseCvModel) return;
    if (!cvDraft || !cvDraftDirty) setCvDraft(baseCvModel);
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [baseCvModel]);

  // cleanup URLs
  useEffect(() => {
    return () => {
      if (cvPreviewUrl) URL.revokeObjectURL(cvPreviewUrl);
      if (lmPreviewUrl) URL.revokeObjectURL(lmPreviewUrl);
      if (cvLmPreviewUrl) URL.revokeObjectURL(cvLmPreviewUrl);
    };
  }, [cvPreviewUrl, lmPreviewUrl, cvLmPreviewUrl]);

  // top3 + modal
  const top3Templates = useMemo(() => {
    const all = cvTemplates || [];
    const first = all.slice(0, 3);
    if (cvTemplate && !first.some((t) => t.id === cvTemplate)) {
      const sel = all.find((t) => t.id === cvTemplate);
      if (sel) return [first[0], first[1], sel].filter(Boolean);
    }
    return first;
  }, [cvTemplates, cvTemplate]);

  const filteredTemplates = useMemo(() => {
    const q = templateSearch.trim().toLowerCase();
    if (!q) return cvTemplates;
    return cvTemplates.filter((t) => (t.label + " " + t.description).toLowerCase().includes(q));
  }, [cvTemplates, templateSearch]);

  // =============================
  // ‚úÖ LocalStorage draft
  // =============================
  const cvStorageKey = useMemo(() => {
    if (!userId) return null;
    return `cvDraft:${userId}:${cvTemplate}:${cvLang}`;
  }, [userId, cvTemplate, cvLang]);

  const saveCvDraft = () => {
    if (!cvStorageKey || !cvDraft) return;
    const payload = { cvDraft, cvSections, pdfBrand };
    localStorage.setItem(cvStorageKey, JSON.stringify(payload));
  };

  const loadCvDraft = () => {
    if (!cvStorageKey) return;
    const raw = localStorage.getItem(cvStorageKey);
    if (!raw) return;
    try {
      const parsed = JSON.parse(raw);
      if (parsed?.cvDraft) {
        setCvDraft(parsed.cvDraft);
        setCvDraftDirty(true);
      }
      if (parsed?.cvSections) setCvSections(parsed.cvSections);
      if (parsed?.pdfBrand) setPdfBrand(parsed.pdfBrand);
    } catch {
      // ignore
    }
  };

  const clearCvDraft = () => {
    if (!cvStorageKey) return;
    localStorage.removeItem(cvStorageKey);
  };

  // auto load if exists and not dirty
  useEffect(() => {
    if (!cvStorageKey) return;
    if (!profile) return;
    if (cvDraftDirty) return;
    const raw = localStorage.getItem(cvStorageKey);
    if (!raw) return;
    try {
      const parsed = JSON.parse(raw);
      if (parsed?.cvDraft) {
        setCvDraft(parsed.cvDraft);
        setCvDraftDirty(true);
      }
      if (parsed?.cvSections) setCvSections(parsed.cvSections);
      if (parsed?.pdfBrand) setPdfBrand(parsed.pdfBrand);
    } catch {
      // ignore
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [cvStorageKey, profile]);

  // =============================
  // ‚úÖ Build final model
  // =============================
  const buildFinalCvModel = () => {
    const m = (cvDraft || baseCvModel) as CvDocModel;
    return {
      ...m,
      profile: cvSections.profile ? m.profile : "",
      xp: cvSections.xp ? m.xp : [],
      education: cvSections.education ? m.education : [],
      skills: cvSections.skills ? m.skills : (emptySkillsLike((m as any).skills) as any),
      certs: cvSections.certs ? m.certs : "",
      langLine: cvSections.languages ? m.langLine : "",
      hobbies: cvSections.hobbies ? m.hobbies : [],
    } as CvDocModel;
  };

  // =============================
  // ‚úÖ Firestore: create application (on DOWNLOAD only)
  // =============================
  type GenerationKind = "cv" | "cv_lm" | "lm" | "pitch";

  const autoCreateApplication = async (kind: GenerationKind) => {
    if (!cvAutoCreate) return;
    if (!userId || !profile) return;

    try {
      const appsRef = collection(db, "applications");
      await addDoc(appsRef, {
        userId,
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp(),
        company: companyName || "",
        jobTitle: jobTitle || cvTargetJob || "",
        jobLink: jobLink || "",
        status: "draft",
        source: "Assistant candidature IA",
        hasCv: kind === "cv" || kind === "cv_lm",
        hasLm: kind === "lm" || kind === "cv_lm",
        hasPitch: kind === "pitch",
        langCv: cvLang,
        langLm: lmLang,
        langPitch: pitchLang,
      });
    } catch (e) {
      console.error("Erreur cr√©ation entr√©e suivi de candidature :", e);
    }
  };

  // =============================
  // ‚úÖ PREVIEW CV (NO DOWNLOAD)
  // =============================
  const prepareCvPreview = async (): Promise<Blob | null> => {
    if (!profile || !baseCvModel) {
      setCvError("Aucun profil CV IA d√©tect√©. Va d'abord dans l'onglet CV IA.");
      return null;
    }

    setCvError(null);
    setCvStatus(null);
    setCvLoading(true);
    setGlobalLoadingMessage("Pr√©paration aper√ßu CV (1 page)‚Ä¶");

    try {
      const cvModel = buildFinalCvModel();
      const { blob, bestScale } = await fitOnePage((scale) =>
        buildCvPdf(cvTemplate, cvModel, cvLang, colors, "auto", scale)
      );

      setCvLastBlob(blob);

      const nextUrl = URL.createObjectURL(blob);
      setCvPreviewUrl((prev) => {
        if (prev) URL.revokeObjectURL(prev);
        return nextUrl;
      });

      setCvStatus(`Aper√ßu CV pr√™t ‚úÖ (scale=${bestScale.toFixed(2)})`);
      return blob;
    } catch (err: any) {
      console.error("Erreur preview CV:", err);
      setCvError(err?.message || "Impossible de g√©n√©rer l‚Äôaper√ßu CV.");
      return null;
    } finally {
      setCvLoading(false);
      setGlobalLoadingMessage(null);
    }
  };

  // ‚úÖ Download CV (USER CLICK ONLY)
  const downloadCv = async () => {
    const blob = cvLastBlob ?? (await prepareCvPreview());
    if (!blob) return;

    downloadBlob(blob, "cv-ia.pdf");
    await autoCreateApplication("cv");

    if (auth.currentUser) {
      await logUsage({
        user: auth.currentUser,
        action: "download_pdf",
        docType: "cv",
        eventType: "cv_download",
        tool: "clientPdfMakeCv",
      });
    }
  };

  // =============================
  // ‚úÖ Generate letter text (AI)
  // =============================
  const generateCoverLetterText = async (lang: Lang): Promise<string> => {
    if (!profile) throw new Error("Profil manquant.");
    if (!jobTitle && !jobDescription) {
      throw new Error("Ajoute au moins l'intitul√© du poste ou un extrait de la description.");
    }

    const user = auth.currentUser;
    if (!user) throw new Error("Vous devez √™tre connect√© pour g√©n√©rer une lettre.");

    const token = await user.getIdToken();
    const recaptchaToken = await getRecaptchaToken("generate_letter_pitch");

    const profileContext = buildProfileContext(profile);
    const strictPrompt = buildLmPrompt({
      lang,
      jobTitle,
      companyName,
      profileContext,
      jobDescription,
      jobLink,
    });

    const resp = await fetch(LETTER_AND_PITCH_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json", Authorization: `Bearer ${token}` },
      body: JSON.stringify({
        profile,
        jobTitle,
        companyName,
        jobDescription: strictPrompt,
        lang,
        recaptchaToken,
      }),
    });

    const json = await resp.json().catch(() => null);
    if (!resp.ok) {
      const msg = (json && json.error) || "Erreur pendant la g√©n√©ration de la lettre de motivation.";
      throw new Error(msg);
    }

    const apiLetterBody = typeof json?.letterBody === "string" ? json.letterBody.trim() : "";
    const apiCoverLetter = typeof json?.coverLetter === "string" ? json.coverLetter.trim() : "";

    const out = apiLetterBody || apiCoverLetter;
    const cleaned = sanitizeLM(out);

    if (!cleaned) throw new Error("Lettre vide renvoy√©e par l'API.");

    const name = safeText(profile.fullName);
    const bodyOnly = extractBodyOnly(cleaned, lang, name);
    return bodyOnly || cleaned;
  };

  // =============================
  // ‚úÖ PREVIEW LM (NO DOWNLOAD)
  // =============================
  const prepareLmPreview = async (opts?: { ensureText?: boolean }): Promise<Blob | null> => {
    if (!profile) {
      setLmPdfError("Profil manquant.");
      return null;
    }

    setLmPdfError(null);
    setLmLoading(false);
    setLmPdfLoading(true);
    setGlobalLoadingMessage("Pr√©paration aper√ßu LM (1 page)‚Ä¶");

    try {
      let cover = letterBody?.trim();

      if (opts?.ensureText && !cover) {
        setGlobalLoadingMessage("G√©n√©ration du texte de la lettre (IA)‚Ä¶");
        cover = await generateCoverLetterText(lmLang);
        setLetterBody(cover);
      }

      if (!cover) throw new Error("Texte de lettre vide. G√©n√®re ou colle un texte.");

      const lmModel: LmModel = buildLmModel(profile, lmLang, companyName, jobTitle, cover);

      const { blob } = await fitOnePage((scale) => buildLmStyledPdf(lmModel, colors as any, scale), {
        min: 0.85,
        max: 1.6,
        iterations: 7,
        initial: 1.0,
      });

      setLmLastBlob(blob);
      const nextUrl = URL.createObjectURL(blob);
      setLmPreviewUrl((prev) => {
        if (prev) URL.revokeObjectURL(prev);
        return nextUrl;
      });

      return blob;
    } catch (err: any) {
      console.error("Erreur preview LM:", err);
      setLmPdfError(err?.message || "Impossible de g√©n√©rer l‚Äôaper√ßu LM.");
      return null;
    } finally {
      setLmPdfLoading(false);
      setGlobalLoadingMessage(null);
    }
  };

  // ‚úÖ Download LM (USER CLICK ONLY)
  const downloadLm = async () => {
    const blob = lmLastBlob ?? (await prepareLmPreview({ ensureText: true }));
    if (!blob) return;

    downloadBlob(blob, "lettre-motivation.pdf");
    await autoCreateApplication("lm");

    if (auth.currentUser) {
      await logUsage({
        user: auth.currentUser,
        action: "download_pdf",
        docType: "lm",
        eventType: "lm_download",
        tool: "clientPdfMakeLm",
      });
    }
  };

  // =============================
  // ‚úÖ PREVIEW CV+LM merged (NO DOWNLOAD)
  // =============================
  const prepareCvLmPreview = async (): Promise<Blob | null> => {
    if (!profile || !baseCvModel) {
      setCvError("Aucun profil CV IA d√©tect√©.");
      return null;
    }

    setCvError(null);
    setCvStatus(null);
    setCvLoading(true);
    setGlobalLoadingMessage("Pr√©paration aper√ßu CV + LM (2 pages)‚Ä¶");

    try {
      // CV
      const cvModel = buildFinalCvModel();
      const cvFit = await fitOnePage((scale) => buildCvPdf(cvTemplate, cvModel, cvLang, colors, "auto", scale));

      // LM (ensure text)
      let cover = letterBody?.trim();
      if (!cover) {
        setGlobalLoadingMessage("G√©n√©ration du texte de la lettre (IA)‚Ä¶");
        cover = await generateCoverLetterText(lmLang);
        setLetterBody(cover);
      }
      const lmModel: LmModel = buildLmModel(profile, lmLang, companyName, jobTitle, cover);
      const lmFit = await fitOnePage((scale) => buildLmStyledPdf(lmModel, colors as any, scale), {
        min: 0.85,
        max: 1.6,
        iterations: 7,
        initial: 1.0,
      });

      // merge
      const merged = await mergePdfBlobs([cvFit.blob, lmFit.blob]);
      setCvLmLastBlob(merged);

      const nextUrl = URL.createObjectURL(merged);
      setCvLmPreviewUrl((prev) => {
        if (prev) URL.revokeObjectURL(prev);
        return nextUrl;
      });

      setCvStatus("Aper√ßu CV+LM pr√™t ‚úÖ (2 pages)");
      return merged;
    } catch (err: any) {
      console.error("Erreur preview CV+LM:", err);
      setCvError(err?.message || "Impossible de g√©n√©rer l‚Äôaper√ßu CV+LM.");
      return null;
    } finally {
      setCvLoading(false);
      setGlobalLoadingMessage(null);
    }
  };

  // ‚úÖ Download CV+LM (USER CLICK ONLY)
  const downloadCvLm = async () => {
    const blob = cvLmLastBlob ?? (await prepareCvLmPreview());
    if (!blob) return;

    downloadBlob(blob, "cv-lm-ia.pdf");
    await autoCreateApplication("cv_lm");

    if (auth.currentUser) {
      await logUsage({
        user: auth.currentUser,
        action: "download_pdf",
        docType: "cv",
        eventType: "cv_lm_download",
        tool: "clientPdfMakeCvLm",
      });
    }
  };

  // =============================
  // ‚úÖ CV editor: debounce auto preview
  // =============================
  const cvPreviewTimer = useRef<number | null>(null);
  useEffect(() => {
    if (!cvEditorOpen) return;
    if (!cvDraft) return;

    if (cvPreviewTimer.current) window.clearTimeout(cvPreviewTimer.current);
    cvPreviewTimer.current = window.setTimeout(() => {
      prepareCvPreview();
    }, 450);

    return () => {
      if (cvPreviewTimer.current) window.clearTimeout(cvPreviewTimer.current);
    };
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [cvEditorOpen, cvDraft, cvSections, cvTemplate, cvLang, colors]);

  // =============================
  // ‚úÖ LM editor: debounce auto preview
  // =============================
  const lmPreviewTimer = useRef<number | null>(null);
  useEffect(() => {
    if (!lmEditorOpen) return;
    if (!letterBody?.trim()) return;

    if (lmPreviewTimer.current) window.clearTimeout(lmPreviewTimer.current);
    lmPreviewTimer.current = window.setTimeout(() => {
      prepareLmPreview({ ensureText: false });
    }, 450);

    return () => {
      if (lmPreviewTimer.current) window.clearTimeout(lmPreviewTimer.current);
    };
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [lmEditorOpen, letterBody, lmLang, colors, companyName, jobTitle]);

  // =============================
  // ‚úÖ Generate LM text (button)
  // =============================
  const handleGenerateLetter = async (e?: FormEvent) => {
    if (e) e.preventDefault();
    if (!profile) {
      setLmError("Aucun profil CV IA d√©tect√©. Va d'abord dans l'onglet CV IA.");
      return;
    }
    if (!jobTitle && !jobDescription) {
      setLmError("Ajoute au moins l'intitul√© du poste ou un extrait de la description.");
      return;
    }

    setLmError(null);
    setLmPdfError(null);
    setPitchError(null);
    setLmLoading(true);
    setGlobalLoadingMessage("L‚ÄôIA r√©dige ta lettre de motivation‚Ä¶");

    try {
      const coverLetterBody = await generateCoverLetterText(lmLang);
      setLetterBody(coverLetterBody);
      setLmEditorOpen(true); // ‚úÖ ouvre l‚Äô√©diteur plein √©cran
      await prepareLmPreview({ ensureText: false });
    } catch (err: any) {
      console.error("Erreur generateLetter:", err);
      setLmError(err?.message || "Impossible de g√©n√©rer la lettre de motivation.");
    } finally {
      setLmLoading(false);
      setGlobalLoadingMessage(null);
    }
  };

  // =============================
  // ‚úÖ Pitch
  // =============================
  const handleGeneratePitch = async () => {
    if (!profile) {
      setPitchError("Aucun profil CV IA d√©tect√©. Va d'abord dans l'onglet CV IA.");
      return;
    }

    const effectiveJobTitle = jobTitle || cvTargetJob || "Candidature cible";
    const effectiveDesc = jobDescription || "";

    setPitchError(null);
    setPitchLoading(true);
    setPitchCopied(false);
    setGlobalLoadingMessage("L‚ÄôIA pr√©pare ton pitch d‚Äôascenseur‚Ä¶");

    try {
      const user = auth.currentUser;
      if (!user) throw new Error("Connecte-toi pour g√©n√©rer un pitch.");
      const token = await user.getIdToken();
      const recaptchaToken = await getRecaptchaToken("generate_letter_pitch");

      const resp = await fetch(LETTER_AND_PITCH_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json", Authorization: `Bearer ${token}` },
        body: JSON.stringify({
          profile,
          jobTitle: effectiveJobTitle,
          companyName,
          jobDescription: effectiveDesc,
          lang: pitchLang,
          recaptchaToken,
        }),
      });

      const json = await resp.json().catch(() => null);
      if (!resp.ok) throw new Error((json && json.error) || "Erreur pendant la g√©n√©ration du pitch.");

      const pitch = typeof json.pitch === "string" ? json.pitch.trim() : "";
      if (!pitch) throw new Error("Pitch vide renvoy√© par l'API.");

      setPitchText(pitch);
      await autoCreateApplication("pitch");

      if (auth.currentUser) {
        await logUsage({
          user: auth.currentUser,
          action: "generate_pitch",
          docType: "other",
          eventType: "generate",
          tool: "generateLetterAndPitch",
        });
      }
    } catch (err: any) {
      console.error("Erreur generatePitch:", err);
      setPitchError(err?.message || "Impossible de g√©n√©rer le pitch.");
    } finally {
      setPitchLoading(false);
      setGlobalLoadingMessage(null);
    }
  };

  const handleCopyPitch = async () => {
    if (!pitchText) return;
    try {
      await navigator.clipboard.writeText(pitchText);
      setPitchCopied(true);
      setTimeout(() => setPitchCopied(false), 1500);
    } catch (e) {
      console.error("Erreur copie pitch:", e);
    }
  };

  // =============================
  // ‚úÖ Mail (plus propre + ton au choix)
  // =============================
  const buildEmailContent = () => {
    const name = profile?.fullName || "";
    const recruiter = recruiterName.trim();
    const greeting = recruiter ? `Bonjour ${recruiter},` : "Bonjour,";

    const job = jobTitle || "le poste";
    const company = companyName || "votre entreprise";

    const subject = `Candidature ‚Äì ${job} ‚Äì ${name || "Candidat"}`;

    let body = "";

    if (emailTone === "court") {
      body = `${greeting}

Je vous contacte pour vous proposer ma candidature au poste de ${job} chez ${company}.
Vous trouverez en pi√®ces jointes mon CV et ma lettre de motivation.

Je suis disponible pour un √©change √† votre convenance.

Cordialement,
${name || "‚Äî"}
`;
    } else if (emailTone === "pro") {
      body = `${greeting}

Je me permets de vous soumettre ma candidature au poste de ${job} au sein de ${company}.
Au regard de mon parcours, je peux apporter une contribution concr√®te sur les sujets cl√©s du poste (mise en ≈ìuvre, am√©lioration continue, fiabilisation et travail transverse).

Vous trouverez en pi√®ces jointes mon CV ainsi que ma lettre de motivation.
Je serais ravi(e) d‚Äô√©changer avec vous afin de pr√©ciser ma motivation et mes disponibilit√©s.

Bien cordialement,
${name || "‚Äî"}
`;
    } else {
      body = `${greeting}

Je vous adresse ma candidature pour le poste de ${job} au sein de ${company}.
Vous trouverez en pi√®ces jointes mon CV et ma lettre de motivation.

Je reste √† votre disposition pour un √©change et vous remercie par avance pour votre retour.

Cordialement,
${name || "‚Äî"}
`;
    }

    setSubjectPreview(subject);
    setEmailPreview(body);
  };

  const handleGenerateEmail = (e: FormEvent) => {
    e.preventDefault();
    buildEmailContent();
  };

  const copyEmailAll = async () => {
    const text = `Objet: ${subjectPreview}\n\n${emailPreview}`;
    try {
      await navigator.clipboard.writeText(text);
      setEmailCopied(true);
      setTimeout(() => setEmailCopied(false), 1500);
    } catch (e) {
      console.error("Erreur copie email:", e);
    }
  };

  // =============================
  // UI
  // =============================
  return (
    <motion.div
      initial={{ opacity: 0, y: 12 }}
      animate={{ opacity: 1, y: 0 }}
      transition={{ duration: 0.25 }}
      className="max-w-3xl mx-auto px-3 sm:px-4 py-5 sm:py-6 space-y-4"
    >
      {/* Bandeau global */}
      {globalLoadingMessage && (
        <div className="mb-2 rounded-full bg-[var(--bg-soft)] border border-[var(--border)]/80 px-3 py-1.5 text-[11px] flex items-center gap-2 text-[var(--muted)]">
          <span className="inline-flex w-3 h-3 rounded-full border-2 border-[var(--brand)] border-t-transparent animate-spin" />
          <span>{globalLoadingMessage}</span>
        </div>
      )}

      {/* HEADER */}
      <section className="space-y-3">
        <div className="flex flex-wrap items-center justify-between gap-2">
          <p className="badge-muted flex items-center gap-1.5">
            <span className="w-1.5 h-1.5 rounded-full bg-emerald-400" />
            <span className="text-[11px] uppercase tracking-wider text-[var(--muted)]">Assistant de candidature IA</span>
          </p>
          <div className="flex flex-wrap gap-2 text-[11px]">
            <span className="inline-flex items-center rounded-full border border-[var(--border)] px-2 py-[2px]">
              Profil IA :{" "}
              <span className="ml-1 font-medium">{loadingProfile ? "Chargement‚Ä¶" : profile ? "D√©tect√© ‚úÖ" : "Non d√©tect√©"}</span>
            </span>
            <span className="inline-flex items-center rounded-full border border-[var(--border)] px-2 py-[2px]">
              Visibilit√© : <span className="ml-1 font-medium">{visibilityLabel}</span>
            </span>
          </div>
        </div>

        <div className="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
          <div className="space-y-1">
            <h1 className="text-lg sm:text-xl font-semibold">Pr√©pare ta candidature avec ton CV IA</h1>
            <p className="text-[12px] text-[var(--muted)] max-w-xl">
              Pr√©visualise et √©dite avant de t√©l√©charger : <strong>CV</strong>, <strong>lettre</strong>, <strong>pitch</strong>,{" "}
              <strong>mail</strong>. <span className="font-medium">Aucun t√©l√©chargement automatique.</span>
            </p>
          </div>

          <div className="w-full sm:w-[220px] rounded-2xl border border-[var(--border)] bg-[var(--bg-soft)] px-3 py-2.5 text-[11px]">
            <p className="text-[var(--muted)] mb-1">R√©sum√© du profil</p>
            <p className="font-semibold text-[var(--ink)] leading-tight">{profileName}</p>
            <p className="mt-0.5 text-[var(--muted)] line-clamp-2">{miniHeadline}</p>
          </div>
        </div>
      </section>

      {/* √âTAPE 1 : CV */}
      <section className="glass border border-[var(--border)]/80 rounded-2xl p-4 sm:p-5 space-y-4">
        <div className="flex items-start justify-between gap-2">
          <div className="flex items-center gap-2">
            <span className="inline-flex items-center justify-center text-[10px] px-2 py-[2px] rounded-full bg-[var(--bg-soft)] border border-[var(--border)]/80 text-[var(--muted)]">
              √âtape 1
            </span>
            <div>
              <h2 className="text-base sm:text-lg font-semibold text-[var(--ink)]">CV IA ‚Äì Aper√ßu + √âdition + T√©l√©chargement</h2>
              <p className="text-[11px] text-[var(--muted)]">Le PDF s‚Äôaffiche sans toolbar Chrome (viewer interne).</p>
            </div>
          </div>
        </div>

        <div className="space-y-3 text-[13px]">
          <div>
            <label className="block text-[11px] font-medium text-[var(--muted)] mb-1">Titre / objectif du CV</label>
            <input
              id="cvTargetJob"
              type="text"
              className="input w-full text-[var(--ink)] bg-[var(--bg)] placeholder:text-[var(--muted)]"
              placeholder="Ex : Ing√©nieur Cybers√©curit√©"
              value={cvTargetJob}
              onChange={(e) => setCvTargetJob(e.target.value)}
            />
          </div>

          {/* Templates top3 + modal */}
          <div className="space-y-2">
            <div className="flex items-end justify-between gap-2">
              <div>
                <label className="block text-[11px] font-medium text-[var(--muted)] mb-1">Mod√®le (top 3)</label>
                <p className="text-[10px] text-[var(--muted)]">
                  Clique un mod√®le. Pour tous les mod√®les ‚Üí <span className="font-medium">Plus</span>.
                </p>
              </div>

              <button type="button" onClick={() => setTemplatesModalOpen(true)} className="btn-secondary !py-1.5 !px-3 text-[11px]">
                + Plus
              </button>
            </div>

            <div className="grid grid-cols-1 sm:grid-cols-3 gap-3">
              {top3Templates.map((t) => {
                const active = t.id === cvTemplate;
                return (
                  <button
                    key={t.id}
                    type="button"
                    onClick={() => setCvTemplate(t.id)}
                    className={`text-left rounded-2xl border p-2 bg-[var(--bg-soft)] transition
                      ${active ? "border-[var(--brand)] ring-2 ring-[var(--brand)]/20" : "border-[var(--border)] hover:border-[var(--brand)]/50"}`}
                  >
                    <img
                      src={t.previewSrc}
                      alt={t.label}
                      className="w-full h-[150px] object-cover rounded-xl border border-[var(--border)] bg-white"
                      loading="lazy"
                    />
                    <div className="mt-2">
                      <p className="text-[12px] font-semibold text-[var(--ink)] flex items-center justify-between gap-2">
                        <span>{t.label}</span>
                        {active && (
                          <span className="text-[10px] px-2 py-[2px] rounded-full bg-[var(--brand)]/10 text-[var(--brand)] border border-[var(--brand)]/20">
                            S√©lectionn√©
                          </span>
                        )}
                      </p>
                      <p className="text-[10px] text-[var(--muted)] line-clamp-2">{t.description}</p>
                    </div>
                  </button>
                );
              })}
            </div>
          </div>

          <div className="grid grid-cols-2 gap-3">
            <div>
              <label className="block text-[11px] font-medium text-[var(--muted)] mb-1">Langue</label>
              <select
                id="cvLang"
                className="select-brand w-full text-[var(--ink)] bg-[var(--bg-soft)]"
                value={cvLang}
                onChange={(e) => setCvLang(e.target.value as Lang)}
              >
                <option value="fr">Fran√ßais</option>
                <option value="en">English</option>
              </select>
            </div>

            <div>
              <label className="block text-[11px] font-medium text-[var(--muted)] mb-1">Contrat vis√©</label>
              <select
                id="cvContract"
                className="select-brand w-full text-[var(--ink)] bg-[var(--bg-soft)]"
                value={cvContract}
                onChange={(e) => setCvContract(e.target.value)}
              >
                <option value="CDI">CDI</option>
                <option value="CDD">CDD</option>
                <option value="Alternance">Alternance</option>
                <option value="Stage">Stage</option>
                <option value="Freelance">Freelance</option>
              </select>
            </div>
          </div>

          {/* Couleur */}
          <div>
            <label className="block text-[11px] font-medium text-[var(--muted)] mb-1">Couleur PDF (CV + LM)</label>
            <div className="flex items-center gap-2">
              <input
                type="color"
                value={pdfBrand}
                onChange={(e) => setPdfBrand(e.target.value)}
                className="h-9 w-12 rounded-lg border border-[var(--border)] bg-[var(--bg-soft)]"
                aria-label="Couleur du PDF"
              />
              <input
                type="text"
                value={pdfBrand}
                onChange={(e) => setPdfBrand(e.target.value)}
                className="input flex-1 text-[var(--ink)] bg-[var(--bg)]"
                placeholder="#ef4444"
              />
            </div>
          </div>

          <div className="pt-1">
            <label className="flex items-center gap-2 cursor-pointer text-[12px]">
              <input
                id="autoCreateSwitch"
                type="checkbox"
                className="toggle-checkbox"
                checked={cvAutoCreate}
                onChange={(e) => setCvAutoCreate(e.target.checked)}
              />
              <span className="text-[var(--muted)]">
                Cr√©er automatiquement une entr√©e dans le <strong>Suivi üìå</strong> lors des <strong>t√©l√©chargements</strong>.
              </span>
            </label>
          </div>
        </div>

        <div className="flex flex-col sm:flex-row gap-2 pt-2">
          <button
            type="button"
            onClick={async () => {
              await prepareCvPreview();
              setCvEditorOpen(true);
            }}
            disabled={cvLoading || !profile}
            className="btn-primary flex-1 disabled:opacity-60 disabled:cursor-not-allowed"
          >
            {cvLoading ? "Pr√©paration..." : "Ouvrir l‚Äô√©diteur CV (plein √©cran)"}
          </button>

          <button
            type="button"
            onClick={async () => {
              await prepareCvLmPreview();
              setCvLmViewerOpen(true);
            }}
            disabled={cvLoading || !profile}
            className="btn-secondary flex-1 disabled:opacity-60 disabled:cursor-not-allowed"
          >
            {cvLoading ? "Pr√©paration..." : "Pr√©parer aper√ßu CV + LM (2 pages)"}
          </button>
        </div>

        {/* Status + preview inline (SANS iframe) */}
        <div className="mt-2 p-2.5 rounded-md border border-dashed border-[var(--border)]/70 text-[11px] text-[var(--muted)]">
          {cvStatus ? (
            <p className="text-center text-emerald-400 text-[12px]">{cvStatus}</p>
          ) : (
            <p className="text-center">Pr√©pare un aper√ßu, v√©rifie dans l‚Äô√©diteur, puis t√©l√©charge.</p>
          )}
          {cvError && <p className="mt-1 text-center text-red-400 text-[12px]">{cvError}</p>}

          {/* CV preview actions */}
          {cvPreviewUrl && (
            <div className="mt-3 rounded-xl border border-[var(--border)] bg-[var(--bg)] overflow-hidden">
              <div className="flex flex-wrap items-center justify-between gap-2 p-2 border-b border-[var(--border)] bg-[var(--bg-soft)]">
                <p className="text-[11px] text-[var(--muted)]">Aper√ßu CV pr√™t (sans toolbar Chrome)</p>
                <div className="flex gap-2">
                  <button type="button" className="btn-secondary !py-1 !px-3 text-[11px]" onClick={() => setCvEditorOpen(true)}>
                    Ouvrir l‚Äô√©diteur
                  </button>
                  <button type="button" className="btn-primary !py-1 !px-3 text-[11px]" onClick={downloadCv} disabled={!cvLastBlob}>
                    T√©l√©charger
                  </button>
                </div>
              </div>
              <div className="p-3 text-[11px] text-[var(--muted)]">Ouvre l‚Äô√©diteur pour modifier et v√©rifier avant t√©l√©chargement.</div>
            </div>
          )}

          {/* CV+LM preview actions */}
          {cvLmPreviewUrl && (
            <div className="mt-3 rounded-xl border border-[var(--border)] bg-[var(--bg)] overflow-hidden">
              <div className="flex flex-wrap items-center justify-between gap-2 p-2 border-b border-[var(--border)] bg-[var(--bg-soft)]">
                <p className="text-[11px] text-[var(--muted)]">Aper√ßu CV + LM pr√™t (2 pages)</p>
                <div className="flex gap-2">
                  <button type="button" className="btn-secondary !py-1 !px-3 text-[11px]" onClick={() => setCvLmViewerOpen(true)}>
                    Ouvrir l‚Äôaper√ßu
                  </button>
                  <button type="button" className="btn-primary !py-1 !px-3 text-[11px]" onClick={downloadCvLm} disabled={!cvLmLastBlob}>
                    T√©l√©charger
                  </button>
                </div>
              </div>
              <div className="p-3 text-[11px] text-[var(--muted)]">V√©rifie le PDF 2 pages avant de t√©l√©charger.</div>
            </div>
          )}
        </div>
      </section>

      {/* √âTAPE 2 : LM */}
      <section className="glass border border-[var(--border)]/80 rounded-2xl p-4 sm:p-5 space-y-4">
        <div className="rounded-md bg-[var(--bg-soft)] border border-dashed border-[var(--border)]/70 px-3 py-2 text-[11px] text-[var(--muted)] flex flex-wrap gap-2 justify-between">
          <span>
            üéØ Poste cibl√© : <span className="font-medium text-[var(--ink)]">{targetedJob}</span>
          </span>
          <span>
            üè¢ <span className="font-medium text-[var(--ink)]">{targetedCompany}</span>
          </span>
        </div>

        <form onSubmit={handleGenerateLetter} className="space-y-3">
          <div className="flex items-start justify-between gap-2">
            <div className="flex items-center gap-2">
              <span className="inline-flex items-center justify-center text-[10px] px-2 py-[2px] rounded-full bg-[var(--bg-soft)] border border-[var(--border)]/80 text-[var(--muted)]">
                √âtape 2
              </span>
              <div>
                <h3 className="text-base sm:text-lg font-semibold text-[var(--brand)]">Lettre de motivation IA</h3>
                <p className="text-[11px] text-[var(--muted)]">G√©n√®re ‚Üí √©dite ‚Üí pr√©visualise ‚Üí t√©l√©charge (th√®me = CV).</p>
              </div>
            </div>
            <select
              id="lmLang"
              className="select-brand w-[105px] text-[12px] text-[var(--ink)] bg-[var(--bg-soft)]"
              value={lmLang}
              onChange={(e) => setLmLang(e.target.value as Lang)}
            >
              <option value="fr">FR</option>
              <option value="en">EN</option>
            </select>
          </div>

          <div className="space-y-3 text-[13px]">
            <div className="grid sm:grid-cols-2 gap-3">
              <div>
                <label className="block text-[11px] font-medium text-[var(--muted)] mb-1">Nom de l'entreprise</label>
                <input
                  id="companyName"
                  type="text"
                  className="input w-full text-[var(--ink)] bg-[var(--bg)] placeholder:text-[var(--muted)]"
                  placeholder="Ex : IMOGATE"
                  value={companyName}
                  onChange={(e) => setCompanyName(e.target.value)}
                />
              </div>
              <div>
                <label className="block text-[11px] font-medium text-[var(--muted)] mb-1">Intitul√© du poste</label>
                <input
                  id="jobTitle"
                  type="text"
                  className="input w-full text-[var(--ink)] bg-[var(--bg)] placeholder:text-[var(--muted)]"
                  placeholder="Ex : Ing√©nieur R√©seaux & S√©curit√©"
                  value={jobTitle}
                  onChange={(e) => setJobTitle(e.target.value)}
                />
              </div>
            </div>

            <div>
              <label className="block text-[11px] font-medium text-[var(--muted)] mb-1">Extraits de l'offre (optionnel)</label>
              <textarea
                id="jobDescription"
                rows={3}
                className="input textarea w-full text-[var(--ink)] bg-[var(--bg)] placeholder:text-[var(--muted)]"
                placeholder="Colle quelques missions / outils / contexte."
                value={jobDescription}
                onChange={(e) => setJobDescription(e.target.value)}
              />
            </div>

            <div>
              <label className="block text-[11px] font-medium text-[var(--muted)] mb-1">Lien de l'offre (optionnel)</label>
              <input
                id="jobLink"
                type="url"
                className="input w-full text-[var(--ink)] bg-[var(--bg)] placeholder:text-[var(--muted)]"
                placeholder="https://"
                value={jobLink}
                onChange={(e) => setJobLink(e.target.value)}
              />
            </div>

            {lmError && <p className="text-[11px] text-red-400">{lmError}</p>}
            {lmPdfError && <p className="text-[11px] text-red-400">{lmPdfError}</p>}

            <div className="flex flex-col sm:flex-row gap-2 pt-1">
              <button type="submit" disabled={lmLoading || !profile} className="btn-primary flex-1 disabled:opacity-60 disabled:cursor-not-allowed">
                {lmLoading ? "G√©n√©ration..." : "G√©n√©rer la lettre (IA) + ouvrir √©diteur"}
              </button>

              <button
                type="button"
                onClick={async () => {
                  setLmEditorOpen(true);
                  await prepareLmPreview({ ensureText: true });
                }}
                disabled={lmPdfLoading || !profile}
                className="btn-secondary flex-1 disabled:opacity-60 disabled:cursor-not-allowed"
              >
                {lmPdfLoading ? "Pr√©paration..." : "Ouvrir √©diteur LM (aper√ßu)"}
              </button>
            </div>
          </div>
        </form>
      </section>

      {/* √âTAPE 3 : PITCH */}
      <section className="glass border border-[var(--border)]/80 rounded-2xl p-4 sm:p-5 space-y-3">
        <div className="rounded-md bg-[var(--bg-soft)] border border-dashed border-[var(--border)]/70 px-3 py-2 text-[11px] text-[var(--muted)] flex flex-wrap gap-2 justify-between">
          <span>
            üéØ Poste cibl√© : <span className="font-medium text-[var(--ink)]">{targetedJob}</span>
          </span>
          <span>üß© Utilise ce pitch pour mails, LinkedIn et entretiens.</span>
        </div>

        <div className="flex items-start justify-between gap-2">
          <div className="flex items-center gap-2">
            <span className="inline-flex items-center justify-center text-[10px] px-2 py-[2px] rounded-full bg-[var(--bg-soft)] border border-[var(--border)]/80 text-[var(--muted)]">
              √âtape 3
            </span>
            <div>
              <h3 className="text-base sm:text-lg font-semibold text-[var(--brand)]">Pitch d'ascenseur</h3>
              <p className="text-[11px] text-[var(--muted)]">R√©sum√© percutant de 2‚Äì4 phrases.</p>
            </div>
          </div>
          <select
            className="select-brand w-[105px] text-[12px] text-[var(--ink)] bg-[var(--bg-soft)]"
            value={pitchLang}
            onChange={(e) => setPitchLang(e.target.value as Lang)}
          >
            <option value="fr">FR</option>
            <option value="en">EN</option>
          </select>
        </div>

        {pitchError && <p className="text-[11px] text-red-400">{pitchError}</p>}

        <div className="flex flex-col sm:flex-row gap-2 pt-1">
          <button type="button" onClick={handleGeneratePitch} disabled={pitchLoading || !profile} className="btn-primary flex-1 disabled:opacity-60 disabled:cursor-not-allowed">
            {pitchLoading ? "G√©n√©ration..." : "G√©n√©rer le pitch"}
          </button>
          <button type="button" onClick={handleCopyPitch} disabled={!pitchText} className="btn-secondary flex-1 disabled:opacity-60 disabled:cursor-not-allowed">
            {pitchCopied ? "Copi√© ‚úÖ" : "Copier"}
          </button>
        </div>

        <div className="mt-2 p-3 card-soft rounded-md text-[13px] text-[var(--ink)] whitespace-pre-line">
          {pitchText ? <p>{pitchText}</p> : <p className="text-center text-[11px] text-[var(--muted)]">Apr√®s g√©n√©ration, ton pitch appara√Ætra ici.</p>}
        </div>
      </section>

      {/* √âTAPE 4 : MAIL */}
      <section className="glass border border-[var(--border)]/80 rounded-2xl p-4 sm:p-5 space-y-4">
        <div className="flex items-start justify-between gap-2">
          <div className="flex items-center gap-2">
            <span className="inline-flex items-center justify-center text-[10px] px-2 py-[2px] rounded-full bg-[var(--bg-soft)] border border-[var(--border)]/80 text-[var(--muted)]">
              √âtape 4
            </span>
            <div>
              <h3 className="text-base sm:text-lg font-semibold text-[var(--brand)]">Mail de candidature</h3>
              <p className="text-[11px] text-[var(--muted)]">Objet + corps √† copier, propre (ton au choix).</p>
            </div>
          </div>
        </div>

        <form onSubmit={handleGenerateEmail} className="grid md:grid-cols-2 gap-4 text-sm mt-1">
          <div>
            <label className="block text-[11px] font-medium text-[var(--muted)] mb-1">Nom de l'entreprise</label>
            <input className="input w-full" value={companyName} onChange={(e) => setCompanyName(e.target.value)} placeholder="Ex : IMOGATE" />
          </div>
          <div>
            <label className="block text-[11px] font-medium text-[var(--muted)] mb-1">Intitul√© du poste</label>
            <input className="input w-full" value={jobTitle} onChange={(e) => setJobTitle(e.target.value)} placeholder="Ex : Ing√©nieur R√©seaux & S√©curit√©" />
          </div>
          <div>
            <label className="block text-[11px] font-medium text-[var(--muted)] mb-1">Nom du recruteur (optionnel)</label>
            <input className="input w-full" value={recruiterName} onChange={(e) => setRecruiterName(e.target.value)} placeholder="Ex : Mme Dupont" />
          </div>
          <div>
            <label className="block text-[11px] font-medium text-[var(--muted)] mb-1">Ton</label>
            <select className="select-brand w-full bg-[var(--bg-soft)]" value={emailTone} onChange={(e) => setEmailTone(e.target.value as any)}>
              <option value="standard">Standard</option>
              <option value="pro">Tr√®s pro</option>
              <option value="court">Court</option>
            </select>
          </div>

          <div className="md:col-span-2 flex justify-end gap-2">
            <button type="submit" className="btn-primary min-w-[180px]">
              G√©n√©rer
            </button>
            <button type="button" className="btn-secondary min-w-[180px]" onClick={copyEmailAll} disabled={!subjectPreview || !emailPreview}>
              {emailCopied ? "Copi√© ‚úÖ" : "Copier objet + mail"}
            </button>
          </div>
        </form>

        <div className="grid md:grid-cols-2 gap-4 mt-3 text-sm">
          <div className="card-soft rounded-xl p-4 border border-[var(--border-soft)]">
            <h4 className="font-semibold text-sm mb-2">Objet</h4>
            <div className="text-xs text-[var(--muted)] whitespace-pre-line">{subjectPreview || "L'objet g√©n√©r√© appara√Ætra ici."}</div>
          </div>
          <div className="card-soft rounded-xl p-4 border border-[var(--border-soft)]">
            <h4 className="font-semibold text-sm mb-2">Corps du mail</h4>
            <div className="text-xs text-[var(--muted)] whitespace-pre-line max-h-64 overflow-auto">
              {emailPreview || "Le texte du mail appara√Ætra ici apr√®s g√©n√©ration."}
            </div>
          </div>
        </div>
      </section>

      {/* =============== MODAL CV FULLSCREEN =============== */}
      <FullScreenModal
        open={cvEditorOpen}
        title="√âditeur CV ‚Äî plein √©cran"
        onClose={() => setCvEditorOpen(false)}
        actions={
          <>
            <button type="button" className="btn-secondary !py-2 !px-3 text-[12px]" onClick={loadCvDraft} disabled={!userId}>
              Charger
            </button>
            <button type="button" className="btn-secondary !py-2 !px-3 text-[12px]" onClick={saveCvDraft} disabled={!userId || !cvDraft}>
              Enregistrer
            </button>
            <button type="button" className="btn-secondary !py-2 !px-3 text-[12px]" onClick={clearCvDraft} disabled={!userId}>
              Oublier
            </button>
            <button type="button" className="btn-secondary !py-2 !px-3 text-[12px]" onClick={prepareCvPreview} disabled={cvLoading}>
              R√©g√©n√©rer aper√ßu
            </button>
            <button type="button" className="btn-primary !py-2 !px-3 text-[12px]" onClick={downloadCv} disabled={!cvLastBlob}>
              T√©l√©charger
            </button>
          </>
        }
      >
        <div className="h-full grid grid-cols-1 lg:grid-cols-2 min-h-0">
          {/* LEFT: editor */}
          <div className="min-h-0 overflow-auto p-3 sm:p-4 border-b lg:border-b-0 lg:border-r border-[var(--border)]">
            {!cvDraft ? (
              <p className="text-[11px] text-[var(--muted)]">Charge ton profil CV IA pour √©diter.</p>
            ) : (
              <div className="space-y-3">
                {/* Sections */}
                <div className="rounded-xl border border-[var(--border)] bg-[var(--bg-soft)] p-3">
                  <p className="text-[11px] font-medium text-[var(--muted)] mb-2">Sections √† afficher</p>
                  <div className="grid grid-cols-2 gap-2 text-[11px] text-[var(--muted)]">
                    {(
                      [
                        ["profile", "Profil"],
                        ["xp", "Exp√©rience"],
                        ["education", "Formation"],
                        ["skills", "Comp√©tences"],
                        ["certs", "Certifications"],
                        ["languages", "Langues"],
                        ["hobbies", "Hobbies"],
                      ] as Array<[CvSectionKey, string]>
                    ).map(([k, label]) => (
                      <label key={k} className="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" checked={cvSections[k]} onChange={(e) => setCvSections((prev) => ({ ...prev, [k]: e.target.checked }))} />
                        <span>{label}</span>
                      </label>
                    ))}
                  </div>
                </div>

                {/* Quick fields */}
                <div className="grid sm:grid-cols-2 gap-3">
                  <div>
                    <label className="block text-[11px] font-medium text-[var(--muted)] mb-1">Nom</label>
                    <input
                      className="input w-full"
                      value={(cvDraft as any).name || ""}
                      onChange={(e) => {
                        setCvDraftDirty(true);
                        setCvDraft((prev) => (prev ? ({ ...prev, name: e.target.value } as any) : prev));
                      }}
                    />
                  </div>
                  <div>
                    <label className="block text-[11px] font-medium text-[var(--muted)] mb-1">Titre</label>
                    <input
                      className="input w-full"
                      value={(cvDraft as any).title || ""}
                      onChange={(e) => {
                        setCvDraftDirty(true);
                        setCvDraft((prev) => (prev ? ({ ...prev, title: e.target.value } as any) : prev));
                      }}
                    />
                  </div>
                </div>

                <div>
                  <label className="block text-[11px] font-medium text-[var(--muted)] mb-1">Contact line</label>
                  <input
                    className="input w-full"
                    value={(cvDraft as any).contactLine || ""}
                    onChange={(e) => {
                      setCvDraftDirty(true);
                      setCvDraft((prev) => (prev ? ({ ...prev, contactLine: e.target.value } as any) : prev));
                    }}
                  />
                </div>

                <div>
                  <label className="block text-[11px] font-medium text-[var(--muted)] mb-1">Profil</label>
                  <textarea
                    rows={4}
                    className="input textarea w-full"
                    value={(cvDraft as any).profile || ""}
                    onChange={(e) => {
                      setCvDraftDirty(true);
                      setCvDraft((prev) => (prev ? ({ ...prev, profile: e.target.value } as any) : prev));
                    }}
                  />
                </div>

                <div className="grid sm:grid-cols-2 gap-3">
                  <div>
                    <label className="block text-[11px] font-medium text-[var(--muted)] mb-1">Certifications</label>
                    <textarea
                      rows={3}
                      className="input textarea w-full"
                      value={(cvDraft as any).certs || ""}
                      onChange={(e) => {
                        setCvDraftDirty(true);
                        setCvDraft((prev) => (prev ? ({ ...prev, certs: e.target.value } as any) : prev));
                      }}
                    />
                  </div>

                  <div>
                    <label className="block text-[11px] font-medium text-[var(--muted)] mb-1">Langues</label>
                    <textarea
                      rows={3}
                      className="input textarea w-full"
                      value={(cvDraft as any).langLine || ""}
                      onChange={(e) => {
                        setCvDraftDirty(true);
                        setCvDraft((prev) => (prev ? ({ ...prev, langLine: e.target.value } as any) : prev));
                      }}
                    />
                  </div>
                </div>

                {/* Skills */}
                <div className="grid sm:grid-cols-2 gap-3">
                  <div>
                    <label className="block text-[11px] font-medium text-[var(--muted)] mb-1">Comp√©tences ‚Äì tools (virgules)</label>
                    <textarea
                      rows={3}
                      className="input textarea w-full"
                      value={joinList(((cvDraft as any).skills?.tools || []) as string[])}
                      onChange={(e) => {
                        const tools = splitList(e.target.value);
                        setCvDraftDirty(true);
                        setCvDraft((prev) => {
                          if (!prev) return prev;
                          const skills = { ...(prev as any).skills, tools };
                          return { ...(prev as any), skills };
                        });
                      }}
                    />
                  </div>

                  <div>
                    <label className="block text-[11px] font-medium text-[var(--muted)] mb-1">Comp√©tences ‚Äì cloud</label>
                    <textarea
                      rows={3}
                      className="input textarea w-full"
                      value={joinList(((cvDraft as any).skills?.cloud || []) as string[])}
                      onChange={(e) => {
                        const cloud = splitList(e.target.value);
                        setCvDraftDirty(true);
                        setCvDraft((prev) => {
                          if (!prev) return prev;
                          const skills = { ...(prev as any).skills, cloud };
                          return { ...(prev as any), skills };
                        });
                      }}
                    />
                  </div>
                </div>

                {/* Education */}
                <div>
                  <label className="block text-[11px] font-medium text-[var(--muted)] mb-1">Formation (1 ligne = 1 entr√©e)</label>
                  <textarea
                    rows={4}
                    className="input textarea w-full"
                    value={linesToText(((cvDraft as any).education || []) as string[])}
                    onChange={(e) => {
                      setCvDraftDirty(true);
                      const education = textToLines(e.target.value);
                      setCvDraft((prev) => (prev ? ({ ...prev, education } as any) : prev));
                    }}
                  />
                </div>

                {/* Experiences */}
                <div className="rounded-xl border border-[var(--border)] bg-[var(--bg-soft)] p-3">
                  <div className="flex items-center justify-between gap-2 mb-2">
                    <p className="text-[11px] font-medium text-[var(--muted)]">Exp√©riences</p>
                    <button
                      type="button"
                      className="btn-secondary !py-1 !px-3 text-[11px]"
                      onClick={() => {
                        setCvDraftDirty(true);
                        setCvDraft((prev) => {
                          if (!prev) return prev;
                          const xp = Array.isArray((prev as any).xp) ? ([...(prev as any).xp] as any[]) : [];
                          xp.unshift({ company: "", role: "", dates: "", city: "", bullets: [] });
                          return { ...(prev as any), xp };
                        });
                      }}
                    >
                      + Ajouter
                    </button>
                  </div>

                  <div className="space-y-2">
                    {(((cvDraft as any).xp || []) as any[]).map((x, idx) => (
                      <details key={idx} className="rounded-xl border border-[var(--border)] bg-[var(--bg)] p-2">
                        <summary className="cursor-pointer text-[12px] font-semibold text-[var(--ink)]">
                          {(x.role || "R√¥le")} ‚Äî {(x.company || "Entreprise")}{" "}
                          <span className="text-[10px] text-[var(--muted)]">#{idx + 1}</span>
                        </summary>

                        <div className="mt-2 space-y-2">
                          <div className="grid sm:grid-cols-2 gap-2">
                            <input
                              className="input w-full"
                              placeholder="R√¥le"
                              value={x.role || ""}
                              onChange={(e) => {
                                setCvDraftDirty(true);
                                setCvDraft((prev) => {
                                  if (!prev) return prev;
                                  const xp = [...((prev as any).xp || [])];
                                  xp[idx] = { ...xp[idx], role: e.target.value };
                                  return { ...(prev as any), xp };
                                });
                              }}
                            />
                            <input
                              className="input w-full"
                              placeholder="Entreprise"
                              value={x.company || ""}
                              onChange={(e) => {
                                setCvDraftDirty(true);
                                setCvDraft((prev) => {
                                  if (!prev) return prev;
                                  const xp = [...((prev as any).xp || [])];
                                  xp[idx] = { ...xp[idx], company: e.target.value };
                                  return { ...(prev as any), xp };
                                });
                              }}
                            />
                          </div>

                          <div className="grid sm:grid-cols-2 gap-2">
                            <input
                              className="input w-full"
                              placeholder="Dates (ex: 2022‚Äì2024)"
                              value={x.dates || ""}
                              onChange={(e) => {
                                setCvDraftDirty(true);
                                setCvDraft((prev) => {
                                  if (!prev) return prev;
                                  const xp = [...((prev as any).xp || [])];
                                  xp[idx] = { ...xp[idx], dates: e.target.value };
                                  return { ...(prev as any), xp };
                                });
                              }}
                            />
                            <input
                              className="input w-full"
                              placeholder="Ville / Lieu"
                              value={x.city || ""}
                              onChange={(e) => {
                                setCvDraftDirty(true);
                                setCvDraft((prev) => {
                                  if (!prev) return prev;
                                  const xp = [...((prev as any).xp || [])];
                                  xp[idx] = { ...xp[idx], city: e.target.value };
                                  return { ...(prev as any), xp };
                                });
                              }}
                            />
                          </div>

                          <textarea
                            rows={4}
                            className="input textarea w-full"
                            placeholder={"Bullets (1 ligne = 1 bullet)\n- Exemple: Mise en place MFA\n- Exemple: Durcissement AD"}
                            value={bulletsToText(x.bullets || [])}
                            onChange={(e) => {
                              const bullets = textToBullets(e.target.value);
                              setCvDraftDirty(true);
                              setCvDraft((prev) => {
                                if (!prev) return prev;
                                const xp = [...((prev as any).xp || [])];
                                xp[idx] = { ...xp[idx], bullets };
                                return { ...(prev as any), xp };
                              });
                            }}
                          />

                          <div className="flex flex-wrap gap-2">
                            <button
                              type="button"
                              className="btn-secondary !py-1 !px-3 text-[11px]"
                              onClick={() => {
                                setCvDraftDirty(true);
                                setCvDraft((prev) => {
                                  if (!prev) return prev;
                                  const xp = [...((prev as any).xp || [])];
                                  if (idx > 0) [xp[idx - 1], xp[idx]] = [xp[idx], xp[idx - 1]];
                                  return { ...(prev as any), xp };
                                });
                              }}
                            >
                              ‚Üë Monter
                            </button>

                            <button
                              type="button"
                              className="btn-secondary !py-1 !px-3 text-[11px]"
                              onClick={() => {
                                setCvDraftDirty(true);
                                setCvDraft((prev) => {
                                  if (!prev) return prev;
                                  const xp = [...((prev as any).xp || [])];
                                  if (idx < xp.length - 1) [xp[idx + 1], xp[idx]] = [xp[idx], xp[idx + 1]];
                                  return { ...(prev as any), xp };
                                });
                              }}
                            >
                              ‚Üì Descendre
                            </button>

                            <button
                              type="button"
                              className="btn-secondary !py-1 !px-3 text-[11px] border-red-500/40 text-red-300 hover:border-red-500"
                              onClick={() => {
                                setCvDraftDirty(true);
                                setCvDraft((prev) => {
                                  if (!prev) return prev;
                                  const xp = [...((prev as any).xp || [])];
                                  xp.splice(idx, 1);
                                  return { ...(prev as any), xp };
                                });
                              }}
                            >
                              Supprimer
                            </button>
                          </div>
                        </div>
                      </details>
                    ))}
                  </div>
                </div>

                {/* Hobbies */}
                <div>
                  <label className="block text-[11px] font-medium text-[var(--muted)] mb-1">Hobbies (virgules)</label>
                  <input
                    className="input w-full"
                    value={joinList(((cvDraft as any).hobbies || []) as string[])}
                    onChange={(e) => {
                      const hobbies = splitList(e.target.value);
                      setCvDraftDirty(true);
                      setCvDraft((prev) => (prev ? ({ ...prev, hobbies } as any) : prev));
                    }}
                  />
                </div>

                {/* Reset */}
                <button
                  type="button"
                  className="btn-secondary w-full"
                  onClick={() => {
                    if (!baseCvModel) return;
                    setCvDraft(baseCvModel);
                    setCvDraftDirty(false);
                    setCvSections(DEFAULT_CV_SECTIONS);
                  }}
                >
                  R√©initialiser au profil IA
                </button>
              </div>
            )}
          </div>

          {/* RIGHT: preview (PDF.js canvas) */}
          <div className="min-h-0 bg-white border-t lg:border-t-0 lg:border-l border-[var(--border)]">
            <PdfCanvasViewer fileUrl={cvPreviewUrl} />
          </div>
        </div>
      </FullScreenModal>

      {/* =============== MODAL LM FULLSCREEN =============== */}
      <FullScreenModal
        open={lmEditorOpen}
        title="√âditeur Lettre de motivation ‚Äî plein √©cran"
        onClose={() => setLmEditorOpen(false)}
        actions={
          <>
            <button type="button" className="btn-secondary !py-2 !px-3 text-[12px]" onClick={() => prepareLmPreview({ ensureText: true })} disabled={lmPdfLoading}>
              R√©g√©n√©rer aper√ßu
            </button>
            <button type="button" className="btn-primary !py-2 !px-3 text-[12px]" onClick={downloadLm} disabled={!lmLastBlob}>
              T√©l√©charger
            </button>
          </>
        }
      >
        <div className="h-full grid grid-cols-1 lg:grid-cols-2 min-h-0">
          <div className="min-h-0 overflow-auto p-3 sm:p-4 border-b lg:border-b-0 lg:border-r border-[var(--border)]">
            <div className="space-y-2">
              <p className="text-[11px] text-[var(--muted)]">√âdite le texte ‚Üí l‚Äôaper√ßu se met √† jour automatiquement (debounce).</p>

              <label className="block text-[11px] font-medium text-[var(--muted)]">Texte (corps uniquement)</label>
              <textarea
                rows={18}
                className="input textarea w-full text-[13px] text-[var(--ink)] bg-[var(--bg)]"
                value={letterBody}
                onChange={(e) => setLetterBody(e.target.value)}
                placeholder="Colle / modifie ici‚Ä¶"
              />

              {lmPdfError && <p className="text-[11px] text-red-400">{lmPdfError}</p>}

              <div className="grid grid-cols-2 gap-2">
                <button type="button" className="btn-secondary" onClick={() => prepareLmPreview({ ensureText: false })} disabled={lmPdfLoading}>
                  R√©g√©n√©rer
                </button>
                <button type="button" className="btn-primary" onClick={downloadLm} disabled={!lmLastBlob}>
                  T√©l√©charger
                </button>
              </div>
            </div>
          </div>

          <div className="min-h-0 bg-white border-t lg:border-t-0 lg:border-l border-[var(--border)]">
            <PdfCanvasViewer fileUrl={lmPreviewUrl} />
          </div>
        </div>
      </FullScreenModal>

      {/* =============== MODAL CV+LM VIEWER =============== */}
      <FullScreenModal
        open={cvLmViewerOpen}
        title="Aper√ßu CV + LM ‚Äî plein √©cran (2 pages)"
        onClose={() => setCvLmViewerOpen(false)}
        actions={
          <>
            <button type="button" className="btn-secondary !py-2 !px-3 text-[12px]" onClick={prepareCvLmPreview} disabled={cvLoading}>
              R√©g√©n√©rer aper√ßu
            </button>
            <button type="button" className="btn-primary !py-2 !px-3 text-[12px]" onClick={downloadCvLm} disabled={!cvLmLastBlob}>
              T√©l√©charger
            </button>
          </>
        }
      >
        <div className="h-full min-h-0">
          <PdfCanvasViewer fileUrl={cvLmPreviewUrl} className="h-full" />
        </div>
      </FullScreenModal>

      {/* Modal templates */}
      {templatesModalOpen && (
        <div className="fixed inset-0 z-[60] flex items-center justify-center p-3" aria-modal="true" role="dialog">
          <div className="absolute inset-0 bg-black/60" onClick={() => setTemplatesModalOpen(false)} />
          <motion.div
            initial={{ opacity: 0, y: 10, scale: 0.98 }}
            animate={{ opacity: 1, y: 0, scale: 1 }}
            transition={{ duration: 0.18 }}
            className="relative w-full max-w-4xl rounded-2xl border border-[var(--border)] bg-[var(--bg)] shadow-xl overflow-hidden"
          >
            <div className="p-3 sm:p-4 border-b border-[var(--border)] bg-[var(--bg-soft)] flex flex-wrap items-center justify-between gap-2">
              <div>
                <p className="text-[13px] font-semibold text-[var(--ink)]">Choisir un mod√®le</p>
                <p className="text-[10px] text-[var(--muted)]">Recherche + s√©lection instantan√©e</p>
              </div>
              <div className="flex items-center gap-2">
                <input
                  value={templateSearch}
                  onChange={(e) => setTemplateSearch(e.target.value)}
                  className="input !py-2 !text-[12px] w-[220px]"
                  placeholder="Rechercher (ex: pro, ats, tech)"
                />
                <button type="button" className="btn-secondary !py-2 !px-3 text-[12px]" onClick={() => setTemplatesModalOpen(false)}>
                  Fermer
                </button>
              </div>
            </div>

            <div className="p-3 sm:p-4 max-h-[70vh] overflow-auto">
              <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
                {filteredTemplates.map((t) => {
                  const active = t.id === cvTemplate;
                  return (
                    <button
                      key={t.id}
                      type="button"
                      onClick={() => {
                        setCvTemplate(t.id);
                        setTemplatesModalOpen(false);
                        setTemplateSearch("");
                      }}
                      className={`text-left rounded-2xl border p-2 bg-[var(--bg-soft)] transition
                        ${active ? "border-[var(--brand)] ring-2 ring-[var(--brand)]/20" : "border-[var(--border)] hover:border-[var(--brand)]/50"}`}
                    >
                      <img
                        src={t.previewSrc}
                        alt={t.label}
                        className="w-full h-[150px] object-cover rounded-xl border border-[var(--border)] bg-white"
                        loading="lazy"
                      />
                      <div className="mt-2">
                        <p className="text-[12px] font-semibold text-[var(--ink)] flex items-center justify-between gap-2">
                          <span>{t.label}</span>
                          {active && (
                            <span className="text-[10px] px-2 py-[2px] rounded-full bg-[var(--brand)]/10 text-[var(--brand)] border border-[var(--brand)]/20">
                              S√©lectionn√©
                            </span>
                          )}
                        </p>
                        <p className="text-[10px] text-[var(--muted)] line-clamp-2">{t.description}</p>
                      </div>
                    </button>
                  );
                })}
              </div>

              {!filteredTemplates.length && <p className="text-center text-[11px] text-[var(--muted)] py-8">Aucun mod√®le trouv√©.</p>}
            </div>
          </motion.div>
        </div>
      )}
    </motion.div>
  );
}
````
