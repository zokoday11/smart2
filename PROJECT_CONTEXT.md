This file is a merged representation of a subset of the codebase, containing files not matching ignore patterns, combined into a single document by Repomix.

# File Summary

## Purpose
This file contains a packed representation of a subset of the repository's contents that is considered the most important context.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.

## File Format
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  a. A header with the file path (## File: path/to/file)
  b. The full contents of the file in a code block

## Usage Guidelines
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.

## Notes
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching these patterns are excluded: node_modules, .next, dist, build, .git
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)

# Directory Structure
```
.firebase/
  hosting.b3V0.cache
  hosting.Lm5leHQ.cache
app/
  admin/
    login/
      page.tsx
    logs/
      page.tsx
    page.tsx
  api/
    generateInterviewQA/
      route.ts
    interview/
      route.ts
    jobs/
      route.ts
    letterAndPitch/
      route.ts
    linkedin/
      exchange/
        route.ts
      token/
        route.ts
    polar/
      checkout/
        route.ts
      test/
        route.ts
    stt/
      route.ts
    webhook/
      polar/
        route.ts
  app/
    apply/
      page.tsx
    credits/
      page.tsx
    cv/
      page.tsx
    history/
      page.tsx
    interview/
      page.tsx
    lm/
      page.tsx
    pitch/
      page.tsx
    settings/
      page.tsx
    tracker/
      page.tsx
    layout.tsx
    page.tsx
  assistance-candidature/
    page.tsx
  auth/
    verify-email/
      page.tsx
  debug/
    polar/
      page.tsx
  forgot-password/
    page.tsx
  login/
    page.tsx
  signup/
    page.tsx
  tech/
    page.tsx
  globals.css
  layout.tsx
  not-found.tsx
  page.tsx
components/
  layout/
    AppLayout.tsx
  user/
    CreditsBadge.tsx
  ActivityTracker.tsx
  AOSProvider.tsx
  BlockedOverlay.tsx
  BuyCreditsButtons.tsx
  InterviewChat.tsx
  LandingFeatures.tsx
  LandingHero.tsx
  LandingStack.tsx
  PaymentHeader.jsx
  PolarCheckoutModal.jsx
  SidebarUser.tsx
  TopbarUser.tsx
context/
  AuthContext.tsx
  CreditsContext.tsx
  LangContext.tsx
functions/
  index.js
  package.json
hooks/
  useAdminGuard.ts
  useUserCredits.ts
  useUserProfile.ts
lib/
  server/
    credits.ts
  auth.ts
  credits.ts
  firebase.ts
  firebaseAdmin.ts
  firestore.ts
  gemini.ts
  interviewPrompt.ts
  ipLocation.ts
  linkedin.ts
  logAuthFailed.ts
  logUsage.ts
  polar-checkout.ts
  polar.ts
  recaptcha.ts
  userTracking.ts
public/
  manifest.webmanifest
types/
  cv.ts
.env.local
.firebaserc
api.txt
firebase.json
firestore.indexes.json
firestore.rules
next-env.d.ts
next.config.mjs
package.json
postcss.config.js
serviceAccountKey.json
setAdmin.js
syncAuthUsersToFirestore.js
tailwind.config.js
tsconfig.json
```

# Files

## File: .firebase/hosting.b3V0.cache
````
tech.txt,1766223612383,c06929675c718dade87617718ea24733344b1ab79a75b3f11ed9c9b5887c734a
signup.txt,1766223612384,6a208204e71373e7ec3c137cf801f59175df6fb71bec342b8817bae1a75cd431
manifest.webmanifest,1766223611196,b125a9afb1b3c4b81daaf5442dd9d589e2367c37c2fd3305fa23247173975337
signup.html,1766223612380,f7357d7a32880bb5c7112063d9c24780b44f73fa529907bd3021acd7a0786f9c
login.html,1766223612379,6e3c11e4d9765a11ba51549ddfc40a769064b9784d878a3aaffce4fb320d2388
forgot-password.txt,1766223612384,08ba7a8e07a0a8dd8411608a028173b90402a9a6877856bc6489f58af95ba994
index.txt,1766223612383,b6ad54c0162d5be64d03b4d06dd4e3908e54153826119f9496b25b2b5e9dbfd6
login.txt,1766223612383,8832aaed79a8dd1d1c40ac15fd5dd5dfe369ca53f998aa4b5399757d164b5509
assistance-candidature.txt,1766223612384,cc52c1f960f79b8d01d8544222dfa341e6f3fd7a81c7053537297093509730ff
forgot-password.html,1766223612379,e836b23b12e9d554eafa5dc10fbb12ba7419d6f04cd7cc61283efc13023c2a56
tech.html,1766223612379,41bcbd865ce2ebeafeadc8485f095582d477ef9919a3aa97de983fa00197ef03
app.txt,1766223612384,64e006c64558521a6b2cb875ab4c8f8cc4442b7f1531f527b56aa53fc7878d67
app.html,1766223612380,85c9f13f974c5fea60d49f5ab5f45c0883ab9e0c3fa1eabe6b50b51232b95520
admin.txt,1766223612381,e4ffe2773d972c9cb898d7249b581bdb41cac5c19c496e6964a1af039c510030
404.html,1766223611965,a6ac7cff23e13922b20c5674be9e507c1d2009b8da794d211fafb2996cccb356
admin.html,1766223612376,314792363434c005b301495c4303c863bbfc2517807a5a0e99283d92fca1a716
debug/polar.txt,1766223612381,ed875d6c84d72bb95eeb4b1600b08551be8ee06d4f19ea5513f6de5ca49605b1
debug/polar.html,1766223612377,70d61524d01038fcacd54a73e033c67b44daf605ed046ac5e851b12b332b5323
auth/verify-email.txt,1766223612380,2fa3e3130d3a804f32af0c461706b3f0e0ce876297f90268814a9834c261abf1
app/tracker.html,1766223612378,be57c20725ecc286d1809ca72a850e6c05433c5c9605f88a5750aaa318d71aec
auth/verify-email.html,1766223612375,320d84d75c11797dcce535e8b5a0fa67705cef0d95c590a5e7ea7ec08967f4a1
app/tracker.txt,1766223612383,f108523e998dbca8fce28ed06f4b8f65977015fc1a31267ce9a55eaf1e44587c
app/settings.html,1766223612378,2cabdf2a810eccb81fe7b6f644557c7a644f1e52e7125b7772b3a1d505c99e08
app/settings.txt,1766223612382,4ba7b0d7fae135771f5d59ebd1f703c118c2995e69dcf63fdaa962387675ae44
app/pitch.txt,1766223612383,e0476dd0f6d769c52c7bf6c959a7ca66024e701b2fc5210b420d5a54ddae7d0d
app/pitch.html,1766223612377,04b8f32eda1be930e8ff879bde89fca3d3820c7490499203f7f697f99c1b8338
app/lm.txt,1766223612382,4c88b7be3bcb5d3a6e1080ee381976425598f3c3f22a9e4ee9dae2abe6c5e78f
app/lm.html,1766223612377,3ef282c4ae44a74f0232187d6cc8695b8059b77aa4b25ec99dd201aeb8185835
app/interview.txt,1766223612383,3e3fbfa657b4b5b85fbe207e61ede3d6c5d5355e944d87e5d912c67a8fd74471
app/history.txt,1766223612384,da687c2a8c5a07ba796d7143c28a42279c2639688f28eb2a19dd682421e35c1a
app/interview.html,1766223612378,6b742a05285cce9e02465c1fcac97cef6815e15af36aa572137e9e7098bff34f
app/cv.txt,1766223612381,5e4ef1f75684531f9162476044ff81ee6a5c207a1b197738efb72d73ff7026b2
app/history.html,1766223612380,6939756f95ddaad95a44ef9143d191d287b6e6e70e82b638306d22c302469a71
app/cv.html,1766223612376,ae002d8e451bb5ddbe2b3d5b6d04d05c1674d3f70a24fbb9243be728db365cf5
app/credits.txt,1766223612381,ac433d78002f499967d955d8c4587e9db99e7a1df2b7e0dda61073aeac7c6d10
app/credits.html,1766223612377,bcba3063357a4c0e64f797d51dfc8699d0d9d282ffecb2e0913845ec8c3b9a0a
app/apply.html,1766223612375,32279eae5474f626340d4341c6fceff6e9e00dde9bcebf330df40cf26d26eb39
app/apply.txt,1766223612380,91d26fc2ec75f0116a35daeb6613932231d812e8b7efe4f7f2e8cf81b8aa486c
assistance-candidature.html,1766223612380,af97bc1fc1899ef73e378f961e3b6f9f5a3f401f3c011a6d5a2edcdd4d357e9d
index.html,1766223612379,bef740516134e02824d2cc5f563856fafad1d141886506968e8b2340d51aaef0
api/polar/test,1766223612378,35d1b34b7807696b8413c672871fcf26b35d968667e349dfbe811cedc67ac17a
admin/logs.txt,1766223612381,39cab3fae3383426278ed43c19c854356ceb893556a043fb479e0e2f9127073c
admin/login.txt,1766223612382,4f1fece10a0af95f44279caaa66e1d3c2f50754a8c7806a78488365b1676fff2
admin/logs.html,1766223612376,891c26f32b41ce1031bc844ce4e53a1f7ef5b4ff2ff4bae1ae70dacb83f670fd
_next/static/css/57fd5f904f4111d7.css,1766223611178,172ce9d553d95887b09135dc6fe3164cc05c4ee3faed3b64273c32ead296738a
_next/static/chunks/main-app-7466cb2517b2ac24.js,1766223611177,3dad6f439d8b157d2427b4087aaeff0fef56e1e1041ee3b5f0fad10bf506a92d
admin/login.html,1766223612377,8effedaba8a1f1d12861055fcb2bd94a058a5ce447b23b07b8dac81e89a0eb58
_next/static/chunks/webpack-03f7c6bc932ce1e3.js,1766223611177,219ca515b71e6f5157cf2be9e7c5ef5500867d0db4e6e5e0efc2f95786ce32ef
_next/static/chunks/polyfills-42372ed130431b0a.js,1766223611178,67dee1c02c6a6700d63b5c1898cf2df618101a68a395db469192763d24925a23
_next/static/chunks/648-a41745ebae293ba3.js,1766223611169,d08de5f20a30c50b96e1cb68dfbec730d23ae67cba384f345e34c09b6adddaf3
_next/static/chunks/pages/_error-7ba65e1336b92748.js,1766223611181,0402d6340a70945d851b2d22e156d955fbee54c1d8ec8b379f35fd464a8d08bf
_next/static/chunks/276-a01f3bf27c64a121.js,1766223611167,7959269d2568322cb0a6253c58e7242b54d27d373aa32b7b0c05474bf95e8fd1
_next/static/chunks/pages/_app-72b849fbd24ac258.js,1766223611181,dae29acdf0128939e571909a9228115276818bce739f4d0f98c1da8ed68ba91d
_next/static/chunks/app/not-found-a7d2e025cdaae076.js,1766223611179,8ec8fde655d80c0e5d37c7714dac9911aa99f5add99e26b2820f5afcda111b2a
_next/static/chunks/app/page-2cb43cd786a135b3.js,1766223611179,005704db2d8038cf89ed2990bf49600a72ed1e06bab8c27c410a6e391b1d2231
_next/static/chunks/app/layout-4b9561a229a596fc.js,1766223611181,0c53b31434c9b9491b1db2a45a447193c182cd5eee0754e19418bcadce76eb76
_next/static/chunks/app/tech/page-cc145f1ea41d0f3b.js,1766223611184,9782dc820a4127292f16e053f0bcc1695227f9ba956897623c527946b7b8fdc5
_next/static/chunks/app/signup/page-415d35620f5a8925.js,1766223611184,23a69dc0e5be865291fefc093d134779c918bef51b683c33c9b2d39280c61adc
_next/static/chunks/app/login/page-c06e2b6ded9b49f3.js,1766223611184,67b1ba5beb488bc4f537a597c44233d67135bcc1566758ab79c5117628478a01
_next/static/chunks/app/forgot-password/page-1e8246d3701842f8.js,1766223611183,c5c00836a859da9166998b632679fa0ace77fb105034f37d6d863730aa0a7159
_next/static/chunks/main-76e1bcb595671093.js,1766223611175,bbcdc180a07d600a7f8dcfa6d3267afdec0b918f9bc722e4764b72782a68d238
_next/static/chunks/app/debug/polar/page-49599eb8d5dda592.js,1766223611188,eae0b7def982e0bf3068fde94e7f0f34defeceee17e2646fb7a9cb846c72169e
_next/static/chunks/app/assistance-candidature/page-f38626f0664fd689.js,1766223611183,81d9766776f30fbac7fbd008ba3ab85a44d797761bc1a6972d105a47c69f101f
_next/static/chunks/app/auth/verify-email/page-76a5806573e2ffe6.js,1766223611190,6b22e7525d83798f87b4b2b1d90798e6972b3edc575929ee1352938bfa718515
_next/static/chunks/app/app/layout-a7a5ce754bd1ad16.js,1766223611182,47da4ba9f8b5600fd9cb70eb46bf190b3ea02b503488dfb3560c83c2a3d7b7b8
_next/static/chunks/app/app/tracker/page-51ccc58e2af34ece.js,1766223611187,0b68abda42bcfe86ea7274e10859d1964851010b96b165ed852ecfd58ae16571
_next/static/chunks/app/app/page-b641c52499f8e749.js,1766223611183,f79254300ae18826e790c276848a5aa9223b69f41cb2b8516b8841a1e43a435b
_next/static/chunks/app/app/settings/page-954eb241eae96c3b.js,1766223611191,a65265b14afa8476fb7b78ff2f3f18b8989aec6b6b50f4b02960185d8fca1d76
_next/static/chunks/app/app/pitch/page-a42bf5337283b380.js,1766223611186,8bb08510d6cd6129e33e6ec8e6fbd346c590b1fce79e8c3fd1af1c8492f985d1
_next/static/chunks/app/app/lm/page-f4f00a550e788f79.js,1766223611189,0485551045e1af86f61c5888bb4135463b53f65cbac218bb2399a234fd0f8de2
_next/static/chunks/app/app/history/page-b44f1b622671fb6b.js,1766223611186,2b50c7db092b6dc9ae36249d114bd85396746f0b795a72f18bc9e9432fdd325b
_next/static/chunks/app/app/cv/page-492c1c2b5ea110d3.js,1766223611185,27b93316c1ef03d32314815e1199788b00fbc1166d05264ad35be6c9b1aed703
_next/static/chunks/app/app/interview/page-40c5ab747064b228.js,1766223611188,16f0b930bd092ef2df8ab52ed0055b3302bd2d38656127a0bd302aa93a63c2c9
_next/static/chunks/app/app/credits/page-da7b638bc6a4dc63.js,1766223611186,b354374892ff09c7b40b3f46a63c8c22a7f71c29267d087cef7b69db4ca914c9
_next/static/chunks/app/app/apply/page-4b1674fce4aea889.js,1766223611188,ade9f6c59cd78012d78ce2f721ae446a30017dfdb3bbf86207d3ad0e0e558572
_next/static/chunks/app/admin/page-35b010b882f8dea6.js,1766223611181,8bc2d31560e4e32b0c29fd167e4bda2a4c421fdbf15a83fe5ad1253555f62b2a
_next/static/chunks/app/admin/logs/page-22e44ce20ea54b75.js,1766223611186,554379c156358ee21df7e2bad9172a59004c4a34179d606eec21ae1da9d2e808
_next/static/chunks/app/admin/login/page-2e6925e9ae333b95.js,1766223611185,b90b810232b2619ad3be8ca04464545ed5bee12883d847e4577c1320ac8f4e14
_next/static/chunks/app/_not-found/page-7494094633467ef3.js,1766223611181,dcfa115b285fc1e7d920913e1a0464349f8c270c107df17678afbcaee62abec0
_next/static/08GGivBeUcLdBWsncvPYC/_ssgManifest.js,1766223611166,02dbc1aeab6ef0a6ff2ff9a1643158cf9bb38929945eaa343a3627dee9ba6778
_next/static/08GGivBeUcLdBWsncvPYC/_buildManifest.js,1766223611166,f46b17d6e2e887329d388286773626796e64b52f4cd965c9b0fe037e97f3ad58
_next/static/chunks/ebf8faf4-eb27ebf8c37d4d67.js,1766223611172,a107c6566fbc2f52b78a30e52b2ae3b7b84b0da4ffe8d15f24849c217e372a5d
_next/static/chunks/941-da853eb9ae4bc965.js,1766223611170,f4b97a2711ed98aa8723dcc66969fec23e3ebc576ff38e09fd1f1cd10bd20a82
_next/static/chunks/810-039b9229cc1a2fae.js,1766223611170,2f29a61132b062dab1e63516e7337a67aede0bce268795b569dfccfc5c400bab
_next/static/chunks/600-2ae2ab76ace4e875.js,1766223611168,ea47caf34ad27d1a524604c65a1c0ecc0f6fb1f64426749920e60ac529a33563
_next/static/chunks/framework-aec844d2ccbe7592.js,1766223611173,36f12099915a78862f76158596a2aac7e86dd87ba94f4d3b896a7749c5e4c9d6
_next/static/chunks/fd9d1056-b4129a380d1be68f.js,1766223611173,8b73f2ae4babb3d70adf200a16329555cd03b390ca97f3fa3368428ebc73c549
_next/static/chunks/7508b87c-2affb3ad7b55ab3d.js,1766223611169,798ec3d71f923e838d157bf4dd01e76244b35e1c9634e28e77c89c9df89a676d
_next/static/chunks/ca377847-044365abace2608d.js,1766223611171,c6e43c770559cc5ee6605295131dc3e9de57d9fda82d7043e9b70b2f97bc8002
````

## File: .firebase/hosting.Lm5leHQ.cache
````
required-server-files.json,1764026729350,faa6020d48adf6312d77ee01042cf6db7bce645322cec2497961e1fcf6323c07
react-loadable-manifest.json,1764026716482,a4b04944443134617e3f0ce2d83bd80777944443377c1b3d27d20980cd705f74
prerender-manifest.json,1764026735152,c2dc04e5dabc25e9acc484a2f3460a62c09af8ede877366b92f51c7fdddba5d4
routes-manifest.json,1764026698224,c555d09020c1ff150941161b9ffc7c997b163ac15f30362a0bed428829832180
prerender-manifest.js,1764026735242,c303b184a8a946bc7e3178fc2577c9d562e9b2ffef83363530d37b0e22dc244c
package.json,1764026698223,bcb9a16329e98e1c8a36644006703f1ec868425fd8a87f6e56461c280b826234
next-minimal-server.js.nft.json,1764026743650,03fda4dba157e3caf24f302b96fe9664d8bec48b55b00d683b6ba17d486fa52f
next-server.js.nft.json,1764026743650,f4f5ad4c61d468a0f4acf7234de162444a89622b9f67a97128027b3fe92923c2
images-manifest.json,1764026735376,5debd95a6cb1ddabb0f4052b9ffa429290ee932f8cafc4ec0aab6d9f85e1cf55
export-marker.json,1764026735452,56b9bc6d101d87fcd90a42b4b20f18c87e9ad5fd6523ba1b2fa67f01c00843a2
build-manifest.json,1764026716483,1ea5b8a9339bbe2731223db127d0d67559807118e45a5a2ff7df9eff69b2dc9b
app-path-routes-manifest.json,1764026727489,0f7e2d1f6b9259941d2a2314c3a8947307a1354e3fd6cff1cf2a39e00b2d6e92
app-build-manifest.json,1764026716483,a85c7e52f7458bcba0e631143f1bb4177504b67e10dda402725ccbae62600efe
BUILD_ID,1764026729338,8ffea43f5de75690d4b9438d09393a005a72499ab5e565a70be72287abf8b43c
types/package.json,1764026705341,fb83e1c2e553bcd88716e880a7ad4c4a77e92bdc857ac531d99436a10cea04cf
types/app/page.ts,1764026705308,eb5f4e457ec07e31870d6aea56e3e55b8554c6024ca41292e56de4fb3092cc68
types/app/layout.ts,1764026705341,e84d5dc310608f208720abf21293e6a60114940444c9cff3f4ba76a03ba4d588
types/app/tech/page.ts,1764026705308,1c1809941d2ff3ec07d2670ca7367cb0175ce3159f37236a2e406a21575490c3
types/app/signup/page.ts,1764026705308,2ecd725092fe78e6df6710e98a6065a24f4023f08ec6cf7f96891ffbb3c7dbb1
types/app/login/page.ts,1764026705308,f25be1d3cca2bde80b18561cd235c15fd1b027514d619b383d05879d6b191d67
types/app/auth/verify-email/page.ts,1764026705310,ca58d246324b7d9e65b0b840cbb8277cc29eba583b02c633b24572c91e756bc7
types/app/assistance-candidature/page.ts,1764026705308,55d4152496dbd96043d2461bd92ed9da4526a59d5e65da62bfa38eb804b59adf
types/app/app/page.ts,1764026705310,e72891a038ac654f4c1eee106b84fe9c84d104e5c1fa943bfaa683c9417ea831
types/app/app/tracker/page.ts,1764026705335,486c4ede492e2d58ecd1ef492aab0801a80663818e5869f2000076da64e38ec5
types/app/app/settings/page.ts,1764026705340,005d08996f221e5a26fd79615992288bf4683e2b1424625003e18b105621d539
types/app/app/pitch/page.ts,1764026705323,32b4c30794640bfcfac04ad8decfabf7b8f2d683346bb53b2bed1132b02005b5
types/app/app/lm/page.ts,1764026705340,2233e5615e959240bac8ad67c0db8beea8f9f19fee57661de34b9f380fa6d789
types/app/app/interview/page.ts,1764026705340,9d78266af5c0f20bec41e7f03cae3681fc6c654a722e359d3fab95613039099b
types/app/app/history/page.ts,1764026705341,8a87b2de60976ed83e769956351c4a520f2a9971134d448ead947683c9894e53
types/app/app/cv/page.ts,1764026705340,f3976927c7206640aa5edeb639f91394c004ac0e7df3b2d6776a34345c5629f1
types/app/app/credits/page.ts,1764026705335,9318f268d91b6cbb421d05fba6440521dda42fcbd8de5eeded42c1e17609cd19
types/app/app/apply/page.ts,1764026705340,fbf31f45950016f60250a4a68be2f3844580fe28ee8746ec3eeda1be96949288
types/app/api/polar/webhook/route.ts,1764026705336,ef908572982192c9c27ede864e28b0adc21ecb6b5999a92fd24bbb20d48e04ba
types/app/api/linkedin/token/route.ts,1764026705336,b6acc7578d8b261dde27ca5221926edc9dcc6ffae4b7c717086247f186ec126d
types/app/api/linkedin/exchange/route.ts,1764026705337,4ea317891c345be889c9f48705e043e68f2bb2ffedb699eaf7f391dd572e3151
types/app/admin/page.ts,1764026705308,f4adbbf8eb01a045ab920a9c925ee8829da2e3c2869fcf007ac944e6ff12573f
types/app/admin/login/page.ts,1764026705313,45292f68178863776fa57801f8e2cc7839220fbc6799ea95a35d9feb770d2a60
static/chunks/webpack-91b2d14d0f678b80.js,1764026716472,7c5b4f6fc9c1c64625417a25000feb25495d11438ab49c90c36caf9d44e92e41
static/css/f22078e41cee5400.css,1764026716494,c7f33f4b5844e54993038946795c4511df4869cc0e7bd46d4f354a67714e0dc2
static/chunks/main-app-2e7364934d9bcc31.js,1764026716459,7202fc85e98aa93028029008f04ed2823d9a1809fcb72df44136c86df86c7def
trace,1764026743694,f8982d26a68ebf31317c92875f27a5817a817abfb80054656438167c9ea5d48a
static/chunks/621-3d25d5ee54bc5eb1.js,1764026716483,d5ce8437d45b55a2628db37c20cfe2c717971b5e9ca112e83beae4c6ca49bf52
static/chunks/polyfills-78c92fac7aa8fdd8.js,1764026716483,a5b39edcc77b6069d442b5dbeb8091cf27ac47ac7a1a99cfc325213bdaae2fb5
static/chunks/main-2794a98e2503d678.js,1764026716459,8835a50251026fb0b1617e03639469a4ad86883c4ec70e881e041e31ba8ec66a
static/chunks/69806262-c31872e60297e46d.js,1764026716473,4f4211a27aba4cfd537d50cd51661fcb603d911bd0635b3487c5bc4980bc0c6f
static/chunks/pages/_error-1be831200e60c5c0.js,1764026716460,7ba7b69d070dbc710e451691d369b4ce050c7aff928d7ff030baa21135383430
static/chunks/pages/_app-6a626577ffa902a4.js,1764026716459,033ba1808728c513ad0a88d7ddf19b808f355e4bccb8e18dd6b1928961cf7a45
static/chunks/138-7507c07ab2f9fc1d.js,1764026716483,91e92091a4d37d24da31f94ea676dce2e0025aa584bf1d4a0d8c3524724926b4
static/chunks/app/not-found-0d92631d0244d996.js,1764026716459,c13384c322e45582ecb54e7581d10f6105a2e6f929d88b88a4fb3699c2042dab
static/chunks/app/layout-a618519e30fc5082.js,1764026716459,ead943790b104200135437395cd72a436cd761755cff12d9bb499a995f5ba3c7
static/chunks/app/page-190ea484f1cfb43c.js,1764026716459,3edcd45c01c081de96cde9e577c19bfb60fa523fb8db2130b72c31fb37db2fdc
static/chunks/955-3cd8599ce6aa07c2.js,1764026716482,480a8d35d35df333d9754ff92b6c5e523e4649270ebf535ec31aff8256bab0ca
static/chunks/app/tech/page-53b001589ec4b409.js,1764026716460,82387e0dc4c5ab6527090c260f51d025e5a2e07867679264f4dd83d63acb4954
static/chunks/app/signup/page-591af0428c3c8d19.js,1764026716459,6eea57794e7ad969d32d0aba976ae81201105f5d07cb42995c36d713dac2679c
static/chunks/app/login/page-383e7d3fb5f56246.js,1764026716460,97e046275c288f6cc40e2aeb32c4ecbb409ba7f415b3805ca275fbd88034cc0a
static/chunks/app/auth/verify-email/page-ac86f774492d8f10.js,1764026716460,b49a5154c933ccf2153a02edf6e8f7607f7c022c12ef2cef4fda7b3c38a01fef
static/chunks/app/assistance-candidature/page-4e3c0a0fbfaa46b9.js,1764026716459,5ea28e433b8f80ac391dace8d3af730568b30c0fc88328dab306688b43caff8b
static/chunks/app/app/lm/page-d2424b1c58ec485f.js,1764026716471,4b7b2dc1668e8a9af41882a291f8498c0917ee195675af10a3ab0c05347585ce
static/chunks/app/app/page-93cc857ad2ae5002.js,1764026716472,deb3b43928d34631b9960284e84ae575600416f3f4e43d00878ec476cb85f157
static/chunks/app/app/credits/page-e697f2bb8d726ec9.js,1764026716474,d738c16316413f56a09a8bb7246b9ad9df561eec2205c30b83af6a422e156272
static/chunks/app/app/layout-6aed7b227000a15a.js,1764026716472,c3e1ff34f45c8e28aed9bb74fe054d4c3d26940b7b7dc015dd2b4249cad51507
static/chunks/app/app/apply/page-ff605542414d7f7f.js,1764026716471,3d1a478dc7704b5fb18f64410fc3872edea77f1e7d65c0820632b79f0991982c
static/chunks/app/admin/login/page-240daa14bb4852c0.js,1764026716460,ae17b8fa6940c6f38f0c1e6268f3d82a79d22b6033f0f074c834c9e4831618e1
static/chunks/app/admin/page-8857cf2a57926d01.js,1764026716459,9045bdbd33a422215036810dbb37d02cac3c3d959114dfef839ff197ec9c3a40
static/chunks/app/_not-found/page-29db342e34374c89.js,1764026716459,13d3e75033764ed3306d7ec29efe4c83d3e4cc0af66065fd8578935ffb4df03a
static/-dT6A1SvnRSySsEbysDYr/_ssgManifest.js,1764026735319,02dbc1aeab6ef0a6ff2ff9a1643158cf9bb38929945eaa343a3627dee9ba6778
static/-dT6A1SvnRSySsEbysDYr/_buildManifest.js,1764026716489,d69e5a007397f17b35522afa5231f150a71e70144a0b25094b29b45bb5e6de96
server/server-reference-manifest.json,1764026705342,ca34e4b77172d3b8b2702eaac9586210574c409b034aa6dc731084dbc23786a9
server/webpack-runtime.js,1764026705293,f45ae6f81d5f7169cc53c6f3fa69a4c25238876a6692c08599ed810c58bd416f
server/pages-manifest.json,1764026734952,6b5834025a891ba7f8c4c4d40d486c8fc382a0b20353347d0b1e3e9265a45d00
server/next-font-manifest.json,1764026716491,7b3fdd39ef88a4f1a399b6c5db0e293276d61e74616d22506da791d19c18853d
server/middleware-react-loadable-manifest.js,1764026716485,ab4b3550c791b0ce095966989fb559527bc579db9697f53478f9996a28acf179
server/next-font-manifest.js,1764026716491,0516113d642299cc41ed8dfbcc3411732df29e0731dcf16fb2c18ce648e556fc
server/server-reference-manifest.js,1764026705341,ad544a760a19d613df67fe08face8e009a2f0d83a57ba0b29760deaf00b01ece
server/middleware-manifest.json,1764026708873,44131e01ea364a61de764fb249651ffe6fdcae5b7ab75e7f56ab60aeeed8e9dc
server/interception-route-rewrite-manifest.js,1764026708873,0e1ba25843e7639a44c34068a45a9e043402eeb3cd1ccc5c2d84b99b6ec810ac
server/middleware-build-manifest.js,1764026716485,5be83cf816efb1c65bf3cda845c83b875abf6811bc389e40bbaaf1f6857801a6
static/chunks/app/app/tracker/page-0ce47c9c65c0fc6d.js,1764026716471,3e41ecc6f797416d7f4830d2bb5fda4439984de5cc9c13501438412b3a9f5cef
server/functions-config-manifest.json,1764026729286,6b736f30bb3e680388457fe5fbb0293db3a6fb06c47a7df50a348236717fa747
static/chunks/app/app/cv/page-4c9c75503c5069c8.js,1764026716474,058266404ce25a3d25b9fc797c1af672ab0d4dc7873c60615413bc7db1e7f7b5
static/chunks/app/app/settings/page-8c2e33a56a848599.js,1764026716471,97a5c69d6ab86734367532759ccada046ef4b8a39a261f0ec60e4650d0308778
static/chunks/framework-aec844d2ccbe7592.js,1764026716472,7885994d6203224805fffa95f6a6551af6903a76bbec7b9292d3ea205e7d447f
static/chunks/app/app/pitch/page-c31ce7b3525e659c.js,1764026716472,6531b907e07757401e38643ff35e9a408b220fdaa1469a164e10575627a68391
server/font-manifest.json,1764026705298,6731668a37f6a3ed10d77860e21c7ba693c377a061571ffa58564d1d699c1798
static/chunks/app/app/history/page-ba2f61e7c7cba866.js,1764026716474,544e40ded57e5639de2f84d5c6885ec08d561ee40ce2cfbccc9a821ad27f6b45
static/chunks/app/app/interview/page-bd53d6b7237f5620.js,1764026716471,dcd71273057154c86d38f8fd2ebd663e8283f8917a5571838ebd0a8e557d1707
static/chunks/fd9d1056-41afe60f3d3c21b2.js,1764026716488,1ad5b60900951695550bcfb3b5d43784825075257435b5badf3d5a7ed4b9e1f9
server/app-paths-manifest.json,1764026708856,45cdce38d3d1053f583b65c1192527cc7fb98391a72500cc8ef6a7ff0ef4ad7c
static/chunks/ca377847-ba88b40a0691822b.js,1764026716483,f3518b038f5ba71224751678bfd02c707f512eefa5d99b943a692d6f622dc782
server/pages/_error.js.nft.json,1764026743627,f3103a2cfb0e52a9142f5cc1cec951e7df09a28c7866b47c952c49f6d6948448
static/chunks/23-a018d5b946342a64.js,1764026716483,ecc22580e6753b5bc285b46a3d4336d95e37f088effb8ab7d47f4d409d6fee9e
server/pages/_error.js,1764026705283,9d1484768dbdce62ae27550ee0aac87c0536b4b01538cf2ebe5915abb36d73aa
server/pages/_document.js.nft.json,1764026743625,1dd6b313b1f1df84db1c05ed61eecb61fb22a30586efffacb790ec02f90c4bb3
static/chunks/bc9e92e6-c92f39a73848b8a1.js,1764026716472,0ca8c089ad5759331761854b39e094ef24612544c3168410548694e9c6e39b55
server/pages/_document.js,1764026705289,ca5276420d329a86d6e2c6caef0b20a86f4060fb2bd896f4402c340574b1bccd
server/pages/_app.js.nft.json,1764026743632,f2ae4965a89bff1105ee000b4bc1f1ba040469c3f396e9ed79df07183847998c
server/pages/404.html,1764026734419,2a92d454d1b10bcb8e5b90c0b4f5713a80604534421865f4718537521ce9edf3
server/pages/_app.js,1764026705283,a096157015a2ee91a3984993ff98682529ad435c4329eb6ab6ec2f4fb7526ee6
server/pages/500.html,1764026732565,9dedaef1bccf8b51bbd4c1384d7ccfdf9058f85fdb7135ff8bc28f98d09e713b
server/chunks/682.js,1764026705296,6a55378f19ef26f47fbf66ad6b48b5748e5a7362772a03d202666923760c1e0e
server/chunks/972.js,1764026705294,043102158eeed7586923d8ccb7f4919c6e03838e09781a28a7e21c0bf501347f
server/chunks/10.js,1764026705298,58062128d087253d99f7dc626327229010b1b42eb620ebcf62f2e031b37a535e
server/app/tech.rsc,1764026734276,d2b3ffaec2c87d96c92d6e8573f916400a5c6808c7e6962e210f8a37cf9c4070
server/app/signup.rsc,1764026734275,2669465a36bda815d470758e6a29eb4acf66315049fb7254ee472293bc1a839f
server/app/tech.html,1764026734280,1a0a62430c185dd4733e86cfe9094b29d914812ffa81565f975dacb7c6a212cd
server/app/signup.meta,1764026734283,1cf7ec4b44fa726f7cf2f4f406aa5858e7ddd0a3ace5f41848d08fdbdc3710b8
server/app/signup.html,1764026734280,c0f3d377ca269e095072bfcaca236b264be51d202d3e0e53ad6c6bce28425614
server/app/tech.meta,1764026734282,b606cdc8a28c2ca43bbf810d893410eacf65cb38d5936bf1d2a2cbb096aeb47e
server/app/page_client-reference-manifest.js,1764026716491,f6666f371b5566cb6dc0332593948d0ab1db8fc5c7ff837e91d373e7be52044c
server/app/login.meta,1764026733996,679384b27256e79d6787a0422a20ff18e239f15a72dce53443e9a3672ebb9462
server/app/index.meta,1764026734058,e9cb1abe59404b1848c500ac3b6029bf17116af5bbd827f20260f2f077fe0d2f
server/app/login.html,1764026733996,c71b92cb4e734cfcb97cd05aec2f5e4f1d2d6be200473feaaa788dbfbad5bced
server/app/index.rsc,1764026734056,c22cc93a96116d70263e1b8ddd916282c26dc7766c69551e435fdd7bd2b78958
static/chunks/537-ce8c447b5bd64451.js,1764026716482,0450691049244cddbca2d67e1e0dc5006bb87db3de4d8241e8025d00a35df387
server/app/page.js.nft.json,1764026743625,6c24862ba2dc96868dbae9fc6285e6849eecf4935514c919bab08319abc6ac42
server/app/assistance-candidature.meta,1764026733756,00a26dd8b3f23eea682f5680b5e19dc2cb4208d4582978a5cfad884598ed8cf1
server/app/page.js,1764026705284,8077e599228bd79bd609dafa51a3bc9eefa7310575c321e8a733b6f9acbfba8d
server/app/app.meta,1764026734137,2194b0478a36dd1305b778f19930aa2c5e954f69368a9754cca6497d31a38a03
server/app/assistance-candidature.html,1764026733755,ca0785855d9a6e74ca71b7c592d04e9729dea0be113c5e8f123a6baf291d7c3d
server/app/index.html,1764026734057,b3c358fe8644453109f63842214c39e781bd028ba8f564c3a46600d1dc73b6bf
server/app/assistance-candidature.rsc,1764026733753,085b5f5d02075cc7831e5685da4698bd195f8bca8e5d98d90dc04a43ab770d00
server/app/app.rsc,1764026734134,c063a2c72b60a0ab00edb158b474794fafe3f163caedf530b40b9317f66959fb
server/app/login.rsc,1764026733995,2d3efda02f056683d18904c2a8b90691f9431fc2f7886ad620a956633d9c2ae5
server/app/admin.meta,1764026734286,bad0bdc40e9b73db07237079f2a6b06235490bc56fd7f6a8b690715b776fdbef
server/app/admin.rsc,1764026734281,190316dacf7193c6adfcbd5432605d3fb8558101e679859b05935b4dfc74e0a0
server/app/_not-found.rsc,1764026733382,5696cea366f6693fba34d602c73bd7006e98acb9452eba68627691b7ced74b34
server/chunks/font-manifest.json,1764026705282,6731668a37f6a3ed10d77860e21c7ba693c377a061571ffa58564d1d699c1798
server/app/_not-found.meta,1764026733388,9b0ddfb98f277970ee75de2f4f80679d4dd59e2a89b379098d839d061197756a
server/app/app.html,1764026734136,264f638ccb796245130f1b0de12b5a272a5c951f8feb62814b753befd2d0d966
server/app/admin.html,1764026734284,5a291647c83b11c32fefd0be5b61a8c39663adb4d4dec39d978a76d91657e978
server/app/_not-found.html,1764026733383,2a92d454d1b10bcb8e5b90c0b4f5713a80604534421865f4718537521ce9edf3
server/app/tech/page_client-reference-manifest.js,1764026716491,4cb279f8a0aa972deca94ab59fbc5f8e189e66fc09bea71b9715d13da8db44ee
server/app/tech/page.js.nft.json,1764026743625,c0c74ad18a7a75c1ca768f1e20ff8ec89e2456a16a4c8a18732f99f2cae9733a
server/app/tech/page.js,1764026705287,a338325f6261aa37b8ff54536cc6d2163a31893183bc3c6b06b04aa98432b0ad
server/app/signup/page_client-reference-manifest.js,1764026716491,0aa207798d24880c6d135e4015cca8c449b4ca38af6f4f888b8f578e142b1dc0
server/app/signup/page.js.nft.json,1764026743625,c0c74ad18a7a75c1ca768f1e20ff8ec89e2456a16a4c8a18732f99f2cae9733a
server/chunks/948.js,1764026705293,45033c1f6d5616f7e5e9016c200b580bf07b343b92364805de6aa6522f4baaea
server/app/login/page.js.nft.json,1764026743625,c0c74ad18a7a75c1ca768f1e20ff8ec89e2456a16a4c8a18732f99f2cae9733a
server/app/signup/page.js,1764026705287,aa26db4277e6d7c8363bee453fc727fb805b8bc4885aeaf917159869a4c0b00e
server/app/login/page_client-reference-manifest.js,1764026716491,fc53f4672b147e77f93994ff59677cad50faea7f79ee1ae6abee092981cac522
server/app/login/page.js,1764026705287,100fab30d891de1777220a3b2d636c694d5e838ea5f497dfe5e9b30bef2cd90b
server/app/auth/verify-email.rsc,1764026733892,79b6010bd5bc699a565a762c7be931b4a555f4506f32e506274c48f566f0bc1a
server/app/auth/verify-email.meta,1764026733894,a566cf5ac4ba42c2c0c00beafe61da29f999e19cd8c2f05a8379d230a3412914
server/chunks/622.js,1764026705294,84df62a3bfcba640cfe8018c547ed03638c80ae16a43f7963854170dd8ee1cf1
server/app/auth/verify-email/page_client-reference-manifest.js,1764026716491,b2fd220f62f00eb4a627dd91df75ead2640bbf193dcb5f4f5571eb9622cc15c0
server/app/auth/verify-email/page.js.nft.json,1764026743625,5ba162c85b003181ae736d2e1d05076f88aaf5cbe721466503d5c8640b140c48
server/app/auth/verify-email/page.js,1764026705287,dd31014c15fdba7ecb3cc643106596df8d4eff65d74834c9cee62974474c2bfd
server/app/assistance-candidature/page_client-reference-manifest.js,1764026716491,857b2dff3047f4ae127742ffdc690c6ecc540238bc988e09e511142399efa91c
server/app/auth/verify-email.html,1764026733894,05d9001c10b2514cf36f1eb5341bab3e4f9cd6ab61243f2d51c6ae8a6b88fca1
server/app/assistance-candidature/page.js.nft.json,1764026743625,bb7cde0f585498f675b44c936d6db59207a8a065f1c839ed176cd5854079e479
server/app/assistance-candidature/page.js,1764026705288,c4b01b81449cd03b8a733e00d7977cb6866536d97738436bc9e3993af4b668d1
server/app/app/tracker.rsc,1764026733929,39c199c3ee9cd454a35278d7c1f09c111b7f4407d81b01bdb0d26bfd9b22a84a
server/app/app/tracker.html,1764026733929,52e436ececac03f3b47c8a470c8d72905eaddd4d83a300bec3b3b7196dfece14
server/app/app/settings.rsc,1764026733675,144434b7221c5c2c7213ab483f13a87310465f53a4c724acdd1deca64f84179e
server/app/app/settings.html,1764026733676,bd000bf4703766b0872915a134cea49e197b7e70f8857b11b8f9c43014883f3c
server/app/app/settings.meta,1764026733677,61e24ac4645b6bfc1e4edde2a706de0cef571be36472d53bd09fda1d3cd766f2
server/app/app/pitch.meta,1764026733671,b96294f210dc68d6ed5f7d7fd558aa6f8787909611ddea3b1529f5d65c3d8de1
server/app/app/pitch.rsc,1764026733667,30160839b0a11e25a396a9c21be74191942befae16617684362db089f8bb9b7b
server/app/app/tracker.meta,1764026733930,2bf5058e644cfa342725213c7bef725d7b39c603242e7c99aba6f52f2bc55efc
server/app/app/pitch.html,1764026733668,f34dc2a9a7890a8756dc387cdcc400fac197c755ca613e7dc317ceef11946f8d
server/app/app/page_client-reference-manifest.js,1764026716492,1478c5671b574133bf876646be0f37e193f46c2b909fa0608410c90bb15e5573
server/app/app/page.js.nft.json,1764026743625,dcf52dadbcbb7b55bad9cb8051b63e4f0c20cbeff8c824d8820b078d94034704
server/app/app/lm.rsc,1764026733734,922564088718544373245fc64366051cf06b48d25f563f7fab8b60c583804402
server/app/app/lm.html,1764026733738,703720e85c6544a8438840f384f215da49842c1161c08a288dfc028bc1d16654
server/app/app/lm.meta,1764026733738,04a1afc9b5c9d3c66420d60fe724a4eb7846889efde9ec68eb2d28fa4191cc51
server/app/app/interview.rsc,1764026733556,e87c2d76458a38059baa71e503caa00f9b9d10b945be5f4b18d1c2af7a6c6af1
server/app/app/interview.meta,1764026733560,316676f311368fc2a2b64e6be3ef9a1f33d111fa54869f250d3fcfe6515fa983
server/app/app/history.rsc,1764026734132,1f04abaf4db2a5cf34dcf30e5ceb0b61378ed2684baad1429837c12dbe7aa338
server/app/app/history.html,1764026734133,c70e6519c39281428d61e3f950ed38c3ffc48131d2ce6b1357a0feacd89390f3
server/app/app/interview.html,1764026733559,193c4e41647330cdc58d410fbf4247571147c0fcd27b38c15f8601b2e5d4bb8d
server/app/app/history.meta,1764026734134,ccfd2db673d40cdeaf7ef0d7aad5c0140d1af7f2107aff2d9858775ac2a52c6c
server/app/app/cv.meta,1764026733543,3bc75ba2cf927dd094e9fa7a7ebd18fdfc2df8a83e1082be80613c591c294565
server/app/app/cv.rsc,1764026733541,b0ea1f052e4d6e113f68e0ed0abc865c064f1464a9258d42da78aff460e72874
server/app/app/cv.html,1764026733542,9ccde8b13ff0feb3aaf78c333c81ef790fb49422c77f9e8c9e24314150e622a0
server/app/app/credits.meta,1764026733391,0ba7583a8c447a60bbd5ac60a625ebe737ef41e8825560751188929d0c6e4085
server/app/app/credits.rsc,1764026733389,610d4ed1679ca8b7ba24c984f8f432c775479a3474cc02f01075888ec8c421d3
server/app/app/credits.html,1764026733390,2bdef619a6b0247140759d6c8d378164e0435977f6ac67d9b244dfc2a9d27d12
server/app/app/apply.rsc,1764026734179,f1cbab3b0699564ada0bf2e7c8c86f679d06db904ce35a25a533064fa15e9845
server/app/app/apply.meta,1764026734181,7733dc31718f9147899aeb7818e83a5bd27b05e1dfa3dbcaaaab829f920e187d
server/app/app/apply.html,1764026734180,d9b7d3dd31f64871027a766cdb774d6eb9dcac8065d59871e885f44bd06f7cdb
server/app/app/tracker/page_client-reference-manifest.js,1764026716492,7dc70b31a812727224db784c3ff186987998bde6813dc5c3cd712c42493d310c
server/app/app/tracker/page.js.nft.json,1764026743627,3ea3e05e656da738b8ceac6244f7cb7ccc89f908351e572d52acbefbea231341
server/app/app/tracker/page.js,1764026705291,0bdfadb6960f3c49a85b58eb4e401ede157447f23e4dac787f1f7d8c58efd4b5
server/app/app/settings/page_client-reference-manifest.js,1764026716494,99394414ac94dc0d3468e9959d8a8069c83c818dadbfd5b71b695eafc22be045
server/app/app/settings/page.js.nft.json,1764026743625,4d505ac5f1de0adeeaf4d41bbb52795670e5cb6751a67d106fbeb72adcc412d4
server/app/app/pitch/page_client-reference-manifest.js,1764026716491,cbb7b827a1962ca7753a901ac058c83d8d8761f50c978bc34b810aa00a989ec8
server/app/app/settings/page.js,1764026705292,8bf4afa0a640fc674223306db7b1afa61d32e5d333a1cb8c1fc772a90f60203f
server/app/app/pitch/page.js.nft.json,1764026743625,4d505ac5f1de0adeeaf4d41bbb52795670e5cb6751a67d106fbeb72adcc412d4
server/app/app/pitch/page.js,1764026705292,b5788dd6ca77fde290f62233a6b0c9dc63e63e2f6346a9cb8fe5f4be36463e63
server/app/app/lm/page_client-reference-manifest.js,1764026716494,01d6f42ca5e38af024902d6b46c72064659a7419fd8f784eeb527b8e3be1c1a9
server/app/app/lm/page.js.nft.json,1764026743625,3ea3e05e656da738b8ceac6244f7cb7ccc89f908351e572d52acbefbea231341
server/app/app/lm/page.js,1764026705292,dc68758656ded45c5c838c5973f755ddc0d39bbc052cb7559febf842e8c86352
server/app/app/interview/page_client-reference-manifest.js,1764026716494,2aa911daae2fa6c2cb63a897720e02e24d04481411314742231389076ef4100f
server/app/app/interview/page.js,1764026705292,bc6264f28f5fc843559065f5db61da590d2d28596d3fb85347844d752223af80
server/app/app/interview/page.js.nft.json,1764026743630,4d505ac5f1de0adeeaf4d41bbb52795670e5cb6751a67d106fbeb72adcc412d4
server/app/app/history/page_client-reference-manifest.js,1764026716494,6683f41479fae4f70fc6094786f73c52c3275f7620164339958944af59ddc88a
server/app/app/history/page.js,1764026705293,6d8cbc3d3314683dd1059fc371f6b8823c1e99dccbf148dcf6a5ca40fa2bbf75
server/app/app/history/page.js.nft.json,1764026743627,4d505ac5f1de0adeeaf4d41bbb52795670e5cb6751a67d106fbeb72adcc412d4
server/app/app/cv/page_client-reference-manifest.js,1764026716494,e4852e761a7aa0fb29845adbfbc671741b0d54bafea4345740a71e76d279474f
server/app/app/cv/page.js,1764026705292,529d9f56c4746a0e546329cb6d2af8d3a7bdd1448dc8f4a7093c82ebb806101e
server/app/app/cv/page.js.nft.json,1764026743627,4d505ac5f1de0adeeaf4d41bbb52795670e5cb6751a67d106fbeb72adcc412d4
server/app/app/credits/page_client-reference-manifest.js,1764026716491,a8a13feeed10060e54772e9e9a98873da43b9fee1e16d4853bd222a47f542313
server/app/app/credits/page.js,1764026705292,d8e4004b336bc4a8023bd57de455140dbd05fdc25fa9e794faf47d5f57a4771f
server/app/app/credits/page.js.nft.json,1764026743625,4d505ac5f1de0adeeaf4d41bbb52795670e5cb6751a67d106fbeb72adcc412d4
server/app/app/apply/page.js.nft.json,1764026743632,4d505ac5f1de0adeeaf4d41bbb52795670e5cb6751a67d106fbeb72adcc412d4
server/app/api/polar/webhook/route.js.nft.json,1764026743625,796be69d4da4af17133295c67ec12e7c14bb8d1846829ef52135dcc1244ecb6e
server/app/api/polar/webhook/route.js,1764026705290,eed78a62a284f29f754001abdf2ea1b5c76dc6bafc4b705747e89fc73c21b1f7
server/app/app/apply/page_client-reference-manifest.js,1764026716494,d1495ce120debe8d48ae02504dc4737ca80382495fa094a985a9e9c62d8808cd
server/app/api/linkedin/token/route.js.nft.json,1764026743625,796be69d4da4af17133295c67ec12e7c14bb8d1846829ef52135dcc1244ecb6e
server/app/app/apply/page.js,1764026705293,27ff452aa7e4655fed48993499211eb55935426d0c4944b01b40c2f96418aa20
server/app/api/linkedin/exchange/route.js,1764026705289,412b09c643df42cb268df80aaa2f7db76ff94910a5d23caf087bc1cd3ad3f59e
server/app/api/linkedin/token/route.js,1764026705288,99340dca17580ce19363ed568dc0be2b9a4f1dc9e1a5d802f69d4d8aec472581
server/app/api/linkedin/exchange/route.js.nft.json,1764026743625,796be69d4da4af17133295c67ec12e7c14bb8d1846829ef52135dcc1244ecb6e
server/app/admin/page_client-reference-manifest.js,1764026716491,206a1603a7be6b0d4d2bbbf94865dc5078bd0ca815be5c3e6cec1228c4150037
server/app/admin/page.js.nft.json,1764026743625,6d0f9f3a635e0052395e591d0fbca8a18ce5429ee90d8191f79869b286c5d174
server/app/admin/login.rsc,1764026733266,a1bbb5ab018ab12c977c5164b2147d2dbb3b600d551849d8fa475cc494426415
server/app/admin/login.meta,1764026733268,e5221f8e14d92870d3b29f6391ce660c8ee7d86bfd9d5bd874d0c608a628f946
server/app/admin/page.js,1764026705286,03bb00ca7abcc3197eb670b8486599c3f66d1800bc5e7195467cbbfbe27c6ba8
server/app/admin/login/page.js,1764026705287,131dcf4415189b38bb5f00ccc3d730920f8962b012d1d8f1996ec1e1f8032fda
server/app/admin/login/page_client-reference-manifest.js,1764026716491,9f056511577a3b0d63cc1b95f47fa60a76f164d5ae6aa3a5bdce99a33dfab75b
server/app/admin/login/page.js.nft.json,1764026743625,5ba162c85b003181ae736d2e1d05076f88aaf5cbe721466503d5c8640b140c48
server/app/_not-found/page.js,1764026705286,5b5f5335a4fc20ac15e06452ec3cb31a7a7ddc2858bd3b2efd3e5ebb180ad48b
server/app/_not-found/page.js.nft.json,1764026743625,c0c74ad18a7a75c1ca768f1e20ff8ec89e2456a16a4c8a18732f99f2cae9733a
server/app/_not-found/page_client-reference-manifest.js,1764026716490,d4f29cd13c3c59844cfb92c82d6bd6dcef46cb05170f2dac570924fefe5f313d
server/app/admin/login.html,1764026733267,4886c912d168d1a7907f7405c625bb07b7f31fbebff904e1bd07217502e1865f
cache/webpack/server-production/2.pack,1764026706592,3be9ce6cecf649c02c6e3bb2b2f9f1f9f8e1fe2fef377d731f676f7ac833b274
cache/webpack/server-development/6.pack.gz,1764024287161,af5813aca905aa5a7a97b1e5b7675dc1bc28e341312bd4a612cdb818b2aeb31e
server/app/app/page.js,1764026705291,e61535bddd23ff85f3fc9c7b1510de0b11213d229b6f3f1ca21e0168ac85d787
cache/webpack/server-development/15.pack.gz,1764024478922,6fbe853fac4248b73a11c90a43eba6edf59782530d783b9b50e564644cc6707f
cache/webpack/server-development/11.pack.gz,1764024287152,f875f25d7e9093fb1bb816db2d754d685d094346225cd1435787fc6902f14853
cache/webpack/edge-server-production/index.pack,1764024896487,f930deff61cd0f8e15d35a5996abae25ec091975ed6689e2c5028eed3c27209b
cache/webpack/edge-server-production/0.pack,1764024896487,59c753cc45ee8a4ca8e89f9074c0a493819b5a37358aa131156273515da76376
cache/webpack/client-production/5.pack,1764026717087,ba616cd5a26fbda70e6ff6b8f14e3a3a1cb8635b87032c101a988d4ef179ae3e
cache/webpack/client-production/4.pack,1764025809169,861564f47b4fdb92bff604be45c3bea1c58dedf0432dbe6aaf4381238de5e484
cache/webpack/client-production/1.pack,1764025809180,50b578df7a32ddf4a70c34244efd930eaf761adc713daf3767e17e95803a11e6
cache/webpack/client-production/3.pack,1764026717058,82fe9b530572ab47659b5ec28f4686614d8c68bc03a131ffbc4f66a0936d5791
cache/webpack/client-development-fallback/1.pack.gz,1763726991041,f61803af34be4773ca38272a9a924a1832e7e70eb24147e6927f887e02893095
cache/webpack/client-development/9.pack.gz,1764026444340,dd8810dda553ee803e79954b8ae9c5607043a113d89694c64706949615648a89
cache/webpack/server-development/16.pack.gz,1764024478931,415172b8deca54ed5cff8de0255b48d7ad101fb669bcacb27885294a1f0b0e32
cache/webpack/client-production/2.pack,1764025809168,5f956b09fd3adc12a5a125f8657055a1de340df6b44092b01e04e046601d0ec0
cache/webpack/client-development/21.pack.gz,1763988536526,1be651da5078a64070533b34658b5803c831a94f26a9ac326964ff164d23976b
cache/webpack/client-development/22.pack.gz,1763987316980,2ecfbaf7023039a0da19ae122ba501122d185e196efa7d0c9ecaa7bfc82968a1
cache/webpack/client-development/24.pack.gz,1763987528318,c57f090c3bc52cb27b948397439f3b3a7bf0b1f5fb9e542dca27c58f16ef81e1
cache/webpack/client-development-fallback/index.pack.gz,1763921497081,a01df9400632244658fa28a8106a1ff323ed5a9a45ae22939fcf99659e193e04
cache/webpack/client-development-fallback/index.pack.gz.old,1763873529452,d766420aee69fc87896c35c03c6be1a0237bd250e9c6ae951c957d590e8b39c5
cache/webpack/server-development/0.pack.gz,1764026442370,947f307d0df9d1ae306ad9748558cfe9b56ac4f658da5c9dd94cd75aa7cf68fe
cache/webpack/server-development/7.pack.gz,1764024478941,b0c569ad7f0b726945445af7def37bde26e6ddb6b113879c63a88a1bff0e37ba
cache/webpack/client-development/17.pack.gz,1763986942086,f84688711ef56374c6c18a20a6fa2d6097471b63927a3490bd9c26a22e52be27
cache/webpack/client-development/11.pack.gz,1764024858312,d3f516b8392a8a6308a85dd9d03bde944f0fc5082b9f0c3f60665abb703e1a7e
cache/webpack/server-development/4.pack.gz,1764026444268,94dfc57db1f0a25e4edda508660f2bb4004099963e0f514443c08fde2dfe5153
cache/webpack/client-development/16.pack.gz,1764021355468,f769bfe625095718462c540a33d16a33e6602f16fc66e4e5e94c6381928e4a65
cache/webpack/server-development/3.pack.gz,1764026444386,74023dfe4317e765d61dd6a9807f1a04ad62e8da248ab69128d2329e5b785e54
cache/webpack/server-development/5.pack.gz,1763989632258,1ec658b7b8d89f228d50afb2f679d425a78fe12cb66f22a9cf45842f5d672638
cache/webpack/server-development/index.pack.gz,1764026444350,03f2b92eec824712f05d4ef5397a98c9e95e39538ad86c90fcf04b4417a6e769
cache/webpack/server-development/index.pack.gz.old,1764024859308,9bd96307be040e788a47d131f398d4a53e30371f03440151489f0dd1dbd09b38
cache/webpack/server-development/1.pack.gz,1764023592035,59630e27ca9506cf51d0b98f9dddc6112e7ad46bfe06773d76bbf3120ff1cf23
cache/webpack/client-development/0.pack.gz,1764026444335,67333172fd61e9d5387c1189a4ca6d76838c0e6519de4341cdee49f07e605fba
server/chunks/254.js,1764026705294,df597731c4b651bc4792c8298bd15cd2384c0225e24ef1b49526d91d3efb8a0a
cache/webpack/server-development/2.pack.gz,1764023829411,d21f7bf5b0c8d4e1f65f8278814cb3b730d6f68bbe4fd36fadaa546e0f64918d
cache/webpack/server-development/12.pack.gz,1764024478936,28f0ee449337ebf528c0a44fe10537395258b7735279cb86935a1315749d7ebf
cache/webpack/client-development/14.pack.gz,1764026444365,ee6e6204e9b89ade016ab1a82b6c6d7e73ea21ea9c698487ff1985ec0cfec373
cache/webpack/client-production/7.pack,1764026717064,c243fbe1ad78cc2cbb8891c69e93b5d8d5de25afa7bdfab674a3099d95bf513b
cache/webpack/server-development/13.pack.gz,1763988902299,71c14dc314fe4d95d8477f72260e428fbd47d442d217ff342dd0ab839c696c04
cache/webpack/client-development/index.pack.gz.old,1764025787240,73dbc14890d1674cb365356ae99df5c3dacbc04b58f945aef1ade0694d6c09c5
cache/webpack/client-development/index.pack.gz,1764026444390,d3c9b99283a328761c60faefb956265c5b8d2a573d3e256872f25c402ca4f4a4
cache/webpack/server-development/17.pack.gz,1764026442362,d2ad7444e57888e6b7afa447265c86e17488e6e2bdb9cfe737588f57f4d39a14
cache/webpack/client-development/15.pack.gz,1764024414530,13373de1947ff8b169256b3cabefda95b88bb3a815281c2306ec9e1addc3c01b
cache/webpack/server-development/10.pack.gz,1764026442369,61880f9607c3e89f652b4bd92a0127d29ff6601f5e11f64824f185bbb8d7f97f
cache/webpack/client-development/13.pack.gz,1763968188144,639e5a9ab4ed71fcba7416618b84710e2537303485689576bb143a809567b566
cache/webpack/server-production/1.pack,1764026706591,4af1d06e9e5435925d39a4631d84d9537ad600da6690e84cc19509045a5fe4eb
cache/webpack/client-development/12.pack.gz,1763951604099,76bd1da3fac92263b39565f6165a4a25fa27b1039fdd4f9897f38ab27a07b8a1
cache/webpack/server-production/index.pack.old,1764025799422,d66f3f0f5f96a5952fc9e370e0c42c3973ca739d7350f50ca4b944cab92674d6
cache/webpack/server-production/index.pack,1764026706594,b1654556d94073ee618e490103f6570666a2e3a015aa9aeadc31650dc0b365ae
cache/webpack/client-production/index.pack.old,1764026016461,de941ba7ef440c1f8173f7c48d341bdbf87c675c853c37331da6bb7a2baaf23b
cache/webpack/client-production/index.pack,1764026717091,f6700140c332fed5a67176912c463afd0f2859638736490c0d7070799ab2e53c
cache/webpack/server-development/9.pack.gz,1763951604183,1004351b0acb99281e1c7415dd77c5157ea07d77ea8c1651b28de8b2f8d2dbd0
cache/webpack/server-development/8.pack.gz,1764024111083,88112fd577fe747768bde149380e95477c68963162452faa3f584043af1dbdde
cache/webpack/client-development/6.pack.gz,1764026444697,d7e7471f7c6aa20e8a12a431c521199ae55fdeb81eda2cf50dbe8b61f0ed1c3c
cache/webpack/client-development/18.pack.gz,1763987528813,22caf0af068a091156465524c89c17c5f3c815cea362405a9ab8c1f4e82ccba1
cache/webpack/client-development/7.pack.gz,1763983814599,98e647b9a55f43f38005c38f3ee5a5487a98ba64dbc9638eb2fca57530c61506
cache/webpack/client-development/1.pack.gz,1763990016627,20c3229ba3dd2a052bc3ad8949ecc5be9bad8a9c72e0b41cdddf471d2eb24eea
cache/webpack/client-development/8.pack.gz,1763983997981,66ae1347be96206145361fa304a1fe57a826a4e5a04c56e5ac3df2ee8d89d2be
cache/webpack/client-development/5.pack.gz,1763945324748,505c70bb2acfb85da18bf8d7e24b17fce54b57aa36716f653191abacb7a15b08
cache/webpack/client-development/19.pack.gz,1763987669403,25aa2f30e282fd12a9e29dab8a86f4e9be4ff3f3b4dba37eca1166817ca1baa4
cache/webpack/client-development/4.pack.gz,1763988536836,733ff9ece11cdd38504cf809ec97e4a65d24adad77093589fd7317224020b2b5
cache/webpack/client-development/10.pack.gz,1764025787234,283a69de3a025bbe55f3f6807ef44a08299fd5cabcbc7e72033fbc9426658af4
cache/webpack/client-development/2.pack.gz,1763942931149,6b697172bbde5161c5e917cc0c4fe84214decdf303778b260285612b753480b8
cache/webpack/client-development/20.pack.gz,1763986671864,760fe4ccd7765c8166608397a1346525c1bb9154a7a061501712b1a77413291b
cache/webpack/client-production/6.pack,1764026717134,fd9dbc57ea55aca90888ddb84ac8c6f5ea9b4cc3a495c2ba2f22d2f4118c6a4d
cache/webpack/client-development/3.pack.gz,1764023831064,9d9368d90de2535715bd0edf4a48453e135abce85afccce08f9a4382fad51e3c
cache/webpack/client-development-fallback/0.pack.gz,1763921497803,c97aaf6f15fa631a6664be64d4c9cf42945fa7e05595920edd7fb24ea1a9c2fd
cache/webpack/server-production/0.pack,1764026706676,8d8e8dfd045c0535d1fe3571d15e1a82fd2d5f1b4b0d56419dabc5650df37d7a
cache/webpack/client-development/25.pack.gz,1763894293590,7538527500128b39b36e55f3e63eb1d48e5aea4bc1e91f74d510a9415eb5d54c
cache/webpack/server-development/14.pack.gz,1764024289034,45edb5b8908cc95ba77914137c1ba47da29fa0120ea9d7af464b1573e6ad8ff8
cache/webpack/client-development/23.pack.gz,1763986672120,fc4708bebdd6f16423170a4b9d7ceb88231b67e0c1bde408758d3f46b4353f4e
cache/webpack/server-production/3.pack,1764026706769,b043e64e56d8c46d1717601643778a12dba1d7586e1155a6fc5612feed533b78
cache/webpack/client-production/0.pack,1764026717221,2e4a71900671a280a59332cd93725570040238a7c09ba8c0b846e01ae8aa3a30
````

## File: app/admin/login/page.tsx
````typescript
"use client";

import { useState, FormEvent } from "react";
import Link from "next/link";
import { useRouter } from "next/navigation";
import {
  signInWithEmailAndPassword,
  GoogleAuthProvider,
  signInWithPopup,
} from "firebase/auth";
import { auth } from "@/lib/firebase";

export default function AdminLoginPage() {
  // Simples états de formulaire et de soumission
  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [submitting, setSubmitting] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const router = useRouter();

  const mapFirebaseError = (code?: string) => {
    switch (code) {
      case "auth/invalid-email":
        return "Adresse email invalide.";
      case "auth/user-not-found":
      case "auth/wrong-password":
        return "Email ou mot de passe incorrect.";
      case "auth/user-disabled":
        return "Ce compte a été désactivé. Contacte l’administrateur.";
      case "auth/popup-closed-by-user":
        return "Connexion annulée.";
      default:
        return "Impossible de te connecter. Réessaie dans un instant.";
    }
  };

  const handleSubmit = async (e: FormEvent) => {
    e.preventDefault();
    setError(null);
    setSubmitting(true);

    try {
      const cred = await signInWithEmailAndPassword(auth, email, password);
      console.log("Admin login success (email/password):", cred.user.uid);

      // Redirection vers le dashboard admin (à adapter si besoin)
      router.push("/admin/dashboard");
    } catch (err: any) {
      console.error(err);
      const msg = mapFirebaseError(err?.code);
      setError(msg);
    } finally {
      setSubmitting(false);
    }
  };

  const handleGoogleLogin = async () => {
    setError(null);
    setSubmitting(true);

    try {
      const provider = new GoogleAuthProvider();
      provider.setCustomParameters({
        prompt: "select_account",
      });

      const result = await signInWithPopup(auth, provider);
      console.log("Admin login success (Google):", result.user.uid);

      // Redirection vers le dashboard admin (à adapter si besoin)
      router.push("/admin/dashboard");
    } catch (err: any) {
      console.error(err);
      const msg = mapFirebaseError(err?.code);
      setError(msg);
    } finally {
      setSubmitting(false);
    }
  };

  return (
    <div className="min-h-screen flex flex-col bg-slate-950 text-slate-100">
      {/* Navbar (Minimal Admin Header) */}
      <header className="border-b border-slate-800/80 bg-slate-950/80 backdrop-blur">
        <div className="max-w-5xl mx-auto px-4 sm:px-6 py-3 flex items-center justify-between gap-3">
          <div className="flex items-center gap-2">
            <div className="w-8 h-8 rounded-xl bg-gradient-to-br from-red-500 to-red-400 flex items-center justify-center text-[10px] font-semibold text-slate-950 shadow-lg shadow-red-500/40">
              AD
            </div>
            <div className="flex flex-col">
              <span className="text-[10px] uppercase tracking-[0.18em] text-slate-400">
                Accès réservé
              </span>
              <span className="text-xs font-medium text-slate-100">
                Administration
              </span>
            </div>
          </div>
          <Link
            href="/login" // Lien de retour vers la connexion utilisateur classique
            className="px-2 py-1 rounded-full border border-slate-700/80 hover:border-red-500/80 text-slate-300 hover:text-red-300 transition-colors text-[11px]"
          >
            ← Retour Client
          </Link>
        </div>
      </header>

      {/* CONTENU PRINCIPAL - Centré */}
      <main className="flex-1 flex items-center justify-center px-4 py-6">
        <div className="glass max-w-sm w-full p-6 sm:p-7 rounded-2xl border border-slate-800 bg-slate-950/80 shadow-2xl shadow-red-900/40">
          <div className="mb-5">
            <p className="inline-flex items-center gap-2 rounded-full bg-slate-900/80 border border-slate-700 px-3 py-1 mb-2">
              <span className="text-xs text-red-400">🚨</span>
              <span className="text-[11px] uppercase tracking-[0.18em] text-slate-300">
                Accès Admin
              </span>
            </p>
            <h1 className="text-lg sm:text-xl font-semibold text-slate-50">
              Connexion administrateur
            </h1>
            <p className="text-xs text-slate-400 mt-1">
              Veuillez utiliser vos identifiants de sécurité.
            </p>
          </div>

          {error && (
            <div className="mb-4 rounded-lg border border-red-500/70 bg-red-500/10 px-3 py-2 text-[11px] text-red-100">
              {error}
            </div>
          )}

          {/* FORMULAIRE */}
          <form onSubmit={handleSubmit} className="space-y-4 text-sm">
            <div>
              <label className="block mb-1 text-xs text-slate-300">
                Email
              </label>
              <input
                type="email"
                required
                className="w-full rounded-lg bg-slate-900/80 border border-slate-700 px-3 py-2 text-xs text-slate-100 placeholder:text-slate-500 outline-none focus:ring-1 focus:ring-red-500 focus:border-red-500"
                placeholder="admin@example.com"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                disabled={submitting}
              />
            </div>

            <div>
              <label className="block mb-1 text-xs text-slate-300">
                Mot de passe
              </label>
              <input
                type="password"
                required
                className="w-full rounded-lg bg-slate-900/80 border border-slate-700 px-3 py-2 text-xs text-slate-100 placeholder:text-slate-500 outline-none focus:ring-1 focus:ring-red-500 focus:border-red-500"
                placeholder="••••••••"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                disabled={submitting}
              />
              {/* Le lien "Mot de passe oublié ?" est intentionnellement omis ici */}
            </div>

            <button
              type="submit"
              disabled={submitting}
              className="w-full inline-flex items-center justify-center rounded-lg bg-red-600 hover:bg-red-700 disabled:opacity-60 disabled:cursor-not-allowed text-xs font-medium text-white px-3 py-2 transition-colors mt-2"
            >
              {submitting ? "Connexion en cours..." : "Se connecter"}
            </button>
          </form>

          {/* Séparateur */}
          <div className="flex items-center gap-3 my-4">
            <div className="h-px flex-1 bg-slate-800" />
            <span className="text-[10px] text-slate-500 uppercase tracking-[0.18em]">
              ou
            </span>
            <div className="h-px flex-1 bg-slate-800" />
          </div>

          {/* BOUTON GOOGLE */}
          <button
            type="button"
            onClick={handleGoogleLogin}
            disabled={submitting}
            className="w-full inline-flex items-center justify-center gap-2 rounded-lg bg-slate-900/80 hover:bg-slate-900 disabled:opacity-60 disabled:cursor-not-allowed border border-slate-700 px-3 py-2 text-xs font-medium text-slate-100 transition-colors"
          >
            {/* Icône Google minimaliste (SVG) */}
            <span className="w-4 h-4 rounded-sm bg-white flex items-center justify-center">
              <span className="text-[11px] font-bold text-slate-900">G</span>
            </span>
            <span>
              {submitting
                ? "Connexion en cours..."
                : "Se connecter avec Google"}
            </span>
          </button>
        </div>
      </main>
    </div>
  );
}
````

## File: app/admin/logs/page.tsx
````typescript
"use client";

import { useEffect, useState } from "react";
import { motion } from "framer-motion";
import { db } from "@/lib/firebase";
import {
  collection,
  getDocs,
  limit,
  orderBy,
  query,
} from "firebase/firestore";
import { useAdminGuard } from "@/hooks/useAdminGuard";

interface UsageLogRow {
  id: string;
  userId: string;
  email?: string | null;
  type: string;
  createdAt?: Date | null;
  meta?: any;
}

function formatDateTime(date?: Date | null): string {
  if (!date) return "—";
  return date.toLocaleString("fr-FR", {
    dateStyle: "short",
    timeStyle: "short",
  });
}

export default function AdminLogsPage() {
  const { loading, isAdmin } = useAdminGuard();
  const [logs, setLogs] = useState<UsageLogRow[]>([]);
  const [loadingLogs, setLoadingLogs] = useState(true);

  useEffect(() => {
    if (!isAdmin || loading) return;

    const fetchLogs = async () => {
      try {
        const q = query(
          collection(db, "usageLogs"),
          orderBy("createdAt", "desc"),
          limit(200)
        );
        const snap = await getDocs(q);
        const rows: UsageLogRow[] = snap.docs.map((d) => {
          const data = d.data() as any;
          const createdAt =
            data.createdAt?.toDate?.() &&
            typeof data.createdAt.toDate === "function"
              ? data.createdAt.toDate()
              : null;

          return {
            id: d.id,
            userId: data.userId ?? "—",
            email: data.email ?? null,
            type: data.type ?? "—",
            createdAt,
            meta: data.meta ?? {},
          };
        });
        setLogs(rows);
      } catch (err) {
        console.error("Erreur chargement logs:", err);
      } finally {
        setLoadingLogs(false);
      }
    };

    fetchLogs();
  }, [loading, isAdmin]);

  if (loading) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <p className="text-xs text-[var(--muted)]">
          Chargement de l&apos;admin…
        </p>
      </div>
    );
  }

  if (!isAdmin) return null;

  return (
    <div className="min-h-screen px-4 sm:px-8 py-6 bg-[var(--bg)] text-[var(--ink)]">
      <div className="max-w-6xl mx-auto flex flex-col gap-4">
        <motion.div
          initial={{ opacity: 0, y: 10 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.25 }}
        >
          <h1 className="text-xl sm:text-2xl font-semibold">
            Logs d&apos;utilisation
          </h1>
          <p className="text-xs sm:text-sm text-[var(--muted)] mt-1 max-w-xl">
            Historique des actions des utilisateurs (génération de CV, LM,
            etc.).
          </p>
        </motion.div>

        <motion.div
          initial={{ opacity: 0, y: 10 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.25, delay: 0.05 }}
          className="glass rounded-2xl p-4 overflow-x-auto"
        >
          {loadingLogs ? (
            <p className="text-[12px] text-[var(--muted)]">
              Chargement des logs…
            </p>
          ) : logs.length === 0 ? (
            <p className="text-[12px] text-[var(--muted)]">
              Aucun log pour le moment.
            </p>
          ) : (
            <table className="w-full text-[11px] sm:text-xs">
              <thead className="text-[10px] uppercase tracking-[0.18em] text-[var(--muted)]">
                <tr className="text-left border-b border-[var(--border)]">
                  <th className="py-2 pr-2">Date</th>
                  <th className="py-2 pr-2">User</th>
                  <th className="py-2 pr-2">Type</th>
                  <th className="py-2 pr-2">Meta</th>
                </tr>
              </thead>
              <tbody>
                {logs.map((log) => (
                  <tr
                    key={log.id}
                    className="border-b border-[var(--border)]/60 last:border-none align-top"
                  >
                    <td className="py-2 pr-2">
                      {formatDateTime(log.createdAt)}
                    </td>
                    <td className="py-2 pr-2">
                      <div className="flex flex-col">
                        <span className="font-medium text-[11px]">
                          {log.email || "—"}
                        </span>
                        <span className="text-[10px] text-[var(--muted)]">
                          UID: {log.userId?.slice(0, 8) || "—"}…
                        </span>
                      </div>
                    </td>
                    <td className="py-2 pr-2">
                      <span className="inline-flex px-2 py-[2px] rounded-full border border-[var(--border)] text-[10px]">
                        {log.type}
                      </span>
                    </td>
                    <td className="py-2 pr-2 max-w-xs">
                      <pre className="text-[10px] whitespace-pre-wrap break-words text-[var(--muted)]">
                        {JSON.stringify(log.meta ?? {}, null, 2)}
                      </pre>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          )}
        </motion.div>
      </div>
    </div>
  );
}
````

## File: app/admin/page.tsx
````typescript
// app/admin/page.tsx
"use client";

import { useEffect, useState, useRef } from "react";
import { motion } from "framer-motion";
import { db } from "@/lib/firebase";
import {
  collection,
  onSnapshot,
  doc,
  updateDoc,
  query,
  orderBy,
  limit,
  deleteDoc,
} from "firebase/firestore";
import Chart from "chart.js/auto";
import { useAdminGuard } from "@/hooks/useAdminGuard";
import { useAuth } from "@/context/AuthContext";

type AdminUser = {
  id: string;
  email: string;
  displayName?: string | null;
  createdAt?: number | null;
  lastLoginAt?: number | null;
  lastSeenAt?: number | null;
  lastSeenPage?: string | null;
  credits?: number;
  blocked?: boolean;
  emailVerified?: boolean;
  provider?: string;

  role?: string | null;

  lastIp?: string | null;
  country?: string | null;
  city?: string | null;

  lastAction?: string | null;
  lastActionAt?: number | null;
  lastDeviceType?: string | null; // "iphone" | "ipad" | "mac" | "mobile" | "tablet" | "desktop" | ...
  lastOs?: string | null;
  lastBrowser?: string | null;

  totalIaCalls?: number | null;
  totalCvGenerated?: number | null;
  totalLmGenerated?: number | null;
  totalDocumentsGenerated?: number | null;

  authFailedCount?: number | null;
};

type UsageLog = {
  id: string;
  userId: string;
  email?: string | null;
  action: string;
  tool?: string | null;
  docType?: string | null;
  eventType?: string | null;
  createdAt?: number | null;

  ip?: string | null;
  country?: string | null;
  city?: string | null;
  path?: string | null;
  creditsDelta?: number | null;

  deviceType?: string | null;
  os?: string | null;
  browser?: string | null;
};

function formatDate(ts?: number | null) {
  if (!ts) return "—";
  const d = new Date(ts);
  return new Intl.DateTimeFormat("fr-FR", {
    day: "2-digit",
    month: "short",
    year: "numeric",
    hour: "2-digit",
    minute: "2-digit",
  }).format(d);
}

function formatRelative(ts?: number | null): string {
  if (!ts) return "Jamais vu·e";
  const now = Date.now();
  const diffMs = now - ts;
  if (diffMs < 0) return "Dans le futur 🤔";

  const diffSec = Math.floor(diffMs / 1000);
  if (diffSec < 60) return `Il y a ${diffSec}s`;

  const diffMin = Math.floor(diffSec / 60);
  if (diffMin < 60) return `Il y a ${diffMin} min`;

  const diffH = Math.floor(diffMin / 60);
  if (diffH < 48) return `Il y a ${diffH} h`;

  const diffJ = Math.floor(diffH / 24);
  return `Il y a ${diffJ} j`;
}

function getPresence(lastSeenAt?: number | null) {
  if (!lastSeenAt) {
    return {
      label: "Jamais vu·e",
      dotClass: "bg-slate-500",
      badgeClass:
        "bg-slate-500/10 text-slate-200 border border-slate-500/40",
    };
  }

  const now = Date.now();
  const diff = now - lastSeenAt;

  if (diff < 2 * 60 * 1000) {
    return {
      label: "En ligne",
      dotClass: "bg-emerald-400",
      badgeClass:
        "bg-emerald-500/10 text-emerald-200 border border-emerald-500/50",
    };
  }

  if (diff < 60 * 60 * 1000) {
    return {
      label: formatRelative(lastSeenAt),
      dotClass: "bg-amber-400",
      badgeClass:
        "bg-amber-500/10 text-amber-200 border border-amber-500/40",
    };
  }

  return {
    label: formatRelative(lastSeenAt),
    dotClass: "bg-slate-400",
    badgeClass:
      "bg-slate-500/10 text-slate-200 border border-slate-500/40",
  };
}

function getCountryFlag(country?: string | null): string {
  if (!country) return "🏳️";
  const c = country.toLowerCase();

  if (c.includes("france")) return "🇫🇷";
  if (c.includes("belgique") || c.includes("belgium")) return "🇧🇪";
  if (c.includes("suisse") || c.includes("switzerland")) return "🇨🇭";
  if (c.includes("canada")) return "🇨🇦";
  if (c.includes("maroc")) return "🇲🇦";
  if (c.includes("tunisie") || c.includes("tunisia")) return "🇹🇳";
  if (c.includes("algérie") || c.includes("algerie")) return "🇩🇿";
  if (c.includes("luxembourg")) return "🇱🇺";

  if (
    c.includes("united states") ||
    c.includes("usa") ||
    c.includes("états-unis") ||
    c.includes("etats-unis")
  )
    return "🇺🇸";
  if (c.includes("spain") || c.includes("espagne")) return "🇪🇸";
  if (c.includes("germany") || c.includes("allemagne")) return "🇩🇪";
  if (c.includes("italy") || c.includes("italie")) return "🇮🇹";
  if (c.includes("portugal")) return "🇵🇹";
  if (c.includes("netherlands") || c.includes("pays-bas")) return "🇳🇱";
  if (
    c.includes("united kingdom") ||
    c.includes("uk") ||
    c.includes("royaume-uni")
  )
    return "🇬🇧";

  return "🌍";
}

// Traduction du path en section lisible
function getPageLabel(path?: string | null): string {
  if (!path) return "Inconnu";
  const [clean] = path.split("?");
  if (!clean) return "Inconnu";

  if (clean === "/" || clean === "/app") return "Accueil (app)";
  if (clean.startsWith("/lm")) return "Lettre de motivation IA";
  if (
    clean.startsWith("/applications") ||
    clean.startsWith("/tracker") ||
    clean.startsWith("/suivi")
  )
    return "Suivi de candidatures";
  if (clean.startsWith("/credits")) return "Page crédits";
  if (clean.startsWith("/login") || clean.startsWith("/signup"))
    return "Connexion / Inscription";
  if (clean.startsWith("/admin")) return "Administration";
  if (clean.startsWith("/profil") || clean.startsWith("/profile"))
    return "Profil candidat";

  return clean;
}

// Affichage lisible du device, avec différenciation iPhone / iPad / macOS
function formatDevice(
  deviceType?: string | null,
  os?: string | null
): string {
  if (!deviceType && !os) return "—";

  let label: string;

  switch (deviceType) {
    case "iphone":
      label = "📱 iPhone";
      break;
    case "ipad":
      label = "📱 iPad";
      break;
    case "mac":
      label = "💻 macOS";
      break;
    case "mobile":
      label = "📱 Mobile";
      break;
    case "tablet":
      label = "📱 Tablette";
      break;
    case "desktop":
      label = "🖥 Desktop";
      break;
    default:
      label = "❓ Appareil";
  }

  if (os) label += ` · ${os}`;

  return label;
}

export default function AdminDashboardPage() {
  const { loading, isAdmin } = useAdminGuard();
  const { logout } = useAuth();

  const [users, setUsers] = useState<AdminUser[]>([]);
  const [loadingUsers, setLoadingUsers] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [editingCredits, setEditingCredits] = useState<
    Record<string, string>
  >({});
  const [updatingIds, setUpdatingIds] = useState<Record<string, boolean>>(
    {}
  );

  const [activeTab, setActiveTab] = useState<"users" | "logs">("users");

  const [usageLogs, setUsageLogs] = useState<UsageLog[]>([]);
  const [loadingLogs, setLoadingLogs] = useState(false);

  // 🔎 nouveau : filtre sur les logs (tous / seulement auth_failed)
  const [logFilter, setLogFilter] = useState<"all" | "auth_failed">("all");

  // Chart.js pour les logs
  const logsChartRef = useRef<HTMLCanvasElement | null>(null);
  const [logsChart, setLogsChart] = useState<Chart | null>(null);

  // --- USERS SUB ---
  useEffect(() => {
    if (!isAdmin) {
      setUsers([]);
      setLoadingUsers(false);
      return;
    }

    setLoadingUsers(true);

    const unsub = onSnapshot(
      collection(db, "users"),
      (snap) => {
        const list: AdminUser[] = snap.docs.map((d) => {
          const data = d.data() as any;
          return {
            id: d.id,
            email: data.email || "—",
            displayName: data.displayName || null,
            createdAt:
              typeof data.createdAt === "number" ? data.createdAt : null,
            lastLoginAt:
              typeof data.lastLoginAt === "number"
                ? data.lastLoginAt
                : null,
            lastSeenAt:
              typeof data.lastSeenAt === "number" ? data.lastSeenAt : null,
            lastSeenPage: data.lastSeenPage || null,
            credits:
              typeof data.credits === "number"
                ? data.credits
                : data.credits ?? 0,
            blocked: !!data.blocked,
            emailVerified: !!data.emailVerified,
            provider: data.provider || "",

            role: data.role || (data.isAdmin ? "admin" : "user"),

            lastIp: data.lastSeenIp || null,
            country: data.lastSeenCountry || null,
            city: data.lastSeenCity || null,
            lastAction: data.lastAction || null,
            lastActionAt:
              typeof data.lastActionAt === "number"
                ? data.lastActionAt
                : null,
            lastDeviceType: data.lastDeviceType || null,
            lastOs: data.lastOs || null,
            lastBrowser: data.lastBrowser || null,

            totalIaCalls:
              typeof data.totalIaCalls === "number"
                ? data.totalIaCalls
                : null,
            totalCvGenerated:
              typeof data.totalCvGenerated === "number"
                ? data.totalCvGenerated
                : null,
            totalLmGenerated:
              typeof data.totalLmGenerated === "number"
                ? data.totalLmGenerated
                : null,
            totalDocumentsGenerated:
              typeof data.totalDocumentsGenerated === "number"
                ? data.totalDocumentsGenerated
                : null,
            authFailedCount:
              typeof data.authFailedCount === "number"
                ? data.authFailedCount
                : null,
          };
        });

        list.sort((a, b) => {
          const ta = a.createdAt || 0;
          const tb = b.createdAt || 0;
          return tb - ta;
        });

        setUsers(list);
        setLoadingUsers(false);
        setError(null);
      },
      (err) => {
        console.error("Erreur onSnapshot(users):", err);
        setError("Impossible de charger les utilisateurs.");
        setLoadingUsers(false);
      }
    );

    return () => {
      unsub();
    };
  }, [isAdmin]);

  // --- USAGE LOGS SUB ---
  useEffect(() => {
    if (!isAdmin || activeTab !== "logs") {
      setUsageLogs([]);
      setLoadingLogs(false);
      return;
    }

    setLoadingLogs(true);

    const qLogs = query(
      collection(db, "usageLogs"),
      orderBy("createdAt", "desc"),
      limit(200)
    );

    const unsub = onSnapshot(
      qLogs,
      (snap) => {
        const list: UsageLog[] = snap.docs.map((d) => {
          const data = d.data() as any;
          return {
            id: d.id,
            userId: data.userId,
            email: data.email ?? null,
            action: data.action || "—",
            tool: data.tool ?? null,
            docType: data.docType ?? null,
            eventType: data.eventType ?? null,
            createdAt:
              typeof data.createdAt === "number"
                ? data.createdAt
                : null,
            ip: data.ip ?? null,
            country: data.country ?? null,
            city: data.city ?? null,
            path: data.path ?? null,
            creditsDelta:
              typeof data.creditsDelta === "number"
                ? data.creditsDelta
                : null,
            deviceType: data.deviceType ?? null,
            os: data.os ?? null,
            browser: data.browser ?? null,
          };
        });

        setUsageLogs(list);
        setLoadingLogs(false);
      },
      (err) => {
        console.error("Erreur onSnapshot(usageLogs):", err);
        setLoadingLogs(false);
      }
    );

    return () => {
      unsub();
    };
  }, [isAdmin, activeTab]);

  // --- CHARTS SUR LES LOGS (LM / CV par jour) ---
  useEffect(() => {
    if (activeTab !== "logs") return;
    if (!logsChartRef.current) return;

    const ctx = logsChartRef.current.getContext("2d");
    if (!ctx) return;

    if (logsChart) {
      logsChart.destroy();
    }

    if (usageLogs.length === 0) {
      setLogsChart(null);
      return;
    }

    const byDate: Record<
      string,
      { total: number; lm: number; cv: number }
    > = {};

    usageLogs.forEach((log) => {
      if (!log.createdAt) return;
      const d = new Date(log.createdAt);
      const key = d.toISOString().slice(0, 10); // YYYY-MM-DD

      if (!byDate[key]) {
        byDate[key] = { total: 0, lm: 0, cv: 0 };
      }

      byDate[key].total += 1;

      if (log.docType === "lm") {
        byDate[key].lm += 1;
      } else if (log.docType === "cv") {
        byDate[key].cv += 1;
      }
    });

    const labels = Object.keys(byDate).sort();
    const totalData = labels.map((k) => byDate[k].total);
    const lmData = labels.map((k) => byDate[k].lm);
    const cvData = labels.map((k) => byDate[k].cv);

    const chart = new Chart(ctx, {
      type: "line",
      data: {
        labels,
        datasets: [
          {
            label: "Total appels IA",
            data: totalData,
            borderWidth: 2,
            tension: 0.3,
          },
          {
            label: "LM générées",
            data: lmData,
            borderWidth: 2,
            tension: 0.3,
          },
          {
            label: "CV générés",
            data: cvData,
            borderWidth: 2,
            tension: 0.3,
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            labels: {
              color: "#e5e7eb",
              font: { size: 11 },
            },
          },
        },
        scales: {
          x: {
            ticks: { color: "#9ca3af", font: { size: 10 } },
            grid: { color: "rgba(55,65,81,0.4)" },
          },
          y: {
            ticks: { color: "#9ca3af", font: { size: 10 } },
            grid: { color: "rgba(55,65,81,0.4)" },
          },
        },
      },
    });

    setLogsChart(chart);

    return () => {
      chart.destroy();
    };
  }, [usageLogs, activeTab]);

  // --- ACTIONS ADMIN ---

  const handleSaveCredits = async (u: AdminUser) => {
    const raw = editingCredits[u.id];
    if (raw == null) return;

    const parsed = Number(raw);
    if (Number.isNaN(parsed)) {
      alert("Merci de saisir un nombre valide.");
      return;
    }

    try {
      setUpdatingIds((prev) => ({ ...prev, [u.id]: true }));
      const ref = doc(db, "users", u.id);
      await updateDoc(ref, { credits: parsed });
    } catch (e) {
      console.error("Erreur update credits:", e);
      alert("Erreur en mettant à jour les crédits.");
    } finally {
      setUpdatingIds((prev) => ({ ...prev, [u.id]: false }));
    }
  };

  const handleToggleBlocked = async (u: AdminUser) => {
    try {
      setUpdatingIds((prev) => ({ ...prev, [u.id]: true }));
      const ref = doc(db, "users", u.id);
      await updateDoc(ref, { blocked: !u.blocked });
    } catch (e) {
      console.error("Erreur toggle blocked:", e);
      alert("Erreur en mettant à jour le statut de blocage.");
    } finally {
      setUpdatingIds((prev) => ({ ...prev, [u.id]: false }));
    }
  };

  const handleDeleteUser = async (u: AdminUser) => {
    const sure = window.confirm(
      `Supprimer l'utilisateur ${u.email} de Firestore ?\n\n(Le compte Auth ne sera pas supprimé automatiquement.)`
    );
    if (!sure) return;

    try {
      setUpdatingIds((prev) => ({ ...prev, [u.id]: true }));
      const ref = doc(db, "users", u.id);
      await deleteDoc(ref);
    } catch (e) {
      console.error("Erreur delete user:", e);
      alert("Erreur lors de la suppression de l'utilisateur.");
    } finally {
      setUpdatingIds((prev) => ({ ...prev, [u.id]: false }));
    }
  };

  const handleLogout = async () => {
    try {
      await logout();
      window.location.href = "/login";
    } catch (e) {
      console.error("Erreur logout:", e);
    }
  };

  if (loading) {
    return (
      <div className="min-h-screen flex items-center justify-center text-sm text-slate-300">
        Vérification des droits admin…
      </div>
    );
  }

  if (!isAdmin) {
    return null;
  }

  const totalCredits = users.reduce(
    (sum, u) => sum + (u.credits ?? 0),
    0
  );
  const blockedCount = users.filter((u) => u.blocked).length;
  const totalDocs = users.reduce(
    (sum, u) => sum + (u.totalDocumentsGenerated ?? 0),
    0
  );

  const lmTotal = users.reduce(
    (sum, u) => sum + (u.totalLmGenerated ?? 0),
    0
  );
  const cvTotal = users.reduce(
    (sum, u) => sum + (u.totalCvGenerated ?? 0),
    0
  );

  const suspiciousLogs = usageLogs.filter(
    (l) => l.action === "auth_failed"
  ).length;

  // 🔎 on applique le filtre pour le tableau
  const filteredLogs =
    logFilter === "auth_failed"
      ? usageLogs.filter((l) => l.action === "auth_failed")
      : usageLogs;

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-950 via-slate-900 to-slate-950 px-3 sm:px-6 py-5">
      <div className="max-w-7xl mx-auto flex flex-col gap-4">
        {/* HEADER */}
        <motion.header
          initial={{ opacity: 0, y: 10 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.25 }}
          className="flex items-center justify-between gap-3"
        >
          <div>
            <p className="inline-flex items-center gap-1.5 rounded-full border border-sky-500/30 bg-sky-500/10 px-2 py-[3px]">
              <span className="w-1.5 h-1.5 rounded-full bg-emerald-400" />
              <span className="text-[11px] uppercase tracking-[0.18em] text-sky-100/80">
                Espace admin
              </span>
            </p>
            <h1 className="mt-2 text-xl sm:text-2xl font-semibold text-white">
              Tableau de bord administrateur
            </h1>
            <p className="text-xs sm:text-sm text-slate-300/80 mt-1 max-w-xl">
              Vue globale sur les comptes, la localisation des utilisateurs,
              les documents IA générés et les appels à l&apos;assistant.
            </p>
          </div>

          <div className="flex items-center gap-2">
            <button
              type="button"
              className="hidden sm:inline-flex items-center gap-1.5 rounded-full border border-slate-700 bg-slate-900/60 px-3 py-1.5 text-[11px] text-slate-200"
            >
              <span className="w-2 h-2 rounded-full bg-emerald-400 animate-pulse" />
              <span>Admin connecté</span>
            </button>
            <button
              type="button"
              onClick={handleLogout}
              className="inline-flex items-center gap-1.5 rounded-full bg-slate-100 text-slate-900 px-3 py-1.5 text-[12px] font-medium hover:bg-white transition-colors"
            >
              <span>Se déconnecter</span>
              <span className="text-[13px]">↩</span>
            </button>
          </div>
        </motion.header>

        {/* TABS */}
        <div className="flex items-center gap-2 border-b border-slate-800/80">
          <button
            type="button"
            onClick={() => setActiveTab("users")}
            className={`relative px-3 py-2 text-[12px] sm:text-[13px] ${
              activeTab === "users"
                ? "text-white"
                : "text-slate-400 hover:text-slate-200"
            }`}
          >
            Utilisateurs
            {activeTab === "users" && (
              <span className="absolute inset-x-2 -bottom-px h-[2px] rounded-full bg-sky-400" />
            )}
          </button>
          <button
            type="button"
            onClick={() => setActiveTab("logs")}
            className={`relative px-3 py-2 text-[12px] sm:text-[13px] ${
              activeTab === "logs"
                ? "text-white"
                : "text-slate-400 hover:text-slate-200"
            }`}
          >
            Logs IA
            {activeTab === "logs" && (
              <span className="absolute inset-x-2 -bottom-px h-[2px] rounded-full bg-sky-400" />
            )}
          </button>
        </div>

        {/* ONGLET UTILISATEURS */}
        {activeTab === "users" && (
          <>
            {/* STATS RAPIDES */}
            <div className="grid gap-3 md:grid-cols-4">
              <div className="rounded-2xl border border-slate-800 bg-slate-900/70 p-4 shadow-sm shadow-sky-500/5">
                <p className="text-[11px] uppercase tracking-[0.18em] text-slate-400 mb-1">
                  Utilisateurs
                </p>
                <p className="text-2xl font-semibold text-white">
                  {loadingUsers ? "…" : users.length}
                </p>
                <p className="text-[11px] text-slate-400">
                  Nombre total de comptes dans{" "}
                  <code className="text-sky-300">users</code>.
                </p>
              </div>

              <div className="rounded-2xl border border-slate-800 bg-slate-900/70 p-4 shadow-sm shadow-sky-500/5">
                <p className="text-[11px] uppercase tracking-[0.18em] text-slate-400 mb-1">
                  Utilisateurs bloqués
                </p>
                <p className="text-2xl font-semibold text-white">
                  {loadingUsers ? "…" : blockedCount}
                </p>
                <p className="text-[11px] text-slate-400">
                  Comptes avec{" "}
                  <code className="text-sky-300">blocked = true</code>.
                </p>
              </div>

              <div className="rounded-2xl border border-slate-800 bg-slate-900/70 p-4 shadow-sm shadow-sky-500/5">
                <p className="text-[11px] uppercase tracking-[0.18em] text-slate-400 mb-1">
                  Crédits totaux
                </p>
                <p className="text-2xl font-semibold text-white">
                  {loadingUsers ? "…" : totalCredits}
                </p>
                <p className="text-[11px] text-slate-400">
                  Somme de tous les crédits utilisateurs.
                </p>
              </div>

              <div className="rounded-2xl border border-slate-800 bg-slate-900/70 p-4 shadow-sm shadow-sky-500/5">
                <p className="text-[11px] uppercase tracking-[0.18em] text-slate-400 mb-1">
                  Docs IA générés
                </p>
                <p className="text-2xl font-semibold text-white">
                  {loadingUsers ? "…" : totalDocs}
                </p>
                <p className="text-[11px] text-slate-400">
                  LM: {lmTotal} · CV: {cvTotal}
                </p>
              </div>
            </div>

            {/* TABLE UTILISATEURS */}
            <div className="rounded-2xl border border-slate-800 bg-slate-950/80 p-4 sm:p-5 shadow-inner shadow-black/40">
              <div className="flex items-center justify-between mb-3 gap-2">
                <h2 className="text-sm sm:text-base font-semibold text-white">
                  Liste des utilisateurs
                </h2>
                {loadingUsers && (
                  <span className="text-[11px] text-slate-400">
                    Chargement…
                  </span>
                )}
              </div>

              {error && (
                <div className="mb-3 rounded-lg border border-red-500/40 bg-red-500/10 px-3 py-2 text-[11px] text-red-100">
                  {error}
                </div>
              )}

              {!loadingUsers && users.length === 0 && !error && (
                <p className="text-[12px] text-slate-400">
                  Aucun utilisateur trouvé dans{" "}
                  <code className="text-sky-300">users</code>.
                  <br />
                  Vérifie que ta fonction{" "}
                  <code className="text-sky-300">upsertUserOnLogin</code> est
                  bien appelée après chaque connexion.
                </p>
              )}

              {users.length > 0 && (
                <div className="overflow-x-auto mt-2">
                  <table className="w-full text-[11px] sm:text-[12px] border-collapse">
                    <thead>
                      <tr className="text-slate-400 border-b border-slate-800">
                        <th className="text-left py-2 pr-3">Utilisateur</th>
                        <th className="text-left py-2 pr-3 hidden sm:table-cell">
                          Localisation / Appareil
                        </th>
                        <th className="text-left py-2 pr-3">Crédits</th>
                        <th className="text-left py-2 pr-3">Statut</th>
                        <th className="text-left py-2 pr-3 hidden md:table-cell">
                          Dernier login
                        </th>
                        <th className="text-left py-2 pr-3 hidden lg:table-cell">
                          Dernière activité
                        </th>
                        <th className="text-left py-2 pl-3">Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      {users.map((u) => {
                        const isUpdating = !!updatingIds[u.id];
                        const creditsValue =
                          editingCredits[u.id] ?? String(u.credits ?? 0);
                        const presence = getPresence(u.lastSeenAt);

                        const flag = getCountryFlag(u.country);
                        const pageLabel = getPageLabel(u.lastSeenPage);

                        return (
                          <tr
                            key={u.id}
                            className="border-b border-slate-800/70 hover:bg-slate-900/60"
                          >
                            {/* Utilisateur */}
                            <td className="py-2 pr-3 align-top">
                              <div className="flex flex-col gap-0.5">
                                <span className="font-medium text-[13px] text-white">
                                  {u.email}
                                </span>
                                <span className="text-[10px] text-slate-400">
                                  UID: {u.id}
                                </span>
                                <span className="text-[10px] text-slate-400">
                                  {u.displayName || "—"}{" "}
                                  <span className="ml-1">
                                    {u.provider || "password"}
                                    {u.emailVerified
                                      ? " · ✅ vérifié"
                                      : " · ⚠️ non vérifié"}
                                  </span>
                                </span>
                                {u.role && (
                                  <span className="inline-flex w-fit mt-0.5 rounded-full border border-sky-500/50 bg-sky-500/10 px-2 py-[1px] text-[10px] text-sky-200">
                                    Rôle : {u.role}
                                  </span>
                                )}
                              </div>
                            </td>

                            {/* Localisation + device + page */}
                            <td className="py-2 pr-3 align-top hidden sm:table-cell">
                              <div className="flex flex-col gap-0.5 text-slate-200">
                                <div className="flex items-center gap-1.5">
                                  <span className="text-lg">{flag}</span>
                                  <span>
                                    {u.city || u.country
                                      ? `${u.city ?? ""}${
                                          u.city && u.country ? " · " : ""
                                        }${u.country ?? ""}`
                                      : "—"}
                                  </span>
                                </div>
                                {u.lastIp && (
                                  <span className="text-[10px] text-slate-400">
                                    IP: {u.lastIp}
                                  </span>
                                )}
                                <span className="text-[10px] text-slate-400">
                                  {formatDevice(u.lastDeviceType, u.lastOs)}
                                </span>
                                <span className="text-[10px] text-slate-400">
                                  Section: {pageLabel}
                                </span>
                                {u.lastSeenPage && (
                                  <span className="text-[10px] text-slate-500 line-clamp-1">
                                    Path: {u.lastSeenPage}
                                  </span>
                                )}
                                {u.lastBrowser && (
                                  <span className="text-[10px] text-slate-500">
                                    Navigateur: {u.lastBrowser}
                                  </span>
                                )}
                              </div>
                            </td>

                            {/* Crédits */}
                            <td className="py-2 pr-3 align-top min-w-[90px]">
                              <div className="flex items-center gap-1.5">
                                <input
                                  type="number"
                                  className="w-20 rounded-md border border-slate-700 bg-slate-900 px-1.5 py-1 text-[11px] text-slate-100 outline-none focus:ring-1 focus:ring-sky-500"
                                  value={creditsValue}
                                  onChange={(e) =>
                                    setEditingCredits((prev) => ({
                                      ...prev,
                                      [u.id]: e.target.value,
                                    }))
                                  }
                                />
                                <button
                                  type="button"
                                  onClick={() => handleSaveCredits(u)}
                                  disabled={isUpdating}
                                  className="rounded-md border border-slate-700 bg-slate-900/70 px-2 py-1 text-[10px] text-slate-100 hover:border-sky-500 hover:text-sky-300 disabled:opacity-60"
                                >
                                  {isUpdating ? "…" : "OK"}
                                </button>
                              </div>
                            </td>

                            {/* Statut / IA */}
                            <td className="py-2 pr-3 align-top">
                              <div className="flex flex-col gap-1">
                                <span
                                  className={
                                    "inline-flex items-center gap-1 rounded-full px-2 py-[2px] text-[10px] " +
                                    presence.badgeClass
                                  }
                                >
                                  <span
                                    className={
                                      "w-1.5 h-1.5 rounded-full " +
                                      presence.dotClass
                                    }
                                  />
                                  <span>{presence.label}</span>
                                </span>
                                <span
                                  className={
                                    u.blocked
                                      ? "text-[10px] text-red-300"
                                      : "text-[10px] text-emerald-300"
                                  }
                                >
                                  {u.blocked ? "Bloqué" : "Autorisé"}
                                </span>

                                {(u.totalIaCalls ||
                                  u.totalCvGenerated ||
                                  u.totalLmGenerated) && (
                                  <span className="text-[10px] text-sky-300">
                                    IA: {u.totalIaCalls ?? 0} · CV:{" "}
                                    {u.totalCvGenerated ?? 0} · LM:{" "}
                                    {u.totalLmGenerated ?? 0}
                                  </span>
                                )}

                                {u.authFailedCount &&
                                  u.authFailedCount > 0 && (
                                    <span className="text-[10px] text-red-300">
                                      ⚠ {u.authFailedCount} tentatives login
                                      échouées
                                    </span>
                                  )}

                                {u.lastAction && (
                                  <span className="text-[10px] text-slate-400 line-clamp-1">
                                    Dernière action: {u.lastAction}
                                  </span>
                                )}
                              </div>
                            </td>

                            {/* Dernier login */}
                            <td className="py-2 pr-3 align-top hidden md:table-cell text-slate-200">
                              {formatDate(u.lastLoginAt)}
                            </td>

                            {/* Dernière activité */}
                            <td className="py-2 pr-3 align-top hidden lg:table-cell text-slate-200">
                              {formatDate(u.lastSeenAt)}
                              <div className="text-[10px] text-slate-400">
                                {formatRelative(u.lastSeenAt)}
                              </div>
                            </td>

                            {/* Actions */}
                            <td className="py-2 pl-3 align-top">
                              <div className="flex flex-col gap-1">
                                <button
                                  type="button"
                                  onClick={() => handleToggleBlocked(u)}
                                  disabled={isUpdating}
                                  className={
                                    "inline-flex items-center justify-center rounded-full px-2.5 py-1 text-[10px] border " +
                                    (u.blocked
                                      ? "border-emerald-400/70 text-emerald-200 hover:bg-emerald-500/10"
                                      : "border-red-400/70 text-red-200 hover:bg-red-500/10")
                                  }
                                >
                                  {isUpdating
                                    ? "…"
                                    : u.blocked
                                    ? "Débloquer"
                                    : "Bloquer"}
                                </button>
                                <button
                                  type="button"
                                  onClick={() => handleDeleteUser(u)}
                                  disabled={isUpdating}
                                  className="inline-flex items-center justify-center rounded-full px-2.5 py-1 text-[10px] border border-slate-700 text-slate-300 hover:border-red-500 hover:text-red-300 disabled:opacity-60"
                                >
                                  Supprimer
                                </button>
                              </div>
                            </td>
                          </tr>
                        );
                      })}
                    </tbody>
                  </table>
                </div>
              )}
            </div>
          </>
        )}

        {/* ONGLET LOGS */}
        {activeTab === "logs" && (
          <div className="space-y-4">
            {/* STATS + COURBE */}
            <div className="grid gap-3 lg:grid-cols-[2fr,1fr]">
              <div className="rounded-2xl border border-slate-800 bg-slate-950/80 p-4 sm:p-5 shadow-inner shadow-black/40">
                <div className="flex items-center justify-between mb-3 gap-2">
                  <h2 className="text-sm sm:text-base font-semibold text-white">
                    Activité IA (LM / CV)
                  </h2>
                  {loadingLogs && (
                    <span className="text-[11px] text-slate-400">
                      Chargement…
                    </span>
                  )}
                </div>
                <div className="relative h-[220px] sm:h-[260px]">
                  <canvas ref={logsChartRef} />
                </div>
              </div>

              <div className="grid gap-3 sm:grid-cols-2 lg:grid-cols-1">
                <div className="rounded-2xl border border-slate-800 bg-slate-950/80 p-4 shadow-inner shadow-black/40">
                  <p className="text-[11px] uppercase tracking-[0.18em] text-slate-400 mb-1">
                    LM générées (logs)
                  </p>
                  <p className="text-2xl font-semibold text-white">
                    {usageLogs.filter((l) => l.docType === "lm").length}
                  </p>
                  <p className="text-[11px] text-slate-400">
                    Nombre d&apos;événements avec <code>docType = "lm"</code>.
                  </p>
                </div>
                <div className="rounded-2xl border border-slate-800 bg-slate-950/80 p-4 shadow-inner shadow-black/40">
                  <p className="text-[11px] uppercase tracking-[0.18em] text-slate-400 mb-1">
                    Tentatives suspectes
                  </p>
                  <p className="text-2xl font-semibold text-white">
                    {suspiciousLogs}
                  </p>
                  <p className="text-[11px] text-slate-400">
                    Logs avec <code>action = "auth_failed"</code> (échecs de
                    connexion). À logger côté Auth sur chaque erreur de login.
                  </p>
                </div>
              </div>
            </div>

            {/* TABLE DES LOGS */}
            <div className="rounded-2xl border border-slate-800 bg-slate-950/80 p-4 sm:p-5 shadow-inner shadow-black/40">
              <div className="flex items-center justify-between mb-3 gap-2">
                <h2 className="text-sm sm:text-base font-semibold text-white">
                  Logs d&apos;usage IA (derniers 200)
                </h2>
                <div className="flex items-center gap-2">
                  {/* Filtre logs vs auth_failed */}
                  <div className="inline-flex items-center gap-1 rounded-full border border-slate-700 bg-slate-900/80 p-1">
                    <button
                      type="button"
                      onClick={() => setLogFilter("all")}
                      className={
                        "px-2.5 py-0.5 rounded-full text-[10px] " +
                        (logFilter === "all"
                          ? "bg-sky-500 text-slate-900"
                          : "text-slate-300 hover:text-white")
                      }
                    >
                      Tous
                    </button>
                    <button
                      type="button"
                      onClick={() => setLogFilter("auth_failed")}
                      className={
                        "px-2.5 py-0.5 rounded-full text-[10px] " +
                        (logFilter === "auth_failed"
                          ? "bg-red-500 text-slate-900"
                          : "text-slate-300 hover:text-white")
                      }
                    >
                      Échecs de connexion
                    </button>
                  </div>

                  {loadingLogs && (
                    <span className="text-[11px] text-slate-400">
                      Chargement…
                    </span>
                  )}
                </div>
              </div>

              {usageLogs.length === 0 && !loadingLogs && (
                <p className="text-[12px] text-slate-400">
                  Aucun log d&apos;usage trouvé. Vérifie que{" "}
                  <code className="text-sky-300">logUsage()</code> est bien
                  appelé quand tu génères / télécharges LM & CV, et que tu
                  loggues aussi les erreurs de connexion avec{" "}
                  <code className="text-sky-300">action = "auth_failed"</code>.
                </p>
              )}

              {usageLogs.length > 0 && filteredLogs.length === 0 && (
                <p className="text-[12px] text-slate-400">
                  Aucun log pour ce filtre. Il n&apos;y a pas (encore) de
                  logs avec <code>action = "auth_failed"</code>.
                </p>
              )}

              {filteredLogs.length > 0 && (
                <div className="overflow-x-auto mt-2">
                  <table className="w-full text-[11px] sm:text-[12px] border-collapse">
                    <thead>
                      <tr className="text-slate-400 border-b border-slate-800">
                        <th className="text-left py-2 pr-3">Date</th>
                        <th className="text-left py-2 pr-3">User</th>
                        <th className="text-left py-2 pr-3">Action</th>
                        <th className="text-left py-2 pr-3 hidden md:table-cell">
                          Crédit
                        </th>
                        <th className="text-left py-2 pr-3 hidden sm:table-cell">
                          Localisation / Appareil
                        </th>
                        <th className="text-left py-2 pl-3 hidden lg:table-cell">
                          Page
                        </th>
                      </tr>
                    </thead>
                    <tbody>
                      {filteredLogs.map((log) => {
                        const flag = getCountryFlag(log.country);
                        const deviceLabel = formatDevice(
                          log.deviceType ?? undefined,
                          log.os ?? undefined
                        );
                        const pageLabel = getPageLabel(log.path ?? undefined);

                        const isSuspicious = log.action === "auth_failed";

                        return (
                          <tr
                            key={log.id}
                            className={
                              "border-b border-slate-800/70 hover:bg-slate-900/60 " +
                              (isSuspicious ? "bg-red-900/10" : "")
                            }
                          >
                            <td className="py-2 pr-3 align-top text-slate-200">
                              <div className="flex flex-col">
                                <span>{formatDate(log.createdAt)}</span>
                                <span className="text-[10px] text-slate-400">
                                  {formatRelative(log.createdAt ?? null)}
                                </span>
                              </div>
                            </td>
                            <td className="py-2 pr-3 align-top">
                              <div className="flex flex-col">
                                <span className="text-slate-100">
                                  {log.email || "—"}
                                </span>
                                <span className="text-[10px] text-slate-400">
                                  UID: {log.userId}
                                </span>
                              </div>
                            </td>
                            <td className="py-2 pr-3 align-top">
                              <div className="flex flex-col gap-0.5">
                                <span
                                  className={
                                    "text-slate-100 " +
                                    (log.action === "auth_failed"
                                      ? "text-red-300"
                                      : "")
                                  }
                                >
                                  {log.action}
                                </span>
                                <span className="text-[10px] text-slate-400">
                                  {log.docType || "—"}{" "}
                                  {log.eventType
                                    ? `· ${log.eventType}`
                                    : ""}
                                </span>
                                {log.tool && (
                                  <span className="inline-flex w-fit rounded-full border border-sky-500/50 bg-sky-500/10 px-2 py-[1px] text-[10px] text-sky-200">
                                    {log.tool}
                                  </span>
                                )}
                              </div>
                            </td>
                            <td className="py-2 pr-3 align-top hidden md:table-cell text-slate-200">
                              {log.creditsDelta != null ? (
                                <span
                                  className={
                                    log.creditsDelta < 0
                                      ? "text-red-300"
                                      : log.creditsDelta > 0
                                      ? "text-emerald-300"
                                      : "text-slate-200"
                                  }
                                >
                                  {log.creditsDelta > 0 ? "+" : ""}
                                  {log.creditsDelta}
                                </span>
                              ) : (
                                "—"
                              )}
                            </td>
                            <td className="py-2 pr-3 align-top hidden sm:table-cell text-slate-200">
                              <div className="flex flex-col gap-0.5">
                                <div className="flex items-center gap-1.5">
                                  <span className="text-lg">{flag}</span>
                                  <span>
                                    {log.city || log.country
                                      ? `${log.city ?? ""}${
                                          log.city && log.country ? " · " : ""
                                        }${log.country ?? ""}`
                                      : "—"}
                                  </span>
                                </div>
                                {log.ip && (
                                  <span className="text-[10px] text-slate-400">
                                    IP: {log.ip}
                                  </span>
                                )}
                                <span className="text-[10px] text-slate-400">
                                  {deviceLabel}
                                </span>
                                {log.browser && (
                                  <span className="text-[10px] text-slate-500">
                                    Navigateur: {log.browser}
                                  </span>
                                )}
                              </div>
                            </td>
                            <td className="py-2 pl-3 align-top hidden lg:table-cell text-slate-200">
                              <span className="text-[11px] text-slate-300 line-clamp-1">
                                Section: {pageLabel}
                              </span>
                              {log.path && (
                                <div className="text-[10px] text-slate-500 line-clamp-1">
                                  Path: {log.path}
                                </div>
                              )}
                            </td>
                          </tr>
                        );
                      })}
                    </tbody>
                  </table>
                </div>
              )}
            </div>
          </div>
        )}
      </div>
    </div>
  );
}
````

## File: app/api/generateInterviewQA/route.ts
````typescript
// app/api/generateInterviewQA/route.ts
import { NextRequest, NextResponse } from "next/server";

export const runtime = "nodejs";

// Petit helper pour récupérer un JSON même si Gemini met des ```json ... ```
function extractJson(text: string): any | null {
  if (!text) return null;

  let t = text.trim();

  // Si Gemini renvoie ```json ... ```
  if (t.startsWith("```")) {
    // retire ```json ou ``` et la dernière ```
    t = t.replace(/^```[a-zA-Z]*\s*/, "").replace(/```$/, "").trim();
  }

  // 1ère tentative : parser tout
  try {
    return JSON.parse(t);
  } catch {
    // ignore, on tente plus bas
  }

  // 2ème tentative : chercher le premier bloc {...}
  const match = t.match(/\{[\s\S]*\}/);
  if (match) {
    try {
      return JSON.parse(match[0]);
    } catch {
      // toujours pas bon
    }
  }

  return null;
}

export async function POST(req: NextRequest) {
  try {
    const body = await req.json();
    const { profile, experienceIndex, lang = "fr" } = body;

    if (!profile || typeof experienceIndex !== "number") {
      return NextResponse.json(
        { error: "Missing profile or experienceIndex" },
        { status: 400 }
      );
    }

    const experiences: any[] =
      (profile.experiences as any[]) ||
      (profile.experience as any[]) ||
      [];

    const exp = experiences[experienceIndex];
    if (!exp) {
      return NextResponse.json(
        { error: "Experience not found" },
        { status: 404 }
      );
    }

    const bullets = Array.isArray(exp.bullets)
      ? exp.bullets.join("\n- ")
      : "";

    const prompt = `
Tu es un coach d'entretien. Génère 5 questions d'entretien pour le candidat,
basées sur cette expérience de son CV, avec des réponses de qualité.

Tu dois renvoyer STRICTEMENT un objet JSON valide, sans aucun texte avant ou après.

Format de sortie EXACT :
{
  "questions": [
    {
      "question": "string",
      "answer": "string"
    }
  ]
}

Pas de commentaires, pas de texte hors de cet objet JSON.

Langue : ${lang === "en" ? "anglais" : "français"}.

Expérience :
- Poste : ${exp.role || exp.title || ""}
- Entreprise : ${exp.company || ""}
- Lieu : ${exp.city || exp.location || ""}
- Dates : ${exp.dates || ""}

Missions / résultats :
- ${bullets}
    `.trim();

    const apiKey = process.env.GEMINI_API_KEY;
    if (!apiKey) {
      console.warn("[generateInterviewQA] GEMINI_API_KEY manquant → mode démo.");
      // Fallback démo simple
      return NextResponse.json({
        questions: [
          {
            question:
              lang === "en"
                ? "Tell me about a challenge in this role and how you handled it."
                : "Parle-moi d’un défi que tu as rencontré sur ce poste et comment tu l’as géré.",
            answer:
              lang === "en"
                ? "Sample answer here…"
                : "Exemple de réponse ici…",
          },
        ],
        lang,
      });
    }

    const model =
      process.env.GEMINI_MODEL || "models/gemini-2.5-flash";

    const url = `https://generativelanguage.googleapis.com/v1beta/${model}:generateContent?key=${apiKey}`;

    const payload = {
      contents: [
        {
          role: "user",
          parts: [{ text: prompt }],
        },
      ],
      // >>> IMPORTANT : on force une réponse en JSON pur
      generationConfig: {
        response_mime_type: "application/json",
      },
    };

    const resp = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    });

    if (!resp.ok) {
      const errorText = await resp.text();
      console.error(
        "Gemini error (generateInterviewQA):",
        resp.status,
        errorText
      );

      if (resp.status === 429) {
        console.warn(
          "[generateInterviewQA] Quota Gemini dépassé → fallback démo."
        );
        return NextResponse.json({
          questions: [
            {
              question:
                lang === "en"
                  ? "Demo mode (quota exceeded): what did you learn in this experience?"
                  : "Mode démo (quota dépassé) : qu’as-tu appris dans cette expérience ?",
              answer:
                lang === "en"
                  ? "Sample answer here…"
                  : "Exemple de réponse ici…",
            },
          ],
          lang,
        });
      }

      return NextResponse.json(
        { error: "Gemini call failed" },
        { status: 500 }
      );
    }

    const data = await resp.json();

    const textRaw: string =
      data?.candidates?.[0]?.content?.parts
        ?.map((p: any) => p?.text || "")
        .join("")
        .trim() || "";

    if (!textRaw) {
      console.error("Empty Gemini response (generateInterviewQA):", data);
      // On ne jette plus une 500, on renvoie un fallback propre
      return NextResponse.json({
        questions: [
          {
            question:
              lang === "en"
                ? "Based on this experience, what are you most proud of?"
                : "De quoi es-tu le plus fier dans cette expérience ?",
            answer:
              lang === "en"
                ? "Sample answer here…"
                : "Exemple de réponse ici…",
          },
        ],
        lang,
      });
    }

    const parsed = extractJson(textRaw);

    if (!parsed || !Array.isArray(parsed.questions)) {
      console.error(
        "JSON parse error generateInterviewQA: texte non exploitable",
        textRaw
      );
      // Toujours un fallback pour ne plus avoir de 500 côté front
      return NextResponse.json({
        questions: [
          {
            question:
              lang === "en"
                ? "Tell me about this role and your main responsibilities."
                : "Parle-moi de ce poste et de tes principales responsabilités.",
            answer:
              lang === "en"
                ? "Sample answer here…"
                : "Exemple de réponse ici…",
          },
        ],
        lang,
      });
    }

    // On force la langue si absente
    if (!parsed.lang) {
      parsed.lang = lang;
    }

    return NextResponse.json(parsed);
  } catch (err) {
    console.error("generateInterviewQA API error:", err);
    return NextResponse.json(
      { error: "Internal error" },
      { status: 500 }
    );
  }
}
````

## File: app/api/interview/route.ts
````typescript
// app/api/interview/route.ts
import { NextRequest, NextResponse } from "next/server";
import {
  buildPrompt,
  InterviewLevel,
  InterviewChannel,
  HistoryItem,
} from "@/lib/interviewPrompt";
import {
  verifyUserAndCredits,
  consumeCredit,
} from "@/lib/server/credits";

export const runtime = "nodejs";

// ---- Sessions en mémoire (DEV) ---- //

type InterviewSession = {
  userId: string;
  createdAt: string;
  lastUpdated: string;
  jobDesc: string;
  cvSummary: string;
  mode: string;
  level: InterviewLevel;
  channel: InterviewChannel;
  status: "active" | "completed";
  currentStep: number;
  history: HistoryItem[];
  score?: number | null;
  finalSummary?: string | null;
};

const memorySessions = new Map<string, InterviewSession>();

function createSessionId() {
  return Math.random().toString(36).slice(2);
}

// ---- Handler principal ---- //

export async function POST(req: NextRequest) {
  try {
    const body = await req.json();
    const { action } = body;

    // ---------- DÉMARRER L'ENTRETIEN ---------- //
    if (action === "start") {
      const { userId, jobDesc, cvSummary, mode, channel, level } = body;

      if (!userId) {
        return NextResponse.json(
          { error: "Missing userId" },
          { status: 400 }
        );
      }

      const user = await verifyUserAndCredits(userId);
      if (!user) {
        return NextResponse.json(
          { error: "Unauthorized or no credits" },
          { status: 401 }
        );
      }

      const nowIso = new Date().toISOString();

      const safeMode = (mode || "mixed") as string;
      const safeChannel = (channel || "written") as InterviewChannel;
      const safeLevel = (level || "junior") as InterviewLevel;

      const sessionId = createSessionId();

      const sessionData: InterviewSession = {
        userId,
        createdAt: nowIso,
        lastUpdated: nowIso,
        jobDesc: jobDesc || "",
        cvSummary: cvSummary || "",
        mode: safeMode,
        level: safeLevel,
        channel: safeChannel,
        status: "active",
        currentStep: 1,
        history: [],
      };

      memorySessions.set(sessionId, sessionData);

      const prompt = buildPrompt({
        cvSummary: sessionData.cvSummary,
        jobDesc: sessionData.jobDesc,
        mode: sessionData.mode,
        level: sessionData.level,
        channel: sessionData.channel,
        history: [],
        step: 1,
      });

      const llmResponseText = await callLLM(prompt);

      let parsed: any;
      try {
        parsed = JSON.parse(llmResponseText);
      } catch (err) {
        console.error("JSON parse error (start):", err, llmResponseText);
        return NextResponse.json(
          { error: "LLM response parse error" },
          { status: 500 }
        );
      }

      const firstQuestion =
        parsed.next_question || "Parlez-moi de vous.";

      const historyItem: HistoryItem = {
        role: "interviewer",
        text: firstQuestion,
        createdAt: new Date().toISOString(),
      };

      const updatedSession = memorySessions.get(sessionId);
      if (updatedSession) {
        updatedSession.history.push(historyItem);
        updatedSession.currentStep = 1;
        updatedSession.lastUpdated = new Date().toISOString();
        memorySessions.set(sessionId, updatedSession);
      }

      await consumeCredit(userId);

      return NextResponse.json({
        sessionId,
        firstQuestion,
        shortAnalysis: parsed.short_analysis ?? null,
      });
    }

    // ---------- RÉPONDRE À UNE QUESTION ---------- //
    if (action === "answer") {
      const { userId, sessionId, userMessage, channel, step } = body;

      if (!userId || !sessionId || !userMessage?.trim()) {
        return NextResponse.json(
          { error: "Missing userId, sessionId or userMessage" },
          { status: 400 }
        );
      }

      const user = await verifyUserAndCredits(userId);
      if (!user) {
        return NextResponse.json(
          { error: "Unauthorized or no credits" },
          { status: 401 }
        );
      }

      const session = memorySessions.get(sessionId);
      if (!session) {
        return NextResponse.json(
          { error: "Session not found" },
          { status: 404 }
        );
      }

      if (session.userId !== userId) {
        return NextResponse.json(
          { error: "Forbidden" },
          { status: 403 }
        );
      }

      const history = Array.isArray(session.history)
        ? [...session.history]
        : [];

      history.push({
        role: "candidate",
        text: userMessage,
        createdAt: new Date().toISOString(),
      });

      const nextStep =
        typeof step === "number"
          ? step
          : (session.currentStep || 1) + 1;

      const prompt = buildPrompt({
        cvSummary: session.cvSummary,
        jobDesc: session.jobDesc,
        mode: session.mode,
        level: (session.level || "junior") as InterviewLevel,
        channel: (channel || session.channel || "written") as InterviewChannel,
        history,
        step: nextStep,
      });

      const llmResponseText = await callLLM(prompt);

      let parsed: any;
      try {
        parsed = JSON.parse(llmResponseText);
        } catch (err) {
        console.error("JSON parse error (answer):", err, llmResponseText);
        return NextResponse.json(
          { error: "LLM response parse error" },
          { status: 500 }
        );
      }

      const nextQuestion =
        parsed.next_question || "Merci, l’entretien est terminé.";
      const shortAnalysis = parsed.short_analysis ?? "";
      const isFinal = Boolean(parsed.final_summary);

      history.push({
        role: "interviewer",
        text: nextQuestion,
        createdAt: new Date().toISOString(),
      });

      const nowIso = new Date().toISOString();

      const updated: InterviewSession = {
        ...session,
        history,
        lastUpdated: nowIso,
        currentStep: nextStep,
      };

      if (isFinal) {
        updated.status = "completed";
        updated.score = parsed.final_score ?? null;
        updated.finalSummary = parsed.final_summary ?? null;
      }

      memorySessions.set(sessionId, updated);

      await consumeCredit(userId);

      return NextResponse.json({
        nextQuestion,
        shortAnalysis,
        finalSummary: parsed.final_summary ?? null,
        finalScore: parsed.final_score ?? null,
        isFinal,
      });
    }

    return NextResponse.json(
      { error: "Unknown action" },
      { status: 400 }
    );
  } catch (err) {
    console.error("Interview API error:", err);
    return NextResponse.json(
      { error: "Internal error" },
      { status: 500 }
    );
  }
}

// ---- APPEL GEMINI ---- //

async function callLLM(prompt: string): Promise<string> {
  const apiKey = process.env.GEMINI_API_KEY;

  if (!apiKey) {
    console.warn(
      "[Interview] GEMINI_API_KEY manquant → fallback démo."
    );
    // 👉 ici tu peux renvoyer une réponse “fake” simple
    return JSON.stringify({
      next_question:
        "Mode démo : peux-tu me résumer ton expérience la plus récente en lien avec ce poste ?",
      short_analysis:
        "Mode démo sans Gemini : configure GEMINI_API_KEY pour avoir l’analyse réelle.",
      final_summary: null,
      final_score: null,
    });
  }

  // 🔴 ICI tu choisis le modèle 2.5
  const model =
    process.env.GEMINI_MODEL || "models/gemini-2.5-flash";

  const url = `https://generativelanguage.googleapis.com/v1beta/${model}:generateContent?key=${apiKey}`;

  const payload = {
    contents: [
      {
        role: "user",
        parts: [{ text: prompt }],
      },
    ],
  };

  const resp = await fetch(url, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
    },
    body: JSON.stringify(payload),
  });

  if (!resp.ok) {
    const errorText = await resp.text();
    console.error("Gemini error (interview):", resp.status, errorText);

    // Si c’est un 429 (quota dépassé), tu peux retourner un JSON “fallback”
    if (resp.status === 429) {
      console.warn("[Interview] Quota Gemini dépassé → fallback démo.");
      return JSON.stringify({
        next_question:
          "Mode démo (quota dépassé) : peux-tu me raconter un de tes projets dont tu es fièr(e) ?",
        short_analysis:
          "Le quota de l’API Gemini est dépassé. Ceci est un scénario d’entretien simulé.",
        final_summary: null,
        final_score: null,
      });
    }

    throw new Error("Gemini call failed");
  }

  const data = await resp.json();

  const textRaw: string =
    data?.candidates?.[0]?.content?.parts
      ?.map((p: any) => p.text || "")
      .join("")
      .trim() || "";

  if (!textRaw) {
    throw new Error("Empty Gemini response");
  }

  const text = textRaw.trim();

  // On laisse Gemini renvoyer directement un JSON ; le parse se fait dans le handler
  return text;
}
````

## File: app/api/jobs/route.ts
````typescript
// app/api/jobs/route.ts
import { NextRequest, NextResponse } from "next/server";

export const runtime = "nodejs";

// Clés Adzuna côté serveur Next
const ADZUNA_APP_ID = process.env.ADZUNA_APP_ID;
const ADZUNA_APP_KEY = process.env.ADZUNA_APP_KEY;

// Base CF pour vérifier reCAPTCHA côté serveur (anti-bypass)
const DEFAULT_API_BASE =
  "https://europe-west1-assistant-ia-v4.cloudfunctions.net";
const API_BASE = (
  process.env.NEXT_PUBLIC_API_BASE_URL ||
  process.env.API_BASE_URL ||
  DEFAULT_API_BASE
).replace(/\/+$/, "");

async function verifyRecaptchaServer(token: string, action: string) {
  const res = await fetch(`${API_BASE}/recaptchaVerify`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ token, action: (action || "").trim().toLowerCase() }),
    cache: "no-store",
  });

  const data: any = await res.json().catch(() => ({}));
  return { ok: res.ok && data?.ok === true, data };
}

type AdzunaRawJob = {
  id?: string;
  title?: string;
  company?: { display_name?: string };
  location?: { display_name?: string };
  redirect_url?: string;
  description?: string;
  created?: string;
  salary_min?: number;
  salary_max?: number;
};

type AdzunaRawResponse = {
  results?: AdzunaRawJob[];
  count?: number;
  mean?: number;
};

const ALLOWED_COUNTRIES = new Set([
  "fr",
  "be",
  "ch",
  "ca",
  "gb",
  "es",
  "de",
  "it",
]);

function asNumber(v: any): number | undefined {
  const n = typeof v === "number" ? v : Number(v);
  return Number.isFinite(n) ? n : undefined;
}

export async function POST(req: NextRequest) {
  try {
    const body = await req.json();

    const {
      query,
      location,
      country = "fr",
      page = 1,
      results_per_page = 50,

      // Filtres optionnels (front)
      contract_time, // "any" | "full_time" | "part_time"
      contract_type, // "any" | "permanent" | "contract"
      salary_min,
      salary_max,
      max_days_old,

      recaptchaToken,
    } = body || {};

    // ✅ reCAPTCHA (anti-bypass)
    const check = await verifyRecaptchaServer(
      String(recaptchaToken || ""),
      "jobs_search"
    );
    if (!check.ok) {
      return NextResponse.json(
        { error: "reCAPTCHA refusé", details: check.data },
        { status: 403 }
      );
    }

    if (!query && !location) {
      return NextResponse.json(
        { error: "query ou location requis" },
        { status: 400 }
      );
    }

    if (!ADZUNA_APP_ID || !ADZUNA_APP_KEY) {
      console.error("ADZUNA_APP_ID ou ADZUNA_APP_KEY manquants");
      return NextResponse.json(
        {
          error:
            "Clés Adzuna non configurées côté serveur. Ajoute ADZUNA_APP_ID et ADZUNA_APP_KEY dans ton .env.local.",
        },
        { status: 500 }
      );
    }

    const safeCountry = String(country || "fr").toLowerCase().trim();
    const countryCode = ALLOWED_COUNTRIES.has(safeCountry) ? safeCountry : "fr";

    const safePage = asNumber(page) && (page as number) > 0 ? Number(page) : 1;

    const rppRaw = asNumber(results_per_page) ?? 50;
    const safeRpp = Math.max(1, Math.min(100, Math.floor(rppRaw)));

    const params = new URLSearchParams();
    params.set("app_id", ADZUNA_APP_ID);
    params.set("app_key", ADZUNA_APP_KEY);
    params.set("results_per_page", String(safeRpp));
    params.set("content-type", "application/json");

    if (query) params.set("what", String(query));
    if (location) params.set("where", String(location));

    // Filtres Adzuna
    const salMin = asNumber(salary_min);
    const salMax = asNumber(salary_max);
    const maxDays = asNumber(max_days_old);

    if (salMin !== undefined) params.set("salary_min", String(Math.floor(salMin)));
    if (salMax !== undefined) params.set("salary_max", String(Math.floor(salMax)));
    if (maxDays !== undefined) params.set("max_days_old", String(Math.floor(maxDays)));

    // contract_time
    if (contract_time === "full_time") params.set("full_time", "1");
    if (contract_time === "part_time") params.set("part_time", "1");

    // contract_type
    if (contract_type === "permanent") params.set("permanent", "1");
    if (contract_type === "contract") params.set("contract", "1");

    // URL
    const url = `https://api.adzuna.com/v1/api/jobs/${countryCode}/search/${safePage}?${params.toString()}`;

    const resp = await fetch(url, {
      method: "GET",
      headers: { Accept: "application/json" },
    });

    if (!resp.ok) {
      const textErr = await resp.text();
      console.error("Erreur Adzuna:", resp.status, textErr);
      return NextResponse.json(
        { error: "Erreur lors de l'appel à l'API Adzuna." },
        { status: 500 }
      );
    }

    const data: AdzunaRawResponse = await resp.json();

    const jobs =
      (data.results || []).map((job, index) => ({
        id: job.id || `job-${safePage}-${index}`,
        title: job.title || "Offre sans titre",
        company: job.company?.display_name || "Entreprise non renseignée",
        location: job.location?.display_name || "Lieu non précisé",
        url: job.redirect_url || "",
        description: job.description || "",
        created: job.created || "",
        // ✅ important pour ton front (il calcule salary avec salary_min/max)
        salary_min: typeof job.salary_min === "number" ? job.salary_min : undefined,
        salary_max: typeof job.salary_max === "number" ? job.salary_max : undefined,
      })) || [];

    return NextResponse.json({
      jobs,
      meta: {
        country: countryCode,
        page: safePage,
        results_per_page: safeRpp,
        count: typeof data.count === "number" ? data.count : undefined,
      },
    });
  } catch (err) {
    console.error("Erreur /api/jobs:", err);
    return NextResponse.json(
      { error: "Erreur interne lors de la recherche d'offres (API jobs)." },
      { status: 500 }
    );
  }
}
````

## File: app/api/letterAndPitch/route.ts
````typescript
// app/api/letterAndPitch/route.ts
import { NextRequest, NextResponse } from "next/server";

export const runtime = "nodejs";

function getModelPath(envValue: string | undefined, fallback: string): string {
  const raw = (envValue || fallback).trim();
  return raw.startsWith("models/") ? raw : `models/${raw}`;
}

// Base Cloud Functions pour vérifier reCAPTCHA côté serveur
const DEFAULT_API_BASE =
  "https://europe-west1-assistant-ia-v4.cloudfunctions.net";
const API_BASE = (
  process.env.NEXT_PUBLIC_API_BASE_URL ||
  process.env.API_BASE_URL ||
  DEFAULT_API_BASE
).replace(/\/+$/, "");

async function verifyRecaptchaServer(token: string, action: string) {
  const res = await fetch(`${API_BASE}/recaptchaVerify`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ token, action: (action || "").trim().toLowerCase() }),
    cache: "no-store",
  });

  const data: any = await res.json().catch(() => ({}));
  return { ok: res.ok && data?.ok === true, data };
}

// Helper: enlève ```json ... ``` si besoin
function extractJson(text: string): any | null {
  if (!text) return null;
  let t = text.trim();

  if (t.startsWith("```")) {
    t = t.replace(/^```[a-zA-Z]*\s*/, "").replace(/```$/, "").trim();
  }

  try {
    return JSON.parse(t);
  } catch {
    const match = t.match(/\{[\s\S]*\}/);
    if (match) {
      try {
        return JSON.parse(match[0]);
      } catch {
        return null;
      }
    }
    return null;
  }
}

export async function POST(req: NextRequest) {
  try {
    const body = await req.json();
    const {
      profile,
      jobTitle = "",
      companyName = "",
      jobDescription = "",
      lang = "fr",
      recaptchaToken,
    } = body || {};

    // ✅ Vérif reCAPTCHA (anti-bypass)
    const check = await verifyRecaptchaServer(
      String(recaptchaToken || ""),
      "generate_letter_pitch"
    );
    if (!check.ok) {
      return NextResponse.json(
        { error: "reCAPTCHA refusé", details: check.data },
        { status: 403 }
      );
    }

    if (!profile) {
      return NextResponse.json({ error: "Missing profile" }, { status: 400 });
    }

    const apiKey = process.env.GEMINI_API_KEY;
    if (!apiKey) {
      console.warn("[letterAndPitch] GEMINI_API_KEY manquant → mode démo.");
      return NextResponse.json({
        coverLetter:
          lang === "en"
            ? "Demo mode: here would be a tailored cover letter based on your CV and the job description."
            : "Mode démo : ici apparaîtrait une lettre de motivation personnalisée à partir de ton CV et de l'offre.",
        pitch:
          lang === "en"
            ? "Demo mode: here would be a short elevator pitch summarizing your profile for this job."
            : "Mode démo : ici apparaîtrait un court pitch d’ascenseur résumant ton profil pour ce poste.",
        lang,
      });
    }

    const model = getModelPath(process.env.GEMINI_MODEL, "gemini-2.5-flash");
    const url = `https://generativelanguage.googleapis.com/v1beta/${model}:generateContent?key=${apiKey}`;

    const profileJson = JSON.stringify(profile ?? {}).slice(0, 20000);

    const prompt = `
Tu es un assistant expert en candidatures.

À partir :
- du profil CV du candidat (en JSON),
- du poste visé (intitulé, entreprise),
- et d'éventuels extraits d'annonce,

tu dois produire :
1) une lettre de motivation complète (1 page max) prête à être envoyée,
2) un pitch d'ascenseur de 2 à 4 phrases pour se présenter rapidement.

Langue de sortie : ${lang === "en" ? "anglais" : "français"}.

Réponds STRICTEMENT au format JSON suivant, sans aucun texte avant ou après :

{
  "coverLetter": "string",
  "pitch": "string",
  "lang": "fr"
}

Où "lang" est "fr" ou "en".

Profil CV (JSON) :
${profileJson}

Informations sur le poste :
- Intitulé : ${jobTitle}
- Entreprise : ${companyName}
- Description / extraits d'annonce : ${jobDescription}
`.trim();

    const payload = {
      contents: [{ role: "user", parts: [{ text: prompt }] }],
      generationConfig: { response_mime_type: "application/json" },
    };

    const resp = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    });

    if (!resp.ok) {
      const errorText = await resp.text().catch(() => "");
      console.error("Gemini error (letterAndPitch):", resp.status, errorText);

      if (resp.status === 429) {
        return NextResponse.json({
          coverLetter:
            lang === "en"
              ? "Demo mode (quota exceeded): here is a short sample cover letter. Please try again later when the quota is reset."
              : "Mode démo (quota dépassé) : voici un exemple de lettre. Réessaie plus tard quand le quota sera réinitialisé.",
          pitch:
            lang === "en"
              ? "Demo mode (quota exceeded): here is a sample elevator pitch."
              : "Mode démo (quota dépassé) : voici un exemple de pitch d’ascenseur.",
          lang,
        });
      }

      return NextResponse.json({ error: "Gemini call failed" }, { status: 500 });
    }

    const data = await resp.json().catch(() => null);

    const textRaw: string =
      data?.candidates?.[0]?.content?.parts
        ?.map((p: any) => p?.text || "")
        .join("")
        .trim() || "";

    if (!textRaw) {
      console.error("Empty Gemini response (letterAndPitch):", data);
      return NextResponse.json({
        coverLetter:
          lang === "en"
            ? "Based on your experience and this role, explain in 3–4 paragraphs why you are a good fit."
            : "En te basant sur ton expérience et ce poste, explique en 3–4 paragraphes pourquoi tu es un bon profil.",
        pitch:
          lang === "en"
            ? "Summarize your profile in 2–3 sentences as if you were introducing yourself at the start of an interview."
            : "Résume ton profil en 2–3 phrases comme si tu te présentais en début d’entretien.",
        lang,
      });
    }

    const parsed = extractJson(textRaw);

    const coverLetter =
      typeof parsed?.coverLetter === "string" ? parsed.coverLetter.trim() : "";
    const pitch =
      typeof parsed?.pitch === "string" ? parsed.pitch.trim() : "";
    const outLang = typeof parsed?.lang === "string" ? parsed.lang : lang;

    if (!coverLetter && !pitch) {
      console.error("letterAndPitch: JSON non exploitable, texte brut :", textRaw);
      return NextResponse.json({
        coverLetter:
          lang === "en"
            ? "Based on your CV and this job, write a motivation letter explaining why you are a good match."
            : "À partir de ton CV et de cette offre, rédige une lettre de motivation expliquant pourquoi tu corresponds au poste.",
        pitch:
          lang === "en"
            ? "Give a short pitch (2–4 sentences) summarizing your profile for this job."
            : "Donne un court pitch (2–4 phrases) résumant ton profil pour ce poste.",
        lang,
      });
    }

    return NextResponse.json({ coverLetter, pitch, lang: outLang });
  } catch (err) {
    console.error("letterAndPitch API error:", err);
    return NextResponse.json({ error: "Internal error" }, { status: 500 });
  }
}
````

## File: app/api/linkedin/exchange/route.ts
````typescript
// app/api/linkedin/exchange/route.ts
import { NextRequest, NextResponse } from "next/server";
import qs from "querystring";

// ⚠️ Mets ces valeurs dans .env.local (voir plus bas)
const CLIENT_ID = process.env.LINKEDIN_CLIENT_ID!;
const CLIENT_SECRET = process.env.LINKEDIN_CLIENT_SECRET!;
const REDIRECT_URI = process.env.LINKEDIN_REDIRECT_URI!; // doit matcher l'URL callback

export async function POST(req: NextRequest) {
  try {
    const { code } = await req.json();

    if (!code) {
      return NextResponse.json(
        { error: "Missing authorization code" },
        { status: 400 }
      );
    }

    // 1) Échanger le code contre un access_token + id_token
    const tokenResp = await fetch(
      "https://www.linkedin.com/oauth/v2/accessToken",
      {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded"
        },
        body: qs.stringify({
          grant_type: "authorization_code",
          code,
          redirect_uri: REDIRECT_URI,
          client_id: CLIENT_ID,
          client_secret: CLIENT_SECRET
        })
      }
    );

    if (!tokenResp.ok) {
      const text = await tokenResp.text();
      console.error("LinkedIn token error:", text);
      return NextResponse.json(
        { error: "Failed to exchange code", details: text },
        { status: 400 }
      );
    }

    const tokenJson = (await tokenResp.json()) as any;

    // LinkedIn peut renvoyer un id_token si on a demandé scope "openid"
    const idToken = tokenJson.id_token;
    const accessToken = tokenJson.access_token;

    if (!idToken) {
      // On peut continuer avec accessToken si besoin, mais pour Firebase OIDC,
      // on veut surtout un id_token. Si pas dispo, renvoie erreur claire.
      return NextResponse.json(
        {
          error:
            "LinkedIn n'a pas renvoyé d'id_token (vérifie que le scope openid est bien activé)"
        },
        { status: 400 }
      );
    }

    return NextResponse.json({ idToken, accessToken });
  } catch (e: any) {
    console.error("LinkedIn exchange error:", e);
    return NextResponse.json(
      { error: "Server error", details: e.message },
      { status: 500 }
    );
  }
}
````

## File: app/api/linkedin/token/route.ts
````typescript
// app/api/linkedin/token/route.ts
import { NextRequest, NextResponse } from "next/server";

export async function POST(req: NextRequest) {
  try {
    const { code } = await req.json();

    if (!code) {
      return NextResponse.json(
        { error: "code manquant" },
        { status: 400 }
      );
    }

    const clientId = process.env.LINKEDIN_CLIENT_ID!;
    const clientSecret = process.env.LINKEDIN_CLIENT_SECRET!;
    const redirectUri = process.env.LINKEDIN_REDIRECT_URI!;

    const body = new URLSearchParams({
      grant_type: "authorization_code",
      code,
      redirect_uri: redirectUri,
      client_id: clientId,
      client_secret: clientSecret,
    });

    // Appel LinkedIn pour échanger le code
    const resp = await fetch("https://www.linkedin.com/oauth/v2/accessToken", {
      method: "POST",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded",
      },
      body: body.toString(),
    });

    const data = await resp.json();

    if (!resp.ok) {
      console.error("LinkedIn token error:", data);
      return NextResponse.json(
        { error: "Erreur LinkedIn", details: data },
        { status: 400 }
      );
    }

    // Avec le scope "openid", LinkedIn peut renvoyer un id_token
    const idToken = (data as any).id_token;

    if (!idToken) {
      return NextResponse.json(
        {
          error:
            "id_token manquant dans la réponse LinkedIn. Vérifie que le scope 'openid' est bien activé.",
          details: data,
        },
        { status: 400 }
      );
    }

    return NextResponse.json({ idToken });
  } catch (e: any) {
    console.error("API /api/linkedin/token error:", e);
    return NextResponse.json(
      { error: e.message ?? "Erreur serveur" },
      { status: 500 }
    );
  }
}
````

## File: app/api/polar/checkout/route.ts
````typescript
// src/app/api/polar/checkout/route.ts
// @ts-nocheck
import { NextRequest, NextResponse } from "next/server";
import { createPolarCheckout, CreditPackId } from "@/lib/polar";

// Cette route tourne en mode node en dev / en mode serveur
export const runtime = "nodejs";
// ⚠️ NE PAS mettre `export const dynamic = "force-dynamic"` ici en output: "export"

export async function POST(req: NextRequest) {
  try {
    let body: any = null;
    try {
      body = await req.json();
    } catch (e) {
      console.error("[/api/polar/checkout] Body non JSON ou vide");
      return NextResponse.json(
        {
          ok: false,
          error: "Body JSON invalide pour /api/polar/checkout.",
        },
        { status: 400 }
      );
    }

    const packId = body.packId as CreditPackId | undefined;
    const userId = body.userId as string | undefined;
    const email = body.email as string | undefined;

    console.log("[/api/polar/checkout] body reçu :", body);

    if (!packId || !userId || !email) {
      console.error("[/api/polar/checkout] Paramètres manquants", {
        packId,
        userId,
        email,
      });
      return NextResponse.json(
        {
          ok: false,
          error:
            "Paramètres manquants. Il faut packId ('20' | '50' | '100'), userId et email.",
        },
        { status: 400 }
      );
    }

    // Vérif rapide des variables d'env
    if (!process.env.POLAR_ACCESS_TOKEN) {
      console.error("[/api/polar/checkout] POLAR_ACCESS_TOKEN manquant");
      return NextResponse.json(
        {
          ok: false,
          error: "Config Polar manquante (POLAR_ACCESS_TOKEN).",
        },
        { status: 500 }
      );
    }

    const { url } = await createPolarCheckout({
      packId,
      userId,
      email,
    });

    console.log("[/api/polar/checkout] Checkout créé, URL :", url);

    // Toujours renvoyer du JSON
    return NextResponse.json({ ok: true, url }, { status: 200 });
  } catch (error: any) {
    console.error("[/api/polar/checkout] ERREUR :", error);

    return NextResponse.json(
      {
        ok: false,
        error: "Erreur lors de la création du checkout Polar.",
        detail: error?.message ?? String(error),
      },
      { status: 500 }
    );
  }
}
````

## File: app/api/polar/test/route.ts
````typescript
// src/app/api/polar/test/route.ts
import { NextResponse } from "next/server";
import { polar } from "@/lib/polar";

export async function GET() {
  try {
    // Appel simple à l'API Polar en prod
    const result = await polar.products.list({});

    // On renvoie directement ce que Polar renvoie,
    // sans essayer de boucler ni de faire des "..."
    return NextResponse.json({ ok: true, result });
  } catch (error: any) {
    console.error("Erreur Polar test (prod):", error);
    return NextResponse.json(
      {
        ok: false,
        message:
          "Erreur d'appel à Polar (prod). Vérifie POLAR_ACCESS_TOKEN si ça persiste.",
        detail: error?.message ?? String(error),
      },
      { status: 500 }
    );
  }
}
````

## File: app/api/stt/route.ts
````typescript
import { NextRequest, NextResponse } from "next/server";

export const runtime = "nodejs";

// Nettoie le nom du modèle si nécessaire
function getModelName(envValue: string | undefined, fallback: string): string {
  const raw = (envValue || fallback).trim();
  // On accepte "gemini-2.5-flash" ou "models/gemini-2.5-flash"
  return raw.replace(/^models\//, "");
}

export async function POST(req: NextRequest) {
  try {
    const formData = await req.formData();
    const file = formData.get("audio") as File | null;

    if (!file) {
      return NextResponse.json(
        { error: "Aucun fichier audio reçu (champ 'audio' manquant)." },
        { status: 400 }
      );
    }

    const arrayBuffer = await file.arrayBuffer();
    const buffer = Buffer.from(arrayBuffer);
    const base64 = buffer.toString("base64");
    const mimeType = file.type || "audio/webm";

    const apiKey = process.env.GEMINI_API_KEY;
    if (!apiKey) {
      console.error("[/api/stt] GEMINI_API_KEY manquant.");
      return NextResponse.json(
        { error: "GEMINI_API_KEY manquant côté serveur." },
        { status: 500 }
      );
    }

    // Modèle audio (configurable via env)
    const configuredModel = getModelName(
      process.env.GEMINI_STT_MODEL,
      "gemini-2.5-flash"
    );

    const url = `https://generativelanguage.googleapis.com/v1beta/models/${configuredModel}:generateContent?key=${apiKey}`;

    const prompt =
      "Transcris mot à mot l'audio suivant en texte. " +
      "Réponds uniquement par la transcription, sans guillemets ni commentaire.";

    const payload = {
      contents: [
        {
          role: "user",
          parts: [
            { text: prompt },
            {
              inlineData: {
                mimeType,
                data: base64,
              },
            },
          ],
        },
      ],
    };

    const resp = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    });

    const status = resp.status;
    const bodyText = await resp.text().catch(() => "");

    if (!resp.ok) {
      console.error("Erreur Gemini STT:", status, bodyText);

      if (status === 429) {
        return NextResponse.json(
          {
            error:
              "Quota Gemini STT dépassé. Réessaie un peu plus tard.",
          },
          { status: 429 }
        );
      }

      return NextResponse.json(
        { error: `Erreur Gemini (${status})` },
        { status: 500 }
      );
    }

    let data: any;
    try {
      data = JSON.parse(bodyText);
    } catch {
      return NextResponse.json(
        { error: "Réponse invalide de Gemini (JSON)" },
        { status: 500 }
      );
    }

    const transcript: string =
      data?.candidates?.[0]?.content?.parts
        ?.map((p: any) => p?.text || "")
        .join("")
        .trim() || "";

    return NextResponse.json({ transcript });
  } catch (err) {
    console.error("Erreur interne /api/stt:", err);
    return NextResponse.json(
      { error: "Erreur interne sur /api/stt" },
      { status: 500 }
    );
  }
}
````

## File: app/api/webhook/polar/route.ts
````typescript
// @ts-nocheck
import { NextRequest, NextResponse } from "next/server";
import {
  validateEvent,
  WebhookVerificationError,
  WebhookHeaders,
} from "@polar-sh/sdk/webhooks";
import {
  addCreditsToUserById,
  addCreditsToUserByEmail,
} from "@/lib/credits";

export const runtime = "nodejs";

// ✅ mapping product_id -> crédits (depuis tes .env)
const PRODUCT_ID_TO_CREDITS: Record<string, number> = {};

if (process.env.POLAR_PRODUCT_20_ID) {
  PRODUCT_ID_TO_CREDITS[process.env.POLAR_PRODUCT_20_ID] = 20;
}
if (process.env.POLAR_PRODUCT_50_ID) {
  PRODUCT_ID_TO_CREDITS[process.env.POLAR_PRODUCT_50_ID] = 50;
}
if (process.env.POLAR_PRODUCT_100_ID) {
  PRODUCT_ID_TO_CREDITS[process.env.POLAR_PRODUCT_100_ID] = 100;
}

// GET juste pour tester depuis le navigateur
export async function GET() {
  return NextResponse.json({
    ok: true,
    env: process.env.POLAR_ENV,
    mappedProducts: PRODUCT_ID_TO_CREDITS,
    message:
      "Endpoint webhook Polar OK. Utilisé en POST par Polar, pas en GET par le navigateur.",
  });
}

// Webhook POST appelé par Polar
export async function POST(req: NextRequest) {
  const secret = process.env.POLAR_WEBHOOK_SECRET;
  if (!secret) {
    console.error("POLAR_WEBHOOK_SECRET manquant");
    return new NextResponse("Config manquante", { status: 500 });
  }

  // 1) Body brut (texte) pour la vérification de signature
  const body = await req.text();

  // 2) Headers envoyés par Polar
  const headers: WebhookHeaders = {
    "webhook-id": req.headers.get("webhook-id") ?? "",
    "webhook-timestamp": req.headers.get("webhook-timestamp") ?? "",
    "webhook-signature": req.headers.get("webhook-signature") ?? "",
  };

  let event: any;
  try {
    // 3) Vérifier la signature + parser l'event
    event = validateEvent(body, headers, secret);
  } catch (error) {
    if (error instanceof WebhookVerificationError) {
      console.error("Signature Polar invalide");
      return new NextResponse("Signature invalide", { status: 403 });
    }
    console.error("Erreur webhook Polar:", error);
    return new NextResponse("Erreur interne", { status: 500 });
  }

  console.log("📬 Webhook Polar reçu:", event.type);

  // 4) Gestion des événements
  switch (event.type) {
    case "order.paid": {
      const data = event.data;

      console.log("💰 order.paid data brut:", JSON.stringify(data, null, 2));

      const productId = data.product_id as string | undefined;
      const creditsToAdd =
        (productId && PRODUCT_ID_TO_CREDITS[productId]) ?? 0;

      const externalId: string | undefined =
        (data.customer?.external_id as string | undefined) ?? undefined;
      const email: string | undefined =
        (data.customer?.email as string | undefined) ?? undefined;

      console.log("👤 Client pour crédit:", {
        productId,
        creditsToAdd,
        externalId,
        email,
      });

      if (creditsToAdd > 0) {
        try {
          if (externalId) {
            await addCreditsToUserById(externalId, creditsToAdd);
          } else if (email) {
            await addCreditsToUserByEmail(email, creditsToAdd);
          } else {
            console.warn(
              "⚠️ Aucun externalId ni email dans l'order.paid, impossible de créditer l'utilisateur."
            );
          }
        } catch (e) {
          console.error("Erreur lors de l'ajout de crédits Firestore:", e);
          // On n'échoue pas le webhook : Polar considère le paiement OK
        }
      } else {
        console.log(
          "Produit non mappé dans PRODUCT_ID_TO_CREDITS, aucun crédit ajouté."
        );
      }

      break;
    }

    default:
      console.log("Event non géré explicitement:", event.type);
  }

  // 5) Réponse OK pour Polar
  return NextResponse.json({ received: true });
}
````

## File: app/app/apply/page.tsx
````typescript
"use client";

import { useState, useEffect, FormEvent, useMemo } from "react";
import { motion } from "framer-motion";
import { auth, db } from "@/lib/firebase";
import { onAuthStateChanged } from "firebase/auth";
import { doc, getDoc, collection, addDoc, serverTimestamp } from "firebase/firestore";
import { getRecaptchaToken } from "@/lib/recaptcha";

// --- TYPES PROFIL / CV ---
type CvSkillsSection = { title: string; items: string[] };
type CvSkills = { sections: CvSkillsSection[]; tools: string[] };

type CvExperience = {
  company: string;
  role: string;
  dates: string;
  bullets: string[];
  location?: string;
};

type CvEducation = {
  school: string;
  degree: string;
  dates: string;
  location?: string;
};

type CvProfile = {
  fullName: string;
  email: string;
  phone: string;
  linkedin: string;
  profileSummary: string;

  city?: string;
  address?: string;

  contractType: string;
  contractTypeStandard?: string;
  contractTypeFull?: string;

  primaryDomain?: string;
  secondaryDomains?: string[];
  softSkills?: string[];

  drivingLicense?: string;
  vehicle?: string;

  skills: CvSkills;
  experiences: CvExperience[];
  education: CvEducation[];
  educationShort: string[];
  certs: string;
  langLine: string;
  hobbies: string[];
  updatedAt?: number;
};

type Lang = "fr" | "en";

type JobOffer = {
  id: string;
  title: string;
  company: string;
  location: string;
  url: string;
  description: string;
  created: string;
  salary: string | null;
  matchScore: number;
};

type LastOpenedJob = {
  id: string;
  title: string;
  company: string;
  url: string;
  location?: string;
  openedAt: number;
};

// --- ENDPOINTS CLOUD FUNCTIONS ---
const GENERATE_CV_API =
  "https://europe-west1-assistant-ia-v4.cloudfunctions.net/generateCvPdf";

const GENERATE_CV_LM_ZIP_API =
  "https://europe-west1-assistant-ia-v4.cloudfunctions.net/generateCvLmZip";

// --- AUTOCOMPLETE ---
const JOB_SUGGESTIONS = [
  "Kinésithérapeute",
  "Kiné respiratoire",
  "Infirmier",
  "Infirmière",
  "Médecin généraliste",
  "Développeur web",
  "Développeur front-end",
  "Développeur back-end",
  "Product Owner",
  "Chef de projet",
  "Data analyst",
  "Data engineer",
  "Comptable",
  "Chargé de recrutement",
  "Responsable RH",
  "Commercial B2B",
  "Commercial sédentaire",
  "UX designer",
  "Graphiste",
];

const CITY_SUGGESTIONS_FR = [
  "Paris",
  "Lyon",
  "Marseille",
  "Toulouse",
  "Nice",
  "Nantes",
  "Montpellier",
  "Strasbourg",
  "Bordeaux",
  "Lille",
  "Rennes",
  "Reims",
  "Le Havre",
  "Saint-Étienne",
  "Grenoble",
  "Dijon",
  "Angers",
  "Nîmes",
  "Villeurbanne",
  "Clermont-Ferrand",
];

const COUNTRY_CODES = [
  { code: "fr", label: "France" },
  { code: "be", label: "Belgique" },
  { code: "ch", label: "Suisse" },
  { code: "ca", label: "Canada" },
  { code: "gb", label: "Royaume-Uni" },
  { code: "es", label: "Espagne" },
  { code: "de", label: "Allemagne" },
  { code: "it", label: "Italie" },
];

// --- HELPERS ---
function normalize(str: string) {
  return str
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .toLowerCase();
}

function tokenize(str: string): string[] {
  return normalize(str)
    .split(/[^a-z0-9]+/i)
    .filter((t) => t.length >= 3);
}

function extractProfileKeywords(profile: CvProfile | null): string[] {
  if (!profile) return [];
  const tokens: string[] = [];

  if (profile.primaryDomain) tokens.push(profile.primaryDomain);
  if (Array.isArray(profile.secondaryDomains)) tokens.push(...profile.secondaryDomains);
  if (profile.profileSummary) tokens.push(profile.profileSummary);

  if (profile.skills) {
    if (Array.isArray(profile.skills.sections)) {
      profile.skills.sections.forEach((sec) => {
        if (sec?.title) tokens.push(sec.title);
        if (Array.isArray(sec?.items)) tokens.push(...sec.items);
      });
    }
    if (Array.isArray(profile.skills.tools)) tokens.push(...profile.skills.tools);
  }

  if (Array.isArray(profile.softSkills)) tokens.push(...profile.softSkills);

  if (Array.isArray(profile.experiences)) {
    profile.experiences.forEach((exp) => {
      if (exp.role) tokens.push(exp.role);
      if (exp.company) tokens.push(exp.company);
      if (Array.isArray(exp.bullets)) tokens.push(...exp.bullets);
    });
  }

  const dedup = Array.from(
    new Set(tokens.map((t) => String(t)).flatMap((t) => tokenize(t)))
  );

  return dedup.slice(0, 80);
}

function computeMatchScore(
  rawJob: any,
  profile: CvProfile | null,
  searchQuery: string,
  searchLocation: string,
  remoteOnly: boolean
): number {
  const title = rawJob.title || "";
  const company =
    (rawJob.company && rawJob.company.display_name) || rawJob.company || "";
  const description = rawJob.description || "";
  const loc =
    (rawJob.location && rawJob.location.display_name) || rawJob.location || "";

  const jobText = `${title} ${company} ${description} ${loc}`;
  const jobTokens = new Set(tokenize(jobText));

  const profileTokens = extractProfileKeywords(profile);
  const queryTokens = tokenize(searchQuery);
  const locationTokens = tokenize(searchLocation);

  const allKeywords = Array.from(new Set([...profileTokens, ...queryTokens]));

  let overlap = 0;
  for (const kw of allKeywords) {
    if (jobTokens.has(kw)) overlap += 1;
  }

  const baseDenom = Math.max(5, allKeywords.length || 5);
  let score = (overlap / baseDenom) * 100;

  if (locationTokens.length) {
    for (const lt of locationTokens) {
      if (jobTokens.has(lt)) {
        score += 10;
        break;
      }
    }
  }

  if (remoteOnly) {
    const jobNorm = normalize(jobText);
    if (/remote|teletravail|home\s*office|hybride/.test(jobNorm)) score += 10;
    else score -= 15;
  }

  return Math.max(0, Math.min(100, Math.round(score)));
}

function scoreBadgeClass(score: number): string {
  if (score >= 75) return "bg-emerald-500/15 text-emerald-300 border-emerald-400/60";
  if (score >= 50) return "bg-amber-500/15 text-amber-300 border-amber-400/60";
  if (score >= 30) return "bg-yellow-500/10 text-yellow-200 border-yellow-400/40";
  return "bg-red-500/10 text-red-200 border-red-400/40";
}

// --- PAGE ---
export default function ApplyPage() {
  // AUTH & PROFIL CV
  const [userId, setUserId] = useState<string | null>(null);
  const [userEmail, setUserEmail] = useState<string | null>(null);
  const [profile, setProfile] = useState<CvProfile | null>(null);
  const [loadingProfile, setLoadingProfile] = useState(true);

  useEffect(() => {
    const unsub = onAuthStateChanged(auth, async (user) => {
      if (!user) {
        setUserId(null);
        setUserEmail(null);
        setProfile(null);
        setLoadingProfile(false);
        return;
      }

      setUserId(user.uid);
      setUserEmail(user.email ?? null);

      try {
        const ref = doc(db, "profiles", user.uid);
        const snap = await getDoc(ref);

        if (snap.exists()) {
          const data = snap.data() as any;
          const loaded: CvProfile = {
            fullName: data.fullName || "",
            email: data.email || "",
            phone: data.phone || "",
            linkedin: data.linkedin || "",
            profileSummary: data.profileSummary || "",
            city: data.city || "",
            address: data.address || "",
            contractType: data.contractType || data.contractTypeStandard || "",
            contractTypeStandard: data.contractTypeStandard || "",
            contractTypeFull: data.contractTypeFull || "",
            primaryDomain: data.primaryDomain || "",
            secondaryDomains: Array.isArray(data.secondaryDomains) ? data.secondaryDomains : [],
            softSkills: Array.isArray(data.softSkills) ? data.softSkills : [],
            drivingLicense: data.drivingLicense || "",
            vehicle: data.vehicle || "",
            skills: {
              sections: Array.isArray(data.skills?.sections) ? data.skills.sections : [],
              tools: Array.isArray(data.skills?.tools) ? data.skills.tools : [],
            },
            experiences: Array.isArray(data.experiences) ? data.experiences : [],
            education: Array.isArray(data.education) ? data.education : [],
            educationShort: Array.isArray(data.educationShort) ? data.educationShort : [],
            certs: data.certs || "",
            langLine: data.langLine || "",
            hobbies: Array.isArray(data.hobbies) ? data.hobbies : [],
            updatedAt: typeof data.updatedAt === "number" ? data.updatedAt : undefined,
          };
          setProfile(loaded);
        } else {
          setProfile(null);
        }
      } catch (e) {
        console.error("Erreur chargement profil pour Apply:", e);
      } finally {
        setLoadingProfile(false);
      }
    });

    return () => unsub();
  }, []);

  const profileName = profile?.fullName || userEmail || "Profil non détecté";

  // RECHERCHE D’OFFRES
  const [searchQuery, setSearchQuery] = useState("");
  const [searchLocation, setSearchLocation] = useState("");
  const [searchCountry, setSearchCountry] = useState("fr");
  const [contractTime, setContractTime] = useState<"any" | "full_time" | "part_time">("any");
  const [contractType, setContractType] = useState<"any" | "permanent" | "contract">("any");
  const [remoteOnly, setRemoteOnly] = useState(false);
  const [minSalary, setMinSalary] = useState("");
  const [maxSalary, setMaxSalary] = useState("");
  const [publishedWithin, setPublishedWithin] = useState<"any" | "1" | "3" | "7" | "30">("7");

  const [jobs, setJobs] = useState<JobOffer[]>([]);
  const [searchLoading, setSearchLoading] = useState(false);
  const [searchError, setSearchError] = useState<string | null>(null);
  const [maxDisplay, setMaxDisplay] = useState(30);

  // VISITES / DÉJÀ CONSULTÉES
  const [visitedJobIds, setVisitedJobIds] = useState<string[]>([]);
  const [pendingApplyJob, setPendingApplyJob] = useState<LastOpenedJob | null>(null);

  useEffect(() => {
    if (typeof window === "undefined") return;
    try {
      const rawVisited = window.localStorage.getItem("visitedJobIds");
      if (rawVisited) {
        const arr = JSON.parse(rawVisited);
        if (Array.isArray(arr)) setVisitedJobIds(arr);
      }

      const rawLast = window.localStorage.getItem("lastOpenedJob");
      if (rawLast) {
        const obj = JSON.parse(rawLast) as LastOpenedJob;
        if (obj && obj.id && obj.title && obj.company) setPendingApplyJob(obj);
      }
    } catch (e) {
      console.error("Erreur lecture localStorage Apply:", e);
    }
  }, []);

  const markJobVisited = (job: JobOffer) => {
    if (typeof window === "undefined") return;

    setVisitedJobIds((prev) => {
      const set = new Set(prev);
      set.add(job.id);
      const arr = Array.from(set);
      window.localStorage.setItem("visitedJobIds", JSON.stringify(arr));
      return arr;
    });

    const last: LastOpenedJob = {
      id: job.id,
      title: job.title,
      company: job.company,
      url: job.url,
      location: job.location,
      openedAt: Date.now(),
    };
    window.localStorage.setItem("lastOpenedJob", JSON.stringify(last));
    setPendingApplyJob(last);
  };

  const clearPendingApplyJob = () => {
    if (typeof window !== "undefined") window.localStorage.removeItem("lastOpenedJob");
    setPendingApplyJob(null);
  };

  // AUTOCOMPLETE
  const jobAutocomplete = useMemo(() => {
    const q = searchQuery.trim();
    if (q.length < 2) return [];
    const lower = normalize(q);
    return JOB_SUGGESTIONS.filter((s) => normalize(s).startsWith(lower)).slice(0, 8);
  }, [searchQuery]);

  const cityAutocomplete = useMemo(() => {
    const q = searchLocation.trim();
    if (q.length < 2) return [];
    const lower = normalize(q);
    return CITY_SUGGESTIONS_FR.filter((s) => normalize(s).startsWith(lower)).slice(0, 8);
  }, [searchLocation]);

  // /api/jobs
  const handleSearchJobs = async (e: FormEvent) => {
    e.preventDefault();
    if (!searchQuery.trim() && !searchLocation.trim()) {
      alert("Saisis au moins un mot-clé ou une localisation.");
      return;
    }

    setSearchLoading(true);
    setSearchError(null);
    setJobs([]);
    setMaxDisplay(30);

    try {
      const recaptchaToken = await getRecaptchaToken("jobs_search");

      const res = await fetch("/api/jobs", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          query: searchQuery.trim(),
          location: searchLocation.trim(),
          country: searchCountry.trim() || "fr",
          contract_time: contractTime === "any" ? undefined : contractTime,
          contract_type: contractType === "any" ? undefined : contractType,
          remote_only: remoteOnly,
          salary_min: minSalary ? Number(minSalary) || undefined : undefined,
          salary_max: maxSalary ? Number(maxSalary) || undefined : undefined,
          max_days_old: publishedWithin === "any" ? undefined : Number(publishedWithin),
          page: 1,
          results_per_page: 100,
          recaptchaToken,
        }),
      });

      const contentType = res.headers.get("content-type") || "";
      if (!contentType.includes("application/json")) {
        const textErr = await res.text();
        console.error("Réponse non JSON /api/jobs:", textErr);
        throw new Error("Réponse serveur invalide (jobs).");
      }

      const data = await res.json();
      if (!res.ok) throw new Error(data.error || "Erreur lors de la recherche d'offres.");

      const rawList: any[] = data.jobs || data.results || [];

      let list: JobOffer[] = rawList.map((j, index) => {
        const id =
          j.id?.toString() ??
          j.adref?.toString() ??
          `job_${index}_${Math.random().toString(36).slice(2)}`;

        const title = j.title || "";
        const company = (j.company && j.company.display_name) || j.company || "";
        const location = (j.location && j.location.display_name) || j.location || "";
        const url = j.url || j.redirect_url || "";
        const description = j.description || "";
        const created = j.created || "";

        const salary =
          j.salary_min && j.salary_max
            ? `${Math.round(j.salary_min)} - ${Math.round(j.salary_max)} €`
            : j.salary_min
              ? `≥ ${Math.round(j.salary_min)} €`
              : null;

        const matchScore = computeMatchScore(j, profile, searchQuery, searchLocation, remoteOnly);

        return { id, title, company, location, url, description, created, salary, matchScore };
      });

      if (remoteOnly) {
        list = list.filter((job) => {
          const txt = normalize(`${job.title} ${job.description} ${job.location}`);
          return /remote|teletravail|home\s*office|hybride/.test(txt);
        });
      }

      list.sort((a, b) => b.matchScore - a.matchScore);
      setJobs(list);

      if (!list.length) setSearchError("Aucune offre trouvée pour ces critères.");
    } catch (err: any) {
      console.error(err);
      setSearchError(err.message || "Erreur lors de la recherche d'offres, réessaie plus tard.");
    } finally {
      setSearchLoading(false);
    }
  };

  // SUIVI candidature après visite
  const createApplicationFromJob = async (job: LastOpenedJob) => {
    if (!userId || !job) return;
    try {
      const appsRef = collection(db, "applications");
      await addDoc(appsRef, {
        userId,
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp(),
        company: job.company,
        jobTitle: job.title,
        jobLink: job.url,
        location: job.location || "",
        status: "applied",
        source: "Adzuna / Apply",
      });
    } catch (e) {
      console.error("Erreur création suivi candidature depuis Apply:", e);
    }
  };

  const handleAnswerApplied = async (applied: boolean) => {
    if (!pendingApplyJob) {
      clearPendingApplyJob();
      return;
    }
    if (applied) await createApplicationFromJob(pendingApplyJob);
    clearPendingApplyJob();
  };

  // Génération CV / ZIP
  const [cvJobLoadingId, setCvJobLoadingId] = useState<string | null>(null);
  const [cvLmJobLoadingId, setCvLmJobLoadingId] = useState<string | null>(null);

  const [cvLang] = useState<Lang>("fr");
  const [lmLang] = useState<Lang>("fr");

  const generateCvForJob = async (job: JobOffer) => {
    if (!profile) {
      alert("Aucun profil CV IA détecté. Va d'abord dans l'onglet CV IA pour analyser ton CV PDF.");
      return;
    }

    setCvJobLoadingId(job.id);
    try {
      const recaptchaToken = await getRecaptchaToken("generate_cv_pdf");

      const res = await fetch(GENERATE_CV_API, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          profile,
          targetJob: job.title,
          template: "ats",
          lang: cvLang,
          contract: profile.contractType || "",
          jobLink: job.url,
          jobDescription: job.description,
          recaptchaToken,
        }),
      });

      if (!res.ok) {
        const text = await res.text();
        throw new Error(text || "Erreur serveur lors de la génération du CV.");
      }

      const blob = await res.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "cv-ia.pdf";
      document.body.appendChild(a);
      a.click();
      a.remove();
      window.URL.revokeObjectURL(url);
    } catch (e: any) {
      console.error("Erreur génération CV pour offre:", e);
      alert(e?.message || "Impossible de générer le CV pour cette offre.");
    } finally {
      setCvJobLoadingId(null);
    }
  };

  const generateCvLmForJob = async (job: JobOffer) => {
    if (!profile) {
      alert("Aucun profil CV IA détecté. Va d'abord dans l'onglet CV IA pour analyser ton CV PDF.");
      return;
    }

    setCvLmJobLoadingId(job.id);
    try {
      const recaptchaToken = await getRecaptchaToken("generate_cv_lm_zip");

      const res = await fetch(GENERATE_CV_LM_ZIP_API, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          profile,
          targetJob: job.title,
          template: "ats",
          lang: cvLang,
          contract: profile.contractType || "",
          jobLink: job.url,
          jobDescription: job.description,
          lm: {
            companyName: job.company,
            jobTitle: job.title,
            jobDescription: job.description,
            jobLink: job.url,
            lang: lmLang,
          },
          recaptchaToken,
        }),
      });

      if (!res.ok) {
        const text = await res.text();
        throw new Error(text || "Erreur serveur lors de la génération du ZIP CV + LM.");
      }

      const blob = await res.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "cv-lm-ia.zip";
      document.body.appendChild(a);
      a.click();
      a.remove();
      window.URL.revokeObjectURL(url);
    } catch (e: any) {
      console.error("Erreur génération CV+LM pour offre:", e);
      alert(e?.message || "Impossible de générer le CV + LM pour cette offre.");
    } finally {
      setCvLmJobLoadingId(null);
    }
  };

  // RENDER
  if (!userId && !loadingProfile) {
    return (
      <div className="max-w-5xl mx-auto px-4 py-8">
        <div className="glass rounded-2xl p-6 space-y-3">
          <h1 className="text-xl font-semibold">Postuler à des offres</h1>
          <p className="text-sm text-[var(--muted)]">
            Connecte-toi pour rechercher des offres, générer ton CV/LM et suivre tes candidatures.
          </p>
        </div>
      </div>
    );
  }

  const displayedJobs = jobs.slice(0, maxDisplay);

  return (
    <motion.div
      initial={{ opacity: 0, y: 10 }}
      animate={{ opacity: 1, y: 0 }}
      transition={{ duration: 0.2 }}
      className="max-w-5xl mx-auto px-4 py-6 space-y-6"
    >
      {pendingApplyJob && (
        <div className="fixed bottom-4 left-1/2 -translate-x-1/2 z-40 max-w-md w-full px-3">
          <div className="rounded-2xl bg-[var(--bg)] border border-[var(--border)] shadow-lg px-4 py-3 text-xs flex flex-col gap-2">
            <p className="text-[var(--muted)]">
              Tu viens de consulter{" "}
              <span className="font-semibold text-[var(--ink)]">{pendingApplyJob.title}</span> chez{" "}
              <span className="font-semibold text-[var(--ink)]">{pendingApplyJob.company}</span>. As-tu postulé ?
            </p>
            <div className="flex justify-end gap-2">
              <button
                className="px-3 py-1 rounded-full text-[11px] bg-white/5 hover:bg-white/10"
                onClick={() => handleAnswerApplied(false)}
              >
                Non
              </button>
              <button
                className="px-3 py-1 rounded-full text-[11px] bg-emerald-500/80 hover:bg-emerald-500 text-black font-medium"
                onClick={() => handleAnswerApplied(true)}
              >
                Oui, ajouter au suivi
              </button>
            </div>
          </div>
        </div>
      )}

      <header className="glass rounded-2xl p-5 space-y-3">
        <div className="flex flex-wrap items-center justify-between gap-2">
          <div>
            <h1 className="text-2xl font-semibold">Recherche & candidatures</h1>
            <p className="text-sm text-[var(--muted)] max-w-xl">
              1) Cherche des offres, 2) génère CV + LM en 1 clic, 3) postule et mets à jour ton suivi.
            </p>
          </div>
          <div className="text-[11px] rounded-full border border-[var(--border)] px-3 py-1 bg-[var(--bg-soft)]">
            Profil CV IA :{" "}
            <span className="font-medium">
              {loadingProfile ? "Chargement…" : profile ? profileName : "Non détecté"}
            </span>
          </div>
        </div>
      </header>

      <section className="glass rounded-2xl p-5 space-y-4">
        <div className="flex items-center justify-between gap-2">
          <h2 className="text-lg font-semibold">1. Rechercher des offres (Adzuna)</h2>
          <span className="text-[11px] text-[var(--muted)]">
            API via <code>/api/jobs</code>
          </span>
        </div>

        <form onSubmit={handleSearchJobs} className="grid md:grid-cols-4 gap-3 text-sm">
          <div className="md:col-span-2 relative">
            <label className="block text-[11px] font-medium text-[var(--muted)] mb-1">
              Métier / secteur
            </label>
            <input
              className="input w-full"
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value)}
              placeholder="Ex : kiné, développeur web, data…"
            />
            {jobAutocomplete.length > 0 && (
              <div className="absolute z-20 mt-1 w-full rounded-md border border-[var(--border)] bg-[var(--bg)] text-[11px] max-h-40 overflow-auto">
                {jobAutocomplete.map((s) => (
                  <button
                    key={s}
                    type="button"
                    className="w-full text-left px-2 py-1 hover:bg-white/5"
                    onClick={() => setSearchQuery(s)}
                  >
                    {s}
                  </button>
                ))}
              </div>
            )}
          </div>

          <div className="relative">
            <label className="block text-[11px] font-medium text-[var(--muted)] mb-1">
              Ville / zone
            </label>
            <input
              className="input w-full"
              value={searchLocation}
              onChange={(e) => setSearchLocation(e.target.value)}
              placeholder="Ex : Paris, Lyon, remote…"
            />
            {cityAutocomplete.length > 0 && (
              <div className="absolute z-20 mt-1 w-full rounded-md border border-[var(--border)] bg-[var(--bg)] text-[11px] max-h-40 overflow-auto">
                {cityAutocomplete.map((s) => (
                  <button
                    key={s}
                    type="button"
                    className="w-full text-left px-2 py-1 hover:bg-white/5"
                    onClick={() => setSearchLocation(s)}
                  >
                    {s}
                  </button>
                ))}
              </div>
            )}
          </div>

          <div>
            <label className="block text-[11px] font-medium text-[var(--muted)] mb-1">
              Pays
            </label>
            <select className="input w-full" value={searchCountry} onChange={(e) => setSearchCountry(e.target.value)}>
              {COUNTRY_CODES.map((c) => (
                <option key={c.code} value={c.code}>
                  {c.label} ({c.code})
                </option>
              ))}
            </select>
          </div>

          <div>
            <label className="block text-[11px] font-medium text-[var(--muted)] mb-1">
              Temps de travail
            </label>
            <select
              className="input w-full"
              value={contractTime}
              onChange={(e) => setContractTime(e.target.value as any)}
            >
              <option value="any">Indifférent</option>
              <option value="full_time">Temps plein</option>
              <option value="part_time">Temps partiel</option>
            </select>
          </div>

          <div>
            <label className="block text-[11px] font-medium text-[var(--muted)] mb-1">
              Type de contrat
            </label>
            <select
              className="input w-full"
              value={contractType}
              onChange={(e) => setContractType(e.target.value as any)}
            >
              <option value="any">Indifférent</option>
              <option value="permanent">CDI / permanent</option>
              <option value="contract">CDD / contract</option>
            </select>
          </div>

          <div>
            <label className="block text-[11px] font-medium text-[var(--muted)] mb-1">
              Salaire min (€/an)
            </label>
            <input className="input w-full" value={minSalary} onChange={(e) => setMinSalary(e.target.value)} placeholder="Ex : 30000" />
          </div>
          <div>
            <label className="block text-[11px] font-medium text-[var(--muted)] mb-1">
              Salaire max (€/an)
            </label>
            <input className="input w-full" value={maxSalary} onChange={(e) => setMaxSalary(e.target.value)} placeholder="Ex : 50000" />
          </div>

          <div>
            <label className="block text-[11px] font-medium text-[var(--muted)] mb-1">
              Offres publiées depuis
            </label>
            <select className="input w-full" value={publishedWithin} onChange={(e) => setPublishedWithin(e.target.value as any)}>
              <option value="any">Peu importe</option>
              <option value="1">24 heures</option>
              <option value="3">3 jours</option>
              <option value="7">7 jours</option>
              <option value="30">30 jours</option>
            </select>
          </div>

          <div className="flex flex-col justify-between gap-2">
            <label className="flex items-center gap-2 text-[11px] text-[var(--muted)] mt-1">
              <input
                type="checkbox"
                className="h-3.5 w-3.5"
                checked={remoteOnly}
                onChange={(e) => setRemoteOnly(e.target.checked)}
              />
              <span>Télétravail / remote uniquement</span>
            </label>

            <label className="block text-[11px] font-medium text-[var(--muted)]">Nb max à afficher</label>
            <select className="input w-full text-[11px]" value={maxDisplay} onChange={(e) => setMaxDisplay(Number(e.target.value))}>
              <option value={20}>20</option>
              <option value={30}>30</option>
              <option value={50}>50</option>
              <option value={100}>100</option>
            </select>
          </div>

          <div className="flex items-end md:justify-end md:col-span-2">
            <button type="submit" className="btn-primary w-full md:w-auto" disabled={searchLoading}>
              {searchLoading ? "Recherche en cours..." : "Chercher des offres"}
            </button>
          </div>
        </form>

        <div className="space-y-1 text-[11px] text-[var(--muted)] mt-1">
          <p>
            💡 Résultats triés par <strong>score de match</strong> avec ton profil.
          </p>
          {searchError && <p className="text-red-400 text-[11px]">{searchError}</p>}
          {!!jobs.length && (
            <p>
              {jobs.length} offre(s) trouvée(s) – {displayedJobs.length} affichée(s).
            </p>
          )}
        </div>

        <div className="mt-3 space-y-3 max-h-[420px] overflow-auto custom-scrollbar">
          {displayedJobs.map((job, index) => {
            const visited = visitedJobIds.includes(job.id);
            const createdDate = job.created ? new Date(job.created) : null;
            const rank = index + 1;

            return (
              <article
                key={job.id}
                className={`rounded-xl border p-3 text-sm transition-colors ${
                  visited
                    ? "border-[var(--border)] bg-white/5"
                    : "border-[var(--border-soft)] bg-black/20 hover:border-emerald-400/70"
                }`}
              >
                <div className="flex items-start justify-between gap-3">
                  <div>
                    <div className="flex items-center gap-2 flex-wrap">
                      <h3 className="font-semibold text-[13px]">{job.title}</h3>
                      <span className={`text-[10px] px-2 py-[2px] rounded-full border ${scoreBadgeClass(job.matchScore)}`}>
                        Match : <span className="font-semibold">{job.matchScore}%</span>
                      </span>
                      {rank <= 3 && (
                        <span className="text-[10px] px-2 py-[2px] rounded-full bg-emerald-500/10 text-emerald-300 border border-emerald-500/40">
                          Top {rank}
                        </span>
                      )}
                      {visited && (
                        <span className="text-[10px] px-2 py-[2px] rounded-full bg-white/10 text-[var(--muted)] border border-[var(--border)]/60">
                          Déjà consultée
                        </span>
                      )}
                    </div>
                    <p className="text-[11px] text-[var(--muted)]">
                      {job.company} • {job.location}
                    </p>
                    {job.salary && <p className="text-[11px] text-emerald-200 mt-1">Salaire estimé : {job.salary}</p>}
                  </div>

                  <div className="flex flex-col items-end gap-2">
                    {createdDate && (
                      <span className="text-[10px] text-[var(--muted)]">
                        Publié le {createdDate.toLocaleDateString("fr-FR")}
                      </span>
                    )}

                    <div className="flex flex-wrap justify-end gap-1.5">
                      {job.url && (
                        <button
                          type="button"
                          className="text-[11px] px-2 py-1 rounded-full bg-white/10 hover:bg-white/20"
                          onClick={() => {
                            markJobVisited(job);
                            window.open(job.url, "_blank", "noopener,noreferrer");
                          }}
                        >
                          Ouvrir l&apos;offre ↗
                        </button>
                      )}

                      <button
                        type="button"
                        className="text-[11px] px-2 py-1 rounded-full bg-[var(--bg)] border border-[var(--border)] hover:border-emerald-400/70"
                        onClick={() => generateCvForJob(job)}
                        disabled={cvJobLoadingId === job.id}
                      >
                        {cvJobLoadingId === job.id ? "CV..." : "CV 1 page"}
                      </button>

                      <button
                        type="button"
                        className="text-[11px] px-2 py-1 rounded-full bg-[var(--bg)] border border-[var(--border)] hover:border-emerald-400/70"
                        onClick={() => generateCvLmForJob(job)}
                        disabled={cvLmJobLoadingId === job.id}
                      >
                        {cvLmJobLoadingId === job.id ? "CV + LM..." : "CV + LM (ZIP)"}
                      </button>
                    </div>
                  </div>
                </div>

                {job.description && (
                  <p className="text-[11px] text-[var(--muted)] mt-2 line-clamp-3">
                    {job.description.replace(/<[^>]+>/g, "")}
                  </p>
                )}
              </article>
            );
          })}

          {!searchLoading && !jobs.length && !searchError && (
            <p className="text-xs text-[var(--muted)]">
              Aucun résultat pour l&apos;instant. Lance une recherche.
            </p>
          )}
        </div>

        {jobs.length > displayedJobs.length && (
          <div className="pt-2 flex justify-center">
            <button
              type="button"
              className="text-[11px] px-3 py-1.5 rounded-full bg-white/5 hover:bg-white/10 border border-[var(--border)]"
              onClick={() => setMaxDisplay((m) => Math.min(m + 30, jobs.length))}
            >
              Afficher +30 offres (actuellement {displayedJobs.length}/{jobs.length})
            </button>
          </div>
        )}
      </section>
    </motion.div>
  );
}
````

## File: app/app/credits/page.tsx
````typescript
"use client";

import { useEffect, useRef, useState } from "react";
import { useUserCredits } from "@/hooks/useUserCredits";
import { useAuth } from "@/context/AuthContext";
import { getRecaptchaToken } from "@/lib/recaptcha";

type PackKey = "20" | "50" | "100";

const CREDIT_PACKS: {
  key: PackKey;
  label: string;
  credits: number;
  desc: string;
}[] = [
  {
    key: "20",
    credits: 20,
    label: "Pack Découverte",
    desc: "Idéal pour tester les fonctionnalités IA.",
  },
  {
    key: "50",
    credits: 50,
    label: "Pack Boost",
    desc: "Parfait pour une phase active de recherche.",
  },
  {
    key: "100",
    credits: 100,
    label: "Pack Intensif",
    desc: "Pour candidatures + entretiens à fond.",
  },
];

// ⚙️ Base de l'API :
// - en prod : Cloud Functions
// - en dev : tu peux override avec NEXT_PUBLIC_API_BASE_URL dans .env.local
const DEFAULT_API_BASE =
  "https://europe-west1-assistant-ia-v4.cloudfunctions.net";

const API_BASE =
  (process.env.NEXT_PUBLIC_API_BASE_URL || DEFAULT_API_BASE).replace(/\/+$/, "");

export default function CreditsPage() {
  const { user } = useAuth();
  const { credits, loading, error } = useUserCredits();

  const [buyLoading, setBuyLoading] = useState<PackKey | null>(null);
  const [buyError, setBuyError] = useState<string | null>(null);

  // 👉 URL d’embed du checkout Polar (quand non null, on affiche la popup)
  const [embedUrl, setEmbedUrl] = useState<string | null>(null);
  const iframeRef = useRef<HTMLIFrameElement | null>(null);

  // 🎉 Animation / bandeau succès dans la page
  const [showSuccessAnimation, setShowSuccessAnimation] = useState(false);

  // Pour info, si un jour tu veux savoir quel pack a été démarré
  const [lastPack, setLastPack] = useState<PackKey | null>(null);

  // Message global en haut de page (success / cancel)
  const [statusMessage, setStatusMessage] = useState<string | null>(null);

  // ✅ IMPORTANT (Option B) :
  // on mémorise le solde AVANT l’achat, puis on ferme automatiquement la popup
  // dès que credits > soldeAvant (webhook OK -> Firestore se met à jour)
  const [creditsBeforePurchase, setCreditsBeforePurchase] = useState<number | null>(
    null
  );

  const triggerSuccessClose = (message?: string) => {
    setEmbedUrl(null);
    setBuyLoading(null);
    setLastPack(null);
    setCreditsBeforePurchase(null);

    setShowSuccessAnimation(true);
    window.setTimeout(() => setShowSuccessAnimation(false), 4000);

    setStatusMessage(
      message ||
        "✅ Paiement confirmé ! Tes crédits ont été ajoutés à ton compte."
    );
  };

  const handleBuy = async (pack: PackKey) => {
    try {
      setBuyError(null);
      setStatusMessage(null);

      if (!user?.uid || !user.email) {
        setBuyError("Tu dois être connecté pour recharger tes crédits.");
        return;
      }

      setBuyLoading(pack);
      setLastPack(pack);

      // On capture le solde actuel pour détecter l’augmentation après webhook
      if (typeof credits === "number") {
        setCreditsBeforePurchase(credits);
      } else {
        setCreditsBeforePurchase(0);
      }

      // 👉 Appel à ta Cloud Function HTTPS : /polarCheckout
      const endpoint = `${API_BASE}/polarCheckout`;

      // ✅ reCAPTCHA token
      let recaptchaToken = "";
      try {
        recaptchaToken = await getRecaptchaToken("polar_checkout");
      } catch {
        setBuyError(
          "Sécurité: impossible de valider reCAPTCHA (script bloqué ?). Désactive l'adblock et réessaie."
        );
        setBuyLoading(null);
        setCreditsBeforePurchase(null);
        return;
      }

      const res = await fetch(endpoint, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          packId: pack, // "20" | "50" | "100"
          userId: user.uid, // pour externalCustomerId
          email: user.email, // pour customerEmail
          recaptchaToken, // ✅ ajouté
        }),
      });

      const contentType = res.headers.get("content-type") || "";
      let data: any = null;

      if (contentType.includes("application/json")) {
        data = await res.json();
      } else {
        const text = await res.text();
        console.error(
          "[Credits] Réponse non JSON de /polarCheckout :",
          text.slice(0, 300)
        );
        throw new Error(
          "Le serveur de paiement a renvoyé une réponse invalide (HTML). Vérifie la fonction polarCheckout."
        );
      }

      if (!res.ok || !data?.url) {
        console.error("Erreur API /polarCheckout :", data);
        throw new Error(data?.error || "Impossible de créer le paiement Polar.");
      }

      // 👉 On ajoute les params d’embed : embed=true & embed_origin=...
      const origin = window.location.origin;
      const urlBase = data.url as string;
      const sep = urlBase.includes("?") ? "&" : "?";
      const fullEmbedUrl = `${urlBase}${sep}embed=true&embed_origin=${encodeURIComponent(
        origin
      )}`;

      setEmbedUrl(fullEmbedUrl); // ouvre la popup
    } catch (e: any) {
      console.error("Erreur checkout Polar (iframe) :", e);
      setBuyError(
        e?.message ||
          "Erreur lors de la création du paiement. Essaie à nouveau dans quelques instants."
      );
      setBuyLoading(null);
      setCreditsBeforePurchase(null);
    }
  };

  // 🔐 (Option A / bonus) : si un jour Polar redirige l’iframe vers ton domaine,
  // on peut fermer via status=success. Mais actuellement l’iframe reste chez Polar,
  // donc ça ne marche pas (cross-origin).
  const handleIframeLoad = () => {
    const iframe = iframeRef.current;
    if (!iframe) return;

    try {
      const win = iframe.contentWindow;
      if (!win) return;

      const href = win.location.href; // accessible seulement si même origine

      if (href.includes("/app/credits") && href.includes("status=success")) {
        triggerSuccessClose(
          "✅ Paiement confirmé ! Tes crédits vont se mettre à jour dans quelques instants."
        );
      }

      if (href.includes("/app/credits") && href.includes("status=cancel")) {
        setEmbedUrl(null);
        setBuyLoading(null);
        setLastPack(null);
        setCreditsBeforePurchase(null);
        setStatusMessage("Paiement annulé.");
      }
    } catch {
      // cross-origin -> normal
    }
  };

  // ✅ LA FERMETURE AUTO (Option B) :
  // Dès que les crédits augmentent après l’achat, on ferme la popup.
  useEffect(() => {
    if (!embedUrl) return;
    if (creditsBeforePurchase === null) return;
    if (loading) return;
    if (typeof credits !== "number") return;

    if (credits > creditsBeforePurchase) {
      triggerSuccessClose("✅ Paiement confirmé ! Tes crédits ont été ajoutés.");
    }
  }, [credits, loading, embedUrl, creditsBeforePurchase]);

  const closeModal = () => {
    setEmbedUrl(null);
    setBuyLoading(null);
    setLastPack(null);
    setCreditsBeforePurchase(null);
  };

  // Si on arrive sur /app/credits?status=success dans la page normale (sans iframe)
  useEffect(() => {
    if (typeof window === "undefined") return;
    const url = new URL(window.location.href);
    const status = url.searchParams.get("status");

    if (status === "success") {
      setStatusMessage("✅ Paiement confirmé ! Tes crédits ont été pris en compte.");
      setShowSuccessAnimation(true);
      setTimeout(() => setShowSuccessAnimation(false), 4000);
    } else if (status === "cancel") {
      setStatusMessage("Paiement annulé.");
    }
  }, []);

  return (
    <div className="space-y-6">
      {/* Animation succès flottante */}
      {showSuccessAnimation && (
        <div className="fixed top-4 left-1/2 z-40 -translate-x-1/2">
          <div className="rounded-full border border-emerald-400/70 bg-emerald-500/10 px-4 py-2 shadow-lg backdrop-blur flex items-center gap-2 animate-[fadeInOut_4s_ease-in-out]">
            <span className="text-lg">⚡</span>
            <span className="text-[13px] text-emerald-200">
              Crédits ajoutés à ton compte !
            </span>
          </div>
        </div>
      )}

      {/* Titre + résumé */}
      <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
        <div>
          <h1 className="text-lg sm:text-xl font-semibold text-[var(--ink)]">
            Crédits IA
          </h1>
          <p className="text-[12px] text-[var(--muted)]">
            Utilise tes crédits pour analyser ton CV, générer des lettres de motivation,
            des pitchs, et préparer tes entretiens.
          </p>
        </div>

        {/* Petit récap du solde */}
        <div className="inline-flex flex-col items-end gap-1">
          <span className="text-[11px] text-[var(--muted)]">Solde actuel</span>
          <div className="inline-flex items-center gap-2 rounded-full px-3 py-1.5 text-[12px] bg-[var(--bg-soft)] border border-[var(--border)]/80">
            <span className="text-[15px]">⚡</span>
            {loading ? (
              <span className="text-[var(--muted)]">Chargement…</span>
            ) : (
              <span className="font-semibold text-[var(--ink)]">{credits} crédits</span>
            )}
          </div>
        </div>
      </div>

      {statusMessage && <p className="text-[12px] text-emerald-400">{statusMessage}</p>}
      {error && <p className="text-[12px] text-red-400">{error}</p>}

      {/* Packs de rechargement */}
      <section className="glass border border-[var(--border)]/80 rounded-2xl p-4 sm:p-5 space-y-4">
        <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
          <div>
            <h2 className="text-base font-semibold text-[var(--ink)]">
              Recharger mes crédits
            </h2>
            <p className="text-[12px] text-[var(--muted)]">
              Choisis un pack ci-dessous pour ajouter des crédits à ton compte.
              Paiement sécurisé via Polar.
            </p>
          </div>

          <button
            type="button"
            onClick={() => {
              const el = document.getElementById("credit-packs");
              if (el) el.scrollIntoView({ behavior: "smooth", block: "start" });
            }}
            className="btn-primary text-[12px] px-3 py-1.5"
          >
            Ajouter du crédit
          </button>
        </div>

        <div
          id="credit-packs"
          className="grid grid-cols-1 sm:grid-cols-3 gap-3 sm:gap-4 mt-2"
        >
          {CREDIT_PACKS.map((pack) => (
            <div
              key={pack.key}
              className="card-soft border border-[var(--border)]/80 rounded-2xl p-3 sm:p-4 flex flex-col justify-between"
            >
              <div className="space-y-1">
                <div className="flex items-center justify-between gap-2">
                  <h3 className="text-[13px] font-semibold text-[var(--ink)]">
                    {pack.label}
                  </h3>
                  <span className="inline-flex items-center rounded-full px-2 py-[2px] text-[11px] bg-[var(--bg)] border border-[var(--border)]/80">
                    ⚡ {pack.credits} crédits
                  </span>
                </div>
                <p className="text-[12px] text-[var(--muted)]">{pack.desc}</p>
              </div>

              <div className="mt-3 flex flex-col gap-1">
                <button
                  type="button"
                  onClick={() => handleBuy(pack.key)}
                  disabled={buyLoading === pack.key}
                  className="btn-primary w-full text-[12px] flex items-center justify-center gap-2 disabled:opacity-60 disabled:cursor-not-allowed"
                >
                  {buyLoading === pack.key ? (
                    <>
                      <span className="loader" />
                      <span>Ouverture du paiement…</span>
                    </>
                  ) : (
                    <>
                      <span>Recharger</span>
                      <span className="text-[13px]">→</span>
                    </>
                  )}
                </button>
                <span className="text-[10px] text-[var(--muted)] text-center">
                  Paiement unique, pas d’abonnement.
                </span>
              </div>
            </div>
          ))}
        </div>

        {buyError && <p className="text-[12px] text-red-400">{buyError}</p>}
      </section>

      {/* Explication d’usage */}
      <section className="text-[11px] text-[var(--muted)] space-y-1">
        <p>
          1 crédit ≈ 1 action IA (analyse CV, génération de lettre, pitch, Q&A entretien…).
        </p>
        <p>
          Ton solde est mis à jour automatiquement après chaque achat dès que le paiement est confirmé
          (via le webhook Polar).
        </p>
      </section>

      {/* 🔥 POPUP CHECKOUT POLAR EN IFRAME */}
      {embedUrl && (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm">
          <div className="relative w-full max-w-lg h-[520px] sm:h-[580px] bg-[var(--bg)] border border-[var(--border)]/80 rounded-2xl shadow-2xl flex flex-col overflow-hidden">
            <div className="flex items-center justify-between px-4 py-2 border-b border-[var(--border)]/70 bg-[var(--bg-soft)]/80">
              <div className="flex flex-col">
                <span className="text-[12px] font-semibold text-[var(--ink)]">
                  Paiement sécurisé
                </span>
                <span className="text-[11px] text-[var(--muted)]">
                  Transaction gérée par Polar (Stripe)
                </span>
              </div>
              <button
                type="button"
                onClick={closeModal}
                className="text-[11px] rounded-full border border-[var(--border)] px-2 py-1 hover:bg-[var(--bg)]"
              >
                ✕
              </button>
            </div>

            <iframe
              ref={iframeRef}
              src={embedUrl}
              onLoad={handleIframeLoad}
              className="flex-1 w-full border-0"
              title="Paiement Polar"
              allow="payment *; publickey-credentials-get *"
            />
          </div>
        </div>
      )}
    </div>
  );
}
````

## File: app/app/cv/page.tsx
````typescript
"use client";

export default function CvPage() {
  return (
    <div className="max-w-4xl mx-auto glass p-4">
      <h1 className="text-lg font-semibold mb-2">Section cv</h1>
      <p className="text-sm text-[var(--muted)]">CV IA — upload de ton PDF et extraction du profil par Gemini.</p>
    </div>
  );
}
````

## File: app/app/history/page.tsx
````typescript
"use client";

export default function HistoryPage() {
  return (
    <div className="max-w-4xl mx-auto glass p-4">
      <h1 className="text-lg font-semibold mb-2">Section history</h1>
      <p className="text-sm text-[var(--muted)]">Historique de toutes tes générations IA.</p>
    </div>
  );
}
````

## File: app/app/interview/page.tsx
````typescript
// app/app/interview/page.tsx
"use client";

import { useEffect, useState } from "react";
import { useAuth } from "@/context/AuthContext";
import { db } from "@/lib/firebase";
import { doc, getDoc } from "firebase/firestore";
import {
  callGenerateInterviewQA,
  type GenerateInterviewQAResult,
} from "@/lib/gemini";
import InterviewChat from "@/components/InterviewChat";

type ExperienceLike = {
  company?: string;
  role?: string;
  title?: string;
  city?: string;
  location?: string;
  dates?: string;
  bullets?: string[];
};

type ProfileLike = {
  fullName?: string;
  profileHeadline?: string;
  title?: string;
  city?: string;
  experiences?: ExperienceLike[] | any;
  experience?: ExperienceLike[] | any;
  [key: string]: any;
};

type QaPair = {
  question: string;
  answer: string;
};

export default function InterviewPage() {
  const { user } = useAuth();

  const [profile, setProfile] = useState<ProfileLike | null>(null);
  const [loadingProfile, setLoadingProfile] = useState(true);
  const [loadError, setLoadError] = useState<string | null>(
    null
  );

  const [qaLang, setQaLang] = useState<"fr" | "en">("fr");
  const [selectedExpIndex, setSelectedExpIndex] =
    useState<string>("");
  const [qaLoading, setQaLoading] = useState(false);
  const [qaError, setQaError] = useState<string | null>(null);
  const [qaPairs, setQaPairs] = useState<QaPair[]>([]);

  const [copiedIndex, setCopiedIndex] = useState<number | null>(
    null
  );

  // Chargement profil CV
  useEffect(() => {
    const fetchProfile = async () => {
      if (!user) {
        setProfile(null);
        setLoadingProfile(false);
        return;
      }
      try {
        const ref = doc(db, "profiles", user.uid);
        const snap = await getDoc(ref);
        if (snap.exists()) {
          setProfile(snap.data() as ProfileLike);
        } else {
          setProfile(null);
        }
      } catch (e) {
        console.error(e);
        setLoadError("Impossible de charger ton profil CV.");
      } finally {
        setLoadingProfile(false);
      }
    };

    fetchProfile();
  }, [user]);

  // Récupération robuste des expériences
  const experiences: ExperienceLike[] = (() => {
    if (!profile) return [];
    const possible =
      (profile.experiences as any) ??
      (profile.experience as any) ??
      [];
    if (Array.isArray(possible))
      return possible as ExperienceLike[];
    return [];
  })();

  // Reset quand on change de langue ou d'expérience
  useEffect(() => {
    setQaPairs([]);
    setQaError(null);
    setCopiedIndex(null);
  }, [selectedExpIndex, qaLang]);

  const handleGenerateQA = async () => {
    if (!profile) {
      setQaError(
        "Charge d'abord ton CV dans l’onglet Profil."
      );
      return;
    }
    if (!selectedExpIndex) {
      setQaError("Sélectionne d'abord une expérience.");
      return;
    }

    const index = parseInt(selectedExpIndex, 10);
    if (Number.isNaN(index) || !experiences[index]) {
      setQaError("Expérience invalide.");
      return;
    }

    setQaError(null);
    setQaLoading(true);

    try {
      let result: GenerateInterviewQAResult;

      try {
        result = await callGenerateInterviewQA({
          profile,
          experienceIndex: index,
          lang: qaLang,
        });
      } catch (err: any) {
        console.error(
          "Erreur callGenerateInterviewQA:",
          err
        );
        setQaPairs([]);
        setQaError(
          err?.message ||
            "Erreur pendant la génération des questions (appel serveur)."
        );
        return;
      }

      const rawQuestions: any[] = Array.isArray(
        result.questions
      )
        ? result.questions
        : [];

      if (!rawQuestions.length) {
        console.error(
          "Réponse generateInterviewQA inattendue:",
          result
        );
        setQaPairs([]);
        setQaError(
          "L'IA n'a pas renvoyé de questions exploitables. Vérifie que l'expérience contient bien des missions/bullets, ou réessaie plus tard."
        );
        return;
      }

      const mapped: QaPair[] = rawQuestions.map(
        (q: any, idx: number) => ({
          question:
            (q?.question ??
              q?.q ??
              `Question ${idx + 1}`) + "",
          answer: (q?.answer ?? q?.a ?? "") + "",
        })
      );

      setQaPairs(mapped);
      setCopiedIndex(null);
    } catch (err: any) {
      console.error("handleGenerateQA error:", err);
      setQaError(
        err?.message ||
          "Erreur inattendue pendant la génération des questions."
      );
      setQaPairs([]);
    } finally {
      setQaLoading(false);
    }
  };

  const handleCopyOne = async (idx: number) => {
    const qa = qaPairs[idx];
    if (!qa) return;

    const text = `Q: ${qa.question}\n\nR: ${qa.answer}`;
    try {
      if (navigator.clipboard?.writeText) {
        await navigator.clipboard.writeText(text);
      } else {
        const textarea = document.createElement("textarea");
        textarea.value = text;
        textarea.style.position = "fixed";
        textarea.style.opacity = "0";
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand("copy");
        document.body.removeChild(textarea);
      }
      setCopiedIndex(idx);
      setTimeout(() => setCopiedIndex(null), 1500);
    } catch (e) {
      console.error(e);
      alert("Impossible de copier automatiquement le texte.");
    }
  };

  const handleCopyAll = async () => {
    if (!qaPairs.length) return;
    const text = qaPairs
      .map(
        (qa, i) =>
          `Q${i + 1}. ${qa.question}\nR${i + 1}. ${
            qa.answer
          }\n`
      )
      .join("\n");

    try {
      if (navigator.clipboard?.writeText) {
        await navigator.clipboard.writeText(text);
      } else {
        const textarea = document.createElement("textarea");
        textarea.value = text;
        textarea.style.position = "fixed";
        textarea.style.opacity = "0";
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand("copy");
        document.body.removeChild(textarea);
      }
      setCopiedIndex(-1);
      setTimeout(() => setCopiedIndex(null), 1500);
    } catch (e) {
      console.error(e);
      alert("Impossible de copier automatiquement le texte.");
    }
  };

  // ÉTATS GLOBALS PAGE
  if (loadingProfile) {
    return (
      <div className="max-w-5xl mx-auto glass p-6 rounded-2xl">
        <p className="text-sm text-[var(--muted)]">
          Chargement de ton profil CV...
        </p>
      </div>
    );
  }

  if (!profile) {
    return (
      <div className="max-w-5xl mx-auto glass p-6 rounded-2xl space-y-3">
        {loadError && (
          <p className="text-sm text-[var(--danger)]">
            {loadError}
          </p>
        )}
        <h1 className="text-xl font-semibold">
          Commence par analyser ton CV 📄
        </h1>
        <p className="text-sm text-[var(--muted)]">
          Va dans l&apos;onglet{" "}
          <span className="font-semibold">Profil CV</span> pour
          uploader ton CV. L&apos;IA utilisera ensuite ces
          informations pour générer des questions / réponses et
          simuler des entretiens.
        </p>
      </div>
    );
  }

  // PAGE PRINCIPALE
  return (
    <div className="max-w-5xl mx-auto space-y-6">
      {/* Header général */}
      <header className="glass rounded-2xl p-5 space-y-3">
        <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
          <div>
            <h1 className="text-2xl font-semibold mb-1">
              Préparer ton entretien 🎤
            </h1>
            <p className="text-sm text-[var(--muted)]">
              Utilise l&apos;IA pour générer des questions /
              réponses à partir de ton CV, puis entraîne-toi en
              conditions réelles avec un simulateur d&apos;entretien
              (texte + voix).
            </p>
          </div>
          <div className="text-right text-xs text-[var(--muted)]">
            <p className="font-semibold">
              {profile.fullName || "Profil"}
            </p>
            <p>
              {profile.profileHeadline ||
                profile.title ||
                "Candidat"}
            </p>
            {profile.city && <p>{profile.city}</p>}
          </div>
        </div>
      </header>

      {/* Bloc 1 : Génération Q/R à partir d'une expérience */}
      <section className="glass rounded-2xl p-5 space-y-4">
        <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
          <div>
            <h2 className="text-lg font-semibold">
              Questions / Réponses sur une expérience
            </h2>
            <p className="text-xs text-[var(--muted)]">
              Choisis une expérience de ton CV. L&apos;assistant
              générera des questions ciblées (missions, résultats,
              compétences) avec des exemples de réponses.
            </p>
          </div>
          <div className="flex items-center gap-2">
            <span className="text-xs text-[var(--muted)]">
              Langue
            </span>
            <select
              value={qaLang}
              onChange={(e) =>
                setQaLang(
                  e.target.value === "en" ? "en" : "fr"
                )
              }
              className="select-brand text-xs"
            >
              <option value="fr">Français</option>
              <option value="en">English</option>
            </select>
          </div>
        </div>

        {experiences.length === 0 && (
          <p className="text-xs text-[var(--danger)]">
            Ton profil ne contient aucune expérience. Vérifie que
            l&apos;analyse de ton CV a bien détecté tes postes
            (section &quot;experiences&quot; dans le document
            Firestore{" "}
            <code>profiles/{user?.uid}</code>).
          </p>
        )}

        <div>
          <label className="block text-xs font-medium text-[var(--muted)] mb-1">
            Expérience
          </label>
          <select
            className="select-brand w-full text-sm"
            value={selectedExpIndex}
            onChange={(e) =>
              setSelectedExpIndex(e.target.value)
            }
          >
            <option value="">
              -- Sélectionne une expérience --
            </option>
            {experiences.map((exp, idx) => {
              const role =
                exp.role || exp.title || "Poste";
              const company =
                exp.company || "Entreprise";
              const dates = exp.dates || "";
              const city =
                exp.city || exp.location || "";
              return (
                <option
                  key={idx}
                  value={idx.toString()}
                >
                  {role} — {company}{" "}
                  {dates && `(${dates})`}{" "}
                  {city && `· ${city}`}
                </option>
              );
            })}
          </select>
        </div>

        {qaError && (
          <p className="text-xs text-[var(--danger)] whitespace-pre-line">
            {qaError}
          </p>
        )}

        <div className="flex justify-center">
          <button
            type="button"
            className="btn-primary min-w-[200px]"
            onClick={handleGenerateQA}
            disabled={qaLoading || !experiences.length}
          >
            {qaLoading
              ? qaLang === "en"
                ? "Generating..."
                : "Génération en cours..."
              : "Générer les questions ✨"}
          </button>
        </div>

        {/* Liste Q&A */}
        <div className="mt-2 p-4 card-soft rounded-xl max-h-[420px] overflow-auto text-sm">
          <div className="flex items-center justify-between gap-3 mb-2">
            <h3 className="text-sm font-semibold">
              Questions d&apos;entretien générées
            </h3>
            <button
              type="button"
              className="btn-secondary text-[11px] px-3 py-1"
              onClick={handleCopyAll}
              disabled={!qaPairs.length}
            >
              {copiedIndex === -1
                ? "Tout copié ✔"
                : "Copier tout"}
            </button>
          </div>

          {qaLoading ? (
            <p className="text-center text-[var(--muted)]">
              {qaLang === "en"
                ? "Generating interview questions..."
                : "Génération des questions en cours..."}
            </p>
          ) : !qaPairs.length ? (
            <p className="text-center text-[var(--muted)]">
              Les questions apparaîtront ici après la
              génération. Utilise-les pour t&apos;entraîner à
              répondre à l&apos;oral (méthode STAR, résultats
              concrets, etc.).
            </p>
          ) : (
            <div className="space-y-4">
              {qaPairs.map((qa, idx) => (
                <div
                  key={idx}
                  className="border border-[var(--border-soft)] rounded-xl p-3 bg-black/20"
                >
                  <div className="flex items-center justify-between gap-2 mb-2">
                    <p className="font-semibold text-sm">
                      Q{idx + 1}. {qa.question}
                    </p>
                    <button
                      type="button"
                      className="btn-secondary text-[10px] px-2 py-1"
                      onClick={() =>
                        handleCopyOne(idx)
                      }
                    >
                      {copiedIndex === idx
                        ? "Copié ✔"
                        : "Copier Q/R"}
                    </button>
                  </div>
                  <p className="text-xs text-[var(--muted)] whitespace-pre-line">
                    {qa.answer}
                  </p>
                </div>
              ))}
            </div>
          )}
        </div>
      </section>

      {/* Bloc 2 : Simulateur d'entretien IA (texte + voix) */}
      {/* ⚠️ InterviewChat contient déjà tout le layout (header, glass, etc.) */}
      <InterviewChat />
    </div>
  );
}
````

## File: app/app/lm/page.tsx
````typescript
"use client";

import { logUsage } from "@/lib/logUsage";
import { useEffect, useState, FormEvent } from "react";
import { motion } from "framer-motion";
import { auth, db } from "@/lib/firebase";
import { onAuthStateChanged } from "firebase/auth";
import {
  doc,
  getDoc,
  collection,
  addDoc,
  serverTimestamp,
} from "firebase/firestore";

// --- TYPES ---

type CvSkillsSection = {
  title: string;
  items: string[];
};

type CvSkills = {
  sections: CvSkillsSection[];
  tools: string[];
};

type CvExperience = {
  company: string;
  role: string;
  dates: string;
  bullets: string[];
  location?: string;
};

type CvEducation = {
  school: string;
  degree: string;
  dates: string;
  location?: string;
};

type CvProfile = {
  fullName: string;
  email: string;
  phone: string;
  linkedin: string;
  profileSummary: string;

  city?: string;
  address?: string;

  contractType: string;
  contractTypeStandard?: string;
  contractTypeFull?: string;

  primaryDomain?: string;
  secondaryDomains?: string[];
  softSkills?: string[];

  drivingLicense?: string;
  vehicle?: string;

  skills: CvSkills;
  experiences: CvExperience[];
  education: CvEducation[];
  educationShort: string[];
  certs: string;
  langLine: string;
  hobbies: string[];
  updatedAt?: number;
};

type Lang = "fr" | "en";

// 🔗 ENDPOINTS CLOUD FUNCTIONS
const LETTER_AND_PITCH_URL =
  "https://europe-west1-assistant-ia-v4.cloudfunctions.net/generateLetterAndPitch";

const GENERATE_CV_API =
  "https://europe-west1-assistant-ia-v4.cloudfunctions.net/generateCvPdf";

const GENERATE_CV_LM_ZIP_API =
  "https://europe-west1-assistant-ia-v4.cloudfunctions.net/generateCvLmZip";

const GENERATE_LM_PDF_API =
  "https://europe-west1-assistant-ia-v4.cloudfunctions.net/generateLetterPdf";

export default function AssistanceCandidaturePage() {
  // --- PROFIL CV IA ---

  const [userId, setUserId] = useState<string | null>(null);
  const [userEmail, setUserEmail] = useState<string | null>(null);
  const [profile, setProfile] = useState<CvProfile | null>(null);
  const [loadingProfile, setLoadingProfile] = useState(true);

  // Bandeau global "IA en cours"
  const [globalLoadingMessage, setGlobalLoadingMessage] = useState<
    string | null
  >(null);

  useEffect(() => {
    const unsub = onAuthStateChanged(auth, async (user) => {
      if (!user) {
        setUserId(null);
        setUserEmail(null);
        setProfile(null);
        setLoadingProfile(false);
        return;
      }

      setUserId(user.uid);
      setUserEmail(user.email ?? null);

      try {
        const ref = doc(db, "profiles", user.uid);
        const snap = await getDoc(ref);

        if (snap.exists()) {
          const data = snap.data() as any;

          const loadedProfile: CvProfile = {
            fullName: data.fullName || "",
            email: data.email || "",
            phone: data.phone || "",
            linkedin: data.linkedin || "",
            profileSummary: data.profileSummary || "",
            city: data.city || "",
            address: data.address || "",
            contractType:
              data.contractType || data.contractTypeStandard || "",
            contractTypeStandard: data.contractTypeStandard || "",
            contractTypeFull: data.contractTypeFull || "",
            primaryDomain: data.primaryDomain || "",
            secondaryDomains: Array.isArray(data.secondaryDomains)
              ? data.secondaryDomains
              : [],
            softSkills: Array.isArray(data.softSkills)
              ? data.softSkills
              : [],
            drivingLicense: data.drivingLicense || "",
            vehicle: data.vehicle || "",
            skills: {
              sections: Array.isArray(data.skills?.sections)
                ? data.skills.sections
                : [],
              tools: Array.isArray(data.skills?.tools)
                ? data.skills.tools
                : [],
            },
            experiences: Array.isArray(data.experiences)
              ? data.experiences
              : [],
            education: Array.isArray(data.education)
              ? data.education
              : [],
            educationShort: Array.isArray(data.educationShort)
              ? data.educationShort
              : [],
            certs: data.certs || "",
            langLine: data.langLine || "",
            hobbies: Array.isArray(data.hobbies) ? data.hobbies : [],
            updatedAt:
              typeof data.updatedAt === "number"
                ? data.updatedAt
                : undefined,
          };

          setProfile(loadedProfile);
        } else {
          setProfile(null);
        }
      } catch (e) {
        console.error("Erreur chargement profil Firestore (assistance):", e);
      } finally {
        setLoadingProfile(false);
      }
    });

    return () => unsub();
  }, []);

  // --- ÉTATS CV IA (1 page) ---

  const [cvTargetJob, setCvTargetJob] = useState("");
  const [cvTemplate, setCvTemplate] = useState("ats");
  const [cvLang, setCvLang] = useState<Lang>("fr");
  const [cvContract, setCvContract] = useState("CDI");
  const [cvJobLink, setCvJobLink] = useState("");
  const [cvJobDesc, setCvJobDesc] = useState("");
  const [cvAutoCreate, setCvAutoCreate] = useState(true);

  const [cvLoading, setCvLoading] = useState(false);
  const [cvZipLoading, setCvZipLoading] = useState(false);
  const [cvStatus, setCvStatus] = useState<string | null>(null);
  const [cvError, setCvError] = useState<string | null>(null);

  // --- ÉTATS LETTRE DE MOTIVATION ---

  const [lmLang, setLmLang] = useState<Lang>("fr");
  const [companyName, setCompanyName] = useState("");
  const [jobTitle, setJobTitle] = useState("");
  const [jobDescription, setJobDescription] = useState("");
  const [jobLink, setJobLink] = useState("");
  const [letterText, setLetterText] = useState("");
  const [lmLoading, setLmLoading] = useState(false);
  const [lmError, setLmError] = useState<string | null>(null);
  const [letterCopied, setLetterCopied] = useState(false);
  const [lmPdfLoading, setLmPdfLoading] = useState(false);
  const [lmPdfError, setLmPdfError] = useState<string | null>(null);

  // --- ÉTATS PITCH ---

  const [pitchLang, setPitchLang] = useState<Lang>("fr");
  const [pitchText, setPitchText] = useState("");
  const [pitchLoading, setPitchLoading] = useState(false);
  const [pitchError, setPitchError] = useState<string | null>(null);
  const [pitchCopied, setPitchCopied] = useState(false);

  // --- MAIL DE CANDIDATURE (objet + corps) ---

  const [recruiterName, setRecruiterName] = useState("");
  const [emailPreview, setEmailPreview] = useState("");
  const [subjectPreview, setSubjectPreview] = useState("");

  // --- DERIVÉS POUR AFFICHAGE HEADER & BANDEAUX ---

  const visibilityLabel = userId ? "Associé à ton compte" : "Invité";

  const miniHeadline =
    profile?.profileSummary?.split(".")[0] ||
    profile?.contractType ||
    "Analyse ton CV PDF dans l’onglet « CV IA » pour activer l’assistant.";

  const profileName = profile?.fullName || userEmail || "Profil non détecté";

  const targetedJob =
    jobTitle || cvTargetJob || "Poste cible non renseigné";
  const targetedCompany = companyName || "Entreprise non renseignée";

  // --- HELPER : création auto dans /applications ---

  type GenerationKind = "cv" | "cv_lm" | "lm" | "pitch";

  const autoCreateApplication = async (kind: GenerationKind) => {
    // Si la case n'est pas cochée -> on ne fait rien
    if (!cvAutoCreate) return;
    if (!userId || !profile) return;

    try {
      const appsRef = collection(db, "applications");
      await addDoc(appsRef, {
        userId,
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp(),
        // Infos poste : on prend d'abord ce qui vient de l'étape LM, sinon Etape CV
        company: companyName || "",
        jobTitle: jobTitle || cvTargetJob || "",
        jobLink: jobLink || cvJobLink || "",
        status: "draft",
        source: "Assistant candidature IA",
        hasCv: kind === "cv" || kind === "cv_lm",
        hasLm: kind === "lm" || kind === "cv_lm",
        hasPitch: kind === "pitch",
        langCv: cvLang,
        langLm: lmLang,
        langPitch: pitchLang,
      });
    } catch (e) {
      console.error("Erreur création entrée suivi de candidature :", e);
      // On ne bloque pas l’UX si le suivi plante
    }
  };

  // --- ACTIONS CV ---

  const handleGenerateCv = async () => {
    if (!profile) {
      setCvError(
        "Aucun profil CV IA détecté. Va d'abord dans l'onglet CV IA pour analyser ton CV PDF."
      );
      return;
    }

    setCvError(null);
    setCvStatus(null);
    setCvLoading(true);
    setGlobalLoadingMessage("L’IA prépare ton CV 1 page…");

    try {
      const res = await fetch(GENERATE_CV_API, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          profile,
          targetJob: cvTargetJob,
          template: cvTemplate,
          lang: cvLang,
          contract: cvContract,
          jobLink: cvJobLink,
          jobDescription: cvJobDesc,
          autoCreate: cvAutoCreate,
        }),
      });

      if (!res.ok) {
        const text = await res.text();
        throw new Error(text || "Erreur serveur lors de la génération du CV.");
      }

      const blob = await res.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "cv-ia.pdf";
      document.body.appendChild(a);
      a.click();
      a.remove();
      window.URL.revokeObjectURL(url);

      setCvStatus("CV généré et téléchargé avec succès 🎉");

      // 👉 Création automatique dans /applications
      await autoCreateApplication("cv");

      // 📣 LOG L'USAGE du CV (1 docType = "cv")
      if (auth.currentUser) {
        await logUsage({
          user: auth.currentUser,
          action: "generate_document",
          docType: "cv",
          eventType: "generate",
          tool: "generateCvPdf",
          // creditsDelta: -1, // à activer si tu gères les crédits ici
        });
      }
    } catch (err: any) {
      console.error("Erreur génération CV:", err);
      setCvError(
        err?.message || "Impossible de générer le CV pour le moment."
      );
    } finally {
      setCvLoading(false);
      setGlobalLoadingMessage(null);
    }
  };

  const handleGenerateCvLmZip = async () => {
    if (!profile) {
      setCvError(
        "Aucun profil CV IA détecté. Va d'abord dans l'onglet CV IA pour analyser ton CV PDF."
      );
      return;
    }

    setCvError(null);
    setCvStatus(null);
    setCvZipLoading(true);
    setGlobalLoadingMessage("L’IA prépare ton CV + lettre de motivation…");

    try {
      const res = await fetch(GENERATE_CV_LM_ZIP_API, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          profile,
          targetJob: cvTargetJob,
          template: cvTemplate,
          lang: cvLang,
          contract: cvContract,
          jobLink: cvJobLink,
          jobDescription: cvJobDesc,
          autoCreate: cvAutoCreate,
          lm: {
            companyName,
            jobTitle,
            jobDescription,
            jobLink,
            lang: lmLang,
          },
        }),
      });

      if (!res.ok) {
        const text = await res.text();
        throw new Error(
          text || "Erreur serveur lors de la génération du ZIP CV + LM."
        );
      }

      const blob = await res.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "cv-lm-ia.zip";
      document.body.appendChild(a);
      a.click();
      a.remove();
      window.URL.revokeObjectURL(url);

      setCvStatus("CV + LM générés et téléchargés dans un ZIP 🎉");

      // 👉 Création auto dans /applications (CV + LM)
      await autoCreateApplication("cv_lm");

      // 📣 LOG L'USAGE du ZIP (CV + LM)
      if (auth.currentUser) {
        // 1) côté stats CV
        await logUsage({
          user: auth.currentUser,
          action: "generate_document",
          docType: "cv",
          eventType: "generate_zip",
          tool: "generateCvLmZip",
        });
        // 2) côté stats LM (sans retoucher les crédits)
        await logUsage({
          user: auth.currentUser,
          action: "generate_document",
          docType: "lm",
          eventType: "generate_zip",
          tool: "generateCvLmZip",
          creditsDelta: 0,
        });
      }
    } catch (err: any) {
      console.error("Erreur génération ZIP CV + LM:", err);
      setCvError(
        err?.message ||
          "Impossible de générer le ZIP CV + LM pour le moment."
      );
    } finally {
      setCvZipLoading(false);
      setGlobalLoadingMessage(null);
    }
  };

  // --- ACTIONS LETTRE DE MOTIVATION ---

  const handleGenerateLetter = async (e?: FormEvent) => {
    if (e) e.preventDefault();
    if (!profile) {
      setLmError(
        "Aucun profil CV IA détecté. Va d'abord dans l'onglet CV IA pour analyser ton CV PDF."
      );
      return;
    }

    if (!jobTitle && !jobDescription) {
      setLmError(
        "Ajoute au moins l'intitulé du poste ou un extrait de la description."
      );
      return;
    }

    setLmError(null);
    setLmPdfError(null);
    setPitchError(null);
    setLmLoading(true);
    setLetterCopied(false);
    setGlobalLoadingMessage("L’IA rédige ta lettre de motivation…");

    try {
      const resp = await fetch(LETTER_AND_PITCH_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          profile,
          jobTitle,
          companyName,
          jobDescription,
          lang: lmLang,
        }),
      });

      const json = await resp.json().catch(() => null);

      if (!resp.ok) {
        const msg =
          (json && json.error) ||
          "Erreur pendant la génération de la lettre de motivation.";
        throw new Error(msg);
      }

      const coverLetter =
        typeof json.coverLetter === "string" ? json.coverLetter.trim() : "";

      setLetterText(coverLetter);

      // 👉 Création auto dans /applications (LM seule)
      await autoCreateApplication("lm");

      // 📣 LOG L'USAGE de la LM (génération texte)
      if (auth.currentUser) {
        await logUsage({
          user: auth.currentUser,
          action: "generate_document",
          docType: "lm",
          eventType: "generate",
          tool: "generateLetterAndPitch",
        });
      }
    } catch (err: any) {
      console.error("Erreur generateLetter:", err);
      setLmError(
        err?.message ||
          "Impossible de générer la lettre de motivation pour le moment."
      );
    } finally {
      setLmLoading(false);
      setGlobalLoadingMessage(null);
    }
  };

  const handleDownloadLetterPdf = async () => {
    if (!letterText) {
      setLmPdfError(
        "Génère d'abord la lettre, puis tu pourras la télécharger en PDF."
      );
      return;
    }

    setLmPdfError(null);
    setLmPdfLoading(true);
    setGlobalLoadingMessage("L’IA met en forme ta lettre en PDF…");

    try {
      const resp = await fetch(GENERATE_LM_PDF_API, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          coverLetter: letterText,
          jobTitle,
          companyName,
          candidateName: profile?.fullName || "",
          lang: lmLang,
        }),
      });

      if (!resp.ok) {
        const text = await resp.text();
        throw new Error(
          text || "Erreur serveur lors de la génération du PDF de la lettre."
        );
      }

      const blob = await resp.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "lettre-motivation.pdf";
      document.body.appendChild(a);
      a.click();
      a.remove();
      window.URL.revokeObjectURL(url);

      // 📣 LOG L'USAGE du téléchargement PDF de la LM
      if (auth.currentUser) {
        await logUsage({
          user: auth.currentUser,
          action: "download_pdf",
          docType: "other",
          eventType: "lm_pdf_download",
          tool: "generateLetterPdf",
        });
      }
    } catch (err: any) {
      console.error("Erreur téléchargement LM PDF:", err);
      setLmPdfError(
        err?.message || "Impossible de générer le PDF pour le moment."
      );
    } finally {
      setLmPdfLoading(false);
      setGlobalLoadingMessage(null);
    }
  };

  const handleCopyLetter = async () => {
    if (!letterText) return;
    try {
      await navigator.clipboard.writeText(letterText);
      setLetterCopied(true);
      setTimeout(() => setLetterCopied(false), 1500);
    } catch (e) {
      console.error("Erreur copie LM:", e);
    }
  };

  // --- ACTIONS PITCH ---

  const handleGeneratePitch = async () => {
    if (!profile) {
      setPitchError(
        "Aucun profil CV IA détecté. Va d'abord dans l'onglet CV IA pour analyser ton CV PDF."
      );
      return;
    }

    const effectiveJobTitle =
      jobTitle || cvTargetJob || "Candidature cible";
    const effectiveDesc = jobDescription || cvJobDesc || "";

    setPitchError(null);
    setPitchLoading(true);
    setPitchCopied(false);
    setGlobalLoadingMessage("L’IA prépare ton pitch d’ascenseur…");

    try {
      const resp = await fetch(LETTER_AND_PITCH_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          profile,
          jobTitle: effectiveJobTitle,
          companyName,
          jobDescription: effectiveDesc,
          lang: pitchLang,
        }),
      });

      const json = await resp.json().catch(() => null);

      if (!resp.ok) {
        const msg =
          (json && json.error) ||
          "Erreur pendant la génération du pitch.";
        throw new Error(msg);
      }

      const pitch =
        typeof json.pitch === "string" ? json.pitch.trim() : "";

      if (!pitch) {
        throw new Error("Pitch vide renvoyé par l'API.");
      }

      setPitchText(pitch);

      // 👉 Création auto dans /applications (pitch)
      await autoCreateApplication("pitch");

      // 📣 LOG L'USAGE du Pitch
      if (auth.currentUser) {
        await logUsage({
          user: auth.currentUser,
          action: "generate_pitch",
          docType: "other",
          eventType: "generate",
          tool: "generateLetterAndPitch",
        });
      }
    } catch (err: any) {
      console.error("Erreur generatePitch:", err);
      setPitchError(
        err?.message || "Impossible de générer le pitch pour le moment."
      );
    } finally {
      setPitchLoading(false);
      setGlobalLoadingMessage(null);
    }
  };

  const handleCopyPitch = async () => {
    if (!pitchText) return;
    try {
      await navigator.clipboard.writeText(pitchText);
      setPitchCopied(true);
      setTimeout(() => setPitchCopied(false), 1500);
    } catch (e) {
      console.error("Erreur copie pitch:", e);
    }
  };

  // --- ACTIONS MAIL DE CANDIDATURE ---

  const buildEmailContent = () => {
    const name = profile?.fullName || "Je";
    const subject = `Candidature – ${jobTitle || "poste"} – ${name}`;
    const recruiter =
      recruiterName.trim() || "Madame, Monsieur";

    const body = `Bonjour ${recruiter},

Je me permets de vous adresser ma candidature pour le poste de ${
      jobTitle || "..."
    } au sein de ${companyName || "votre entreprise"}.

Vous trouverez ci-joint mon CV ainsi que ma lettre de motivation.
Mon profil correspond particulièrement à vos attentes sur ce poste, et je serais ravi(e) d'échanger avec vous pour en discuter de vive voix.

Je reste bien entendu disponible pour tout complément d'information.

Cordialement,

${name}
`;

    setSubjectPreview(subject);
    setEmailPreview(body);
  };

  const handleGenerateEmail = (e: FormEvent) => {
    e.preventDefault();
    buildEmailContent();
  };

  // --- RENDER ---

  return (
    <motion.div
      initial={{ opacity: 0, y: 12 }}
      animate={{ opacity: 1, y: 0 }}
      transition={{ duration: 0.25 }}
      className="max-w-3xl mx-auto px-3 sm:px-4 py-5 sm:py-6 space-y-4"
    >
      {/* Bandeau global de chargement IA */}
      {globalLoadingMessage && (
        <div className="mb-2 rounded-full bg-[var(--bg-soft)] border border-[var(--border)]/80 px-3 py-1.5 text-[11px] flex items-center gap-2 text-[var(--muted)]">
          <span className="inline-flex w-3 h-3 rounded-full border-2 border-[var(--brand)] border-t-transparent animate-spin" />
          <span>{globalLoadingMessage}</span>
        </div>
      )}

      {/* HEADER MOBILE-FIRST */}
      <section className="space-y-3">
        <div className="flex flex-wrap items-center justify-between gap-2">
          <p className="badge-muted flex items-center gap-1.5">
            <span className="w-1.5 h-1.5 rounded-full bg-emerald-400" />
            <span className="text-[11px] uppercase tracking-wider text-[var(--muted)]">
              Assistant de candidature IA
            </span>
          </p>
          <div className="flex flex-wrap gap-2 text-[11px]">
            <span className="inline-flex items-center rounded-full border border-[var(--border)] px-2 py-[2px]">
              Profil IA :{" "}
              <span className="ml-1 font-medium">
                {loadingProfile
                  ? "Chargement…"
                  : profile
                  ? "Détecté ✅"
                  : "Non détecté"}
              </span>
            </span>
            <span className="inline-flex items-center rounded-full border border-[var(--border)] px-2 py-[2px]">
              Visibilité :{" "}
              <span className="ml-1 font-medium">{visibilityLabel}</span>
            </span>
          </div>
        </div>

        <div className="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
          <div className="space-y-1">
            <h1 className="text-lg sm:text-xl font-semibold">
              Prépare ta candidature avec ton CV IA
            </h1>
            <p className="text-[12px] text-[var(--muted)] max-w-xl">
              À partir de ton profil CV IA, génère un{" "}
              <strong>CV 1 page</strong>, une{" "}
              <strong>lettre de motivation personnalisée</strong>, un{" "}
              <strong>pitch d&apos;ascenseur</strong> et un{" "}
              <strong>mail de candidature</strong> prêts à être envoyés.
            </p>
          </div>

          {/* Mini résumé profil */}
          <div className="w-full sm:w-[220px] rounded-2xl border border-[var(--border)] bg-[var(--bg-soft)] px-3 py-2.5 text-[11px]">
            <p className="text-[var(--muted)] mb-1">Résumé du profil</p>
            <p className="font-semibold text-[var(--ink)] leading-tight">
              {profileName}
            </p>
            <p className="mt-0.5 text-[var(--muted)] line-clamp-2">
              {miniHeadline}
            </p>
          </div>
        </div>

        {/* 4 étapes */}
        <div className="flex flex-wrap gap-1.5 text-[11px]">
          <span className="inline-flex items-center gap-1 rounded-full bg-[var(--bg-soft)] border border-[var(--border)] px-2 py-[3px]">
            <span className="w-4 h-4 rounded-full bg-[var(--brand)]/10 flex items-center justify-center text-[10px] text-[var(--brand)]">
              1
            </span>
            <span>Cible le poste (titre, entreprise, offre)</span>
          </span>
          <span className="inline-flex items-center gap-1 rounded-full bg-[var(--bg-soft)] border border-[var(--border)] px-2 py-[3px]">
            <span className="w-4 h-4 rounded-full bg-[var(--brand)]/10 flex items-center justify-center text-[10px] text-[var(--brand)]">
              2
            </span>
            <span>Génère CV 1 page &amp; LM</span>
          </span>
          <span className="inline-flex items-center gap-1 rounded-full bg-[var(--bg-soft)] border border-[var(--border)] px-2 py-[3px]">
            <span className="w-4 h-4 rounded-full bg-[var(--brand)]/10 flex items-center justify-center text-[10px] text-[var(--brand)]">
              3
            </span>
            <span>Finalise ton pitch pour l’entretien</span>
          </span>
          <span className="inline-flex items-center gap-1 rounded-full bg-[var(--bg-soft)] border border-[var(--border)] px-2 py-[3px]">
            <span className="w-4 h-4 rounded-full bg-[var(--brand)]/10 flex items-center justify-center text-[10px] text-[var(--brand)]">
              4
            </span>
            <span>Génère ton mail de candidature</span>
          </span>
        </div>
      </section>

      {/* ÉTAPE 1 : CV IA */}
      <section className="glass border border-[var(--border)]/80 rounded-2xl p-4 sm:p-5 space-y-4">
        <div className="flex items-start justify-between gap-2">
          <div className="flex items-center gap-2">
            <span className="inline-flex items-center justify-center text-[10px] px-2 py-[2px] rounded-full bg-[var(--bg-soft)] border border-[var(--border)]/80 text-[var(--muted)]">
              Étape 1
            </span>
            <div>
              <h2 className="text-base sm:text-lg font-semibold text-[var(--ink)]">
                CV IA – 1 page A4
              </h2>
              <p className="text-[11px] text-[var(--muted)]">
                PDF compact, lisible par les ATS, généré à partir de ton
                profil.
              </p>
            </div>
          </div>
        </div>

        {/* Inputs CV */}
        <div className="space-y-3 text-[13px]">
          <div>
            <label className="block text-[11px] font-medium text-[var(--muted)] mb-1">
              Titre / objectif du CV
            </label>
            <input
              id="cvTargetJob"
              type="text"
              className="input w-full text-[var(--ink)] bg-[var(--bg)] placeholder:text-[var(--muted)]"
              placeholder="Ex : Ingénieur Cybersécurité"
              value={cvTargetJob}
              onChange={(e) => setCvTargetJob(e.target.value)}
            />
          </div>

          <div className="grid grid-cols-2 gap-3">
            <div>
              <label className="block text-[11px] font-medium text-[var(--muted)] mb-1">
                Modèle
              </label>
              <select
                id="cvTemplate"
                className="select-brand w-full text-[var(--ink)] bg-[var(--bg-soft)]"
                value={cvTemplate}
                onChange={(e) => setCvTemplate(e.target.value)}
              >
                <option value="ats">ATS (sobre)</option>
                <option value="design">Design (CLOUD)</option>
                <option value="magazine">Magazine</option>
                <option value="classic">Classique</option>
                <option value="modern">Moderne</option>
                <option value="minimalist">Minimaliste</option>
                <option value="academic">Académique</option>
              </select>
            </div>
            <div>
              <label className="block text-[11px] font-medium text-[var(--muted)] mb-1">
                Langue
              </label>
              <select
                id="cvLang"
                className="select-brand w-full text-[var(--ink)] bg-[var(--bg-soft)]"
                value={cvLang}
                onChange={(e) => setCvLang(e.target.value as Lang)}
              >
                <option value="fr">Français</option>
                <option value="en">English</option>
              </select>
            </div>
          </div>

          <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
            <div>
              <label className="block text-[11px] font-medium text-[var(--muted)] mb-1">
                Contrat visé
              </label>
              <select
                id="cvContract"
                className="select-brand w-full text-[var(--ink)] bg-[var(--bg-soft)]"
                value={cvContract}
                onChange={(e) => setCvContract(e.target.value)}
              >
                <option value="CDI">CDI</option>
                <option value="CDD">CDD</option>
                <option value="Alternance">Alternance</option>
                <option value="Stage">Stage</option>
                <option value="Freelance">Freelance</option>
              </select>
            </div>
            <div>
              <label className="block text-[11px] font-medium text-[var(--muted)] mb-1">
                Lien de l&apos;offre (optionnel)
              </label>
              <input
                id="cvJobLink"
                type="url"
                className="input w-full text-[var(--ink)] bg-[var(--bg)] placeholder:text-[var(--muted)]"
                placeholder="https://"
                value={cvJobLink}
                onChange={(e) => setCvJobLink(e.target.value)}
              />
            </div>
          </div>

          <div>
            <label className="block text-[11px] font-medium text-[var(--muted)] mb-1">
              Extraits de l&apos;offre (optionnel)
            </label>
            <textarea
              id="cvJD"
              rows={3}
              className="input textarea w-full text-[13px] text-[var(--ink)] bg-[var(--bg)] placeholder:text-[var(--muted)]"
              placeholder="Colle quelques missions / outils / mots-clés de l’offre."
              value={cvJobDesc}
              onChange={(e) => setCvJobDesc(e.target.value)}
            />
          </div>

          <div className="pt-1">
            <label className="flex items-center gap-2 cursor-pointer text-[12px]">
              <input
                id="autoCreateSwitch"
                type="checkbox"
                className="toggle-checkbox"
                checked={cvAutoCreate}
                onChange={(e) => setCvAutoCreate(e.target.checked)}
              />
              <span className="text-[var(--muted)]">
                Créer automatiquement une entrée dans le{" "}
                <strong>Suivi 📌</strong> à chaque génération (CV, LM, pitch).
              </span>
            </label>
          </div>
        </div>

        <div className="flex flex-col sm:flex-row gap-2 pt-2">
          <button
            id="generateCvBtn"
            type="button"
            onClick={handleGenerateCv}
            disabled={cvLoading || !profile}
            className="btn-primary relative flex-1 disabled:opacity-60 disabled:cursor-not-allowed"
          >
            <span>
              {cvLoading ? "Génération du CV..." : "Générer le CV (PDF)"}
            </span>
            <div
              id="cvBtnSpinner"
              className={`loader absolute inset-0 m-auto ${
                cvLoading ? "" : "hidden"
              }`}
            />
          </button>
          <button
            id="generateCvLmZipBtn"
            type="button"
            onClick={handleGenerateCvLmZip}
            disabled={cvZipLoading || !profile}
            className="btn-secondary relative flex-1 disabled:opacity-60 disabled:cursor-not-allowed"
          >
            <span>
              {cvZipLoading ? "Génération ZIP..." : "CV + LM (ZIP)"}
            </span>
            <div
              id="cvLmZipBtnSpinner"
              className={`loader absolute inset-0 m-auto ${
                cvZipLoading ? "" : "hidden"
              }`}
            />
          </button>
        </div>

        <div className="mt-2 p-2.5 rounded-md border border-dashed border-[var(--border)]/70 text-[11px] text-[var(--muted)]">
          {cvStatus ? (
            <p className="text-center text-emerald-400 text-[12px]">
              {cvStatus}
            </p>
          ) : (
            <p className="text-center">
              Le CV est directement téléchargé en PDF. Ce bloc affiche le
              résultat de la génération.
            </p>
          )}
          {cvError && (
            <p className="mt-1 text-center text-red-400 text-[12px]">
              {cvError}
            </p>
          )}
        </div>
      </section>

      {/* ÉTAPE 2 : LETTRE DE MOTIVATION */}
      <section className="glass border border-[var(--border)]/80 rounded-2xl p-4 sm:p-5 space-y-4">
        {/* Bandeau rappel du poste ciblé */}
        <div className="rounded-md bg-[var(--bg-soft)] border border-dashed border-[var(--border)]/70 px-3 py-2 text-[11px] text-[var(--muted)] flex flex-wrap gap-2 justify-between">
          <span>
            🎯 Poste ciblé :{" "}
            <span className="font-medium text-[var(--ink)]">
              {targetedJob}
            </span>
          </span>
          <span>
            🏢{" "}
            <span className="font-medium text-[var(--ink)]">
              {targetedCompany}
            </span>
          </span>
        </div>

        <form onSubmit={handleGenerateLetter} className="space-y-3">
          <div className="flex items-start justify-between gap-2">
            <div className="flex items-center gap-2">
              <span className="inline-flex items-center justify-center text-[10px] px-2 py-[2px] rounded-full bg-[var(--bg-soft)] border border-[var(--border)]/80 text-[var(--muted)]">
                Étape 2
              </span>
              <div>
                <h3 className="text-base sm:text-lg font-semibold text-[var(--brand)]">
                  Lettre de motivation IA
                </h3>
                <p className="text-[11px] text-[var(--muted)]">
                  Génère un texte personnalisé à partir de ton profil et de
                  l&apos;offre, puis exporte-le en PDF.
                </p>
              </div>
            </div>
            <select
              id="lmLang"
              className="select-brand w-[105px] text-[12px] text-[var(--ink)] bg-[var(--bg-soft)]"
              value={lmLang}
              onChange={(e) => setLmLang(e.target.value as Lang)}
            >
              <option value="fr">FR</option>
              <option value="en">EN</option>
            </select>
          </div>

          <div className="space-y-3 text-[13px]">
            <div className="grid sm:grid-cols-2 gap-3">
              <div>
                <label className="block text-[11px] font-medium text-[var(--muted)] mb-1">
                  Nom de l&apos;entreprise
                </label>
                <input
                  id="companyName"
                  type="text"
                  className="input w-full text-[var(--ink)] bg-[var(--bg)] placeholder:text-[var(--muted)]"
                  placeholder="Ex : IMOGATE"
                  value={companyName}
                  onChange={(e) => setCompanyName(e.target.value)}
                />
              </div>
              <div>
                <label className="block text-[11px] font-medium text-[var(--muted)] mb-1">
                  Intitulé du poste
                </label>
                <input
                  id="jobTitle"
                  type="text"
                  className="input w-full text-[var(--ink)] bg-[var(--bg)] placeholder:text-[var(--muted)]"
                  placeholder="Ex : Ingénieur Réseaux & Sécurité"
                  value={jobTitle}
                  onChange={(e) => setJobTitle(e.target.value)}
                />
              </div>
            </div>

            <div>
              <label className="block text-[11px] font-medium text-[var(--muted)] mb-1">
                Extraits de l&apos;offre (optionnel)
              </label>
              <textarea
                id="jobDescription"
                rows={3}
                className="input textarea w-full text-[var(--ink)] bg-[var(--bg)] placeholder:text-[var(--muted)]"
                placeholder="Colle quelques missions / outils / contexte de l’offre."
                value={jobDescription}
                onChange={(e) => setJobDescription(e.target.value)}
              />
            </div>

            <div>
              <label className="block text-[11px] font-medium text-[var(--muted)] mb-1">
                Lien de l&apos;offre (optionnel)
              </label>
              <input
                id="jobLink"
                type="url"
                className="input w-full text-[var(--ink)] bg-[var(--bg)] placeholder:text-[var(--muted)]"
                placeholder="https://"
                value={jobLink}
                onChange={(e) => setJobLink(e.target.value)}
              />
            </div>

            {lmError && (
              <p className="text-[11px] text-red-400">{lmError}</p>
            )}

            <div className="flex flex-col sm:flex-row gap-2 pt-1">
              <button
                id="generateCoverLetterBtn"
                type="submit"
                disabled={lmLoading || !profile}
                className="btn-primary relative flex-1 disabled:opacity-60 disabled:cursor-not-allowed"
              >
                <span>
                  {lmLoading
                    ? "Génération de la LM..."
                    : "Générer la lettre"}
                </span>
                <div
                  id="lmBtnSpinner"
                  className={`loader absolute inset-0 m-auto ${
                    lmLoading ? "" : "hidden"
                  }`}
                />
              </button>

              <button
                id="downloadLetterPdfBtn"
                type="button"
                onClick={handleDownloadLetterPdf}
                disabled={!letterText || lmPdfLoading}
                className="btn-secondary relative flex-1 disabled:opacity-60 disabled:cursor-not-allowed"
              >
                <span>
                  {lmPdfLoading
                    ? "Création du PDF..."
                    : "Télécharger en PDF"}
                </span>
                <div
                  className={`loader absolute inset-0 m-auto ${
                    lmPdfLoading ? "" : "hidden"
                  }`}
                />
              </button>
            </div>

            <div className="flex flex-col sm:flex-row gap-2">
              <button
                id="copyLetterBtn"
                type="button"
                onClick={handleCopyLetter}
                disabled={!letterText}
                className="btn-secondary flex-1 disabled:opacity-60 disabled:cursor-not-allowed"
              >
                <span>
                  {letterCopied ? "Texte copié ✅" : "Copier le texte"}
                </span>
              </button>
            </div>

            {lmPdfError && (
              <p className="text-[11px] text-red-400">{lmPdfError}</p>
            )}
          </div>
        </form>

        <div className="mt-2 p-3 card-soft rounded-md border border-dashed border-[var(--brand)]/50">
          <p className="text-[11px] text-[var(--muted)] mb-1 text-center">
            Dernière lettre générée (tu peux l&apos;adapter avant envoi ou PDF).
          </p>
          <div className="letter-pre text-[13px] text-[var(--ink)] overflow-auto max-h-[220px] whitespace-pre-line">
            {letterText ? (
              <p>{letterText}</p>
            ) : (
              <p className="text-center text-[var(--muted)]">
                Lance une génération pour voir ici le texte de la LM IA.
              </p>
            )}
          </div>
        </div>
      </section>

      {/* ÉTAPE 3 : PITCH */}
      <section className="glass border border-[var(--border)]/80 rounded-2xl p-4 sm:p-5 space-y-3">
        {/* Bandeau rappel du poste ciblé */}
        <div className="rounded-md bg-[var(--bg-soft)] border border-dashed border-[var(--border)]/70 px-3 py-2 text-[11px] text-[var(--muted)] flex flex-wrap gap-2 justify-between">
          <span>
            🎯 Poste ciblé :{" "}
            <span className="font-medium text-[var(--ink)]">
              {targetedJob}
            </span>
          </span>
          <span>🧩 Utilise ce pitch pour mails, LinkedIn et entretiens.</span>
        </div>

        <div className="flex items-start justify-between gap-2">
          <div className="flex items-center gap-2">
            <span className="inline-flex items-center justify-center text-[10px] px-2 py-[2px] rounded-full bg-[var(--bg-soft)] border border-[var(--border)]/80 text-[var(--muted)]">
              Étape 3
            </span>
            <div>
              <h3 className="text-base sm:text-lg font-semibold text-[var(--brand)]">
                Pitch d&apos;ascenseur
              </h3>
              <p className="text-[11px] text-[var(--muted)]">
                Résumé percutant de 2–4 phrases pour te présenter en 30–40
                secondes.
              </p>
            </div>
          </div>
          <select
            id="pitchLang"
            className="select-brand w-[105px] text-[12px] text-[var(--ink)] bg-[var(--bg-soft)]"
            value={pitchLang}
            onChange={(e) => setPitchLang(e.target.value as Lang)}
          >
            <option value="fr">FR</option>
            <option value="en">EN</option>
          </select>
        </div>

        {pitchError && (
          <p className="text-[11px] text-red-400">{pitchError}</p>
        )}

        <div className="flex flex-col sm:flex-row gap-2 pt-1">
          <button
            id="generatePitchBtn"
            type="button"
            onClick={handleGeneratePitch}
            disabled={pitchLoading || !profile}
            className="btn-primary relative flex-1 disabled:opacity-60 disabled:cursor-not-allowed"
          >
            <span>
              {pitchLoading
                ? "Génération du pitch..."
                : "Générer le pitch"}
            </span>
            <div
              id="pitchBtnSpinner"
              className={`loader absolute inset-0 m-auto ${
                pitchLoading ? "" : "hidden"
              }`}
            />
          </button>
          <button
            id="copyPitchBtn"
            type="button"
            onClick={handleCopyPitch}
            disabled={!pitchText}
            className="btn-secondary flex-1 disabled:opacity-60 disabled:cursor-not-allowed"
          >
            <span>
              {pitchCopied ? "Pitch copié ✅" : "Copier le pitch"}
            </span>
          </button>
        </div>

        <div className="mt-2 p-3 card-soft rounded-md text-[13px] text-[var(--ink)] whitespace-pre-line">
          {pitchText ? (
            <p>{pitchText}</p>
          ) : (
            <p className="text-center text-[11px] text-[var(--muted)]">
              Après génération, ton pitch apparaîtra ici. Tu pourras ensuite le
              réutiliser dans tes mails, sur LinkedIn ou en entretien.
            </p>
          )}
        </div>
      </section>

      {/* ÉTAPE 4 : MAIL DE CANDIDATURE */}
      <section className="glass border border-[var(--border)]/80 rounded-2xl p-4 sm:p-5 space-y-4">
        <div className="flex items-start justify-between gap-2">
          <div className="flex items-center gap-2">
            <span className="inline-flex items-center justify-center text-[10px] px-2 py-[2px] rounded-full bg-[var(--bg-soft)] border border-[var(--border)]/80 text-[var(--muted)]">
              Étape 4
            </span>
            <div>
              <h3 className="text-base sm:text-lg font-semibold text-[var(--brand)]">
                Mail de candidature prêt à envoyer
              </h3>
              <p className="text-[11px] text-[var(--muted)] max-w-xl">
                Utilise les mêmes informations que ta lettre (entreprise, poste)
                pour générer un <strong>objet</strong> et un{" "}
                <strong>corps de mail</strong> à copier dans ton client mail ou
                sur un jobboard.
              </p>
            </div>
          </div>
        </div>

        <form
          onSubmit={handleGenerateEmail}
          className="grid md:grid-cols-2 gap-4 text-sm mt-1"
        >
          <div>
            <label className="block text-[11px] font-medium text-[var(--muted)] mb-1">
              Nom de l&apos;entreprise
            </label>
            <input
              className="input w-full"
              value={companyName}
              onChange={(e) => setCompanyName(e.target.value)}
              placeholder="Ex : IMOGATE"
            />
          </div>
          <div>
            <label className="block text-[11px] font-medium text-[var(--muted)] mb-1">
              Intitulé du poste
            </label>
            <input
              className="input w-full"
              value={jobTitle}
              onChange={(e) => setJobTitle(e.target.value)}
              placeholder="Ex : Ingénieur Réseaux & Sécurité"
            />
          </div>
          <div>
            <label className="block text-[11px] font-medium text-[var(--muted)] mb-1">
              Nom du recruteur (optionnel)
            </label>
            <input
              className="input w-full"
              value={recruiterName}
              onChange={(e) => setRecruiterName(e.target.value)}
              placeholder="Ex : Mme Dupont"
            />
          </div>
          <div className="md:col-span-2 flex justify-end">
            <button
              type="submit"
              className="btn-primary min-w-[200px]"
            >
              Générer le mail
            </button>
          </div>
        </form>

        <div className="grid md:grid-cols-2 gap-4 mt-3 text-sm">
          <div className="card-soft rounded-xl p-4 border border-[var(--border-soft)]">
            <h4 className="font-semibold text-sm mb-2">Objet</h4>
            <div className="text-xs text-[var(--muted)] whitespace-pre-line">
              {subjectPreview || "L'objet généré apparaîtra ici."}
            </div>
          </div>
          <div className="card-soft rounded-xl p-4 border border-[var(--border-soft)]">
            <h4 className="font-semibold text-sm mb-2">
              Corps du mail
            </h4>
            <div className="text-xs text-[var(--muted)] whitespace-pre-line max-h-64 overflow-auto">
              {emailPreview ||
                "Le texte du mail apparaîtra ici après génération."}
            </div>
          </div>
        </div>

        <p className="text-[10px] text-[var(--muted)] mt-3">
          📌 Copie-colle l&apos;objet et le texte dans ton client mail ou dans
          un formulaire &quot;Postuler&quot;, puis joins le CV et la lettre
          PDF générés dans les étapes précédentes.
        </p>
      </section>
    </motion.div>
  );
}
````

## File: app/app/pitch/page.tsx
````typescript
"use client";

export default function PitchPage() {
  return (
    <div className="max-w-4xl mx-auto glass p-4">
      <h1 className="text-lg font-semibold mb-2">Section pitch</h1>
      <p className="text-sm text-[var(--muted)]">Pitch oral IA pour préparer tes entretiens.</p>
    </div>
  );
}
````

## File: app/app/settings/page.tsx
````typescript
"use client";

import { useState, type FormEvent } from "react";
import { useAuth } from "@/context/AuthContext";
import { updateEmail, sendEmailVerification } from "firebase/auth";

export default function SettingsPage() {
  const { user } = useAuth();
  const [newEmail, setNewEmail] = useState(user?.email ?? "");
  const [saving, setSaving] = useState(false);
  const [sendingVerification, setSendingVerification] = useState(false);
  const [info, setInfo] = useState<string | null>(null);
  const [error, setError] = useState<string | null>(null);

  // Si pas connecté, on affiche juste un message (et on ne montre pas le reste de la page)
  if (!user) {
    return (
      <div className="max-w-4xl mx-auto glass p-4 text-sm">
        <p className="text-[var(--muted)]">
          Tu dois être connecté pour accéder à tes paramètres.
        </p>
      </div>
    );
  }

  async function handleResendVerification() {
    setError(null);
    setInfo(null);

    // 🔐 Sécurité + typage TS : on revérifie que user existe
    if (!user) {
      setError("Tu dois être connecté pour envoyer un email de vérification.");
      return;
    }

    setSendingVerification(true);
    try {
      await sendEmailVerification(user);
      setInfo(
        `Un nouvel email de validation a été envoyé à ${user.email}. Pense à vérifier tes spams.`
      );
    } catch (err) {
      console.error("Resend verification error:", err);
      setError(
        "Impossible d'envoyer l'email de validation pour le moment. Merci de réessayer plus tard."
      );
    } finally {
      setSendingVerification(false);
    }
  }

  async function handleChangeEmail(e: FormEvent<HTMLFormElement>) {
    e.preventDefault();
    setError(null);
    setInfo(null);
    setSaving(true);

    // 🔐 Sécurité + typage TS : on revérifie que user existe
    if (!user) {
      setError(
        "Tu dois être connecté pour modifier ton adresse email."
      );
      setSaving(false);
      return;
    }

    try {
      if (!newEmail || newEmail === user.email) {
        setInfo("L'adresse email est déjà à jour.");
        setSaving(false);
        return;
      }

      await updateEmail(user, newEmail);

      try {
        await sendEmailVerification(user);
        setInfo(
          `Ton adresse email a été mise à jour. Un email de validation a été envoyé à ${newEmail}.`
        );
      } catch (e) {
        console.error("sendEmailVerification après updateEmail:", e);
        setInfo(
          `Ton adresse email a été mise à jour en ${newEmail}, mais l'email de validation n'a pas pu être envoyé.`
        );
      }
    } catch (err: any) {
      console.error("Update email error:", err);
      const code = err?.code as string | undefined;

      if (code === "auth/invalid-email") {
        setError("L'adresse email saisie n'est pas valide.");
      } else if (code === "auth/email-already-in-use") {
        setError("Cette adresse email est déjà associée à un autre compte.");
      } else if (code === "auth/requires-recent-login") {
        setError(
          "Pour modifier ton adresse email, merci de te reconnecter puis de réessayer (mesure de sécurité)."
        );
      } else {
        setError(
          "Impossible de mettre à jour l'adresse email pour le moment. Merci de réessayer."
        );
      }
    } finally {
      setSaving(false);
    }
  }

  return (
    <div className="max-w-4xl mx-auto glass p-4 sm:p-6 text-sm">
      <h1 className="text-lg font-semibold mb-2">Profil & sécurité</h1>
      <p className="text-xs text-[var(--muted)] mb-4">
        Gère ton adresse email de connexion et le statut de validation de ton compte.
      </p>

      {info && (
        <p className="mb-3 text-xs text-emerald-400 bg-emerald-400/10 border border-emerald-400/40 rounded-md px-3 py-2">
          {info}
        </p>
      )}
      {error && (
        <p className="mb-3 text-xs text-red-400 bg-red-400/10 border border-red-400/40 rounded-md px-3 py-2">
          {error}
        </p>
      )}

      <div className="space-y-4">
        {/* Statut actuel */}
        <div>
          <h2 className="text-sm font-semibold mb-1">
            Statut de l&apos;adresse email
          </h2>
          <p className="text-xs text-[var(--muted)] mb-1">
            Adresse actuelle :{" "}
            <span className="font-medium text-[var(--ink)]">
              {user.email}
            </span>
          </p>
          <p className="text-xs">
            {user.emailVerified ? (
              <span className="text-emerald-400">
                ✅ Adresse email vérifiée. Ton compte est pleinement activé.
              </span>
            ) : (
              <span className="text-amber-300">
                ⚠️ Adresse email non vérifiée. Certaines fonctionnalités peuvent
                être restreintes tant que tu n&apos;as pas validé ton email.
              </span>
            )}
          </p>

          {!user.emailVerified && (
            <button
              type="button"
              onClick={handleResendVerification}
              disabled={sendingVerification}
              className="btn-secondary mt-2 text-xs"
            >
              {sendingVerification
                ? "Envoi en cours..."
                : "Renvoyer l’email de validation"}
            </button>
          )}
        </div>

        <hr className="border-[var(--border)]/60" />

        {/* Modification de l'email */}
        <div>
          <h2 className="text-sm font-semibold mb-2">
            Modifier mon adresse email
          </h2>
          <p className="text-xs text-[var(--muted)] mb-3">
            Utilise une adresse que tu consultes régulièrement. Pour des raisons
            de sécurité, il est possible que nous te demandions de te reconnecter
            avant de valider le changement.
          </p>

          <form
            onSubmit={handleChangeEmail}
            className="space-y-2 text-sm max-w-sm"
          >
            <div>
              <label className="block mb-1 text-xs" htmlFor="newEmail">
                Nouvelle adresse email
              </label>
              <input
                id="newEmail"
                type="email"
                className="w-full rounded-lg bg-[var(--bg-soft)] border border-[var(--border)] px-3 py-2 text-xs"
                value={newEmail}
                onChange={(e) => setNewEmail(e.target.value)}
                required
              />
            </div>

            <button
              type="submit"
              disabled={saving}
              className="btn-primary mt-1"
            >
              {saving ? "Mise à jour..." : "Mettre à jour l'adresse email"}
            </button>
          </form>
        </div>
      </div>
    </div>
  );
}
````

## File: app/app/tracker/page.tsx
````typescript
"use client";

import { useEffect, useMemo, useState, FormEvent } from "react";
import { motion } from "framer-motion";
import { auth, db } from "@/lib/firebase";
import { onAuthStateChanged } from "firebase/auth";
import {
  collection,
  query,
  where,
  orderBy,
  onSnapshot,
  addDoc,
  serverTimestamp,
  doc,
  updateDoc,
  Timestamp,
} from "firebase/firestore";

// --- TYPES ---

type ApplicationStatus = "todo" | "sent" | "interview" | "offer" | "rejected";

type Application = {
  id: string;
  userId: string;
  company: string;
  jobTitle: string;
  status: ApplicationStatus;
  location?: string;
  contract?: string;
  source?: string; // LinkedIn, Indeed, Réseau, etc.
  jobLink?: string;
  createdAt?: Date | null;
  updatedAt?: Date | null;
  lastActionDate?: Date | null;
  notes?: string;
  fromAutoCreate?: boolean; // créé depuis CV IA / LM
  hasCv?: boolean;
  hasLm?: boolean;
  hasPitch?: boolean;
  interviewAt?: Date | null; // 👉 date d'entretien
};

type FilterStatus = "all" | ApplicationStatus;
type IaFilter = "all" | "withCv" | "withLm" | "withPitch";

// --- Helpers dates ---

function formatDate(d?: Date | null) {
  if (!d) return "—";
  return d.toLocaleDateString("fr-FR", {
    day: "2-digit",
    month: "2-digit",
    year: "2-digit",
  });
}

function formatDateTime(d?: Date | null) {
  if (!d) return "Date à préciser";
  return d.toLocaleString("fr-FR", {
    weekday: "short",
    day: "2-digit",
    month: "2-digit",
    hour: "2-digit",
    minute: "2-digit",
  });
}

function dateToInputValue(d?: Date | null): string {
  if (!d) return "";
  const pad = (n: number) => String(n).padStart(2, "0");
  const year = d.getFullYear();
  const month = pad(d.getMonth() + 1);
  const day = pad(d.getDate());
  const hour = pad(d.getHours());
  const minute = pad(d.getMinutes());
  return `${year}-${month}-${day}T${hour}:${minute}`;
}

// Convertit le format 'YYYY-MM-DDTHH:MM' du datetime-local en 'yyyymmddTHHMM'
function convertToApiDatetime(isoLocalString: string): string | null {
  if (!isoLocalString) return null;
  // Ex: "2025-11-24T20:00" -> "20251124T2000"
  return isoLocalString.replace(/[-:]/g, "").replace("T", "T");
}

// Label humain pour chaque statut
function statusLabel(status: ApplicationStatus): string {
  switch (status) {
    case "todo":
      return "À envoyer";
    case "sent":
      return "Envoyée";
    case "interview":
      return "Entretien";
    case "offer":
      return "Offre";
    case "rejected":
      return "Refus";
    default:
      return status;
  }
}

// Couleurs tailwind pour le pill de statut
function statusClasses(status: ApplicationStatus): string {
  switch (status) {
    case "todo":
      return "bg-slate-800/80 text-slate-200 border-slate-600/80";
    case "sent":
      return "bg-sky-900/40 text-sky-200 border-sky-500/70";
    case "interview":
      return "bg-amber-900/40 text-amber-200 border-amber-500/70";
    case "offer":
      return "bg-emerald-900/40 text-emerald-200 border-emerald-500/70";
    case "rejected":
      return "bg-rose-900/40 text-rose-200 border-rose-500/70";
    default:
      return "bg-slate-800/80 text-slate-200 border-slate-600/80";
  }
}

export default function TrackerPage() {
  const [userId, setUserId] = useState<string | null>(null);
  const [userEmail, setUserEmail] = useState<string | null>(null);
  const [loadingAuth, setLoadingAuth] = useState(true);

  const [applications, setApplications] = useState<Application[]>([]);
  const [loadingApps, setLoadingApps] = useState(true);
  const [appsError, setAppsError] = useState<string | null>(null);

  // Pour éviter certains problèmes d'hydratation (pagination)
  const [isMounted, setIsMounted] = useState(false);

  // Filtres
  const [filterStatus, setFilterStatus] = useState<FilterStatus>("all");
  const [iaFilter, setIaFilter] = useState<IaFilter>("all");
  const [searchTerm, setSearchTerm] = useState("");

  // Pagination
  const [itemsPerPage, setItemsPerPage] = useState<number>(10);
  const [currentPage, setCurrentPage] = useState<number>(1);

  // Formulaire "nouvelle candidature"
  const [showNewForm, setShowNewForm] = useState(false);
  const [savingNew, setSavingNew] = useState(false);

  const [newCompany, setNewCompany] = useState("");
  const [newJobTitle, setNewJobTitle] = useState("");
  const [newStatus, setNewStatus] = useState<ApplicationStatus>("todo");
  const [newLocation, setNewLocation] = useState("");
  const [newContract, setNewContract] = useState("");
  const [newSource, setNewSource] = useState("");
  const [newJobLink, setNewJobLink] = useState("");
  const [newNotes, setNewNotes] = useState("");
  const [newInterviewAt, setNewInterviewAt] = useState("");

  // Édition d’une candidature (modale)
  const [editingApp, setEditingApp] = useState<Application | null>(null);
  const [editSaving, setEditSaving] = useState(false);
  const [editCompany, setEditCompany] = useState("");
  const [editJobTitle, setEditJobTitle] = useState("");
  const [editStatus, setEditStatus] = useState<ApplicationStatus>("todo");
  const [editLocation, setEditLocation] = useState("");
  const [editContract, setEditContract] = useState("");
  const [editSource, setEditSource] = useState("");
  const [editJobLink, setEditJobLink] = useState("");
  const [editNotes, setEditNotes] = useState("");
  const [editInterviewAt, setEditInterviewAt] = useState("");
  const [editHasCv, setEditHasCv] = useState(false);
  const [editHasLm, setEditHasLm] = useState(false);
  const [editHasPitch, setEditHasPitch] = useState(false);

  // --- Auth + chargement des candidatures ---

  useEffect(() => {
    setIsMounted(true);
  }, []);

  useEffect(() => {
    let unsubApps: (() => void) | null = null;

    const unsubAuth = onAuthStateChanged(auth, async (user) => {
      if (unsubApps) {
        unsubApps();
        unsubApps = null;
      }

      if (!user) {
        setUserId(null);
        setUserEmail(null);
        setApplications([]);
        setLoadingAuth(false);
        setLoadingApps(false);
        return;
      }

      setUserId(user.uid);
      setUserEmail(user.email ?? null);
      setLoadingAuth(false);

      const q = query(
        collection(db, "applications"),
        where("userId", "==", user.uid),
        orderBy("createdAt", "desc")
      );

      setLoadingApps(true);
      setAppsError(null);

      unsubApps = onSnapshot(
        q,
        (snap) => {
          const list: Application[] = snap.docs.map((docSnap) => {
            const data = docSnap.data() as any;
            return {
              id: docSnap.id,
              userId: data.userId,
              company: data.company || "",
              jobTitle: data.jobTitle || "",
              status: (data.status as ApplicationStatus) || "todo",
              location: data.location || "",
              contract: data.contract || data.contractType || "",
              source: data.source || "",
              jobLink: data.jobLink || "",
              notes: data.notes || "",
              fromAutoCreate: !!data.fromAutoCreate,
              hasCv: !!data.hasCv,
              hasLm: !!data.hasLm,
              hasPitch: !!data.hasPitch,
              createdAt: data.createdAt?.toDate ? data.createdAt.toDate() : null,
              updatedAt: data.updatedAt?.toDate ? data.updatedAt.toDate() : null,
              lastActionDate: data.lastActionDate?.toDate
                ? data.lastActionDate.toDate()
                : null,
              interviewAt: data.interviewAt?.toDate
                ? data.interviewAt.toDate()
                : null,
            };
          });
          setApplications(list);
          setLoadingApps(false);
        },
        (err) => {
          console.error("Erreur chargement candidatures:", err);
          setAppsError("Impossible de charger tes candidatures pour le moment.");
          setLoadingApps(false);
        }
      );
    });

    return () => {
      if (unsubApps) unsubApps();
      unsubAuth();
    };
  }, []);

  // --- Stats dérivées ---

  const {
    total,
    sentCount,
    interviewCount,
    offerCount,
    todoCount,
    trackedWithCv,
    trackedWithLm,
  } = useMemo(() => {
    const total = applications.length;
    let sentCount = 0;
    let interviewCount = 0;
    let offerCount = 0;
    let todoCount = 0;
    let trackedWithCv = 0;
    let trackedWithLm = 0;

    applications.forEach((app) => {
      if (app.status === "sent") sentCount++;
      if (app.status === "interview") interviewCount++;
      if (app.status === "offer") offerCount++;
      if (app.status === "todo") todoCount++;
      if (app.hasCv) trackedWithCv++;
      if (app.hasLm) trackedWithLm++;
    });

    return {
      total,
      sentCount,
      interviewCount,
      offerCount,
      todoCount,
      trackedWithCv,
      trackedWithLm,
    };
  }, [applications]);

  // Filtres combinés (statut + recherche + IA)
  const filteredApps = useMemo(() => {
    let list = [...applications];

    if (filterStatus !== "all") {
      list = list.filter((a) => a.status === filterStatus);
    }

    if (searchTerm.trim()) {
      const term = searchTerm.toLowerCase();
      list = list.filter(
        (a) =>
          a.company.toLowerCase().includes(term) ||
          a.jobTitle.toLowerCase().includes(term)
      );
    }

    if (iaFilter === "withCv") {
      list = list.filter((a) => a.hasCv);
    } else if (iaFilter === "withLm") {
      list = list.filter((a) => a.hasLm);
    } else if (iaFilter === "withPitch") {
      list = list.filter((a) => a.hasPitch);
    }

    return list;
  }, [applications, filterStatus, searchTerm, iaFilter]);

  // Pagination
  const totalPages = Math.max(
    1,
    Math.ceil((filteredApps.length || 1) / itemsPerPage)
  );

  useEffect(() => {
    setCurrentPage(1);
  }, [filterStatus, searchTerm, iaFilter, itemsPerPage]);

  const paginatedApps = useMemo(() => {
    const start = (currentPage - 1) * itemsPerPage;
    return filteredApps.slice(start, start + itemsPerPage);
  }, [filteredApps, currentPage, itemsPerPage]);

  // Agenda : entretiens à venir
  const upcomingInterviews = useMemo(() => {
    const now = new Date();
    const withDate = applications.filter(
      (a) =>
        a.interviewAt &&
        a.interviewAt.getTime() >= now.getTime()
    );
    withDate.sort(
      (a, b) =>
        (a.interviewAt?.getTime() || 0) - (b.interviewAt?.getTime() || 0)
    );
    return withDate;
  }, [applications]);

  const visibilityLabel = userId ? "Associé à ton compte" : "Invité";

  // --- Création d'une nouvelle candidature (avec interviewAt) ---

  const handleAddApplication = async (e: FormEvent) => {
    e.preventDefault();
    if (!userId) return;

    if (!newCompany.trim() || !newJobTitle.trim()) {
      return;
    }

    setSavingNew(true);

    try {
      const interviewAtDate = newInterviewAt
        ? new Date(newInterviewAt)
        : null;

      const firestoreData: any = {
        userId,
        company: newCompany.trim(),
        jobTitle: newJobTitle.trim(),
        status: newStatus,
        location: newLocation.trim(),
        contract: newContract.trim(),
        source: newSource.trim(),
        jobLink: newJobLink.trim(),
        notes: newNotes.trim(),
        fromAutoCreate: false,
        hasCv: false,
        hasLm: false,
        hasPitch: false,
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp(),
        lastActionDate: serverTimestamp(),
      };

      if (interviewAtDate) {
        firestoreData.interviewAt = Timestamp.fromDate(interviewAtDate);
      }

      await addDoc(collection(db, "applications"), firestoreData);

      // Optionnel : simulation d'appel API calendrier
      if (newInterviewAt) {
        const start_datetime = convertToApiDatetime(newInterviewAt);
        if (start_datetime) {
          console.log("CALENDAR API: Create Event (New Application)", {
            title: `Entretien - ${newJobTitle.trim()} chez ${newCompany.trim()}`,
            start_datetime,
            duration: "1h",
            location: newLocation.trim(),
            description: `Lien: ${newJobLink.trim()} | Notes: ${newNotes.trim()}`,
          });
        }
      }

      // reset formulaire
      setNewCompany("");
      setNewJobTitle("");
      setNewStatus("todo");
      setNewLocation("");
      setNewContract("");
      setNewSource("");
      setNewJobLink("");
      setNewNotes("");
      setNewInterviewAt("");
      setShowNewForm(false);
    } catch (err) {
      console.error("Erreur ajout candidature:", err);
    } finally {
      setSavingNew(false);
    }
  };

  // --- Edition d'une candidature (modale) ---

  const openEditModal = (app: Application) => {
    setEditingApp(app);
    setEditCompany(app.company || "");
    setEditJobTitle(app.jobTitle || "");
    setEditStatus(app.status || "todo");
    setEditLocation(app.location || "");
    setEditContract(app.contract || "");
    setEditSource(app.source || "");
    setEditJobLink(app.jobLink || "");
    setEditNotes(app.notes || "");
    setEditInterviewAt(dateToInputValue(app.interviewAt || null));
    setEditHasCv(!!app.hasCv);
    setEditHasLm(!!app.hasLm);
    setEditHasPitch(!!app.hasPitch);
  };

  const closeEditModal = () => {
    setEditingApp(null);
  };

  const handleEditApplication = async (e: FormEvent) => {
    e.preventDefault();
    if (!userId || !editingApp) return;

    setEditSaving(true);

    try {
      const interviewAtDate = editInterviewAt
        ? new Date(editInterviewAt)
        : null;

      const updatedFields: any = {
        company: editCompany.trim(),
        jobTitle: editJobTitle.trim(),
        status: editStatus,
        location: editLocation.trim(),
        contract: editContract.trim(),
        source: editSource.trim(),
        jobLink: editJobLink.trim(),
        notes: editNotes.trim(),
        hasCv: editHasCv,
        hasLm: editHasLm,
        hasPitch: editHasPitch,
        updatedAt: serverTimestamp(),
        lastActionDate: serverTimestamp(),
      };

      if (interviewAtDate) {
        updatedFields.interviewAt = Timestamp.fromDate(interviewAtDate);
      } else {
        updatedFields.interviewAt = null;
      }

      await updateDoc(doc(db, "applications", editingApp.id), updatedFields);

      // Optionnel : simulation d'appel API calendrier
      if (editInterviewAt) {
        const start_datetime = convertToApiDatetime(editInterviewAt);
        if (start_datetime) {
          console.log("CALENDAR API: Create/Update Event (Edited Application)", {
            title: `Entretien - ${editJobTitle.trim()} chez ${editCompany.trim()}`,
            start_datetime,
            duration: "1h",
            location: editLocation.trim(),
            description: `Lien: ${editJobLink.trim()} | Notes: ${editNotes.trim()}`,
          });
        }
      }

      setEditingApp(null);
    } catch (err) {
      console.error("Erreur mise à jour candidature:", err);
    } finally {
      setEditSaving(false);
    }
  };

  // --- Pagination buttons ---

  const paginationButtons = useMemo(() => {
    const pages: (number | string)[] = [];
    if (totalPages <= 6) {
      for (let i = 1; i <= totalPages; i++) pages.push(i);
    } else {
      pages.push(1);
      const left = Math.max(2, currentPage - 1);
      const right = Math.min(totalPages - 1, currentPage + 1);
      if (left > 2) pages.push("...");
      for (let i = left; i <= right; i++) pages.push(i);
      if (right < totalPages - 1) pages.push("...");
      pages.push(totalPages);
    }
    return pages;
  }, [currentPage, totalPages]);

  // --- RENDER ---

  if (!loadingAuth && !userId) {
    return (
      <motion.div
        initial={{ opacity: 0, y: 8 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ duration: 0.2 }}
        className="max-w-2xl mx-auto px-3 sm:px-4 py-8"
      >
        <section className="glass rounded-2xl border border-[var(--border)]/80 p-5 text-center space-y-3">
          <h1 className="text-lg sm:text-xl font-semibold">
            Suivi de candidatures
          </h1>
          <p className="text-sm text-[var(--muted)]">
            Connecte-toi pour voir et suivre toutes tes candidatures (CV + LM
            générés, entretiens, offres…).
          </p>
          <p className="text-xs text-[var(--muted)]">
            Depuis l&apos;assistant de candidature, coche l&apos;option{" "}
            <strong>“Créer une entrée dans le Suivi 📌”</strong> pour qu&apos;une
            ligne soit créée automatiquement ici.
          </p>
        </section>
      </motion.div>
    );
  }

  return (
    <motion.div
      initial={{ opacity: 0, y: 12 }}
      animate={{ opacity: 1, y: 0 }}
      transition={{ duration: 0.25 }}
      className="max-w-5xl mx-auto px-3 sm:px-4 py-5 sm:py-6 space-y-4"
    >
      {/* HEADER */}
      <section className="space-y-3">
        <div className="flex flex-wrap items-center justify-between gap-2">
          <p className="badge-muted flex items-center gap-1.5">
            <span className="w-1.5 h-1.5 rounded-full bg-emerald-400" />
            <span className="text-[11px] uppercase tracking-wider">
              Suivi de candidatures
            </span>
          </p>

          <div className="flex flex-wrap items-center gap-2 text-[11px]">
            <span className="inline-flex items-center rounded-full border border-[var(--border)] px-2 py-[2px]">
              Profil IA :{" "}
              <span className="ml-1 font-medium">
                {userEmail || "Connecté"}
              </span>
            </span>
            <span className="inline-flex items-center rounded-full border border-[var(--border)] px-2 py-[2px]">
              Visibilité :{" "}
              <span className="ml-1 font-medium">{visibilityLabel}</span>
            </span>
          </div>
        </div>

        <div className="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
          <div className="space-y-1">
            <h1 className="text-lg sm:text-xl font-semibold">
              Ton tableau de bord de candidatures
            </h1>
            <p className="text-[12px] text-[var(--muted)] max-w-xl">
              Visualise où tu en es sur chaque candidature : envoyée, en
              attente, entretien, offre ou refus. Les candidatures créées
              depuis l&apos;assistant de CV IA apparaissent automatiquement
              ici.
            </p>
          </div>

          <button
            type="button"
            onClick={() => setShowNewForm((v) => !v)}
            className="btn-primary text-xs sm:text-sm"
          >
            {showNewForm ? "Fermer le formulaire" : "Ajouter une candidature"}
          </button>
        </div>
      </section>

      {/* STATS */}
      <section className="grid grid-cols-2 sm:grid-cols-5 gap-2 sm:gap-3">
        <div className="glass border border-[var(--border)]/80 rounded-xl px-3 py-2.5 text-xs">
          <p className="text-[var(--muted)] mb-0.5">Total</p>
          <p className="text-lg font-semibold">{total}</p>
        </div>
        <div className="glass border border-[var(--border)]/80 rounded-xl px-3 py-2.5 text-xs">
          <p className="text-[var(--muted)] mb-0.5">À envoyer</p>
          <p className="text-lg font-semibold">{todoCount}</p>
        </div>
        <div className="glass border border-[var(--border)]/80 rounded-xl px-3 py-2.5 text-xs">
          <p className="text-[var(--muted)] mb-0.5">Candidatures envoyées</p>
          <p className="text-lg font-semibold">{sentCount}</p>
        </div>
        <div className="glass border border-[var(--border)]/80 rounded-xl px-3 py-2.5 text-xs">
          <p className="text-[var(--muted)] mb-0.5">Entretiens</p>
          <p className="text-lg font-semibold">{interviewCount}</p>
        </div>
        <div className="glass border border-[var(--border)]/80 rounded-xl px-3 py-2.5 text-xs">
          <p className="text-[var(--muted)] mb-0.5">Offres</p>
          <p className="text-lg font-semibold">{offerCount}</p>
        </div>
      </section>

      {/* MINI STATS IA (CV / LM liés) */}
      <section className="grid grid-cols-2 sm:grid-cols-3 gap-2 sm:gap-3">
        <div className="glass border border-[var(--border)]/80 rounded-xl px-3 py-2.5 text-xs">
          <p className="text-[var(--muted)] mb-0.5">Candidatures avec CV IA</p>
          <p className="text-lg font-semibold">{trackedWithCv}</p>
          <p className="text-[10px] text-[var(--muted)] mt-0.5">
            Candidatures où tu as coché ou généré un CV IA.
          </p>
        </div>
        <div className="glass border border-[var(--border)]/80 rounded-xl px-3 py-2.5 text-xs">
          <p className="text-[var(--muted)] mb-0.5">Candidatures avec LM IA</p>
          <p className="text-lg font-semibold">{trackedWithLm}</p>
          <p className="text-[10px] text-[var(--muted)] mt-0.5">
            Candidatures où tu as coché ou généré une lettre IA.
          </p>
        </div>
        <div className="glass border border-[var(--border)]/80 rounded-xl px-3 py-2.5 text-xs">
          <p className="text-[var(--muted)] mb-0.5">Candidatures suivies</p>
          <p className="text-lg font-semibold">{total}</p>
          <p className="text-[10px] text-[var(--muted)] mt-0.5">
            Total de lignes dans ton tracker actuel.
          </p>
        </div>
      </section>

      {/* AGENDA ENTRETIENS À VENIR */}
      <section className="glass border border-[var(--border)]/80 rounded-2xl p-4 sm:p-5 space-y-3">
        <div className="flex items-center justify-between gap-2">
          <div className="flex items-center gap-2">
            <span className="inline-flex h-7 w-7 items-center justify-center rounded-full bg-[var(--bg-soft)] border border-[var(--border)] text-sm">
              📅
            </span>
            <div>
              <h2 className="text-sm sm:text-base font-semibold">
                Agenda — Entretiens à venir
              </h2>
              <p className="text-[11px] text-[var(--muted)]">
                Toutes les candidatures avec une date d&apos;entretien future
                apparaissent ici.
              </p>
            </div>
          </div>
          <span className="text-[11px] rounded-full border border-[var(--border)] px-2 py-[2px] text-[var(--muted)]">
            {upcomingInterviews.length} entretien
            {upcomingInterviews.length > 1 ? "s" : ""} à venir
          </span>
        </div>

        {upcomingInterviews.length === 0 ? (
          <p className="text-[12px] text-[var(--muted)]">
            Aucun entretien programmé. Quand tu ajoutes une date d&apos;entretien
            dans une candidature (champ &quot;Date / heure de l&apos;entretien&quot;),
            elle apparaît ici.
          </p>
        ) : (
          <div className="space-y-2 text-[12px]">
            {upcomingInterviews.slice(0, 5).map((app) => (
              <div
                key={app.id}
                className="flex items-start gap-3 rounded-lg border border-[var(--border)]/70 bg-[var(--bg-soft)] px-3 py-2.5"
              >
                <div className="mt-1 text-[18px]">🕒</div>
                <div className="flex-1 min-w-0">
                  <p className="font-medium truncate">
                    {app.jobTitle || "Poste"}{" "}
                    {app.company && (
                      <span className="text-[11px] text-[var(--muted)]">
                        · {app.company}
                      </span>
                    )}
                  </p>
                  <p className="text-[11px] text-[var(--muted)]">
                    {formatDateTime(app.interviewAt)}
                  </p>
                  <div className="mt-1 flex flex-wrap gap-1.5 text-[10px] text-[var(--muted)]">
                    {app.location && (
                      <span className="inline-flex items-center gap-1 px-1.5 py-[1px] rounded-full bg-slate-900/70">
                        📍 {app.location}
                      </span>
                    )}
                    {app.source && (
                      <span className="inline-flex items-center gap-1 px-1.5 py-[1px] rounded-full bg-slate-900/70">
                        🌐 {app.source}
                      </span>
                    )}
                  </div>
                </div>
              </div>
            ))}
          </div>
        )}
      </section>

      {/* FORMULAIRE NOUVELLE CANDIDATURE */}
      {showNewForm && (
        <section className="glass border border-[var(--border)]/80 rounded-2xl p-4 sm:p-5 space-y-3">
          <div className="flex items-center justify-between gap-2">
            <h2 className="text-base sm:text-lg font-semibold">
              Ajouter une candidature
            </h2>
            {savingNew && (
              <div className="flex items-center gap-2 text-[11px] text-[var(--muted)]">
                <div className="loader" />
                <span>Sauvegarde en cours…</span>
              </div>
            )}
          </div>

          <form
            onSubmit={handleAddApplication}
            className="space-y-3 text-[13px]"
          >
            <div className="grid sm:grid-cols-2 gap-3">
              <div>
                <label className="block text-[11px] mb-1 text-[var(--muted)]">
                  Entreprise
                </label>
                <input
                  type="text"
                  className="input text-[var(--ink)] bg-[var(--bg)] placeholder:text-[var(--muted)]"
                  placeholder="Ex : IMOGATE"
                  value={newCompany}
                  onChange={(e) => setNewCompany(e.target.value)}
                  required
                />
              </div>
              <div>
                <label className="block text-[11px] mb-1 text-[var(--muted)]">
                  Intitulé du poste
                </label>
                <input
                  type="text"
                  className="input text-[var(--ink)] bg-[var(--bg)] placeholder:text-[var(--muted)]"
                  placeholder="Ex : Ingénieur Réseaux & Sécurité"
                  value={newJobTitle}
                  onChange={(e) => setNewJobTitle(e.target.value)}
                  required
                />
              </div>
            </div>

            <div className="grid sm:grid-cols-3 gap-3">
              <div>
                <label className="block text-[11px] mb-1 text-[var(--muted)]">
                  Statut
                </label>
                <select
                  className="select-brand text-[var(--ink)] bg-[var(--bg-soft)]"
                  value={newStatus}
                  onChange={(e) =>
                    setNewStatus(e.target.value as ApplicationStatus)
                  }
                >
                  <option value="todo">À envoyer</option>
                  <option value="sent">Envoyée</option>
                  <option value="interview">Entretien</option>
                  <option value="offer">Offre</option>
                  <option value="rejected">Refus</option>
                </select>
              </div>
              <div>
                <label className="block text-[11px] mb-1 text-[var(--muted)]">
                  Contrat (CDI, Stage…)
                </label>
                <input
                  type="text"
                  className="input text-[var(--ink)] bg-[var(--bg)] placeholder:text-[var(--muted)]"
                  placeholder="Ex : CDI, Alternance…"
                  value={newContract}
                  onChange={(e) => setNewContract(e.target.value)}
                />
              </div>
              <div>
                <label className="block text-[11px] mb-1 text-[var(--muted)]">
                  Lieu
                </label>
                <input
                  type="text"
                  className="input text-[var(--ink)] bg-[var(--bg)] placeholder:text-[var(--muted)]"
                  placeholder="Ex : Paris, Remote…"
                  value={newLocation}
                  onChange={(e) => setNewLocation(e.target.value)}
                />
              </div>
            </div>

            <div className="grid sm:grid-cols-2 gap-3">
              <div>
                <label className="block text-[11px] mb-1 text-[var(--muted)]">
                  Source
                </label>
                <input
                  type="text"
                  className="input text-[var(--ink)] bg-[var(--bg)] placeholder:text-[var(--muted)]"
                  placeholder="Ex : LinkedIn, Indeed, Réseau…"
                  value={newSource}
                  onChange={(e) => setNewSource(e.target.value)}
                />
              </div>
              <div>
                <label className="block text-[11px] mb-1 text-[var(--muted)]">
                  Lien de l&apos;offre
                </label>
                <input
                  type="url"
                  className="input text-[var(--ink)] bg-[var(--bg)] placeholder:text-[var(--muted)]"
                  placeholder="https://"
                  value={newJobLink}
                  onChange={(e) => setNewJobLink(e.target.value)}
                />
              </div>
            </div>

            <div className="grid sm:grid-cols-2 gap-3">
              <div>
                <label className="block text-[11px] mb-1 text-[var(--muted)]">
                  Date / heure de l&apos;entretien (optionnel)
                </label>
                <input
                  type="datetime-local"
                  className="input text-[var(--ink)] bg-[var(--bg)]"
                  value={newInterviewAt}
                  onChange={(e) => setNewInterviewAt(e.target.value)}
                />
              </div>
            </div>

            <div>
              <label className="block text-[11px] mb-1 text-[var(--muted)]">
                Notes (rappels, contacts, prochaines étapes…)
              </label>
              <textarea
                rows={3}
                className="input textarea text-[var(--ink)] bg-[var(--bg)] placeholder:text-[var(--muted)]"
                placeholder="Ex : Relancer dans 5 jours, entretien technique prévu, contact RH…"
                value={newNotes}
                onChange={(e) => setNewNotes(e.target.value)}
              />
            </div>

            <div className="flex flex-wrap gap-2 justify-end pt-1">
              <button
                type="button"
                onClick={() => setShowNewForm(false)}
                className="btn-secondary"
              >
                Annuler
              </button>
              <button
                type="submit"
                disabled={savingNew}
                className="btn-primary relative"
              >
                <span>
                  {savingNew ? "Ajout en cours..." : "Enregistrer la candidature"}
                </span>
                <div
                  className={`loader absolute inset-0 m-auto ${
                    savingNew ? "" : "hidden"
                  }`}
                />
              </button>
            </div>
          </form>
        </section>
      )}

      {/* RECHERCHE + FILTRES + LIMITE */}
      <section className="space-y-3">
        {/* Recherche + filtre statut */}
        <div className="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
          <div className="relative w-full sm:max-w-xs">
            <input
              type="text"
              className="input pl-8 text-[12px] bg-[var(--bg)] placeholder:text-[var(--muted)]"
              placeholder="Rechercher par entreprise ou poste…"
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
            />
            <span className="absolute left-2.5 top-1/2 -translate-y-1/2 text-[var(--muted)] text-[14px]">
              🔍
            </span>
          </div>

          <div className="flex flex-wrap gap-1.5 text-[11px]">
            {[
              { key: "all", label: "Toutes" },
              { key: "todo", label: "À envoyer" },
              { key: "sent", label: "Envoyées" },
              { key: "interview", label: "Entretiens" },
              { key: "offer", label: "Offres" },
              { key: "rejected", label: "Refus" },
            ].map((f) => {
              const active = filterStatus === f.key;
              return (
                <button
                  key={f.key}
                  type="button"
                  onClick={() => setFilterStatus(f.key as FilterStatus)}
                  className={`inline-flex items-center gap-1 rounded-full border px-2.5 py-[4px] transition-colors ${
                    active
                      ? "border-[var(--brand)] bg-[var(--brand)]/10 text-[var(--ink)]"
                      : "border-[var(--border)]/80 text-[var(--muted)] hover:text-[var(--ink)] hover:bg-[var(--bg-soft)]"
                  }`}
                >
                  <span>{f.label}</span>
                  {f.key === "all" && total > 0 && (
                    <span className="text-[10px] opacity-80">({total})</span>
                  )}
                </button>
              );
            })}
          </div>
        </div>

        {/* Filtres IA + limite par page */}
        <div className="flex flex-wrap items-center justify-between gap-2 text-[11px]">
          <div className="flex flex-wrap gap-1.5">
            {[
              { key: "all", label: "Toutes" },
              { key: "withCv", label: "Avec CV IA" },
              { key: "withLm", label: "Avec LM IA" },
              { key: "withPitch", label: "Avec Pitch" },
            ].map((f) => {
              const active = iaFilter === f.key;
              return (
                <button
                  key={f.key}
                  type="button"
                  onClick={() => setIaFilter(f.key as IaFilter)}
                  className={`inline-flex items-center gap-1 rounded-full border px-2.5 py-[3px] transition-colors ${
                    active
                      ? "border-[var(--brand)] bg-[var(--brand)]/10 text-[var(--ink)]"
                      : "border-[var(--border)]/80 text-[var(--muted)] hover:text-[var(--ink)] hover:bg-[var(--bg-soft)]"
                  }`}
                >
                  <span>{f.label}</span>
                </button>
              );
            })}
          </div>

          <div className="flex items-center gap-1.5">
            <span className="text-[var(--muted)]">Par page :</span>
            <select
              className="border border-[var(--border)] bg-[var(--bg-soft)] rounded-full px-2 py-[3px] text-[11px]"
              value={itemsPerPage}
              onChange={(e) => setItemsPerPage(Number(e.target.value))}
            >
              <option value={10}>10</option>
              <option value={20}>20</option>
              <option value={50}>50</option>
            </select>
          </div>
        </div>

        {/* État de chargement / erreurs */}
        {loadingApps && (
          <div className="glass border border-[var(--border)]/80 rounded-xl p-4 flex items-center gap-3 text-[13px] text-[var(--muted)]">
            <div className="loader" />
            <span>Chargement de tes candidatures…</span>
          </div>
        )}

        {appsError && (
          <div className="glass border border-rose-500/60 rounded-xl p-3 text-[12px] text-rose-200">
            {appsError}
          </div>
        )}

        {!loadingApps && !appsError && filteredApps.length === 0 && (
          <div className="glass border border-[var(--border)]/80 rounded-xl p-4 text-center text-[13px] text-[var(--muted)]">
            <p className="mb-1">Aucune candidature à afficher pour ce filtre.</p>
            <p className="text-[11px]">
              Ajoute une candidature manuellement ou coche l&apos;option{" "}
              <strong>“Créer une entrée dans le Suivi 📌”</strong> dans
              l&apos;assistant de CV IA.
            </p>
          </div>
        )}

        {/* Liste des candidatures */}
        <div className="space-y-2">
          {paginatedApps.map((app) => (
            <div
              key={app.id}
              className="glass border border-[var(--border)]/80 rounded-xl px-3.5 py-3 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2"
            >
              {/* Colonne gauche */}
              <div className="flex-1 min-w-0">
                <div className="flex flex-wrap items-center gap-1.5">
                  <p className="font-medium text-[14px] truncate">
                    {app.jobTitle || "Poste sans intitulé"}
                  </p>
                  {app.company && (
                    <span className="text-[11px] text-[var(--muted)]">
                      · {app.company}
                    </span>
                  )}
                </div>

                <div className="mt-1 flex flex-wrap gap-1.5 text-[10.5px] text-[var(--muted)]">
                  {app.location && (
                    <span className="inline-flex items-center gap-1 px-1.5 py-[1px] rounded-full bg-slate-900/70">
                      📍 {app.location}
                    </span>
                  )}
                  {app.contract && (
                    <span className="inline-flex items-center gap-1 px-1.5 py-[1px] rounded-full bg-slate-900/70">
                      📄 {app.contract}
                    </span>
                  )}
                  {app.source && (
                    <span className="inline-flex items-center gap-1 px-1.5 py-[1px] rounded-full bg-slate-900/70">
                      🌐 {app.source}
                    </span>
                  )}
                  {app.fromAutoCreate && (
                    <span className="inline-flex items-center gap-1 px-1.5 py-[1px] rounded-full bg-[var(--brand)]/15 text-[var(--brand)] border border-[var(--brand)]/50">
                      🤖 Depuis CV IA
                    </span>
                  )}
                </div>

                <div className="mt-1 text-[11px] text-[var(--muted)] flex flex-wrap gap-2">
                  <span>
                    Créée : <strong>{formatDate(app.createdAt)}</strong>
                  </span>
                  {app.lastActionDate && (
                    <span>
                      Dernière action :{" "}
                      <strong>{formatDate(app.lastActionDate)}</strong>
                    </span>
                  )}
                  {app.interviewAt && (
                    <span>
                      Entretien :{" "}
                      <strong>{formatDateTime(app.interviewAt)}</strong>
                    </span>
                  )}
                </div>

                {app.notes && (
                  <p className="mt-1 text-[11px] text-[var(--muted)] line-clamp-2">
                    {app.notes}
                  </p>
                )}

                {app.jobLink && (
                  <a
                    href={app.jobLink}
                    target="_blank"
                    rel="noreferrer"
                    className="mt-1 inline-flex items-center gap-1 text-[11px] text-[var(--brand)] hover:underline"
                  >
                    Voir l&apos;offre
                    <span aria-hidden>↗</span>
                  </a>
                )}
              </div>

              {/* Colonne droite : statut + badges IA + bouton éditer */}
              <div className="flex flex-col items-end gap-1 min-w-[170px]">
                <span
                  className={`inline-flex items-center justify-center px-2 py-[3px] text-[11px] border rounded-full ${statusClasses(
                    app.status
                  )}`}
                >
                  {statusLabel(app.status)}
                </span>

                <div className="flex flex-wrap justify-end gap-1 text-[10px] text-[var(--muted)] mt-1">
                  {app.hasCv && (
                    <span className="inline-flex items-center gap-1 px-1.5 py-[1px] rounded-full border border-[var(--border)] bg-[var(--bg-soft)]">
                      ✅ CV IA
                    </span>
                  )}
                  {app.hasLm && (
                    <span className="inline-flex items-center gap-1 px-1.5 py-[1px] rounded-full border border-[var(--border)] bg-[var(--bg-soft)]">
                      ✉️ LM IA
                    </span>
                  )}
                  {app.hasPitch && (
                    <span className="inline-flex items-center gap-1 px-1.5 py-[1px] rounded-full border border-[var(--border)] bg-[var(--bg-soft)]">
                      🎙️ Pitch
                    </span>
                  )}
                </div>

                <button
                  type="button"
                  onClick={() => openEditModal(app)}
                  className="mt-1 inline-flex items-center gap-1 rounded-full border border-[var(--border)] bg-[var(--bg-soft)] px-2 py-[2px] text-[10px] text-[var(--muted)] hover:border-[var(--brand)] hover:text-[var(--brand)] transition-colors"
                >
                  <span className="text-[12px]">✏️</span>
                  <span>Modifier</span>
                </button>
              </div>
            </div>
          ))}
        </div>

        {/* PAGINATION */}
        {filteredApps.length > 0 && isMounted && (
          <div className="max-w-5xl mx-auto mt-4 flex justify-center items-center gap-2 text-[11px]">
            <button
              type="button"
              className="px-2.5 py-1 rounded-full border border-[var(--border)] bg-[var(--bg-soft)] disabled:opacity-40 disabled:cursor-not-allowed hover:bg-[var(--bg)]"
              onClick={() =>
                setCurrentPage((p) => (p > 1 ? p - 1 : p))
              }
              disabled={currentPage === 1}
            >
              Précédent
            </button>

            {paginationButtons.map((p, idx) =>
              typeof p === "number" ? (
                <button
                  key={idx}
                  type="button"
                  onClick={() => setCurrentPage(p)}
                  className={`px-2.5 py-1 rounded-full border text-[11px] ${
                    p === currentPage
                      ? "border-[var(--brand)] bg-[var(--brand)]/20"
                      : "border-[var(--border)] bg-[var(--bg-soft)] hover:bg-[var(--bg)]"
                  }`}
                >
                  {p}
                </button>
              ) : (
                <span key={idx} className="px-2 py-1">
                  …
                </span>
              )
            )}

            <button
              type="button"
              className="px-2.5 py-1 rounded-full border border-[var(--border)] bg-[var(--bg-soft)] disabled:opacity-40 disabled:cursor-not-allowed hover:bg-[var(--bg)]"
              onClick={() =>
                setCurrentPage((p) =>
                  p < totalPages ? p + 1 : p
                )
              }
              disabled={currentPage === totalPages}
            >
              Suivant
            </button>

            <div className="ml-4 text-[var(--muted)]">
              Page {currentPage} sur {totalPages}
            </div>
          </div>
        )}
      </section>

      {/* MODALE EDIT CANDIDATURE */}
      {editingApp && (
        <div className="fixed inset-0 z-40 flex items-center justify-center bg-black/60 px-3">
          <motion.form
            onSubmit={handleEditApplication}
            initial={{ opacity: 0, y: 16, scale: 0.97 }}
            animate={{ opacity: 1, y: 0, scale: 1 }}
            exit={{ opacity: 0, y: 16, scale: 0.97 }}
            className="w-full max-w-lg rounded-2xl bg-[var(--bg)] border border-[var(--border)] shadow-xl p-4 sm:p-5 space-y-4"
          >
            <div className="flex items-center justify-between gap-2">
              <h3 className="text-sm sm:text-base font-semibold">
                Modifier la candidature
              </h3>
              <button
                type="button"
                onClick={closeEditModal}
                className="rounded-full px-2 py-1 text-[11px] text-[var(--muted)] hover:bg-[var(--bg-soft)]"
              >
                ✕
              </button>
            </div>

            <div className="space-y-3 max-h-[70vh] overflow-auto pr-1 text-[13px]">
              <div className="grid sm:grid-cols-2 gap-3">
                <div>
                  <label className="block text-[11px] mb-1 text-[var(--muted)]">
                    Entreprise
                  </label>
                  <input
                    type="text"
                    className="input text-[var(--ink)] bg-[var(--bg-soft)]"
                    value={editCompany}
                    onChange={(e) => setEditCompany(e.target.value)}
                  />
                </div>
                <div>
                  <label className="block text-[11px] mb-1 text-[var(--muted)]">
                    Intitulé du poste
                  </label>
                  <input
                    type="text"
                    className="input text-[var(--ink)] bg-[var(--bg-soft)]"
                    value={editJobTitle}
                    onChange={(e) => setEditJobTitle(e.target.value)}
                  />
                </div>
              </div>

              <div className="grid sm:grid-cols-3 gap-3">
                <div>
                  <label className="block text-[11px] mb-1 text-[var(--muted)]">
                    Statut
                  </label>
                  <select
                    className="select-brand text-[var(--ink)] bg-[var(--bg-soft)]"
                    value={editStatus}
                    onChange={(e) =>
                      setEditStatus(e.target.value as ApplicationStatus)
                    }
                  >
                    <option value="todo">À envoyer</option>
                    <option value="sent">Envoyée</option>
                    <option value="interview">Entretien</option>
                    <option value="offer">Offre</option>
                    <option value="rejected">Refus</option>
                  </select>
                </div>
                <div>
                  <label className="block text-[11px] mb-1 text-[var(--muted)]">
                    Contrat
                  </label>
                  <input
                    type="text"
                    className="input text-[var(--ink)] bg-[var(--bg-soft)]"
                    value={editContract}
                    onChange={(e) => setEditContract(e.target.value)}
                  />
                </div>
                <div>
                  <label className="block text-[11px] mb-1 text-[var(--muted)]">
                    Lieu
                  </label>
                  <input
                    type="text"
                    className="input text-[var(--ink)] bg-[var(--bg-soft)]"
                    value={editLocation}
                    onChange={(e) => setEditLocation(e.target.value)}
                  />
                </div>
              </div>

              <div className="grid sm:grid-cols-2 gap-3">
                <div>
                  <label className="block text-[11px] mb-1 text-[var(--muted)]">
                    Source
                  </label>
                  <input
                    type="text"
                    className="input text-[var(--ink)] bg-[var(--bg-soft)]"
                    value={editSource}
                    onChange={(e) => setEditSource(e.target.value)}
                  />
                </div>
                <div>
                  <label className="block text-[11px] mb-1 text-[var(--muted)]">
                    Lien de l&apos;offre
                  </label>
                  <input
                    type="url"
                    className="input text-[var(--ink)] bg-[var(--bg-soft)]"
                    value={editJobLink}
                    onChange={(e) => setEditJobLink(e.target.value)}
                  />
                </div>
              </div>

              <div className="grid sm:grid-cols-2 gap-3">
                <div>
                  <label className="block text-[11px] mb-1 text-[var(--muted)]">
                    Date / heure de l&apos;entretien
                  </label>
                  <input
                    type="datetime-local"
                    className="input text-[var(--ink)] bg-[var(--bg-soft)]"
                    value={editInterviewAt}
                    onChange={(e) => setEditInterviewAt(e.target.value)}
                  />
                </div>
              </div>

              <div>
                <label className="block text-[11px] mb-1 text-[var(--muted)]">
                  Notes
                </label>
                <textarea
                  rows={3}
                  className="input textarea text-[var(--ink)] bg-[var(--bg-soft)]"
                  value={editNotes}
                  onChange={(e) => setEditNotes(e.target.value)}
                />
              </div>

              <div className="flex flex-wrap gap-3 text-[11px]">
                <label className="inline-flex items-center gap-1 cursor-pointer">
                  <input
                    type="checkbox"
                    className="h-3 w-3 rounded border-[var(--border)] bg-[var(--bg)]"
                    checked={editHasCv}
                    onChange={(e) => setEditHasCv(e.target.checked)}
                  />
                  <span>CV IA associé</span>
                </label>
                <label className="inline-flex items-center gap-1 cursor-pointer">
                  <input
                    type="checkbox"
                    className="h-3 w-3 rounded border-[var(--border)] bg-[var(--bg)]"
                    checked={editHasLm}
                    onChange={(e) => setEditHasLm(e.target.checked)}
                  />
                  <span>LM IA associée</span>
                </label>
                <label className="inline-flex items-center gap-1 cursor-pointer">
                  <input
                    type="checkbox"
                    className="h-3 w-3 rounded border-[var(--border)] bg-[var(--bg)]"
                    checked={editHasPitch}
                    onChange={(e) => setEditHasPitch(e.target.checked)}
                  />
                  <span>Pitch IA associé</span>
                </label>
              </div>
            </div>

            <div className="flex justify-end gap-2 pt-2">
              <button
                type="button"
                onClick={closeEditModal}
                className="inline-flex items-center justify-center rounded-lg border border-[var(--border)] bg-[var(--bg-soft)] px-3 py-1.5 text-[12px] text-[var(--muted)] hover:bg-[var(--bg)] transition-colors"
              >
                Annuler
              </button>
              <button
                type="submit"
                disabled={editSaving}
                className="inline-flex items-center justify-center rounded-lg bg-[var(--brand)] hover:bg-[var(--brandDark)] px-3 py-1.5 text-[12px] font-medium text-white transition-colors relative"
              >
                <span>
                  {editSaving ? "Enregistrement..." : "Enregistrer"}
                </span>
                <div
                  className={`loader absolute inset-0 m-auto ${
                    editSaving ? "" : "hidden"
                  }`}
                />
              </button>
            </div>
          </motion.form>
        </div>
      )}
    </motion.div>
  );
}
````

## File: app/app/layout.tsx
````typescript
"use client";

import { ReactNode, useEffect, useState } from "react";
import Link from "next/link";
import { usePathname, useRouter } from "next/navigation";
import { doc, onSnapshot } from "firebase/firestore";

import { useAuth } from "@/context/AuthContext";
import { db } from "@/lib/firebase";
import { useUserCredits } from "@/hooks/useUserCredits";

const navLinks = [
  { href: "/app", label: "Profil CV IA", icon: "📄" },
  { href: "/app/lm", label: "Assistant candidature", icon: "✨" },
  { href: "/app/tracker", label: "Suivi candidatures", icon: "📊" },
  { href: "/app/interview", label: "Préparer entretien", icon: "🎤" },
  { href: "/app/apply", label: "Postuler", icon: "📨" },
  { href: "/app/history", label: "Historique IA", icon: "🕒" },
  { href: "/app/credits", label: "Crédits", icon: "⚡" },
];

export default function UserAppLayout({ children }: { children: ReactNode }) {
  const { user, loading, logout } = useAuth();
  const router = useRouter();
  const pathname = usePathname();
  const [sidebarOpen, setSidebarOpen] = useState(false);

  // ✅ flag pour être sûr qu'on est côté client
  const [clientReady, setClientReady] = useState(false);
  useEffect(() => {
    setClientReady(true);
  }, []);

  // ✅ Crédits utilisateur via le hook (temps réel Firestore)
  const { credits, loading: creditsLoading } = useUserCredits();

  // 🔒 Protection des routes /app : login + email vérifié
  useEffect(() => {
    if (!clientReady) return;
    if (loading) return;

    if (!user) {
      router.replace("/login");
      return;
    }

    if (!user.emailVerified) {
      router.replace("/auth/verify-email");
      return;
    }
  }, [clientReady, user, loading, router]);

  // 🛡 Surveillance du doc user : si blocked = true => déconnexion immédiate
  useEffect(() => {
    if (!clientReady) return;
    if (!user) return;

    const ref = doc(db, "users", user.uid);

    const unsub = onSnapshot(
      ref,
      (snap) => {
        const data = snap.data() as any | undefined;
        if (data?.blocked) {
          // déconnexion + redirection login avec message
          logout()
            .catch((e) =>
              console.error("Erreur déconnexion après blocage :", e)
            )
            .finally(() => {
              router.replace("/login?blocked=1");
            });
        }
      },
      (err) => {
        console.error("Erreur surveillance blocage utilisateur :", err);
      }
    );

    return () => {
      unsub();
    };
  }, [clientReady, user, logout, router]);

  // ferme le menu mobile au changement de page
  useEffect(() => {
    setSidebarOpen(false);
  }, [pathname]);

  // ⚠️ Tant qu'on n'est pas prêt ou pas autorisé → on ne rend PAS le dashboard
  if (!clientReady || loading || !user || !user.emailVerified) {
    return null;
  }

  const handleLogout = async () => {
    try {
      await logout();
      router.replace("/login");
    } catch (e) {
      console.error("Erreur déconnexion :", e);
    }
  };

  const currentNav = navLinks.find(
    (link) =>
      pathname === link.href || pathname.startsWith(link.href + "/")
  );
  const pageTitle = currentNav?.label ?? "Espace candidat";

  // 🔹 petit composant inline pour le badge crédits
  const CreditsBadge =
    creditsLoading || credits === undefined || credits === null ? (
      <div className="inline-flex items-center gap-1 rounded-full px-2 py-1 text-[11px] bg-[var(--bg-soft)] border border-[var(--border)]/80 text-[var(--muted)]">
        <span className="text-[13px]">⚡</span>
        <span>Chargement…</span>
      </div>
    ) : (
      <div className="inline-flex items-center gap-1 rounded-full px-2 py-1 text-[11px] bg-[var(--bg-soft)] border border-[var(--border)]/80 text-[var(--ink)]">
        <span className="text-[13px]">⚡</span>
        <span>
          <span className="font-semibold">{credits}</span> crédits
        </span>
      </div>
    );

  return (
    <div className="min-h-screen flex bg-[var(--bg)] text-[var(--ink)]">
      {/* SIDEBAR DESKTOP */}
      <aside className="hidden md:flex w-60 shrink-0 flex-col border-r border-[var(--border)] bg-[var(--bg-soft)]/60">
        <div className="flex items-center gap-2 px-3 py-4 border-b border-[var(--border)]/70">
          <Link href="/app" className="flex items-center gap-2">
            <div className="w-9 h-9 rounded-2xl bg-[var(--brand)]/10 border border-[var(--brand)]/40 flex items-center justify-center text-lg">
              ⚡
            </div>
            <div className="flex flex-col">
              <span className="text-xs font-semibold">
                Assistant Candidature IA
              </span>
              <span className="text-[10px] text-[var(--muted)]">
                Espace candidat
              </span>
            </div>
          </Link>
        </div>

        <nav className="flex-1 px-2 py-3 space-y-1 text-[13px] overflow-y-auto">
          {navLinks.map((link) => {
            const active =
              pathname === link.href ||
              pathname.startsWith(link.href + "/");
            return (
              <Link
                key={link.href}
                href={link.href}
                className={[
                  "flex items-center gap-2 rounded-lg px-2 py-1.5 transition-colors border border-transparent",
                  active
                    ? "bg-[var(--bg)] text-[var(--ink)] border-[var(--brand)]/60"
                    : "text-[var(--muted)] hover:text-[var(--ink)] hover:bg-[var(--bg-soft)]",
                ].join(" ")}
              >
                <span className="w-5 text-center text-[13px]">
                  {link.icon}
                </span>
                <span>{link.label}</span>
              </Link>
            );
          })}
        </nav>

        <div className="border-t border-[var(--border)]/70 px-3 py-3 text-[11px] flex flex-col gap-2">
          {/* Badge crédits en bas de la sidebar */}
          {CreditsBadge}

          {user?.email && (
            <p className="text-[var(--muted)]">
              Connecté·e :{" "}
              <span className="font-medium text-[var(--ink)]">
                {user.email}
              </span>
            </p>
          )}
          <button
            type="button"
            onClick={handleLogout}
            className="w-full text-[11px] rounded-full border border-[var(--border)] px-3 py-1.5 bg-[var(--bg)] hover:border-red-500 hover:text-red-300 transition-colors"
          >
            Se déconnecter
          </button>
        </div>
      </aside>

      {/* COLONNE CONTENU */}
      <div className="flex-1 flex flex-col relative">
        <div className="pointer-events-none absolute inset-0 -z-10 bg-[radial-gradient(circle_at_top,_rgba(56,189,248,0.16),_transparent_55%),radial-gradient(circle_at_bottom,_rgba(94,234,212,0.12),_transparent_55%)]" />

        {/* TOPBAR */}
        <header className="sticky top-0 z-30 border-b border-[var(--border)]/80 bg-[var(--bg)]/95 backdrop-blur">
          <div className="flex items-center justify-between gap-3 px-3 sm:px-6 py-3">
            <div className="flex items-center gap-3">
              <button
                type="button"
                aria-label="Ouvrir la navigation"
                onClick={() => setSidebarOpen(true)}
                className="md:hidden rounded-full p-2 bg-[var(--bg-soft)] border border-[var(--border)]/80 shadow-sm focus:outline-none focus:ring-2 focus:ring-[var(--brand)]/60"
              >
                <div className={`menu-icon1 ${sidebarOpen ? "is-open" : ""}`}>
                  <div className="menu-icon1_line-top"></div>
                  <div className="menu-icon1_line-middle">
                    <div className="menu-icon1_line-middle-inner"></div>
                  </div>
                  <div className="menu-icon1_line-bottom"></div>
                </div>
              </button>

              <div className="flex flex-col">
                <span className="text-[11px] font-medium uppercase tracking-wide text-[var(--muted)]">
                  Tableau de bord
                </span>
                <span className="text-sm font-semibold">{pageTitle}</span>
              </div>
            </div>

            <div className="flex items-center gap-3">
              {/* Badge crédits dans la topbar */}
              {CreditsBadge}

              {user?.email && (
                <span className="hidden sm:inline text-[11px] text-[var(--muted)]">
                  {user.email}
                </span>
              )}
              <button
                type="button"
                onClick={handleLogout}
                className="text-[11px] rounded-full border border-[var(--border)] px-3 py-1.5 bg-[var(--bg-soft)] hover:border-red-500 hover:text-red-300 transition-colors"
              >
                Se déconnecter
              </button>
            </div>
          </div>
        </header>

        <main className="flex-1 overflow-y-auto">
          <div className="px-3 sm:px-6 lg:px-8 py-4 lg:py-6">
            <div className="max-w-6xl mx-auto space-y-4">{children}</div>
          </div>
        </main>
      </div>

      {/* MENU MOBILE (DRAWER) */}
      <div
        className={`fixed inset-0 z-40 md:hidden transition ${
          sidebarOpen ? "pointer-events-auto" : "pointer-events-none"
        }`}
      >
        <div
          className={`absolute inset-0 bg-black/50 transition-opacity ${
            sidebarOpen ? "opacity-100" : "opacity-0"
          }`}
          onClick={() => setSidebarOpen(false)}
        />

        <div
          className={`absolute left-0 top-0 h-full w-64 bg-[var(--bg)] border-r border-[var(--border)] shadow-xl transform transition-transform ${
            sidebarOpen ? "translate-x-0" : "-translate-x-full"
          }`}
        >
          <div className="flex items-center justify-between px-3 py-3 border-b border-[var(--border)]/80">
            <div className="flex items-center gap-2">
              <div className="menu-icon1">
                <div className="menu-icon1_line-top"></div>
                <div className="menu-icon1_line-middle">
                  <div className="menu-icon1_line-middle-inner"></div>
                </div>
                <div className="menu-icon1_line-bottom"></div>
              </div>
              <div className="flex flex-col">
                <span className="text-xs font-semibold">Menu</span>
                <span className="text-[10px] text-[var(--muted)]">
                  Navigation
                </span>
              </div>
            </div>
            <button
              type="button"
              onClick={() => setSidebarOpen(false)}
              className="text-[11px] rounded-full border border-[var(--border)] px-2 py-1 hover:bg-[var(--bg-soft)]"
            >
              ✕
            </button>
          </div>

          <nav className="px-2 py-3 flex flex-col gap-1 text-[13px] overflow-y-auto">
            {navLinks.map((link) => {
              const active =
                pathname === link.href ||
                pathname.startsWith(link.href + "/");
              return (
                <Link
                  key={link.href}
                  href={link.href}
                  className={[
                    "flex items-center gap-2 rounded-lg px-2 py-1.5 transition-colors border border-transparent",
                    active
                      ? "bg-[var(--bg)] text-[var(--ink)] border-[var(--brand)]/60"
                      : "text-[var(--muted)] hover:text-[var(--ink)] hover:bg-[var(--bg-soft)]",
                  ].join(" ")}
                >
                  <span className="w-5 text-center text-[13px]">
                    {link.icon}
                  </span>
                  <span>{link.label}</span>
                </Link>
              );
            })}
          </nav>

          <div className="border-t border-[var(--border)]/70 px-3 py-3 text-[11px] space-y-2">
            {/* Badge crédits dans le menu mobile */}
            {CreditsBadge}

            {user?.email && (
              <p className="mb-1 text-[var(--muted)]">
                Connecté·e :{" "}
                <span className="font-medium text-[var(--ink)]">
                  {user.email}
                </span>
              </p>
            )}
            <button
              type="button"
              onClick={handleLogout}
              className="w-full text-[11px] rounded-full border border-[var(--border)] px-3 py-1.5 bg-[var(--bg)] hover:border-red-500 hover:text-red-300 transition-colors"
            >
              Se déconnecter
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}
````

## File: app/app/page.tsx
````typescript
"use client";

import { useState, useEffect, useRef, ChangeEvent, FormEvent } from "react";
import { motion } from "framer-motion";
import { auth, db } from "@/lib/firebase";
import { onAuthStateChanged } from "firebase/auth";
import {
  doc,
  getDoc,
  setDoc,
  collection,
  query,
  where,
  onSnapshot,
} from "firebase/firestore";
import Chart from "chart.js/auto";
import { useAuth } from "@/context/AuthContext";
import { useUserProfile } from "@/hooks/useUserProfile";
import { consumeCredits } from "@/lib/credits";
import { logUsage } from "@/lib/userTracking";

// --- TYPES ---

type CvSkillsSection = {
  title: string;
  items: string[];
};

type CvSkills = {
  sections: CvSkillsSection[];
  tools: string[];
};

type CvExperience = {
  company: string;
  role: string;
  dates: string;
  bullets: string[];
  location?: string;
};

type CvEducation = {
  school: string;
  degree: string;
  dates: string;
  location?: string;
};

type CvProfile = {
  fullName: string;
  email: string;
  phone: string;
  linkedin: string;
  profileSummary: string;

  city?: string;
  address?: string;

  contractType: string;
  contractTypeStandard?: string;
  contractTypeFull?: string;

  primaryDomain?: string;
  secondaryDomains?: string[];
  softSkills?: string[];

  drivingLicense?: string;
  vehicle?: string;

  skills: CvSkills;
  experiences: CvExperience[];
  education: CvEducation[];
  educationShort: string[];
  certs: string;
  langLine: string;
  hobbies: string[];
  updatedAt?: number;
};

type DashboardCounts = {
  totalApps: number;
  cvCount: number;
  lmCount: number;
};

// 🔗 URL de ta Firebase Function d'extraction de profil
const WORKER_URL =
  "https://europe-west1-assistant-ia-v4.cloudfunctions.net/extractProfile";

// --- HELPERS GÉNÉRAUX ---

function getInitials(name?: string) {
  if (!name) return "?";
  const parts = name.trim().split(/\s+/);
  if (parts.length === 0) return "?";
  if (parts.length === 1) return (parts[0][0] || "?").toUpperCase();
  return (
    ((parts[0][0] || "") + (parts[parts.length - 1][0] || "")).toUpperCase()
  );
}

function formatUpdatedAt(ts?: number) {
  if (!ts) return "";
  const d = new Date(ts);
  return new Intl.DateTimeFormat("fr-FR", {
    day: "2-digit",
    month: "short",
    year: "numeric",
    hour: "2-digit",
    minute: "2-digit",
  }).format(d);
}

function normalizeText(str: string): string {
  return str
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .toLowerCase();
}

// 🌐 Drapeaux langues (robuste, ignore natif/bilingue/etc.)
function getFlagEmoji(langPart: string): string {
  if (!langPart) return "🌐";

  const lower = langPart.toLowerCase();

  // On enlève ce qu'il y a entre parenthèses (souvent le niveau)
  let base = lower.replace(/\(.*?\)/g, " ").trim();

  const levelWords = [
    "natif",
    "bilingue",
    "courant",
    "intermédiaire",
    "intermediaire",
    "débutant",
    "debutant",
    "langue maternelle",
    "maternelle",
    "maternel",
    "c1",
    "c2",
    "b1",
    "b2",
    "a1",
    "a2",
  ];

  levelWords.forEach((w) => {
    base = base.replace(new RegExp("\\b" + w + "\\b", "g"), " ");
  });

  base = base.trim();
  if (!base) base = lower;

  if (base.match(/\bfrançais\b|\bfrancais\b|\bfrench\b/)) return "🇫🇷";
  if (base.match(/\banglais\b|\benglish\b/)) return "🇬🇧";
  if (base.match(/\bamericain\b|\bétats-unis\b|\busa\b|\bamerican\b/))
    return "🇺🇸";

  if (base.match(/\bespagnol\b|\bspanish\b/)) return "🇪🇸";
  if (base.match(/\ballemand\b|\bgerman\b/)) return "🇩🇪";
  if (base.match(/\bitalien\b|\bitalian\b/)) return "🇮🇹";
  if (base.match(/\bportugais\b|\bportuguese\b/)) return "🇵🇹";
  if (base.match(/\bnéerlandais\b|\bneerlandais\b|\bdutch\b/)) return "🇳🇱";

  if (base.match(/\barabe\b|\barabic\b|\barab\b/)) return "🇸🇦";
  if (base.match(/\bchinois\b|\bmandarin\b|\bchinese\b/)) return "🇨🇳";
  if (base.match(/\brusse\b|\brussian\b/)) return "🇷🇺";
  if (base.match(/\bjaponais\b|\bjapanese\b/)) return "🇯🇵";
  if (base.match(/\bcoréen\b|\bcoreen\b|\bkorean\b/)) return "🇰🇷";
  if (base.match(/\bhindi\b|\bhindou\b/)) return "🇮🇳";
  if (base.match(/\bturc\b|\bturkish\b/)) return "🇹🇷";

  return "🌐";
}

// 🌐 Parse le champ langLine en { flag, text }[]
function parseLangLine(langLine: string): { flag: string; text: string }[] {
  if (!langLine) return [];
  const parts = langLine
    .split("·")
    .join("|")
    .split(",")
    .join("|")
    .split("|")
    .map((p) => p.trim())
    .filter((p) => p.length > 0);

  return parts.map((part) => ({
    flag: getFlagEmoji(part),
    text: part,
  }));
}

// 🎯 Emoji pour les hobbies
function getHobbyEmoji(hobby: string): string {
  const p = hobby.toLowerCase();
  if (p.includes("football") || p.includes("foot")) return "⚽";
  if (p.includes("basket") || p.includes("basketball")) return "🏀";
  if (p.includes("sport") || p.includes("fitness") || p.includes("gym"))
    return "💪";
  if (p.includes("musique") || p.includes("guitare") || p.includes("piano"))
    return "🎵";
  if (p.includes("lecture") || p.includes("livre")) return "📚";
  if (p.includes("cinéma") || p.includes("cinema") || p.includes("film"))
    return "🎬";
  if (p.includes("jeu vidéo") || p.includes("jeux vidéo") || p.includes("gaming"))
    return "🎮";
  if (p.includes("voyage") || p.includes("travel")) return "✈️";
  if (p.includes("cuisine") || p.includes("cooking")) return "🍳";
  if (p.includes("photo") || p.includes("photographie")) return "📸";
  if (p.includes("dessin") || p.includes("peinture") || p.includes("art"))
    return "🎨";
  if (p.includes("randonnée") || p.includes("rando") || p.includes("hiking"))
    return "🥾";
  return "⭐";
}

// --- RADAR GÉNÉRIQUE (multi-métiers, robuste) ---

type RadarAxisDef = {
  id: string;
  label: string;
  keywords: string[];
};

const DOMAIN_AXES: RadarAxisDef[] = [
  {
    id: "finance",
    label: "Finance & Contrôle",
    keywords: [
      "finance",
      "financier",
      "controle de gestion",
      "contrôle de gestion",
      "controle interne",
      "contrôle interne",
      "audit",
      "conformite",
      "conformité",
      "risque",
      "risques",
      "reporting",
      "budget",
      "bilan",
      "comptable",
      "tresorerie",
      "trésorerie",
      "analyse financiere",
      "analyse financière",
      "cfa",
      "ifrs",
    ],
  },
  {
    id: "it_dev",
    label: "IT & Développement",
    keywords: [
      "developpement",
      "développement",
      "javascript",
      "typescript",
      "python",
      "java",
      "c++",
      "c#",
      "php",
      "go",
      "react",
      "node",
      "angular",
      "vue",
      "api",
      "application",
      "fullstack",
      "frontend",
      "backend",
      "devops",
      "git",
      "docker",
      "kubernetes",
    ],
  },
  {
    id: "cyber",
    label: "Cybersécurité & Réseaux",
    keywords: [
      "cyber",
      "cybersecurite",
      "cybersécurité",
      "pentest",
      "penetration test",
      "vulnerabilite",
      "vulnérabilité",
      "soc",
      "firewall",
      "pare feu",
      "pare-feu",
      "vpn",
      "ids",
      "ips",
      "wireshark",
      "nmap",
      "kali",
      "siem",
      "owasp",
    ],
  },
  {
    id: "data",
    label: "Data & Analytics",
    keywords: [
      "data",
      "donnees",
      "données",
      "sql",
      "power bi",
      "tableau",
      "statistique",
      "statistiques",
      "machine learning",
      "intelligence artificielle",
      "ia ",
      "analyse de donnees",
      "analyse de données",
      "data analyst",
      "data engineer",
      "pandas",
      "numpy",
    ],
  },
  {
    id: "marketing",
    label: "Marketing & Communication",
    keywords: [
      "marketing",
      "communication",
      "social media",
      "réseaux sociaux",
      "reseaux sociaux",
      "seo",
      "sea",
      "content",
      "contenu",
      "campagne",
      "publicite",
      "publicité",
      "branding",
      "influence",
      "community manager",
    ],
  },
  {
    id: "sales",
    label: "Commerce & Vente",
    keywords: [
      "commercial",
      "vente",
      "business developer",
      "account manager",
      "prospection",
      "negociation",
      "négociation",
      "pipeline",
      "portefeuille clients",
      "chiffre d affaires",
      "ca ",
      "b2b",
      "b2c",
    ],
  },
  {
    id: "hr",
    label: "RH & Recrutement",
    keywords: [
      "ressources humaines",
      "rh",
      "recrutement",
      "onboarding",
      "formation",
      "gestion du personnel",
      "talent acquisition",
      "people",
      "paie",
      "gestion des talents",
    ],
  },
  {
    id: "project",
    label: "Gestion de projet",
    keywords: [
      "chef de projet",
      "gestion de projet",
      "project manager",
      "planning",
      "pilotage",
      "agile",
      "scrum",
      "kanban",
      "coordination",
      "roadmap",
      "livrable",
      "livrables",
      "planning",
    ],
  },
  {
    id: "ops",
    label: "Opérations & Logistique",
    keywords: [
      "logistique",
      "supply chain",
      "transport",
      "flux",
      "optimisation des processus",
      "lean",
      "maintenance",
      "production",
      "magasinier",
      "preparation de commandes",
      "exploitation",
    ],
  },
  {
    id: "health",
    label: "Santé & Social",
    keywords: [
      "infirmier",
      "infirmière",
      "aide soignant",
      "aide-soignant",
      "medecin",
      "médecin",
      "paramedical",
      "paramédical",
      "social",
      "accompagnement",
      "patients",
      "soins",
      "assistante sociale",
      "assistant social",
      "ehpad",
    ],
  },
  {
    id: "education",
    label: "Éducation & Formation",
    keywords: [
      "enseignant",
      "professeur",
      "formateur",
      "formatrice",
      "pedagogie",
      "pédagogie",
      "cours",
      "formation",
      "apprentissage",
      "eleves",
      "élèves",
      "etudiants",
      "étudiants",
      "éducation",
    ],
  },
];

const DOMAIN_CORE_KEYWORDS: Record<string, string[]> = {
  finance: [
    "comptable",
    "controle de gestion",
    "contrôle de gestion",
    "controle interne",
    "contrôle interne",
    "audit",
    "bilan",
    "compte de resultat",
    "compte de résultat",
    "tresorerie",
    "trésorerie",
    "analyse financiere",
    "analyse financière",
    "cfa",
    "ifrs",
  ],
  it_dev: [
    "developpement",
    "développement",
    "javascript",
    "typescript",
    "python",
    "java",
    "c++",
    "c#",
    "php",
    "react",
    "node",
    "angular",
    "vue",
    "fullstack",
    "frontend",
    "backend",
    "devops",
    "docker",
    "kubernetes",
  ],
  cyber: [
    "pentest",
    "penetration test",
    "wireshark",
    "nmap",
    "kali",
    "ids",
    "ips",
    "soc",
    "siem",
    "owasp",
    "firewall",
    "pare feu",
    "pare-feu",
  ],
  data: [
    "data analyst",
    "data engineer",
    "power bi",
    "tableau",
    "sql",
    "pandas",
    "numpy",
    "machine learning",
    "intelligence artificielle",
  ],
  marketing: [
    "seo",
    "sea",
    "community manager",
    "social media",
    "campagne",
    "branding",
    "communication digitale",
  ],
  sales: [
    "business developer",
    "account manager",
    "commercial",
    "prospection",
    "negociation",
    "négociation",
    "pipeline",
  ],
  hr: [
    "ressources humaines",
    "rh",
    "recrutement",
    "talent acquisition",
    "gestion de la paie",
    "gestion du personnel",
  ],
  project: [
    "chef de projet",
    "project manager",
    "scrum master",
    "agile",
    "gestion de projet",
  ],
  ops: [
    "supply chain",
    "logistique",
    "exploitation",
    "maintenance",
    "production",
  ],
  health: [
    "infirmier",
    "infirmière",
    "medecin",
    "médecin",
    "aide soignant",
    "aide-soignant",
    "soins",
    "patients",
  ],
  education: [
    "enseignant",
    "professeur",
    "formateur",
    "formatrice",
    "pedagogie",
    "pédagogie",
    "eleves",
    "élèves",
    "etudiants",
    "étudiants",
  ],
};

const SOFT_SKILLS_KEYWORDS = [
  "communication",
  "travail en equipe",
  "travail en équipe",
  "collaboration",
  "autonome",
  "autonomie",
  "rigoureux",
  "rigoureuse",
  "organise",
  "organisé",
  "organisee",
  "organisée",
  "adaptabilite",
  "adaptabilité",
  "gestion du stress",
  "leadership",
  "esprit d analyse",
  "esprit d'analyse",
  "empathie",
  "relationnel",
];

function countHits(keywords: string[], text: string): number {
  let hits = 0;
  for (const k of keywords) {
    const normK = normalizeText(k);
    if (text.includes(normK)) hits++;
  }
  return hits;
}

function scaleScore(hits: number): number {
  if (hits <= 0) return 3;
  if (hits === 1) return 5;
  if (hits === 2) return 7;
  if (hits === 3) return 9;
  return 10;
}

// 🔎 construit les données du radar à partir du profil (générique multi-métiers)
function buildRadarData(profile: CvProfile | null) {
  const defaultLabels = [
    "Analyse / Résolution",
    "Organisation & Processus",
    "Outils & Tech",
    "Apprentissage",
    "Soft skills",
  ];

  if (!profile) {
    return { labels: defaultLabels, data: [3, 3, 3, 3, 3] };
  }

  const rawText =
    JSON.stringify(profile.skills.sections || "") +
    JSON.stringify(profile.skills.tools || "") +
    JSON.stringify(profile.experiences || "") +
    JSON.stringify(profile.education || "") +
    (profile.profileSummary || "") +
    (profile.contractType || "") +
    (profile.certs || "") +
    (profile.langLine || "");

  const lower = normalizeText(rawText);

  const aiDomainIds: string[] = [];
  if (profile.primaryDomain && profile.primaryDomain !== "autre") {
    aiDomainIds.push(profile.primaryDomain);
  }
  if (Array.isArray(profile.secondaryDomains)) {
    for (const d of profile.secondaryDomains) {
      if (d && d !== "autre" && !aiDomainIds.includes(d)) {
        aiDomainIds.push(d);
      }
    }
  }

  let relevant: {
    axis: RadarAxisDef;
    totalHits: number;
    coreHits: number;
    score: number;
  }[] = [];

  if (aiDomainIds.length > 0) {
    relevant = aiDomainIds
      .map((id) => {
        const axis = DOMAIN_AXES.find((a) => a.id === id);
        if (!axis) return null;

        const totalHits = countHits(axis.keywords, lower);
        const coreKeywords = DOMAIN_CORE_KEYWORDS[axis.id] || axis.keywords;
        const coreHits = countHits(coreKeywords, lower);

        const rawHits = Math.max(totalHits, coreHits);
        const score = scaleScore(rawHits);

        return { axis, totalHits, coreHits, score };
      })
      .filter(
        (
          x
        ): x is {
          axis: RadarAxisDef;
          totalHits: number;
          coreHits: number;
          score: number;
        } => !!x
      );
  } else {
    const domainScores = DOMAIN_AXES.map((axis) => {
      const totalHits = countHits(axis.keywords, lower);
      const coreKeywords = DOMAIN_CORE_KEYWORDS[axis.id] || axis.keywords;
      const coreHits = countHits(coreKeywords, lower);

      const isRelevant = coreHits > 0 && totalHits > 0;
      const score = isRelevant ? scaleScore(totalHits) : 0;

      return { axis, totalHits, coreHits, isRelevant, score };
    });

    relevant = domainScores
      .filter((d) => d.isRelevant)
      .sort((a, b) => b.totalHits - a.totalHits)
      .slice(0, 4);
  }

  let softHits = countHits(SOFT_SKILLS_KEYWORDS, lower);
  const softSkillsCount = Array.isArray(profile.softSkills)
    ? profile.softSkills.length
    : 0;

  if (softSkillsCount > 0) {
    softHits += Math.min(4, Math.floor(softSkillsCount / 2));
  }

  const softScore = scaleScore(softHits);

  if (!relevant.length) {
    const generic = [
      scaleScore(countHits(["analyse", "diagnostic"], lower)),
      scaleScore(countHits(["processus", "organisation"], lower)),
      scaleScore(countHits(["outil", "logiciel", "technique"], lower)),
      scaleScore(countHits(["apprentissage", "formation", "veille"], lower)),
    ];
    return {
      labels: defaultLabels,
      data: [...generic, softScore],
    };
  }

  const labels = relevant.map((r) => r.axis.label).concat("Soft skills");
  const data = relevant.map((r) => r.score).concat(softScore);

  console.debug(
    "[Radar IA] Domaines retenus :",
    relevant.map((r) => ({
      id: r.axis.id,
      label: r.axis.label,
      hits: r.totalHits,
      score: r.score,
    })),
    "SoftSkillsCount:",
    softSkillsCount,
    "SoftScore:",
    softScore
  );

  return { labels, data };
}

// Items pour la navigation rapide
const navItems = [
  { id: "infos-personnelles", label: "Infos & CV" },
  { id: "competences", label: "Compétences & Outils" },
  { id: "experience", label: "Expérience" },
  { id: "formation", label: "Formation & Certifs" },
  { id: "langues", label: "Langues" },
  { id: "hobbies", label: "Centres d'intérêt" },
];

type ActiveModal =
  | "infos"
  | "skills"
  | "experience"
  | "education"
  | "languages"
  | "hobbies"
  | null;

type ExperienceDraft = {
  company: string;
  role: string;
  dates: string;
  bulletsText: string;
};

type EducationDraft = {
  school: string;
  degree: string;
  dates: string;
  location: string;
};

type LanguageDraft = {
  language: string;
  level: string;
};

const LANGUAGE_OPTIONS = [
  "Français",
  "Anglais",
  "Espagnol",
  "Allemand",
  "Italien",
  "Portugais",
  "Néerlandais",
  "Arabe",
  "Russe",
  "Chinois (Mandarin)",
  "Japonais",
  "Coréen",
  "Hindi",
  "Turc",
];

const LANGUAGE_LEVEL_OPTIONS = [
  "Natif / Bilingue (C2)",
  "Courant (C1)",
  "Intermédiaire (B2)",
  "Opérationnel (B1)",
  "Débutant (A2 - A1)",
];

const CERTIFICATION_OPTIONS = [
  "TOEIC",
  "TOEFL",
  "IELTS",
  "CCNA",
  "CCNP",
  "CompTIA Security+",
  "CompTIA Network+",
  "AWS Cloud Practitioner",
  "AWS Solutions Architect Associate",
  "Azure AZ-900",
  "Azure AZ-104",
  "Azure AZ-500",
  "Azure SC-900",
  "Azure MS-900",
  "Google Cloud Digital Leader",
  "PMI PMP",
  "Prince2 Foundation",
  "Prince2 Practitioner",
  "ITIL Foundation",
  "CFA Niveau 1",
  "AMF",
  "Tosa Excel",
];

const HOBBY_OPTIONS = [
  "Voyage",
  "Lecture",
  "Musique",
  "Piano",
  "Guitare",
  "Sport (Football)",
  "Sport (Basketball)",
  "Fitness / Musculation",
  "Course à pied",
  "Randonnée",
  "Natation",
  "Cinéma",
  "Séries",
  "Jeux vidéo",
  "Photographie",
  "Cuisine",
  "Pâtisserie",
  "Dessin",
  "Peinture",
  "Art digital",
  "Bénévolat",
  "Entrepreneuriat",
  "Technologie / veille tech",
  "Échecs",
  "Podcasts",
];

const CONTRACT_TYPE_OPTIONS = [
  "CDI",
  "CDD",
  "Intérim",
  "Alternance",
  "Stage",
  "Freelance",
  "Temps plein",
  "Temps partiel",
  "Indépendant",
  "Contrat pro",
];

// --- COMPOSANT PRINCIPAL ---

export default function DashboardPage() {
  const [file, setFile] = useState<File | null>(null);
  const [uploading, setUploading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [profile, setProfile] = useState<CvProfile | null>(null);

  const radarCanvasRef = useRef<HTMLCanvasElement | null>(null);

  const [userId, setUserId] = useState<string | null>(null);
  const [userEmail, setUserEmail] = useState<string | null>(null);
  const [loadingProfileFromDb, setLoadingProfileFromDb] =
    useState<boolean>(true);

  const [dashboardCounts, setDashboardCounts] = useState<DashboardCounts>({
    totalApps: 0,
    cvCount: 0,
    lmCount: 0,
  });
  const [loadingCounts, setLoadingCounts] = useState<boolean>(true);

  // --- ÉTATS MODALES ---

  const [activeModal, setActiveModal] = useState<ActiveModal>(null);

  const [infosDraft, setInfosDraft] = useState({
    fullName: "",
    email: "",
    phone: "",
    linkedin: "",
    contractType: "",
    profileSummary: "",
    drivingLicense: "",
    vehicle: "",
    address: "",
  });

  const [skillsSectionsText, setSkillsSectionsText] = useState("");
  const [skillsToolsText, setSkillsToolsText] = useState("");

  const [experiencesDraft, setExperiencesDraft] = useState<ExperienceDraft[]>(
    []
  );

  const [educationDrafts, setEducationDrafts] = useState<EducationDraft[]>([]);
  const [certsList, setCertsList] = useState<string[]>([]);
  const [certInput, setCertInput] = useState("");

  const [languagesDraft, setLanguagesDraft] = useState<LanguageDraft[]>([]);
  const [hobbiesList, setHobbiesList] = useState<string[]>([]);
  const [hobbyInput, setHobbyInput] = useState("");

  const { user } = useAuth();
  const { profile: accountProfile, loading: loadingAccountProfile } =
    useUserProfile();
  const remainingCredits = accountProfile?.credits ?? 0;
  const isBlocked = accountProfile?.blocked === true;

  // 🔐 Auth + chargement du profil Firestore + stats candidatures
  useEffect(() => {
    let unsubApps: (() => void) | null = null;

    const unsubAuth = onAuthStateChanged(auth, async (user) => {
      if (unsubApps) {
        unsubApps();
        unsubApps = null;
      }

      if (!user) {
        setUserId(null);
        setUserEmail(null);
        setProfile(null);
        setLoadingProfileFromDb(false);
        setDashboardCounts({ totalApps: 0, cvCount: 0, lmCount: 0 });
        setLoadingCounts(false);
        return;
      }

      setUserId(user.uid);
      setUserEmail(user.email ?? null);

      // --- Chargement du profil
      try {
        const ref = doc(db, "profiles", user.uid);
        const snap = await getDoc(ref);
        if (snap.exists()) {
          const data = snap.data() as any;

          const loadedProfile: CvProfile = {
            fullName: data.fullName || "",
            email: data.email || "",
            phone: data.phone || "",
            linkedin: data.linkedin || "",
            profileSummary: data.profileSummary || "",
            city: data.city || "",
            address: data.address || "",
            contractType: data.contractType || data.contractTypeStandard || "",
            contractTypeStandard: data.contractTypeStandard || "",
            contractTypeFull: data.contractTypeFull || "",
            primaryDomain: data.primaryDomain || "",
            secondaryDomains: Array.isArray(data.secondaryDomains)
              ? data.secondaryDomains
              : [],
            softSkills: Array.isArray(data.softSkills)
              ? data.softSkills
              : [],
            drivingLicense: data.drivingLicense || "",
            vehicle: data.vehicle || "",
            skills: {
              sections: Array.isArray(data.skills?.sections)
                ? data.skills.sections
                : [],
              tools: Array.isArray(data.skills?.tools)
                ? data.skills.tools
                : [],
            },
            experiences: Array.isArray(data.experiences)
              ? data.experiences
              : [],
            education: Array.isArray(data.education)
              ? data.education
              : [],
            educationShort: Array.isArray(data.educationShort)
              ? data.educationShort
              : [],
            certs: data.certs || "",
            langLine: data.langLine || "",
            hobbies: Array.isArray(data.hobbies) ? data.hobbies : [],
            updatedAt:
              typeof data.updatedAt === "number" ? data.updatedAt : undefined,
          };

          setProfile(loadedProfile);
        } else {
          setProfile(null);
        }
      } catch (e) {
        console.error("Erreur chargement profil Firestore:", e);
      } finally {
        setLoadingProfileFromDb(false);
      }

      // --- Stats candidatures (CV générés, LM générées, candidatures suivies)
      setLoadingCounts(true);

      const q = query(
        collection(db, "applications"),
        where("userId", "==", user.uid)
      );

      unsubApps = onSnapshot(
        q,
        (snap) => {
          let totalApps = 0;
          let cvCount = 0;
          let lmCount = 0;

          snap.docs.forEach((docSnap) => {
            const data = docSnap.data() as any;
            totalApps++;
            if (data.hasCv) cvCount++;
            if (data.hasLm) lmCount++;
          });

          setDashboardCounts({ totalApps, cvCount, lmCount });
          setLoadingCounts(false);
        },
        (err) => {
          console.error("Erreur chargement stats dashboard:", err);
          setLoadingCounts(false);
        }
      );
    });

    return () => {
      if (unsubApps) {
        unsubApps();
      }
      unsubAuth();
    };
  }, []);

  // 💾 sauvegarde du profil en base (Firestore)
  const saveProfileToDb = async (p: CvProfile) => {
    if (!userId) return;
    const ref = doc(db, "profiles", userId);
    const payload = {
      ...p,
      ownerUid: userId,
      ownerEmail: userEmail ?? null,
      updatedAt: Date.now(),
    };
    await setDoc(ref, payload, { merge: true });
  };

  // 🎯 Radar Chart
  useEffect(() => {
    if (!radarCanvasRef.current || !profile) return;

    const ctx = radarCanvasRef.current.getContext("2d");
    if (!ctx) return;

    const existingChart = Chart.getChart(ctx as any);
    if (existingChart) {
      existingChart.destroy();
    }

    const { labels, data } = buildRadarData(profile);

    const chartInstance = new Chart(ctx, {
      type: "radar",
      data: {
        labels,
        datasets: [
          {
            label: "Niveau estimé",
            data,
            backgroundColor: "rgba(56, 189, 248, 0.25)",
            borderColor: "rgba(56, 189, 248, 0.9)",
            borderWidth: 2,
            pointBackgroundColor: "rgba(56, 189, 248, 1)",
            pointRadius: 3,
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          r: {
            beginAtZero: true,
            min: 0,
            max: 10,
            ticks: {
              stepSize: 2,
              showLabelBackdrop: false,
              display: false,
            },
            grid: {
              color: "rgba(148, 163, 184, 0.35)",
            },
            angleLines: {
              color: "rgba(148, 163, 184, 0.35)",
            },
            pointLabels: {
              font: { size: 11 },
              color: "#e5e7eb",
            },
          },
        },
        plugins: {
          legend: {
            display: false,
          },
        },
      },
    });

    return () => {
      chartInstance.destroy();
    };
  }, [profile]);

  // --- UPLOAD CV ---

  const handleFileChange = (e: ChangeEvent<HTMLInputElement>) => {
    setError(null);
    const f = e.target.files?.[0];
    if (!f) return;

    if (!f.type.includes("pdf")) {
      setError("Merci d'importer un CV au format PDF.");
      return;
    }

    setFile(f);
  };

  const fileToBase64 = (file: File): Promise<string> => {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onerror = () =>
        reject(new Error("Impossible de lire le fichier."));
      reader.onload = () => {
        const result = reader.result as string;
        const base64 = result.split(",")[1];
        if (!base64) {
          reject(new Error("Encodage base64 invalide."));
        } else {
          resolve(base64);
        }
      };
      reader.readAsDataURL(file);
    });
  };

  const handleUpload = async () => {
    if (!file) {
      setError("Choisis d'abord un CV au format PDF.");
      return;
    }

    if (!user) {
      setError("Tu dois être connecté pour analyser ton CV.");
      return;
    }

    if (loadingAccountProfile) {
      setError(
        "Ton profil utilisateur est en cours de chargement, réessaie dans un instant."
      );
      return;
    }

    if (isBlocked) {
      setError(
        "Ton compte est bloqué. Contacte l'administrateur pour en savoir plus."
      );
      return;
    }

    const cost = 1; // 💰 coût d'une analyse de CV
    if (remainingCredits < cost) {
      setError(
        "Tu n'as plus assez de crédits pour analyser un CV. Contacte l'administrateur."
      );
      return;
    }

    setError(null);
    setUploading(true);

    try {
      // 1) Consommation des crédits (transaction Firestore)
      await consumeCredits(user.uid, cost);

      // 2) Log d'usage
      await logUsage(user, "cv_analyze", {
        fileName: file.name,
        fileSize: file.size,
        feature: "dashboard-cv-upload",
      });

      // 3) Appel de la Cloud Function d'extraction
      const base64Pdf = await fileToBase64(file);

      const res = await fetch(WORKER_URL, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ base64Pdf }),
      });

      const json = await res.json().catch(() => null);

      if (!res.ok) {
        const msg = (json && json.error) || "Erreur pendant l'analyse du CV.";
        throw new Error(msg);
      }

      const now = Date.now();
      const rawProfile = json?.profile ?? json;

      const receivedProfile: CvProfile = {
        fullName: rawProfile.fullName || "",
        email: rawProfile.email || "",
        phone: rawProfile.phone || "",
        linkedin: rawProfile.linkedin || "",
        profileSummary: rawProfile.profileSummary || "",
        city: rawProfile.city || "",
        address: rawProfile.address || "",
        contractType:
          rawProfile.contractType || rawProfile.contractTypeStandard || "",
        contractTypeStandard: rawProfile.contractTypeStandard || "",
        contractTypeFull: rawProfile.contractTypeFull || "",
        primaryDomain: rawProfile.primaryDomain || "",
        secondaryDomains: Array.isArray(rawProfile.secondaryDomains)
          ? rawProfile.secondaryDomains
          : [],
        softSkills: Array.isArray(rawProfile.softSkills)
          ? rawProfile.softSkills
          : [],
        drivingLicense: rawProfile.drivingLicense || "",
        vehicle: rawProfile.vehicle || "",
        skills: {
          sections: Array.isArray(rawProfile.skills?.sections)
            ? rawProfile.skills.sections
            : [],
          tools: Array.isArray(rawProfile.skills?.tools)
            ? rawProfile.skills.tools
            : [],
        },
        experiences: Array.isArray(rawProfile.experiences)
          ? rawProfile.experiences
          : [],
        education: Array.isArray(rawProfile.education)
          ? rawProfile.education
          : [],
        educationShort: Array.isArray(rawProfile.educationShort)
          ? rawProfile.educationShort
          : [],
        certs: rawProfile.certs || "",
        langLine: rawProfile.langLine || "",
        hobbies: Array.isArray(rawProfile.hobbies)
          ? rawProfile.hobbies
          : [],
        updatedAt: now,
      };

      setProfile(receivedProfile);

      if (userId) {
        await saveProfileToDb(receivedProfile);
      }
    } catch (err: any) {
      console.error(err);
      if (err instanceof Error) {
        if (err.message === "NOT_ENOUGH_CREDITS") {
          setError(
            "Tu n'as plus assez de crédits pour analyser un CV. Contacte l'administrateur."
          );
        } else if (err.message === "USER_BLOCKED") {
          setError(
            "Ton compte est bloqué. Contacte l'administrateur pour en savoir plus."
          );
        } else if (err.message === "USER_DOC_NOT_FOUND") {
          setError(
            "Profil utilisateur introuvable dans la base. Contacte l'administrateur."
          );
        } else {
          setError(
            err.message || "Impossible d'analyser ton CV pour le moment."
          );
        }
      } else {
        setError("Impossible d'analyser ton CV pour le moment.");
      }
    } finally {
      setUploading(false);
    }
  };

  // --- MODALES : OUVERTURE ---

  const openInfosModal = () => {
    if (!profile) return;
    setInfosDraft({
      fullName: profile.fullName,
      email: profile.email || userEmail || "",
      phone: profile.phone || "",
      linkedin: profile.linkedin || "",
      contractType:
        profile.contractType || profile.contractTypeStandard || "",
      profileSummary: profile.profileSummary || "",
      drivingLicense: profile.drivingLicense || "",
      vehicle: profile.vehicle || "",
      address: profile.address || profile.city || "",
    });
    setActiveModal("infos");
  };

  const openSkillsModal = () => {
    if (!profile) return;
    const sectionsText = (profile.skills.sections || [])
      .map((sec) => `${sec.title}: ${sec.items.join(", ")}`)
      .join("\n");
    const toolsText = (profile.skills.tools || []).join(", ");

    setSkillsSectionsText(sectionsText);
    setSkillsToolsText(toolsText);
    setActiveModal("skills");
  };

  const openExperienceModal = () => {
    if (!profile) return;
    const drafts: ExperienceDraft[] =
      profile.experiences?.map((exp) => ({
        company: exp.company || "",
        role: exp.role || "",
        dates: exp.dates || "",
        bulletsText: (exp.bullets || []).join("\n"),
      })) || [];

    if (drafts.length === 0) {
      drafts.push({ company: "", role: "", dates: "", bulletsText: "" });
    }

    setExperiencesDraft(drafts);
    setActiveModal("experience");
  };

  const addExperienceDraft = () => {
    setExperiencesDraft((prev) => [
      ...prev,
      { company: "", role: "", dates: "", bulletsText: "" },
    ]);
  };

  const updateExperienceDraft = (
    index: number,
    field: keyof ExperienceDraft,
    value: string
  ) => {
    setExperiencesDraft((prev) =>
      prev.map((exp, i) =>
        i === index
          ? {
              ...exp,
              [field]: value,
            }
          : exp
      )
    );
  };

  const openEducationModal = () => {
    if (!profile) return;

    const drafts: EducationDraft[] =
      Array.isArray(profile.education) && profile.education.length > 0
        ? profile.education.map((edu) => ({
            school: edu.school || "",
            degree: edu.degree || "",
            dates: edu.dates || "",
            location: (edu as any).location || "",
          }))
        : [
            {
              school: "",
              degree: "",
              dates: "",
              location: "",
            },
          ];

    setEducationDrafts(drafts);

    const list =
      profile.certs
        ?.split(/[,\n]/)
        .map((c: string) => c.trim())
        .filter((c: string) => c.length > 0) || [];
    setCertsList(list);
    setCertInput("");

    setActiveModal("education");
  };

  const addEducationDraft = () => {
    setEducationDrafts((prev) => [
      ...prev,
      { school: "", degree: "", dates: "", location: "" },
    ]);
  };

  const updateEducationDraft = (
    index: number,
    field: keyof EducationDraft,
    value: string
  ) => {
    setEducationDrafts((prev) =>
      prev.map((edu, i) =>
        i === index
          ? {
              ...edu,
              [field]: value,
            }
          : edu
      )
    );
  };

  const openLanguagesModal = () => {
    if (!profile) return;

    const parsed = parseLangLine(profile.langLine || "");
    let drafts: LanguageDraft[] = [];

    if (parsed.length > 0) {
      drafts = parsed.map((p) => {
        const txt = p.text;
        const match = txt.match(/^(.*?)\s*\((.*)\)$/);
        if (match) {
          return {
            language: match[1].trim(),
            level: match[2].trim(),
          };
        }
        return {
          language: txt,
          level: "",
        };
      });
    }

    if (drafts.length === 0) {
      drafts = [{ language: "", level: "" }];
    }

    setLanguagesDraft(drafts);
    setActiveModal("languages");
  };

  const openHobbiesModal = () => {
    if (!profile) return;
    setHobbiesList(profile.hobbies || []);
    setHobbyInput("");
    setActiveModal("hobbies");
  };

  // --- MODALES : SAUVEGARDE ---

  const handleModalSave = async (e?: FormEvent) => {
    if (e) e.preventDefault();
    if (!profile || !activeModal) {
      setActiveModal(null);
      return;
    }

    let updated: CvProfile = { ...profile };

    if (activeModal === "infos") {
      updated = {
        ...profile,
        fullName: infosDraft.fullName.trim(),
        email: infosDraft.email.trim(),
        phone: infosDraft.phone.trim(),
        linkedin: infosDraft.linkedin.trim(),
        contractType: infosDraft.contractType.trim(),
        profileSummary: infosDraft.profileSummary.trim(),
        drivingLicense: infosDraft.drivingLicense.trim(),
        vehicle: infosDraft.vehicle.trim(),
        address: infosDraft.address.trim(),
        city:
          infosDraft.address.trim().split(",")[0].trim() ||
          profile.city ||
          "",
      };
    }

    if (activeModal === "skills") {
      const sections: CvSkillsSection[] = skillsSectionsText
        .split("\n")
        .map((l) => l.trim())
        .filter(Boolean)
        .map((line) => {
          const [titlePart, itemsPart] = line.split(":");
          const title = (titlePart || "Compétences").trim();
          const items = itemsPart
            ? itemsPart
                .split(",")
                .map((s) => s.trim())
                .filter(Boolean)
            : [];
          return { title, items };
        });

      const tools = skillsToolsText
        .split(",")
        .map((t) => t.trim())
        .filter(Boolean);

      updated = {
        ...profile,
        skills: {
          sections,
          tools,
        },
      };
    }

    if (activeModal === "experience") {
      const experiences: CvExperience[] = experiencesDraft
        .map((d) => ({
          company: d.company.trim(),
          role: d.role.trim(),
          dates: d.dates.trim(),
          bullets: d.bulletsText
            .split("\n")
            .map((b) => b.trim())
            .filter(Boolean),
        }))
        .filter(
          (exp) =>
            exp.company || exp.role || exp.dates || exp.bullets.length > 0
        );

      updated = {
        ...profile,
        experiences,
      };
    }

    if (activeModal === "education") {
      const education: CvEducation[] = educationDrafts
        .map((d) => ({
          school: d.school.trim(),
          degree: d.degree.trim(),
          dates: d.dates.trim(),
          location: d.location.trim(),
        }))
        .filter(
          (e) => e.school || e.degree || e.dates || (e.location ?? "").length
        );

      const educationShort = education.map((e) => {
        const parts: string[] = [];
        if (e.dates) parts.push(e.dates);
        let main = "";
        if (e.degree && e.school) main = `${e.degree} – ${e.school}`;
        else if (e.degree) main = e.degree;
        else if (e.school) main = e.school;
        if (main) parts.push(main);
        if (e.location) {
          if (parts.length > 1) {
            parts[parts.length - 1] = `${parts[parts.length - 1]} (${e.location})`;
          } else {
            parts.push(`(${e.location})`);
          }
        }
        return parts.join(" · ");
      });

      const certsJoined = certsList.join(", ");

      updated = {
        ...profile,
        education,
        educationShort,
        certs: certsJoined,
      };
    }

    if (activeModal === "languages") {
      const cleaned = languagesDraft
        .map((l) => ({
          language: l.language.trim(),
          level: l.level.trim(),
        }))
        .filter((l) => l.language.length > 0);

      const langLine = cleaned
        .map((l) =>
          l.level ? `${l.language} (${l.level})` : `${l.language}`
        )
        .join(" · ");

      updated = {
        ...profile,
        langLine,
      };
    }

    if (activeModal === "hobbies") {
      const hobbies = hobbiesList
        .map((h) => h.trim())
        .filter((h) => h.length > 0);
      updated = {
        ...profile,
        hobbies,
      };
    }

    setProfile(updated);
    if (userId) {
      await saveProfileToDb(updated);
    }
    setActiveModal(null);
  };

  const handleModalCancel = () => {
    setActiveModal(null);
  };

  const headline =
    profile?.profileSummary?.split(".")[0] ||
    (profile?.contractType
      ? profile.contractType
      : "Profil en cours de configuration");

  const updatedLabel = profile?.updatedAt
    ? `Profil mis à jour le ${formatUpdatedAt(profile.updatedAt)}`
    : "Profil non encore enregistré";

  const langDisplay = parseLangLine(profile?.langLine || "");
  const visibilityLabel = userId ? "Associé à ton compte" : "Invité";

  // --- RENDER ---

  return (
    <motion.div
      initial={{ opacity: 0, y: 12 }}
      animate={{ opacity: 1, y: 0 }}
      transition={{ duration: 0.25 }}
      className="max-w-6xl mx-auto px-3 sm:px-4 py-5 sm:py-6 space-y-5"
    >
      {/* 1. VUE D'ENSEMBLE + STATS */}
      <section className="space-y-4">
        <div>
          <p className="badge-muted mb-2 flex items-center gap-1.5">
            <span className="w-1.5 h-1.5 rounded-full bg-emerald-400" />
            <span className="text-[11px] uppercase tracking-wider text-[var(--muted)]">
              Vue d&apos;ensemble
            </span>
          </p>
          <h1 className="text-xl sm:text-2xl font-semibold">
            Ton tableau de bord de candidatures
          </h1>
          <p className="text-xs sm:text-sm text-[var(--muted)] mt-1 max-w-xl">
            Accède rapidement à ton CV IA et à toutes les infos qui serviront à
            générer ton CV, tes lettres de motivation et ton pitch.
          </p>
        </div>

        {/* STATS CARDS */}
        <div className="grid gap-3 md:grid-cols-4">
          {/* Crédits */}
          <div className="glass p-4 rounded-2xl border border-[var(--border)]/80">
            <p className="text-[11px] uppercase tracking-[0.18em] text-[var(--muted)] mb-1">
              Crédits restants
            </p>
            <p className="text-2xl font-semibold">
              {loadingAccountProfile ? "…" : remainingCredits}
            </p>
            <p className="text-[11px] text-[var(--muted)]">
              Utilisés pour analyser ton CV et générer des contenus.
            </p>
          </div>

          {/* CV générés */}
          <div className="glass p-4 rounded-2xl border border-[var(--border)]/80">
            <p className="text-[11px] uppercase tracking-[0.18em] text-[var(--muted)] mb-1">
              CV générés
            </p>
            <p className="text-2xl font-semibold">
              {loadingCounts ? "…" : dashboardCounts.cvCount}
            </p>
            <p className="text-[11px] text-[var(--muted)]">
              Nombre de candidatures où un <strong>CV IA</strong> est associé
              (coché ou généré).
            </p>
          </div>

          {/* LM IA générées */}
          <div className="glass p-4 rounded-2xl border border-[var(--border)]/80">
            <p className="text-[11px] uppercase tracking-[0.18em] text-[var(--muted)] mb-1">
              LM IA générées
            </p>
            <p className="text-2xl font-semibold">
              {loadingCounts ? "…" : dashboardCounts.lmCount}
            </p>
            <p className="text-[11px] text-[var(--muted)]">
              Nombre de candidatures avec une <strong>lettre IA</strong>{" "}
              associée.
            </p>
          </div>

          {/* Candidatures suivies */}
          <div className="glass p-4 rounded-2xl border border-[var(--border)]/80">
            <p className="text-[11px] uppercase tracking-[0.18em] text-[var(--muted)] mb-1">
              Candidatures suivies
            </p>
            <p className="text-2xl font-semibold">
              {loadingCounts ? "…" : dashboardCounts.totalApps}
            </p>
            <p className="text-[11px] text-[var(--muted)]">
              Total de lignes dans ton{" "}
              <strong>tracker de candidatures</strong>.
            </p>
          </div>
        </div>
      </section>

      {/* 2. HEADER PROFIL + MON CV + RADAR */}
      <header
        id="infos-personnelles"
        className="glass border border-[var(--border)]/80 rounded-2xl p-4 sm:p-5 flex flex-col lg:flex-row gap-4 md:items-stretch"
      >
        {/* Colonne gauche : identité, résumé, CV, infos clés */}
        <div className="flex flex-col flex-1 gap-3">
          {/* Identité */}
          <div className="flex items-center gap-3 sm:gap-4">
            <div className="flex h-14 w-14 sm:h-16 sm:w-16 items-center justify-center rounded-full bg-[var(--bg-soft)] border border-[var(--border)] text-base sm:text-lg font-semibold">
              {getInitials(profile?.fullName || userEmail || "")}
            </div>
            <div className="space-y-1">
              <div className="flex flex-wrap items-center gap-1.5">
                <h2 className="text-base sm:text-lg font-semibold">
                  {profile?.fullName || "Ton profil candidat"}
                </h2>
                {userEmail && (
                  <span className="rounded-full border border-[var(--border)] px-2 py-[2px] text-[10px] text-[var(--muted)]">
                    Connecté·e en tant que{" "}
                    <span className="font-medium text-[11px] text-white">
                      {userEmail}
                    </span>
                  </span>
                )}
              </div>
              <p className="text-[12px] text-[var(--muted)] line-clamp-2">
                {headline}
              </p>
              {(profile?.address || profile?.city) && (
                <p className="text-[11px] text-[var(--muted)]">
                  {profile.address || profile.city}
                </p>
              )}
              <p className="text-[11px] text-[var(--muted)]">{updatedLabel}</p>
            </div>
          </div>

          {/* Mon CV */}
          <section className="rounded-xl border border-[var(--border)]/80 bg-[var(--bg-soft)] p-3 sm:p-3.5 flex flex-col md:flex-row gap-3 md:items-center">
            <div className="flex-1 space-y-1">
              <div className="flex items-center gap-2 flex-wrap">
                <span className="inline-flex items-center rounded-full border border-[var(--border)] bg-[var(--bg)] px-2 py-[2px] text-[11px]">
                  Mon CV
                </span>
                <p className="text-[11px] text-[var(--muted)]">
                  {profile
                    ? "Ton CV a été analysé et ton profil est sauvegardé."
                    : "Aucun CV analysé pour le moment."}
                </p>
              </div>
              {loadingProfileFromDb && (
                <p className="text-[11px] text-[var(--muted)]">
                  Chargement de ton profil sauvegardé...
                </p>
              )}
            </div>

            <div className="flex flex-col sm:flex-row gap-2 items-stretch sm:items-center md:ml-auto">
              <label className="flex-1 cursor-pointer">
                <div className="w-full rounded-lg border border-dashed border-[var(--border)] bg-[var(--bg)] px-3 py-2.5 text-[12px] text-[var(--muted)] hover:border-[var(--brand)]/80 hover:bg-[var(--bg-soft)] transition-colors">
                  {file ? (
                    <div className="flex items-center justify-between gap-2">
                      <span className="truncate">{file.name}</span>
                      <span className="text-[11px] text-[var(--muted)]">
                        {(file.size / 1024 / 1024).toFixed(2)} Mo
                      </span>
                    </div>
                  ) : (
                    <span>Choisir un CV (PDF)</span>
                  )}
                </div>
                <input
                  type="file"
                  accept="application/pdf"
                  className="hidden"
                  onChange={handleFileChange}
                />
              </label>

              <button
                type="button"
                onClick={handleUpload}
                disabled={
                  uploading ||
                  !file ||
                  loadingAccountProfile ||
                  isBlocked ||
                  remainingCredits <= 0
                }
                className="sm:w-[160px] inline-flex items-center justify-center rounded-lg bg-[var(--brand)] hover:bg-[var(--brandDark)] disabled:opacity-60 disabled:cursor-not-allowed text-[13px] font-medium text-white px-3 py-2 transition-colors"
              >
                {uploading
                  ? "Analyse en cours..."
                  : isBlocked
                  ? "Compte bloqué"
                  : remainingCredits <= 0
                  ? "Plus de crédits"
                  : "Analyser / Mettre à jour"}
              </button>
            </div>
          </section>

          {/* Informations clés */}
          {profile && (
            <div className="rounded-xl border border-[var(--border)]/60 bg-[var(--bg-soft)] p-3 space-y-2">
              <div className="flex items-center justify-between gap-2">
                <p className="text-[11px] text-[var(--muted)] font-medium">
                  Informations clés
                </p>
                <button
                  type="button"
                  onClick={openInfosModal}
                  className="inline-flex items-center gap-1 rounded-full border border-[var(--border)] bg-[var(--bg)] px-2.5 py-1 text-[11px] text-[var(--muted)] hover:border-[var(--brand)] hover:text-[var(--brand)] transition-colors"
                >
                  <span className="text-[13px]">✏️</span>
                  <span>Modifier / ajouter</span>
                </button>
              </div>
              <div className="grid gap-3 sm:grid-cols-2 text-[12px]">
                <div>
                  <p className="text-[11px] text-[var(--muted)]">Email</p>
                  <p className="font-medium">
                    {profile.email || userEmail || "—"}
                  </p>
                </div>
                <div>
                  <p className="text-[11px] text-[var(--muted)]">Téléphone</p>
                  <p className="font-medium">{profile.phone || "—"}</p>
                </div>
                <div>
                  <p className="text-[11px] text-[var(--muted)]">LinkedIn</p>
                  <p className="font-medium break-all">
                    {profile.linkedin || "—"}
                  </p>
                </div>
                <div>
                  <p className="text-[11px] text-[var(--muted)]">Adresse</p>
                  <p className="font-medium line-clamp-2">
                    {profile.address || profile.city || "—"}
                  </p>
                </div>
                <div>
                  <p className="text-[11px] text-[var(--muted)]">
                    Contrat recherché
                  </p>
                  <p className="font-medium line-clamp-2">
                    {profile.contractType || "Non renseigné"}
                  </p>
                </div>
                <div>
                  <p className="text-[11px] text-[var(--muted)]">
                    Permis de conduire
                  </p>
                  <p className="font-medium">
                    {profile.drivingLicense || "—"}
                  </p>
                </div>
                <div>
                  <p className="text-[11px] text-[var(--muted)]">Véhicule</p>
                  <p className="font-medium">{profile.vehicle || "—"}</p>
                </div>
              </div>
            </div>
          )}

          {error && (
            <div className="mt-1 w-full rounded-lg border border-red-500/40 bg-red-500/10 px-3 py-2 text-[11px] text-red-100">
              {error}
            </div>
          )}

          {/* Visibilité */}
          <div className="text-[11px] text-[var(--muted)]">
            Visibilité :{" "}
            <span className="font-medium text-[var(--text)]">
              {visibilityLabel}
            </span>
          </div>
        </div>

        {/* Colonne droite : RADAR */}
        <div className="md:w-[320px] lg:w-[360px] flex-shrink-0">
          <div className="rounded-2xl bg-[var(--bg-soft)] border border-[var(--border)]/80 px-3 py-3 sm:p-4 h-full flex flex-col">
            <p className="text-[11px] text-[var(--muted)] mb-2">
              Radar de compétences estimé
            </p>
            <div className="relative flex-1 min-h-[210px]">
              <canvas
                id="skillsRadarChart"
                ref={radarCanvasRef}
                className="w-full h-full"
              />
            </div>
          </div>
        </div>
      </header>

      {/* 3. CONTENU PRINCIPAL : NAV GAUCHE + SECTIONS */}
      <div className="lg:grid lg:grid-cols-[220px,1fr] gap-4 sm:gap-5">
        {/* Sidebar navigation */}
        <aside className="mb-3 lg:mb-0">
          <motion.nav
            initial={{ opacity: 0, y: 10 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ duration: 0.35 }}
            className="glass border border-[var(--border)]/80 rounded-2xl py-3 text-[12px] sticky top-20 lg:top-24"
          >
            <p className="px-3 pb-1 text-[11px] text-[var(--muted)]">
              Navigation rapide
            </p>
            <ul className="space-y-0.5">
              {navItems.map((item, idx) => (
                <motion.li
                  key={item.id}
                  initial={{ opacity: 0, x: -8 }}
                  animate={{ opacity: 1, x: 0 }}
                  transition={{ delay: 0.1 + idx * 0.05 }}
                >
                  <a
                    href={`#${item.id}`}
                    className="flex items-center justify-between px-3 py-2 hover:bg-[var(--bg-soft)] text-[12px] rounded-md transition-colors"
                  >
                    <span>{item.label}</span>
                    <motion.span
                      whileHover={{ x: 2 }}
                      className="text-[10px] text-[var(--muted)]"
                    >
                      ↗
                    </motion.span>
                  </a>
                </motion.li>
              ))}
            </ul>
          </motion.nav>
        </aside>

        {/* Main content */}
        <main className="space-y-4 sm:space-y-5">
          {/* Compétences */}
          {profile?.skills && (
            <section
              id="competences"
              className="glass border border-[var(--border)]/80 rounded-2xl p-4 sm:p-5 space-y-4"
            >
              <div className="flex items-center justify-between gap-2 mb-1">
                <h2 className="text-sm sm:text-base font-semibold">
                  Compétences &amp; Outils
                </h2>
                <button
                  type="button"
                  onClick={openSkillsModal}
                  className="inline-flex items-center gap-1 rounded-full border border-[var(--border)] bg-[var(--bg-soft)] px-2.5 py-1 text-[11px] text-[var(--muted)] hover:border-[var(--brand)] hover:text-[var(--brand)] transition-colors"
                >
                  <span className="text-[13px]">✏️</span>
                  <span>Modifier / ajouter</span>
                </button>
              </div>

              {profile.skills.sections?.length > 0 && (
                <div className="space-y-4">
                  {profile.skills.sections.map((section, idx) => (
                    <div key={idx} className="space-y-1">
                      <p className="text-[11px] uppercase tracking-wide text-[var(--muted)]">
                        {section.title}
                      </p>
                      <div className="flex flex-wrap gap-2 text-[12px]">
                        {section.items.map((s, i) => (
                          <span key={i} className="badge">
                            {s}
                          </span>
                        ))}
                      </div>
                    </div>
                  ))}
                </div>
              )}

              {profile.skills.tools?.length > 0 && (
                <div className="space-y-1 pt-2 border-t border-[var(--border)]/80">
                  <p className="text-[11px] uppercase tracking-wide text-[var(--muted)]">
                    Outils / logiciels
                  </p>
                  <div className="flex flex-wrap gap-2 text-[12px]">
                    {profile.skills.tools.map((tool, idx) => (
                      <span key={idx} className="badge">
                        {tool}
                      </span>
                    ))}
                  </div>
                </div>
              )}
            </section>
          )}

          {/* Expérience */}
          {profile?.experiences?.length ? (
            <section
              id="experience"
              className="glass border border-[var(--border)]/80 rounded-2xl p-4 sm:p-5"
            >
              <div className="flex items-center justify-between gap-2 mb-2">
                <h2 className="text-sm sm:text-base font-semibold">
                  Expériences principales
                </h2>
                <button
                  type="button"
                  onClick={openExperienceModal}
                  className="inline-flex items-center gap-1 rounded-full border border-[var(--border)] bg-[var(--bg-soft)] px-2.5 py-1 text-[11px] text-[var(--muted)] hover:border-[var(--brand)] hover:text-[var(--brand)] transition-colors"
                >
                  <span className="text-[13px]">✏️</span>
                  <span>Modifier / ajouter</span>
                </button>
              </div>

              <ul className="space-y-3 text-[12px]">
                {profile.experiences.map((exp, idx) => (
                  <li
                    key={idx}
                    className="rounded-lg bg-[var(--bg-soft)] border border-[var(--border)]/70 px-3 py-3"
                  >
                    <p className="font-medium">
                      {exp.role || "Poste"} · {exp.company || "Entreprise"}
                    </p>
                    <p className="text-[11px] text-[var(--muted)]">
                      {exp.dates || ""}
                    </p>
                    {exp.bullets?.length > 0 && (
                      <ul className="mt-1 list-disc list-inside space-y-0.5">
                        {exp.bullets.map((b, i) => (
                          <li key={i}>{b}</li>
                        ))}
                      </ul>
                    )}
                  </li>
                ))}
              </ul>
            </section>
          ) : null}

          {/* Formation & certifs */}
          {profile && (profile.educationShort?.length || profile.certs) && (
            <section
              id="formation"
              className="glass border border-[var(--border)]/80 rounded-2xl p-4 sm:p-5 space-y-4"
            >
              <div className="flex items-center justify-between gap-2 mb-2">
                <h2 className="text-sm sm:text-base font-semibold">
                  Formation &amp; Certifications
                </h2>
                <button
                  type="button"
                  onClick={openEducationModal}
                  className="inline-flex items-center gap-1 rounded-full border border-[var(--border)] bg-[var(--bg-soft)] px-2.5 py-1 text-[11px] text-[var(--muted)] hover:border-[var(--brand)] hover:text-[var(--brand)] transition-colors"
                >
                  <span className="text-[13px]">✏️</span>
                  <span>Modifier / ajouter</span>
                </button>
              </div>

              {profile?.educationShort?.length ? (
                <div>
                  <ul className="space-y-1.5 text-[12px]">
                    {profile.educationShort.map((line, idx) => (
                      <li key={idx}>{line}</li>
                    ))}
                  </ul>
                </div>
              ) : null}

              {profile?.certs && (
                <div>
                  <p className="text-[11px] text-[var(--muted)] mb-1">
                    Certifications
                  </p>
                  <p className="text-[12px]">{profile.certs}</p>
                </div>
              )}
            </section>
          )}

          {/* Langues */}
          {profile && (
            <section
              id="langues"
              className="glass border border-[var(--border)]/80 rounded-2xl p-4 sm:p-5 space-y-3"
            >
              <div className="flex items-center justify-between gap-2 mb-1">
                <h2 className="text-sm sm:text-base font-semibold">
                  Langues
                </h2>
                <button
                  type="button"
                  onClick={openLanguagesModal}
                  className="inline-flex items-center gap-1 rounded-full border border-[var(--border)] bg-[var(--bg-soft)] px-2.5 py-1 text-[11px] text-[var(--muted)] hover:border-[var(--brand)] hover:text-[var(--brand)] transition-colors"
                >
                  <span className="text-[13px]">✏️</span>
                  <span>Modifier / ajouter</span>
                </button>
              </div>
              {langDisplay.length > 0 ? (
                <div className="flex flex-wrap gap-x-6 gap-y-3 text-[13px]">
                  {langDisplay.map((lang, idx) => (
                    <div key={idx} className="flex items-center gap-2">
                      <span className="text-2xl">{lang.flag}</span>
                      <span className="font-medium text-[var(--text)]">
                        {lang.text}
                      </span>
                    </div>
                  ))}
                </div>
              ) : (
                <p className="text-[12px] text-[var(--muted)]">
                  Aucune langue renseignée pour le moment.
                </p>
              )}
            </section>
          )}

          {/* Hobbies */}
          {profile && (
            <section
              id="hobbies"
              className="glass border border-[var(--border)]/80 rounded-2xl p-4 sm:p-5"
            >
              <div className="flex items-center justify-between gap-2 mb-2">
                <h2 className="text-sm sm:text-base font-semibold">
                  Centres d&apos;intérêt
                </h2>
                <button
                  type="button"
                  onClick={openHobbiesModal}
                  className="inline-flex items-center gap-1 rounded-full border border-[var(--border)] bg-[var(--bg-soft)] px-2.5 py-1 text-[11px] text-[var(--muted)] hover:border-[var(--brand)] hover:text-[var(--brand)] transition-colors"
                >
                  <span className="text-[13px]">✏️</span>
                  <span>Modifier / ajouter</span>
                </button>
              </div>
              {profile.hobbies?.length ? (
                <div className="flex flex-wrap gap-2 text-[12px]">
                  {profile.hobbies.map((hobby) => (
                    <span
                      key={hobby}
                      className="inline-flex items-center gap-1 rounded-full border border-[var(--border)] bg-[var(--bg-soft)] px-2 py-[3px]"
                    >
                      <span>{getHobbyEmoji(hobby)}</span>
                      <span>{hobby}</span>
                    </span>
                  ))}
                </div>
              ) : (
                <p className="text-[12px] text-[var(--muted)]">
                  Aucun centre d&apos;intérêt renseigné pour le moment.
                </p>
              )}
            </section>
          )}
        </main>
      </div>

      {/* Message si aucun profil */}
      {!profile && !loadingProfileFromDb && (
        <div className="text-center p-10 glass border border-[var(--border)]/80 rounded-2xl">
          <h3 className="text-lg font-semibold mb-2">
            Aucun profil enregistré ou analysé
          </h3>
          <p className="text-[13px] text-[var(--muted)]">
            Veuille uploader un CV PDF dans le header ci-dessus pour initialiser
            ton profil candidat IA.
          </p>
        </div>
      )}

      {/* --- MODALE GÉNÉRIQUE D'ÉDITION --- */}
      {activeModal && (
        <div className="fixed inset-0 z-40 flex items-center justify-center bg-black/40 px-3">
          <motion.form
            onSubmit={handleModalSave}
            initial={{ opacity: 0, y: 16, scale: 0.97 }}
            animate={{ opacity: 1, y: 0, scale: 1 }}
            exit={{ opacity: 0, y: 16, scale: 0.97 }}
            className="w-full max-w-lg rounded-2xl bg-[var(--bg)] border border-[var(--border)] shadow-xl p-4 sm:p-5 space-y-4"
          >
            <div className="flex items-center justify-between gap-2">
              <h3 className="text-sm sm:text-base font-semibold">
                {activeModal === "infos" && "Modifier tes informations clés"}
                {activeModal === "skills" &&
                  "Modifier tes compétences & outils"}
                {activeModal === "experience" &&
                  "Modifier tes expériences principales"}
                {activeModal === "education" &&
                  "Modifier ta formation & tes certifications"}
                {activeModal === "languages" && "Modifier tes langues"}
                {activeModal === "hobbies" &&
                  "Modifier tes centres d’intérêt"}
              </h3>
              <button
                type="button"
                onClick={handleModalCancel}
                className="rounded-full px-2 py-1 text-[11px] text-[var(--muted)] hover:bg-[var(--bg-soft)]"
              >
                ✕
              </button>
            </div>

            <div className="space-y-3 max-h-[60vh] overflow-auto pr-1">
              {/* INFOS */}
              {activeModal === "infos" && (
                <>
                  <div className="grid sm:grid-cols-2 gap-3 text-[12px]">
                    <div>
                      <label className="text-[11px] text-[var(--muted)]">
                        Nom complet
                      </label>
                      <input
                        className="mt-1 w-full rounded-md border border-[var(--border)] bg-[var(--bg-soft)] px-2 py-1.5 text-[12px] outline-none focus:ring-1 focus:ring-[var(--brand)]"
                        value={infosDraft.fullName}
                        onChange={(e) =>
                          setInfosDraft((p) => ({
                            ...p,
                            fullName: e.target.value,
                          }))
                        }
                      />
                    </div>
                    <div>
                      <label className="text-[11px] text-[var(--muted)]">
                        Email
                      </label>
                      <input
                        className="mt-1 w-full rounded-md border border-[var(--border)] bg-[var(--bg-soft)] px-2 py-1.5 text-[12px] outline-none focus:ring-1 focus:ring-[var(--brand)]"
                        value={infosDraft.email}
                        onChange={(e) =>
                          setInfosDraft((p) => ({
                            ...p,
                            email: e.target.value,
                          }))
                        }
                      />
                    </div>
                    <div>
                      <label className="text-[11px] text-[var(--muted)]">
                        Téléphone
                      </label>
                      <input
                        className="mt-1 w-full rounded-md border border-[var(--border)] bg-[var(--bg-soft)] px-2 py-1.5 text-[12px] outline-none focus:ring-1 focus:ring-[var(--brand)]"
                        value={infosDraft.phone}
                        onChange={(e) =>
                          setInfosDraft((p) => ({
                            ...p,
                            phone: e.target.value,
                          }))
                        }
                      />
                    </div>
                    <div>
                      <label className="text-[11px] text-[var(--muted)]">
                        LinkedIn
                      </label>
                      <input
                        className="mt-1 w-full rounded-md border border-[var(--border)] bg-[var(--bg-soft)] px-2 py-1.5 text-[12px] outline-none focus:ring-1 focus:ring-[var(--brand)]"
                        value={infosDraft.linkedin}
                        onChange={(e) =>
                          setInfosDraft((p) => ({
                            ...p,
                            linkedin: e.target.value,
                          }))
                        }
                      />
                    </div>
                    <div>
                      <label className="text-[11px] text-[var(--muted)]">
                        Permis (ex : Permis B)
                      </label>
                      <input
                        className="mt-1 w-full rounded-md border border-[var(--border)] bg-[var(--bg-soft)] px-2 py-1.5 text-[12px] outline-none focus:ring-1 focus:ring-[var(--brand)]"
                        value={infosDraft.drivingLicense}
                        onChange={(e) =>
                          setInfosDraft((p) => ({
                            ...p,
                            drivingLicense: e.target.value,
                          }))
                        }
                      />
                    </div>
                    <div>
                      <label className="text-[11px] text-[var(--muted)]">
                        Véhicule (ex : Véhiculé)
                      </label>
                      <input
                        className="mt-1 w-full rounded-md border border-[var(--border)] bg-[var(--bg-soft)] px-2 py-1.5 text-[12px] outline-none focus:ring-1 focus:ring-[var(--brand)]"
                        value={infosDraft.vehicle}
                        onChange={(e) =>
                          setInfosDraft((p) => ({
                            ...p,
                            vehicle: e.target.value,
                          }))
                        }
                      />
                    </div>
                    <div className="sm:col-span-2">
                      <label className="text-[11px] text-[var(--muted)]">
                        Adresse (ville, code postal, etc.)
                      </label>
                      <input
                        className="mt-1 w-full rounded-md border border-[var(--border)] bg-[var(--bg-soft)] px-2 py-1.5 text-[12px] outline-none focus:ring-1 focus:ring-[var(--brand)]"
                        placeholder="Ex : 12 rue Exemple, 75000 Paris"
                        value={infosDraft.address}
                        onChange={(e) =>
                          setInfosDraft((p) => ({
                            ...p,
                            address: e.target.value,
                          }))
                        }
                      />
                    </div>
                  </div>
                  <div className="text-[12px]">
                    <label className="text-[11px] text-[var(--muted)]">
                      Contrat recherché
                    </label>
                    <input
                      list="contract-type-options"
                      className="mt-1 w-full rounded-md border border-[var(--border)] bg-[var(--bg-soft)] px-2 py-1.5 text-[12px] outline-none focus:ring-1 focus:ring-[var(--brand)]"
                      placeholder="Ex : CDI, Alternance, Stage, Freelance..."
                      value={infosDraft.contractType}
                      onChange={(e) =>
                        setInfosDraft((p) => ({
                          ...p,
                          contractType: e.target.value,
                        }))
                      }
                    />
                    <datalist id="contract-type-options">
                      {CONTRACT_TYPE_OPTIONS.map((c) => (
                        <option key={c} value={c} />
                      ))}
                    </datalist>
                  </div>
                  <div className="text-[12px]">
                    <label className="text-[11px] text-[var(--muted)]">
                      Résumé de profil / Pitch
                    </label>
                    <textarea
                      rows={4}
                      className="mt-1 w-full rounded-md border border-[var(--border)] bg-[var(--bg-soft)] px-2 py-1.5 text-[12px] outline-none focus:ring-1 focus:ring-[var(--brand)] resize-vertical"
                      value={infosDraft.profileSummary}
                      onChange={(e) =>
                        setInfosDraft((p) => ({
                          ...p,
                          profileSummary: e.target.value,
                        }))
                      }
                    />
                  </div>
                </>
              )}

              {/* COMPÉTENCES */}
              {activeModal === "skills" && (
                <>
                  <div className="text-[12px] space-y-1">
                    <label className="text-[11px] text-[var(--muted)]">
                      Sections de compétences
                    </label>
                    <p className="text-[11px] text-[var(--muted)]">
                      Format conseillé : une ligne par section. Exemple :
                      <br />
                      <span className="italic">
                        &quot;Compétences analytiques : Analyse financière,
                        Reporting, Budget&quot;
                      </span>
                    </p>
                    <textarea
                      rows={5}
                      className="mt-1 w-full rounded-md border border-[var(--border)] bg-[var(--bg-soft)] px-2 py-1.5 text-[12px] outline-none focus:ring-1 focus:ring-[var(--brand)] resize-vertical"
                      value={skillsSectionsText}
                      onChange={(e) => setSkillsSectionsText(e.target.value)}
                    />
                  </div>
                  <div className="text-[12px] space-y-1">
                    <label className="text-[11px] text-[var(--muted)]">
                      Outils / logiciels (séparés par des virgules)
                    </label>
                    <textarea
                      rows={2}
                      className="mt-1 w-full rounded-md border border-[var(--border)] bg-[var(--bg-soft)] px-2 py-1.5 text-[12px] outline-none focus:ring-1 focus:ring-[var(--brand)] resize-vertical"
                      value={skillsToolsText}
                      onChange={(e) => setSkillsToolsText(e.target.value)}
                    />
                  </div>
                </>
              )}

              {/* EXPÉRIENCE */}
              {activeModal === "experience" && (
                <div className="space-y-3 text-[12px]">
                  {experiencesDraft.map((exp, idx) => (
                    <div
                      key={idx}
                      className="rounded-lg border border-[var(--border)]/70 bg-[var(--bg-soft)] p-3 space-y-2"
                    >
                      <div className="grid sm:grid-cols-2 gap-2">
                        <div>
                          <label className="text-[11px] text-[var(--muted)]">
                            Poste
                          </label>
                          <input
                            className="mt-1 w-full rounded-md border border-[var(--border)] bg-[var(--bg)] px-2 py-1.5 text-[12px] outline-none focus:ring-1 focus:ring-[var(--brand)]"
                            value={exp.role}
                            onChange={(e) =>
                              updateExperienceDraft(
                                idx,
                                "role",
                                e.target.value
                              )
                            }
                          />
                        </div>
                        <div>
                          <label className="text-[11px] text-[var(--muted)]">
                            Entreprise
                          </label>
                          <input
                            className="mt-1 w-full rounded-md border border-[var(--border)] bg-[var(--bg)] px-2 py-1.5 text-[12px] outline-none focus:ring-1 focus:ring-[var(--brand)]"
                            value={exp.company}
                            onChange={(e) =>
                              updateExperienceDraft(
                                idx,
                                "company",
                                e.target.value
                              )
                            }
                          />
                        </div>
                        <div>
                          <label className="text-[11px] text-[var(--muted)]">
                            Dates
                          </label>
                          <input
                            className="mt-1 w-full rounded-md border border-[var(--border)] bg-[var(--bg)] px-2 py-1.5 text-[12px] outline-none focus:ring-1 focus:ring-[var(--brand)]"
                            value={exp.dates}
                            onChange={(e) =>
                              updateExperienceDraft(
                                idx,
                                "dates",
                                e.target.value
                              )
                            }
                          />
                        </div>
                      </div>
                      <div>
                        <label className="text-[11px] text-[var(--muted)]">
                          Missions / Réalisations (une par ligne)
                        </label>
                        <textarea
                          rows={3}
                          className="mt-1 w-full rounded-md border border-[var(--border)] bg-[var(--bg)] px-2 py-1.5 text-[12px] outline-none focus:ring-1 focus:ring-[var(--brand)] resize-vertical"
                          value={exp.bulletsText}
                          onChange={(e) =>
                            updateExperienceDraft(
                              idx,
                              "bulletsText",
                              e.target.value
                            )
                          }
                        />
                      </div>
                    </div>
                  ))}

                  <button
                    type="button"
                    onClick={addExperienceDraft}
                    className="inline-flex items-center gap-1 rounded-full border border-dashed border-[var(--border)] bg-[var(--bg-soft)] px-3 py-1.5 text-[11px] text-[var(--muted)] hover:border-[var(--brand)] hover:text-[var(--brand)] transition-colors"
                  >
                    <span className="text-[14px]">＋</span>
                    <span>Ajouter une expérience</span>
                  </button>
                </div>
              )}

              {/* FORMATION & CERTIFS */}
              {activeModal === "education" && (
                <>
                  <div className="space-y-3 text-[12px]">
                    {educationDrafts.map((edu, idx) => (
                      <div
                        key={idx}
                        className="rounded-lg border border-[var(--border)]/70 bg-[var(--bg-soft)] p-3 space-y-2"
                      >
                        <div className="grid sm:grid-cols-2 gap-2">
                          <div>
                            <label className="text-[11px] text-[var(--muted)]">
                              Diplôme
                            </label>
                            <input
                              className="mt-1 w-full rounded-md border border-[var(--border)] bg-[var(--bg)] px-2 py-1.5 text-[12px] outline-none focus:ring-1 focus:ring-[var(--brand)]"
                              value={edu.degree}
                              onChange={(e) =>
                                updateEducationDraft(
                                  idx,
                                  "degree",
                                  e.target.value
                                )
                              }
                            />
                          </div>
                          <div>
                            <label className="text-[11px] text-[var(--muted)]">
                              École / Université
                            </label>
                            <input
                              className="mt-1 w-full rounded-md border border-[var(--border)] bg-[var(--bg)] px-2 py-1.5 text-[12px] outline-none focus:ring-1 focus:ring-[var(--brand)]"
                              value={edu.school}
                              onChange={(e) =>
                                updateEducationDraft(
                                  idx,
                                  "school",
                                  e.target.value
                                )
                              }
                            />
                          </div>
                          <div>
                            <label className="text-[11px] text-[var(--muted)]">
                              Lieu (optionnel)
                            </label>
                            <input
                              className="mt-1 w-full rounded-md border border-[var(--border)] bg-[var(--bg)] px-2 py-1.5 text-[12px] outline-none focus:ring-1 focus:ring-[var(--brand)]"
                              value={edu.location}
                              onChange={(e) =>
                                updateEducationDraft(
                                  idx,
                                  "location",
                                  e.target.value
                                )
                              }
                            />
                          </div>
                          <div>
                            <label className="text-[11px] text-[var(--muted)]">
                              Dates
                            </label>
                            <input
                              className="mt-1 w-full rounded-md border border-[var(--border)] bg-[var(--bg)] px-2 py-1.5 text-[12px] outline-none focus:ring-1 focus:ring-[var(--brand)]"
                              placeholder="Ex : 2022–2024"
                              value={edu.dates}
                              onChange={(e) =>
                                updateEducationDraft(
                                  idx,
                                  "dates",
                                  e.target.value
                                )
                              }
                            />
                          </div>
                        </div>
                        {educationDrafts.length > 1 && (
                          <div className="flex justify-end">
                            <button
                              type="button"
                              onClick={() =>
                                setEducationDrafts((prev) =>
                                  prev.filter((_, i) => i !== idx)
                                )
                              }
                              className="text-[11px] text-[var(--muted)] hover:text-red-400"
                            >
                              Supprimer cette formation
                            </button>
                          </div>
                        )}
                      </div>
                    ))}

                    <button
                      type="button"
                      onClick={addEducationDraft}
                      className="inline-flex items-center gap-1 rounded-full border border-dashed border-[var(--border)] bg-[var(--bg-soft)] px-3 py-1.5 text-[11px] text-[var(--muted)] hover:border-[var(--brand)] hover:text-[var(--brand)] transition-colors"
                    >
                      <span className="text-[14px]">＋</span>
                      <span>Ajouter une formation</span>
                    </button>
                  </div>

                  {/* Certifications */}
                  <div className="text-[12px] space-y-2 pt-3">
                    <label className="text-[11px] text-[var(--muted)]">
                      Certifications (avec auto-complétion)
                    </label>
                    <div className="flex gap-2">
                      <input
                        list="certification-options"
                        className="flex-1 rounded-md border border-[var(--border)] bg-[var(--bg-soft)] px-2 py-1.5 text-[12px] outline-none focus:ring-1 focus:ring-[var(--brand)]"
                        placeholder="Ex : Tosa Excel, Azure AZ-900..."
                        value={certInput}
                        onChange={(e) => setCertInput(e.target.value)}
                      />
                      <button
                        type="button"
                        onClick={() => {
                          const val = certInput.trim();
                          if (!val) return;
                          if (!certsList.includes(val)) {
                            setCertsList((prev) => [...prev, val]);
                          }
                          setCertInput("");
                        }}
                        className="rounded-md bg-[var(--brand)] hover:bg-[var(--brandDark)] px-3 py-1.5 text-[12px] text-white"
                      >
                        Ajouter
                      </button>
                      <datalist id="certification-options">
                        {CERTIFICATION_OPTIONS.map((c) => (
                          <option key={c} value={c} />
                        ))}
                      </datalist>
                    </div>

                    {certsList.length > 0 && (
                      <div className="flex flex-wrap gap-2 mt-1">
                        {certsList.map((cert) => (
                          <span
                            key={cert}
                            className="inline-flex items-center gap-1 rounded-full border border-[var(--border)] bg-[var(--bg-soft)] px-2 py-[2px] text-[11px]"
                          >
                            {cert}
                            <button
                              type="button"
                              onClick={() =>
                                setCertsList((prev) =>
                                  prev.filter((c) => c !== cert)
                                )
                              }
                              className="text-[10px] text-[var(--muted)] hover:text-red-400"
                            >
                              ✕
                            </button>
                          </span>
                        ))}
                      </div>
                    )}
                  </div>
                </>
              )}

              {/* LANGUES */}
              {activeModal === "languages" && (
                <div className="text-[12px] space-y-3">
                  <p className="text-[11px] text-[var(--muted)]">
                    Ajoute tes langues avec leur niveau. Tu peux choisir dans la
                    liste ou taper manuellement.
                  </p>
                  {languagesDraft.map((lang, idx) => {
                    const flag =
                      lang.language.trim() !== ""
                        ? getFlagEmoji(lang.language)
                        : "🌐";
                    return (
                      <div
                        key={idx}
                        className="flex items-center gap-2 rounded-lg border border-[var(--border)]/70 bg-[var(--bg-soft)] px-2.5 py-2"
                      >
                        <span className="text-xl w-7 text-center">{flag}</span>
                        <div className="flex-1 grid grid-cols-1 sm:grid-cols-2 gap-2">
                          <div>
                            <label className="text-[11px] text-[var(--muted)]">
                              Langue
                            </label>
                            <input
                              list="language-options"
                              className="mt-1 w-full rounded-md border border-[var(--border)] bg-[var(--bg)] px-2 py-1.5 text-[12px] outline-none focus:ring-1 focus:ring-[var(--brand)]"
                              value={lang.language}
                              onChange={(e) =>
                                setLanguagesDraft((prev) =>
                                  prev.map((l, i) =>
                                    i === idx
                                      ? { ...l, language: e.target.value }
                                      : l
                                  )
                                )
                              }
                            />
                          </div>
                          <div>
                            <label className="text-[11px] text-[var(--muted)]">
                              Niveau
                            </label>
                            <select
                              className="mt-1 w-full rounded-md border border-[var(--border)] bg-[var(--bg)] px-2 py-1.5 text-[12px] outline-none focus:ring-1 focus:ring-[var(--brand)]"
                              value={lang.level}
                              onChange={(e) =>
                                setLanguagesDraft((prev) =>
                                  prev.map((l, i) =>
                                    i === idx
                                      ? { ...l, level: e.target.value }
                                      : l
                                  )
                                )
                              }
                            >
                              <option value="">Sélectionner un niveau</option>
                              {LANGUAGE_LEVEL_OPTIONS.map((lvl) => (
                                <option key={lvl} value={lvl}>
                                  {lvl}
                                </option>
                              ))}
                            </select>
                          </div>
                        </div>
                        {languagesDraft.length > 1 && (
                          <button
                            type="button"
                            onClick={() =>
                              setLanguagesDraft((prev) =>
                                prev.filter((_, i) => i !== idx)
                              )
                            }
                            className="ml-1 text-[11px] text-[var(--muted)] hover:text-red-400"
                          >
                            ✕
                          </button>
                        )}
                      </div>
                    );
                  })}

                  <datalist id="language-options">
                    {LANGUAGE_OPTIONS.map((l) => (
                      <option key={l} value={l} />
                    ))}
                  </datalist>

                  <button
                    type="button"
                    onClick={() =>
                      setLanguagesDraft((prev) => [
                        ...prev,
                        { language: "", level: "" },
                      ])
                    }
                    className="inline-flex items-center gap-1 rounded-full border border-dashed border-[var(--border)] bg-[var(--bg-soft)] px-3 py-1.5 text-[11px] text-[var(--muted)] hover:border-[var(--brand)] hover:text-[var(--brand)] transition-colors"
                  >
                    <span className="text-[14px]">＋</span>
                    <span>Ajouter une langue</span>
                  </button>
                </div>
              )}

              {/* HOBBIES */}
              {activeModal === "hobbies" && (
                <div className="text-[12px] space-y-2">
                  <label className="text-[11px] text-[var(--muted)]">
                    Centres d&apos;intérêt (avec auto-complétion)
                  </label>
                  <div className="flex gap-2">
                    <input
                      list="hobby-options"
                      className="flex-1 rounded-md border border-[var(--border)] bg-[var(--bg-soft)] px-2 py-1.5 text-[12px] outline-none focus:ring-1 focus:ring-[var(--brand)]"
                      placeholder="Ex : Voyage, Football, Lecture..."
                      value={hobbyInput}
                      onChange={(e) => setHobbyInput(e.target.value)}
                    />
                    <button
                      type="button"
                      onClick={() => {
                        const val = hobbyInput.trim();
                        if (!val) return;
                        if (!hobbiesList.includes(val)) {
                          setHobbiesList((prev) => [...prev, val]);
                        }
                        setHobbyInput("");
                      }}
                      className="rounded-md bg-[var(--brand)] hover:bg-[var(--brandDark)] px-3 py-1.5 text-[12px] text-white"
                    >
                      Ajouter
                    </button>
                    <datalist id="hobby-options">
                      {HOBBY_OPTIONS.map((h) => (
                        <option key={h} value={h} />
                      ))}
                    </datalist>
                  </div>

                  {hobbiesList.length > 0 ? (
                    <div className="flex flex-wrap gap-2 mt-2">
                      {hobbiesList.map((hobby) => (
                        <span
                          key={hobby}
                          className="inline-flex items-center gap-1 rounded-full border border-[var(--border)] bg-[var(--bg-soft)] px-2 py-[2px] text-[11px]"
                        >
                          <span>{getHobbyEmoji(hobby)}</span>
                          <span>{hobby}</span>
                          <button
                            type="button"
                            onClick={() =>
                              setHobbiesList((prev) =>
                                prev.filter((h) => h !== hobby)
                              )
                            }
                            className="text-[10px] text-[var(--muted)] hover:text-red-400"
                          >
                            ✕
                          </button>
                        </span>
                      ))}
                    </div>
                  ) : (
                    <p className="text-[11px] text-[var(--muted)] mt-1">
                      Aucun centre d&apos;intérêt ajouté pour le moment.
                    </p>
                  )}
                </div>
              )}
            </div>

            <div className="flex justify-end gap-2 pt-2">
              <button
                type="button"
                onClick={handleModalCancel}
                className="inline-flex items-center justify-center rounded-lg border border-[var(--border)] bg-[var(--bg-soft)] px-3 py-1.5 text-[12px] text-[var(--muted)] hover:bg-[var(--bg)] transition-colors"
              >
                Annuler
              </button>
              <button
                type="submit"
                className="inline-flex items-center justify-center rounded-lg bg-[var(--brand)] hover:bg-[var(--brandDark)] px-3 py-1.5 text-[12px] font-medium text-white transition-colors"
              >
                Enregistrer
              </button>
            </div>
          </motion.form>
        </div>
      )}
    </motion.div>
  );
}
````

## File: app/assistance-candidature/page.tsx
````typescript
export default function AssistanceCandidaturePage() {
  // ...
}
````

## File: app/auth/verify-email/page.tsx
````typescript
"use client";

import { useEffect, useState, Suspense } from "react";
import { useSearchParams, useRouter } from "next/navigation";
import Link from "next/link";
import { applyActionCode, sendEmailVerification } from "firebase/auth";
import { auth } from "@/lib/firebase";
import { useAuth } from "@/context/AuthContext";

type Status = "idle" | "processing" | "success" | "error";

function VerifyEmailPageInner() {
  const searchParams = useSearchParams();
  const router = useRouter();
  const { user, logout } = useAuth();

  const [status, setStatus] = useState<Status>("idle");
  const [message, setMessage] = useState<string | null>(null);

  const oobCode = searchParams.get("oobCode");

  // Cas 1 : on arrive depuis le lien de vérification (oobCode dans l'URL)
  useEffect(() => {
    const verify = async () => {
      if (!oobCode) return;

      setStatus("processing");
      setMessage("Vérification de ton email en cours...");

      try {
        await applyActionCode(auth, oobCode);

        if (auth.currentUser) {
          await auth.currentUser.reload();
        }

        setStatus("success");
        setMessage(
          "Email vérifié avec succès. Tu peux maintenant accéder à ton espace candidat."
        );
      } catch (err) {
        console.error("Erreur de vérification d’email :", err);
        setStatus("error");
        setMessage(
          "Le lien de vérification est invalide ou expiré. Demande un nouveau mail de vérification."
        );
      }
    };

    verify();
  }, [oobCode]);

  const handleResend = async () => {
    if (!user) {
      setStatus("error");
      setMessage(
        "Tu dois d’abord te connecter pour renvoyer l’email de vérification."
      );
      return;
    }

    try {
      setStatus("processing");
      setMessage("Envoi d’un nouvel email de vérification...");
      await sendEmailVerification(user);
      setStatus("success");
      setMessage(
        "Email de vérification renvoyé. Vérifie ta boîte de réception."
      );
    } catch (err) {
      console.error("Erreur renvoi email :", err);
      setStatus("error");
      setMessage(
        "Impossible de renvoyer l’email pour le moment. Réessaie plus tard."
      );
    }
  };

  // 🔁 Bouton pour accéder à l'espace candidat
  const handleGoToApp = async () => {
    if (!user) {
      setStatus("error");
      setMessage(
        "Tu dois être connecté pour accéder à l’espace candidat. Connecte-toi puis reviens ici."
      );
      return;
    }

    try {
      setStatus("processing");
      setMessage("Vérification de l’état de ton email...");

      // on rafraîchit le user pour avoir le bon état de emailVerified
      if (user.reload) {
        await user.reload();
      } else if (auth.currentUser) {
        await auth.currentUser.reload();
      }

      const refreshedUser = auth.currentUser ?? user;

      if (!refreshedUser.emailVerified) {
        setStatus("error");
        setMessage(
          "Ton email n’est toujours pas vérifié. Clique sur le lien dans l’email reçu, puis réessaie."
        );
        return;
      }

      setStatus("idle");
      setMessage(null);
      router.push("/app");
    } catch (err) {
      console.error("Erreur lors du check emailVerified :", err);
      setStatus("error");
      setMessage(
        "Impossible de vérifier l’état de ton email pour le moment. Réessaie dans quelques instants."
      );
    }
  };

  // 🔌 Bouton de déconnexion → redirection vers /login
  const handleLogout = async () => {
    try {
      await logout();
      router.push("/login");
    } catch (err) {
      console.error("Erreur déconnexion :", err);
    }
  };

  return (
    <div className="min-h-screen bg-[var(--page)] text-[var(--text)]">
      {/* fond léger comme les autres pages */}
      <div className="pointer-events-none fixed inset-0 -z-10 bg-[radial-gradient(circle_at_top,_rgba(56,189,248,0.16),_transparent_55%),radial-gradient(circle_at_bottom,_rgba(94,234,212,0.12),_transparent_55%)]" />

      <div className="mx-auto flex min-h-screen max-w-6xl flex-col px-3 sm:px-4">
        {/* NAVBAR HAUT DE PAGE */}
        <header className="sticky top-0 z-20 flex items-center justify-between gap-3 border-b border-[var(--border)]/80 bg-[var(--page)]/90 px-0 py-3 backdrop-blur">
          {/* Logo + retour accueil */}
          <Link href="/" className="flex items-center gap-2">
            <div className="flex h-9 w-9 items-center justify-center rounded-2xl border border-[var(--brand)]/40 bg-[var(--brand)]/10 text-lg">
              ⚡
            </div>
            <div className="flex flex-col">
              <span className="text-xs font-semibold">
                Assistant Candidature IA
              </span>
              <span className="text-[10px] text-[var(--muted)]">
                Retour à l&apos;accueil
              </span>
            </div>
          </Link>

          {/* Liens Connexion / Inscription / Déconnexion */}
          <div className="flex items-center gap-2 text-[11px]">
            {!user && (
              <>
                <Link
                  href="/login"
                  className="rounded-full border border-[var(--border)] bg-[var(--bg-soft)] px-3 py-1.5 text-[var(--muted)] transition-colors hover:border-[var(--brand)]/60 hover:text-[var(--ink)]"
                >
                  Se connecter
                </Link>
                <Link
                  href="/signup"
                  className="rounded-full border border-[var(--brand)]/70 bg-[var(--brand)]/20 px-3 py-1.5 text-[var(--ink)] transition-colors hover:bg-[var(--brand)]/30"
                >
                  S&apos;inscrire
                </Link>
              </>
            )}

            {user && (
              <button
                type="button"
                onClick={handleLogout}
                className="rounded-full border border-[var(--border)] bg-[var(--bg-soft)] px-3 py-1.5 text-[var(--muted)] transition-colors hover:border-red-500/70 hover:text-red-200"
              >
                Se déconnecter
              </button>
            )}
          </div>
        </header>

        {/* CONTENU PRINCIPAL */}
        <main className="flex flex-1 items-center justify-center py-10">
          <div className="relative w-full max-w-md">
            {/* halo derrière la card */}
            <div className="pointer-events-none absolute -inset-6 -z-10 rounded-[32px] bg-[radial-gradient(circle_at_top,_rgba(56,189,248,0.25),_transparent_55%)] opacity-80" />

            <div className="glass space-y-5 rounded-2xl border border-[var(--border)]/80 bg-[var(--bg)]/85 px-6 py-6 shadow-[0_22px_50px_rgba(0,0,0,0.55)]">
              {/* badge étape */}
              <div className="inline-flex items-center gap-2 rounded-full border border-[var(--border)]/80 bg-[var(--bg-soft)] px-3 py-1 text-[10px] text-[var(--muted)]">
                <span className="inline-flex h-4 w-4 items-center justify-center rounded-full bg-[var(--brand)]/30 text-[9px]">
                  2
                </span>
                <span>Étape 2 · Validation du compte</span>
              </div>

              <div className="flex items-start gap-3">
                <div className="flex h-9 w-9 items-center justify-center rounded-2xl border border-[var(--brand)]/40 bg-[var(--brand)]/12 text-lg">
                  ✉️
                </div>
                <div className="space-y-1">
                  <h1 className="text-sm font-semibold">
                    Vérifie ton adresse email
                  </h1>
                  <p className="text-[11px] text-[var(--muted)] leading-relaxed">
                    Pour sécuriser ton espace candidat et activer les fonctionnalités
                    IA, nous devons vérifier ton adresse email.
                  </p>
                </div>
              </div>

              {message && (
                <div
                  className={[
                    "text-[12px] rounded-lg px-3 py-2 border leading-relaxed",
                    status === "error"
                      ? "border-red-500/60 bg-red-500/5 text-red-200"
                      : status === "success"
                      ? "border-emerald-500/60 bg-emerald-500/5 text-emerald-200"
                      : "border-[var(--border)]/80 bg-[var(--bg-soft)] text-[var(--muted)]",
                  ].join(" ")}
                >
                  {message}
                </div>
              )}

              {!oobCode && (
                <div className="space-y-2">
                  <p className="text-[11px] text-[var(--muted)] leading-relaxed">
                    Nous t’avons envoyé un lien de vérification par email. Clique sur
                    le bouton dans l’email pour valider ton compte, puis reviens sur
                    cette page.
                  </p>
                  <ul className="space-y-1 text-[11px] text-[var(--muted)]">
                    <li>• Vérifie aussi les spams / courriers indésirables</li>
                    <li>• Le lien est valable pendant un temps limité</li>
                  </ul>
                </div>
              )}

              <div className="flex flex-col gap-2 text-[12px]">
                <button
                  type="button"
                  onClick={handleResend}
                  className="w-full rounded-full border border-[var(--border)] bg-[var(--bg-soft)] px-3 py-2 text-[var(--muted)] transition-colors hover:border-[var(--brand)]/60 hover:text-[var(--ink)] disabled:opacity-60 disabled:cursor-not-allowed"
                  disabled={status === "processing"}
                >
                  Renvoyer l’email de vérification
                </button>

                <button
                  type="button"
                  onClick={handleGoToApp}
                  className="w-full rounded-full border border-[var(--brand)]/70 bg-[var(--brand)]/20 px-3 py-2 text-[var(--ink)] transition-colors hover:bg-[var(--brand)]/30"
                >
                  Accéder à l&apos;espace candidat
                </button>
              </div>

              <p className="text-center text-[10px] text-[var(--muted)]">
                Si tu ne vois pas l’email, pense à vérifier les spams ou l’onglet
                &quot;Promotions&quot; de ta boîte de réception.
              </p>
            </div>
          </div>
        </main>
      </div>
    </div>
  );
}

/**
 * Wrapper avec Suspense → obligatoire quand on utilise useSearchParams
 * dans une page client pour que le build Next.js ne plante pas.
 */
export default function VerifyEmailPage() {
  return (
    <Suspense
      fallback={
        <div className="min-h-screen flex items-center justify-center text-sm text-slate-400">
          Chargement…
        </div>
      }
    >
      <VerifyEmailPageInner />
    </Suspense>
  );
}
````

## File: app/debug/polar/page.tsx
````typescript
// app/debug/polar/page.tsx
"use client";

import { useEffect, useState } from "react";
import type { CreditPackId } from "@/lib/polar";
import { auth, db } from "@/lib/firebase";
import { onAuthStateChanged } from "firebase/auth";
import { doc, getDoc } from "firebase/firestore";

type UserProfile = {
  id: string;
  email: string;
  displayName?: string;
  credits?: number;
};

type PackConfig = {
  id: CreditPackId;
  title: string;
  subtitle: string;
  credits: number;
  priceText: string;
  highlight?: boolean;
};

// ✅ Packs alignés avec tes produits Polar : 20 / 50 / 100
const PACKS: PackConfig[] = [
  {
    id: "20",
    title: "Pack 20 crédits",
    subtitle: "≈ 20 crédits",
    credits: 20,
    priceText: "≈ 10 $ (config Polar)",
  },
  {
    id: "50",
    title: "Pack 50 crédits",
    subtitle: "≈ 50 crédits",
    credits: 50,
    priceText: "≈ 25 $ (config Polar)",
    highlight: true,
  },
  {
    id: "100",
    title: "Pack 100 crédits",
    subtitle: "≈ 100 crédits",
    credits: 100,
    priceText: "≈ 40 $ (config Polar)",
  },
];

export default function PolarDebugPage() {
  const [firebaseUser, setFirebaseUser] = useState<any | null>(null);
  const [profile, setProfile] = useState<UserProfile | null>(null);
  const [loadingUser, setLoadingUser] = useState(true);

  const [loadingPack, setLoadingPack] = useState<CreditPackId | null>(null);
  const [message, setMessage] = useState<string | null>(null);
  const [rawResponse, setRawResponse] = useState<any>(null);
  const [showDetails, setShowDetails] = useState(false);
  const [lastPack, setLastPack] = useState<CreditPackId | null>(null);

  // 🔐 On récupère l'utilisateur Firebase + son doc Firestore ("users/{uid}")
  useEffect(() => {
    const unsubscribe = onAuthStateChanged(auth, async (user) => {
      setFirebaseUser(user);
      if (!user) {
        setProfile(null);
        setLoadingUser(false);
        return;
      }

      try {
        const ref = doc(db, "users", user.uid);
        const snap = await getDoc(ref);
        const data = snap.exists() ? (snap.data() as any) : {};

        const credits =
          typeof data.credits === "number" ? (data.credits as number) : undefined;

        const displayName =
          data.displayName ??
          data.name ??
          data.fullName ??
          user.displayName ??
          undefined;

        const email = user.email ?? data.email ?? "";

        setProfile({
          id: user.uid,
          email,
          displayName,
          credits,
        });
      } catch (err) {
        console.error("[Debug Polar] Erreur chargement profil Firestore :", err);
      } finally {
        setLoadingUser(false);
      }
    });

    return () => unsubscribe();
  }, []);

  const handleBuy = async (packId: CreditPackId) => {
    try {
      setMessage(null);
      setRawResponse(null);
      setLoadingPack(packId);
      setLastPack(packId);

      if (!profile?.id || !profile.email) {
        setMessage(
          "❌ Impossible de lancer le paiement : utilisateur non connecté ou email manquant."
        );
        return;
      }

      const res = await fetch("/api/polar/checkout", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          packId,
          userId: profile.id,
          email: profile.email,
        }),
      });

      const data = await res.json();
      console.error("Réponse /api/polar/checkout :", data);
      setRawResponse(data);

      if (!data.ok || !data.url) {
        const msg =
          data.error ||
          data.detail ||
          "❌ Erreur lors de la création du paiement (réponse API).";
        setMessage(msg);
        return;
      }

      // Redirection vers la page de paiement Polar
      window.location.href = data.url;
    } catch (error) {
      console.error("Erreur handleBuy:", error);
      setMessage("❌ Une erreur est survenue côté client.");
    } finally {
      setLoadingPack(null);
    }
  };

  const isLoading = (pack: CreditPackId) => loadingPack === pack;
  const isAuthenticated = !!firebaseUser && !!profile;

  return (
    <main
      style={{
        minHeight: "100vh",
        margin: 0,
        padding: "2rem",
        fontFamily: "system-ui, -apple-system, BlinkMacSystemFont, sans-serif",
        background:
          "radial-gradient(circle at top, #111827 0, #020617 45%, #000 100%)",
        color: "#e5e7eb",
        display: "flex",
        justifyContent: "center",
      }}
    >
      <div style={{ width: "100%", maxWidth: "960px" }}>
        {/* Header */}
        <header
          style={{
            marginBottom: "1.5rem",
            display: "flex",
            justifyContent: "space-between",
            gap: "1rem",
            alignItems: "flex-start",
          }}
        >
          <div>
            <h1
              style={{
                fontSize: "1.8rem",
                marginBottom: "0.3rem",
                color: "#f9fafb",
              }}
            >
              Mode debug Polar
            </h1>
            <p style={{ margin: 0, color: "#9ca3af", maxWidth: "32rem" }}>
              Cette page te permet de tester les paiements Polar et le crédit
              de l’utilisateur dans Firestore, sans toucher à ton UI principale.
            </p>
          </div>

          <div
            style={{
              padding: "0.75rem 1rem",
              borderRadius: "0.75rem",
              backgroundColor: "rgba(15, 23, 42, 0.85)",
              border: "1px solid rgba(148, 163, 184, 0.4)",
              fontSize: "0.8rem",
              lineHeight: 1.35,
              minWidth: "220px",
            }}
          >
            <div style={{ marginBottom: "0.25rem", fontWeight: 600 }}>
              {loadingUser
                ? "Chargement utilisateur…"
                : isAuthenticated
                ? "Utilisateur connecté"
                : "Aucun utilisateur connecté"}
            </div>

            {isAuthenticated && profile && (
              <>
                {profile.displayName && (
                  <div>
                    <span style={{ color: "#9ca3af" }}>Nom :</span>{" "}
                    <strong>{profile.displayName}</strong>
                  </div>
                )}
                <div>
                  <span style={{ color: "#9ca3af" }}>Email :</span>{" "}
                  <strong>{profile.email}</strong>
                </div>
                <div>
                  <span style={{ color: "#9ca3af" }}>ID :</span>{" "}
                  <code
                    style={{
                      backgroundColor: "rgba(15,23,42,0.9)",
                      padding: "0.1rem 0.3rem",
                      borderRadius: "0.25rem",
                    }}
                  >
                    {profile.id}
                  </code>
                </div>
                {typeof profile.credits === "number" && (
                  <div style={{ marginTop: "0.25rem" }}>
                    <span style={{ color: "#9ca3af" }}>Crédits :</span>{" "}
                    <strong>{profile.credits}</strong>
                  </div>
                )}
              </>
            )}

            {!loadingUser && !isAuthenticated && (
              <div style={{ color: "#f97316", marginTop: "0.3rem" }}>
                Connecte-toi dans l’app pour tester les paiements.
              </div>
            )}
          </div>
        </header>

        {/* Boutons de contrôle */}
        <div
          style={{
            display: "flex",
            gap: "0.5rem",
            marginBottom: "1.5rem",
            flexWrap: "wrap",
          }}
        >
          <button
            type="button"
            onClick={() => setShowDetails((v) => !v)}
            style={{
              padding: "0.5rem 0.9rem",
              borderRadius: "999px",
              border: "1px solid rgba(148, 163, 184, 0.6)",
              backgroundColor: showDetails
                ? "rgba(34, 197, 94, 0.15)"
                : "rgba(15,23,42,0.9)",
              color: showDetails ? "#bbf7d0" : "#e5e7eb",
              fontSize: "0.8rem",
              cursor: "pointer",
            }}
          >
            {showDetails ? "Masquer les détails API" : "Afficher les détails API"}
          </button>

          {lastPack && (
            <button
              type="button"
              onClick={() => handleBuy(lastPack)}
              style={{
                padding: "0.5rem 0.9rem",
                borderRadius: "999px",
                border: "1px solid rgba(148, 163, 184, 0.4)",
                backgroundColor: "rgba(15,23,42,0.9)",
                color: "#e5e7eb",
                fontSize: "0.8rem",
                cursor: "pointer",
              }}
            >
              Relancer le pack testé ({lastPack})
            </button>
          )}

          <button
            type="button"
            onClick={() => {
              setMessage(null);
              setRawResponse(null);
            }}
            style={{
              padding: "0.5rem 0.9rem",
              borderRadius: "999px",
              border: "1px solid rgba(55, 65, 81, 0.9)",
              backgroundColor: "transparent",
              color: "#9ca3af",
              fontSize: "0.8rem",
              cursor: "pointer",
            }}
          >
            Effacer les messages
          </button>
        </div>

        {/* Cartes de packs */}
        <section
          style={{
            display: "grid",
            gridTemplateColumns: "repeat(auto-fit, minmax(240px, 1fr))",
            gap: "1rem",
            marginBottom: "1.5rem",
          }}
        >
          {PACKS.map((pack) => {
            const loading = isLoading(pack.id);
            const disabled = !isAuthenticated || loading;

            return (
              <article
                key={pack.id}
                style={{
                  position: "relative",
                  borderRadius: "1rem",
                  padding: "1.1rem 1.1rem 1rem",
                  background:
                    "linear-gradient(145deg, rgba(15,23,42,0.96), rgba(15,23,42,0.9))",
                  border: pack.highlight
                    ? "1px solid rgba(96, 165, 250, 0.9)"
                    : "1px solid rgba(31, 41, 55, 1)",
                  boxShadow: pack.highlight
                    ? "0 0 0 1px rgba(59,130,246,0.3), 0 18px 40px rgba(15,23,42,0.9)"
                    : "0 14px 35px rgba(15,23,42,0.85)",
                  overflow: "hidden",
                }}
              >
                {pack.highlight && (
                  <div
                    style={{
                      position: "absolute",
                      top: "0.7rem",
                      right: "0.9rem",
                      fontSize: "0.7rem",
                      padding: "0.15rem 0.5rem",
                      borderRadius: "999px",
                      background:
                        "linear-gradient(to right, #2563eb, #22c55e)",
                      color: "#f9fafb",
                      fontWeight: 600,
                      letterSpacing: "0.04em",
                      textTransform: "uppercase",
                    }}
                  >
                    Recommandé
                  </div>
                )}

                <div style={{ marginBottom: "0.75rem" }}>
                  <h2
                    style={{
                      fontSize: "1rem",
                      margin: 0,
                      color: "#f9fafb",
                    }}
                  >
                    {pack.title}
                  </h2>
                  <p
                    style={{
                      margin: "0.15rem 0 0",
                      fontSize: "0.8rem",
                      color: "#9ca3af",
                    }}
                  >
                    {pack.subtitle} • {pack.priceText}
                  </p>
                </div>

                <div
                  style={{
                    display: "flex",
                    alignItems: "baseline",
                    gap: "0.5rem",
                    marginBottom: "0.5rem",
                  }}
                >
                  <div style={{ fontSize: "2rem", fontWeight: 700 }}>
                    {pack.credits}
                  </div>
                  <div
                    style={{
                      fontSize: "0.8rem",
                      textTransform: "uppercase",
                      letterSpacing: "0.08em",
                      color: "#9ca3af",
                      fontWeight: 500,
                    }}
                  >
                    crédits
                  </div>
                </div>

                <p
                  style={{
                    margin: 0,
                    fontSize: "0.8rem",
                    color: "#9ca3af",
                    minHeight: "2.4rem",
                  }}
                >
                  Crédits utilisables pour les actions IA (analyse CV,
                  candidatures, etc.).
                </p>

                <div
                  style={{
                    marginTop: "0.9rem",
                    display: "flex",
                    justifyContent: "space-between",
                    alignItems: "center",
                    gap: "0.75rem",
                  }}
                >
                  <button
                    type="button"
                    onClick={() => handleBuy(pack.id)}
                    disabled={disabled}
                    style={{
                      flex: 1,
                      padding: "0.55rem 0.8rem",
                      borderRadius: "999px",
                      border: "none",
                      cursor: disabled ? "default" : "pointer",
                      background: pack.highlight
                        ? "linear-gradient(to right, #2563eb, #22c55e)"
                        : "linear-gradient(to right, #4b5563, #1f2937)",
                      color: "#f9fafb",
                      fontSize: "0.85rem",
                      fontWeight: 600,
                      textAlign: "center",
                      opacity: disabled ? 0.5 : 1,
                      transition:
                        "transform 0.12s ease, box-shadow 0.12s ease, opacity 0.12s ease",
                    }}
                  >
                    {loading
                      ? "Redirection..."
                      : isAuthenticated
                      ? "Tester ce pack"
                      : "Connexion requise"}
                  </button>

                  <div
                    style={{
                      fontSize: "0.7rem",
                      color: "#6b7280",
                      textAlign: "right",
                    }}
                  >
                    ID interne :{" "}
                    <code
                      style={{
                        backgroundColor: "rgba(15,23,42,0.9)",
                        padding: "0.15rem 0.35rem",
                        borderRadius: "999px",
                      }}
                    >
                      {pack.id}
                    </code>
                  </div>
                </div>
              </article>
            );
          })}
        </section>

        {/* Message d'erreur simple */}
        {message && (
          <div
            style={{
              marginBottom: "1rem",
              padding: "0.75rem 1rem",
              borderRadius: "0.75rem",
              backgroundColor: "rgba(127, 29, 29, 0.4)",
              border: "1px solid rgba(248, 113, 113, 0.7)",
              color: "#fecaca",
              fontSize: "0.85rem",
            }}
          >
            <strong style={{ display: "block", marginBottom: "0.15rem" }}>
              Erreur
            </strong>
            <span>{message}</span>
          </div>
        )}

        {/* Détails API (raw JSON) */}
        {showDetails && rawResponse && (
          <section>
            <h2
              style={{
                fontSize: "0.9rem",
                marginBottom: "0.4rem",
                color: "#e5e7eb",
              }}
            >
              Détails de la dernière réponse API
            </h2>
            <pre
              style={{
                margin: 0,
                padding: "1rem",
                background:
                  "linear-gradient(135deg, rgba(15,23,42,0.98), rgba(15,23,42,0.95))",
                borderRadius: "0.75rem",
                fontSize: "0.78rem",
                overflowX: "auto",
                border: "1px solid rgba(31, 41, 55, 1)",
              }}
            >
{JSON.stringify(rawResponse, null, 2)}
            </pre>
          </section>
        )}
      </div>
    </main>
  );
}
````

## File: app/forgot-password/page.tsx
````typescript
"use client";

import { useState, FormEvent } from "react";
import Script from "next/script";
import Link from "next/link";
import { sendPasswordResetEmail } from "firebase/auth";
import { auth } from "@/lib/firebase";
import { getRecaptchaToken, verifyRecaptcha } from "@/lib/recaptcha";

export default function ForgotPasswordPage() {
  const [email, setEmail] = useState("");
  const [submitting, setSubmitting] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [info, setInfo] = useState<string | null>(null);

  const handleSubmit = async (e: FormEvent) => {
    e.preventDefault();
    setError(null);
    setInfo(null);
    setSubmitting(true);

    try {
      // ✅ reCAPTCHA avant envoi reset email
      const action = "PASSWORD_RESET";
      let token = "";
      try {
        token = await getRecaptchaToken(action);
      } catch {
        setError(
          "Sécurité: impossible de valider reCAPTCHA (script bloqué ?). Désactive l'adblock et réessaie."
        );
        return;
      }

      const check = await verifyRecaptcha(token, action);
      if (!check.ok) {
        setError("Demande refusée par sécurité. Réessayez dans quelques secondes.");
        return;
      }

      await sendPasswordResetEmail(auth, email);
      setInfo(
        "Si un compte existe pour cette adresse email, un lien de réinitialisation vient de t'être envoyé. Pense à vérifier tes spams."
      );
    } catch (err: any) {
      console.error("Forgot password error:", err);
      const code = err?.code as string | undefined;

      if (code === "auth/invalid-email") {
        setError("Adresse email invalide.");
      } else {
        setError(
          "Impossible d'envoyer l'email de réinitialisation pour le moment. Réessaie dans quelques instants."
        );
      }
    } finally {
      setSubmitting(false);
    }
  };

  return (
    <div className="min-h-screen flex flex-col bg-gradient-to-b from-slate-950 via-slate-950/95 to-slate-900 text-slate-100">
      <Script
        src={`https://www.google.com/recaptcha/enterprise.js?render=${process.env.NEXT_PUBLIC_RECAPTCHA_SITE_KEY}`}
        strategy="afterInteractive"
      />

      <header className="border-b border-slate-800/80 bg-slate-950/80 backdrop-blur">
        <div className="max-w-5xl mx-auto px-4 sm:px-6 py-3 flex items-center justify-between gap-3">
          <div className="flex items-center gap-2">
            <div className="w-8 h-8 rounded-xl bg-gradient-to-br from-sky-500 to-sky-400 flex items-center justify-center text-[10px] font-semibold text-slate-950 shadow-lg shadow-sky-500/40">
              IA
            </div>
            <div className="flex flex-col">
              <span className="text-[10px] uppercase tracking-[0.18em] text-slate-400">
                Assistant candidatures
              </span>
              <span className="text-xs font-medium text-slate-100">Mot de passe oublié</span>
            </div>
          </div>
          <nav className="flex items-center gap-2 text-[11px]">
            <Link
              href="/"
              className="px-2 py-1 rounded-full border border-slate-700/80 hover:border-sky-500/80 text-slate-300 hover:text-sky-300 transition-colors"
            >
              ← Accueil
            </Link>
            <Link
              href="/login"
              className="px-3 py-1 rounded-full bg-sky-500/90 text-slate-950 font-medium hover:bg-sky-400 transition-colors"
            >
              Se connecter
            </Link>
            <Link
              href="/signup"
              className="px-3 py-1 rounded-full border border-slate-700/80 text-slate-300 hover:border-sky-500/80 hover:text-sky-300 transition-colors"
            >
              S&apos;inscrire
            </Link>
          </nav>
        </div>
      </header>

      <main className="flex-1 flex items-center justify-center px-4 py-6">
        <div className="glass max-w-md w-full p-6 sm:p-7 rounded-2xl border border-slate-800 bg-slate-950/80 shadow-2xl shadow-sky-900/40">
          <div className="mb-4">
            <p className="inline-flex items-center gap-2 rounded-full bg-slate-900/80 border border-slate-700 px-3 py-1 mb-2">
              <span className="text-xs">💬</span>
              <span className="text-[11px] uppercase tracking-[0.18em] text-slate-300">
                Mot de passe oublié
              </span>
            </p>
            <h1 className="text-lg sm:text-xl font-semibold text-slate-50">
              Réinitialiser ton mot de passe
            </h1>
            <p className="text-xs text-slate-400 mt-1">
              Entre l&apos;adresse email liée à ton compte. Si elle existe, tu recevras un lien sécurisé.
            </p>
          </div>

          {info && (
            <div className="mb-2 rounded-lg border border-emerald-500/70 bg-emerald-500/10 px-3 py-2 text-[11px] text-emerald-100">
              {info}
            </div>
          )}

          {error && (
            <div className="mb-2 rounded-lg border border-rose-500/70 bg-rose-500/10 px-3 py-2 text-[11px] text-rose-100">
              {error}
            </div>
          )}

          <form onSubmit={handleSubmit} className="space-y-3 text-sm">
            <div>
              <label className="block mb-1 text-xs text-slate-300" htmlFor="email">
                Adresse email
              </label>
              <input
                id="email"
                type="email"
                required
                autoComplete="email"
                className="w-full rounded-lg bg-slate-900/80 border border-slate-700 px-3 py-2 text-xs text-slate-100 placeholder:text-slate-500 outline-none focus:ring-1 focus:ring-sky-500 focus:border-sky-500"
                placeholder="toi@example.com"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                disabled={submitting}
              />
            </div>

            <button
              type="submit"
              disabled={submitting}
              className="w-full inline-flex items-center justify-center rounded-lg bg-sky-500 hover:bg-sky-600 disabled:opacity-60 disabled:cursor-not-allowed text-xs font-medium text-white px-3 py-2 transition-colors mt-1"
            >
              {submitting ? "Envoi du lien..." : "Envoyer le lien de réinitialisation"}
            </button>
          </form>

          <p className="mt-4 text-[11px] text-slate-400 text-center">
            Tu te souviens de ton mot de passe ?{" "}
            <Link href="/login" className="text-sky-400 hover:text-sky-300 hover:underline font-medium">
              Retour à la connexion
            </Link>
          </p>
        </div>
      </main>
    </div>
  );
}
````

## File: app/login/page.tsx
````typescript
"use client";

import { Suspense, useState, useEffect, FormEvent } from "react";
import Script from "next/script";
import Link from "next/link";
import { useRouter, useSearchParams } from "next/navigation";
import {
  signInWithEmailAndPassword,
  signInWithPopup,
  GoogleAuthProvider,
} from "firebase/auth";
import { auth, googleProvider, db } from "@/lib/firebase";
import { doc, getDoc } from "firebase/firestore";
import { useAuth } from "@/context/AuthContext";
import { logAuthFailed } from "@/lib/logAuthFailed";
import { getRecaptchaToken, verifyRecaptcha } from "@/lib/recaptcha";

const MAX_ATTEMPTS = 5;
const LOCK_DURATION_MS = 60_000; // 1 minute

function LoginPageInner() {
  const router = useRouter();
  const searchParams = useSearchParams();

  const { user, loading, blocked } = useAuth();

  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [showPwd, setShowPwd] = useState(false);
  const [submitting, setSubmitting] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [info, setInfo] = useState<string | null>(null);

  const [attempts, setAttempts] = useState(0);
  const [isLocked, setIsLocked] = useState(false);
  const [lockEnd, setLockEnd] = useState<number | null>(null);
  const [lockRemaining, setLockRemaining] = useState(0);

  // ✅ Affiche le message si compte bloqué (depuis AuthContext)
  useEffect(() => {
    if (!blocked) return;
    setInfo(null);
    setError(
      "Votre compte est bloqué. Si vous pensez que c'est une erreur, contactez l'administrateur."
    );
  }, [blocked]);

  // ✅ Redirection auto si déjà connecté (mais PAS si blocked, ni pendant submit)
  useEffect(() => {
    if (loading) return;
    if (blocked) return;
    if (!user) return;
    if (submitting) return;

    const redirectTo = searchParams.get("redirect") || "/app";
    router.replace(redirectTo);
  }, [loading, blocked, user, searchParams, router, submitting]);

  // ✅ Message query params
  useEffect(() => {
    const justSignedUp = searchParams.get("justSignedUp");
    const blockedParam = searchParams.get("blocked");

    if (blockedParam === "1") {
      setInfo(null);
      setError(
        "Votre compte a été bloqué par l'administrateur. Si vous pensez que c'est une erreur, contactez le support."
      );
    } else if (justSignedUp === "1") {
      setError(null);
      setInfo(
        "Votre compte a bien été créé. Pensez à valider votre adresse email avant votre première connexion."
      );
    }
  }, [searchParams]);

  // ✅ Recharge lock depuis localStorage
  useEffect(() => {
    if (typeof window === "undefined") return;

    const storedAttempts = window.localStorage.getItem("loginAttempts");
    const storedLockEnd = window.localStorage.getItem("loginLockEnd");
    const now = Date.now();

    if (storedAttempts) {
      const a = parseInt(storedAttempts, 10);
      if (!Number.isNaN(a)) setAttempts(a);
    }

    if (storedLockEnd) {
      const end = parseInt(storedLockEnd, 10);
      if (!Number.isNaN(end) && end > now) {
        setIsLocked(true);
        setLockEnd(end);
        setLockRemaining(Math.ceil((end - now) / 1000));
      } else {
        window.localStorage.removeItem("loginAttempts");
        window.localStorage.removeItem("loginLockEnd");
      }
    }
  }, []);

  // ✅ Timer lock
  useEffect(() => {
    if (!isLocked || !lockEnd) return;

    const id = window.setInterval(() => {
      const diff = lockEnd - Date.now();
      if (diff <= 0) {
        setIsLocked(false);
        setAttempts(0);
        setLockEnd(null);
        setLockRemaining(0);

        window.localStorage.removeItem("loginAttempts");
        window.localStorage.removeItem("loginLockEnd");

        window.clearInterval(id);
      } else {
        setLockRemaining(Math.ceil(diff / 1000));
      }
    }, 1000);

    return () => window.clearInterval(id);
  }, [isLocked, lockEnd]);

  // -------------------------
  //  LOGIN EMAIL / PASSWORD
  // -------------------------
  const handleSubmit = async (e: FormEvent) => {
    e.preventDefault();
    if (isLocked) return;

    setError(null);
    setInfo(null);
    setSubmitting(true);

    try {
      // ✅ reCAPTCHA avant Firebase Auth
      const action = "LOGIN";
      let token = "";
      try {
        token = await getRecaptchaToken(action);
      } catch {
        setError(
          "Sécurité: impossible de valider reCAPTCHA (script bloqué ?). Désactive l'adblock et réessaie."
        );
        return;
      }

      const check = await verifyRecaptcha(token, action);
      if (!check.ok) {
        setError("Connexion refusée par sécurité. Réessayez dans quelques secondes.");
        logAuthFailed({
          email,
          provider: "password",
          errorCode: `recaptcha:${check.reason}`,
          errorMessage: `score=${check.score ?? "?"}`,
        });
        return;
      }

      const cred = await signInWithEmailAndPassword(auth, email, password);

      // Vérif blocage Firestore (optionnel, mais ok)
      const ref = doc(db, "users", cred.user.uid);
      const snap = await getDoc(ref);
      const data = snap.data() as any | undefined;

      if (data?.blocked) {
        await auth.signOut();
        setError(
          "Votre compte est bloqué. Si vous pensez que c'est une erreur, contactez l'administrateur."
        );
        return;
      }

      // ✅ Reset lock
      setAttempts(0);
      setIsLocked(false);
      setLockEnd(null);
      setLockRemaining(0);
      window.localStorage.removeItem("loginAttempts");
      window.localStorage.removeItem("loginLockEnd");

      const redirectTo = searchParams.get("redirect") || "/app";
      router.replace(redirectTo);
    } catch (err: any) {
      console.error("Erreur login:", err);

      const code = err?.code as string | undefined;

      logAuthFailed({
        email,
        provider: "password",
        errorCode: code,
        errorMessage: err?.message,
      });

      setAttempts((prev) => {
        const next = prev + 1;
        window.localStorage.setItem("loginAttempts", String(next));

        if (next >= MAX_ATTEMPTS) {
          const end = Date.now() + LOCK_DURATION_MS;
          setIsLocked(true);
          setLockEnd(end);
          setLockRemaining(Math.ceil(LOCK_DURATION_MS / 1000));
          window.localStorage.setItem("loginLockEnd", String(end));
        }

        return next;
      });

      if (code === "auth/wrong-password" || code === "auth/user-not-found") {
        setError("Email ou mot de passe incorrect. Vérifiez vos identifiants puis réessayez.");
      } else if (code === "auth/too-many-requests") {
        setError(
          "Trop de tentatives échouées. Votre compte est temporairement bloqué côté serveur. Réessayez dans quelques minutes ou réinitialisez votre mot de passe."
        );
      } else if (code === "auth/network-request-failed") {
        setError("Problème de connexion réseau. Vérifiez votre connexion Internet.");
      } else {
        setError("Impossible de vous connecter pour le moment. Réessayez dans quelques instants.");
      }
    } finally {
      setSubmitting(false);
    }
  };

  // -------------------------
  //  LOGIN GOOGLE
  // -------------------------
  const handleGoogleLogin = async () => {
    setError(null);
    setInfo(null);
    setSubmitting(true);

    try {
      // ✅ reCAPTCHA avant Firebase Auth
      const action = "LOGIN_GOOGLE";
      let token = "";
      try {
        token = await getRecaptchaToken(action);
      } catch {
        setError(
          "Sécurité: impossible de valider reCAPTCHA (script bloqué ?). Désactive l'adblock et réessaie."
        );
        return;
      }

      const check = await verifyRecaptcha(token, action);
      if (!check.ok) {
        setError("Connexion refusée par sécurité. Réessayez dans quelques secondes.");
        logAuthFailed({
          email,
          provider: "google",
          errorCode: `recaptcha:${check.reason}`,
          errorMessage: `score=${check.score ?? "?"}`,
        });
        return;
      }

      const provider = googleProvider || new GoogleAuthProvider();
      const result = await signInWithPopup(auth, provider);
      const u = result.user;

      const ref = doc(db, "users", u.uid);
      const snap = await getDoc(ref);
      const data = snap.data() as any | undefined;

      if (data?.blocked) {
        await auth.signOut();
        setError(
          "Votre compte est bloqué. Si vous pensez que c'est une erreur, contactez l'administrateur."
        );
        return;
      }

      const displayName = u.displayName || u.email || "";
      setInfo(`Bienvenue ${displayName} 👋`);

      const redirectTo = searchParams.get("redirect") || "/app";
      router.replace(redirectTo);
    } catch (err: any) {
      console.error("Google login error:", err);
      const code = err?.code as string | undefined;

      logAuthFailed({
        email,
        provider: "google",
        errorCode: code,
        errorMessage: err?.message,
      });

      if (code === "auth/account-exists-with-different-credential") {
        setError(
          "Un compte existe déjà pour cette adresse email avec une autre méthode de connexion. Essayez avec votre mot de passe habituel."
        );
      } else if (code === "auth/popup-closed-by-user") {
        setError("La fenêtre Google a été fermée avant la fin du processus.");
      } else if (code === "auth/network-request-failed") {
        setError("Problème de connexion réseau. Vérifiez votre connexion Internet.");
      } else {
        setError("Impossible de vous connecter avec Google pour le moment.");
      }
    } finally {
      setSubmitting(false);
    }
  };

  const attemptsLeft = Math.max(0, MAX_ATTEMPTS - attempts);

  if (loading) {
    return (
      <div className="min-h-screen flex items-center justify-center text-sm text-slate-400">
        Chargement…
      </div>
    );
  }

  return (
    <div className="min-h-screen flex flex-col bg-gradient-to-b from-slate-950 via-slate-950/95 to-slate-900 text-slate-100">
      <Script
        src={`https://www.google.com/recaptcha/enterprise.js?render=${process.env.NEXT_PUBLIC_RECAPTCHA_SITE_KEY}`}
        strategy="afterInteractive"
      />

      {/* NAVBAR */}
      <header className="border-b border-slate-800/80 bg-slate-950/80 backdrop-blur">
        <div className="max-w-5xl mx-auto px-4 sm:px-6 py-3 flex items-center justify-between gap-3">
          <div className="flex items-center gap-2">
            <div className="w-8 h-8 rounded-xl bg-gradient-to-br from-sky-500 to-sky-400 flex items-center justify-center text-[10px] font-semibold text-slate-950 shadow-lg shadow-sky-500/40">
              IA
            </div>
            <div className="flex flex-col">
              <span className="text-[10px] uppercase tracking-[0.18em] text-slate-400">
                Assistant candidatures
              </span>
              <span className="text-xs font-medium text-slate-100">Connexion</span>
            </div>
          </div>
          <nav className="flex items-center gap-2 text-[11px]">
            <Link
              href="/"
              className="px-2 py-1 rounded-full border border-slate-700/80 hover:border-sky-500/80 text-slate-300 hover:text-sky-300 transition-colors"
            >
              ← Retour accueil
            </Link>
            <Link
              href="/signup"
              className="px-3 py-1 rounded-full bg-sky-500/90 text-slate-950 font-medium hover:bg-sky-400 transition-colors"
            >
              S&apos;inscrire
            </Link>
          </nav>
        </div>
      </header>

      {/* CONTENU */}
      <main className="flex-1 flex items-center justify-center px-4 py-6">
        <div className="glass max-w-md w-full p-6 sm:p-7 rounded-2xl border border-slate-800 bg-slate-950/80 shadow-2xl shadow-sky-900/40">
          <div className="mb-4">
            <p className="inline-flex items-center gap-2 rounded-full bg-slate-900/80 border border-slate-700 px-3 py-1 mb-2">
              <span className="text-xs">🔐</span>
              <span className="text-[11px] uppercase tracking-[0.18em] text-slate-300">
                Connexion
              </span>
            </p>
            <h1 className="text-lg sm:text-xl font-semibold text-slate-50">
              Connexion à votre espace
            </h1>
            <p className="text-xs text-slate-400 mt-1">
              Connectez-vous pour accéder à votre tableau de bord, votre CV IA et vos candidatures.
            </p>
          </div>

          {info && (
            <div className="mb-2 rounded-lg border border-emerald-500/70 bg-emerald-500/10 px-3 py-2 text-[11px] text-emerald-100">
              {info}
            </div>
          )}

          {error && (
            <div className="mb-2 rounded-lg border border-rose-500/70 bg-rose-500/10 px-3 py-2 text-[11px] text-rose-100">
              {error}
            </div>
          )}

          {isLocked && lockRemaining > 0 && (
            <div className="mb-3 rounded-lg border border-amber-500/70 bg-amber-500/10 px-3 py-2 text-[11px] text-amber-100">
              <span className="font-semibold">Votre compte est temporairement bloqué.</span>{" "}
              Trop de tentatives échouées. Réessayez dans environ {lockRemaining} seconde
              {lockRemaining > 1 ? "s" : ""} ou utilisez{" "}
              <span className="font-semibold">« Mot de passe oublié »</span>.
            </div>
          )}

          {!isLocked && attempts > 0 && attemptsLeft > 0 && (
            <p className="mb-2 text-[10px] text-slate-400">
              Tentative échouée. Il vous reste{" "}
              <span className="font-semibold">{attemptsLeft}</span> tentative
              {attemptsLeft > 1 ? "s" : ""} avant le blocage temporaire.
            </p>
          )}

          <form onSubmit={handleSubmit} className="space-y-3 text-sm">
            <div>
              <label className="block mb-1 text-xs text-slate-300">Email</label>
              <input
                type="email"
                required
                autoComplete="email"
                className="w-full rounded-lg bg-slate-900/80 border border-slate-700 px-3 py-2 text-xs text-slate-100 placeholder:text-slate-500 outline-none focus:ring-1 focus:ring-sky-500 focus:border-sky-500"
                placeholder="vous@example.com"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                disabled={submitting || isLocked}
              />
            </div>

            <div>
              <label className="block mb-1 text-xs text-slate-300">Mot de passe</label>
              <div className="relative">
                <input
                  type={showPwd ? "text" : "password"}
                  required
                  autoComplete="current-password"
                  className="w-full rounded-lg bg-slate-900/80 border border-slate-700 px-3 py-2 text-xs text-slate-100 placeholder:text-slate-500 outline-none focus:ring-1 focus:ring-sky-500 focus:border-sky-500 pr-16"
                  placeholder="••••••••"
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  disabled={submitting || isLocked}
                />
                <button
                  type="button"
                  onClick={() => setShowPwd((v) => !v)}
                  className="absolute inset-y-0 right-2 flex items-center text-[11px] text-slate-400 hover:text-slate-200"
                >
                  {showPwd ? "Masquer" : "Afficher"}
                </button>
              </div>
              <div className="mt-1 flex justify-between items-center">
                <Link
                  href="/forgot-password"
                  className="text-[11px] text-sky-400 hover:text-sky-300 hover:underline"
                >
                  Mot de passe oublié ?
                </Link>
              </div>
            </div>

            <button
              type="submit"
              disabled={submitting || isLocked}
              className="w-full inline-flex items-center justify-center rounded-lg bg-sky-500 hover:bg-sky-600 disabled:opacity-60 disabled:cursor-not-allowed text-xs font-medium text-white px-3 py-2 transition-colors mt-1"
            >
              {isLocked ? "Compte temporairement bloqué" : submitting ? "Connexion..." : "Se connecter"}
            </button>
          </form>

          <div className="flex items-center gap-2 my-4">
            <div className="h-px flex-1 bg-slate-800" />
            <span className="text-[10px] text-slate-500 uppercase tracking-[0.16em]">ou</span>
            <div className="h-px flex-1 bg-slate-800" />
          </div>

          <button
            type="button"
            onClick={handleGoogleLogin}
            disabled={submitting}
            className="w-full inline-flex items-center justify-center rounded-lg bg-slate-900/80 border border-slate-700 hover:border-sky-500 text-xs font-medium text-slate-100 px-3 py-2.5 transition-colors"
          >
            Continuer avec <span className="font-semibold ml-1">Google</span>
          </button>

          <p className="mt-4 text-[11px] text-slate-400 text-center">
            Pas encore de compte ?{" "}
            <Link href="/signup" className="text-sky-400 hover:text-sky-300 hover:underline font-medium">
              Créer un compte
            </Link>
          </p>
        </div>
      </main>
    </div>
  );
}

export default function LoginPage() {
  return (
    <Suspense
      fallback={
        <div className="min-h-screen flex items-center justify-center text-sm text-slate-400">
          Chargement…
        </div>
      }
    >
      <LoginPageInner />
    </Suspense>
  );
}
````

## File: app/signup/page.tsx
````typescript
"use client";

import { Suspense, useState, useMemo, FormEvent } from "react";
import Script from "next/script";
import { useRouter, useSearchParams } from "next/navigation";
import Link from "next/link";
import {
  createUserWithEmailAndPassword,
  updateProfile,
  sendEmailVerification,
  signInWithPopup,
  GoogleAuthProvider,
} from "firebase/auth";
import { auth, googleProvider } from "@/lib/firebase";
import { getRecaptchaToken, verifyRecaptcha } from "@/lib/recaptcha";

function checkPasswordRules(pwd: string) {
  const min = pwd.length >= 8;
  const upper = /[A-Z]/.test(pwd);
  const digit = /[0-9]/.test(pwd);
  const special = /[!@#$%^&*(),.?":{}|<>]/.test(pwd);
  const ok = min && upper && digit && special;
  return { min, upper, digit, special, ok };
}

function SignupPageInner() {
  const router = useRouter();
  const searchParams = useSearchParams();

  const [firstName, setFirstName] = useState("");
  const [lastName, setLastName] = useState("");

  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [showPwd, setShowPwd] = useState(false);

  const [error, setError] = useState<string | null>(null);
  const [info, setInfo] = useState<string | null>(null);
  const [loading, setLoading] = useState(false);

  const pwdRules = useMemo(() => checkPasswordRules(password), [password]);

  function mapSignupError(err: any) {
    const code = err?.code as string | undefined;

    if (code === "auth/email-already-in-use") {
      return "Cette adresse email est déjà associée à un compte. Veuillez vous connecter.";
    }
    if (code === "auth/invalid-email") {
      return "Adresse email invalide.";
    }
    return "Une erreur est survenue lors de l'inscription. Merci de réessayer.";
  }

  async function handleSubmit(e: FormEvent) {
    e.preventDefault();
    setError(null);
    setInfo(null);

    if (!pwdRules.ok) {
      setError(
        "Le mot de passe ne respecte pas les règles de sécurité. Vérifie les critères en dessous du champ."
      );
      return;
    }

    setLoading(true);
    try {
      // ✅ reCAPTCHA avant Firebase Auth
      const action = "SIGNUP";
      let token = "";
      try {
        token = await getRecaptchaToken(action);
      } catch {
        setError(
          "Sécurité: impossible de valider reCAPTCHA (script bloqué ?). Désactive l'adblock et réessaie."
        );
        return;
      }

      const check = await verifyRecaptcha(token, action);
      if (!check.ok) {
        setError("Inscription refusée par sécurité. Réessayez dans quelques secondes.");
        return;
      }

      const cred = await createUserWithEmailAndPassword(auth, email, password);

      const displayName = `${firstName} ${lastName}`.trim() || email;
      if (displayName) {
        await updateProfile(cred.user, { displayName });
      }

      await sendEmailVerification(cred.user);

      router.push("/login?justSignedUp=1");
    } catch (err: any) {
      console.error("Signup error:", err);
      setError(mapSignupError(err));
    } finally {
      setLoading(false);
    }
  }

  async function handleGoogleSignup() {
    setError(null);
    setInfo(null);
    setLoading(true);
    try {
      // ✅ reCAPTCHA avant Firebase Auth (Google)
      const action = "SIGNUP_GOOGLE";
      let token = "";
      try {
        token = await getRecaptchaToken(action);
      } catch {
        setError(
          "Sécurité: impossible de valider reCAPTCHA (script bloqué ?). Désactive l'adblock et réessaie."
        );
        return;
      }

      const check = await verifyRecaptcha(token, action);
      if (!check.ok) {
        setError("Inscription refusée par sécurité. Réessayez dans quelques secondes.");
        return;
      }

      const provider = googleProvider || new GoogleAuthProvider();
      const result = await signInWithPopup(auth, provider);
      const user = result.user;

      const displayName = user.displayName || user.email || "";
      setInfo(`Bienvenue ${displayName} 👋`);

      // (Tu peux aussi respecter redirect si tu veux)
      const redirectTo = searchParams.get("redirect") || "/app";
      router.push(redirectTo);
    } catch (err: any) {
      console.error("Google signup error:", err);
      const code = err?.code as string | undefined;

      if (code === "auth/account-exists-with-different-credential") {
        setError(
          "Un compte existe déjà pour cette adresse email. Veuillez vous connecter avec votre mot de passe habituel."
        );
      } else if (code === "auth/popup-closed-by-user") {
        setError("La fenêtre Google a été fermée avant la fin du processus.");
      } else {
        setError("Impossible de terminer l'inscription avec Google pour le moment.");
      }
    } finally {
      setLoading(false);
    }
  }

  return (
    <div className="min-h-screen flex flex-col bg-gradient-to-b from-slate-950 via-slate-950/95 to-slate-900 text-slate-100">
      <Script
        src={`https://www.google.com/recaptcha/enterprise.js?render=${process.env.NEXT_PUBLIC_RECAPTCHA_SITE_KEY}`}
        strategy="afterInteractive"
      />

      {/* NAVBAR */}
      <header className="border-b border-slate-800/80 bg-slate-950/80 backdrop-blur">
        <div className="max-w-5xl mx-auto px-4 sm:px-6 py-3 flex items-center justify-between gap-3">
          <div className="flex items-center gap-2">
            <div className="w-8 h-8 rounded-xl bg-gradient-to-br from-sky-500 to-sky-400 flex items-center justify-center text-[10px] font-semibold text-slate-950 shadow-lg shadow-sky-500/40">
              IA
            </div>
            <div className="flex flex-col">
              <span className="text-[10px] uppercase tracking-[0.18em] text-slate-400">
                Assistant candidatures
              </span>
              <span className="text-xs font-medium text-slate-100">Inscription</span>
            </div>
          </div>
          <nav className="flex items-center gap-2 text-[11px]">
            <Link
              href="/"
              className="px-2 py-1 rounded-full border border-slate-700/80 hover:border-sky-500/80 text-slate-300 hover:text-sky-300 transition-colors"
            >
              ← Retour accueil
            </Link>
            <Link
              href="/login"
              className="px-3 py-1 rounded-full bg-sky-500/90 text-slate-950 font-medium hover:bg-sky-400 transition-colors"
            >
              Se connecter
            </Link>
          </nav>
        </div>
      </header>

      {/* CONTENU */}
      <main className="flex-1 flex items-center justify-center px-4 py-6">
        <div className="glass max-w-md w-full p-6 sm:p-7 rounded-2xl border border-slate-800 bg-slate-950/80 shadow-2xl shadow-sky-900/40">
          <div className="mb-4">
            <p className="inline-flex items-center gap-2 rounded-full bg-slate-900/80 border border-slate-700 px-3 py-1 mb-2">
              <span className="text-xs">✨</span>
              <span className="text-[11px] uppercase tracking-[0.18em] text-slate-300">
                Inscription
              </span>
            </p>
            <h1 className="text-lg sm:text-xl font-semibold text-slate-50">Créer un compte</h1>
            <p className="text-xs text-slate-400 mt-1">
              Crée ton compte, reçois des crédits de bienvenue et commence à générer tes candidatures.
              Tu devras d&apos;abord{" "}
              <span className="font-semibold text-slate-100">valider ton adresse email</span>.
            </p>
          </div>

          {info && (
            <p className="mb-2 text-xs text-emerald-100 bg-emerald-500/10 border border-emerald-500/40 rounded-md px-3 py-2">
              {info}
            </p>
          )}
          {error && (
            <p className="mb-2 text-xs text-rose-100 bg-rose-500/10 border border-rose-500/40 rounded-md px-3 py-2">
              {error}
            </p>
          )}

          <form onSubmit={handleSubmit} className="space-y-3 text-sm">
            <div className="grid grid-cols-2 gap-2">
              <div>
                <label className="block mb-1 text-xs text-slate-300" htmlFor="firstName">
                  Prénom
                </label>
                <input
                  id="firstName"
                  type="text"
                  className="w-full rounded-lg bg-slate-900/80 border border-slate-700 px-3 py-2 text-xs text-slate-100 placeholder:text-slate-500 outline-none focus:ring-1 focus:ring-sky-500 focus:border-sky-500"
                  value={firstName}
                  onChange={(e) => setFirstName(e.target.value)}
                  required
                  placeholder="Jean"
                />
              </div>
              <div>
                <label className="block mb-1 text-xs text-slate-300" htmlFor="lastName">
                  Nom
                </label>
                <input
                  id="lastName"
                  type="text"
                  className="w-full rounded-lg bg-slate-900/80 border border-slate-700 px-3 py-2 text-xs text-slate-100 placeholder:text-slate-500 outline-none focus:ring-1 focus:ring-sky-500 focus:border-sky-500"
                  value={lastName}
                  onChange={(e) => setLastName(e.target.value)}
                  required
                  placeholder="Dupont"
                />
              </div>
            </div>

            <div>
              <label className="block mb-1 text-xs text-slate-300" htmlFor="email">
                Adresse email
              </label>
              <input
                id="email"
                type="email"
                autoComplete="email"
                className="w-full rounded-lg bg-slate-900/80 border border-slate-700 px-3 py-2 text-xs text-slate-100 placeholder:text-slate-500 outline-none focus:ring-1 focus:ring-sky-500 focus:border-sky-500"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                required
                placeholder="toi@example.com"
              />
            </div>

            <div>
              <label className="block mb-1 text-xs text-slate-300" htmlFor="password">
                Mot de passe
              </label>
              <div className="relative">
                <input
                  id="password"
                  type={showPwd ? "text" : "password"}
                  autoComplete="new-password"
                  className={`w-full rounded-lg bg-slate-900/80 border px-3 py-2 text-xs text-slate-100 placeholder:text-slate-500 outline-none focus:ring-1 focus:ring-sky-500 focus:border-sky-500 pr-16 transition-colors ${
                    password && !pwdRules.ok ? "border-rose-500/70" : "border-slate-700"
                  }`}
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  required
                  placeholder="••••••••"
                />
                <button
                  type="button"
                  className="absolute inset-y-0 right-2 text-[11px] text-slate-400 hover:text-slate-200 flex items-center"
                  onClick={() => setShowPwd((v) => !v)}
                >
                  {showPwd ? "Masquer" : "Afficher"}
                </button>
              </div>

              <ul className="mt-2 text-[10px] space-y-0.5">
                <li className={`flex items-center gap-1 ${pwdRules.min ? "text-emerald-400" : "text-rose-400"}`}>
                  <span className="text-[12px]">{pwdRules.min ? "✔" : "•"}</span>
                  <span>Minimum 8 caractères</span>
                </li>
                <li className={`flex items-center gap-1 ${pwdRules.upper ? "text-emerald-400" : "text-rose-400"}`}>
                  <span className="text-[12px]">{pwdRules.upper ? "✔" : "•"}</span>
                  <span>Au moins une majuscule (A-Z)</span>
                </li>
                <li className={`flex items-center gap-1 ${pwdRules.digit ? "text-emerald-400" : "text-rose-400"}`}>
                  <span className="text-[12px]">{pwdRules.digit ? "✔" : "•"}</span>
                  <span>Au moins un chiffre (0-9)</span>
                </li>
                <li
                  className={`flex items-center gap-1 ${
                    pwdRules.special ? "text-emerald-400" : "text-rose-400"
                  }`}
                >
                  <span className="text-[12px]">{pwdRules.special ? "✔" : "•"}</span>
                  <span>Au moins un caractère spécial (!, @, #, ...)</span>
                </li>
              </ul>
            </div>

            <button
              type="submit"
              disabled={loading}
              className="w-full inline-flex items-center justify-center rounded-lg bg-sky-500 hover:bg-sky-600 disabled:opacity-60 disabled:cursor-not-allowed text-xs font-medium text-white px-3 py-2 mt-1 transition-colors"
            >
              {loading ? "Inscription..." : "S'inscrire"}
            </button>
          </form>

          <div className="flex items-center gap-2 my-4">
            <div className="h-px flex-1 bg-slate-800" />
            <span className="text-[10px] text-slate-500 uppercase tracking-[0.16em]">ou</span>
            <div className="h-px flex-1 bg-slate-800" />
          </div>

          <button
            onClick={handleGoogleSignup}
            disabled={loading}
            className="w-full inline-flex items-center justify-center rounded-lg bg-slate-900/80 border border-slate-700 hover:border-sky-500 text-xs font-medium text-slate-100 px-3 py-2.5 transition-colors"
          >
            Continuer avec <span className="font-semibold ml-1">Google</span>
          </button>

          <p className="mt-4 text-[11px] text-center text-slate-400">
            <span>Déjà un compte ? </span>
            <Link href="/login" className="text-sky-400 hover:text-sky-300 font-semibold underline">
              Se connecter
            </Link>
          </p>
        </div>
      </main>
    </div>
  );
}

export default function SignupPage() {
  return (
    <Suspense
      fallback={
        <div className="min-h-screen flex items-center justify-center text-sm text-slate-400">
          Chargement de la page d’inscription...
        </div>
      }
    >
      <SignupPageInner />
    </Suspense>
  );
}
````

## File: app/tech/page.tsx
````typescript
"use client";

export default function TechPage() {
  return (
    <div className="min-h-screen px-4 sm:px-8 py-8">
      <div className="max-w-4xl mx-auto glass p-6">
        <h1 className="text-xl font-semibold mb-3">Technologies utilisées</h1>
        <p className="text-sm text-[var(--muted)] mb-4">
          Bien que le site lui-même ne liste pas explicitement les technologies de son frontend
          dans le contenu visible, l'analyse du code source et des pratiques courantes pour ce
          type de plateforme moderne suggère fortement l'utilisation de la pile suivante :
        </p>
        <ul className="list-disc pl-5 space-y-2 text-sm">
          <li>
            <span className="font-semibold">Frontend — React / Next.js :</span>{" "}
            Framework JavaScript moderne pour construire l&apos;interface utilisateur,
            avec un routage optimisé et un rendu performant.
          </li>
          <li>
            <span className="font-semibold">Styling — Tailwind CSS :</span>{" "}
            Framework CSS utilitaire permettant de construire rapidement des designs
            réactifs et cohérents.
          </li>
          <li>
            <span className="font-semibold">Animations — Framer Motion :</span>{" "}
            Bibliothèque React dédiée aux animations fluides, transitions interactives
            et gestes avancés.
          </li>
        </ul>
        <p className="text-sm text-[var(--muted)] mt-4">
          Le style sombre, les cartes en verre (glassmorphism) et les transitions rapides
          sont caractéristiques d&apos;une approche basée sur Next.js couplé à Tailwind CSS
          et Framer Motion pour les effets au scroll et à l&apos;interaction.
        </p>
      </div>
    </div>
  );
}
````

## File: app/globals.css
````css
@tailwind base;
@tailwind components;
@tailwind utilities;

/* =========================
   Thème global
   ========================= */
:root {
  --bg: #020617;              /* fond général */
  --bg-soft: #020617;         /* blocs soft */
  --card-elevated: #020617;   /* cartes en relief */
  --ink: #f9fafb;             /* texte principal */
  --muted: #9ca3af;           /* texte secondaire */
  --brand: #60a5fa;           /* bleu principal */
  --brandDark: #1d4ed8;       /* bleu plus foncé */
  --border: #1f2933;          /* gris pour les bordures */
}

html,
body {
  padding: 0;
  margin: 0;
  min-height: 100%;
}

body {
  background:
    radial-gradient(circle at top, #020617 0, #020617 40%, #000 100%);
  color: var(--ink);
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Inter",
    sans-serif;
}

/* Pour que les sections soient bien fluides sur mobile */
body {
  overscroll-behavior-y: none;
}

/* =========================
   Scrollbar globale (droite)
   ========================= */

/* Firefox */
* {
  scrollbar-width: thin;
  scrollbar-color: var(--brand) transparent;
}

/* Chrome / Edge / Safari */
*::-webkit-scrollbar {
  width: 8px;
}

*::-webkit-scrollbar-track {
  background: transparent;
}

*::-webkit-scrollbar-thumb {
  background-image: linear-gradient(
    to bottom,
    var(--brand),
    var(--brandDark)
  );
  border-radius: 9999px;
}

/* Barre de progression en haut */
.scroll-progress-bar {
  border-radius: 9999px;
}

/* =========================
   Utilitaires UI
   ========================= */

.glass {
  background: radial-gradient(circle at top left, rgba(148, 163, 184, 0.16), transparent 55%),
    rgba(15, 23, 42, 0.92);
  backdrop-filter: blur(18px);
}

/* Bouton primaire */
.btn-primary {
  @apply inline-flex items-center justify-center px-4 py-2 rounded-full text-xs sm:text-sm font-medium;
  background-image: linear-gradient(to right, var(--brand), var(--brandDark));
  color: white;
  box-shadow: 0 10px 30px rgba(37, 99, 235, 0.4);
  transition: transform 0.12s ease-out, box-shadow 0.12s ease-out,
    filter 0.12s ease-out;
}

.btn-primary:hover {
  transform: translateY(-1px);
  box-shadow: 0 14px 32px rgba(37, 99, 235, 0.6);
  filter: brightness(1.05);
}

.btn-primary:active {
  transform: translateY(0);
  box-shadow: 0 8px 20px rgba(37, 99, 235, 0.4);
}

/* Bouton secondaire */
.btn-secondary {
  @apply inline-flex items-center justify-center px-4 py-2 rounded-full text-xs sm:text-sm font-medium border;
  border-color: rgba(148, 163, 184, 0.5);
  background: rgba(15, 23, 42, 0.8);
  color: var(--ink);
  transition: background-color 0.12s ease-out, border-color 0.12s ease-out,
    color 0.12s ease-out;
}

.btn-secondary:hover {
  border-color: var(--brand);
  color: white;
}

/* Petites helpers pour cartes etc. */
.card-border {
  border: 1px solid rgba(148, 163, 184, 0.35);
  border-radius: 0.75rem;
}

/* Lien hover subtil */
.link-soft {
  color: var(--muted);
  transition: color 0.12s ease-out;
}

.link-soft:hover {
  color: var(--ink);
}

/* Pour éviter un flash de scroll bar trop claire au load */
::-webkit-scrollbar-corner {
  background: transparent;
}

/* Scrollbar verticale (container principal) */
main::-webkit-scrollbar {
  width: 6px;
}

main::-webkit-scrollbar-track {
  background: transparent;
}

main::-webkit-scrollbar-thumb {
  background: var(--brand);
  border-radius: 999px;
}

main {
  scrollbar-width: thin;               /* Firefox */
  scrollbar-color: var(--brand) transparent;
}

/* =========================
   FORM CONTROLS (inputs / selects / textareas)
   ========================= */

/* Champs de base */
.input,
textarea.input,
textarea.textarea,
select.select-brand {
  width: 100%;
  border-radius: 0.75rem;
  border: 1px solid var(--border);
  background-color: var(--bg-soft);
  color: var(--ink);
  font-size: 0.875rem;
  padding: 0.45rem 0.7rem;
  outline: none;
  transition: border-color 0.15s ease, box-shadow 0.15s ease,
    background-color 0.15s ease, color 0.15s ease;
}

/* Placeholders visibles */
.input::placeholder,
textarea.input::placeholder,
textarea.textarea::placeholder {
  color: var(--muted);
  opacity: 1;
}

/* Focus state */
.input:focus,
textarea.input:focus,
textarea.textarea:focus,
select.select-brand:focus {
  border-color: var(--brand);
  box-shadow: 0 0 0 1px color-mix(in srgb, var(--brand) 60%, transparent);
  background-color: #020617;
}

/* Textarea : redimension verticale seulement */
textarea.input,
textarea.textarea {
  resize: vertical;
  min-height: 3rem;
}

/* Select sur fond un peu différent */
select.select-brand {
  background-color: rgba(15, 23, 42, 0.9);
  padding-right: 2rem;
  appearance: none;
}

/* =========================
   BADGES / CARTES / TOGGLE
   ========================= */

.badge-muted {
  display: inline-flex;
  align-items: center;
  border-radius: 9999px;
  padding: 0.15rem 0.6rem;
  font-size: 0.7rem;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  background-color: rgba(15, 23, 42, 0.9);
  border: 1px solid rgba(148, 163, 184, 0.5);
  color: var(--muted);
}

/* Carte soft (used for LM / Pitch preview) */
.card-soft {
  background: rgba(15, 23, 42, 0.92);
}

/* Simple toggle checkbox (si tu ne l’as pas déjà) */
.toggle-checkbox {
  width: 1rem;
  height: 1rem;
  border-radius: 0.3rem;
  border: 1px solid var(--border);
  background-color: #020617;
  accent-color: var(--brand);
}

/* =========================
   LOADER SPINNER
   ========================= */

.loader {
  border-radius: 9999px;
  border: 2px solid var(--border);
  border-top-color: var(--brand);
  width: 1.1rem;
  height: 1.1rem;
  animation: spin-loader 0.7s linear infinite;
}

@keyframes spin-loader {
  to {
    transform: rotate(360deg);
  }
}

/* =========================
   BANDEAU "L’IA prépare tes documents…"
   (optionnel, mais utile si tu utilises une classe dédiée)
   ========================= */

.assistant-loading-bar {
  border-radius: 9999px;
  backdrop-filter: blur(10px);
}
/* app/globals.css */

/* Assure toi que html / body remplissent bien la hauteur */
html,
body {
  height: 100%;
}

body {
  min-height: 100%;
  /* évite les comportements bizarres de scroll sur mobile */
  overscroll-behavior-y: contain;
  -webkit-tap-highlight-color: transparent;
}

/* Empêche tout débordement horizontal global */
html,
body {
  overflow-x: hidden;
}

/* Si tu utilises #__next (pages router) : garde ça, sinon tu peux l'ignorer */
#__next {
  min-height: 100%;
}

/* Tu peux garder ici toutes tes classes custom :
   .glass, .btn-primary, .badge-muted, etc. */
.grecaptcha-badge {
  visibility: hidden; /* ou display:none; mais visibility est plus “soft” */
}
````

## File: app/layout.tsx
````typescript
// app/layout.tsx
import "./globals.css";
import type { Metadata, Viewport } from "next";
import { AuthProvider } from "@/context/AuthContext";
import ActivityTracker from "@/components/ActivityTracker";

export const metadata: Metadata = {
  title: "Assistant Candidatures IA",
  description: "Tableau de bord CV / LM / candidatures",
};

export const viewport: Viewport = {
  width: "device-width",
  initialScale: 1,
  maximumScale: 1,
  viewportFit: "cover",
};

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html lang="fr">
      <head>
        <link rel="manifest" href="/manifest.webmanifest" />
        <meta name="theme-color" content="#020617" />
        <meta name="mobile-web-app-capable" content="yes" />
        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta
          name="apple-mobile-web-app-status-bar-style"
          content="black-translucent"
        />
      </head>
      <body
        className="
          min-h-screen
          bg-[var(--bg)]
          text-[var(--text)]
          overflow-x-hidden
          antialiased
        "
      >
        <AuthProvider>
          <ActivityTracker />
          <div className="min-h-screen flex flex-col">{children}</div>
        </AuthProvider>
      </body>
    </html>
  );
}
````

## File: app/not-found.tsx
````typescript
"use client";

import Link from "next/link";
import { useAuth } from "@/context/AuthContext";

export default function NotFound() {
  const { user } = useAuth();

  return (
    <div className="min-h-screen flex flex-col items-center justify-center bg-[var(--bg)] text-[var(--ink)] px-4">
      <div className="glass max-w-md w-full p-6 border border-[var(--border)]/80 text-center">
        <h1 className="text-xl font-semibold mb-2">Page introuvable</h1>
        <p className="text-sm text-[var(--muted)] mb-4">
          Le lien que tu as suivi est invalide ou cette page n&apos;existe pas.
        </p>
        <div className="flex flex-wrap gap-3 justify-center">
          <Link href="/" className="btn-secondary text-xs sm:text-sm">
            Retour à l&apos;accueil
          </Link>
          {user && (
            <Link href="/app" className="btn-primary text-xs sm:text-sm">
              Aller au dashboard
            </Link>
          )}
        </div>
      </div>
    </div>
  );
}
````

## File: app/page.tsx
````typescript
"use client";

import Link from "next/link";
import { motion } from "framer-motion";
import { useRef, useState, UIEvent, useEffect } from "react";
import { useRouter } from "next/navigation";
import { onAuthStateChanged, type User } from "firebase/auth";
import { auth } from "@/lib/firebase";

const fadeUp = (delay = 0) => ({
  initial: { opacity: 0, y: 20 },
  whileInView: { opacity: 1, y: 0 },
  transition: { duration: 0.4, delay },
  viewport: { once: false, amount: 0.4 }, // rejoue quand on remonte
});

// ordre des sections pour le menu
const SECTION_IDS: string[] = ["hero", "features", "how", "pricing", "stack", "faq"];

export default function LandingPage() {
  const scrollRef = useRef<HTMLDivElement | null>(null);
  const [progress, setProgress] = useState(0);
  const [activeSection, setActiveSection] = useState<string>("hero");

  // 🔐 état d'auth Firebase
  const [currentUser, setCurrentUser] = useState<User | null>(null);
  const router = useRouter();

  // on écoute l'état Firebase pour savoir si la personne est connectée
  useEffect(() => {
    const unsub = onAuthStateChanged(auth, (user) => {
      setCurrentUser(user);
    });
    return () => unsub();
  }, []);

  // 👉 fonction intelligente pour tous les boutons "Se connecter"
  const handleSmartLoginClick = () => {
    if (currentUser) {
      // déjà connecté → on envoie direct au dashboard
      router.push("/app");
    } else {
      // pas connecté → page de login normale
      router.push("/login");
    }
  };

  const handleScroll = (e: UIEvent<HTMLDivElement>) => {
    const el = e.currentTarget;
    const maxScroll = el.scrollHeight - el.clientHeight;

    // Progress bar (desktop)
    if (maxScroll <= 0) {
      setProgress(0);
    } else {
      const ratio = (el.scrollTop / maxScroll) * 100;
      setProgress(ratio);
    }

    // Déterminer la section la plus proche du haut du container
    const containerRect = el.getBoundingClientRect();
    let closestId: string = activeSection;
    let minDelta = Infinity;

    SECTION_IDS.forEach((id) => {
      const sec = document.getElementById(id) as HTMLElement | null;
      if (!sec) return;
      const rect = sec.getBoundingClientRect();
      const delta = Math.abs(rect.top - containerRect.top);
      if (delta < minDelta) {
        minDelta = delta;
        closestId = id;
      }
    });

    if (closestId !== activeSection) {
      setActiveSection(closestId);
    }
  };

  const baseNavLink =
    "relative inline-flex items-center gap-1 text-[11px] px-2 py-1 rounded-full transition-colors";

  const scrollToSection =
    (id: string) => (e: React.MouseEvent<HTMLAnchorElement>) => {
      e.preventDefault();
      const sec = document.getElementById(id);
      if (sec) {
        sec.scrollIntoView({ behavior: "smooth", block: "start" });
      }
    };

  return (
    <div className="min-h-screen bg-[var(--bg)] text-[var(--ink)] flex flex-col overflow-x-hidden">
      {/* NAVBAR FIXE */}
      <header className="fixed top-0 left-0 right-0 z-40 bg-[var(--bg)]/90 backdrop-blur-xl">
        <div className="max-w-6xl mx-auto px-4 sm:px-8 h-14 flex items-center justify-between">
          {/* Logo + titre */}
          <div className="flex items-center gap-2">
            <div className="w-8 h-8 rounded-2xl bg-gradient-to-br from-[var(--brand)] to-[var(--brandDark)] shadow-lg shadow-[var(--brand)]/30 flex items-center justify-center text-[11px] font-semibold">
              AI
            </div>
            <div className="flex flex-col leading-tight">
              <span className="text-[11px] uppercase tracking-[0.22em] text-[var(--muted)]">
                Assistant candidatures
              </span>
              <span className="text-xs font-medium">Smart CV · LM · Pitch</span>
            </div>
          </div>

          {/* Liens + CTA */}
          <nav className="hidden sm:flex items-center gap-4 text-[11px]">
            <a
              href="#hero"
              onClick={scrollToSection("hero")}
              className={
                activeSection === "hero"
                  ? `${baseNavLink} bg-[var(--bg-soft)] text-[var(--ink)]`
                  : `${baseNavLink} text-[var(--muted)] hover:text-[var(--ink)]`
              }
            >
              {activeSection === "hero" && (
                <span className="inline-flex w-1.5 h-1.5 rounded-full bg-[var(--brand)] animate-pulse" />
              )}
              <span>Accueil</span>
            </a>

            <a
              href="#features"
              onClick={scrollToSection("features")}
              className={
                activeSection === "features"
                  ? `${baseNavLink} bg-[var(--bg-soft)] text-[var(--ink)]`
                  : `${baseNavLink} text-[var(--muted)] hover:text-[var(--ink)]`
              }
            >
              {activeSection === "features" && (
                <span className="inline-flex w-1.5 h-1.5 rounded-full bg-[var(--brand)] animate-pulse" />
              )}
              <span>Fonctionnalités</span>
            </a>

            <a
              href="#how"
              onClick={scrollToSection("how")}
              className={
                activeSection === "how"
                  ? `${baseNavLink} bg-[var(--bg-soft)] text-[var(--ink)]`
                  : `${baseNavLink} text-[var(--muted)] hover:text-[var(--ink)]`
              }
            >
              {activeSection === "how" && (
                <span className="inline-flex w-1.5 h-1.5 rounded-full bg-[var(--brand)] animate-pulse" />
              )}
              <span>Comment ça marche</span>
            </a>

            <a
              href="#pricing"
              onClick={scrollToSection("pricing")}
              className={
                activeSection === "pricing"
                  ? `${baseNavLink} bg-[var(--bg-soft)] text-[var(--ink)]`
                  : `${baseNavLink} text-[var(--muted)] hover:text-[var(--ink)]`
              }
            >
              {activeSection === "pricing" && (
                <span className="inline-flex w-1.5 h-1.5 rounded-full bg-[var(--brand)] animate-pulse" />
              )}
              <span>Tarifs</span>
            </a>

            <a
              href="#stack"
              onClick={scrollToSection("stack")}
              className={
                activeSection === "stack"
                  ? `${baseNavLink} bg-[var(--bg-soft)] text-[var(--ink)]`
                  : `${baseNavLink} text-[var(--muted)] hover:text-[var(--ink)]`
              }
            >
              {activeSection === "stack" && (
                <span className="inline-flex w-1.5 h-1.5 rounded-full bg-[var(--brand)] animate-pulse" />
              )}
              <span>Tech</span>
            </a>

            <a
              href="#faq"
              onClick={scrollToSection("faq")}
              className={
                activeSection === "faq"
                  ? `${baseNavLink} bg-[var(--bg-soft)] text-[var(--ink)]`
                  : `${baseNavLink} text-[var(--muted)] hover:text-[var(--ink)]`
              }
            >
              {activeSection === "faq" && (
                <span className="inline-flex w-1.5 h-1.5 rounded-full bg-[var(--brand)] animate-pulse" />
              )}
              <span>Questions fréquentes</span>
            </a>
          </nav>

          <div className="flex items-center gap-2">
            {/* bouton intelligent : login ou dashboard */}
            <button
              type="button"
              onClick={handleSmartLoginClick}
              className="hidden sm:inline-flex text-[11px] text-[var(--muted)] hover:text-[var(--ink)]"
            >
              Se connecter
            </button>
            <Link
              href="/signup"
              className="inline-flex items-center justify-center text-[11px] sm:text-xs px-3 sm:px-4 py-1.5 rounded-full bg-[var(--brand)] hover:bg-[var(--brandDark)] text-white shadow-lg shadow-[var(--brand)]/40 transition-colors"
            >
              Essayer gratuitement
            </Link>
          </div>
        </div>
      </header>

      {/* CONTENU SCROLL-SNAP (desktop) / scroll normal (mobile) */}
      <div className="flex-1 pt-14">
        {/* Barre de progression uniquement sur desktop */}
        <div className="hidden md:block h-[2px] w-full bg-[var(--border)]/40 sticky top-14 z-30">
          <div
            className="scroll-progress-bar h-full bg-[var(--brand)] transition-[width] duration-150"
            style={{ width: `${progress}%` }}
          />
        </div>

        {/* Container qui scroll + snap seulement à partir de md */}
        <main
          ref={scrollRef}
          onScroll={handleScroll}
          className="
            snap-none 
            md:snap-y md:snap-mandatory
            md:h-[calc(100vh-3.5rem-2px)] md:overflow-y-scroll
            scroll-smooth
          "
        >
          {/* HERO */}
          <section
            id="hero"
            className="md:snap-start md:min-h-[calc(100vh-3.5rem-2px)] flex items-center px-4 sm:px-8 py-10 md:py-0"
          >
            <div className="max-w-6xl mx-auto grid gap-8 md:grid-cols-[1.1fr,0.9fr] items-center">
              <motion.div {...fadeUp(0)}>
                <div className="inline-flex items-center gap-2 rounded-full border border-[var(--border)] bg-[var(--bg-soft)] px-2 py-1 mb-4">
                  <span className="inline-flex h-4 w-4 rounded-full bg-emerald-400/20 border border-emerald-400/50">
                    <span className="m-auto h-2 w-2 rounded-full bg-emerald-400" />
                  </span>
                  <span className="text-[11px] text-[var(--muted)]">
                    Gagne jusqu&apos;à{" "}
                    <span className="text-[var(--ink)] font-medium">
                      4h par semaine
                    </span>{" "}
                    sur tes candidatures.
                  </span>
                </div>

                <h1 className="text-[1.9rem] sm:text-3xl md:text-[2.6rem] font-semibold leading-tight mb-3">
                  L&apos;assistant IA pour candidater comme un pro,
                  <span className="text-[var(--brand)]">
                    {" "}
                    sans y passer tes soirées.
                  </span>
                </h1>

                <p className="text-sm sm:text-base text-[var(--muted)] max-w-xl mb-5">
                  Importe ton CV, colle une offre d’emploi, laisse l’IA générer
                  une lettre de motivation ciblée, un pitch oral et suis toutes
                  tes candidatures depuis un tableau de bord unique.
                </p>

                <div className="flex flex-wrap items-center gap-3 mb-4">
                  <Link
                    href="/signup"
                    className="btn-primary text-xs sm:text-sm"
                  >
                    Essayer gratuitement
                  </Link>

                  {/* bouton intelligent ici aussi */}
                  <button
                    type="button"
                    onClick={handleSmartLoginClick}
                    className="btn-secondary text-xs sm:text-sm"
                  >
                    Se connecter
                  </button>
                </div>

                <p className="text-[11px] text-[var(--muted)]">
                  Aucun CB requise • Crédits offerts à l’inscription • Pensé
                  pour les profils tech & cybersécurité
                </p>
              </motion.div>

              <motion.div {...fadeUp(0.1)} className="relative">
                <div className="glass rounded-2xl p-4 text-[11px] sm:text-xs shadow-2xl shadow-black/60 border border-[var(--border)]/80">
                  <div className="flex items-center justify-between mb-3">
                    <div>
                      <p className="text-[10px] uppercase tracking-[0.18em] text-[var(--muted)]">
                        Aperçu du dashboard
                      </p>
                      <p className="text-xs font-medium mt-1">
                        CV, lettres, pitch & suivi en un coup d&apos;œil.
                      </p>
                    </div>
                    <span className="px-2 py-1 rounded-full bg-emerald-400/10 text-emerald-300 border border-emerald-400/40 text-[10px]">
                      IA activée
                    </span>
                  </div>

                  <div className="grid gap-2 sm:grid-cols-3 mb-3">
                    <div className="rounded-xl bg-[var(--bg-soft)] border border-[var(--border)]/80 px-3 py-2">
                      <p className="text-[10px] text-[var(--muted)] mb-1">
                        Crédits restants
                      </p>
                      <p className="text-lg font-semibold">124</p>
                      <p className="text-[10px] text-[var(--muted)]">
                        ~ 30 lettres + 15 pitchs
                      </p>
                    </div>
                    <div className="rounded-xl bg-[var(--bg-soft)] border border-[var(--border)]/80 px-3 py-2">
                      <p className="text-[10px] text-[var(--muted)] mb-1">
                        Candidatures envoyées
                      </p>
                      <p className="text-lg font-semibold">18</p>
                      <p className="text-[10px] text-[var(--muted)]">
                        5 en entretien 🔥
                      </p>
                    </div>
                    <div className="rounded-xl bg-[var(--bg-soft)] border border-[var(--border)]/80 px-3 py-2">
                      <p className="text-[10px] text-[var(--muted)] mb-1">
                        Temps économisé
                      </p>
                      <p className="text-lg font-semibold">7h / semaine</p>
                      <p className="text-[10px] text-[var(--muted)]">
                        vs candidatures manuelles
                      </p>
                    </div>
                  </div>

                  <div className="rounded-xl bg-gradient-to-br from-[var(--bg-soft)] to-[var(--card-elevated)] border border-[var(--border)]/90 p-3 space-y-2">
                    <div className="flex items-center justify-between text-[10px] text-[var(--muted)]">
                      <span>Offre · Ingénieur cybersécurité</span>
                      <span>
                        Match profil :{" "}
                        <span className="text-emerald-300 font-semibold">
                          92%
                        </span>
                      </span>
                    </div>
                    <div className="h-1.5 w-full rounded-full bg-[var(--bg-soft)] overflow-hidden">
                      <div className="h-full w-[92%] bg-gradient-to-r from-emerald-400 to-[var(--brand)]" />
                    </div>
                    <div className="flex flex-wrap gap-2 text-[10px]">
                      <span className="px-2 py-1 rounded-full bg-emerald-400/10 text-emerald-200 border border-emerald-400/40">
                        LM générée
                      </span>
                      <span className="px-2 py-1 rounded-full bg-[var(--brand)]/10 text-[var(--brand)] border border-[var(--brand)]/40">
                        Pitch prêt
                      </span>
                      <span className="px-2 py-1 rounded-full bg-[var(--bg-soft)] text-[var(--muted)] border border-[var(--border)]/70">
                        Suivi : En cours
                      </span>
                    </div>
                  </div>
                </div>

                <div className="pointer-events-none absolute -inset-10 -z-10 bg-[radial-gradient(circle_at_top,_rgba(88,166,255,0.35),_transparent_60%),radial-gradient(circle_at_bottom,_rgba(16,185,129,0.2),_transparent_55%)] opacity-80" />
              </motion.div>
            </div>
          </section>

          {/* FEATURES */}
          <section
            id="features"
            className="md:snap-start md:min-h-[calc(100vh-3.5rem-2px)] flex items-center px-4 sm:px-8 py-10 md:py-0"
          >
            <div className="max-w-6xl mx-auto w-full">
              <motion.div
                {...fadeUp(0)}
                className="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-3 mb-6"
              >
                <div>
                  <p className="text-[11px] uppercase tracking-[0.22em] text-[var(--muted)] mb-1">
                    Pensé pour ton quotidien
                  </p>
                  <h2 className="text-lg sm:text-xl font-semibold">
                    Tout ce dont tu as besoin pour candidater au calme.
                  </h2>
                </div>
              </motion.div>

              <div className="grid gap-4 md:grid-cols-3">
                {[
                  {
                    title: "CV IA optimisé",
                    desc: "Importe ton CV PDF, l’IA extrait ton profil et te propose une version claire et impactante pour les recruteurs.",
                  },
                  {
                    title: "Lettres ciblées",
                    desc: "Colle une offre d’emploi, l’assistant adapte ta lettre à l’entreprise, au poste et à ton parcours.",
                  },
                  {
                    title: "Pitch d’entretien",
                    desc: "Génère un pitch oral structuré pour te présenter en 30 à 90 secondes en entretien ou en réseautage.",
                  },
                  {
                    title: "Tracker de candidatures",
                    desc: "Garde la main sur tout : qui t’a répondu, où tu en es, quelles relances tu dois faire.",
                  },
                  {
                    title: "Historique IA",
                    desc: "Retrouve facilement tes lettres, tes pitchs et les versions de ton CV, sans te perdre dans les dossiers.",
                  },
                  {
                    title: "Crédits flexibles",
                    desc: "Des packs adaptés à ton rythme : quelques candidatures ciblées ou une vraie campagne d’attaque.",
                  },
                ].map((f, i) => (
                  <motion.div
                    key={f.title}
                    {...fadeUp(0.05 * i)}
                    className="glass p-4 border border-[var(--border)]/80 hover:border-[var(--brand)]/60 transition-colors"
                  >
                    <h3 className="text-sm font-semibold mb-1">{f.title}</h3>
                    <p className="text-[11px] sm:text-xs text-[var(--muted)]">
                      {f.desc}
                    </p>
                  </motion.div>
                ))}
              </div>
            </div>
          </section>

          {/* HOW IT WORKS */}
          <section
            id="how"
            className="md:snap-start md:min-h-[calc(100vh-3.5rem-2px)] flex items-center px-4 sm:px-8 py-10 md:py-0"
          >
            <div className="max-w-6xl mx-auto grid gap-6 md:grid-cols-[1.1fr,0.9fr] items-start">
              <motion.div {...fadeUp(0)}>
                <p className="text-[11px] uppercase tracking-[0.22em] text-[var(--muted)] mb-1">
                  En pratique
                </p>
                <h2 className="text-lg sm:text-xl font-semibold mb-3">
                  3 étapes pour transformer ton process de candidature.
                </h2>
                <p className="text-sm text-[var(--muted)] max-w-xl mb-4">
                  L’objectif : que tu passes moins de temps à lutter avec tes
                  lettres, et plus de temps à préparer tes entretiens.
                </p>

                <ol className="space-y-3 text-sm">
                  <li className="flex gap-3">
                    <span className="mt-0.5 h-6 w-6 rounded-full bg-[var(--brand)]/15 border border-[var(--brand)]/60 text-[10px] flex items-center justify-center">
                      1
                    </span>
                    <div>
                      <p className="font-medium mb-1">
                        Tu importes ton CV & les offres
                      </p>
                      <p className="text-[12px] text-[var(--muted)]">
                        PDF de ton CV, lien d’offre ou texte copié/collé : tout
                        part de ton vrai parcours.
                      </p>
                    </div>
                  </li>
                  <li className="flex gap-3">
                    <span className="mt-0.5 h-6 w-6 rounded-full bg-[var(--brand)]/15 border border-[var(--brand)]/60 text-[10px] flex items-center justify-center">
                      2
                    </span>
                    <div>
                      <p className="font-medium mb-1">
                        L’IA génère lettres, pitchs & matchs
                      </p>
                      <p className="text-[12px] text-[var(--muted)]">
                        Tu valides, ajustes, c’est toi qui garde le contrôle du
                        ton et des infos.
                      </p>
                    </div>
                  </li>
                  <li className="flex gap-3">
                    <span className="mt-0.5 h-6 w-6 rounded-full bg-[var(--brand)]/15 border border-[var(--brand)]/60 text-[10px] flex items-center justify-center">
                      3
                    </span>
                    <div>
                      <p className="font-medium mb-1">
                        Tu suis tout depuis le dashboard
                      </p>
                      <p className="text-[12px] text-[var(--muted)]">
                        Tableau de bord, statut des candidatures, relances,
                        historique : tout est centralisé.
                      </p>
                    </div>
                  </li>
                </ol>
              </motion.div>

              <motion.div
                {...fadeUp(0.1)}
                className="glass p-4 border border-[var(--border)]/80"
              >
                <p className="text-[11px] uppercase tracking-[0.18em] text-[var(--muted)] mb-2">
                  Pour qui ?
                </p>
                <ul className="space-y-2 text-[12px] text-[var(--muted)]">
                  <li>
                    • Étudiants & juniors qui veulent des candidatures propres
                    sans y passer leurs nuits.
                  </li>
                  <li>
                    • Profils tech / cybersécurité qui veulent aller droit au
                    but avec un ton pro.
                  </li>
                  <li>
                    • Pros en reconversion ou en veille qui envoient plusieurs
                    candidatures par semaine.
                  </li>
                </ul>
                <div className="mt-4 border-t border-[var(--border)]/70 pt-3 text-[11px]">
                  <p className="text-[var(--muted)] mb-1">
                    Tu n’es pas obligé de tout automatiser.
                  </p>
                  <p>
                    Utilise l’IA comme un accélérateur : tu gardes le contrôle,
                    l’assistant fait le gros du texte.
                  </p>
                </div>
              </motion.div>
            </div>
          </section>

          {/* PRICING */}
          <section
            id="pricing"
            className="md:snap-start md:min-h-[calc(100vh-3.5rem-2px)] flex items-center px-4 sm:px-8 py-10 md:py-0"
          >
            <div className="max-w-6xl mx-auto w-full">
              <motion.div
                {...fadeUp(0)}
                className="text-center mb-8 max-w-2xl mx-auto"
              >
                <p className="text-[11px] uppercase tracking-[0.22em] text-[var(--muted)] mb-1">
                  Tarifs
                </p>
                <h2 className="text-lg sm:text-xl font-semibold mb-2">
                  Des crédits simples, adaptés à ton rythme.
                </h2>
                <p className="text-sm text-[var(--muted)]">
                  Commence avec les crédits gratuits. Tu ne paies que si l’outil
                  t’aide vraiment.
                </p>
              </motion.div>

              <div className="grid gap-4 md:grid-cols-3">
                {/* Gratuit */}
                <motion.div
                  {...fadeUp(0.05)}
                  className="glass p-4 border border-[var(--border)]/90"
                >
                  <p className="text-[11px] uppercase tracking-[0.18em] text-[var(--muted)] mb-1">
                    Découverte
                  </p>
                  <h3 className="text-sm font-semibold mb-1">
                    Gratuit • Pour tester
                  </h3>
                  <p className="text-[12px] text-[var(--muted)] mb-3">
                    Idéal pour voir si le flow te convient.
                  </p>
                  <p className="text-2xl font-semibold mb-3">0 €</p>
                  <ul className="text-[11px] text-[var(--muted)] space-y-1.5 mb-4">
                    <li>• X crédits offerts à l’inscription</li>
                    <li>• 2 lettres de motivation IA</li>
                    <li>• 1 pitch d’entretien</li>
                    <li>• Accès au tracker de candidatures</li>
                  </ul>
                  <Link
                    href="/signup"
                    className="btn-secondary w-full text-center text-xs"
                  >
                    Commencer gratuitement
                  </Link>
                </motion.div>

                {/* Standard */}
                <motion.div
                  {...fadeUp(0.1)}
                  className="glass p-4 border border-[var(--brand)]/80 relative overflow-hidden"
                >
                  <div className="absolute inset-0 bg-[radial-gradient(circle_at_top,_rgba(88,166,255,0.12),_transparent_55%)] pointer-events-none" />
                  <div className="relative">
                    <p className="text-[11px] uppercase tracking-[0.18em] text-[var(--muted)] mb-1">
                      Plus populaire
                    </p>
                    <h3 className="text-sm font-semibold mb-1">
                      Campagne ciblée
                    </h3>
                    <p className="text-[12px] text-[var(--muted)] mb-3">
                      Pour une vraie recherche active de poste.
                    </p>
                    <p className="text-2xl font-semibold mb-3">
                      19 €{" "}
                      <span className="text-[11px] text-[var(--muted)]">
                        / une fois
                      </span>
                    </p>
                    <ul className="text-[11px] text-[var(--muted)] space-y-1.5 mb-4">
                      <li>• Crédits pour ~25 lettres</li>
                      <li>• Pitchs illimités pour les offres générées</li>
                      <li>• Suivi avancé des candidatures</li>
                      <li>• Priorité sur les améliorations de templates</li>
                    </ul>
                    <Link
                      href="/app/credits"
                      className="btn-primary w-full text-center text-xs"
                    >
                      Acheter des crédits
                    </Link>
                  </div>
                </motion.div>

                {/* Power user */}
                <motion.div
                  {...fadeUp(0.15)}
                  className="glass p-4 border border-[var(--border)]/90"
                >
                  <p className="text-[11px] uppercase tracking-[0.18em] text-[var(--muted)] mb-1">
                    Intensif
                  </p>
                  <h3 className="text-sm font-semibold mb-1">
                    Pro / reconversion
                  </h3>
                  <p className="text-[12px] text-[var(--muted)] mb-3">
                    Pour les périodes de candidatures massives.
                  </p>
                  <p className="text-2xl font-semibold mb-3">
                    39 €{" "}
                    <span className="text-[11px] text-[var(--muted)]">
                      / une fois
                    </span>
                  </p>
                  <ul className="text-[11px] text-[var(--muted)] space-y-1.5 mb-4">
                    <li>• Crédits pour ~60 lettres</li>
                    <li>• Pitchs étendus + variantes</li>
                    <li>• Support prioritaire</li>
                    <li>• Idéal pour changer de pays / secteur</li>
                  </ul>
                  <Link
                    href="/app/credits"
                    className="btn-secondary w-full text-center text-xs"
                  >
                    Voir ce pack plus tard
                  </Link>
                </motion.div>
              </div>
            </div>
          </section>

          {/* STACK */}
          <section
            id="stack"
            className="md:snap-start md:min-h-[calc(100vh-3.5rem-2px)] flex items-center px-4 sm:px-8 py-10 md:py-0"
          >
            <div className="max-w-6xl mx-auto grid gap-6 md:grid-cols-2">
              <motion.div {...fadeUp(0)}>
                <p className="text-[11px] uppercase tracking-[0.22em] text-[var(--muted)] mb-1">
                  Sous le capot
                </p>
                <h2 className="text-lg sm:text-xl font-semibold mb-2">
                  Une stack moderne, optimisée pour la vitesse.
                </h2>
                <p className="text-sm text-[var(--muted)] mb-3">
                  Tu profites d’une interface fluide, sans te soucier de la
                  technique. Mais si ça t’intéresse :
                </p>
                <ul className="text-[12px] text-[var(--muted)] space-y-1.5">
                  <li>
                    •{" "}
                    <span className="text-[var(--ink)] font-medium">
                      Next.js
                    </span>{" "}
                    pour le frontend & le routing.
                  </li>
                  <li>
                    •{" "}
                    <span className="text-[var(--ink)] font-medium">
                      Tailwind CSS
                    </span>{" "}
                    pour le design dark moderne.
                  </li>
                  <li>
                    •{" "}
                    <span className="text-[var(--ink)] font-medium">
                      Framer Motion
                    </span>{" "}
                    pour les animations fluides.
                  </li>
                  <li>
                    •{" "}
                    <span className="text-[var(--ink)] font-medium">
                      Firebase
                    </span>{" "}
                    pour l’auth sécurisée & le stockage.
                  </li>
                  <li>
                    •{" "}
                    <span className="text-[var(--ink)] font-medium">
                      Gemini
                    </span>{" "}
                    pour l’analyse de CV & la génération IA.
                  </li>
                </ul>
              </motion.div>

              <motion.div
                {...fadeUp(0.1)}
                className="glass p-4 border border-[var(--border)]/80 text-[11px] sm:text-xs"
              >
                <p className="text-[11px] uppercase tracking-[0.18em] text-[var(--muted)] mb-2">
                  Pourquoi c&apos;est important pour toi ?
                </p>
                <p className="text-[var(--muted)] mb-2">
                  Parce que ça veut dire : moins de chargements lents, moins de
                  bugs bizarres, et une interface qui réagit comme un vrai outil
                  pro, pas comme un formulaire coincé dans le passé.
                </p>
                <p className="text-[var(--muted)]">
                  Et si tu es curieux·se côté dev, la structure du projet est
                  pensée pour être lisible, extensible, et déployable facilement
                  sur Firebase Hosting.
                </p>
              </motion.div>
            </div>
          </section>

          {/* FAQ / CTA */}
          <section
            id="faq"
            className="md:snap-start md:min-h-[calc(100vh-3.5rem-2px)] flex items-center px-4 sm:px-8 pb-12 pt-10 md:py-0"
          >
            <div className="max-w-4xl mx-auto w-full">
              <motion.div {...fadeUp(0)} className="text-center mb-6">
                <p className="text-[11px] uppercase tracking-[0.22em] text-[var(--muted)] mb-1">
                  Questions fréquentes
                </p>
                <h2 className="text-lg sm:text-xl font-semibold mb-2">
                  Et si tu te poses encore la question…
                </h2>
              </motion.div>

              <div className="space-y-3 text-sm">
                <motion.div
                  {...fadeUp(0.05)}
                  className="glass p-3 border border-[var(--border)]/80"
                >
                  <p className="font-medium mb-1">
                    Est-ce que les textes sont vraiment uniques ?
                  </p>
                  <p className="text-[12px] text-[var(--muted)]">
                    Oui, chaque génération est basée sur ton CV, l’offre collée
                    et les paramètres que tu choisis. Tu peux ensuite éditer et
                    personnaliser autant que tu veux.
                  </p>
                </motion.div>
                <motion.div
                  {...fadeUp(0.1)}
                  className="glass p-3 border border-[var(--border)]/80"
                >
                  <p className="font-medium mb-1">
                    Est-ce que l’outil remplace complètement mon travail ?
                  </p>
                  <p className="text-[12px] text-[var(--muted)]">
                    Non. L’idée est de te donner une base solide, structurée et
                    adaptée, pour que tu passes de 0 → 80% en quelques minutes,
                    puis que tu ajustes les derniers 20%.
                  </p>
                </motion.div>
                <motion.div
                  {...fadeUp(0.15)}
                  className="glass p-3 border border-[var(--border)]/80"
                >
                  <p className="font-medium mb-1">
                    Je peux arrêter quand je veux ?
                  </p>
                  <p className="text-[12px] text-[var(--muted)]">
                    Oui, les crédits ne t&apos;engagent pas dans un abonnement.
                    Tu recharges uniquement quand tu en as besoin.
                  </p>
                </motion.div>
              </div>

              <motion.div
                {...fadeUp(0.2)}
                className="mt-8 glass p-5 border border-[var(--border)]/90 text-center"
              >
                <p className="text-[11px] uppercase tracking-[0.22em] text-[var(--muted)] mb-2">
                  Prêt à tester ?
                </p>
                <h3 className="text-base sm:text-lg font-semibold mb-2">
                  Tu peux créer ton compte en 30 secondes et tester avec de vrais
                  cas.
                </h3>
                <p className="text-[12px] text-[var(--muted)] mb-4">
                  Tu gardes la main sur tout, l’IA est là pour accélérer ton
                  travail, pas pour te remplacer.
                </p>
                <div className="flex flex-wrap gap-3 justify-center">
                  <Link
                    href="/signup"
                    className="btn-primary text-xs sm:text-sm"
                  >
                    Essayer gratuitement
                  </Link>

                  {/* bouton intelligent ici aussi */}
                  <button
                    type="button"
                    onClick={handleSmartLoginClick}
                    className="btn-secondary text-xs sm:text-sm"
                  >
                    J&apos;ai déjà un compte
                  </button>
                </div>
              </motion.div>
            </div>
          </section>
        </main>
      </div>
    </div>
  );
}
````

## File: components/layout/AppLayout.tsx
````typescript
"use client";

import { ReactNode, useEffect, useState } from "react";
import Link from "next/link";
import { usePathname, useRouter } from "next/navigation";
import { useAuth } from "@/context/AuthContext";
import { db } from "@/lib/firebase";
import { doc, onSnapshot } from "firebase/firestore";

const navLinks = [
  { href: "/app", label: "Profil CV IA", icon: "📄" },
  { href: "/app/lm", label: "Assistant candidature", icon: "✨" },
  { href: "/app/tracker", label: "Suivi candidatures", icon: "📊" },
  { href: "/app/interview", label: "Préparer entretien", icon: "🎤" },
  { href: "/app/apply", label: "Postuler", icon: "📨" },
  { href: "/app/history", label: "Historique IA", icon: "🕒" },
  { href: "/app/credits", label: "Crédits", icon: "⚡" },
];

export default function UserAppLayout({ children }: { children: ReactNode }) {
  const { user, loading, logout } = useAuth();
  const router = useRouter();
  const pathname = usePathname();
  const [sidebarOpen, setSidebarOpen] = useState(false);

  // ✅ flag pour être sûr qu'on est côté client
  const [clientReady, setClientReady] = useState(false);
  useEffect(() => {
    setClientReady(true);
  }, []);

  // ✅ Crédits utilisateur (Firestorm)
  const [credits, setCredits] = useState<number | null>(null);

  // 🔒 Protection des routes /app : login + email vérifié
  useEffect(() => {
    if (!clientReady) return;
    if (loading) return;

    if (!user) {
      router.replace("/login");
      return;
    }

    if (!user.emailVerified) {
      router.replace("/auth/verify-email");
      return;
    }
  }, [clientReady, user, loading, router]);

  // 🛡 Surveillance du doc user : blocage + crédits
  useEffect(() => {
    if (!clientReady) return;
    if (!user) return;

    const ref = doc(db, "users", user.uid);

    const unsub = onSnapshot(
      ref,
      (snap) => {
        const data = snap.data() as any | undefined;

        // blocage
        if (data?.blocked) {
          logout()
            .catch((e) =>
              console.error("Erreur déconnexion après blocage :", e)
            )
            .finally(() => {
              router.replace("/login?blocked=1");
            });
          return;
        }

        // crédits
        if (typeof data?.credits === "number") {
          setCredits(data.credits);
        } else {
          setCredits(0);
        }
      },
      (err) => {
        console.error("Erreur surveillance utilisateur :", err);
      }
    );

    return () => {
      unsub();
    };
  }, [clientReady, user, logout, router]);

  // ferme le menu mobile au changement de page
  useEffect(() => {
    setSidebarOpen(false);
  }, [pathname]);

  // ⚠️ Tant qu'on n'est pas prêt ou pas autorisé → on ne rend PAS le dashboard
  if (!clientReady || loading || !user || !user.emailVerified) {
    return null;
  }

  const handleLogout = async () => {
    try {
      await logout();
      router.replace("/login");
    } catch (e) {
      console.error("Erreur déconnexion :", e);
    }
  };

  const currentNav = navLinks.find(
    (link) =>
      pathname === link.href || pathname.startsWith(link.href + "/")
  );
  const pageTitle = currentNav?.label ?? "Espace candidat";

  const CreditsBadge =
    credits === null ? null : (
      <div className="inline-flex items-center gap-1 rounded-full px-2 py-1 text-[11px] bg-[var(--bg-soft)] border border-[var(--border)]/80 text-[var(--ink)]">
        <span className="text-[13px]">⚡</span>
        <span>
          <span className="font-semibold">{credits}</span> crédits
        </span>
      </div>
    );

  return (
    <div className="min-h-screen flex bg-[var(--bg)] text-[var(--ink)]">
      {/* SIDEBAR DESKTOP */}
      <aside className="hidden md:flex w-60 shrink-0 flex-col border-r border-[var(--border)] bg-[var(--bg-soft)]/60">
        <div className="flex items-center gap-2 px-3 py-4 border-b border-[var(--border)]/70">
          <Link href="/app" className="flex items-center gap-2">
            <div className="w-9 h-9 rounded-2xl bg-[var(--brand)]/10 border border-[var(--brand)]/40 flex items-center justify-center text-lg">
              ⚡
            </div>
            <div className="flex flex-col">
              <span className="text-xs font-semibold">
                Assistant Candidature IA
              </span>
              <span className="text-[10px] text-[var(--muted)]">
                Espace candidat
              </span>
            </div>
          </Link>
        </div>

        <nav className="flex-1 px-2 py-3 space-y-1 text-[13px] overflow-y-auto">
          {navLinks.map((link) => {
            const active =
              pathname === link.href ||
              pathname.startsWith(link.href + "/");
            return (
              <Link
                key={link.href}
                href={link.href}
                className={[
                  "flex items-center gap-2 rounded-lg px-2 py-1.5 transition-colors border border-transparent",
                  active
                    ? "bg-[var(--bg)] text-[var(--ink)] border-[var(--brand)]/60"
                    : "text-[var(--muted)] hover:text-[var(--ink)] hover:bg-[var(--bg-soft)]",
                ].join(" ")}
              >
                <span className="w-5 text-center text-[13px]">
                  {link.icon}
                </span>
                <span>{link.label}</span>
              </Link>
            );
          })}
        </nav>

        <div className="border-t border-[var(--border)]/70 px-3 py-3 text-[11px] flex flex-col gap-2">
          {/* Badge crédits dans le bas de la sidebar */}
          {CreditsBadge}

          {user?.email && (
            <p className="text-[var(--muted)]">
              Connecté·e :{" "}
              <span className="font-medium text-[var(--ink)]">
                {user.email}
              </span>
            </p>
          )}
          <button
            type="button"
            onClick={handleLogout}
            className="w-full text-[11px] rounded-full border border-[var(--border)] px-3 py-1.5 bg-[var(--bg)] hover:border-red-500 hover:text-red-300 transition-colors"
          >
            Se déconnecter
          </button>
        </div>
      </aside>

      {/* COLONNE CONTENU */}
      <div className="flex-1 flex flex-col relative">
        <div className="pointer-events-none absolute inset-0 -z-10 bg-[radial-gradient(circle_at_top,_rgba(56,189,248,0.16),_transparent_55%),radial-gradient(circle_at_bottom,_rgba(94,234,212,0.12),_transparent_55%)]" />

        {/* TOPBAR */}
        <header className="sticky top-0 z-30 border-b border-[var(--border)]/80 bg-[var(--bg)]/95 backdrop-blur">
          <div className="flex items-center justify-between gap-3 px-3 sm:px-6 py-3">
            <div className="flex items-center gap-3">
              <button
                type="button"
                aria-label="Ouvrir la navigation"
                onClick={() => setSidebarOpen(true)}
                className="md:hidden rounded-full p-2 bg-[var(--bg-soft)] border border-[var(--border)]/80 shadow-sm focus:outline-none focus:ring-2 focus:ring-[var(--brand)]/60"
              >
                <div className={`menu-icon1 ${sidebarOpen ? "is-open" : ""}`}>
                  <div className="menu-icon1_line-top"></div>
                  <div className="menu-icon1_line-middle">
                    <div className="menu-icon1_line-middle-inner"></div>
                  </div>
                  <div className="menu-icon1_line-bottom"></div>
                </div>
              </button>

              <div className="flex flex-col">
                <span className="text-[11px] font-medium uppercase tracking-wide text-[var(--muted)]">
                  Tableau de bord
                </span>
                <span className="text-sm font-semibold">{pageTitle}</span>
              </div>
            </div>

            <div className="flex items-center gap-3">
              {/* Badge crédits visible dans la topbar */}
              {CreditsBadge}

              {user?.email && (
                <span className="hidden sm:inline text-[11px] text-[var(--muted)]">
                  {user.email}
                </span>
              )}
              <button
                type="button"
                onClick={handleLogout}
                className="text-[11px] rounded-full border border-[var(--border)] px-3 py-1.5 bg-[var(--bg-soft)] hover:border-red-500 hover:text-red-300 transition-colors"
              >
                Se déconnecter
              </button>
            </div>
          </div>
        </header>

        <main className="flex-1 overflow-y-auto">
          <div className="px-3 sm:px-6 lg:px-8 py-4 lg:py-6">
            <div className="max-w-6xl mx-auto space-y-4">{children}</div>
          </div>
        </main>
      </div>

      {/* MENU MOBILE (DRAWER) */}
      <div
        className={`fixed inset-0 z-40 md:hidden transition ${
          sidebarOpen ? "pointer-events-auto" : "pointer-events-none"
        }`}
      >
        <div
          className={`absolute inset-0 bg-black/50 transition-opacity ${
            sidebarOpen ? "opacity-100" : "opacity-0"
          }`}
          onClick={() => setSidebarOpen(false)}
        />

        <div
          className={`absolute left-0 top-0 h-full w-64 bg-[var(--bg)] border-r border-[var(--border)] shadow-xl transform transition-transform ${
            sidebarOpen ? "translate-x-0" : "-translate-x-full"
          }`}
        >
          <div className="flex items-center justify-between px-3 py-3 border-b border-[var(--border)]/80">
            <div className="flex items-center gap-2">
              <div className="menu-icon1">
                <div className="menu-icon1_line-top"></div>
                <div className="menu-icon1_line-middle">
                  <div className="menu-icon1_line-middle-inner"></div>
                </div>
                <div className="menu-icon1_line-bottom"></div>
              </div>
              <div className="flex flex-col">
                <span className="text-xs font-semibold">Menu</span>
                <span className="text-[10px] text-[var(--muted)]">
                  Navigation
                </span>
              </div>
            </div>
            <button
              type="button"
              onClick={() => setSidebarOpen(false)}
              className="text-[11px] rounded-full border border-[var(--border)] px-2 py-1 hover:bg-[var(--bg-soft)]"
            >
              ✕
            </button>
          </div>

          <nav className="px-2 py-3 flex flex-col gap-1 text-[13px] overflow-y-auto">
            {navLinks.map((link) => {
              const active =
                pathname === link.href ||
                pathname.startsWith(link.href + "/");
              return (
                <Link
                  key={link.href}
                  href={link.href}
                  className={[
                    "flex items-center gap-2 rounded-lg px-2 py-1.5 transition-colors border border-transparent",
                    active
                      ? "bg-[var(--bg)] text-[var(--ink)] border-[var(--brand)]/60"
                      : "text-[var(--muted)] hover:text-[var(--ink)] hover:bg-[var(--bg-soft)]",
                  ].join(" ")}
                >
                  <span className="w-5 text-center text-[13px]">
                    {link.icon}
                  </span>
                  <span>{link.label}</span>
                </Link>
              );
            })}
          </nav>

          <div className="border-t border-[var(--border)]/70 px-3 py-3 text-[11px] space-y-2">
            {/* Badge crédits aussi dans le menu mobile */}
            {CreditsBadge}

            {user?.email && (
              <p className="mb-1 text-[var(--muted)]">
                Connecté·e :{" "}
                <span className="font-medium text-[var(--ink)]">
                  {user.email}
                </span>
              </p>
            )}
            <button
              type="button"
              onClick={handleLogout}
              className="w-full text-[11px] rounded-full border border-[var(--border)] px-3 py-1.5 bg-[var(--bg)] hover:border-red-500 hover:text-red-300 transition-colors"
            >
              Se déconnecter
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}
````

## File: components/user/CreditsBadge.tsx
````typescript
"use client";

import { useUserCredits } from "@/hooks/useUserCredits";

export function CreditsBadge() {
  const { credits, loading } = useUserCredits();

  return (
    <div className="inline-flex items-center gap-1 rounded-full px-2 py-1 text-[11px] bg-[var(--bg-soft)] border border-[var(--border)]/80 text-[var(--ink)]">
      <span className="text-[13px]">⚡</span>
      {loading ? (
        <span className="opacity-70">Chargement…</span>
      ) : (
        <span>
          <span className="font-semibold">{credits}</span> crédits
        </span>
      )}
    </div>
  );
}
````

## File: components/ActivityTracker.tsx
````typescript
// components/ActivityTracker.tsx
"use client";

import { useEffect } from "react";
import { useAuth } from "@/context/AuthContext";
import { updateLastActive } from "@/lib/userTracking";

/**
 * Composant invisible qui met à jour lastActiveAt
 * toutes les 60 secondes tant que l'utilisateur est connecté.
 * On en profite pour envoyer:
 *  - la page actuelle (path)
 *  - le device (iPhone / iPad / macOS / etc.)
 *  - l’IP + pays + ville (via userTracking)
 */
export default function ActivityTracker() {
  const { user } = useAuth();

  useEffect(() => {
    if (!user) return;

    let cancelled = false;

    const tick = () => {
      if (!user || cancelled) return;

      const path =
        typeof window !== "undefined"
          ? window.location.pathname + window.location.search
          : undefined;

      updateLastActive(user, {
        path,
        action: "heartbeat",
      });
    };

    // première mise à jour immédiate
    tick();
    const id = setInterval(tick, 60_000); // toutes les 60 secondes

    return () => {
      cancelled = true;
      clearInterval(id);
    };
  }, [user]);

  return null;
}
````

## File: components/AOSProvider.tsx
````typescript
"use client";

import { useEffect } from "react";
import AOS from "aos";
import "aos/dist/aos.css";

export default function AOSProvider({ children }: { children: React.ReactNode }) {
  useEffect(() => {
    AOS.init({
      duration: 1000, // durée des animations
      once: true,     // n’anime qu’une seule fois
      easing: "ease-out-cubic",
      offset: 60
    });
  }, []);

  return <>{children}</>;
}
````

## File: components/BlockedOverlay.tsx
````typescript
// components/BlockedOverlay.tsx
"use client";

import { useAuth } from "@/context/AuthContext";
import { useUserProfile } from "@/hooks/useUserProfile";

/**
 * Affiche un overlay pleine page si le user est marqué "blocked" dans Firestore.
 * Résultat : impossible de cliquer / utiliser l'app.
 */
export default function BlockedOverlay() {
  const { user } = useAuth();
  const { profile, loading } = useUserProfile();

  // pas connecté ou encore en chargement -> pas d'overlay
  if (!user || loading) return null;

  if (!profile?.blocked) return null;

  return (
    <div className="fixed inset-0 z-[9999] bg-black/80 backdrop-blur-sm flex items-center justify-center px-4">
      <div className="max-w-md w-full glass border border-red-500/40 rounded-2xl p-6 text-center">
        <h2 className="text-lg font-semibold mb-2 text-red-100">
          Accès bloqué
        </h2>
        <p className="text-xs text-[var(--muted)] mb-4">
          Ton compte a été temporairement bloqué par l&apos;administration.
          Tu ne peux plus utiliser l&apos;assistant tant que le blocage est
          actif.
        </p>
        <p className="text-[11px] text-[var(--muted)] mb-4">
          Si tu penses qu&apos;il s&apos;agit d&apos;une erreur, contacte le
          support ou l&apos;administrateur.
        </p>
        <p className="text-[10px] text-[var(--muted)]/70">
          ID utilisateur :{" "}
          <span className="font-mono">
            {profile.id.slice(0, 8)}…
          </span>
        </p>
      </div>
    </div>
  );
}
````

## File: components/BuyCreditsButtons.tsx
````typescript
// src/components/BuyCreditsButtons.tsx
"use client";

import { useState } from "react";

type CreditPackId = "10" | "20" | "30";

interface BuyCreditsButtonsProps {
  user: {
    id: string;
    email: string;
  };
}

export function BuyCreditsButtons({ user }: BuyCreditsButtonsProps) {
  const [loadingPack, setLoadingPack] = useState<CreditPackId | null>(null);

  const handleBuy = async (packId: CreditPackId) => {
    try {
      setLoadingPack(packId);

      const res = await fetch("/api/polar/checkout", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          packId,
          email: user.email,
          userId: user.id,
        }),
      });

      const data = await res.json();

      if (!data.ok || !data.url) {
        console.error("Erreur réponse API Polar:", data);
        alert("Erreur lors de la création du paiement.");
        return;
      }

      // Redirection vers la page de paiement Polar
      window.location.href = data.url;
    } catch (error) {
      console.error("Erreur handleBuy:", error);
      alert("Une erreur est survenue.");
    } finally {
      setLoadingPack(null);
    }
  };

  const isLoading = (pack: CreditPackId) => loadingPack === pack;

  return (
    <div className="flex flex-col gap-3">
      <button onClick={() => handleBuy("10")} disabled={isLoading("10")}>
        {isLoading("10") ? "Redirection..." : "Acheter 10 crédits"}
      </button>
      <button onClick={() => handleBuy("20")} disabled={isLoading("20")}>
        {isLoading("20") ? "Redirection..." : "Acheter 20 crédits"}
      </button>
      <button onClick={() => handleBuy("30")} disabled={isLoading("30")}>
        {isLoading("30") ? "Redirection..." : "Acheter 30 crédits"}
      </button>
    </div>
  );
}
````

## File: components/InterviewChat.tsx
````typescript
// components/InterviewChat.tsx
"use client";

import { useState, useEffect, useRef } from "react";
import { useAuth } from "@/context/AuthContext";

type Message = {
  role: "interviewer" | "candidate" | "system";
  text: string;
};

type InterviewMode = "complet" | "rapide" | "technique" | "comportemental";
type Difficulty = "facile" | "standard" | "difficile";
type VoiceProfileId = "femme" | "homme";
type RecruiterGender = "f" | "m";

const INTERVIEW_QUESTION_PLAN: Record<InterviewMode, number> = {
  complet: 8,
  rapide: 4,
  technique: 6,
  comportemental: 6,
};

const VOICE_PROFILES: Record<
  VoiceProfileId,
  { label: string; pitch: number; rate: number }
> = {
  femme: {
    label: "Voix féminine",
    pitch: 1.1,
    rate: 1.0,
  },
  homme: {
    label: "Voix masculine",
    pitch: 0.9,
    rate: 0.98,
  },
};

// Durée moyenne par question (en minutes) pour l'estimation
const AVG_MIN_PER_QUESTION = 1.5;

// --- Helper : récup nom côté client (Firebase Auth) ---
const getCandidateNameFromAuth = (user: any): string | null => {
  if (!user) return null;
  const possible =
    user.displayName ||
    user.fullName ||
    user.name ||
    user.email?.split("@")[0] ||
    "";
  const trimmed = (possible || "").toString().trim();
  return trimmed || null;
};

// --- Helper : nettoie & personnalise les questions contenant [Nom du candidat...] ---
const personalizeQuestionClient = (
  raw: string | null | undefined,
  user: any
): string => {
  if (!raw) return "";
  let q = raw;

  const safeName = getCandidateNameFromAuth(user) || "";
  const firstName = safeName.split(" ")[0] || safeName;

  if (safeName) {
    // FR
    q = q.replace(/\[Nom du candidat[^\]]*\]/gi, safeName);
    q = q.replace(/\[Prénom du candidat[^\]]*\]/gi, firstName);
    // EN (au cas où)
    q = q.replace(/\[Name of the candidate[^\]]*\]/gi, safeName);
    q = q.replace(/\[First name of the candidate[^\]]*\]/gi, firstName);
  } else {
    q = q.replace(/\[Nom du candidat[^\]]*\]/gi, "");
    q = q.replace(/\[Prénom du candidat[^\]]*\]/gi, "");
    q = q.replace(/\[Name of the candidate[^\]]*\]/gi, "");
    q = q.replace(/\[First name of the candidate[^\]]*\]/gi, "");
  }

  // Nettoyage "Bonjour ,", espaces multiples, etc.
  q = q.replace(/\s+,/g, ",");
  q = q.replace(/\s{2,}/g, " ").trim();
  q = q.replace(/^,\s*/, "");

  // Harmonise les débuts de phrase
  q = q.replace(/^Bonjour\s*,/i, "Bonjour,");
  q = q.replace(/^Bonjour\s+$/, "Bonjour,");

  return q.trim();
};

export default function InterviewChat() {
  const { user } = useAuth();

  const [sessionId, setSessionId] = useState<string | null>(null);
  const [history, setHistory] = useState<Message[]>([]);
  const [input, setInput] = useState("");
  const [loading, setLoading] = useState(false);

  // "started" = entretien en cours (questions qui s'enchaînent)
  const [started, setStarted] = useState(false);
  // "finished" = bilan final reçu
  const [finished, setFinished] = useState(false);

  // Config entretien
  const [jobTitle, setJobTitle] = useState("");
  const [jobDesc, setJobDesc] = useState("");
  const [interviewMode, setInterviewMode] =
    useState<InterviewMode>("complet");
  const [difficulty, setDifficulty] = useState<Difficulty>("standard");

  // Profil du recruteur : voix + avatar
  const [voiceProfile, setVoiceProfile] =
    useState<VoiceProfileId>("femme");
  const [recruiterGender, setRecruiterGender] =
    useState<RecruiterGender>("f");

  // Progression de l'entretien
  const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);
  const [totalQuestions, setTotalQuestions] = useState(
    INTERVIEW_QUESTION_PLAN["complet"]
  );

  // États vocaux
  const [listening, setListening] = useState(false);
  const recognitionRef = useRef<any>(null);
  const [speechSupported, setSpeechSupported] = useState(false);
  const [recognitionSupported, setRecognitionSupported] =
    useState(false);
  const [aiSpeaking, setAiSpeaking] = useState(false);

  // Feedback final
  const [finalSummary, setFinalSummary] = useState<string | null>(null);
  const [finalScore, setFinalScore] = useState<number | null>(null);
  const [finalDecision, setFinalDecision] = useState<string | null>(null);

  // Effet "texte qui s'écrit" pour la dernière question
  const [typing, setTyping] = useState(false);
  const [typingIndex, setTypingIndex] = useState(0);

  // Auto-scroll du chat
  const chatRef = useRef<HTMLDivElement | null>(null);

  // --- INIT VOIX (TTS) ---
  useEffect(() => {
    if (typeof window === "undefined") return;
    if ("speechSynthesis" in window) {
      setSpeechSupported(true);
    } else {
      setSpeechSupported(false);
    }
  }, []);

  // --- AUTO-SCROLL DU CHAT ---
  useEffect(() => {
    const el = chatRef.current;
    if (!el) return;
    el.scrollTop = el.scrollHeight;
  }, [history, loading]);

  // Index du dernier message "interviewer" (pour l'effet typewriter)
  const lastInterviewerIndex =
    history.length > 0
      ? [...history]
          .map((m, i) => ({ m, i }))
          .reverse()
          .find(({ m }) => m.role === "interviewer")?.i ?? -1
      : -1;

  const lastInterviewerMessage =
    lastInterviewerIndex >= 0
      ? history[lastInterviewerIndex]?.text || ""
      : "";

  // --- TYPEWRITER (effet texte qui s'écrit pour la dernière question) ---
  useEffect(() => {
    if (!typing) return;
    if (lastInterviewerIndex === -1) return;
    const msg = history[lastInterviewerIndex];
    if (!msg) return;

    if (typingIndex >= msg.text.length) {
      setTyping(false);
      return;
    }

    const interval = setInterval(() => {
      setTypingIndex((prev) => prev + 2);
    }, 15);

    return () => clearInterval(interval);
  }, [typing, typingIndex, history, lastInterviewerIndex]);

  // --- BEEP MIC ---
  const playMicBeep = () => {
    try {
      const W = window as any;
      const AudioContext =
        W.AudioContext || W.webkitAudioContext;
      if (!AudioContext) return;
      const ctx = new AudioContext();
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.type = "sine";
      osc.frequency.value = 1000;
      gain.gain.value = 0.06;
      osc.connect(gain);
      gain.connect(ctx.destination);
      osc.start();
      setTimeout(() => {
        osc.stop();
        ctx.close();
      }, 120);
    } catch (e) {
      console.warn("Impossible de jouer le beep micro", e);
    }
  };

  // --- PARLER (TTS) : NE LIT QUE LES QUESTIONS ---
  const speak = (text: string) => {
    if (typeof window === "undefined") return;
    const toSpeak = (text || "").trim();
    if (!toSpeak) return;
    if (!("speechSynthesis" in window)) {
      console.warn("speechSynthesis non supporté");
      return;
    }

    try {
      const utterance = new SpeechSynthesisUtterance(toSpeak);

      // Langue
      utterance.lang = "fr-FR";

      // Pitch + vitesse selon profil (mais pas critique si ça ne marche pas)
      const profile = VOICE_PROFILES[voiceProfile];
      if (profile) {
        utterance.pitch = profile.pitch;
        utterance.rate = profile.rate;
      }

      // Gestion des états UI
      utterance.onstart = () => setAiSpeaking(true);
      utterance.onend = () => setAiSpeaking(false);
      utterance.onerror = (e) => {
        console.error("Erreur TTS:", e);
        setAiSpeaking(false);
      };

      // On annule ce qui est en cours puis on parle
      try {
        window.speechSynthesis.cancel();
      } catch {
        // ignore
      }
      window.speechSynthesis.speak(utterance);
    } catch (e) {
      console.error("Erreur synthèse vocale:", e);
      setAiSpeaking(false);
    }
  };

  // --- PARSE des payloads backend (gère ```json ...``` + JSON cassé) ---
  const parseInterviewPayload = (raw: any): {
    nextQuestion: string | null;
    shortAnalysis: string | null;
    finalSummary: string | null;
    finalScore: number | null;
  } => {
    let obj: any = raw;

    const tryParseString = (txt: string | null | undefined): any => {
      if (!txt) return null;
      let inner = txt.trim();

      // On enlève d'abord les balises ```lang ... ```
      if (inner.startsWith("```")) {
        inner = inner
          .replace(/^```[a-zA-Z]*\s*\n?/, "")
          .replace(/```$/, "")
          .trim();
      }

      try {
        // Si c'est un JSON propre, on parse direct
        const parsed = JSON.parse(inner);
        return parsed;
      } catch {
        // Sinon, on essaie d'extraire les champs à la main (regex)
        const result: any = {};

        const extractField = (
          field: string,
          source: string
        ): string | null => {
          const doubleQuote =
            source.match(
              new RegExp(
                `"${field}"\\s*:\\s*"([^"]*)"`,
                "s"
              )
            ) ||
            source.match(
              new RegExp(
                `"${field}"\\s*:\\s*\\"([^"]*)\\"`,
                "s"
              )
            );
          const singleQuote = source.match(
            new RegExp(
              `'${field}'\\s*:\\s*'([^']*)'`,
              "s"
            )
          );
          const m = doubleQuote || singleQuote;
          if (!m) return null;
          return m[1].replace(/\\"/g, '"');
        };

        const nextQ =
          extractField("next_question", inner) ??
          extractField("nextQuestion", inner);
        const shortA =
          extractField("short_analysis", inner) ??
          extractField("shortAnalysis", inner);
        const finalSum =
          extractField("final_summary", inner) ??
          extractField("finalSummary", inner);
        const finalScoreStr =
          extractField("final_score", inner) ??
          extractField("finalScore", inner);

        if (nextQ) result.next_question = nextQ;
        if (shortA) result.short_analysis = shortA;
        if (finalSum) result.final_summary = finalSum;
        if (finalScoreStr) {
          const num = parseFloat(finalScoreStr);
          if (!Number.isNaN(num)) result.final_score = num;
        }

        if (Object.keys(result).length > 0) {
          return result;
        }

        // Dernier fallback : on considère que tout le texte est la question
        return { next_question: inner };
      }
    };

    // Si on reçoit une string brute (potentiellement avec ```json ...``` dedans)
    if (typeof obj === "string") {
      obj = tryParseString(obj);
    }

    // Si on reçoit un objet, mais que certains champs sont eux-mêmes du ```json ...```
    if (obj && typeof obj === "object") {
      if (
        typeof obj.nextQuestion === "string" &&
        obj.nextQuestion.trim().startsWith("```")
      ) {
        const nested = tryParseString(obj.nextQuestion);
        if (nested && typeof nested === "object") {
          const q =
            (nested as any).next_question ??
            (nested as any).nextQuestion ??
            null;
          obj = {
            ...obj,
            ...nested,
            next_question: q ?? obj.next_question,
            nextQuestion: q ?? obj.nextQuestion,
          };
        }
      }
      if (
        typeof obj.next_question === "string" &&
        obj.next_question.trim().startsWith("```")
      ) {
        const nested = tryParseString(obj.next_question);
        if (nested && typeof nested === "object") {
          const q =
            (nested as any).next_question ??
            (nested as any).nextQuestion ??
            null;
          obj = {
            ...obj,
            ...nested,
            next_question: q ?? obj.next_question,
            nextQuestion: q ?? obj.nextQuestion,
          };
        }
      }
    }

    // ⚠️ IMPORTANT : on privilégie toujours next_question (propre) avant nextQuestion
    const nextQuestionRaw =
      obj?.next_question ||
      obj?.nextQuestion ||
      obj?.question ||
      null;
    const shortAnalysis =
      obj?.short_analysis || obj?.shortAnalysis || null;
    const finalSummary =
      obj?.final_summary || obj?.finalSummary || null;
    const finalScoreRaw =
      obj?.final_score ?? obj?.finalScore ?? null;

    const nextQuestionText =
      typeof nextQuestionRaw === "string"
        ? nextQuestionRaw.trim()
        : null;

    // --- NETTOYAGE : on retire tout bloc ```...``` éventuel du texte public ---
    let cleanNextQuestion = nextQuestionText;
    if (cleanNextQuestion) {
      cleanNextQuestion = cleanNextQuestion
        .replace(/```[a-zA-Z]*\s*\n?[\s\S]*?```/g, "")
        .trim();
    }
    // -------------------------------------------------------------------------

    const scoreNum =
      typeof finalScoreRaw === "number"
        ? finalScoreRaw
        : typeof finalScoreRaw === "string"
        ? parseFloat(finalScoreRaw)
        : null;

    return {
      nextQuestion: cleanNextQuestion,
      shortAnalysis:
        typeof shortAnalysis === "string"
          ? shortAnalysis.trim()
          : null,
      finalSummary:
        typeof finalSummary === "string"
          ? finalSummary.trim()
          : null,
      finalScore: Number.isNaN(scoreNum) ? null : scoreNum,
    };
  };

  // --- START ---
  const startInterview = async () => {
    if (!user) {
      alert("Connecte-toi d'abord pour lancer la simulation.");
      return;
    }

    // 🔓 Débloque TTS dans le geste utilisateur (iOS / mobiles stricts)
    try {
      if (
        typeof window !== "undefined" &&
        "speechSynthesis" in window
      ) {
        const silent = new SpeechSynthesisUtterance(" ");
        silent.volume = 0;
        silent.rate = 1;
        silent.pitch = 1;
        window.speechSynthesis.speak(silent);
      }
    } catch (e) {
      console.warn("Impossible de débloquer TTS", e);
    }

    setLoading(true);
    setHistory([]);
    setFinished(false);
    setFinalSummary(null);
    setFinalScore(null);
    setFinalDecision(null);
    setCurrentQuestionIndex(0);
    setTotalQuestions(INTERVIEW_QUESTION_PLAN[interviewMode]);

    try {
      const res = await fetch("/api/interview", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          action: "start",
          userId: user.uid,
          jobTitle,
          jobDesc,
          interviewMode,
          difficulty,
          channel: "oral",
        }),
      });

      const contentType = res.headers.get("content-type") || "";
      if (!contentType.includes("application/json")) {
        const text = await res.text();
        console.error("Réponse non JSON de /api/interview (start):", text);
        throw new Error(
          "Réponse serveur invalide (non JSON). Vérifie le rewrite /api/interview."
        );
      }

      const data = await res.json();
      if (!res.ok) {
        throw new Error(
          data.error || "Erreur lors du démarrage de l'entretien."
        );
      }

      let rawFirst =
        data.firstQuestion ||
        data.first_question ||
        data.nextQuestion ||
        data.next_question ||
        data;

      const {
        nextQuestion,
        shortAnalysis,
        finalSummary,
        finalScore,
      } = parseInterviewPayload(rawFirst);

      const firstQ = personalizeQuestionClient(
        nextQuestion ||
          "Bonjour ! Pour commencer, pouvez-vous vous présenter en quelques phrases ?",
        user
      );

      setSessionId(data.sessionId || data.session_id || null);
      setStarted(true);
      setCurrentQuestionIndex(1);

      const newHistory: Message[] = [
        { role: "interviewer", text: firstQ },
      ];

      if (shortAnalysis) {
        newHistory.push({
          role: "system",
          text: `💭 Ce que pense le recruteur : ${shortAnalysis}`,
        });
      }

      setHistory(newHistory);

      if (finalSummary) {
        setFinalSummary(finalSummary);
        if (finalScore !== null) setFinalScore(finalScore);
        setFinished(true);
      }

      setTypingIndex(0);
      setTyping(true);
      speak(firstQ);
    } catch (e: any) {
      console.error(e);
      alert(
        e.message || "Erreur lors du démarrage de la simulation."
      );
      setStarted(false);
      setSessionId(null);
    } finally {
      setLoading(false);
    }
  };

  // --- RÉPONDRE (clavier + micro) ---
  const sendAnswer = async (text: string) => {
    const answer = text.trim();
    if (!answer) return;

    if (!started || !sessionId) {
      console.warn(
        "Réponse ignorée : entretien non démarré ou sessionId manquant."
      );
      return;
    }

    setHistory((prev) => [
      ...prev,
      { role: "candidate", text: answer } as Message,
    ]);
    setInput("");
    setLoading(true);

    try {
      const res = await fetch("/api/interview", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          action: "answer",
          userId: user?.uid,
          sessionId,
          userMessage: answer,
          interviewMode,
          difficulty,
        }),
      });

      const contentType = res.headers.get("content-type") || "";
      if (!contentType.includes("application/json")) {
        const textErr = await res.text();
        console.error("Réponse non JSON de /api/interview (answer):", textErr);
        throw new Error(
          "Réponse serveur invalide (non JSON) pendant l'entretien."
        );
      }

      const data = await res.json();
      if (!res.ok) {
        throw new Error(
          data.error || "Erreur lors de l'envoi de la réponse."
        );
      }

      const payload = (() => {
        if (
          data.nextQuestion ||
          data.next_question ||
          data.final_summary ||
          data.finalSummary
        ) {
          return parseInterviewPayload(data);
        }
        if (data.payload) {
          return parseInterviewPayload(data.payload);
        }
        if (typeof data === "string") {
          return parseInterviewPayload(data);
        }
        return parseInterviewPayload(data);
      })();

      const {
        nextQuestion,
        shortAnalysis,
        finalSummary,
        finalScore,
      } = payload;

      const nextQClean = nextQuestion
        ? personalizeQuestionClient(nextQuestion, user)
        : null;

      setHistory((prev) => {
        const newHistory = [...prev];

        if (shortAnalysis) {
          newHistory.push({
            role: "system",
            text: `💭 Ce que pense le recruteur : ${shortAnalysis}`,
          });
        }

        if (nextQClean && !finalSummary) {
          newHistory.push({
            role: "interviewer",
            text: nextQClean,
          });
        }

        return newHistory;
      });

      if (finalSummary || typeof finalScore === "number") {
        if (finalSummary) setFinalSummary(finalSummary);
        if (typeof finalScore === "number") setFinalScore(finalScore);

        if (typeof finalScore === "number") {
          let decision: string;
          if (finalScore >= 80) {
            decision =
              "Très bon entretien : tu aurais de fortes chances d'être retenu(e) pour le poste. 🎉";
          } else if (finalScore >= 60) {
            decision =
              "Entretien correct : tu pourrais passer à l'étape suivante, mais il y a encore des axes d'amélioration.";
          } else {
            decision =
              "Entretien en dessous des attentes : il faudrait retravailler certains points clés avant de postuler.";
          }
          setFinalDecision(decision);
        }

        setFinished(true);
      }

      if (nextQClean && !finalSummary) {
        setCurrentQuestionIndex((prev) =>
          Math.min(prev + 1, totalQuestions)
        );
        setTypingIndex(0);
        setTyping(true);
        speak(nextQClean);
      }
    } catch (e: any) {
      console.error(e);
      alert(
        e.message || "Erreur lors de l'envoi de ta réponse."
      );
    } finally {
      setLoading(false);
    }
  };

  // --- INIT RECONNAISSANCE VOCALE ---
  useEffect(() => {
    if (typeof window === "undefined") return;

    const w = window as any;
    const SpeechRecognition =
      w.SpeechRecognition || w.webkitSpeechRecognition;

    if (!SpeechRecognition) {
      setRecognitionSupported(false);
      recognitionRef.current = null;
      return;
    }

    setRecognitionSupported(true);

    const recognition = new SpeechRecognition();
    recognition.lang = "fr-FR";
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;

    recognition.onresult = (event: any) => {
      const text = event.results[0][0].transcript;
      if (text) {
        sendAnswer(text);
      }
    };
    recognition.onend = () => {
      setListening(false);
    };
    recognition.onerror = (e: any) => {
      console.error("Speech recognition error:", e);
      setListening(false);
    };

    recognitionRef.current = recognition;

    return () => {
      try {
        recognition.stop();
      } catch {
        // ignore
      }
    };
  }, [started, sessionId]);

  // --- ACTIONS UI ---
  const toggleMic = () => {
    if (!started) {
      alert(
        "Lance d'abord la simulation avant d'utiliser le micro."
      );
      return;
    }

    if (!recognitionRef.current) {
      alert(
        "La reconnaissance vocale n'est pas disponible sur ce navigateur / appareil (par exemple iOS Safari). Tu peux toujours répondre au clavier."
      );
      return;
    }

    if (listening) {
      try {
        recognitionRef.current.stop();
      } catch (e) {
        console.error(e);
      }
    } else {
      setListening(true);
      playMicBeep();
      try {
        recognitionRef.current.start();
      } catch (e) {
        console.error(e);
        setListening(false);
      }
    }
  };

  const stopSession = () => {
    try {
      if (typeof window !== "undefined" && "speechSynthesis" in window) {
        window.speechSynthesis.cancel();
      }
    } catch {
      // ignore
    }
    if (recognitionRef.current && listening) {
      try {
        recognitionRef.current.stop();
      } catch {
        // ignore
      }
    }
    setStarted(false);
    setSessionId(null);
    setHistory([]);
    setListening(false);
    setFinished(false);
    setFinalSummary(null);
    setFinalScore(null);
    setFinalDecision(null);
    setCurrentQuestionIndex(0);
    setTyping(false);
    setTypingIndex(0);
  };

  // Progress / stepper / temps restant
  const progressPercent =
    totalQuestions > 0
      ? Math.min((currentQuestionIndex / totalQuestions) * 100, 100)
      : 0;

  const showConfig = !started || finished;
  const showInterviewPanel = started || finished;

  const stepVisual = !started
    ? 1
    : finished || finalSummary || finalScore !== null
    ? 3
    : 2;

  const questionsLeft = Math.max(
    totalQuestions - currentQuestionIndex,
    0
  );
  const estimatedMinutesLeft = questionsLeft * AVG_MIN_PER_QUESTION;
  const estimatedMinutesRounded =
    questionsLeft > 0
      ? Math.max(1, Math.round(estimatedMinutesLeft))
      : 0;

  return (
    <section className="glass rounded-2xl p-5 space-y-4">
      {/* Titre + intro */}
      <div className="space-y-1">
        <h2 className="text-lg font-semibold">
          Simulateur d&apos;entretien IA (mode vocal)
        </h2>
        <p className="text-[11px] text-[var(--muted)] max-w-2xl">
          L&apos;IA joue le rôle du recruteur : elle te pose des
          questions adaptées au poste et à ton profil à l&apos;oral,
          tu réponds à l&apos;oral ou à l&apos;écrit, et elle lit
          ensuite ses messages à voix haute. Idéal pour t&apos;entraîner
          avec un casque ou des écouteurs.
        </p>
      </div>

      <div className="space-y-4">
        {/* STEPPER 1/2/3 */}
        <div className="flex flex-wrap items-center gap-3 text-xs">
          {[
            { id: 1, label: "Configuration" },
            { id: 2, label: "Entretien" },
            { id: 3, label: "Bilan" },
          ].map((step) => (
            <div key={step.id} className="flex items-center gap-1">
              <div
                className={`h-5 w-5 rounded-full flex items-center justify-center text-[11px] ${
                  stepVisual === step.id
                    ? "bg-emerald-500 text-black"
                    : stepVisual > step.id
                    ? "bg-emerald-900/60 text-emerald-200"
                    : "bg-white/5 text-[var(--muted)]"
                }`}
              >
                {step.id}
              </div>
              <span
                className={
                  stepVisual === step.id
                    ? "text-emerald-300"
                    : "text-[var(--muted)]"
                }
              >
                {step.label}
              </span>
            </div>
          ))}
        </div>

        {/* Bloc configuration avant / après l'entretien */}
        {showConfig && (
          <div className="glass p-4 rounded-2xl border border-white/10 space-y-3">
            <p className="text-sm text-[var(--muted)]">
              Configure ton entretien, choisis le type de simulation et
              le profil du recruteur (voix + apparence), puis lance le
              mode vocal.
            </p>

            <div className="grid gap-3 md:grid-cols-2">
              {/* Colonne gauche : poste & description */}
              <div className="space-y-2">
                <label className="block text-xs font-medium text-[var(--muted)]">
                  Poste visé
                </label>
                <input
                  className="w-full bg-black/20 border border-white/10 rounded-lg p-2 text-sm"
                  placeholder="Ex : Développeur WordPress, Chargé de recrutement..."
                  value={jobTitle}
                  disabled={loading || started}
                  onChange={(e) => setJobTitle(e.target.value)}
                />

                <label className="block text-xs font-medium text-[var(--muted)] mt-2">
                  Descriptif de poste (facultatif)
                </label>
                <textarea
                  className="w-full bg-black/20 border border-white/10 rounded-lg p-2 text-xs min-h-[100px]"
                  placeholder="Colle ici l'annonce ou un extrait (missions, contexte...). Si tu laisses vide, l'IA fera un entretien plus général."
                  value={jobDesc}
                  disabled={loading || started}
                  onChange={(e) => setJobDesc(e.target.value)}
                />
              </div>

              {/* Colonne droite : mode, niveau, profil recruteur */}
              <div className="space-y-2">
                <div>
                  <label className="block text-xs font-medium text-[var(--muted)]">
                    Type d&apos;entretien
                  </label>
                  <select
                    className="w-full bg-black/20 border border-white/10 rounded-lg p-2 text-xs"
                    value={interviewMode}
                    disabled={loading || started}
                    onChange={(e) =>
                      setInterviewMode(
                        e.target.value as InterviewMode
                      )
                    }
                  >
                    <option value="complet">
                      Entretien complet (général + motivation +
                      compétences)
                    </option>
                    <option value="rapide">
                      Flash 10 minutes (questions essentielles)
                    </option>
                    <option value="technique">
                      Focalisé compétences / technique
                    </option>
                    <option value="comportemental">
                      Comportemental (soft skills, situations)
                    </option>
                  </select>
                </div>

                <div>
                  <label className="block text-xs font-medium text-[var(--muted)]">
                    Niveau de difficulté
                  </label>
                  <select
                    className="w-full bg-black/20 border border-white/10 rounded-lg p-2 text-xs"
                    value={difficulty}
                    disabled={loading || started}
                    onChange={(e) =>
                      setDifficulty(
                        e.target.value as Difficulty
                      )
                    }
                  >
                    <option value="facile">
                      Facile / débutant
                    </option>
                    <option value="standard">Standard</option>
                    <option value="difficile">
                      Exigeant (questions poussées)
                    </option>
                  </select>
                </div>

                {/* Profil recruteur (voix + avatar) */}
                <div className="mt-1">
                  <label className="block text-xs font-medium text-[var(--muted)]">
                    Profil du recruteur (voix + apparence)
                  </label>
                  <div className="flex gap-2 mt-1">
                    <button
                      type="button"
                      disabled={loading || started}
                      onClick={() => {
                        setRecruiterGender("m");
                        setVoiceProfile("homme");
                      }}
                      className={`flex-1 text-xs rounded-lg border px-2 py-2 flex items-center justify-center gap-2 ${
                        recruiterGender === "m"
                          ? "border-emerald-400 bg-emerald-500/10"
                          : "border-white/10 bg-black/20"
                      }`}
                    >
                      <span className="text-lg">👨‍💼</span>
                      <span className="text-left">
                        Recruteur homme
                        <br />
                        <span className="text-[10px] text-[var(--muted)]">
                          Voix masculine
                        </span>
                      </span>
                    </button>
                    <button
                      type="button"
                      disabled={loading || started}
                      onClick={() => {
                        setRecruiterGender("f");
                        setVoiceProfile("femme");
                      }}
                      className={`flex-1 text-xs rounded-lg border px-2 py-2 flex items-center justify-center gap-2 ${
                        recruiterGender === "f"
                          ? "border-emerald-400 bg-emerald-500/10"
                          : "border-white/10 bg-black/20"
                      }`}
                    >
                      <span className="text-lg">👩‍💼</span>
                      <span className="text-left">
                        Recruteuse femme
                        <br />
                        <span className="text-[10px] text-[var(--muted)]">
                          Voix féminine
                        </span>
                      </span>
                    </button>
                  </div>
                </div>

                <p className="text-[10px] text-[var(--muted)] mt-1">
                  L&apos;entretien durera environ{" "}
                  <span className="font-semibold">
                    {INTERVIEW_QUESTION_PLAN[interviewMode]} questions
                  </span>
                  .
                </p>

                {!recognitionSupported && (
                  <p className="text-[10px] text-[var(--muted)] mt-1">
                    ⚠️ La reconnaissance vocale n&apos;est pas
                    disponible sur ce navigateur / appareil (par
                    exemple iOS Safari). Tu pourras quand même répondre
                    au clavier et écouter la voix du recruteur si elle
                    est supportée.
                  </p>
                )}

                {!speechSupported && (
                  <p className="text-[10px] text-[var(--muted)] mt-1">
                    ⚠️ La synthèse vocale n&apos;est pas supportée
                    ici. L&apos;IA ne pourra pas lire les questions à
                    voix haute.
                  </p>
                )}
              </div>
            </div>

            <button
              onClick={startInterview}
              disabled={loading || !user}
              className="btn-primary w-full mt-2"
              type="button"
            >
              {loading
                ? "Préparation de la simulation..."
                : "Lancer la simulation vocale 🎙️"}
            </button>

            {!user && (
              <p className="text-[10px] text-[var(--muted)]">
                Tu dois être connecté pour utiliser le simulateur
                d&apos;entretien.
              </p>
            )}
          </div>
        )}

        {/* Bloc entretien en direct */}
        {showInterviewPanel && (
          <div className="glass p-4 rounded-2xl border border-white/10 h-[520px] flex flex-col">
            <div className="flex justify-between items-start mb-4 border-b border-white/5 pb-2 gap-3">
              <div className="flex items-center gap-3">
                <div
                  className={`w-10 h-10 rounded-full bg-gradient-to-br from-emerald-400/70 to-cyan-500/80 flex items-center justify-center shadow-lg ${
                    aiSpeaking ? "animate-pulse" : ""
                  }`}
                >
                  <span className="text-2xl">
                    {recruiterGender === "f" ? "👩‍💼" : "👨‍💼"}
                  </span>
                </div>
                <div className="text-xs text-[var(--muted)]">
                  <p className="font-semibold">
                    {recruiterGender === "f"
                      ? "Recruteuse IA"
                      : "Recruteur IA"}
                  </p>
                  <p className="text-[11px]">
                    {aiSpeaking
                      ? "Te pose une question..."
                      : finished
                      ? "Entretien terminé"
                      : "Attend ta réponse"}
                  </p>
                  {lastInterviewerMessage && (
                    <button
                      type="button"
                      onClick={() =>
                        speak(lastInterviewerMessage)
                      }
                      className="mt-1 inline-flex items-center gap-1 text-[10px] px-2 py-[2px] rounded-full bg-white/5 hover:bg-white/10"
                    >
                      🔊 Réécouter la question
                    </button>
                  )}
                </div>
              </div>

              <div className="flex flex-col items-end gap-1">
                <span className="text-[10px] font-semibold text-emerald-400 uppercase tracking-wider">
                  En direct
                </span>
                <span className="text-[10px] text-[var(--muted)]">
                  {finished
                    ? "Entretien terminé"
                    : `Question ${Math.max(
                        1,
                        currentQuestionIndex
                      )} sur ${totalQuestions}`}
                </span>
                <div className="w-32 h-1.5 bg-white/10 rounded-full overflow-hidden">
                  <div
                    className="h-full bg-emerald-400 transition-all"
                    style={{ width: `${progressPercent}%` }}
                  />
                </div>
                {!finished && questionsLeft > 0 && (
                  <span className="text-[10px] text-[var(--muted)]">
                    Il reste environ{" "}
                    <span className="font-semibold">
                      {questionsLeft} questions
                    </span>{" "}
                    (~{estimatedMinutesRounded} min)
                  </span>
                )}
                {finished && (
                  <span className="text-[10px] text-[var(--muted)]">
                    Entretien terminé • Bilan disponible ci-dessous
                  </span>
                )}
                <button
                  onClick={stopSession}
                  className="text-[11px] text-red-400 hover:underline mt-1"
                  type="button"
                >
                  Arrêter l&apos;entretien
                </button>
              </div>
            </div>

            {/* Zone de chat */}
            <div
              ref={chatRef}
              className="flex-1 overflow-y-auto space-y-4 custom-scrollbar pr-2"
            >
              {history.map((m, i) => {
                const isLastInterviewer =
                  m.role === "interviewer" &&
                  i === lastInterviewerIndex;
                const showText =
                  isLastInterviewer && typing
                    ? m.text.slice(0, typingIndex)
                    : m.text;

                return (
                  <div
                    key={i}
                    className={`flex ${
                      m.role === "candidate"
                        ? "justify-end"
                        : "justify-start"
                    }`}
                  >
                    <div
                      className={`max-w-[85%] p-3 rounded-2xl text-sm ${
                        m.role === "candidate"
                          ? "bg-blue-600/20 text-blue-100 rounded-br-none border border-blue-500/30"
                          : m.role === "interviewer"
                          ? "bg-white/5 text-slate-200 rounded-bl-none border border-white/10"
                          : "bg-white/5 text-[var(--muted)] border border-white/5 text-[11px] italic"
                      }`}
                    >
                      {showText}
                    </div>
                  </div>
                );
              })}

              {loading && (
                <div className="text-xs text-[var(--muted)] flex items-center gap-2">
                  <span className="inline-flex h-2 w-2 rounded-full bg-emerald-400 animate-pulse" />
                  L&apos;IA réfléchit...
                </div>
              )}

              {/* Résultat final */}
              {finished && (finalSummary || finalScore !== null) && (
                <div className="mt-3 rounded-xl border border-emerald-500/40 bg-emerald-500/10 p-3 text-[11px] space-y-2">
                  <p className="text-xs font-semibold text-emerald-300">
                    Bilan de l&apos;entretien
                  </p>
                  {typeof finalScore === "number" && (
                    <p>
                      <span className="font-semibold">
                        Note globale :
                      </span>{" "}
                      {Math.round(finalScore)}/100
                    </p>
                  )}
                  {finalSummary && (
                    <p className="whitespace-pre-line">
                      <span className="font-semibold">
                        Synthèse :
                      </span>{" "}
                      {finalSummary}
                    </p>
                  )}
                  {finalDecision && (
                    <p className="whitespace-pre-line">
                      <span className="font-semibold">
                        Décision probable :
                      </span>{" "}
                      {finalDecision}
                    </p>
                  )}
                  <p className="text-[10px] text-[var(--muted)]">
                    Utilise ce bilan pour identifier les points à
                    améliorer : structure des réponses, exemples
                    concrets, mise en avant de tes résultats, etc.
                  </p>
                </div>
              )}
            </div>

            {/* Zone de réponse */}
            <div className="mt-4 pt-4 border-t border-white/10 flex flex-col gap-2">
              <div className="flex items-center gap-2">
                <button
                  onClick={toggleMic}
                  disabled={!started || loading}
                  type="button"
                  className={`p-3 rounded-full transition-colors flex items-center justify-center ${
                    listening
                      ? "bg-red-500/80 animate-pulse ring-2 ring-red-300/60"
                      : "bg-white/10 hover:bg-white/20"
                  } ${
                    !started || loading
                      ? "opacity-50 cursor-not-allowed"
                      : ""
                  }`}
                >
                  <span>🎤</span>
                  {listening && (
                    <span className="ml-1 text-[10px] uppercase tracking-widest text-red-100">
                      REC
                    </span>
                  )}
                </button>

                {/* Mini visualiseur audio (animation fake) */}
                {listening && (
                  <div className="flex gap-[3px] h-4 items-end">
                    <span className="w-[3px] bg-red-100 rounded-sm animate-[ping_0.7s_ease-in-out_infinite]" />
                    <span className="w-[3px] bg-red-200 rounded-sm animate-[ping_0.8s_ease-in-out_infinite]" />
                    <span className="w-[3px] bg-red-300 rounded-sm animate-[ping_0.6s_ease-in-out_infinite]" />
                    <span className="w-[3px] bg-red-200 rounded-sm animate-[ping_0.9s_ease-in-out_infinite]" />
                  </div>
                )}
              </div>

              <div className="flex gap-2">
                <input
                  className="flex-1 bg-black/20 border border-white/10 rounded-full px-4 text-sm"
                  placeholder={
                    started
                      ? "Parle ou écris ta réponse..."
                      : "Lance la simulation pour commencer l'entretien"
                  }
                  value={input}
                  disabled={!started || loading}
                  onChange={(e) => setInput(e.target.value)}
                  onKeyDown={(e) =>
                    started &&
                    e.key === "Enter" &&
                    sendAnswer(input)
                  }
                />
                <button
                  onClick={() => sendAnswer(input)}
                  disabled={!started || loading}
                  type="button"
                  className="p-2 px-4 bg-white/10 rounded-full text-sm hover:bg-white/20 disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  ➤
                </button>
              </div>
            </div>
          </div>
        )}
      </div>
    </section>
  );
}
````

## File: components/LandingFeatures.tsx
````typescript
"use client";

import { motion } from "framer-motion";

const features = [
  {
    title: "CV IA optimisé",
    desc: "Importe ton CV PDF, laisse Gemini en extraire le profil et génère un CV optimisé."
  },
  {
    title: "Lettres sur-mesure",
    desc: "Colle une offre, obtiens une lettre adaptée à ton profil et à l'entreprise ciblée."
  },
  {
    title: "Suivi simplifié",
    desc: "Garde une trace de toutes tes candidatures avec un tracker clair et visuel."
  }
];

export default function LandingFeatures() {
  return (
    <section className="px-4 sm:px-8 pb-6">
      <div className="max-w-6xl mx-auto grid gap-3 md:grid-cols-3">
        {features.map((f, idx) => (
          <motion.div
            key={f.title}
            initial={{ opacity: 0, y: 8 }}
            whileInView={{ opacity: 1, y: 0 }}
            viewport={{ once: true, amount: 0.4 }}
            transition={{ duration: 0.2, delay: idx * 0.05 }}
            className="glass p-4 text-sm"
          >
            <h3 className="text-sm font-semibold mb-1">{f.title}</h3>
            <p className="text-xs text-[var(--muted)]">{f.desc}</p>
          </motion.div>
        ))}
      </div>
    </section>
  );
}
````

## File: components/LandingHero.tsx
````typescript
"use client";

import { motion } from "framer-motion";
import Link from "next/link";

export default function LandingHero() {
  return (
    <section className="px-4 sm:px-8 pt-8 pb-6">
      <div className="max-w-6xl mx-auto flex flex-col gap-6 md:flex-row md:items-center">
        <motion.div
          initial={{ opacity: 0, y: 12 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.25 }}
          className="flex-1"
        >
          <p className="badge-muted mb-3">
            <span className="w-1 h-1 rounded-full bg-emerald-400" />
            <span>IA appliquée aux candidatures</span>
          </p>
          <h1 className="text-2xl sm:text-3xl md:text-4xl font-semibold leading-tight mb-3">
            Ton bureau de candidature, piloté par l&apos;IA.
          </h1>
          <p className="text-sm sm:text-base text-[var(--muted)] max-w-xl mb-4">
            Importe ton CV, génère des lettres de motivation ciblées, prépare ton pitch oral
            et suis toutes tes candidatures depuis un seul espace, pensé pour les profils tech
            et cybersécurité.
          </p>
          <div className="flex flex-wrap gap-2">
            <Link href="/signup" className="btn-primary text-xs sm:text-sm">
              Essayer gratuitement
            </Link>
            <Link href="/login" className="btn-secondary text-xs sm:text-sm">
              Se connecter
            </Link>
          </div>
        </motion.div>

        <motion.div
          initial={{ opacity: 0, y: 12 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.25, delay: 0.05 }}
          className="flex-1"
        >
          <div className="glass p-4 text-xs text-[var(--muted)]">
            <p className="mb-2 text-[11px] uppercase tracking-[0.18em]">
              Aperçu temps réel
            </p>
            <p>
              Un tableau de bord unique pour ton CV, tes LM, ton pitch et ton suivi de
              candidatures. Design inspiré de ton interface actuelle, en Next.js + Tailwind CSS
              + Framer Motion.
            </p>
          </div>
        </motion.div>
      </div>
    </section>
  );
}
````

## File: components/LandingStack.tsx
````typescript
"use client";

import { motion } from "framer-motion";
import Link from "next/link";

export default function LandingStack() {
  return (
    <section className="px-4 sm:px-8 pb-10">
      <div className="max-w-6xl mx-auto glass p-4 sm:p-5">
        <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-3">
          <div>
            <p className="badge-muted mb-1">
              <span>Stack technique</span>
            </p>
            <h2 className="text-sm sm:text-base font-semibold">
              Une stack moderne pour une expérience fluide
            </h2>
          </div>
          <Link href="/tech" className="text-[11px] text-[var(--brand)] underline">
            Voir les détails techniques
          </Link>
        </div>
        <div className="grid gap-3 sm:grid-cols-3 text-xs sm:text-sm">
          <motion.div
            initial={{ opacity: 0, y: 8 }}
            whileInView={{ opacity: 1, y: 0 }}
            viewport={{ once: true }}
            transition={{ duration: 0.2 }}
          >
            <p className="font-semibold mb-1">Frontend · React / Next.js</p>
            <p className="text-[var(--muted)]">
              Framework JavaScript moderne pour construire une interface rapide,
              SEO-friendly et bien routée.
            </p>
          </motion.div>
          <motion.div
            initial={{ opacity: 0, y: 8 }}
            whileInView={{ opacity: 1, y: 0 }}
            viewport={{ once: true }}
            transition={{ duration: 0.2, delay: 0.05 }}
          >
            <p className="font-semibold mb-1">Styling · Tailwind CSS</p>
            <p className="text-[var(--muted)]">
              Un framework utilitaire qui permet de décliner ton design sombre actuel
              dans une grille cohérente et responsive.
            </p>
          </motion.div>
          <motion.div
            initial={{ opacity: 0, y: 8 }}
            whileInView={{ opacity: 1, y: 0 }}
            viewport={{ once: true }}
            transition={{ duration: 0.2, delay: 0.1 }}
          >
            <p className="font-semibold mb-1">Animations · Framer Motion</p>
            <p className="text-[var(--muted)]">
              Des transitions douces et maîtrisées pour donner vie aux cartes,
              modales et panneaux comme dans ton design original.
            </p>
          </motion.div>
        </div>
      </div>
    </section>
  );
}
````

## File: components/PaymentHeader.jsx
````javascript
"use client";

import { useEffect } from "react";

export default function PaymentHeader({ onClose, autoCloseMs = 0 }) {
  useEffect(() => {
    if (!autoCloseMs) return;
    const t = setTimeout(() => onClose?.(), autoCloseMs);
    return () => clearTimeout(t);
  }, [autoCloseMs, onClose]);

  return (
    <div className="flex items-center justify-between px-4 py-2 border-b border-[var(--border)]/70 bg-[var(--bg-soft)]/80">
      <div className="flex flex-col">
        <span className="text-[12px] font-semibold text-[var(--ink)]">
          Paiement sécurisé
        </span>
        <span className="text-[11px] text-[var(--muted)]">
          Transaction gérée par Polar (Stripe)
        </span>
      </div>

      <button
        type="button"
        onClick={onClose}
        className="text-[11px] rounded-full border border-[var(--border)] px-2 py-1 hover:bg-[var(--bg)]"
        aria-label="Fermer"
      >
        ✕
      </button>
    </div>
  );
}
````

## File: components/PolarCheckoutModal.jsx
````javascript
"use client";

import { useEffect } from "react";
import PaymentHeader from "./PaymentHeader";

export default function PolarCheckoutModal({ open, url, onClose, onDone }) {
  useEffect(() => {
    if (!open) return;

    function handleMessage(e) {
      // On accepte uniquement les messages venant de NOTRE domaine
      if (e.origin !== window.location.origin) return;

      const data = e.data;
      if (!data || typeof data !== "object") return;
      if (data.type !== "POLAR_CHECKOUT_DONE") return;

      onDone?.(data.status);
      onClose?.();
    }

    window.addEventListener("message", handleMessage);
    return () => window.removeEventListener("message", handleMessage);
  }, [open, onClose, onDone]);

  if (!open) return null;

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/40 p-4">
      <div className="w-full max-w-3xl overflow-hidden rounded-2xl bg-white shadow-xl">
        <PaymentHeader onClose={onClose} />

        <div className="h-[80vh] bg-white">
          {url ? (
            <iframe
              title="Polar checkout"
              src={url}
              className="h-full w-full"
              allow="payment *"
            />
          ) : (
            <div className="p-4 text-sm">Chargement…</div>
          )}
        </div>
      </div>
    </div>
  );
}
````

## File: components/SidebarUser.tsx
````typescript
"use client";

import Link from "next/link";
import { usePathname } from "next/navigation";
import { useState } from "react";

type AppLink = {
  href: string;
  label: string;
  icon?: string;
};

// Liens principaux
const MAIN_LINKS: AppLink[] = [
  { href: "/app", label: "Profil CV IA", icon: "📄" },
  { href: "/app/lm", label: "Assistant candidature", icon: "✨" },
  { href: "/app/tracker", label: "Suivi candidatures", icon: "📊" },
  { href: "/app/interview", label: "Préparer entretien", icon: "🎤" },
  { href: "/app/apply", label: "Postuler", icon: "📨" },
  { href: "/app/history", label: "Historique IA", icon: "🕒" },
  { href: "/app/credits", label: "Crédits", icon: "⚡" },
];

const SETTINGS_LINK: AppLink = {
  href: "/app/settings",
  label: "Paramètres",
  icon: "⚙️",
};

export default function SidebarUser() {
  const pathname = usePathname();

  // Desktop collapse
  const [collapsed, setCollapsed] = useState(false);

  // Mobile sidebar
  const [mobileOpen, setMobileOpen] = useState(false);

  const baseItem =
    "flex items-center gap-2 rounded-lg px-2 py-1.5 text-[11px] transition-colors";

  const isLinkActive = (href: string) =>
    pathname === href || pathname.startsWith(href + "/");

  return (
    <>
      {/* === BOUTON HAMBURGER MOBILE === */}
      <button
        className="menu-icon1 md:hidden fixed top-3 left-3 z-50"
        onClick={() => setMobileOpen((o) => !o)}
      >
        <div className="menu-icon1_line-top"></div>
        <div className="menu-icon1_line-middle">
          <div className="menu-icon1_line-middle-inner"></div>
        </div>
        <div className="menu-icon1_line-bottom"></div>
      </button>

      {/* === OVERLAY MOBILE (clic pour fermer) === */}
      {mobileOpen && (
        <div
          className="fixed inset-0 bg-black/40 backdrop-blur-sm z-40 md:hidden"
          onClick={() => setMobileOpen(false)}
        ></div>
      )}

      {/* === SIDEBAR === */}
      <aside
        className={`
          bg-[var(--bg-soft)]
          border-r border-[var(--border)]/80
          h-screen
          flex flex-col
          sticky top-0
          z-50
          transition-all duration-300

          md:w-[210px] md:relative md:translate-x-0
          ${collapsed ? "md:w-[60px]" : "md:w-[210px]"}
          
          /* Mobile offcanvas */
          fixed top-0 left-0 w-[230px]
          md:static
          ${mobileOpen ? "translate-x-0" : "-translate-x-full"}
        `}
      >
        {/* Header Desktop (bouton collapse) */}
        <div className="hidden md:flex items-center justify-start px-2 py-3 border-b border-[var(--border)]/70">
          <button
            type="button"
            onClick={() => setCollapsed((c) => !c)}
            aria-label={collapsed ? "Déplier navigation" : "Replier navigation"}
            className="menu-icon1 inline-flex items-center justify-center w-7 h-7 rounded-lg border border-[var(--border)] bg-[var(--bg)] text-[var(--muted)] hover:text-[var(--ink)] hover:bg-[var(--bg-soft)] text-[11px]"
          >
            {collapsed ? "»" : "«"}
          </button>
        </div>

        {/* Mobile : petit espace en haut */}
        <div className="md:hidden h-[60px]"></div>

        {/* Liens */}
        <nav className="flex-1 px-2 py-3 flex flex-col gap-1 overflow-y-auto">
          {MAIN_LINKS.map((link) => {
            const active = isLinkActive(link.href);
            return (
              <Link
                key={link.href}
                href={link.href}
                onClick={() => setMobileOpen(false)} // fermer sidebar mobile
                className={
                  active
                    ? `${baseItem} bg-[var(--bg)] text-[var(--ink)] border border-[var(--brand)]/60`
                    : `${baseItem} text-[var(--muted)] hover:text-[var(--ink)] hover:bg-[var(--bg)]`
                }
              >
                <span className="w-5 text-center text-[12px]">
                  {link.icon ?? "•"}
                </span>
                {!collapsed && <span>{link.label}</span>}
              </Link>
            );
          })}
        </nav>

        {/* Paramètres */}
        <div className="px-2 py-3 border-t border-[var(--border)]/70">
          <Link
            href={SETTINGS_LINK.href}
            onClick={() => setMobileOpen(false)}
            className={
              isLinkActive(SETTINGS_LINK.href)
                ? `${baseItem} bg-[var(--bg)] text-[var(--ink)] border border-[var(--brand)]/60`
                : `${baseItem} text-[var(--muted)] hover:text-[var(--ink)] hover:bg-[var(--bg)]`
            }
          >
            <span className="w-5 text-center text-[12px]">
              {SETTINGS_LINK.icon}
            </span>
            {!collapsed && <span>{SETTINGS_LINK.label}</span>}
          </Link>
        </div>
      </aside>
    </>
  );
}
````

## File: components/TopbarUser.tsx
````typescript
"use client";

import Link from "next/link";
import { useRouter } from "next/navigation";
import { useAuth } from "@/context/AuthContext";

export default function TopbarUser() {
  const router = useRouter();
  const { user, logout } = useAuth();

  const handleLogout = async () => {
    try {
      await logout(); // ou ton signOut(auth) dans le contexte
      router.push("/login");
    } catch (err) {
      console.error("Erreur déconnexion :", err);
    }
  };

  // On privilégie le displayName (Prénom Nom)
  const displayName =
    user?.displayName ||
    (user?.email ? user.email.split("@")[0] : "Utilisateur");

  return (
    <header className="sticky top-0 z-30 bg-[var(--bg)]/90 backdrop-blur-xl border-b border-[var(--border)]/70">
      <div className="max-w-6xl mx-auto px-4 sm:px-8 h-14 flex items-center justify-between gap-4">
        {/* Logo + mini titre à gauche */}
        <Link href="/app" className="flex items-center gap-2 shrink-0">
          <div className="w-8 h-8 rounded-2xl bg-gradient-to-br from-[var(--brand)] to-[var(--brandDark)] shadow-lg shadow-[var(--brand)]/30 flex items-center justify-center text-[11px] font-semibold">
            AI
          </div>
          <div className="hidden sm:flex flex-col leading-tight">
            <span className="text-[11px] uppercase tracking-[0.22em] text-[var(--muted)]">
              Assistant candidatures
            </span>
            <span className="text-xs font-medium">Espace connecté</span>
          </div>
        </Link>

        {/* À droite : connecté en tant que + bouton déconnexion */}
        <div className="flex items-center gap-3 ml-auto">
          {user && (
            <div className="flex flex-col items-end leading-tight text-[10px] sm:text-[11px]">
              <span className="text-[var(--muted)] hidden sm:inline">
                Connecté·e en tant que
              </span>
              <span className="text-[var(--ink)] font-medium max-w-[160px] truncate">
                {displayName}
              </span>
            </div>
          )}

          <button
            type="button"
            onClick={handleLogout}
            className="inline-flex items-center justify-center text-[11px] sm:text-[12px] px-3 py-1.5 rounded-full border border-[var(--border)] bg-[var(--bg-soft)] hover:bg-[var(--bg)] text-[var(--muted)] hover:text-[var(--ink)] transition-colors"
          >
            Se déconnecter
          </button>
        </div>
      </div>
    </header>
  );
}
````

## File: context/AuthContext.tsx
````typescript
"use client";

import {
  createContext,
  useContext,
  useEffect,
  useState,
  type ReactNode,
} from "react";
import {
  onIdTokenChanged,
  signOut,
  type User,
  getIdTokenResult,
} from "firebase/auth";
import { auth, db } from "@/lib/firebase";
import { doc, getDoc } from "firebase/firestore";

type AuthContextType = {
  user: User | null;
  loading: boolean;
  isAdmin: boolean;
  blocked: boolean;
  logout: () => Promise<void>;
};

const AuthContext = createContext<AuthContextType>({
  user: null,
  loading: true,
  isAdmin: false,
  blocked: false,
  logout: async () => {},
});

export function AuthProvider({ children }: { children: ReactNode }) {
  const [user, setUser] = useState<User | null>(null);
  const [loading, setLoading] = useState(true);
  const [isAdmin, setIsAdmin] = useState(false);
  const [blocked, setBlocked] = useState(false);

  useEffect(() => {
    const unsub = onIdTokenChanged(auth, async (firebaseUser) => {
      setLoading(true);

      // Déconnecté
      if (!firebaseUser) {
        setUser(null);
        setIsAdmin(false);
        // IMPORTANT: on ne force pas blocked=false ici,
        // comme ça si un compte vient d’être rejeté car bloqué,
        // la page /login peut garder le message.
        setLoading(false);
        return;
      }

      // 1) ✅ Vérif Firestore AVANT d’exposer user
      try {
        const ref = doc(db, "users", firebaseUser.uid);
        const snap = await getDoc(ref);
        const data = snap.data() as any | undefined;

        if (data?.blocked) {
          // 🔒 Compte bloqué : on rejette la session AVANT toute redirection / rendu /app
          setBlocked(true);
          setUser(null);
          setIsAdmin(false);
          setLoading(false);

          try {
            await signOut(auth);
          } catch (e) {
            console.error("Erreur signOut (blocked):", e);
          }
          return;
        }

        // Compte OK → on reset blocked
        setBlocked(false);
      } catch (e) {
        // 🔐 Par sécurité + pour éviter le flash,
        // si la vérif Firestore plante, on refuse la session.
        console.error("Erreur vérification blocked:", e);

        setBlocked(true);
        setUser(null);
        setIsAdmin(false);
        setLoading(false);

        try {
          await signOut(auth);
        } catch (err) {
          console.error("Erreur signOut (firestore check failed):", err);
        }
        return;
      }

      // 2) ✅ Admin claims (après validation blocked)
      try {
        const tokenResult = await getIdTokenResult(firebaseUser, true);
        const claims = tokenResult.claims || {};
        const adminFlag =
          claims.isAdmin === true || claims.email === "aakane0105@gmail.com";
        setIsAdmin(adminFlag);
      } catch (e) {
        console.error("Erreur récupération des custom claims:", e);
        setIsAdmin(false);
      }

      // 3) ✅ On expose user seulement maintenant
      setUser(firebaseUser);
      setLoading(false);
    });

    return () => unsub();
  }, []);

  const logout = async () => {
    // logout volontaire => on efface le statut blocked UI
    setBlocked(false);
    await signOut(auth);
  };

  return (
    <AuthContext.Provider value={{ user, loading, isAdmin, blocked, logout }}>
      {children}
    </AuthContext.Provider>
  );
}

export function useAuth() {
  return useContext(AuthContext);
}
````

## File: context/CreditsContext.tsx
````typescript
"use client";

import { createContext, useContext, useEffect, useState } from "react";
import { useAuth } from "@/context/AuthContext";
// TODO: brancher Firestore pour écouter les crédits en temps réel

interface CreditsContextValue {
  credits: number | null;
}

const CreditsContext = createContext<CreditsContextValue>({
  credits: null
});

export function CreditsProvider({ children }: { children: React.ReactNode }) {
  const { user } = useAuth();
  const [credits, setCredits] = useState<number | null>(null);

  useEffect(() => {
    if (!user) {
      setCredits(null);
      return;
    }
    // TODO: écouter doc Firestore "users/{uid}" et lire le champ credits
  }, [user]);

  return (
    <CreditsContext.Provider value={{ credits }}>
      {children}
    </CreditsContext.Provider>
  );
}

export const useCredits = () => useContext(CreditsContext);
````

## File: context/LangContext.tsx
````typescript
"use client";

import { createContext, useContext, useEffect, useState } from "react";

type LangCode =
  | "fr"
  | "en"
  | "es"
  | "de"
  | "pt"
  | "it"
  | "ru"
  | "zh"
  | "ar"
  | "ja";

type LangContextValue = {
  lang: LangCode;
  setLang: (l: LangCode) => void;
};

const LangContext = createContext<LangContextValue | undefined>(undefined);

export function LangProvider({ children }: { children: React.ReactNode }) {
  const [lang, setLangState] = useState<LangCode>("fr");

  useEffect(() => {
    // 1) récupérer la langue du localStorage si dispo
    const stored = typeof window !== "undefined"
      ? (localStorage.getItem("lang") as LangCode | null)
      : null;
    if (stored) {
      setLangState(stored);
      return;
    }

    // 2) sinon essayer de détecter la langue du navigateur
    if (typeof window !== "undefined") {
      const navLang = window.navigator.language.slice(0, 2).toLowerCase();
      const supported: LangCode[] = [
        "fr",
        "en",
        "es",
        "de",
        "pt",
        "it",
        "ru",
        "zh",
        "ar",
        "ja",
      ];
      if (supported.includes(navLang as LangCode)) {
        setLangState(navLang as LangCode);
        localStorage.setItem("lang", navLang);
      }
    }
  }, []);

  const setLang = (l: LangCode) => {
    setLangState(l);
    if (typeof window !== "undefined") {
      localStorage.setItem("lang", l);
    }
  };

  return (
    <LangContext.Provider value={{ lang, setLang }}>
      {children}
    </LangContext.Provider>
  );
}

export function useLang() {
  const ctx = useContext(LangContext);
  if (!ctx) {
    throw new Error("useLang must be used inside LangProvider");
  }
  return ctx;
}
````

## File: functions/index.js
````javascript
const functions = require("firebase-functions");
const admin = require("firebase-admin");
const { PDFDocument, StandardFonts, rgb } = require("pdf-lib");
const JSZip = require("jszip");
const { Polar } = require("@polar-sh/sdk");
const {
  validateEvent,
  WebhookVerificationError,
} = require("@polar-sh/sdk/webhooks");

const {
  RecaptchaEnterpriseServiceClient,
} = require("@google-cloud/recaptcha-enterprise");

// Initialisation Firebase Admin (pour Firestore + auth + callable)
if (!admin.apps.length) {
  admin.initializeApp();
}
const db = admin.firestore();

// =============================
//  reCAPTCHA Enterprise (config + helper)
// =============================

const recaptchaClient = new RecaptchaEnterpriseServiceClient();

function getRecaptchaConfig() {
  const cfg =
    (functions.config &&
      functions.config() &&
      functions.config().recaptcha) ||
    {};
  const projectId = cfg.project_id || process.env.RECAPTCHA_PROJECT_ID || "";
  const siteKey = cfg.site_key || process.env.RECAPTCHA_SITE_KEY || "";
  const thresholdRaw = cfg.threshold || process.env.RECAPTCHA_THRESHOLD || "0.5";
  const threshold = Number(thresholdRaw);

  return {
    projectId,
    siteKey,
    threshold: Number.isFinite(threshold) ? threshold : 0.5,
  };
}

function getClientIp(req) {
  const xf = req.headers["x-forwarded-for"];
  if (typeof xf === "string" && xf.trim()) {
    return xf.split(",")[0].trim();
  }
  const ip =
    req.ip ||
    (req.connection && req.connection.remoteAddress) ||
    (req.socket && req.socket.remoteAddress) ||
    "";
  return typeof ip === "string" ? ip : "";
}

// ✅ MAJ: normalisation action (évite action_mismatch case-sensitive)
function normalizeAction(action) {
  return String(action || "").trim().toLowerCase();
}

/**
 * Vérifie le token reCAPTCHA Enterprise.
 * expectedAction :
 * - si fourni -> vérifie que l'action du token correspond
 * - sinon -> pas de check d'action
 */
async function verifyRecaptchaToken({ token, expectedAction, req }) {
  const { projectId, siteKey, threshold } = getRecaptchaConfig();

  // Si pas configuré, on ne bloque pas (mais on log)
  if (!projectId || !siteKey) {
    console.warn(
      "reCAPTCHA non configuré (recaptcha.project_id / recaptcha.site_key manquants) => vérification bypass."
    );
    return { ok: true, bypass: true, score: null, threshold };
  }

  if (!token) {
    return { ok: false, reason: "missing_token" };
  }

  try {
    const userIp = getClientIp(req);
    const userAgent = String(req.headers["user-agent"] || "");

    const request = {
      parent: `projects/${projectId}`,
      assessment: {
        event: {
          token,
          siteKey,
          expectedAction: expectedAction || undefined,
          userAgent: userAgent || undefined,
          userIpAddress: userIp || undefined,
        },
      },
    };

    const [response] = await recaptchaClient.createAssessment(request);

    const tokenProps = response && response.tokenProperties;
    if (!tokenProps || tokenProps.valid !== true) {
      return {
        ok: false,
        reason: "invalid_token",
        invalidReason: tokenProps ? tokenProps.invalidReason : null,
      };
    }

    // Action check (si fourni)
    if (
      expectedAction &&
      tokenProps.action &&
      String(tokenProps.action) !== String(expectedAction)
    ) {
      return {
        ok: false,
        reason: "action_mismatch",
        got: tokenProps.action,
        expected: expectedAction,
      };
    }

    const score =
      response &&
      response.riskAnalysis &&
      typeof response.riskAnalysis.score === "number"
        ? response.riskAnalysis.score
        : null;

    if (typeof score === "number" && score < threshold) {
      return {
        ok: false,
        reason: "low_score",
        score,
        threshold,
      };
    }

    return { ok: true, score, threshold };
  } catch (err) {
    console.error("Erreur reCAPTCHA Enterprise:", err);
    return { ok: false, reason: "recaptcha_error" };
  }
}

/**
 * Important sécurité :
 * - expectedAction (passée par l'endpoint) a priorité.
 * - sinon on lit req.body.action (utile pour /recaptchaVerify).
 */
async function enforceRecaptchaOrReturn(req, res, expectedAction) {
  const token =
    (req.body && (req.body.recaptchaToken || req.body.token)) ||
    req.headers["x-recaptcha-token"] ||
    req.headers["x-recaptchatoken"] ||
    "";

  const actionFromBody =
    (req.body &&
      (req.body.recaptchaAction ||
        req.body.actionRecaptcha ||
        req.body.action)) ||
    "";

  // ✅ MAJ: normaliser l'action (case-sensitive côté Google)
  const action = normalizeAction(expectedAction || actionFromBody || "");

  const result = await verifyRecaptchaToken({
    token: typeof token === "string" ? token : String(token),
    expectedAction: action,
    req,
  });

  if (!result.ok) {
    return res.status(403).json({
      error: "reCAPTCHA failed",
      details: result,
    });
  }
  return null; // ok
}

// =============================
//  CORS
// =============================

// Exemple env: CORS_ALLOW_ORIGINS="https://assistant-ia-v4.web.app,https://assistant-ia-v4.firebaseapp.com,http://localhost:3000"
function getAllowedOrigins() {
  const raw =
    process.env.CORS_ALLOW_ORIGINS ||
    (functions.config &&
      functions.config() &&
      functions.config().app &&
      functions.config().app.cors_allow_origins) ||
    "";
  return raw
    .split(",")
    .map((s) => s.trim())
    .filter(Boolean);
}

// Pas de credentials côté front -> pas besoin de Allow-Credentials
function setCors(req, res) {
  const origin = req.headers.origin;
  const allowlist = getAllowedOrigins();

  if (origin && allowlist.length > 0) {
    if (allowlist.includes(origin)) {
      res.set("Access-Control-Allow-Origin", origin);
      res.set("Vary", "Origin");
    }
  } else {
    res.set("Access-Control-Allow-Origin", "*");
  }

  res.set("Access-Control-Allow-Methods", "POST, OPTIONS");
  res.set(
    "Access-Control-Allow-Headers",
    "Content-Type, Authorization, Polar-Signature, polar-signature, X-Recaptcha-Token, x-recaptcha-token"
  );
}

/**
 * HTTPS: recaptchaVerify
 * Appelé par le front pour valider (token + action) avant Firebase Auth.
 *
 * Réponses :
 * - 200 { ok: true, score }
 * - 403 { ok: false, reason, score }
 */
exports.recaptchaVerify = functions
  .region("europe-west1")
  .https.onRequest(async (req, res) => {
    setCors(req, res);

    if (req.method === "OPTIONS") {
      return res.status(204).send("");
    }

    if (req.method !== "POST") {
      return res.status(405).json({ ok: false, reason: "method_not_allowed" });
    }

    if (!req.is("application/json")) {
      return res.status(400).json({ ok: false, reason: "bad_content_type" });
    }

    const token = String(req.body?.token || "");
    // ✅ MAJ: normaliser l’action
    const action = normalizeAction(req.body?.action || "");

    if (!token) {
      return res.status(400).json({ ok: false, reason: "missing_token" });
    }
    if (!action) {
      return res.status(400).json({ ok: false, reason: "missing_action" });
    }

    const result = await verifyRecaptchaToken({
      token,
      expectedAction: action,
      req,
    });

    if (!result.ok) {
      return res.status(403).json({
        ok: false,
        reason: result.reason || "recaptcha_failed",
        score: typeof result.score === "number" ? result.score : undefined,
      });
    }

    return res.status(200).json({
      ok: true,
      score: typeof result.score === "number" ? result.score : undefined,
    });
  });

// Petit helper pour normaliser le texte (sans accents, minuscule)
function normalizeString(str) {
  if (!str) return "";
  return str
    .toString()
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .toLowerCase();
}

// Détection simple du type de contrat standard à partir d'une phrase brute
function inferContractTypeStandard(raw) {
  const norm = normalizeString(raw);
  if (!norm) return "";

  if (norm.includes("alternance") || norm.includes("apprentissage")) {
    return "Alternance";
  }
  if (norm.includes("stage") || norm.includes("intern")) {
    return "Stage";
  }
  if (
    norm.includes("freelance") ||
    norm.includes("independant") ||
    norm.includes("indépendant") ||
    norm.includes("auto-entrepreneur")
  ) {
    return "Freelance";
  }
  if (
    norm.includes("cdd") ||
    norm.includes("duree determinee") ||
    norm.includes("durée determinée")
  ) {
    return "CDD";
  }
  if (
    norm.includes("cdi") ||
    norm.includes("duree indeterminee") ||
    norm.includes("durée indeterminée")
  ) {
    return "CDI";
  }
  if (norm.includes("interim") || norm.includes("intérim")) {
    return "Intérim";
  }

  return "";
}

/* ============================
   HELPER ADMIN COMMUN
   ============================ */

function assertIsAdmin(context) {
  if (!context.auth) {
    throw new functions.https.HttpsError(
      "unauthenticated",
      "Tu dois être connecté."
    );
  }

  const token = context.auth.token || {};
  const isAdmin = token.isAdmin === true || token.email === "aakane0105@gmail.com";

  if (!isAdmin) {
    throw new functions.https.HttpsError(
      "permission-denied",
      "Accès réservé à l'administrateur."
    );
  }
}

/* ============================
   FONCTION ADMIN : SET ROLE ADMIN
   ============================ */

exports.setAdminRole = functions
  .region("europe-west1")
  .https.onCall(async (data, context) => {
    assertIsAdmin(context);

    const uid = data && data.uid;
    const isAdmin = data && data.isAdmin;

    if (!uid || typeof isAdmin !== "boolean") {
      throw new functions.https.HttpsError(
        "invalid-argument",
        "uid (string) et isAdmin (boolean) sont requis."
      );
    }

    await admin.auth().setCustomUserClaims(uid, { isAdmin });
    return { success: true, uid, isAdmin };
  });

/* ============================
   FONCTION ADMIN : MAJ CRÉDITS (valeur absolue)
   ============================ */

exports.adminUpdateCredits = functions
  .region("europe-west1")
  .https.onCall(async (data, context) => {
    assertIsAdmin(context);

    const userId = data && data.userId;
    const credits = data && data.credits;

    if (!userId || typeof credits !== "number") {
      throw new functions.https.HttpsError(
        "invalid-argument",
        "userId (string) et credits (number) sont requis."
      );
    }

    const userRef = db.collection("users").doc(userId);

    await userRef.set(
      {
        credits,
        updatedAt: admin.firestore.FieldValue.serverTimestamp(),
      },
      { merge: true }
    );

    return { success: true, userId, credits };
  });

/* ============================
   HTTPS FUNCTION CV (analyse CV PDF -> profil structuré)
   ============================ */

exports.extractProfile = functions
  .region("europe-west1")
  .https.onRequest(async (req, res) => {
    setCors(req, res);

    if (req.method === "OPTIONS") {
      return res.status(204).send("");
    }

    if (req.method !== "POST") {
      return res.status(405).json({ error: "Méthode non autorisée" });
    }

    if (!req.is("application/json")) {
      return res
        .status(400)
        .json({ error: "Content-Type invalide. Envoie du JSON." });
    }

    // ✅ reCAPTCHA
    const deny = await enforceRecaptchaOrReturn(req, res, "extract_profile");
    if (deny) return;

    try {
      const body = req.body || {};
      const base64Pdf = body.base64Pdf;

      if (!base64Pdf) {
        return res.status(400).json({
          error: "Champ 'base64Pdf' manquant dans le corps JSON.",
        });
      }

      // 🔑 Clé Gemini
      const GEMINI_API_KEY =
        process.env.GEMINI_API_KEY ||
        (functions.config().gemini && functions.config().gemini.key);

      if (!GEMINI_API_KEY) {
        console.error("GEMINI_API_KEY manquante");
        return res.status(500).json({
          error:
            "Clé Gemini manquante côté serveur. Configure GEMINI_API_KEY ou functions.config().gemini.key.",
        });
      }

      // Analyse via Gemini
      const profile = await callGeminiWithCv(base64Pdf, GEMINI_API_KEY);

      return res.status(200).json(profile);
    } catch (err) {
      console.error("Erreur analyse CV :", err);
      const msg = String(err && err.message ? err.message : "");
      const errorMessage = msg.startsWith("Erreur Gemini:")
        ? msg
        : "Erreur pendant l'analyse du CV.";
      return res.status(500).json({ error: errorMessage });
    }
  });

// =====================
//   APPEL GEMINI (CV)
// =====================

async function callGeminiWithCv(base64Pdf, apiKey) {
  const endpoint =
    "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent";

  const body = {
    contents: [
      {
        role: "user",
        parts: [
          {
            inline_data: {
              mime_type: "application/pdf",
              data: base64Pdf,
            },
          },
          {
            text: `Lis ce CV et renvoie STRICTEMENT un JSON valide avec exactement ce schéma :

{
  "fullName": string,
  "email": string,
  "phone": string,
  "linkedin": string,
  "profileSummary": string,

  "city": string,
  "address": string,

  "contractType": string,
  "contractTypeStandard": string,
  "contractTypeFull": string,
  "primaryDomain": string,
  "secondaryDomains": string[],
  "skills": {
    "sections": [
      {
        "title": string,
        "items": string[]
      }
    ],
    "tools": string[]
  },
  "softSkills": string[],
  "experiences": [
    {
      "company": string,
      "role": string,
      "dates": string,
      "bullets": string[]
    }
  ],
  "education": [
    {
      "school": string,
      "degree": string,
      "dates": string
    }
  ],
  "educationShort": string[],
  "certs": string,
  "langLine": string,
  "hobbies": string[],

  "drivingLicense": string,
  "vehicle": string
}

RÈGLES IMPORTANTES :

1) Type de contrat (contractType, contractTypeStandard, contractTypeFull)
- "contractTypeFull" : recopie la phrase du CV la plus explicite.
- "contractType" : version simplifiée si tu veux (sans perdre le sens).
- "contractTypeStandard" : DOIT être parmi :
   "CDI", "CDD", "Alternance", "Stage", "Freelance", "Intérim", "".

2) Domaines / métiers principaux (primaryDomain, secondaryDomains)
- "primaryDomain" DOIT être parmi :
  "finance", "it_dev", "cyber", "data", "marketing", "sales",
  "hr", "project", "ops", "health", "education", "autre".
- "secondaryDomains" : 0 à 3 de ces mêmes valeurs.

3) Compétences en sections (skills.sections)
- Si le CV a déjà des rubriques de compétences, reprends-les.
- Sinon, crée 2–4 sections logiques.
- "items" : petites étiquettes (2–5 mots max).

4) Outils (skills.tools)
- 3 à 10 logiciels / outils réellement présents dans le CV.

5) Soft skills (softSkills)
- 3 à 10 soft skills extraites du CV (sections + texte).

6) Résumé du profil (profileSummary)
- 1 à 2 phrases max, cohérent avec le CV et le contrat recherché.

7) Langues (langLine)
- Une seule ligne compacte, ex :
  "Français (natif) · Anglais (B2 – TOEIC)".

8) Formation, expériences, hobbies, mobilité :
- Ne pas inventer, ne mettre que ce qui est présent.

GÉNÉRAL :
- Si une info est absente -> chaîne vide "" ou tableau [].
- RENVOIE UNIQUEMENT ce JSON, sans texte autour.
`.trim(),
          },
        ],
      },
    ],
    generationConfig: {
      response_mime_type: "application/json",
    },
  };

  const resp = await fetch(endpoint, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "x-goog-api-key": apiKey,
    },
    body: JSON.stringify(body),
  });

  if (!resp.ok) {
    const errorText = await resp.text();
    throw new Error("Erreur Gemini: " + errorText);
  }

  const data = await resp.json();

  // 🔎 Parsing robuste
  let parsed = null;

  if (
    data &&
    data.candidates &&
    data.candidates[0]?.content?.parts?.[0]?.text
  ) {
    const text = data.candidates[0].content.parts[0].text;
    try {
      const cleanedText = text.replace(/```json|```/gi, "").trim();
      parsed = JSON.parse(cleanedText);
    } catch (e) {
      console.error("JSON Gemini invalide dans le champ text:", text);
      throw new Error("JSON Gemini invalide (Parsing text) : " + text);
    }
  } else {
    parsed = data;
  }

  // ==============================
  //  POST-TRAITEMENT
  // ==============================

  // 1) Récupération des champs bruts
  let sectionsRaw = Array.isArray(parsed?.skills?.sections)
    ? parsed.skills.sections
    : [];
  let tools = Array.isArray(parsed?.skills?.tools) ? parsed.skills.tools : [];
  let softSkillsArr = Array.isArray(parsed?.softSkills) ? parsed.softSkills : [];

  // 2) Nettoyage / dédup soft skills
  const softSeen = new Set();
  softSkillsArr = softSkillsArr
    .filter((s) => typeof s === "string")
    .map((s) => s.trim())
    .filter((s) => {
      const key = s.toLowerCase();
      if (!s || softSeen.has(key)) return false;
      softSeen.add(key);
      return true;
    });

  // 3) Injection des soft skills dans "Soft skills"
  if (softSkillsArr.length > 0) {
    let idx = sectionsRaw.findIndex(
      (sec) =>
        sec &&
        typeof sec.title === "string" &&
        /soft|transversal|comportement|relationnel/i.test(sec.title)
    );

    if (idx === -1) {
      sectionsRaw.push({
        title: "Soft skills",
        items: softSkillsArr,
      });
    } else {
      const items = Array.isArray(sectionsRaw[idx].items)
        ? sectionsRaw[idx].items
        : [];
      const seenLocal = new Set(
        items
          .filter((x) => typeof x === "string")
          .map((x) => x.toLowerCase().trim())
      );
      const merged = [
        ...items,
        ...softSkillsArr.filter(
          (s) => !seenLocal.has(s.toLowerCase().trim())
        ),
      ];
      sectionsRaw[idx].items = merged;
    }
  }

  // 4) nettoyer / dédupliquer les items dans chaque section
  let sections = sectionsRaw
    .map((sec) => {
      const seen = new Set();
      const items = Array.isArray(sec.items) ? sec.items : [];
      const cleanItems = [];
      for (const raw of items) {
        if (typeof raw !== "string") continue;
        const trimmed = raw.trim();
        const key = trimmed.toLowerCase();
        if (!trimmed || seen.has(key)) continue;
        seen.add(key);
        cleanItems.push(trimmed);
      }
      return {
        title: typeof sec.title === "string" ? sec.title.trim() : "",
        items: cleanItems,
      };
    })
    .filter((sec) => sec.title || sec.items.length);

  // 5) nettoyer / dédupliquer tools
  const cleanTools = [];
  const seenTools = new Set();
  for (const raw of tools) {
    if (typeof raw !== "string") continue;
    const trimmed = raw.trim();
    const key = trimmed.toLowerCase();
    if (!trimmed || seenTools.has(key)) continue;
    seenTools.add(key);
    cleanTools.push(trimmed);
  }
  tools = cleanTools;

  // 6) dédupliquer entre sections.items et tools
  const sectionItemSet = new Set();
  sections.forEach((sec) => {
    sec.items.forEach((it) => {
      if (typeof it === "string") {
        sectionItemSet.add(it.toLowerCase());
      }
    });
  });

  tools = tools.filter((t) => !sectionItemSet.has(t.toLowerCase()));

  // 7) standardisation du contrat
  const contractTypeFull = parsed?.contractTypeFull || parsed?.contractType || "";

  let contractTypeStandard = parsed?.contractTypeStandard || "";
  if (!contractTypeStandard) {
    contractTypeStandard = inferContractTypeStandard(contractTypeFull);
  }

  const contractTypeFinal = contractTypeStandard || contractTypeFull || "";

  // 8) domaines
  const primaryDomain = parsed?.primaryDomain || "";
  const secondaryDomains = Array.isArray(parsed?.secondaryDomains)
    ? parsed.secondaryDomains
    : [];

  const profile = {
    fullName: parsed?.fullName || "",
    email: parsed?.email || "",
    phone: parsed?.phone || "",
    linkedin: parsed?.linkedin || "",
    profileSummary: parsed?.profileSummary || "",

    city: parsed?.city || "",
    address: parsed?.address || "",

    contractType: contractTypeFinal,
    contractTypeStandard,
    contractTypeFull,

    primaryDomain,
    secondaryDomains,

    softSkills: softSkillsArr,
    drivingLicense: parsed?.drivingLicense || "",
    vehicle: parsed?.vehicle || "",

    skills: {
      sections,
      tools,
    },

    experiences: Array.isArray(parsed?.experiences) ? parsed.experiences : [],
    education: Array.isArray(parsed?.education) ? parsed.education : [],
    educationShort: Array.isArray(parsed?.educationShort)
      ? parsed.educationShort
      : [],
    certs: parsed?.certs || "",
    langLine: parsed?.langLine || "",
    hobbies: Array.isArray(parsed?.hobbies) ? parsed.hobbies : [],
  };

  return profile;
}

// =====================
//   APPEL GEMINI TEXTE
// =====================

async function callGeminiText(prompt, apiKey, temperature = 0.7, maxOutputTokens = 2400) {
  const endpoint =
    "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent";

  const body = {
    contents: [
      {
        role: "user",
        parts: [{ text: prompt }],
      },
    ],
    generationConfig: {
      temperature,
      maxOutputTokens,
    },
  };

  const resp = await fetch(endpoint, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "x-goog-api-key": apiKey,
    },
    body: JSON.stringify(body),
  });

  if (!resp.ok) {
    const errorText = await resp.text();
    throw new Error("Erreur Gemini (texte): " + errorText);
  }

  const data = await resp.json();
  const parts = data?.candidates?.[0]?.content?.parts || [];
  const text = parts
    .map((p) => (typeof p.text === "string" ? p.text : ""))
    .join("\n")
    .trim();

  if (!text) {
    throw new Error("Réponse Gemini (texte) vide");
  }

  return text;
}

/* ============================
   SIMULATION D'ENTRETIEN IA (interview)
   ============================ */

// Plan du nombre de questions par mode
const INTERVIEW_QUESTION_PLAN = {
  complet: 8,
  rapide: 4,
  technique: 6,
  comportemental: 6,
};

// Id simple pour les sessions en mémoire (par instance de fonction)
function createInterviewSessionId() {
  return Math.random().toString(36).slice(2) + "-" + Date.now().toString(36);
}

// ⚠️ En mémoire par instance de Cloud Function
const interviewSessions = new Map();

/**
 * Essaie d'extraire un objet JSON depuis un texte brut renvoyé par l'IA.
 */
function extractInterviewJson(raw) {
  if (!raw || typeof raw !== "string") return null;
  let t = raw.trim();

  if (t.startsWith("```")) {
    t = t.replace(/^```[a-zA-Z]*\s*/, "").replace(/```$/, "").trim();
  }

  try {
    return JSON.parse(t);
  } catch (e) {
    const match = t.match(/\{[\s\S]*\}/);
    if (match) {
      try {
        return JSON.parse(match[0]);
      } catch {
        return null;
      }
    }
  }
  return null;
}

/**
 * Construit le prompt d'entretien pour Gemini (JSON attendu en sortie).
 */
function buildInterviewPrompt(session, lastUserAnswer) {
  const total = session.totalQuestions || 8;
  const step = session.currentStep || 1;

  const modeLabelMap = {
    complet: "entretien complet (général + motivation + compétences)",
    rapide: "entretien flash (questions essentielles)",
    technique: "entretien focalisé sur les compétences techniques",
    comportemental: "entretien focalisé sur les soft skills / situations",
  };

  const modeLabel = modeLabelMap[session.interviewMode] || "entretien général";

  const historyLines = (session.history || [])
    .map((h) => {
      const who = h.role === "candidate" ? "Candidat" : "Recruteur";
      return `- ${who} : ${h.text}`;
    })
    .join("\n");

  const base = `Tu es un recruteur humain expérimenté qui mène un entretien d'embauche en FRANÇAIS pour le poste suivant :

Intitulé du poste : ${session.jobTitle || "(non précisé)"}
Contexte / description du poste : ${session.jobDesc || "(non précisé)"}

Mode d'entretien : ${modeLabel}.
Niveau de difficulté : ${session.difficulty || "standard"}.

Tu mènes un entretien structuré avec environ ${total} questions maximum.`;

  const histBlock = historyLines
    ? `Historique de l'entretien (questions / réponses) :
${historyLines}`
    : `L'entretien commence, tu vas poser la première question.`;

  const stepInfo = `Nous en sommes à l'étape ${step} sur ${total}.
${lastUserAnswer ? `Dernière réponse du candidat : "${lastUserAnswer}".` : ""}

SI nous ne sommes PAS à la dernière étape (étape < ${total}) :

1) Analyse très brièvement la la réponse précédente du candidat (ou son profil au démarrage).
2) Propose la prochaine question d'entretien adaptée au poste.

SI nous SOMMES à la dernière étape (étape >= ${total}) :

1) Fais un bilan synthétique de l'entretien et du candidat (points forts / axes d'amélioration).
2) Propose éventuellement une courte phrase de clôture d'entretien.
3) Donne un score global de l'entretien sur 100 (final_score).

Ta RÉPONSE DOIT être STRICTEMENT un objet JSON VALIDE, sans aucun texte autour, EXACTEMENT de la forme :

{
  "next_question": "string ou null si l'entretien est terminé",
  "short_analysis": "string (analyse courte de la réponse ou du profil)",
  "final_summary": "string ou null si l'entretien continue",
  "final_score": nombre ou null
}

⚠️ Ne renvoie JAMAIS de markdown, JAMAIS de commentaires hors du JSON.`;

  return `${base}

${histBlock}

${stepInfo}`;
}

/**
 * HTTPS: interview (simulation IA temps réel)
 */
exports.interview = functions
  .region("europe-west1")
  .https.onRequest(async (req, res) => {
    setCors(req, res);

    if (req.method === "OPTIONS") {
      return res.status(204).send("");
    }

    if (req.method !== "POST") {
      return res.status(405).json({ error: "Méthode non autorisée" });
    }

    if (!req.is("application/json")) {
      return res.status(400).json({ error: "Content-Type invalide. Envoie du JSON." });
    }

    // ✅ reCAPTCHA
    const deny = await enforceRecaptchaOrReturn(req, res, "interview");
    if (deny) return;

    try {
      const body = req.body || {};
      const action = body.action;

      if (!action) {
        return res.status(400).json({
          error: "Champ 'action' manquant ('start' ou 'answer').",
        });
      }

      // ========== DÉMARRAGE ==========
      if (action === "start") {
        const userId = body.userId || "";
        const jobTitle = body.jobTitle || "";
        const jobDesc = body.jobDesc || "";
        const interviewMode = body.interviewMode || "complet";
        const difficulty = body.difficulty || "standard";

        if (!userId) {
          return res.status(400).json({ error: "Champ 'userId' manquant." });
        }

        const totalQuestions =
          INTERVIEW_QUESTION_PLAN[interviewMode] || INTERVIEW_QUESTION_PLAN.complet;

        const sessionId = createInterviewSessionId();
        const nowIso = new Date().toISOString();

        const session = {
          sessionId,
          userId,
          jobTitle,
          jobDesc,
          interviewMode,
          difficulty,
          totalQuestions,
          currentStep: 1,
          history: [],
          createdAt: nowIso,
          updatedAt: nowIso,
          finished: false,
        };

        interviewSessions.set(sessionId, session);

        let nextQuestion = null;
        let shortAnalysis = "";
        let finalSummary = null;
        let finalScore = null;

        try {
          const GEMINI_API_KEY =
            process.env.GEMINI_API_KEY ||
            (functions.config().gemini && functions.config().gemini.key);

          if (!GEMINI_API_KEY) {
            throw new Error("GEMINI_API_KEY manquante");
          }

          const prompt = buildInterviewPrompt(session, null);
          const raw = await callGeminiText(prompt, GEMINI_API_KEY, 0.6, 1200);

          const parsed = extractInterviewJson(raw) || {};
          if (parsed && typeof parsed === "object") {
            if (typeof parsed.next_question === "string" && parsed.next_question.trim()) {
              nextQuestion = parsed.next_question.trim();
            }
            if (typeof parsed.short_analysis === "string") {
              shortAnalysis = parsed.short_analysis.trim();
            }
            if (typeof parsed.final_summary === "string" && parsed.final_summary.trim()) {
              finalSummary = parsed.final_summary.trim();
            }
            if (typeof parsed.final_score === "number" || typeof parsed.final_score === "string") {
              const num = Number(parsed.final_score);
              if (!Number.isNaN(num)) finalScore = num;
            }
          }
        } catch (err) {
          console.error("Erreur Gemini (interview/start):", err);
        }

        if (!nextQuestion) {
          nextQuestion = jobTitle
            ? `Bonjour ! Pour commencer, pouvez-vous vous présenter et m'expliquer pourquoi vous ciblez le poste de ${jobTitle} ?`
            : "Bonjour ! Pour commencer, pouvez-vous vous présenter en quelques phrases ?";
          if (!shortAnalysis) {
            shortAnalysis = "Mode dégradé sans analyse IA détaillée (erreur ou quota Gemini).";
          }
        }

        session.history.push({
          role: "interviewer",
          text: nextQuestion,
          createdAt: nowIso,
        });

        if (finalSummary) {
          session.finished = true;
        }

        session.updatedAt = new Date().toISOString();
        interviewSessions.set(sessionId, session);

        return res.status(200).json({
          sessionId,
          step: session.currentStep,
          totalQuestions: session.totalQuestions,
          next_question: nextQuestion,
          short_analysis: shortAnalysis,
          final_summary: finalSummary,
          final_score: finalScore,
        });
      }

      // ========== RÉPONSE ==========
      if (action === "answer") {
        const userId = body.userId || "";
        const sessionId = body.sessionId || "";
        const userMessage = (body.userMessage || "").toString().trim();

        if (!userId || !sessionId || !userMessage) {
          return res.status(400).json({
            error: "Champs 'userId', 'sessionId' ou 'userMessage' manquants.",
          });
        }

        const session = interviewSessions.get(sessionId);
        if (!session) {
          return res.status(404).json({
            error: "Session d'entretien introuvable ou expirée (instance de fonction différente).",
          });
        }

        if (session.userId && session.userId !== userId) {
          return res.status(403).json({
            error: "Cette session ne correspond pas à cet utilisateur.",
          });
        }

        session.history.push({
          role: "candidate",
          text: userMessage,
          createdAt: new Date().toISOString(),
        });

        const nextStep = Math.min(
          (session.currentStep || 1) + 1,
          session.totalQuestions || INTERVIEW_QUESTION_PLAN.complet
        );
        session.currentStep = nextStep;

        let nextQuestion = null;
        let shortAnalysis = "";
        let finalSummary = null;
        let finalScore = null;

        try {
          const GEMINI_API_KEY =
            process.env.GEMINI_API_KEY ||
            (functions.config().gemini && functions.config().gemini.key);

          if (!GEMINI_API_KEY) {
            throw new Error("GEMINI_API_KEY manquante");
          }

          const prompt = buildInterviewPrompt(session, userMessage);
          const raw = await callGeminiText(prompt, GEMINI_API_KEY, 0.6, 1200);
          const parsed = extractInterviewJson(raw) || {};
          if (parsed && typeof parsed === "object") {
            if (typeof parsed.next_question === "string" && parsed.next_question.trim()) {
              nextQuestion = parsed.next_question.trim();
            }
            if (typeof parsed.short_analysis === "string") {
              shortAnalysis = parsed.short_analysis.trim();
            }
            if (typeof parsed.final_summary === "string" && parsed.final_summary.trim()) {
              finalSummary = parsed.final_summary.trim();
            }
            if (typeof parsed.final_score === "number" || typeof parsed.final_score === "string") {
              const num = Number(parsed.final_score);
              if (!Number.isNaN(num)) finalScore = num;
            }
          }
        } catch (err) {
          console.error("Erreur Gemini (interview/answer):", err);
        }

        const isLastStep =
          session.currentStep >= (session.totalQuestions || INTERVIEW_QUESTION_PLAN.complet);

        if (!nextQuestion && !finalSummary) {
          if (isLastStep) {
            nextQuestion = "Merci pour tes réponses, l'entretien est terminé.";
            finalSummary =
              "Mode dégradé : le bilan détaillé n'a pas pu être généré car l'API IA n'était pas disponible.";
          } else {
            nextQuestion =
              "Merci pour ta réponse. Peux-tu me donner un exemple encore plus concret en lien avec ce poste ?";
            shortAnalysis =
              shortAnalysis || "Mode dégradé sans analyse IA détaillée (erreur ou quota Gemini).";
          }
        }

        if (nextQuestion) {
          session.history.push({
            role: "interviewer",
            text: nextQuestion,
            createdAt: new Date().toISOString(),
          });
        }

        if (finalSummary || isLastStep) {
          session.finished = true;
        }

        session.updatedAt = new Date().toISOString();
        interviewSessions.set(sessionId, session);

        return res.status(200).json({
          sessionId,
          step: session.currentStep,
          totalQuestions: session.totalQuestions,
          next_question: nextQuestion,
          short_analysis: shortAnalysis,
          final_summary: finalSummary,
          final_score: finalScore,
        });
      }

      return res.status(400).json({
        error: "Action invalide. Utilise 'start' ou 'answer'.",
      });
    } catch (err) {
      console.error("Erreur interne /interview:", err);
      return res.status(500).json({
        error: "Erreur interne lors de la simulation d'entretien.",
      });
    }
  });

// Construit un contexte texte compact à partir du profil CV
function buildProfileContextForIA(profile) {
  const p = profile || {};

  let skillsArr;
  if (Array.isArray(p.skills)) {
    skillsArr = p.skills;
  } else if (p.skills && typeof p.skills === "object") {
    skillsArr = [];
    if (Array.isArray(p.skills.sections)) {
      p.skills.sections.forEach((sec) => {
        if (Array.isArray(sec.items)) {
          skillsArr = skillsArr.concat(sec.items);
        }
      });
    }
    if (Array.isArray(p.skills.tools)) {
      skillsArr = skillsArr.concat(p.skills.tools);
    }
  } else {
    skillsArr = [];
  }
  const skillsStr = (skillsArr || []).join(", ");

  const expStr = Array.isArray(p.experiences)
    ? p.experiences
        .map(
          (e) =>
            `${e.role || e.title || ""} chez ${e.company || ""} (${e.dates || ""}): ${(
              e.bullets || []
            ).join(" ")}`
        )
        .join("; \n")
    : "";

  const eduStr = Array.isArray(p.education)
    ? p.education
        .map(
          (e) =>
            `${e.degree || e.title || ""} - ${e.school || e.institution || ""} (${e.dates || ""})`
        )
        .join("; \n")
    : "";

  return `Nom: ${p.fullName || p.name || ""}
Titre: ${p.profileHeadline || p.title || ""}
Contact: ${p.email || ""} | ${p.phone || ""} | ${p.linkedin || ""} | ${p.city || ""}
Résumé de profil: ${p.profileSummary || p.summary || ""}
Compétences: ${skillsStr}
Expériences: 
${expStr}
Formations: 
${eduStr}
Certifications: ${p.certs || ""}
Langues: ${p.langLine || p.lang || ""}`.trim();
}

// =============================
//  HELPER: création PDF simple pour CV
// =============================

async function createSimpleCvPdf(profile, options) {
  const {
    targetJob = "",
    lang = "fr",
    contract = "",
    jobLink = "",
    jobDescription = "",
  } = options || {};

  const p = profile || {};
  const pdfDoc = await PDFDocument.create();
  const page = pdfDoc.addPage([595.28, 841.89]); // A4
  const font = await pdfDoc.embedFont(StandardFonts.Helvetica);
  const fontBold = await pdfDoc.embedFont(StandardFonts.HelveticaBold);

  const { width, height } = page.getSize();
  const marginX = 50;
  let y = height - 60;

  function drawLine(text, size = 11, bold = false) {
    if (!text || y < 50) return;
    const f = bold ? fontBold : font;
    page.drawText(text, {
      x: marginX,
      y,
      size,
      font: f,
      color: rgb(0.1, 0.12, 0.16),
    });
    y -= size + 4;
  }

  function drawParagraph(text, size = 10) {
    if (!text) return;
    const f = font;
    const maxWidth = width - marginX * 2;
    const paragraphs = text.split(/\n{2,}/);

    for (const paragraph of paragraphs) {
      const words = paragraph.split(/\s+/);
      let line = "";

      for (const w of words) {
        const testLine = line ? line + " " + w : w;
        const testWidth = f.widthOfTextAtSize(testLine, size);
        if (testWidth > maxWidth) {
          if (y < 50) return;
          page.drawText(line, {
            x: marginX,
            y,
            size,
            font: f,
            color: rgb(0.1, 0.12, 0.16),
          });
          y -= size + 3;
          line = w;
        } else {
          line = testLine;
        }
      }

      if (line && y >= 50) {
        page.drawText(line, {
          x: marginX,
          y,
          size,
          font: f,
          color: rgb(0.1, 0.12, 0.16),
        });
        y -= size + 6;
      }

      y -= 2;
    }
  }

  function drawSectionTitle(title) {
    if (!title || y < 60) return;
    page.drawText(title, {
      x: marginX,
      y,
      size: 11,
      font: fontBold,
      color: rgb(0.08, 0.15, 0.45),
    });
    y -= 14;
  }

  function drawBullet(text, size = 9) {
    if (!text || y < 50) return;
    const f = font;
    const bulletX = marginX + 8;
    const maxWidth = width - marginX * 2 - 10;
    const words = text.split(/\s+/);
    let line = "";
    let firstLine = true;

    for (const w of words) {
      const testLine = line ? line + " " + w : w;
      const testWidth = f.widthOfTextAtSize(testLine, size);
      if (testWidth > maxWidth) {
        if (y < 50) return;
        page.drawText(firstLine ? "• " + line : "  " + line, {
          x: bulletX,
          y,
          size,
          font: f,
          color: rgb(0.1, 0.12, 0.16),
        });
        y -= size + 3;
        line = w;
        firstLine = false;
      } else {
        line = testLine;
      }
    }

    if (line && y >= 50) {
      page.drawText(firstLine ? "• " + line : "  " + line, {
        x: bulletX,
        y,
        size,
        font: f,
        color: rgb(0.1, 0.12, 0.16),
      });
      y -= size + 3;
    }
  }

  // En-tête
  drawLine(p.fullName || "", 16, true);
  const jobLine =
    targetJob ||
    contract ||
    p.contractType ||
    (lang === "en" ? "Target position" : "Poste recherché");
  drawLine(jobLine, 11, false);

  const contactParts = [p.email || "", p.phone || "", p.city || "", p.linkedin || ""].filter(Boolean);
  if (contactParts.length) {
    drawLine(contactParts.join(" · "), 9, false);
  }

  if (jobLink) {
    drawLine((lang === "en" ? "Job link: " : "Lien de l'offre : ") + jobLink, 8, false);
  }

  y -= 6;

  // Résumé
  if (p.profileSummary) {
    drawSectionTitle(lang === "en" ? "Profile" : "Profil");
    drawParagraph(p.profileSummary, 9.5);
    y -= 4;
  }

  // Compétences
  if (p.skills && Array.isArray(p.skills.sections) && p.skills.sections.length) {
    drawSectionTitle(lang === "en" ? "Key skills" : "Compétences clés");
    p.skills.sections.forEach((sec) => {
      if (!sec || (!sec.title && !Array.isArray(sec.items))) return;
      if (sec.title) drawLine(sec.title, 9.5, true);
      if (Array.isArray(sec.items)) drawParagraph(sec.items.join(" · "), 9);
      y -= 2;
    });
  }

  // Expériences
  if (Array.isArray(p.experiences) && p.experiences.length) {
    drawSectionTitle(lang === "en" ? "Experience" : "Expériences professionnelles");
    p.experiences.forEach((exp) => {
      if (y < 90) return;
      const header = [exp.role, exp.company].filter(Boolean).join(" — ");
      if (header) drawLine(header, 10, true);
      if (exp.dates) drawLine(exp.dates, 8.5, false);
      if (Array.isArray(exp.bullets)) exp.bullets.slice(0, 4).forEach((b) => drawBullet(b, 8.5));
      y -= 4;
    });
  }

  // Formation
  if (Array.isArray(p.education) && p.education.length && y > 80) {
    drawSectionTitle(lang === "en" ? "Education" : "Formation");
    p.education.forEach((ed) => {
      if (y < 60) return;
      const header = [ed.degree, ed.school].filter(Boolean).join(" — ");
      if (header) drawLine(header, 9.5, true);
      if (ed.dates) drawLine(ed.dates, 8.5, false);
      y -= 4;
    });
  }

  // Divers
  if (p.langLine && y > 60) {
    drawSectionTitle(lang === "en" ? "Languages" : "Langues");
    drawParagraph(p.langLine, 9);
  }

  if (Array.isArray(p.hobbies) && p.hobbies.length && y > 60) {
    drawSectionTitle(lang === "en" ? "Interests" : "Centres d'intérêt");
    drawParagraph(p.hobbies.join(" · "), 9);
  }

  const pdfBytes = await pdfDoc.save();
  return Buffer.from(pdfBytes);
}

// =============================
//  HELPER: création PDF pour lettre de motivation
// =============================

async function createLetterPdf(coverLetter, meta) {
  const { jobTitle = "", companyName = "", candidateName = "", lang = "fr" } = meta || {};

  const pdfDoc = await PDFDocument.create();
  const page = pdfDoc.addPage([595.28, 841.89]); // A4
  const font = await pdfDoc.embedFont(StandardFonts.Helvetica);
  const fontBold = await pdfDoc.embedFont(StandardFonts.HelveticaBold);

  const { width, height } = page.getSize();
  const marginX = 60;
  let y = height - 70;

  function drawLine(text, size = 11, bold = false) {
    if (!text || y < 60) return;
    const f = bold ? fontBold : font;
    page.drawText(text, {
      x: marginX,
      y,
      size,
      font: f,
      color: rgb(0.15, 0.17, 0.23),
    });
    y -= size + 4;
  }

  function drawParagraph(text, size = 11) {
    if (!text) return;
    const f = font;
    const maxWidth = width - marginX * 2;
    const paragraphs = text.split(/\n{2,}/);

    for (const paragraph of paragraphs) {
      const words = paragraph.split(/\s+/);
      let line = "";

      for (const w of words) {
        const testLine = line ? line + " " + w : w;
        const testWidth = f.widthOfTextAtSize(testLine, size);
        if (testWidth > maxWidth) {
          if (y < 60) return;
          page.drawText(line, { x: marginX, y, size, font: f, color: rgb(0.15, 0.17, 0.23) });
          y -= size + 4;
          line = w;
        } else {
          line = testLine;
        }
      }

      if (line && y >= 60) {
        page.drawText(line, { x: marginX, y, size, font: f, color: rgb(0.15, 0.17, 0.23) });
        y -= size + 8;
      }

      y -= 4;
    }
  }

  if (candidateName) drawLine(candidateName, 14, true);

  if (jobTitle || companyName) {
    const titleLine =
      lang === "en"
        ? `Application for ${jobTitle || "the position"} – ${companyName || "Company"}`
        : `Candidature : ${jobTitle || "poste"} – ${companyName || "Entreprise"}`;
    drawLine(titleLine, 11, false);
  }

  y -= 10;
  drawParagraph(coverLetter, 11);

  const pdfBytes = await pdfDoc.save();
  return Buffer.from(pdfBytes);
}

/* ============================
   HTTPS: generateLetterAndPitch
   ============================ */
exports.generateLetterAndPitch = functions
  .region("europe-west1")
  .https.onRequest(async (req, res) => {
    setCors(req, res);

    if (req.method === "OPTIONS") return res.status(204).send("");
    if (req.method !== "POST") return res.status(405).json({ error: "Méthode non autorisée" });
    if (!req.is("application/json"))
      return res.status(400).json({ error: "Content-Type invalide. Envoie du JSON." });

    // ✅ reCAPTCHA
    const deny = await enforceRecaptchaOrReturn(req, res, "generate_letter_pitch");
    if (deny) return;

    try {
      const body = req.body || {};
      const profile = body.profile;
      const jobDescription = body.jobDescription || "";
      const jobTitle = body.jobTitle || "";
      const companyName = body.companyName || "";
      const langRaw = body.lang || "fr";
      const lang = String(langRaw).toLowerCase().startsWith("en") ? "en" : "fr";

      if (!profile) {
        return res.status(400).json({ error: "Champ 'profile' manquant dans le corps JSON." });
      }

      if (!jobTitle && !jobDescription) {
        return res.status(400).json({
          error: "Ajoute au moins l'intitulé du poste ou un extrait de la description.",
        });
      }

      const GEMINI_API_KEY =
        process.env.GEMINI_API_KEY ||
        (functions.config().gemini && functions.config().gemini.key);

      const cvText = buildProfileContextForIA(profile);

      if (!GEMINI_API_KEY) {
        console.error("GEMINI_API_KEY manquante (generateLetterAndPitch)");
        const { coverLetter, pitch } = buildFallbackLetterAndPitch(
          profile,
          jobTitle,
          companyName,
          jobDescription,
          lang
        );
        return res.status(200).json({ coverLetter, pitch, lang });
      }

      const prompt =
        lang === "en"
          ? `You are a career coach.
Based on the candidate profile and the target job, produce a JSON object with exactly two keys:
- "coverLetter": a professional cover letter in ENGLISH for the "${jobTitle || "role"}" position at "${companyName || "the company"}". Use 3–5 short paragraphs, adapted to the job description. Do NOT copy the job text.
- "pitch": a concise elevator pitch in ENGLISH (2–4 sentences) the candidate can say out loud.

Return STRICTLY valid JSON with this shape:
{
  "coverLetter": "string",
  "pitch": "string"
}

Do not add any other keys, explanations or markdown.

CANDIDATE PROFILE:
${cvText}

JOB DESCRIPTION / HINTS:
${jobDescription || "—"}`
          : `Tu es un coach carrières.
À partir du profil du candidat et de l'offre, produis un objet JSON avec exactement deux clés :
- "coverLetter" : une lettre de motivation professionnelle en FRANÇAIS pour le poste "${jobTitle || "cible"}" chez "${companyName || "l'entreprise"}". 3–5 paragraphes courts, concrets, alignés avec l'offre. Ne copie pas le texte de l'annonce.
- "pitch" : un pitch d’ascenseur concis en FRANÇAIS (2–4 phrases) que le candidat peut dire à l’oral.

FORMAT :
Retourne STRICTEMENT un JSON valide de la forme :
{
  "coverLetter": "string",
  "pitch": "string"
}

Pas d'autres clés, pas de markdown, pas de commentaires.

PROFIL CANDIDAT :
${cvText}

DESCRIPTION DU POSTE / INDICES :
${jobDescription || "—"}`;

      let coverLetter = "";
      let pitch = "";

      try {
        const raw = await callGeminiText(prompt, GEMINI_API_KEY, 0.7, 2400);
        let cleaned = raw.replace(/```json|```/gi, "").trim();
        let parsed;
        try {
          parsed = JSON.parse(cleaned);
        } catch (e) {
          console.error("JSON Gemini (LM/pitch) invalide, utilisation brute du texte:", raw);
          parsed = { coverLetter: cleaned, pitch: "" };
        }

        coverLetter = typeof parsed.coverLetter === "string" ? parsed.coverLetter.trim() : "";
        pitch = typeof parsed.pitch === "string" ? parsed.pitch.trim() : "";
      } catch (err) {
        console.error("Erreur Gemini generateLetterAndPitch:", err);
      }

      if (!coverLetter || !pitch) {
        const fb = buildFallbackLetterAndPitch(profile, jobTitle, companyName, jobDescription, lang);
        if (!coverLetter) coverLetter = fb.coverLetter;
        if (!pitch) pitch = fb.pitch;
      }

      return res.status(200).json({ coverLetter, pitch, lang });
    } catch (err) {
      console.error("Erreur generateLetterAndPitch:", err);
      const msg = err && err.message ? err.message : "Erreur interne lors de la génération LM/pitch.";
      return res.status(500).json({ error: msg });
    }
  });

/**
 * Fallback local si Gemini plante ou renvoie un pitch vide
 */
function buildFallbackLetterAndPitch(profile, jobTitle, companyName, jobDescription, lang) {
  const p = profile || {};
  const name = p.fullName || "";
  const city = p.city || "";
  const primaryDomain = p.primaryDomain || "";
  const summary = p.profileSummary || "";

  const firstExp = Array.isArray(p.experiences) && p.experiences.length ? p.experiences[0] : null;

  const role = firstExp?.role || firstExp?.title || "";
  const company = firstExp?.company || "";
  const years = Array.isArray(p.experiences) && p.experiences.length > 0 ? p.experiences.length : null;

  let pitch;
  let coverLetter;

  if (lang === "en") {
    pitch =
      summary ||
      `I am ${name || "a candidate"} with ${years ? years + " years of experience" : "solid experience"} in ${
        primaryDomain || "my field"
      }, and I am particularly motivated by the position of ${jobTitle || "your role"} at ${
        companyName || "your company"
      }. I combine ${role || "relevant professional experience"} with strong motivation to contribute to your team.`;

    coverLetter = `Dear ${companyName || "Hiring Manager"},

I am writing to express my interest in the position of ${jobTitle || "your advertised role"}. With ${
      years ? years + " years of experience" : "solid experience"
    } in ${primaryDomain || "my field"}, I have developed strong skills in ${role || "my previous roles"} that I believe are directly relevant to this opportunity.

In my previous experience at ${company || "my last company"}, I was involved in key missions where I ${
      summary ||
      "contributed to projects with measurable impact and collaborated closely with different stakeholders."
    }

What motivates me particularly about joining ${companyName || "your company"} is the opportunity to grow in a challenging environment and to contribute to concrete projects aligned with my values and skills.

I would be delighted to further discuss my application with you and present in more detail how I can contribute to your team.

Best regards,
${name || ""}${city ? "\n" + city : ""}`;
  } else {
    pitch =
      summary ||
      `Je suis ${name || "un(e) candidat(e)"} avec ${
        years ? years + " ans d’expérience" : "une solide expérience"
      } ${primaryDomain ? "dans " + primaryDomain : ""}, et je suis particulièrement motivé(e) par le poste de ${
        jobTitle || "votre poste"
      } chez ${companyName || "votre entreprise"}. J’allie ${
        role || "des expériences professionnelles pertinentes"
      } à une forte motivation pour contribuer à vos projets.`;

    coverLetter = `Madame, Monsieur,

Je vous écris pour vous faire part de mon intérêt pour le poste de ${jobTitle || "..."} au sein de ${
      companyName || "votre entreprise"
    }. Avec ${years ? years + " ans d’expérience" : "une expérience significative"} ${
      primaryDomain ? "dans " + primaryDomain : "dans mon domaine"
    }, j’ai développé des compétences solides en ${
      role || "gestion de projets, collaboration d’équipe et suivi d’objectifs"
    }.

Au cours de mon expérience ${company ? "chez " + company : "professionnelle"}, j’ai notamment ${
      summary ||
      "contribué à des projets à fort impact, tout en travaillant en étroite collaboration avec différentes parties prenantes."
    }

Ce qui me motive particulièrement dans le poste de ${jobTitle || "votre poste"}, c’est la possibilité de mettre à profit mes compétences au service de ${
      companyName || "votre structure"
    } et de continuer à progresser dans un environnement stimulant et exigeant.

Je serais ravi(e) de pouvoir échanger plus en détail avec vous lors d’un entretien et de vous présenter plus précisément ce que je peux apporter à votre équipe.

Je vous prie d’agréer, Madame, Monsieur, l’expression de mes salutations distinguées.

${name || ""}${city ? "\n" + city : ""}`;
  }

  return { coverLetter, pitch };
}

/* ============================
   HTTPS: generateInterviewQA
   ============================ */
exports.generateInterviewQA = functions
  .region("europe-west1")
  .https.onRequest(async (req, res) => {
    setCors(req, res);

    if (req.method === "OPTIONS") return res.status(204).send("");
    if (!req.is("application/json"))
      return res.status(400).json({ error: "Content-Type invalide. Envoie du JSON." });

    // ✅ reCAPTCHA
    const deny = await enforceRecaptchaOrReturn(req, res, "generate_interview_qa");
    if (deny) return;

    try {
      const body = req.body || {};
      const profile = body.profile;
      const experienceIndex = body.experienceIndex;
      const langRaw = body.lang || "fr";
      const lang = String(langRaw).toLowerCase().startsWith("en") ? "en" : "fr";

      if (!profile || !Array.isArray(profile.experiences)) {
        return res.status(400).json({
          error: "Profil ou expériences manquants. Assure-toi d'avoir bien analysé ton CV.",
        });
      }

      const idx = Number.isInteger(experienceIndex)
        ? experienceIndex
        : parseInt(experienceIndex, 10);

      if (Number.isNaN(idx) || !profile.experiences[idx]) {
        return res.status(400).json({ error: "Indice d'expérience invalide." });
      }

      const exp = profile.experiences[idx] || {};
      const role = exp.role || exp.title || (lang === "en" ? "Role" : "Poste");
      const company = exp.company || "";
      const city = exp.city || exp.location || "";
      const dates = exp.dates || "";
      const bullets = Array.isArray(exp.bullets) ? exp.bullets : [];

      const GEMINI_API_KEY =
        process.env.GEMINI_API_KEY ||
        (functions.config().gemini && functions.config().gemini.key);

      const cvText = buildProfileContextForIA(profile);

      if (!GEMINI_API_KEY) {
        console.error("GEMINI_API_KEY manquante (generateInterviewQA)");
        const questions = buildFallbackQuestions(lang, role, company, city, dates, bullets);
        return res.status(200).json({ questions, lang });
      }

      const prompt =
        lang === "en"
          ? `You are an interview coach.
Generate EXACTLY 3 interview question/answer pairs in ENGLISH.

Return STRICTLY a JSON array of 3 objects:
[
  { "question": "string", "answer": "string" },
  ...
]

Guidelines:
- "question": short, precise.
- "answer": concise (Action + Tool + Result) in 1–3 sentences or bullet-style lines.

Context:
- Role: ${role} — ${company} — ${city} — ${dates}
- Missions: ${bullets.join(" ")}
- Candidate profile:
${cvText}`
          : `Tu es un coach d'entretien.
Génère EXACTEMENT 3 paires question/réponse d'entretien en FRANÇAIS.

Retourne STRICTEMENT un tableau JSON de 3 objets :
[
  { "question": "string", "answer": "string" },
  ...
]

Règles :
- "question" : question courte et précise.
- "answer" : réponse synthétique (Action + Outils + Résultat) en 1–3 phrases ou lignes.

Contexte :
- ${role} — ${company} — ${city} — ${dates}
- Missions : ${bullets.join(" ")}
- Profil candidat :
${cvText}`;

      let questions;

      try {
        const raw = await callGeminiText(prompt, GEMINI_API_KEY, 0.7, 1200);
        let cleaned = raw.replace(/```json|```/gi, "").trim();

        let parsed;
        try {
          parsed = JSON.parse(cleaned);
        } catch (e) {
          console.error("JSON Gemini (Q&A) invalide, utilisation brute du texte:", raw);
          parsed = null;
        }

        if (Array.isArray(parsed)) {
          questions = parsed
            .map((item) => ({
              question: (item.question || item.q || "").toString().trim(),
              answer: (item.answer || item.a || "").toString().trim(),
            }))
            .filter((qa) => qa.question && qa.answer);
        }

        if (!questions || !questions.length) {
          console.warn("Gemini Q&A vide, fallback local sur l'expérience:", role, company);
          questions = buildFallbackQuestions(lang, role, company, city, dates, bullets);
        }
      } catch (gemErr) {
        console.error("Erreur generateInterviewQA/Gemini:", gemErr);
        questions = buildFallbackQuestions(lang, role, company, city, dates, bullets);
      }

      return res.status(200).json({ questions, lang });
    } catch (err) {
      console.error("Erreur generateInterviewQA (général):", err);
      return res.status(500).json({
        error: "Erreur interne lors de la génération des Q&A, réessaie plus tard.",
      });
    }
  });

// =============================
//  Fallback local si Gemini plante
// =============================
function buildFallbackQuestions(lang, role, company, city, dates, bullets) {
  const missions = (Array.isArray(bullets) ? bullets : [])
    .filter((b) => typeof b === "string")
    .slice(0, 3);

  if (lang === "en") {
    return [
      {
        question: `Can you describe your role as ${role} at ${company}?`,
        answer: `In my position as ${role} at ${company}${city ? " in " + city : ""}${dates ? " (" + dates + ")" : ""}, I was responsible for ${
          missions[0] || "several key tasks related to this role"
        }.`,
      },
      {
        question: `Tell me about a concrete achievement in this role.`,
        answer: missions[1]
          ? `One strong achievement was: ${missions[1]}`
          : `One of my main achievements was successfully delivering key tasks with measurable impact on the project and the team.`,
      },
      {
        question: `Which tools or technologies did you use most often in this position?`,
        answer: missions[2]
          ? `In this role, I regularly used tools and technologies such as ${missions[2]}.`
          : `I used the main tools and technologies of the job on a daily basis (development, monitoring, collaboration, etc.).`,
      },
    ];
  }

  return [
    {
      question: `Pouvez-vous me décrire votre rôle de ${role} chez ${company} ?`,
      answer: `Dans ce poste de ${role} chez ${company}${city ? " à " + city : ""}${dates ? " (" + dates + ")" : ""}, j'étais principalement en charge de ${
        missions[0] ||
        "plusieurs missions clés en lien avec le poste (projets, coordination, suivi, etc.)"
      }.`,
    },
    {
      question: `Parlez-moi d'une réalisation concrète dont vous êtes fier(e) dans ce poste.`,
      answer: missions[1]
        ? `Une réalisation marquante : ${missions[1]}`
        : `Une de mes réalisations majeures a été de mener à bien des missions qui ont eu un impact positif mesurable sur l'équipe et/ou l'entreprise.`,
    },
    {
      question: `Quels outils ou technologies utilisiez-vous le plus souvent dans ce rôle ?`,
      answer: missions[2]
        ? `Dans ce rôle, j'utilisais notamment ${missions[2]} au quotidien.`
        : `J'utilisais au quotidien les principaux outils et technologies liés à ce poste (outils métiers, outils de suivi, communication, etc.).`,
    },
  ];
}

/* ============================
   HTTPS: generateCvPdf
   ============================ */
exports.generateCvPdf = functions
  .region("europe-west1")
  .https.onRequest(async (req, res) => {
    setCors(req, res);

    if (req.method === "OPTIONS") return res.status(204).send("");
    if (req.method !== "POST") return res.status(405).json({ error: "Méthode non autorisée" });
    if (!req.is("application/json"))
      return res.status(400).json({ error: "Content-Type invalide. Envoie du JSON." });

    // ✅ reCAPTCHA
    const deny = await enforceRecaptchaOrReturn(req, res, "generate_cv_pdf");
    if (deny) return;

    try {
      const body = req.body || {};
      const profile = body.profile;
      const targetJob = body.targetJob || "";
      const template = body.template || "ats";
      const langRaw = body.lang || "fr";
      const contract = body.contract || "";
      const jobLink = body.jobLink || "";
      const jobDescription = body.jobDescription || "";

      const lang = String(langRaw).toLowerCase().startsWith("en") ? "en" : "fr";

      if (!profile) {
        return res.status(400).json({ error: "Champ 'profile' manquant dans le corps JSON." });
      }

      const pdfBuffer = await createSimpleCvPdf(profile, {
        targetJob,
        lang,
        contract,
        jobLink,
        jobDescription,
      });

      res.setHeader("Content-Type", "application/pdf");
      res.setHeader("Content-Disposition", 'attachment; filename="cv-ia.pdf"');

      return res.status(200).send(pdfBuffer);
    } catch (err) {
      console.error("Erreur generateCvPdf:", err);
      const msg = err && err.message ? err.message : "Erreur interne lors de la génération du CV.";
      return res.status(500).json({ error: msg });
    }
  });

/* ============================
   HTTPS: generateCvLmZip
   ============================ */
exports.generateCvLmZip = functions
  .region("europe-west1")
  .https.onRequest(async (req, res) => {
    setCors(req, res);

    if (req.method === "OPTIONS") return res.status(204).send("");
    if (!req.is("application/json"))
      return res.status(400).json({ error: "Content-Type invalide. Envoie du JSON." });

    // ✅ reCAPTCHA
    const deny = await enforceRecaptchaOrReturn(req, res, "generate_cv_lm_zip");
    if (deny) return;

    try {
      const body = req.body || {};
      const profile = body.profile;
      const targetJob = body.targetJob || "";
      const template = body.template || "ats";
      const langRaw = body.lang || "fr";
      const contract = body.contract || "";
      const jobLink = body.jobLink || "";
      const jobDescription = body.jobDescription || "";
      const lm = body.lm || {};
      const autoCreate = !!body.autoCreate;

      const lang = String(langRaw).toLowerCase().startsWith("en") ? "en" : "fr";

      if (!profile) {
        return res.status(400).json({ error: "Champ 'profile' manquant dans le corps JSON." });
      }

      const cvBuffer = await createSimpleCvPdf(profile, {
        targetJob,
        lang,
        contract,
        jobLink,
        jobDescription,
      });

      const GEMINI_API_KEY =
        process.env.GEMINI_API_KEY ||
        (functions.config().gemini && functions.config().gemini.key);

      if (!GEMINI_API_KEY) {
        console.error("GEMINI_API_KEY manquante (generateCvLmZip)");
        return res.status(500).json({
          error:
            "Clé Gemini manquante côté serveur. Configure GEMINI_API_KEY ou functions.config().gemini.key.",
        });
      }

      const companyName = lm.companyName || "";
      const jobTitle = lm.jobTitle || targetJob || "";
      const lmJobDescription = lm.jobDescription || jobDescription || "";
      const lmLangRaw = lm.lang || lang;
      const lmLang = String(lmLangRaw).toLowerCase().startsWith("en") ? "en" : "fr";

      const cvText = buildProfileContextForIA(profile);

      const promptLm =
        lmLang === "en"
          ? `You are a career coach.
Based on the candidate profile and the target job, produce ONLY a professional cover letter in ENGLISH for the "${jobTitle || "role"}" position at "${companyName || "the company"}". Use 3–5 short paragraphs, adapted to the job description. Do NOT copy the job text.

Return ONLY the letter body as plain text (no JSON, no explanation).

CANDIDATE PROFILE:
${cvText}

JOB DESCRIPTION / HINTS:
${lmJobDescription || "—"}`
          : `Tu es un coach carrières.
À partir du profil du candidat et de l'offre, produis UNIQUEMENT une lettre de motivation professionnelle en FRANÇAIS pour le poste "${jobTitle || "cible"}" chez "${companyName || "l'entreprise"}". 3–5 paragraphes courts, concrets, alignés avec l'offre. Ne copie pas le texte de l'annonce.

Retourne UNIQUEMENT le corps de la lettre en texte brut (pas de JSON, pas de commentaires).

PROFIL CANDIDAT :
${cvText}

DESCRIPTION DU POSTE / INDICES :
${lmJobDescription || "—"}`;

      const rawLm = await callGeminiText(promptLm, GEMINI_API_KEY, 0.7, 2400);
      const coverLetterText = rawLm.trim();

      const lmBuffer = await createLetterPdf(coverLetterText, {
        jobTitle,
        companyName,
        candidateName: profile.fullName || "",
        lang: lmLang,
      });

      const zip = new JSZip();
      zip.file("cv-ia.pdf", cvBuffer);
      zip.file(lmLang === "en" ? "cover-letter.pdf" : "lettre-motivation.pdf", lmBuffer);

      const zipContent = await zip.generateAsync({ type: "nodebuffer" });

      res.setHeader("Content-Type", "application/zip");
      res.setHeader("Content-Disposition", 'attachment; filename="cv-lm-ia.zip"');

      return res.status(200).send(zipContent);
    } catch (err) {
      console.error("Erreur generateCvLmZip:", err);
      const msg =
        err && err.message ? err.message : "Erreur interne lors de la génération du ZIP CV + LM.";
      return res.status(500).json({ error: msg });
    }
  });

/* ============================
   HTTPS: generateLetterPdf (LM -> PDF direct)
   ============================ */
exports.generateLetterPdf = functions
  .region("europe-west1")
  .https.onRequest(async (req, res) => {
    setCors(req, res);

    if (req.method === "OPTIONS") return res.status(204).send("");
    if (!req.is("application/json"))
      return res.status(400).json({ error: "Content-Type invalide. Envoie du JSON." });

    // ✅ reCAPTCHA
    const deny = await enforceRecaptchaOrReturn(req, res, "generate_letter_pdf");
    if (deny) return;

    try {
      const body = req.body || {};
      const coverLetter = (body.coverLetter || "").toString().trim();
      const jobTitle = (body.jobTitle || "").toString().trim();
      const companyName = (body.companyName || "").toString().trim();
      const candidateName = (body.candidateName || "").toString().trim();
      const langRaw = body.lang || "fr";
      const lang = String(langRaw).toLowerCase().startsWith("en") ? "en" : "fr";

      if (!coverLetter) {
        return res.status(400).json({
          error:
            "Champ 'coverLetter' manquant ou vide. Envoie le texte de la lettre à convertir en PDF.",
        });
      }

      const pdfBuffer = await createLetterPdf(coverLetter, {
        jobTitle,
        companyName,
        candidateName,
        lang,
      });

      const safeJob = jobTitle
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, "-")
        .replace(/^-+|-+$/g, "");

      const filename =
        (lang === "en" ? "cover-letter" : "lettre-motivation") +
        (safeJob ? `-${safeJob}` : "") +
        ".pdf";

      res.setHeader("Content-Type", "application/pdf");
      res.setHeader("Content-Disposition", `attachment; filename="${filename}"`);

      return res.status(200).send(pdfBuffer);
    } catch (err) {
      console.error("Erreur generateLetterPdf:", err);
      return res.status(500).json({
        error: "Erreur interne lors de la génération du PDF de la lettre.",
      });
    }
  });

/* ============================
   HTTPS: jobs (recherche d'offres Adzuna)
   ============================ */
exports.jobs = functions
  .region("europe-west1")
  .https.onRequest(async (req, res) => {
    setCors(req, res);

    if (req.method === "OPTIONS") return res.status(204).send("");
    if (!req.is("application/json"))
      return res.status(400).json({ error: "Content-Type invalide. Envoie du JSON." });

    // ✅ reCAPTCHA
    const deny = await enforceRecaptchaOrReturn(req, res, "jobs_search");
    if (deny) return;

    try {
      const body = req.body || {};
      const query = (body.query || "").toString().trim();
      const location = (body.location || "").toString().trim();
      const pageRaw = body.page;

      if (!query && !location) {
        return res.status(400).json({
          error:
            "Ajoute au moins un mot-clé (query) ou un lieu (location) pour lancer la recherche.",
        });
      }

      const ADZUNA_APP_ID =
        (functions.config().adzuna && functions.config().adzuna.app_id) || process.env.ADZUNA_APP_ID;
      const ADZUNA_APP_KEY =
        (functions.config().adzuna && functions.config().adzuna.app_key) ||
        process.env.ADZUNA_APP_KEY;

      if (!ADZUNA_APP_ID || !ADZUNA_APP_KEY) {
        console.error("Clés Adzuna manquantes dans functions.config() ou env.");
        return res.status(500).json({
          error:
            "Clés Adzuna manquantes côté serveur. Configure adzuna.app_id et adzuna.app_key.",
        });
      }

      const page =
        typeof pageRaw === "number" && pageRaw > 0
          ? pageRaw
          : parseInt(pageRaw, 10) > 0
          ? parseInt(pageRaw, 10)
          : 1;

      const params = new URLSearchParams();
      params.set("app_id", ADZUNA_APP_ID);
      params.set("app_key", ADZUNA_APP_KEY);
      params.set("results_per_page", "20");
      params.set("content-type", "application/json");
      if (query) params.set("what", query);
      if (location) params.set("where", location);

      const url = `https://api.adzuna.com/v1/api/jobs/fr/search/${page}?${params.toString()}`;

      const resp = await fetch(url, {
        method: "GET",
        headers: { Accept: "application/json" },
      });

      if (!resp.ok) {
        const textErr = await resp.text();
        console.error("Erreur Adzuna:", resp.status, textErr);
        return res.status(500).json({ error: "Erreur lors de l'appel à l'API Adzuna." });
      }

      const data = await resp.json();
      const results = Array.isArray(data.results) ? data.results : [];

      const jobs = results.map((job, index) => {
        const salaryMin = job.salary_min || 0;
        const salaryMax = job.salary_max || 0;
        const hasSalary = salaryMin > 0 || salaryMax > 0;

        return {
          id: job.id || `job-${index}`,
          title: job.title || "Offre sans titre",
          company:
            job.company && job.company.display_name ? job.company.display_name : "Entreprise non renseignée",
          location:
            job.location && job.location.display_name ? job.location.display_name : "Lieu non précisé",
          url: job.redirect_url || "",
          description: job.description || "",
          created: job.created || "",
          salary: hasSalary
            ? `${salaryMin.toLocaleString("fr-FR")} – ${salaryMax.toLocaleString("fr-FR")} €`
            : null,
        };
      });

      return res.status(200).json({ jobs });
    } catch (err) {
      console.error("Erreur /jobs:", err);
      return res.status(500).json({
        error: "Erreur interne lors de la recherche d'offres (Adzuna /jobs).",
      });
    }
  });

/* ============================
   POLAR CHECKOUT (paiement crédits)
   ============================ */

// Log au démarrage si le token manque
const POLAR_ACCESS_TOKEN_BOOT =
  process.env.POLAR_ACCESS_TOKEN ||
  (functions.config().polar && functions.config().polar.access_token);

if (!POLAR_ACCESS_TOKEN_BOOT) {
  console.warn(
    "⚠️ POLAR_ACCESS_TOKEN manquant (env ou functions.config().polar.access_token). Les paiements ne fonctionneront pas."
  );
}

exports.polarCheckout = functions
  .region("europe-west1")
  .https.onRequest(async (req, res) => {
    setCors(req, res);

    if (req.method === "OPTIONS") return res.status(204).send("");
    if (req.method !== "POST") return res.status(405).json({ error: "Méthode non autorisée" });

    // ✅ reCAPTCHA
    const deny = await enforceRecaptchaOrReturn(req, res, "polar_checkout");
    if (deny) return;

    try {
      const body = req.body || {};
      const packId = body.packId;
      const userId = body.userId;
      const email = body.email;

      if (!packId || !userId || !email) {
        return res.status(400).json({
          ok: false,
          error: "Paramètres manquants : packId, userId et email sont obligatoires.",
        });
      }

      const polarAccessToken =
        process.env.POLAR_ACCESS_TOKEN ||
        (functions.config().polar && functions.config().polar.access_token);

      const polarEnv =
        process.env.POLAR_ENV || (functions.config().polar && functions.config().polar.env) || "sandbox";

      const product20 =
        process.env.POLAR_PRODUCT_20_ID ||
        (functions.config().polar && functions.config().polar.product_20_id);
      const product50 =
        process.env.POLAR_PRODUCT_50_ID ||
        (functions.config().polar && functions.config().polar.product_50_id);
      const product100 =
        process.env.POLAR_PRODUCT_100_ID ||
        (functions.config().polar && functions.config().polar.product_100_id);

      if (!polarAccessToken) {
        console.error("POLAR_ACCESS_TOKEN manquant côté serveur");
        return res.status(500).json({ ok: false, error: "Configuration Polar manquante côté serveur." });
      }

      const server = polarEnv === "production" ? "production" : "sandbox";

      const polar = new Polar({
        accessToken: polarAccessToken,
        // @ts-ignore selon version du SDK
        server,
      });

      const mapPackToProduct = { "20": product20, "50": product50, "100": product100 };
      const productId = mapPackToProduct[packId];

      if (!productId) {
        console.error("Pack invalide ou productId non configuré :", packId);
        return res.status(400).json({
          ok: false,
          error: `Pack invalide ou productId non configuré pour "${packId}".`,
        });
      }

      const baseUrl =
        process.env.NEXT_PUBLIC_APP_URL ||
        (functions.config().app && functions.config().app.base_url) ||
        "https://assistant-ia-v4.web.app";

      const successUrl = `${baseUrl}/app/credits?status=success`;
      const returnUrl = `${baseUrl}/app/credits?status=cancel`;

      const payload = {
        products: [productId],
        success_url: successUrl,
        return_url: returnUrl,
        customer_email: email,

        external_customer_id: userId,

        allow_discount_codes: true,
        require_billing_address: false,
        allow_trial: true,
        is_business_customer: false,

        metadata: {
          firebase_uid: String(userId),
          pack_id: String(packId),
          app: "assistant-ia-v4",
        },
      };

      const checkout = await polar.checkouts.create(payload);

      if (!checkout || !checkout.url) {
        console.error("Checkout Polar créé mais sans URL :", checkout);
        return res.status(500).json({ ok: false, error: "Checkout Polar créé mais URL manquante." });
      }

      // ✅ mapping checkoutId -> userId en Firestore
      try {
        const checkoutId = checkout.id ? String(checkout.id) : null;
        const customerId = checkout.customer_id ? String(checkout.customer_id) : null;
        const productPriceId = checkout.product_price_id || checkout.productPriceId || null;

        if (checkoutId) {
          await db
            .collection("polar_checkouts")
            .doc(checkoutId)
            .set(
              {
                userId: String(userId),
                email: String(email),
                packId: String(packId),
                productId: String(productId),
                productPriceId: productPriceId ? String(productPriceId) : null,
                customerId: customerId ? String(customerId) : null,
                env: server,
                status: checkout.status || null,
                createdAt: admin.firestore.FieldValue.serverTimestamp(),
                updatedAt: admin.firestore.FieldValue.serverTimestamp(),
              },
              { merge: true }
            );
        }

        if (customerId) {
          await db
            .collection("polar_customers")
            .doc(customerId)
            .set(
              { userId: String(userId), email: String(email), updatedAt: admin.firestore.FieldValue.serverTimestamp() },
              { merge: true }
            );
        }
      } catch (e) {
        console.warn("Impossible d'écrire le mapping polar_checkouts:", e);
      }

      return res.status(200).json({ ok: true, url: checkout.url });
    } catch (err) {
      console.error("Erreur polarCheckout:", err);
      return res.status(500).json({ ok: false, error: "Erreur interne lors de la création du checkout Polar." });
    }
  });

/* ============================
   POLAR WEBHOOK (ajout de crédits dans Firestore)
   ============================ */

function deepFindByKey(obj, keyNames) {
  if (!obj || typeof obj !== "object") return null;
  const keys = Array.isArray(keyNames) ? keyNames : [keyNames];

  for (const k of Object.keys(obj)) {
    const lower = k.toLowerCase();
    const found = keys.find((target) => lower === target.toLowerCase());
    if (found) {
      const val = obj[k];
      if (val !== undefined && val !== null && val !== "") {
        return val;
      }
    }
    const child = obj[k];
    if (child && typeof child === "object") {
      const result = deepFindByKey(child, keys);
      if (result !== null && result !== undefined) return result;
    }
  }
  return null;
}

function deepCollectByKey(obj, keyNames, acc = []) {
  if (!obj || typeof obj !== "object") return acc;
  const keys = Array.isArray(keyNames) ? keyNames : [keyNames];

  for (const k of Object.keys(obj)) {
    const lower = k.toLowerCase();
    const isMatch = keys.some((target) => lower === target.toLowerCase());
    const val = obj[k];

    if (isMatch) {
      if (val !== undefined && val !== null && val !== "") {
        acc.push(val);
      }
    }

    if (val && typeof val === "object") {
      deepCollectByKey(val, keys, acc);
    }
  }
  return acc;
}

function inferCreditsFromText(text) {
  if (!text || typeof text !== "string") return 0;
  const m = text.match(/(\d+)\s*credits?/i);
  if (!m) return 0;
  const n = parseInt(m[1], 10);
  if ([20, 50, 100].includes(n)) return n;
  return 0;
}

const POLAR_WEBHOOK_SECRET =
  process.env.POLAR_WEBHOOK_SECRET ||
  (functions.config().polar && functions.config().polar.webhook_secret);

exports.polarWebhook = functions
  .region("europe-west1")
  .https.onRequest(async (req, res) => {
    setCors(req, res);

    if (req.method === "OPTIONS") return res.status(204).send("");
    if (req.method !== "POST") {
      return res.status(405).json({ ok: false, error: "Méthode non autorisée" });
    }

    let event;

    try {
      // ✅ Debug (validation désactivée pour l'instant)
      event = req.body || {};

      console.log("Webhook Polar reçu :", JSON.stringify(event, null, 2));

      if (!event || !event.type) {
        console.error("Webhook Polar sans type d'événement.");
        return res.status(400).json({ ok: false, error: "Event Polar invalide (type manquant)." });
      }

      // On ne gère que order.paid
      if (event.type !== "order.paid") {
        console.log("Event Polar ignoré (type non géré) :", event.type);
        return res.status(200).json({ ok: true, ignored: true });
      }

      const product20 =
        process.env.POLAR_PRODUCT_20_ID ||
        (functions.config().polar && functions.config().polar.product_20_id);
      const product50 =
        process.env.POLAR_PRODUCT_50_ID ||
        (functions.config().polar && functions.config().polar.product_50_id);
      const product100 =
        process.env.POLAR_PRODUCT_100_ID ||
        (functions.config().polar && functions.config().polar.product_100_id);

      const price20 =
        process.env.POLAR_PRICE_20_ID ||
        (functions.config().polar && functions.config().polar.price_20_id);
      const price50 =
        process.env.POLAR_PRICE_50_ID ||
        (functions.config().polar && functions.config().polar.price_50_id);
      const price100 =
        process.env.POLAR_PRICE_100_ID ||
        (functions.config().polar && functions.config().polar.price_100_id);

      const CREDITS_BY_PRODUCT_ID = {};
      if (product20) CREDITS_BY_PRODUCT_ID[String(product20)] = 20;
      if (product50) CREDITS_BY_PRODUCT_ID[String(product50)] = 50;
      if (product100) CREDITS_BY_PRODUCT_ID[String(product100)] = 100;

      const CREDITS_BY_PRICE_ID = {};
      if (price20) CREDITS_BY_PRICE_ID[String(price20)] = 20;
      if (price50) CREDITS_BY_PRICE_ID[String(price50)] = 50;
      if (price100) CREDITS_BY_PRICE_ID[String(price100)] = 100;

      const data = event.data || {};

      const priceIds = deepCollectByKey(data, ["product_price_id", "productPriceId"]).map(String);
      const productIds = deepCollectByKey(data, ["product_id", "productId"]).map(String);

      let creditsToAdd = 0;

      for (const pid of priceIds) {
        if (CREDITS_BY_PRICE_ID[pid]) {
          creditsToAdd = CREDITS_BY_PRICE_ID[pid];
          break;
        }
      }

      if (!creditsToAdd) {
        for (const id of productIds) {
          if (CREDITS_BY_PRODUCT_ID[id]) {
            creditsToAdd = CREDITS_BY_PRODUCT_ID[id];
            break;
          }
        }
      }

      if (!creditsToAdd) {
        const labels = deepCollectByKey(data, ["label", "description", "name"])
          .filter((x) => typeof x === "string")
          .map((x) => x.trim());
        for (const t of labels) {
          const n = inferCreditsFromText(t);
          if (n) {
            creditsToAdd = n;
            break;
          }
        }
      }

      if (!creditsToAdd) {
        console.warn("Impossible de déterminer le pack/crédits (IDs/texte). Event ignoré.");
        return res.status(200).json({
          ok: true,
          ignored: true,
          reason: "credits introuvables",
          found: { priceIds, productIds },
        });
      }

      let userId =
        deepFindByKey(data, ["external_customer_id", "customer_external_id"]) ||
        deepFindByKey(data, ["firebase_uid", "firebaseUid"]) ||
        deepFindByKey(data, ["custom_field_data"])?.firebase_uid ||
        null;

      if (userId && typeof userId !== "string") userId = String(userId);

      if (!userId) {
        const customerId = deepFindByKey(data, ["customer_id", "customerId"]) || null;
        if (customerId) {
          const snap = await db.collection("polar_customers").doc(String(customerId)).get();
          if (snap.exists) {
            const d = snap.data() || {};
            if (d.userId) userId = String(d.userId);
          }
        }
      }

      if (!userId) {
        const checkoutId = deepFindByKey(data, ["checkout_id", "checkoutId"]) || null;
        if (checkoutId) {
          const snap = await db.collection("polar_checkouts").doc(String(checkoutId)).get();
          if (snap.exists) {
            const d = snap.data() || {};
            if (d.userId) userId = String(d.userId);
          }
        }
      }

      if (!userId) {
        const email = deepFindByKey(data, ["customer_email", "email"]) || null;
        if (email && typeof email === "string") {
          try {
            const u = await admin.auth().getUserByEmail(email);
            if (u && u.uid) {
              userId = u.uid;
              console.warn("userId récupéré via email fallback (admin.auth).", email);
            }
          } catch (e) {
            console.warn("Fallback email->uid impossible:", e);
          }
        }
      }

      if (!userId || typeof userId !== "string") {
        console.warn("Impossible de récupérer userId dans le webhook Polar, event ignoré.");
        return res.status(200).json({ ok: true, ignored: true, reason: "userId introuvable" });
      }

      const orderId = (data && (data.id || data.order_id || data.orderId)) || event.id || null;

      let ledgerRef = null;
      if (orderId) {
        ledgerRef = db.collection("polar_orders").doc(String(orderId));
      }

      await db.runTransaction(async (tx) => {
        if (ledgerRef) {
          const ledgerSnap = await tx.get(ledgerRef);
          if (ledgerSnap.exists) {
            console.log("Paiement Polar déjà traité, pas de double crédit. orderId=", orderId);
            return;
          }
        }

        const userRef = db.collection("users").doc(userId);
        const userSnap = await tx.get(userRef);
        const userData = userSnap.exists ? userSnap.data() || {} : {};
        const currentCredits = typeof userData.credits === "number" ? userData.credits : 0;

        const newCredits = currentCredits + creditsToAdd;

        tx.set(
          userRef,
          {
            credits: newCredits,
            updatedAt: admin.firestore.FieldValue.serverTimestamp(),
          },
          { merge: true }
        );

        if (ledgerRef) {
          tx.set(ledgerRef, {
            processed: true,
            userId,
            creditsAdded: creditsToAdd,
            productIds,
            priceIds,
            eventType: event.type,
            createdAt: admin.firestore.FieldValue.serverTimestamp(),
          });
        }

        console.log(
          `Crédits ajoutés via webhook Polar : +${creditsToAdd} (total=${newCredits}) pour userId=${userId}, orderId=${orderId}`
        );
      });

      return res.status(200).json({ ok: true, processed: true });
    } catch (err) {
      console.error("Erreur polarWebhook:", err);
      return res.status(500).json({
        ok: false,
        error: "Erreur interne lors du traitement du webhook Polar.",
      });
    }
  });
````

## File: functions/package.json
````json
{
  "name": "assistant-candidatures-functions",
  "main": "index.js",
  "engines": {
    "node": "20"
  },
  "dependencies": {
    "@google-cloud/recaptcha-enterprise": "^6.3.0",
    "@google/genai": "^1.30.0",
    "@polar-sh/sdk": "^0.41.5",
    "busboy": "^1.6.0",
    "cors": "^2.8.5",
    "firebase-admin": "^12.7.0",
    "firebase-functions": "^5.0.0",
    "jszip": "^3.10.1",
    "node-fetch": "^3.3.2",
    "nodemailer": "^7.0.10",
    "pdf-lib": "^1.17.1",
    "pdf-parse": "^2.4.5",
    "pdfjs-dist": "^5.4.394"
  }
}
````

## File: hooks/useAdminGuard.ts
````typescript
// src/hooks/useAdminGuard.ts
"use client";

import { useEffect } from "react";
import { useRouter, usePathname } from "next/navigation";
import type { User } from "firebase/auth";
import { useAuth } from "@/context/AuthContext";

// 👉 Emails qui sont admin "hardcodés" en plus du custom claim isAdmin
const ADMIN_EMAILS = ["aakane0105@gmail.com"];

export type UseAdminGuardResult = {
  loading: boolean;
  isAdmin: boolean;
  user: User | null;
};

export function useAdminGuard(): UseAdminGuardResult {
  const { user, loading, isAdmin: isAdminFromContext } = useAuth();
  const router = useRouter();
  const pathname = usePathname();

  // fallback : si jamais le claim n'est pas encore set, mais que l'email est dans la whitelist
  const email = (user?.email || "").toLowerCase();
  const hasAdminEmail = ADMIN_EMAILS.includes(email);

  const isAdmin = isAdminFromContext || hasAdminEmail;

  useEffect(() => {
    if (loading) return;

    const onAdminRoute = pathname?.startsWith("/admin");

    // Pas connecté et route /admin → renvoie vers /admin/login
    if (!user && onAdminRoute) {
      router.push("/admin/login");
      return;
    }

    // Connecté mais pas admin et route /admin (hors /admin/login) → renvoie vers /
    if (
      user &&
      !isAdmin &&
      onAdminRoute &&
      pathname !== "/admin/login"
    ) {
      router.push("/");
    }
  }, [user, loading, isAdmin, pathname, router]);

  return { loading, isAdmin, user };
}
````

## File: hooks/useUserCredits.ts
````typescript
"use client";

import { useEffect, useState } from "react";
import { doc, onSnapshot } from "firebase/firestore";
import { db } from "@/lib/firebase";
import { useAuth } from "@/context/AuthContext";

type CreditsState = {
  credits: number;
  loading: boolean;
  error: string | null;
};

export function useUserCredits(): CreditsState {
  const { user } = useAuth();
  const [credits, setCredits] = useState<number>(0);
  const [loading, setLoading] = useState<boolean>(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    // reset à chaque changement d'user
    setError(null);

    if (!user?.uid) {
      setCredits(0);
      setLoading(false);
      return;
    }

    setLoading(true);

    const ref = doc(db, "users", user.uid);

    const unsub = onSnapshot(
      ref,
      (snap) => {
        const data = snap.exists() ? (snap.data() as any) : {};
        const value = typeof data?.credits === "number" ? data.credits : 0;

        setCredits(value);
        setLoading(false);
      },
      (err) => {
        console.error("Erreur Firestore (credits):", err);
        setError("Impossible de charger les crédits.");
        setLoading(false);
      }
    );

    return () => unsub();
  }, [user?.uid]);

  return { credits, loading, error };
}
````

## File: hooks/useUserProfile.ts
````typescript
"use client";

import { useEffect, useState } from "react";
import { doc, onSnapshot } from "firebase/firestore";
import { db } from "@/lib/firebase";
import { useAuth } from "@/context/AuthContext";

export interface UserProfile {
  id: string;
  email?: string | null;
  displayName?: string | null;
  credits?: number;
  blocked?: boolean;
  ip?: string | null;
  city?: string | null;
  country?: string | null;
  emailVerified?: boolean;
  lastLoginAt?: Date | null;
  lastActiveAt?: Date | null;
}

export function useUserProfile() {
  const { user } = useAuth();
  const [profile, setProfile] = useState<UserProfile | null>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    if (!user) {
      setProfile(null);
      setLoading(false);
      return;
    }

    const ref = doc(db, "users", user.uid);

    const unsub = onSnapshot(
      ref,
      (snap) => {
        if (!snap.exists()) {
          setProfile({
            id: user.uid,
            email: user.email ?? null,
            displayName: user.displayName ?? null,
          });
          setLoading(false);
          return;
        }

        const data = snap.data() as any;

        const lastLoginAt =
          data.lastLoginAt?.toDate?.() &&
          typeof data.lastLoginAt.toDate === "function"
            ? data.lastLoginAt.toDate()
            : null;

        const lastActiveAt =
          data.lastActiveAt?.toDate?.() &&
          typeof data.lastActiveAt.toDate === "function"
            ? data.lastActiveAt.toDate()
            : null;

        const profile: UserProfile = {
          id: snap.id,
          email: data.email ?? user.email ?? null,
          displayName: data.displayName ?? user.displayName ?? null,
          credits:
            typeof data.credits === "number"
              ? data.credits
              : data.credits
              ? Number(data.credits)
              : undefined,
          blocked: data.blocked === true,
          ip: data.ip ?? null,
          city: data.city ?? null,
          country: data.country ?? null,
          emailVerified:
            typeof data.emailVerified === "boolean"
              ? data.emailVerified
              : user.emailVerified ?? false,
          lastLoginAt,
          lastActiveAt,
        };

        setProfile(profile);
        setLoading(false);
      },
      (error) => {
        console.error("Erreur onSnapshot user profile:", error);
        setProfile(null);
        setLoading(false);
      }
    );

    return () => unsub();
  }, [user]);

  return { profile, loading };
}
````

## File: lib/server/credits.ts
````typescript
// lib/server/credits.ts
//
// VERSION DEV SANS FIRESTORE
// --------------------------
// On simule juste des crédits illimités pour tous les utilisateurs.
// Ça évite les erreurs Firebase Admin en local.
// Quand tu voudras brancher Firestore côté serveur, tu pourras
// rétablir la logique avec firebase-admin ici.

type DevUser = {
  id: string;
  credits: number;
};

export async function verifyUserAndCredits(
  userId: string
): Promise<DevUser | null> {
  if (!userId) return null;

  // En DEV : tous les users sont autorisés, avec beaucoup de crédits.
  return {
    id: userId,
    credits: 9999,
  };
}

export async function consumeCredit(
  userId: string,
  amount = 1
): Promise<void> {
  // En DEV : on ne fait rien, on log juste.
  console.log(
    `[DEV][credits] Consommation simulée de ${amount} crédit(s) pour l'utilisateur ${userId}`
  );
}
````

## File: lib/auth.ts
````typescript
"use client";

import { auth } from "./firebase";
import {
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  signOut,
  updateProfile,
  sendEmailVerification,
} from "firebase/auth";

export async function signupWithEmail(
  firstName: string,
  lastName: string,
  email: string,
  password: string
) {
  const cred = await createUserWithEmailAndPassword(auth, email, password);

  await updateProfile(cred.user, {
    displayName: `${firstName} ${lastName}`.trim(),
  });

  // 👉 ICI : on laisse Firebase envoyer son email standard
  await sendEmailVerification(cred.user);

  return cred;
}

export async function loginWithEmail(email: string, password: string) {
  return signInWithEmailAndPassword(auth, email, password);
}

export async function logout() {
  return signOut(auth);
}
````

## File: lib/credits.ts
````typescript
// src/lib/credits.ts
import {
  collection,
  doc,
  getDoc,
  getDocs,
  increment,
  query,
  setDoc,
  updateDoc,
  where,
} from "firebase/firestore";
import { db } from "@/lib/firebase";

/**
 * Ajoute des crédits à un utilisateur identifié par son userId (document users/{userId}).
 */
export async function addCreditsToUserById(
  userId: string,
  creditsToAdd: number
): Promise<void> {
  if (!userId) {
    console.error("[credits] userId manquant");
    return;
  }
  if (!creditsToAdd || creditsToAdd <= 0) {
    console.warn("[credits] creditsToAdd <= 0, rien à ajouter", {
      userId,
      creditsToAdd,
    });
    return;
  }

  const ref = doc(db, "users", userId);
  const snap = await getDoc(ref);

  if (!snap.exists()) {
    console.warn(
      "[credits] Doc user inexistant, création avec crédits initiaux",
      { userId, creditsToAdd }
    );
    await setDoc(ref, {
      credits: creditsToAdd,
      createdAt: new Date(),
    });
    return;
  }

  console.log("[credits] Ajout de crédits par userId", { userId, creditsToAdd });

  await updateDoc(ref, {
    credits: increment(creditsToAdd),
  });
}

/**
 * Ajoute des crédits à (tous) les utilisateurs qui ont cet email.
 * Fallback si on n’a pas externalId dans l’event Polar.
 */
export async function addCreditsToUserByEmail(
  email: string,
  creditsToAdd: number
): Promise<void> {
  if (!email) {
    console.error("[credits] email manquant");
    return;
  }
  if (!creditsToAdd || creditsToAdd <= 0) {
    console.warn("[credits] creditsToAdd <= 0, rien à ajouter", {
      email,
      creditsToAdd,
    });
    return;
  }

  const usersCol = collection(db, "users");
  const q = query(usersCol, where("email", "==", email));
  const qs = await getDocs(q);

  if (qs.empty) {
    console.warn(
      "[credits] Aucun user trouvé avec cet email, création impossible",
      { email, creditsToAdd }
    );
    return;
  }

  console.log(
    "[credits] Ajout de crédits par email (tous les users trouvés)",
    { email, creditsToAdd, count: qs.size }
  );

  const promises: Promise<any>[] = [];
  qs.forEach((docSnap) => {
    promises.push(
      updateDoc(docSnap.ref, {
        credits: increment(creditsToAdd),
      })
    );
  });

  await Promise.all(promises);
}

/**
 * Consomme des crédits pour un utilisateur.
 *
 * Pour être flexible avec ton code existant, cette fonction accepte :
 *  - consumeCredits(userId, 3)
 *  - consumeCredits({ userId: "xxx", amount: 3 })
 *  - consumeCredits({ userId: "xxx", credits: 3 })
 */
export async function consumeCredits(arg1: any, arg2?: any): Promise<void> {
  let userId: string | undefined;
  let toConsume = 0;

  if (typeof arg1 === "string") {
    userId = arg1;
    toConsume = typeof arg2 === "number" ? arg2 : 0;
  } else if (typeof arg1 === "object" && arg1 !== null) {
    userId = arg1.userId || arg1.uid;
    toConsume =
      arg1.amount ?? arg1.credits ?? arg1.count ?? arg1.nb ?? 0;
  }

  if (!userId || !toConsume || toConsume <= 0) {
    console.warn(
      "[credits] consumeCredits appelé sans paramètres valides",
      { arg1, arg2 }
    );
    return;
  }

  const ref = doc(db, "users", userId);
  const snap = await getDoc(ref);

  if (!snap.exists()) {
    console.warn(
      "[credits] user inexistant pour consumeCredits, aucun débit",
      { userId }
    );
    return;
  }

  console.log("[credits] Consommation de crédits", {
    userId,
    toConsume,
  });

  await updateDoc(ref, {
    credits: increment(-toConsume),
  });
}
````

## File: lib/firebase.ts
````typescript
"use client";

import { initializeApp, getApps, getApp } from "firebase/app";
import { getAuth, GoogleAuthProvider } from "firebase/auth";
import { getFirestore } from "firebase/firestore";
import { getFunctions } from "firebase/functions";

// ✅ Ta config Firebase
const firebaseConfig = {
  apiKey: "AIzaSyCNb2cU0yhUeBGOk-8IK3TGNbjL6wSYMRs",
  authDomain: "assistant-ia-v4.firebaseapp.com",
  projectId: "assistant-ia-v4",
  storageBucket: "assistant-ia-v4.firebasestorage.app",
  messagingSenderId: "500826253198",
  appId: "1:500826253198:web:4bc5bd2402d7dd286326df",
  measurementId: "G-61HCNNZBTN",
};

const app = !getApps().length ? initializeApp(firebaseConfig) : getApp();

export const auth = getAuth(app);
export const db = getFirestore(app);
// ✅ Functions dans la même région que tes Cloud Functions
export const functions = getFunctions(app, "europe-west1");

// ✅ Provider Google (pour popup)
export const googleProvider = new GoogleAuthProvider();
googleProvider.setCustomParameters({
  prompt: "select_account",
});

export { app };
````

## File: lib/firebaseAdmin.ts
````typescript
// lib/firebaseAdmin.ts
import admin from "firebase-admin";

if (!admin.apps.length) {
  const projectId = process.env.FIREBASE_PROJECT_ID;
  const clientEmail = process.env.FIREBASE_CLIENT_EMAIL;
  const rawPrivateKey = process.env.FIREBASE_PRIVATE_KEY;

  if (projectId && clientEmail && rawPrivateKey) {
    const privateKey = rawPrivateKey.replace(/\\n/g, "\n");
    try {
      admin.initializeApp({
        credential: admin.credential.cert({
          projectId,
          clientEmail,
          privateKey,
        }),
      });
      console.log("[firebaseAdmin] Initialisé avec les variables d'env");
    } catch (err) {
      console.error("[firebaseAdmin] Erreur d'initialisation :", err);
    }
  } else {
    console.warn(
      "[firebaseAdmin] Variables d'env manquantes. Admin ne sera pas initialisé (OK en DEV)."
    );
  }
}

export default admin;
````

## File: lib/firestore.ts
````typescript
import { db } from "./firebase";
import {
  collection,
  doc,
  getDoc,
  getDocs,
  setDoc,
  updateDoc,
  addDoc,
  query,
  where
} from "firebase/firestore";

// Placeholders pour tes futures fonctions Firestore (users, candidatures, etc.)
export {
  db,
  collection,
  doc,
  getDoc,
  getDocs,
  setDoc,
  updateDoc,
  addDoc,
  query,
  where
};
````

## File: lib/gemini.ts
````typescript
"use client";

// lib/gemini.ts
// =========================================================
// Intégration Gemini & Cloud Functions pour ton app
// - extractProfile        : Cloud Function HTTPS (profil CV)
// - generateLetterAndPitch: route Next.js /api/letterAndPitch
// - generateInterviewQA   : Cloud Function HTTPS generateInterviewQA
// =========================================================

import { getRecaptchaToken } from "@/lib/recaptcha";

// URL de base des Cloud Functions HTTP
// En prod, mets NEXT_PUBLIC_API_BASE_URL = "https://europe-west1-assistant-ia-v4.cloudfunctions.net"
const RAW_BASE_URL = process.env.NEXT_PUBLIC_API_BASE_URL ?? "";
const CF_BASE_URL =
  RAW_BASE_URL.trim() ||
  "https://europe-west1-assistant-ia-v4.cloudfunctions.net";

function buildCfUrl(path: string): string {
  return `${CF_BASE_URL.replace(/\/+$/, "")}/${path.replace(/^\/+/, "")}`;
}

async function requireRecaptcha(action: string): Promise<string> {
  try {
    // getRecaptchaToken normalise déjà l'action en lowercase dans lib/recaptcha.ts
    return await getRecaptchaToken(action);
  } catch (e: any) {
    const msg =
      e?.message ||
      "reCAPTCHA non disponible (script bloqué ? adblock ?).";
    throw new Error(
      `Sécurité: impossible de valider reCAPTCHA (${action}). ${msg}`
    );
  }
}

// =========================================================
// 1) EXTRACT PROFILE (CV → profil structuré via Cloud Function)
// =========================================================

export async function callExtractProfile(base64Pdf: string) {
  const url = buildCfUrl("extractProfile");
  const recaptchaToken = await requireRecaptcha("extract_profile");

  const res = await fetch(url, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ base64Pdf, recaptchaToken }),
  });

  const json = await res.json().catch(() => null);

  if (!res.ok) {
    console.error("Erreur HTTP extractProfile:", res.status, json);
    throw new Error(json?.error || "Erreur extractProfile");
  }

  if (!json || typeof json !== "object") {
    console.error("Réponse extractProfile invalide:", json);
    throw new Error("Réponse extractProfile invalide.");
  }

  return json;
}

// =========================================================
// 2) LETTRE DE MOTIVATION + PITCH (via /api/letterAndPitch)
// =========================================================

export type GenerateLetterAndPitchPayload = {
  profile: any; // profil complet CV Firestore
  jobDescription: string;
  jobTitle?: string;
  companyName?: string;
  lang?: "fr" | "en";
};

export type GenerateLetterAndPitchResult = {
  coverLetter: string;
  pitch: string;
  lang?: string;
};

export async function callGenerateLetterAndPitch(
  payload: GenerateLetterAndPitchPayload
): Promise<GenerateLetterAndPitchResult> {
  const recaptchaToken = await requireRecaptcha("generate_letter_pitch");

  const res = await fetch("/api/letterAndPitch", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ ...payload, recaptchaToken }),
  });

  const contentType = res.headers.get("content-type") || "";
  let json: any = null;
  let rawText: string | null = null;

  if (contentType.includes("application/json")) {
    json = await res.json().catch((err) => {
      console.error("Erreur de parse JSON generateLetterAndPitch:", err);
      return null;
    });
  } else {
    rawText = await res.text().catch(() => null);
  }

  if (!res.ok) {
    console.error(
      "Erreur HTTP generateLetterAndPitch:",
      res.status,
      contentType,
      json ?? rawText?.slice(0, 400)
    );
    throw new Error(
      json?.error || `Erreur generateLetterAndPitch (code ${res.status})`
    );
  }

  if (!contentType.includes("application/json")) {
    console.error(
      "generateLetterAndPitch: réponse non JSON (souvent page HTML de 404/500):",
      res.status,
      contentType,
      rawText?.slice(0, 400)
    );
    throw new Error(
      "L'endpoint /api/letterAndPitch ne renvoie pas de JSON. " +
        "En production, vérifie que la route API existe bien."
    );
  }

  if (!json || typeof json !== "object") {
    console.error("Réponse generateLetterAndPitch invalide:", json);
    throw new Error("Réponse generateLetterAndPitch invalide.");
  }

  const coverLetter =
    typeof (json as any).coverLetter === "string"
      ? (json as any).coverLetter
      : "";
  const pitch =
    typeof (json as any).pitch === "string" ? (json as any).pitch : "";

  return {
    coverLetter,
    pitch,
    lang: (json as any).lang || payload.lang || "fr",
  };
}

// =========================================================
// 3) Q&A D'ENTRETIEN (via Cloud Function generateInterviewQA)
// =========================================================

export type GenerateInterviewQAPayload = {
  profile: any;
  experienceIndex: number;
  lang?: "fr" | "en";
};

export type InterviewQAPair = {
  question: string;
  answer: string;
};

export type GenerateInterviewQAResult = {
  questions: InterviewQAPair[];
  lang?: string;
};

export async function callGenerateInterviewQA(
  payload: GenerateInterviewQAPayload
): Promise<GenerateInterviewQAResult> {
  const url = buildCfUrl("generateInterviewQA");
  const recaptchaToken = await requireRecaptcha("generate_interview_qa");

  const res = await fetch(url, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ ...payload, recaptchaToken }),
  });

  const contentType = res.headers.get("content-type") || "";
  let json: any = null;
  let rawText: string | null = null;

  if (contentType.includes("application/json")) {
    json = await res.json().catch((err) => {
      console.error("Erreur de parse JSON generateInterviewQA:", err);
      return null;
    });
  } else {
    rawText = await res.text().catch(() => null);
  }

  if (!res.ok) {
    console.error(
      "Erreur HTTP generateInterviewQA:",
      res.status,
      contentType,
      json ?? rawText?.slice(0, 400)
    );
    throw new Error(
      json?.error || `Erreur generateInterviewQA (code ${res.status}).`
    );
  }

  if (!contentType.includes("application/json")) {
    console.error(
      "generateInterviewQA: réponse non JSON:",
      res.status,
      contentType,
      rawText?.slice(0, 400)
    );
    throw new Error(
      "La Cloud Function generateInterviewQA ne renvoie pas de JSON. Vérifie son déploiement."
    );
  }

  if (!json || typeof json !== "object") {
    console.error("Réponse generateInterviewQA invalide:", json);
    throw new Error("Réponse generateInterviewQA invalide.");
  }

  const questionsRaw: any[] = Array.isArray((json as any).questions)
    ? (json as any).questions
    : [];

  const questions: InterviewQAPair[] = questionsRaw
    .map((q, idx) => ({
      question:
        (q?.question ??
          q?.q ??
          (typeof q === "string" ? q : `Question ${idx + 1}`)) + "",
      answer: (q?.answer ?? q?.a ?? "") + "",
    }))
    .filter((q) => q.question && q.answer);

  if (!questions.length) {
    console.error(
      "generateInterviewQA: aucune question exploitable dans la réponse:",
      json
    );
    throw new Error(
      "L'IA n'a pas renvoyé de questions exploitables pour cette expérience."
    );
  }

  return {
    questions,
    lang: (json as any).lang || payload.lang || "fr",
  };
}
````

## File: lib/interviewPrompt.ts
````typescript
// lib/interviewPrompt.ts

// Canal de l'entretien : écrit (chat) ou oral (avec micro + TTS plus tard)
export type InterviewChannel = "written" | "oral";

// Niveau de difficulté / séniorité
export type InterviewLevel = "junior" | "intermediate" | "senior";

// Élément d'historique échangé pendant l'entretien
export type HistoryItem = {
  role: "interviewer" | "candidate";
  text: string;
  createdAt?: string; // <-- IMPORTANT pour ne plus avoir createdAt en rouge
  analysis?: string | null;
};

export type BuildPromptArgs = {
  cvSummary: string;
  jobDesc: string;
  mode: string; // "mixed" | "tech" | "rh" | "hard" etc.
  level: InterviewLevel;
  channel: InterviewChannel;
  history: HistoryItem[];
  step: number;
};

/**
 * Construit le prompt envoyé à Gemini pour générer :
 * - la prochaine question
 * - l'analyse rapide de la réponse précédente
 * - le résumé final + score quand l'IA estime avoir assez d'informations
 */
export function buildPrompt({
  cvSummary,
  jobDesc,
  mode,
  level,
  channel,
  history,
  step,
}: BuildPromptArgs): string {
  const historyText =
    history.length === 0
      ? "Aucun échange pour le moment (début d'entretien)."
      : history
          .map((h) => {
            const who =
              h.role === "interviewer" ? "INTERVIEWER" : "CANDIDAT";
            return `- [${who}] ${h.text}`;
          })
          .join("\n");

  let modeDescription = "";
  switch (mode) {
    case "tech":
      modeDescription =
        "Pose principalement des questions techniques (cloud, sécurité, réseau, etc.).";
      break;
    case "rh":
      modeDescription =
        "Pose surtout des questions RH, motivation, soft-skills, culture d'entreprise.";
      break;
    case "hard":
      modeDescription =
        "Sois très exigeant, avec des questions difficiles, de relance et de mise en situation.";
      break;
    default:
      modeDescription =
        "Mélange de questions techniques et RH/motivation.";
  }

  let levelDescription = "";
  switch (level) {
    case "junior":
      levelDescription =
        "Considère un profil plutôt junior : évalue le potentiel, la motivation et les bases techniques.";
      break;
    case "intermediate":
      levelDescription =
        "Considère un profil intermédiaire : quelques années d'expérience, autonomie moyenne.";
      break;
    case "senior":
      levelDescription =
        "Considère un profil senior : forte expertise, autonomie, leadership possible.";
      break;
  }

  const channelDescription =
    channel === "oral"
      ? "Le candidat répond à l'oral. Les questions doivent être plutôt courtes, conversationnelles, comme dans un vrai échange vocal."
      : "Le candidat répond à l'écrit via un chat. Tu peux poser des questions un peu plus détaillées mais reste concis.";

  return `
Tu joues le rôle d'un recruteur humain qui fait passer un entretien d'embauche en français.

Contexte candidat (résumé de CV) :
${cvSummary || "Non renseigné."}

Contexte poste (fiche de poste / offre) :
${jobDesc || "Non renseigné."}

Mode d'entretien : ${mode}
${modeDescription}

Niveau d'entretien : ${level}
${levelDescription}

Canal : ${channel}
${channelDescription}

Étape actuelle de l'entretien : ${step}
Historique des échanges (du plus ancien au plus récent) :
${historyText}

OBJECTIF :
- Poser des questions pertinentes par rapport au poste et au profil.
- Être honnête et exigeant sur la compatibilité avec la fiche de poste.
- Quand tu estimes avoir assez d'informations, produire un résumé final détaillé + un score global de compatibilité sur 100.

⚠️ TRÈS IMPORTANT : FORMAT DE RÉPONSE OBLIGATOIRE ⚠️
Tu dois répondre STRICTEMENT en JSON valide, sans texte autour, sans Markdown, sans commentaires, sans \`\`\`.

Format exact attendu :

{
  "next_question": string | null,
  "short_analysis": string | null,
  "final_summary": string | null,
  "final_score": number | null
}

Règles :
- Tant que l'entretien continue :
  - "next_question" = la prochaine question à poser au candidat (en français).
  - "short_analysis" = une analyse très courte (2-3 phrases max) de la dernière réponse du candidat.
  - "final_summary" = null
  - "final_score" = null
- Quand tu estimes que l'entretien est terminé :
  - "next_question" = null
  - "short_analysis" = une courte phrase de conclusion si tu veux
  - "final_summary" = un résumé structuré de la performance du candidat, points forts / points faibles, recommandation (oui / non / à voir).
  - "final_score" = un nombre entier de 0 à 100 représentant la compatibilité globale avec la fiche de poste.

Ta réponse DOIT être un JSON pur, directement parsable par JSON.parse en JavaScript.
  `.trim();
}
````

## File: lib/ipLocation.ts
````typescript
// lib/ipLocation.ts
// Récupère IP + pays + ville côté client, avec un petit cache en sessionStorage

export type ClientLocation = {
  ip: string | null;
  country: string | null;
  city: string | null;
};

let inMemoryLocation: ClientLocation | null = null;
let inFlightPromise: Promise<ClientLocation | null> | null = null;

function loadFromSession(): ClientLocation | null {
  if (typeof window === "undefined") return null;
  try {
    const raw = window.sessionStorage.getItem("smartcv_location_cache");
    if (!raw) return null;
    const parsed = JSON.parse(raw);
    if (
      typeof parsed === "object" &&
      parsed !== null &&
      "ip" in parsed &&
      "country" in parsed &&
      "city" in parsed
    ) {
      return parsed as ClientLocation;
    }
  } catch {
    // ignore
  }
  return null;
}

function saveToSession(loc: ClientLocation) {
  if (typeof window === "undefined") return;
  try {
    window.sessionStorage.setItem(
      "smartcv_location_cache",
      JSON.stringify(loc)
    );
  } catch {
    // ignore
  }
}

export async function getClientLocation(): Promise<ClientLocation | null> {
  if (typeof window === "undefined") return null;

  if (inMemoryLocation) return inMemoryLocation;

  const cached = loadFromSession();
  if (cached) {
    inMemoryLocation = cached;
    return cached;
  }

  if (inFlightPromise) return inFlightPromise;

  inFlightPromise = (async () => {
    try {
      const res = await fetch("https://ipapi.co/json/");
      if (!res.ok) throw new Error("IP API error");
      const data = await res.json();

      const loc: ClientLocation = {
        ip: data.ip || null,
        country: data.country_name || data.country || null,
        city: data.city || null,
      };

      inMemoryLocation = loc;
      saveToSession(loc);
      return loc;
    } catch (e) {
      console.error("Erreur getClientLocation:", e);
      const loc: ClientLocation = {
        ip: null,
        country: null,
        city: null,
      };
      inMemoryLocation = loc;
      saveToSession(loc);
      return loc;
    }
  })();

  return inFlightPromise;
}
````

## File: lib/linkedin.ts
````typescript
// Fichier : lib/auth.ts

// Vous devez vous assurer que ces imports sont valides dans votre structure
import { auth } from "@/lib/firebase"; // Import de l'instance d'authentification Firebase
import { signInWithCustomToken, UserCredential } from "firebase/auth";

// 👉 Login via LinkedIn
// idToken ici est le Custom Token Firebase généré par votre Cloud Function.
export async function loginWithLinkedInIdToken(idToken: string): Promise<UserCredential> {
  console.log(
    "[auth] Tentative de connexion via Custom Token LinkedIn...",
    idToken
  );

  try {
    // 1. Utilisez le Custom Token pour connecter l'utilisateur Firebase.
    const credential = await signInWithCustomToken(auth, idToken);
    
    console.log("[auth] Connexion LinkedIn réussie:", credential.user.uid);
    
    // Le Custom Token est échangé contre une session utilisateur complète.
    return credential; 
    
  } catch (error) {
    console.error("[auth] Erreur lors de la connexion via Custom Token:", error);
    throw new Error("Impossible de se connecter à Firebase avec le Custom Token fourni.");
  }
}
````

## File: lib/logAuthFailed.ts
````typescript
// src/lib/logAuthFailed.ts
import { addDoc, collection, serverTimestamp } from "firebase/firestore";
import { db } from "@/lib/firebase";

export interface LogAuthFailedParams {
  email?: string;
  provider?: string;
  errorCode?: string;
  errorMessage?: string;
}

/**
 * Détection OS / device / navigateur à partir du userAgent
 */
function parseUserAgent(uaRaw: string | null | undefined) {
  const ua = (uaRaw ?? "").toLowerCase();

  let deviceType: string | null = null;
  let os: string | null = null;
  let browser: string | null = null;

  // --- Device ---
  if (ua.includes("iphone")) {
    deviceType = "iphone";
  } else if (ua.includes("ipad")) {
    deviceType = "ipad";
  } else if (ua.includes("android") && ua.includes("mobile")) {
    deviceType = "mobile";
  } else if (ua.includes("android")) {
    deviceType = "tablet";
  } else if (ua.includes("macintosh") || ua.includes("mac os x")) {
    deviceType = "desktop";
  } else if (ua.includes("windows")) {
    deviceType = "desktop";
  } else {
    deviceType = "desktop";
  }

  // --- OS ---
  if (ua.includes("iphone") || ua.includes("ipad") || ua.includes("ipod")) {
    os = "iOS";
  } else if (ua.includes("android")) {
    os = "Android";
  } else if (ua.includes("mac os x") || ua.includes("macintosh")) {
    os = "macOS";
  } else if (ua.includes("windows nt")) {
    os = "Windows";
  } else if (ua.includes("linux")) {
    os = "Linux";
  }

  // --- Navigateur ---
  if (ua.includes("safari") && !ua.includes("chrome") && !ua.includes("crios")) {
    browser = "Safari";
  } else if (
    (ua.includes("chrome") || ua.includes("crios")) &&
    !ua.includes("edge") &&
    !ua.includes("edg/")
  ) {
    browser = "Chrome";
  } else if (ua.includes("firefox") || ua.includes("fxios")) {
    browser = "Firefox";
  } else if (ua.includes("edg/")) {
    browser = "Edge";
  } else if (ua.includes("opera") || ua.includes("opr/")) {
    browser = "Opera";
  }

  return { deviceType, os, browser };
}

/**
 * Récupère l'IP + ville + pays via un petit service public
 * (tu peux changer pour ton propre endpoint si tu veux).
 */
async function fetchIpInfo() {
  if (typeof window === "undefined") return null;

  try {
    const res = await fetch("https://ipapi.co/json/");
    if (!res.ok) return null;
    const json: any = await res.json();

    return {
      ip: json.ip || null,
      country: json.country_name || null,
      city: json.city || null,
    };
  } catch {
    return null;
  }
}

/**
 * Log d'une tentative de connexion échouée (auth_failed)
 * → écrit dans la collection "usageLogs"
 * → enrichi avec IP, pays, ville, device, OS, navigateur, path
 */
export async function logAuthFailed(params: LogAuthFailedParams) {
  try {
    const ua =
      typeof window !== "undefined"
        ? window.navigator.userAgent || ""
        : "";

    const path =
      typeof window !== "undefined"
        ? window.location.pathname + window.location.search
        : "";

    const { deviceType, os, browser } = parseUserAgent(ua);

    const geo = await fetchIpInfo();

    await addDoc(collection(db, "usageLogs"), {
      action: "auth_failed",
      userId: null, // pas connecté
      email: params.email || "",
      provider: params.provider || "password",
      errorCode: params.errorCode || "",
      errorMessage: params.errorMessage || "",

      // contexte technique
      ua,
      path,
      deviceType: deviceType ?? null,
      os: os ?? null,
      browser: browser ?? null,

      // géoloc basique
      ip: geo?.ip ?? null,
      country: geo?.country ?? null,
      city: geo?.city ?? null,

      createdAt: serverTimestamp(),
    });
  } catch (e) {
    // On ne bloque pas l'utilisateur si le log plante
    console.error("Erreur logAuthFailed:", e);
  }
}
````

## File: lib/logUsage.ts
````typescript
// src/lib/logUsage.ts
import {
  addDoc,
  collection,
  doc,
  updateDoc,
  increment,
} from "firebase/firestore";
import { db } from "@/lib/firebase";
import type { User } from "firebase/auth";

export type UsageDocType = "lm" | "cv" | "other";

interface LogUsageOptions {
  user: User;
  action: string;      // ex: "generate_document", "download_document"
  docType?: UsageDocType; // "lm" | "cv" | "other"
  eventType?: string;  // ex: "generate", "download"
  tool?: string;       // ex: "generateLetterAndPitch", "generateCvPdf"
  creditsDelta?: number; // ex: -1 si tu consommes 1 crédit
  path?: string;       // path courant (optionnel)
}

/**
 * Log d'usage IA côté client :
 * - crée un document dans "usageLogs"
 * - met à jour les compteurs dans "users/{uid}"
 *
 * → Permet à ton admin d'afficher :
 *   - LM générées (logs) : docType = "lm"
 *   - CV générés (logs) : docType = "cv"
 *   - totalIaCalls, totalDocumentsGenerated, totalLmGenerated, totalCvGenerated
 */
export async function logUsage(options: LogUsageOptions) {
  const {
    user,
    action,
    docType = "other",
    eventType,
    tool,
    creditsDelta,
  } = options;

  try {
    const now = Date.now();
    const path =
      options.path ||
      (typeof window !== "undefined"
        ? window.location.pathname + window.location.search
        : "");

    // 1) LOG dans usageLogs
    await addDoc(collection(db, "usageLogs"), {
      userId: user.uid,
      email: user.email ?? "",
      action,         // ex: "generate_document"
      docType,        // "lm" | "cv" | "other"
      eventType: eventType ?? null, // ex: "generate"
      tool: tool ?? null,           // ex: "generateCvPdf"

      creditsDelta: typeof creditsDelta === "number" ? creditsDelta : null,

      path,
      createdAt: now, // number → ton admin new Date(createdAt)

      ip: null,
      country: null,
      city: null,
      deviceType: null,
      os: null,
      browser: null,
    });

    // 2) Mise à jour des compteurs dans users/{uid}
    const userRef = doc(db, "users", user.uid);

    const updates: Record<string, any> = {
      totalIaCalls: increment(1),
    };

    // Document IA → compteur global
    if (docType === "lm" || docType === "cv") {
      updates.totalDocumentsGenerated = increment(1);
    }

    if (docType === "lm") {
      updates.totalLmGenerated = increment(1);
    }
    if (docType === "cv") {
      updates.totalCvGenerated = increment(1);
    }

    if (typeof creditsDelta === "number" && creditsDelta !== 0) {
      updates.credits = increment(creditsDelta);
    }

    await updateDoc(userRef, updates);
  } catch (err) {
    console.error("Erreur logUsage:", err);
    // on ne bloque JAMAIS l'utilisateur si le log plante
  }
}
````

## File: lib/polar-checkout.ts
````typescript
// src/lib/polar-checkout.ts
import { polar } from "@/lib/polar";

// Mappe les packs utilisés dans ton app vers les Product IDs Polar
// Ici on suppose trois packs : 10, 20, 30 crédits
const PACK_TO_PRODUCT_ID: Record<string, string> = {
  "10": process.env.POLAR_PRODUCT_10_ID || "",
  "20": process.env.POLAR_PRODUCT_20_ID || "",
  "30": process.env.POLAR_PRODUCT_30_ID || "",
};

const APP_URL =
  process.env.NEXT_PUBLIC_APP_URL ?? "https://assistant-ia-v4.web.app";

export type CreditPackId = "10" | "20" | "30";

export interface CreateCheckoutOptions {
  customerEmail?: string;
  externalCustomerId?: string; // ex: id utilisateur (Firebase, Supabase, etc.)
}

/**
 * Crée une session de paiement Polar pour un pack donné.
 *
 * @param packId - "10", "20" ou "30" (nombre de crédits du pack)
 * @param opts - infos client (email, id externe)
 */
export async function createPolarCheckout(
  packId: CreditPackId,
  opts?: CreateCheckoutOptions
) {
  const productId = PACK_TO_PRODUCT_ID[packId];

  if (!productId) {
    throw new Error(
      `Pack inconnu côté Polar : "${packId}". Vérifie PACK_TO_PRODUCT_ID dans src/lib/polar-checkout.ts`
    );
  }

  // Polar remplace {CHECKOUT_ID} par l'id réel du checkout
  const successUrl = `${APP_URL}/paiement/success?checkout_id={CHECKOUT_ID}`;
  const returnUrl = `${APP_URL}/paiement/canceled`;

  const checkout = await polar.checkouts.create({
    products: [productId],
    successUrl,
    returnUrl,
    customerEmail: opts?.customerEmail,
    externalCustomerId: opts?.externalCustomerId,
  });

  if (!checkout.url) {
    throw new Error("Polar n'a pas renvoyé d'URL de checkout");
  }

  return { url: checkout.url };
}
````

## File: lib/polar.ts
````typescript
// src/lib/polar.ts
import { Polar } from "@polar-sh/sdk";

const server =
  process.env.POLAR_ENV === "production" ? "production" : "sandbox";

if (!process.env.POLAR_ACCESS_TOKEN) {
  throw new Error("POLAR_ACCESS_TOKEN manquant dans .env");
}

// Instance Polar
export const polar = new Polar({
  accessToken: process.env.POLAR_ACCESS_TOKEN,
  // @ts-ignore : selon la version du SDK, server peut être optionnel
  server,
});

// ⚠️ Packs alignés avec ton UI : 20 / 50 / 100 crédits
export type CreditPackId = "20" | "50" | "100";

// ✅ IDs produits liés aux packs, alimentés par tes variables d'env
const PACK_TO_PRODUCT_ID: Record<CreditPackId, string> = {
  "20": process.env.POLAR_PRODUCT_20_ID ?? "",
  "50": process.env.POLAR_PRODUCT_50_ID ?? "",
  "100": process.env.POLAR_PRODUCT_100_ID ?? "",
};

function getProductIdForPack(packId: CreditPackId): string {
  const productId = PACK_TO_PRODUCT_ID[packId];
  if (!productId) {
    throw new Error(
      `Aucun POLAR_PRODUCT_${packId}_ID configuré dans les variables d'env pour le pack "${packId}".`
    );
  }
  return productId;
}

interface CreateCheckoutOptions {
  packId: CreditPackId;
  userId: string;
  email: string;
}

/**
 * Crée un checkout Polar pour un pack de crédits et renvoie l'URL de paiement.
 * Fonctionne autant en sandbox qu'en production (selon POLAR_ENV + les IDs).
 * Cette URL sera utilisée dans l'Embedded Checkout (pop-up dans ton site).
 */
export async function createPolarCheckout(options: CreateCheckoutOptions) {
  const { packId, userId, email } = options;

  const productId = getProductIdForPack(packId);

  const baseAppUrl =
    process.env.NEXT_PUBLIC_APP_URL || "http://localhost:3000";

  // 👉 utilisé pour la redirection *si tu laisses Polar rediriger*
  const successUrl = `${baseAppUrl}/app/credits?status=success&pack=${packId}`;
  const returnUrl = `${baseAppUrl}/app/credits?status=cancel`;

  // 👉 très important pour l'Embedded Checkout
  // Polar docs : embed_origin = origin de la page qui intègre le checkout :contentReference[oaicite:1]{index=1}
  const embedOrigin = baseAppUrl; // NEXT_PUBLIC_APP_URL doit être du style https://mon-site.com

  console.log("[Polar] Création checkout", {
    env: process.env.POLAR_ENV,
    packId,
    productId,
    userId,
    email,
    successUrl,
    returnUrl,
    embedOrigin,
  });

  const payload: any = {
    products: [productId],
    success_url: successUrl,
    return_url: returnUrl,
    embed_origin: embedOrigin,
    customer_email: email, // ⚠️ vrai email
    external_customer_id: userId,

    allow_discount_codes: true,
    require_billing_address: false,
    allow_trial: true,
    is_business_customer: false,
  };

  const checkout = await (polar as any).checkouts.create(payload);

  if (!checkout?.url) {
    console.error(
      "[Polar] Checkout créé mais pas d'URL dans la réponse:",
      checkout
    );
    throw new Error("Checkout Polar créé mais URL manquante.");
  }

  console.log("[Polar] Checkout URL:", checkout.url);

  return {
    url: checkout.url as string,
    checkout,
  };
}
````

## File: lib/recaptcha.ts
````typescript
"use client";

// lib/recaptcha.ts
export type VerifyResult =
  | { ok: true; score?: number }
  | { ok: false; reason: string; score?: number };

const DEFAULT_API_BASE =
  "https://europe-west1-assistant-ia-v4.cloudfunctions.net";

const API_BASE = (
  process.env.NEXT_PUBLIC_API_BASE_URL ||
  DEFAULT_API_BASE
).replace(/\/+$/, "");

/**
 * Normalise l'action pour éviter les mismatches (case-sensitive).
 * Choisis une convention et garde-la partout.
 */
function normalizeAction(action: string) {
  return (action || "").trim().toLowerCase();
}

function withTimeout<T>(p: Promise<T>, ms: number, reason: string): Promise<T> {
  return new Promise<T>((resolve, reject) => {
    const t = window.setTimeout(() => reject(new Error(reason)), ms);
    p.then((v) => {
      window.clearTimeout(t);
      resolve(v);
    }).catch((e) => {
      window.clearTimeout(t);
      reject(e);
    });
  });
}

/**
 * ✅ Version "non bloquante" :
 * - retourne un token si possible
 * - sinon retourne null (adblock, script bloqué, timeout, etc.)
 */
export async function tryGetRecaptchaToken(
  action: string
): Promise<string | null> {
  if (typeof window === "undefined") return null;

  const siteKey = process.env.NEXT_PUBLIC_RECAPTCHA_SITE_KEY;
  if (!siteKey) return null;

  const normalizedAction = normalizeAction(action);
  if (!normalizedAction) return null;

  const grecaptcha = (window as any).grecaptcha;

  try {
    // ✅ Enterprise
    if (grecaptcha?.enterprise) {
      await withTimeout<void>(
        new Promise<void>((resolve) => grecaptcha.enterprise.ready(resolve)),
        4000,
        "reCAPTCHA Enterprise ready timeout"
      );

      const token = await grecaptcha.enterprise.execute(siteKey, {
        action: normalizedAction,
      });

      return typeof token === "string" && token ? token : null;
    }

    // ✅ Fallback v3 (dev / autre config)
    if (
      typeof grecaptcha?.ready === "function" &&
      typeof grecaptcha?.execute === "function"
    ) {
      await withTimeout<void>(
        new Promise<void>((resolve) => grecaptcha.ready(resolve)),
        4000,
        "reCAPTCHA ready timeout"
      );

      const token = await grecaptcha.execute(siteKey, {
        action: normalizedAction,
      });
      return typeof token === "string" && token ? token : null;
    }

    return null;
  } catch {
    return null;
  }
}

/**
 * ✅ Version "stricte" (compat) : conserve ton ancien comportement
 * (utile si tu veux forcer reCAPTCHA dans certains écrans).
 */
export async function getRecaptchaToken(action: string): Promise<string> {
  const token = await tryGetRecaptchaToken(action);
  if (!token) {
    throw new Error("reCAPTCHA non chargé (script bloqué ? adblock ?)");
  }
  return token;
}

/**
 * Vérifie un token côté serveur (si tu gardes l'endpoint recaptchaVerify).
 */
export async function verifyRecaptcha(
  token: string,
  action: string
): Promise<VerifyResult> {
  const normalizedAction = normalizeAction(action);

  if (!token) return { ok: false, reason: "missing_token" };
  if (!normalizedAction) return { ok: false, reason: "missing_action" };

  try {
    const res = await fetch(`${API_BASE}/recaptchaVerify`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ token, action: normalizedAction }),
      cache: "no-store",
    });

    const data: any = await res.json().catch(() => ({}));

    if (!res.ok || !data?.ok) {
      return {
        ok: false,
        reason: String(
          data?.reason || data?.details?.reason || "recaptcha_failed"
        ),
        score:
          typeof data?.score === "number"
            ? data.score
            : typeof data?.details?.score === "number"
            ? data.details.score
            : undefined,
      };
    }

    return {
      ok: true,
      score: typeof data?.score === "number" ? data.score : undefined,
    };
  } catch {
    return { ok: false, reason: "network_error" };
  }
}
````

## File: lib/userTracking.ts
````typescript
// lib/userTracking.ts
import { User } from "firebase/auth";
import {
  collection,
  addDoc,
  doc,
  setDoc,
  increment,
} from "firebase/firestore";
import { db } from "@/lib/firebase";

/**
 * Infos IP / localisation
 */
type IpInfo = {
  ip: string;
  country: string;
  city: string;
};

// Cache en mémoire pour éviter d'appeler l'API à chaque fois
let ipInfoCache: IpInfo | null = null;
let ipInfoPromise: Promise<IpInfo | null> | null = null;

async function getIpInfo(): Promise<IpInfo | null> {
  if (ipInfoCache) return ipInfoCache;
  if (typeof window === "undefined") return null;

  if (ipInfoPromise) return ipInfoPromise;

  ipInfoPromise = (async () => {
    try {
      // API publique simple, tu peux la changer si besoin
      const res = await fetch("https://ipapi.co/json/");
      if (!res.ok) throw new Error("IP API error");
      const data = await res.json();
      const info: IpInfo = {
        ip: data.ip,
        country: data.country_name,
        city: data.city,
      };
      ipInfoCache = info;
      return info;
    } catch (e) {
      console.error("Erreur getIpInfo:", e);
      return null;
    } finally {
      ipInfoPromise = null;
    }
  })();

  return ipInfoPromise;
}

/**
 * Infos device / OS / navigateur
 * ➜ différencie iPhone / iPad / macOS / Android / Windows…
 */
type DeviceInfo = {
  deviceType: string; // "iphone" | "ipad" | "mac" | "mobile" | "tablet" | "desktop" | "unknown"
  os: string;
  browser: string;
};

function detectDeviceInfo(): DeviceInfo {
  if (typeof navigator === "undefined") {
    return { deviceType: "unknown", os: "unknown", browser: "unknown" };
  }

  const ua = navigator.userAgent || "";
  const lower = ua.toLowerCase();

  let deviceType = "unknown";
  let os = "unknown";
  let browser = "unknown";

  // --- OS + device ---
  if (/iphone/i.test(ua)) {
    deviceType = "iphone";
    os = "iOS";
  } else if (/ipad/i.test(ua)) {
    deviceType = "ipad";
    os = "iPadOS";
  } else if (/android/i.test(ua)) {
    os = "Android";
    deviceType = /mobile/i.test(ua) ? "mobile" : "tablet";
  } else if (/macintosh|mac os x/i.test(ua)) {
    os = "macOS";
    deviceType = "mac";
  } else if (/windows/i.test(ua)) {
    os = "Windows";
    deviceType = "desktop";
  } else if (/linux/i.test(ua)) {
    os = "Linux";
    deviceType = "desktop";
  }

  // --- navigateur ---
  if (lower.includes("edg/")) {
    browser = "Edge";
  } else if (lower.includes("opr/") || lower.includes("opera")) {
    browser = "Opera";
  } else if (lower.includes("firefox")) {
    browser = "Firefox";
  } else if (lower.includes("chrome") && !lower.includes("edge") && !lower.includes("opr")) {
    browser = "Chrome";
  } else if (lower.includes("safari") && !lower.includes("chrome")) {
    browser = "Safari";
  }

  return { deviceType, os, browser };
}

/**
 * Mise à jour du doc "users/{uid}" pour suivre :
 * - dernière activité
 * - dernière page
 * - IP / pays / ville
 * - device / OS / navigateur
 */
export async function updateLastActive(
  user: User,
  extra?: { path?: string; action?: string }
) {
  if (!user) return;

  try {
    const [ipInfo, device] = await Promise.all([
      getIpInfo(),
      Promise.resolve(detectDeviceInfo()),
    ]);

    const ref = doc(db, "users", user.uid);

    const path =
      extra?.path ??
      (typeof window !== "undefined"
        ? window.location.pathname + window.location.search
        : null);

    const now = Date.now();

    const payload: any = {
      email: user.email ?? null,
      displayName: user.displayName ?? null,
      lastSeenAt: now,
      lastSeenPage: path,
      lastDeviceType: device.deviceType,
      lastOs: device.os,
      lastBrowser: device.browser,
    };

    if (user.metadata?.lastSignInTime) {
      payload.lastLoginAt = new Date(
        user.metadata.lastSignInTime
      ).getTime();
    }

    if (ipInfo) {
      payload.lastSeenIp = ipInfo.ip;
      payload.lastSeenCountry = ipInfo.country;
      payload.lastSeenCity = ipInfo.city;
    }

    if (extra?.action) {
      payload.lastAction = extra.action;
      payload.lastActionAt = now;
    }

    await setDoc(ref, payload, { merge: true });
  } catch (e) {
    console.error("Erreur updateLastActive:", e);
  }
}

/**
 * Options pour les logs d’usage
 * - action = nom de l’évènement (ex: "lm_generate", "lm_download", "cv_generate")
 * - docType = "lm" | "cv" | "pitch"...
 * - eventType = "generate" | "download" | "view"...
 * - tool = comment tu catégorises ton outil (ex: "lm", "cv", "assistant")
 * - creditsDelta = variation de crédits (ex: -1 quand tu consommes 1 crédit)
 *
 * ➜ grâce à [key: string]: any, tu peux passer
 *    feature, template, lang, contract, targetJob, companyName, etc.
 */
export type LogUsageOptions = {
  tool?: string;
  docType?: "lm" | "cv" | "pitch" | string;
  eventType?: "generate" | "download" | "view" | "auth" | string;
  creditsDelta?: number;
  path?: string;
  meta?: Record<string, any>;
  // pour autoriser des clés libres (feature, template, lang, etc.)
  [key: string]: any;
};

/**
 * Log d’un événement important (appel IA, génération LM/CV, téléchargement…)
 * ➜ crée un doc dans usageLogs
 * ➜ met à jour les compteurs dans users
 *
 * Tous les champs supplémentaires (feature, template, lang, jobTitle, etc.)
 * sont rangés dans log.meta.
 */
export async function logUsage(
  user: User | null,
  action: string,
  options?: LogUsageOptions
) {
  if (!user) return;

  try {
    const [ipInfo, device] = await Promise.all([
      getIpInfo(),
      Promise.resolve(detectDeviceInfo()),
    ]);

    const now = Date.now();

    // On extrait les options "connues" et on met le reste dans `rest`
    const {
      tool,
      docType,
      eventType,
      creditsDelta,
      path: optPath,
      meta,
      ...rest
    } = options ?? {};

    const path =
      optPath ??
      (typeof window !== "undefined"
        ? window.location.pathname + window.location.search
        : null);

    // --- 1) Créer un document dans usageLogs ---
    const log: any = {
      userId: user.uid,
      email: user.email ?? null,
      action,
      tool: tool ?? null,
      docType: docType ?? null,
      eventType: eventType ?? null,
      createdAt: now,
      path,
      creditsDelta:
        typeof creditsDelta === "number" ? creditsDelta : null,
      deviceType: device.deviceType,
      os: device.os,
      browser: device.browser,
    };

    if (ipInfo) {
      log.ip = ipInfo.ip;
      log.country = ipInfo.country;
      log.city = ipInfo.city;
    }

    // Fusionne meta + toutes les autres clés libres (feature, template, ...)
    if (meta || Object.keys(rest).length > 0) {
      log.meta = {
        ...(meta || {}),
        ...rest,
      };
    }

    const logsRef = collection(db, "usageLogs");
    await addDoc(logsRef, log);

    // --- 2) Mettre à jour les compteurs dans users/{uid} ---
    const userRef = doc(db, "users", user.uid);

    const update: any = {
      lastSeenAt: now,
      lastSeenPage: path,
      lastDeviceType: device.deviceType,
      lastOs: device.os,
      lastBrowser: device.browser,
    };

    if (ipInfo) {
      update.lastSeenIp = ipInfo.ip;
      update.lastSeenCountry = ipInfo.country;
      update.lastSeenCity = ipInfo.city;
    }

    const inc: any = {};

    // Appels IA
    if (tool) {
      inc.totalIaCalls = increment(1);
    }

    // Documents générés
    if (docType) {
      inc.totalDocumentsGenerated = increment(1);
      if (docType === "lm") {
        inc.totalLmGenerated = increment(1);
      }
      if (docType === "cv") {
        inc.totalCvGenerated = increment(1);
      }
    }

    // Crédits consommés / ajoutés
    if (typeof creditsDelta === "number") {
      inc.credits = increment(creditsDelta);
    }

    Object.assign(update, inc);

    await setDoc(userRef, update, { merge: true });
  } catch (e) {
    console.error("Erreur logUsage:", e);
  }
}
````

## File: public/manifest.webmanifest
````
{
  "name": "SmartCV",
  "short_name": "SmartCV",
  "start_url": "/",
  "display": "standalone",
  "background_color": "#020617",
  "theme_color": "#0ea5e9",
  "icons": []
}
````

## File: types/cv.ts
````typescript
// types/cv.ts

export type CvSkills = {
  // Compétences métier (finance, RH, IT, marketing, etc.)
  domain?: string[];
  // Outils / logiciels (Excel, Word, PowerPoint, SAP, Canva, etc.)
  tools?: string[];
};

export type CvExperience = {
  company?: string;
  role?: string;
  location?: string;
  dates?: string;
  bullets?: string[];
};

export type CvProfile = {
  fullName?: string;
  email?: string;
  phone?: string;
  linkedin?: string;
  contractType?: string;

  // Résumé court du profil (max 3 phrases)
  profileSummary?: string;

  // Ligne compacte pour les langues : "Français (natif) · Anglais (B2 – TOEIC) · ..."
  langLine?: string;

  skills?: CvSkills;

  // Formation courte, lignes prêtes à afficher
  // ex: "2022–2024 · MSc Expert Financier – ESAM, Paris"
  educationShort?: string[];

  // Certifications principales
  certifications?: string[];

  // Centres d'intérêt détaillés
  interests?: string[];

  // Centres d'intérêt sur une seule ligne : "Musique, piano, voyages, ..."
  interestsLine?: string;

  // Expériences détaillées (utile plus tard pour les LM, pitch, etc.)
  experiences?: CvExperience[];
};

export type CvApiResponse = {
  success: boolean;
  profile?: CvProfile;
  error?: string;
};
````

## File: .env.local
````
GEMINI_API_KEY=AIzaSyDo4t-q7boav3fUOL_hvxfhm6O9pMR2L04
GEMINI_MODEL=models/gemini-2.5-flash
NEXT_PUBLIC_API_BASE_URL=https://europe-west1-assistant-ia-v4.cloudfunctions.net
ADZUNA_APP_ID=d0ca97ff
ADZUNA_APP_KEY=eae26a8b844bdde5ff3672b7a8e43970

POLAR_ACCESS_TOKEN=polar_oat_HDHIQiwJsP5JCcHWlbAudN4VFHvotix2teA9v0TNEJW
POLAR_WEBHOOK_SECRET=polar_whs_3C6xUFewJuBoIoDO0iy2tIdGElBYmUYgyAdg42zwUjk
POLAR_ENV=sandbox

PPOLAR_PRODUCT_100_ID=1763420a-d2d7-42f7-af2d-7755da543d74
POLAR_PRODUCT_20_ID=ef5c6b96-e40e-4f4a-85a1-1cecaf390f83
POLAR_PRODUCT_50_ID=1d624448-9f7e-4658-a88d-e2ed9a6d64f7



NEXT_PUBLIC_API_BASE_URL=https://europe-west1-assistant-ia-v4.cloudfunctions.net
NEXT_PUBLIC_APP_URL=http://localhost:3000
NEXT_PUBLIC_RECAPTCHA_SITE_KEY=6Ld4EDAsAAAAACiYb8q1Csvn1-fnKJGEdeMG_T3i
````

## File: .firebaserc
````
{
  "projects": {
    "a": "assistant-ia-v4"
  },
  "targets": {},
  "etags": {}
}
````

## File: api.txt
````
SMTP et API
Serveur SMTP
smtp-relay.brevo.com
Port
587
Connexion
9c1210001@smtp-brevo.com
STARTTLS
key: bskt8NcPaWFVZUh

firebase functions:config:set smtp.host="smtp-relay.brevo.com"
firebase functions:config:set smtp.port="587"
firebase functions:config:set smtp.secure="false"
firebase functions:config:set smtp.user="9c1210001@smtp-brevo.com"
firebase functions:config:set smtp.pass="bskt8NcPaWFVZUh"
firebase functions:config:set smtp.from='"Assistant IA" <aakane0105@gmail.com>'
firebase functions:config:set smtp.from='"Assistant IA" <no-reply@tondomaine.com>'
firebase functions:config:set smtp.from='"Assistant IA" <no-reply@assistant-ia-v4.com>'
````

## File: firebase.json
````json
{
  "hosting": {
    "site": "assistant-ia-v4",
    "public": "out",
    "ignore": [
      "firebase.json",
      "**/.*",
      "**/node_modules/**"
    ],
    "rewrites": [
      {
        "source": "/api/interview",
        "function": "interview"
      },
      {
        "source": "/api/extractProfile",
        "function": "extractProfile"
      },
      {
        "source": "/api/polar/webhook",
        "function": "polarWebhook"
      },
      {
        "source": "/api/jobs",
        "function": "jobs"
      },
      {
        "source": "**",
        "destination": "/index.html"
      }
    ],
    "cleanUrls": true,
    "trailingSlash": false
  },
  "firestore": {
    "rules": "firestore.rules",
    "indexes": "firestore.indexes.json"
  },
  "functions": {
    "source": "functions"
  }
}
````

## File: firestore.indexes.json
````json
{
  "indexes": [
    {
      "collectionGroup": "applications",
      "queryScope": "COLLECTION",
      "fields": [
        { "fieldPath": "userId", "order": "ASCENDING" },
        { "fieldPath": "createdAt", "order": "DESCENDING" }
      ]
    }
  ],
  "fieldOverrides": []
}
````

## File: firestore.rules
````
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helpers ---
    function isSignedIn() {
      return request.auth != null;
    }

    function isAdmin() {
      return isSignedIn() && (
        request.auth.token.isAdmin == true ||
        request.auth.token.email == "aakane0105@gmail.com"
      );
    }

    // --- COLLECTION users ---
    match /users/{userId} {
      // L'utilisateur peut lire/écrire uniquement SON doc
      allow read, write: if isSignedIn() && request.auth.uid == userId;

      // L'admin peut tout lire/écrire
      allow read, write: if isAdmin();
    }

    // --- COLLECTION profiles ---
    match /profiles/{userId} {
      // L'utilisateur gère son profil
      allow read, write: if isSignedIn() && request.auth.uid == userId;

      // Admin peut tout lire/écrire
      allow read, write: if isAdmin();
    }

    // --- COLLECTION applications ---
    match /applications/{appId} {
      // Création d'une candidature : userId dans le doc = auth.uid
      allow create: if isSignedIn()
        && request.resource.data.userId == request.auth.uid;

      // Lecture / update / delete par le propriétaire
      allow read, update, delete: if isSignedIn()
        && resource.data.userId == request.auth.uid;

      // Admin : lecture/écriture si besoin (stats, corrections, etc.)
      allow read, write: if isAdmin();
    }

    // --- COLLECTION usageLogs ---
    match /usageLogs/{logId} {
      // 1) logs normaux d'un user connecté (LM, CV, etc.)
      // 2) logs d'échec de connexion (auth_failed) AVANT login (pas d'auth)
      allow create: if
        (
          isSignedIn() &&
          request.resource.data.userId == request.auth.uid
        )
        ||
        (
          !isSignedIn() &&
          request.resource.data.action == "auth_failed"
        );

      // lecture / modif / suppression : admin uniquement
      allow read, update, delete: if isAdmin();
    }

    // --- CATCH-ALL ADMIN ---
    match /{document=**} {
      allow read, write: if isAdmin();
    }
  }
}
````

## File: next-env.d.ts
````typescript
/// <reference types="next" />
/// <reference types="next/image-types/global" />

// NOTE: This file should not be edited
// see https://nextjs.org/docs/app/building-your-application/configuring/typescript for more information.
````

## File: next.config.mjs
````javascript
/** @type {import('next').NextConfig} */
const nextConfig = {
  // On demande à Next de générer un site statique dans `out/`
  output: "export",

  // Utile si tu utilises `next/image` (sinon tu peux enlever)
  images: {
    unoptimized: true,
  },
};

export default nextConfig;
````

## File: package.json
````json
{
  "name": "assistant-candidatures",
  "version": "1.0.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "next lint"
  },
  "dependencies": {
    "@polar-sh/checkout": "^0.1.14",
    "@polar-sh/sdk": "^0.41.5",
    "aos": "^2.3.4",
    "chart.js": "^4.5.1",
    "firebase": "^12.7.0",
    "firebase-admin": "^13.6.0",
    "firebase-functions": "^7.0.2",
    "framer-motion": "^11.0.0",
    "next": "^14.2.35",
    "next-intl": "^4.5.5",
    "node-fetch": "^3.3.2",
    "openai": "^6.10.0",
    "react": "18.2.0",
    "react-dom": "18.2.0"
  },
  "devDependencies": {
    "@types/aos": "^3.0.7",
    "@types/node": "^20.12.7",
    "@types/react": "^18.2.66",
    "autoprefixer": "^10.4.19",
    "postcss": "^8.4.38",
    "tailwindcss": "^3.4.4",
    "typescript": "^5.5.0"
  }
}
````

## File: postcss.config.js
````javascript
module.exports = {
  plugins: {
    tailwindcss: {},
    autoprefixer: {}
  }
};
````

## File: setAdmin.js
````javascript
// setAdmin.js
const admin = require("firebase-admin");
const serviceAccount = require("./serviceAccountKey.json");

admin.initializeApp({
  credential: admin.credential.cert(serviceAccount),
});

async function main() {
  // 👉 Mets ici l'email EXACT utilisé dans Firebase Authentication
  const email = "aakane0105@gmail.com"; // <--- NE PAS OUBLIER LE GUILLEMET DE FIN

  try {
    // On récupère l'utilisateur via son email
    const userRecord = await admin.auth().getUserByEmail(email);
    console.log("Utilisateur trouvé ✅");
    console.log("UID :", userRecord.uid);
    console.log("Email :", userRecord.email);

    // On lui ajoute le rôle admin
    await admin.auth().setCustomUserClaims(userRecord.uid, { isAdmin: true });

    console.log("✅ isAdmin = true pour :", userRecord.uid);
  } catch (err) {
    console.error("Erreur setAdmin:", err);
  }
}

main();
````

## File: syncAuthUsersToFirestore.js
````javascript
// syncAuthUsersToFirestore.js
//
// Script une fois pour toutes : synchronise tous les comptes Firebase Auth
// vers la collection Firestore "users", pour qu'ils apparaissent dans ton admin.

const admin = require("firebase-admin");
const serviceAccount = require("./serviceAccountKey.json");

admin.initializeApp({
  credential: admin.credential.cert(serviceAccount),
});

const db = admin.firestore();

function toMillis(str) {
  if (!str) return null;
  const t = Date.parse(str);
  return Number.isNaN(t) ? null : t;
}

async function syncAllUsers(nextPageToken) {
  const result = await admin.auth().listUsers(1000, nextPageToken);

  for (const user of result.users) {
    const uid = user.uid;
    const ref = db.collection("users").doc(uid);
    const snap = await ref.get();

    const baseData = {
      email: user.email || null,
      displayName: user.displayName || null,
      emailVerified: user.emailVerified || false,
      provider:
        (user.providerData[0] && user.providerData[0].providerId) ||
        "password",
      createdAt: toMillis(user.metadata.creationTime) || Date.now(),
      lastLoginAt: toMillis(user.metadata.lastSignInTime) || null,
    };

    if (!snap.exists) {
      // Nouveau doc user créé
      await ref.set({
        ...baseData,
        credits: 0,
        blocked: false,
      });
      console.log("✅ Créé doc users pour", uid, baseData.email);
    } else {
      // Doc déjà existant → on ne touche pas aux crédits / blocked
      await ref.set(baseData, { merge: true });
      console.log("🔁 Mis à jour doc users pour", uid, baseData.email);
    }
  }

  if (result.pageToken) {
    await syncAllUsers(result.pageToken);
  }
}

async function main() {
  await syncAllUsers();
  console.log("🎉 Sync terminé");
  process.exit(0);
}

main().catch((err) => {
  console.error("Erreur syncAllUsers:", err);
  process.exit(1);
});
````

## File: tailwind.config.js
````javascript
/** @type {import('tailwindcss').Config} */
module.exports = {
  content: [
    "./app/**/*.{js,ts,jsx,tsx}",
    "./components/**/*.{js,ts,jsx,tsx}"
  ],
  theme: {
    extend: {}
  },
  plugins: []
}
````

## File: tsconfig.json
````json
{
  "compilerOptions": {
    "target": "ESNext",
    "lib": [
      "DOM",
      "DOM.Iterable",
      "ESNext"
    ],
    "allowJs": false,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "ESNext",
    "moduleResolution": "Node",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "preserve",
    "paths": {
      "@/*": [
        "./*"
      ]
    },
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ]
  },
  "include": [
    "next-env.d.ts",
    "**/*.ts",
    "**/*.tsx",
    ".next/types/**/*.ts"
  ],
  "exclude": [
    "node_modules"
  ]
}
````
