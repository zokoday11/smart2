This file is a merged representation of the entire codebase, combined into a single document by Repomix.

# File Summary

## Purpose
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.

## File Format
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  a. A header with the file path (## File: path/to/file)
  b. The full contents of the file in a code block

## Usage Guidelines
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.

## Notes
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)

# Directory Structure
```
.firebase/hosting.b3V0.cache
.firebase/hosting.Lm5leHQ.cache
.firebaserc
.gitignore
api.txt
app/admin/login/page.tsx
app/admin/logs/page.tsx
app/admin/page.tsx
app/app/apply/page.tsx
app/app/credits/page.tsx
app/app/cv/page.tsx
app/app/history/page.tsx
app/app/interview/page.tsx
app/app/layout.tsx
app/app/lm/page.tsx
app/app/page.tsx
app/app/pitch/page.tsx
app/app/settings/page.tsx
app/app/tracker/page.tsx
app/assistance-candidature/page.tsx
app/auth/verify-email/page.tsx
app/debug/polar/page.tsx
app/forgot-password/page.tsx
app/globals.css
app/layout.tsx
app/login/page.tsx
app/not-found.tsx
app/page.tsx
app/signup/page.tsx
app/tech/page.tsx
components/ActivityTracker.tsx
components/AOSProvider.tsx
components/assistant/CvPdfEditorModal.tsx
components/assistant/CvTemplatePicker.tsx
components/BlockedOverlay.tsx
components/BuyCreditsButtons.tsx
components/CvTemplatePicker.tsx
components/HeroPage.tsx
components/I18nClientProvider.tsx
components/InterviewChat.tsx
components/LandingFeatures.tsx
components/LandingHero.tsx
components/LandingPage.tsx
components/LandingStack.tsx
components/layout/AppHeader.tsx
components/layout/AppLayout.tsx
components/layout/MobileBottomNav.tsx
components/PaymentHeader.jsx
components/pdf/PdfEditorModal.tsx
components/pdf/PdfViewer.tsx
components/PolarCheckoutModal.jsx
components/SidebarUser.tsx
components/TopbarUser.tsx
components/ui/DebugI18nTheme.tsx
components/ui/Starfield.tsx
components/ui/ThemeLangSwitcher.tsx
components/user/CreditsBadge.tsx
context/AuthContext.tsx
context/CreditsContext.tsx
context/I18nContext.tsx
context/LangContext.tsx
context/ThemeContext.tsx
find-bad-tailwind.mjs
firebase.json
firestore.indexes.json
firestore.rules
functions/index.js
functions/package.json
functions/recaptcha-interview.js
hooks/useAdminGuard.ts
hooks/useRechargeHistory.ts
hooks/useUserCredits.ts
hooks/useUserProfile.ts
lib/apiClient.ts
lib/auth.ts
lib/credits.ts
lib/firebase.ts
lib/firebaseAdmin.ts
lib/firestore.ts
lib/gemini.ts
lib/i18n.ts
lib/interviewPrompt.ts
lib/ipLocation.ts
lib/linkedin.ts
lib/logAuthFailed.ts
lib/logUsage.ts
lib/pdf/colors.ts
lib/pdf/fitOnePage.ts
lib/pdf/generateCvLm.ts
lib/pdf/mergePdfs.ts
lib/pdf/pdfmakeClient.ts
lib/pdf/templates/cvAts.ts
lib/pdf/templates/cvTemplates.ts
lib/pdf/templates/letter.ts
lib/pdf/templates/types.ts
lib/polar-checkout.ts
lib/polar.ts
lib/recaptcha.ts
lib/server/credits.ts
lib/userTracking.ts
next-env.d.ts
next.config.mjs
package.json
postcss.config.js
public/cv-templates/cv-previews-grid-new.png
public/cv-templates/cv-template-academic.png
public/cv-templates/cv-template-ats.png
public/cv-templates/cv-template-classic.png
public/cv-templates/cv-template-compact.png
public/cv-templates/cv-template-consulting.png
public/cv-templates/cv-template-creative.png
public/cv-templates/cv-template-elegant-color.png
public/cv-templates/cv-template-elegant.png
public/cv-templates/cv-template-executive.png
public/cv-templates/cv-template-minimalist.png
public/cv-templates/cv-template-modern.png
public/cv-templates/cv-template-pro-max.png
public/cv-templates/cv-template-projects.png
public/cv-templates/cv-template-sales.png
public/cv-templates/cv-template-skills-matrix.png
public/cv-templates/cv-template-startup.png
public/cv-templates/cv-template-tech.png
public/cv-templates/cv-template-timeline.png
public/cv-templates/cv-template-two-column.png
public/locales/en/common.json
public/locales/fr/common.json
public/manifest.webmanifest
server/_api_disabled/api/extractProfile/route.ts
server/_api_disabled/api/generate-cv/generate-letter/route.ts
server/_api_disabled/api/generate-cv/route.ts
server/_api_disabled/api/generate-zip/route.ts
server/_api_disabled/api/generateInterviewQA/route.ts
server/_api_disabled/api/generateLetterAndPitch/route.ts
server/_api_disabled/api/interview/route.ts
server/_api_disabled/api/jobs/route.ts
server/_api_disabled/api/letterAndPitch/route.ts
server/_api_disabled/api/linkedin/exchange/route.ts
server/_api_disabled/api/linkedin/token/route.ts
server/_api_disabled/api/polar/checkout/route.ts
server/_api_disabled/api/polar/test/route.ts
server/_api_disabled/api/stt/route.ts
server/_api_disabled/api/webhook/polar/route.ts
setAdmin.js
syncAuthUsersToFirestore.js
tailwind.config.js
tsconfig.json
types/cv.ts
```

# Files

## File: find-bad-tailwind.mjs
````javascript
import fs from "fs";
import path from "path";

const TARGETS = [
  path.join(process.cwd(), "app", "globals.css"),
  path.join(process.cwd(), "src", "app", "globals.css"),
];

const patterns = [
  { name: "BAD_SELECTOR", re: /\.\\\[-\\:\\\|\\\]/g },     // .\[-:\|\]
  { name: "BAD_PROPERTY", re: /^\s*-:\s*\|;\s*$/gm },      // -: |;
  { name: "JS_IN_CSS", re: /const\s+nextConfig|export\s+default\s+nextConfig/g },
  { name: "JSON_IN_CSS", re: /"name"\s*:\s*"assistant-candidatures"/g },
];

function contextLines(lines, idx, span = 3) {
  const start = Math.max(0, idx - span);
  const end = Math.min(lines.length, idx + span + 1);
  return lines
    .slice(start, end)
    .map((l, i) => `${String(start + i + 1).padStart(5, " ")} | ${l}`)
    .join("\n");
}

let foundAny = false;

for (const file of TARGETS) {
  if (!fs.existsSync(file)) continue;

  const text = fs.readFileSync(file, "utf8");
  const lines = text.split(/\r?\n/);

  console.log(`\n▶ Scan: ${path.relative(process.cwd(), file)}`);

  for (const p of patterns) {
    const matches = [...text.matchAll(p.re)];
    if (matches.length === 0) continue;

    foundAny = true;
    console.log(`\n❌ Found ${p.name} (${matches.length} match(es))`);

    // Affiche le contexte des 3 premiers hits
    for (const m of matches.slice(0, 3)) {
      const pos = m.index ?? 0;
      const before = text.slice(0, pos);
      const lineIdx = before.split(/\r?\n/).length - 1;
      console.log("\n" + contextLines(lines, lineIdx, 4));
    }
  }
}

if (foundAny) {
  console.error("\n⛔ CSS invalide détecté. Corrige globals.css (ou lance fix-globals).");
  process.exit(1);
} else {
  console.log("\n✅ Aucun pattern suspect trouvé.");
}
````

## File: server/_api_disabled/api/extractProfile/route.ts
````typescript
import { NextResponse } from "next/server";

const UPSTREAM =
  process.env.EXTRACT_PROFILE_UPSTREAM ||
  "https://europe-west1-assistant-ia-v4.cloudfunctions.net/extractProfile";

export async function POST(req: Request) {
  const auth = req.headers.get("authorization") || "";
  const recaptcha = req.headers.get("x-recaptcha-token") || "";

  const body = await req.json().catch(() => null);

  if (!body || !body.base64Pdf) {
    return NextResponse.json(
      { error: "Champ 'base64Pdf' manquant." },
      { status: 400 }
    );
  }

  const upstreamRes = await fetch(UPSTREAM, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      ...(auth ? { Authorization: auth } : {}),
      ...(recaptcha ? { "X-Recaptcha-Token": recaptcha } : {}),
    },
    body: JSON.stringify(body),
    cache: "no-store",
  });

  const text = await upstreamRes.text();
  const contentType =
    upstreamRes.headers.get("content-type") || "application/json";

  return new NextResponse(text, {
    status: upstreamRes.status,
    headers: { "Content-Type": contentType },
  });
}
````

## File: server/_api_disabled/api/generate-cv/generate-letter/route.ts
````typescript
import { NextResponse } from "next/server";
import { getApps, initializeApp, applicationDefault, cert } from "firebase-admin/app";
import { getAuth } from "firebase-admin/auth";
import { getFirestore, FieldValue } from "firebase-admin/firestore";

export const runtime = "nodejs";

function getAdminApp() {
  if (getApps().length) return getApps()[0];

  const projectId = process.env.FIREBASE_ADMIN_PROJECT_ID || process.env.FIREBASE_PROJECT_ID;
  const clientEmail = process.env.FIREBASE_ADMIN_CLIENT_EMAIL;
  const privateKeyRaw = process.env.FIREBASE_ADMIN_PRIVATE_KEY;

  if (projectId && clientEmail && privateKeyRaw) {
    const privateKey = privateKeyRaw.replace(/\\n/g, "\n");
    return initializeApp({
      credential: cert({ projectId, clientEmail, privateKey }),
    });
  }

  return initializeApp({
    credential: applicationDefault(),
  });
}

async function requireUser(req: Request) {
  getAdminApp();

  const authHeader = req.headers.get("authorization") || "";
  const token = authHeader.startsWith("Bearer ") ? authHeader.slice(7).trim() : "";

  if (!token) {
    return { ok: false as const, status: 401, error: "Missing Authorization Bearer token" };
  }

  try {
    const decoded = await getAuth().verifyIdToken(token);
    return { ok: true as const, uid: decoded.uid, email: decoded.email || "" };
  } catch (e) {
    console.error("verifyIdToken error:", e);
    return { ok: false as const, status: 401, error: "Invalid token" };
  }
}

async function consumeCreditsAndLog(params: {
  uid: string;
  email: string;
  cost: number;
  tool: string;
  docType: "cv" | "lm" | "other";
  meta?: any;
}) {
  getAdminApp();
  const db = getFirestore();

  const userRef = db.collection("users").doc(params.uid);
  const usageRef = db.collection("usageLogs").doc();
  const now = Date.now();

  await db.runTransaction(async (tx) => {
    const snap = await tx.get(userRef);
    const data = snap.exists ? snap.data() || {} : {};
    const currentCredits = typeof data.credits === "number" ? data.credits : 0;

    if (currentCredits < params.cost) {
      const err: any = new Error("NO_CREDITS");
      err.code = "NO_CREDITS";
      throw err;
    }

    tx.set(
      userRef,
      {
        credits: currentCredits - params.cost,
        totalIaCalls: FieldValue.increment(1),
        totalDocumentsGenerated: FieldValue.increment(params.docType === "cv" || params.docType === "lm" ? 1 : 0),
        totalCvGenerated: FieldValue.increment(params.docType === "cv" ? 1 : 0),
        totalLmGenerated: FieldValue.increment(params.docType === "lm" ? 1 : 0),
        updatedAt: FieldValue.serverTimestamp(),
      },
      { merge: true }
    );

    tx.set(
      usageRef,
      {
        userId: params.uid,
        email: params.email || "",
        action: "generate_document",
        docType: params.docType,
        eventType: "generate",
        tool: params.tool,
        creditsDelta: -params.cost,
        meta: params.meta || null,
        createdAt: now,
        createdAtServer: FieldValue.serverTimestamp(),
      },
      { merge: true }
    );
  });
}

function buildProfileContextForIA(profile: any) {
  const p = profile || {};

  let skillsArr: any[] = [];
  if (Array.isArray(p.skills)) {
    skillsArr = p.skills;
  } else if (p.skills && typeof p.skills === "object") {
    if (Array.isArray(p.skills.sections)) {
      p.skills.sections.forEach((sec: any) => {
        if (Array.isArray(sec.items)) skillsArr = skillsArr.concat(sec.items);
      });
    }
    if (Array.isArray(p.skills.tools)) skillsArr = skillsArr.concat(p.skills.tools);
  }

  const skillsStr = (skillsArr || []).join(", ");

  const expStr = Array.isArray(p.experiences)
    ? p.experiences
        .map(
          (e: any) =>
            `${e.role || e.title || ""} chez ${e.company || ""} (${e.dates || ""}): ${(e.bullets || []).join(" ")}`
        )
        .join("; \n")
    : "";

  const eduStr = Array.isArray(p.education)
    ? p.education
        .map((e: any) => `${e.degree || e.title || ""} - ${e.school || e.institution || ""} (${e.dates || ""})`)
        .join("; \n")
    : "";

  return `Nom: ${p.fullName || p.name || ""}
Titre: ${p.profileHeadline || p.title || ""}
Contact: ${p.email || ""} | ${p.phone || ""} | ${p.linkedin || ""} | ${p.city || ""}
Résumé de profil: ${p.profileSummary || p.summary || ""}
Compétences: ${skillsStr}
Expériences: 
${expStr}
Formations: 
${eduStr}
Certifications: ${p.certs || ""}
Langues: ${p.langLine || p.lang || ""}`.trim();
}

async function callGeminiText(prompt: string, apiKey: string, temperature = 0.7, maxOutputTokens = 2400) {
  const endpoint = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent";

  const body = {
    contents: [{ role: "user", parts: [{ text: prompt }] }],
    generationConfig: { temperature, maxOutputTokens },
  };

  const resp = await fetch(endpoint, {
    method: "POST",
    headers: { "Content-Type": "application/json", "x-goog-api-key": apiKey },
    body: JSON.stringify(body),
  });

  if (!resp.ok) {
    const errorText = await resp.text();
    throw new Error("Erreur Gemini (texte): " + errorText);
  }

  const data = await resp.json();
  const parts = data?.candidates?.[0]?.content?.parts || [];
  const text = parts
    .map((p: any) => (typeof p.text === "string" ? p.text : ""))
    .join("\n")
    .trim();

  if (!text) throw new Error("Réponse Gemini (texte) vide");
  return text;
}

function buildFallbackLetterAndPitch(profile: any, jobTitle: string, companyName: string, jobDescription: string, lang: string) {
  const p = profile || {};
  const name = p.fullName || "";
  const primaryDomain = p.primaryDomain || "";
  const summary = p.profileSummary || "";
  const firstExp = Array.isArray(p.experiences) && p.experiences.length ? p.experiences[0] : null;
  const role = firstExp?.role || firstExp?.title || "";
  const company = firstExp?.company || "";
  const years = Array.isArray(p.experiences) && p.experiences.length > 0 ? p.experiences.length : null;

  if (lang === "en") {
    return {
      pitch:
        summary ||
        `I am ${name || "a candidate"} with ${years ? years + " years of experience" : "solid experience"} in ${
          primaryDomain || "my field"
        }, motivated by the ${jobTitle || "role"} at ${companyName || "your company"}.`,
      coverLetter: `I am writing to express my interest in the position of ${jobTitle || "your advertised role"}. With ${
        years ? years + " years of experience" : "solid experience"
      } in ${primaryDomain || "my field"}, I have developed strong skills relevant to this opportunity.

In my previous experience at ${company || "my last company"}, I contributed to projects with measurable impact and collaborated with different stakeholders.

I would be delighted to discuss how I can contribute to your team.`,
    };
  }

  return {
    pitch:
      summary ||
      `Je suis ${name || "un(e) candidat(e)"} avec ${
        years ? years + " ans d’expérience" : "une solide expérience"
      } ${primaryDomain ? "dans " + primaryDomain : ""}, motivé(e) par le poste de ${
        jobTitle || "votre poste"
      } chez ${companyName || "votre entreprise"}.`,
    coverLetter: `Je vous écris pour vous faire part de mon intérêt pour le poste de ${jobTitle || "..."} au sein de ${
      companyName || "votre entreprise"
    }. Avec ${years ? years + " ans d’expérience" : "une expérience significative"} ${
      primaryDomain ? "dans " + primaryDomain : "dans mon domaine"
    }, j’ai développé des compétences solides en ${role || "gestion de projets, collaboration et suivi d’objectifs"}.

Je serais ravi(e) d’échanger plus en détail lors d’un entretien.`,
  };
}

export async function POST(req: Request) {
  const auth = await requireUser(req);
  if (!auth.ok) return NextResponse.json({ ok: false, error: auth.error }, { status: auth.status });

  let body: any = null;
  try {
    body = await req.json();
  } catch {
    return NextResponse.json({ ok: false, error: "Invalid JSON body" }, { status: 400 });
  }

  const profile = body?.profile;
  const jobDescription = body?.jobDescription || "";
  const jobTitle = body?.jobTitle || "";
  const companyName = body?.companyName || "";
  const langRaw = body?.lang || "fr";
  const lang = String(langRaw).toLowerCase().startsWith("en") ? "en" : "fr";

  if (!profile) return NextResponse.json({ ok: false, error: "Missing profile" }, { status: 400 });
  if (!jobTitle && !jobDescription) {
    return NextResponse.json(
      { ok: false, error: "Ajoute au moins l'intitulé du poste ou un extrait de la description." },
      { status: 400 }
    );
  }

  // ✅ Débit -1 crédit + log
  try {
    await consumeCreditsAndLog({
      uid: auth.uid,
      email: auth.email,
      cost: 1,
      tool: "generateLetterAndPitch",
      docType: "lm",
      meta: { jobTitle, companyName, lang },
    });
  } catch (e: any) {
    if (e?.code === "NO_CREDITS" || e?.message === "NO_CREDITS") {
      return NextResponse.json({ ok: false, error: "NO_CREDITS" }, { status: 402 });
    }
    console.error("consumeCreditsAndLog error:", e);
    return NextResponse.json({ ok: false, error: "CREDITS_ERROR" }, { status: 500 });
  }

  const GEMINI_API_KEY = process.env.GEMINI_API_KEY || "";

  const cvText = buildProfileContextForIA(profile);

  if (!GEMINI_API_KEY) {
    const fb = buildFallbackLetterAndPitch(profile, jobTitle, companyName, jobDescription, lang);
    return NextResponse.json({ ok: true, coverLetter: fb.coverLetter, pitch: fb.pitch, lang }, { status: 200 });
  }

  const prompt =
    lang === "en"
      ? `You are a senior career coach and recruiter.

Return STRICTLY valid JSON:
{ "coverLetter": "string", "pitch": "string" }

COVER LETTER RULES:
- "coverLetter" must be ONLY the BODY (no header, no subject, no greeting, no signature).
- 3 to 5 short paragraphs separated by a blank line.
- Do not invent facts, companies, tools, numbers.
- Use ONLY the candidate profile and the job description.

CANDIDATE PROFILE (source of truth):
${cvText}

JOB DESCRIPTION:
${jobDescription || "—"}

JOB TITLE: ${jobTitle || "the role"}
COMPANY: ${companyName || "your company"}`
      : `Tu es un coach carrières senior et recruteur.

Retourne STRICTEMENT un JSON valide :
{ "coverLetter": "string", "pitch": "string" }

RÈGLES LETTRE :
- "coverLetter" = UNIQUEMENT le CORPS (pas d’en-tête, pas d’objet, pas de formule d’appel, pas de signature).
- 3 à 5 paragraphes séparés par une ligne vide.
- Ne pas inventer (entreprises/outils/chiffres).
- Utilise UNIQUEMENT le profil candidat + la fiche de poste.

PROFIL CANDIDAT (source de vérité) :
${cvText}

FICHE DE POSTE :
${jobDescription || "—"}

INTITULÉ : ${jobTitle || "le poste"}
ENTREPRISE : ${companyName || "votre entreprise"}`;

  let coverLetter = "";
  let pitch = "";

  try {
    const raw = await callGeminiText(prompt, GEMINI_API_KEY, 0.7, 2200);
    const cleaned = String(raw).replace(/```json|```/gi, "").trim();

    let parsed: any = null;
    try {
      parsed = JSON.parse(cleaned);
    } catch {
      parsed = { coverLetter: cleaned, pitch: "" };
    }

    coverLetter = typeof parsed.coverLetter === "string" ? parsed.coverLetter.trim() : "";
    pitch = typeof parsed.pitch === "string" ? parsed.pitch.trim() : "";
  } catch (e) {
    console.error("Gemini generateLetterAndPitch error:", e);
  }

  if (!coverLetter || !pitch) {
    const fb = buildFallbackLetterAndPitch(profile, jobTitle, companyName, jobDescription, lang);
    if (!coverLetter) coverLetter = fb.coverLetter;
    if (!pitch) pitch = fb.pitch;
  }

  return NextResponse.json({ ok: true, coverLetter, pitch, lang }, { status: 200 });
}
````

## File: server/_api_disabled/api/generate-cv/route.ts
````typescript
import { NextResponse } from "next/server";

export const runtime = "nodejs";
// ✅ compatible avec output: "export" : on enlève force-dynamic
// export const dynamic = "force-dynamic";

const UPSTREAM =
  process.env.GENERATE_LETTER_UPSTREAM ||
  "https://europe-west1-assistant-ia-v4.cloudfunctions.net/generateLetterAndPitch";

export async function POST(req: Request) {
  try {
    const auth = req.headers.get("authorization") || "";
    const headerRecaptcha = req.headers.get("x-recaptcha-token") || "";

    const body = await req.json().catch(() => null);
    if (!body) {
      return NextResponse.json({ error: "Body JSON invalide." }, { status: 400 });
    }

    const bodyRecaptcha =
      typeof body?.recaptchaToken === "string" ? body.recaptchaToken : "";
    const recaptcha = headerRecaptcha || bodyRecaptcha;

    const upstreamRes = await fetch(UPSTREAM, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        ...(auth ? { Authorization: auth } : {}),
        ...(recaptcha ? { "X-Recaptcha-Token": recaptcha } : {}),
      },
      body: JSON.stringify(body),
      cache: "no-store",
    });

    const contentType =
      upstreamRes.headers.get("content-type") || "application/json";
    const text = await upstreamRes.text();

    return new NextResponse(text, {
      status: upstreamRes.status,
      headers: { "Content-Type": contentType },
    });
  } catch (e: any) {
    console.error("API /generateLetterAndPitch error:", e);
    return NextResponse.json({ error: "internal_error" }, { status: 500 });
  }
}
````

## File: server/_api_disabled/api/generate-zip/route.ts
````typescript
// app/api/generate-zip/route.ts

import { NextResponse } from "next/server";
import { getApps, initializeApp, applicationDefault, cert } from "firebase-admin/app";
import { getAuth } from "firebase-admin/auth";
import { getFirestore, FieldValue } from "firebase-admin/firestore";
import JSZip from "jszip";
import { PDFDocument, StandardFonts, rgb } from "pdf-lib";

// ⚠️ Pour typer proprement le cast à la fin
type BodyInitCompat = BodyInit | null | undefined;

export const runtime = "nodejs";
export const dynamic = "force-dynamic";

function getAdminApp() {
  if (getApps().length) return getApps()[0];

  const projectId = process.env.FIREBASE_ADMIN_PROJECT_ID || process.env.FIREBASE_PROJECT_ID;
  const clientEmail = process.env.FIREBASE_ADMIN_CLIENT_EMAIL;
  const privateKeyRaw = process.env.FIREBASE_ADMIN_PRIVATE_KEY;

  if (projectId && clientEmail && privateKeyRaw) {
    const privateKey = privateKeyRaw.replace(/\\n/g, "\n");
    return initializeApp({
      credential: cert({ projectId, clientEmail, privateKey }),
    });
  }

  return initializeApp({
    credential: applicationDefault(),
  });
}

async function requireUser(req: Request) {
  getAdminApp();

  const authHeader = req.headers.get("authorization") || "";
  const token = authHeader.startsWith("Bearer ") ? authHeader.slice(7).trim() : "";

  if (!token) {
    return { ok: false as const, status: 401, error: "Missing Authorization Bearer token" };
  }

  try {
    const decoded = await getAuth().verifyIdToken(token);
    return { ok: true as const, uid: decoded.uid, email: decoded.email || "" };
  } catch (e) {
    console.error("verifyIdToken error:", e);
    return { ok: false as const, status: 401, error: "Invalid token" };
  }
}

async function consumeCreditsAndLog(params: {
  uid: string;
  email: string;
  cost: number; // ex 2
  tool: string; // generateCvLmZip
  docType: "cv" | "lm" | "other";
  meta?: any;
}) {
  getAdminApp();
  const db = getFirestore();

  const userRef = db.collection("users").doc(params.uid);
  const usageRef = db.collection("usageLogs").doc();
  const now = Date.now();

  await db.runTransaction(async (tx) => {
    const snap = await tx.get(userRef);
    const data = snap.exists ? snap.data() || {} : {};
    const currentCredits = typeof data.credits === "number" ? data.credits : 0;

    if (currentCredits < params.cost) {
      const err: any = new Error("NO_CREDITS");
      err.code = "NO_CREDITS";
      throw err;
    }

    tx.set(
      userRef,
      {
        credits: currentCredits - params.cost,
        totalIaCalls: FieldValue.increment(1),
        totalDocumentsGenerated: FieldValue.increment(2), // zip = 2 docs (cv + lm)
        totalCvGenerated: FieldValue.increment(1),
        totalLmGenerated: FieldValue.increment(1),
        updatedAt: FieldValue.serverTimestamp(),
      },
      { merge: true }
    );

    tx.set(
      usageRef,
      {
        userId: params.uid,
        email: params.email || "",
        action: "generate_document",
        docType: params.docType,
        eventType: "generate",
        tool: params.tool,
        creditsDelta: -params.cost,
        meta: params.meta || null,
        createdAt: now,
        createdAtServer: FieldValue.serverTimestamp(),
      },
      { merge: true }
    );
  });
}

function buildProfileContextForIA(profile: any) {
  const p = profile || {};

  let skillsArr: any[] = [];
  if (Array.isArray(p.skills)) {
    skillsArr = p.skills;
  } else if (p.skills && typeof p.skills === "object") {
    if (Array.isArray(p.skills.sections)) {
      p.skills.sections.forEach((sec: any) => {
        if (Array.isArray(sec.items)) skillsArr = skillsArr.concat(sec.items);
      });
    }
    if (Array.isArray(p.skills.tools)) skillsArr = skillsArr.concat(p.skills.tools);
  }

  const skillsStr = (skillsArr || []).join(", ");

  const expStr = Array.isArray(p.experiences)
    ? p.experiences
        .map(
          (e: any) =>
            `${e.role || e.title || ""} chez ${e.company || ""} (${e.dates || ""}): ${(e.bullets || []).join(" ")}`
        )
        .join("; \n")
    : "";

  const eduStr = Array.isArray(p.education)
    ? p.education
        .map((e: any) => `${e.degree || e.title || ""} - ${e.school || e.institution || ""} (${e.dates || ""})`)
        .join("; \n")
    : "";

  return `Nom: ${p.fullName || p.name || ""}
Titre: ${p.profileHeadline || p.title || ""}
Contact: ${p.email || ""} | ${p.phone || ""} | ${p.linkedin || ""} | ${p.city || ""}
Résumé de profil: ${p.profileSummary || p.summary || ""}
Compétences: ${skillsStr}
Expériences: 
${expStr}
Formations: 
${eduStr}
Certifications: ${p.certs || ""}
Langues: ${p.langLine || p.lang || ""}`.trim();
}

async function callGeminiText(
  prompt: string,
  apiKey: string,
  temperature = 0.65,
  maxOutputTokens = 1400
) {
  const endpoint = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent";

  const body = {
    contents: [{ role: "user", parts: [{ text: prompt }] }],
    generationConfig: { temperature, maxOutputTokens },
  };

  const resp = await fetch(endpoint, {
    method: "POST",
    headers: { "Content-Type": "application/json", "x-goog-api-key": apiKey },
    body: JSON.stringify(body),
  });

  if (!resp.ok) {
    const errorText = await resp.text();
    throw new Error("Erreur Gemini (texte): " + errorText);
  }

  const data = await resp.json();
  const parts = data?.candidates?.[0]?.content?.parts || [];
  const text = parts
    .map((p: any) => (typeof p.text === "string" ? p.text : ""))
    .join("\n")
    .trim();

  if (!text) throw new Error("Réponse Gemini (texte) vide");
  return text;
}

function buildFallbackLetterBody(profile: any, jobTitle: string, companyName: string, lang: string) {
  const p = profile || {};
  const primaryDomain = p.primaryDomain || "";
  const summary = p.profileSummary || "";
  const firstExp = Array.isArray(p.experiences) && p.experiences.length ? p.experiences[0] : null;
  const role = firstExp?.role || firstExp?.title || "";
  const company = firstExp?.company || "";
  const years = Array.isArray(p.experiences) && p.experiences.length > 0 ? p.experiences.length : null;

  if (lang === "en") {
    return `I am writing to express my interest in the position of ${jobTitle || "your advertised role"} at ${
      companyName || "your company"
    }. ${summary || ""}

With ${years ? years + " years of experience" : "solid experience"} in ${primaryDomain || "my field"}, I have developed skills relevant to this opportunity.

In my previous experience at ${company || "my last company"}, I contributed to projects and collaborated with different stakeholders.

I would be delighted to discuss how I can contribute to your team.`;
  }

  return `Je vous écris pour vous faire part de mon intérêt pour le poste de ${jobTitle || "..."} au sein de ${
    companyName || "votre entreprise"
  }. ${summary || ""}

Avec ${years ? years + " ans d’expérience" : "une expérience significative"} ${
    primaryDomain ? "dans " + primaryDomain : "dans mon domaine"
  }, j’ai développé des compétences solides en ${role || "gestion de projets, collaboration et suivi d’objectifs"}.

Je serais ravi(e) d’échanger plus en détail lors d’un entretien.`;
}

async function createSimpleCvPdf(profile: any, options: any) {
  const { targetJob = "", lang = "fr", contract = "", jobLink = "", jobDescription = "" } = options || {};

  const p = profile || {};
  const pdfDoc = await PDFDocument.create();
  const page = pdfDoc.addPage([595.28, 841.89]); // A4
  const font = await pdfDoc.embedFont(StandardFonts.Helvetica);
  const fontBold = await pdfDoc.embedFont(StandardFonts.HelveticaBold);

  const { width, height } = page.getSize();
  const marginX = 50;
  let y = height - 60;

  function drawLine(text: string, size = 11, bold = false) {
    if (!text || y < 50) return;
    const f = bold ? fontBold : font;
    page.drawText(text, { x: marginX, y, size, font: f, color: rgb(0.1, 0.12, 0.16) });
    y -= size + 4;
  }

  function drawParagraph(text: string, size = 10) {
    if (!text) return;
    const f = font;
    const maxWidth = width - marginX * 2;
    const paragraphs = text.split(/\n{2,}/);

    for (const paragraph of paragraphs) {
      const words = paragraph.split(/\s+/);
      let line = "";

      for (const w of words) {
        const testLine = line ? line + " " + w : w;
        const testWidth = f.widthOfTextAtSize(testLine, size);
        if (testWidth > maxWidth) {
          if (y < 50) return;
          page.drawText(line, { x: marginX, y, size, font: f, color: rgb(0.1, 0.12, 0.16) });
          y -= size + 3;
          line = w;
        } else {
          line = testLine;
        }
      }

      if (line && y >= 50) {
        page.drawText(line, { x: marginX, y, size, font: f, color: rgb(0.1, 0.12, 0.16) });
        y -= size + 6;
      }
      y -= 2;
    }
  }

  function drawSectionTitle(title: string) {
    if (!title || y < 60) return;
    page.drawText(title, { x: marginX, y, size: 11, font: fontBold, color: rgb(0.08, 0.15, 0.45) });
    y -= 14;
  }

  function drawBullet(text: string, size = 9) {
    if (!text || y < 50) return;
    const f = font;
    const bulletX = marginX + 8;
    const maxWidth = width - marginX * 2 - 10;
    const words = text.split(/\s+/);
    let line = "";
    let firstLine = true;

    for (const w of words) {
      const testLine = line ? line + " " + w : w;
      const testWidth = f.widthOfTextAtSize(testLine, size);
      if (testWidth > maxWidth) {
        if (y < 50) return;
        page.drawText(firstLine ? "• " + line : "  " + line, {
          x: bulletX,
          y,
          size,
          font: f,
          color: rgb(0.1, 0.12, 0.16),
        });
        y -= size + 3;
        line = w;
        firstLine = false;
      } else {
        line = testLine;
      }
    }

    if (line && y >= 50) {
      page.drawText(firstLine ? "• " + line : "  " + line, {
        x: bulletX,
        y,
        size,
        font: f,
        color: rgb(0.1, 0.12, 0.16),
      });
      y -= size + 3;
    }
  }

  // Header
  drawLine(p.fullName || "", 16, true);
  const jobLine = targetJob || contract || p.contractType || (lang === "en" ? "Target position" : "Poste recherché");
  drawLine(jobLine, 11, false);

  const contactParts = [p.email || "", p.phone || "", p.city || "", p.linkedin || ""].filter(Boolean);
  if (contactParts.length) drawLine(contactParts.join(" · "), 9, false);

  if (jobLink) drawLine((lang === "en" ? "Job link: " : "Lien de l'offre : ") + jobLink, 8, false);

  y -= 6;

  if (p.profileSummary) {
    drawSectionTitle(lang === "en" ? "Profile" : "Profil");
    drawParagraph(p.profileSummary, 9.5);
    y -= 4;
  }

  if (p.skills && Array.isArray(p.skills.sections) && p.skills.sections.length) {
    drawSectionTitle(lang === "en" ? "Key skills" : "Compétences clés");
    p.skills.sections.forEach((sec: any) => {
      if (!sec || (!sec.title && !Array.isArray(sec.items))) return;
      if (sec.title) drawLine(sec.title, 9.5, true);
      if (Array.isArray(sec.items)) drawParagraph(sec.items.join(" · "), 9);
      y -= 2;
    });
  }

  if (Array.isArray(p.experiences) && p.experiences.length) {
    drawSectionTitle(lang === "en" ? "Experience" : "Expériences professionnelles");
    p.experiences.forEach((exp: any) => {
      if (y < 90) return;
      const header = [exp.role, exp.company].filter(Boolean).join(" — ");
      if (header) drawLine(header, 10, true);
      if (exp.dates) drawLine(exp.dates, 8.5, false);
      if (Array.isArray(exp.bullets)) exp.bullets.slice(0, 4).forEach((b: string) => drawBullet(b, 8.5));
      y -= 4;
    });
  }

  if (Array.isArray(p.education) && p.education.length && y > 80) {
    drawSectionTitle(lang === "en" ? "Education" : "Formation");
    p.education.forEach((ed: any) => {
      if (y < 60) return;
      const header = [ed.degree, ed.school].filter(Boolean).join(" — ");
      if (header) drawLine(header, 9.5, true);
      if (ed.dates) drawLine(ed.dates, 8.5, false);
      y -= 4;
    });
  }

  if (p.langLine && y > 60) {
    drawSectionTitle(lang === "en" ? "Languages" : "Langues");
    drawParagraph(p.langLine, 9);
  }

  if (Array.isArray(p.hobbies) && p.hobbies.length && y > 60) {
    drawSectionTitle(lang === "en" ? "Interests" : "Centres d'intérêt");
    drawParagraph(p.hobbies.join(" · "), 9);
  }

  const pdfBytes = await pdfDoc.save();
  return Buffer.from(pdfBytes);
}

async function createLetterPdf(coverLetter: string, meta: any) {
  const { jobTitle = "", companyName = "", candidateName = "", lang = "fr" } = meta || {};

  const pdfDoc = await PDFDocument.create();
  const page = pdfDoc.addPage([595.28, 841.89]); // A4
  const font = await pdfDoc.embedFont(StandardFonts.Helvetica);
  const fontBold = await pdfDoc.embedFont(StandardFonts.HelveticaBold);

  const { width, height } = page.getSize();
  const marginX = 60;
  let y = height - 70;

  function drawLine(text: string, size = 11, bold = false) {
    if (!text || y < 60) return;
    const f = bold ? fontBold : font;
    page.drawText(text, { x: marginX, y, size, font: f, color: rgb(0.15, 0.17, 0.23) });
    y -= size + 4;
  }

  function drawParagraph(text: string, size = 11) {
    if (!text) return;
    const f = font;
    const maxWidth = width - marginX * 2;
    const paragraphs = text.split(/\n{2,}/);

    for (const paragraph of paragraphs) {
      const words = paragraph.split(/\s+/);
      let line = "";

      for (const w of words) {
        const testLine = line ? line + " " + w : w;
        const testWidth = f.widthOfTextAtSize(testLine, size);
        if (testWidth > maxWidth) {
          if (y < 60) return;
          page.drawText(line, { x: marginX, y, size, font: f, color: rgb(0.15, 0.17, 0.23) });
          y -= size + 4;
          line = w;
        } else {
          line = testLine;
        }
      }

      if (line && y >= 60) {
        page.drawText(line, { x: marginX, y, size, font: f, color: rgb(0.15, 0.17, 0.23) });
        y -= size + 8;
      }

      y -= 4;
    }
  }

  if (candidateName) drawLine(candidateName, 14, true);

  if (jobTitle || companyName) {
    const titleLine =
      lang === "en"
        ? `Application for ${jobTitle || "the position"} – ${companyName || "Company"}`
        : `Candidature : ${jobTitle || "poste"} – ${companyName || "Entreprise"}`;
    drawLine(titleLine, 11, false);
  }

  y -= 10;
  drawParagraph(coverLetter, 11);

  const pdfBytes = await pdfDoc.save();
  return Buffer.from(pdfBytes);
}

export async function POST(req: Request) {
  const auth = await requireUser(req);
  if (!auth.ok) return NextResponse.json({ ok: false, error: auth.error }, { status: auth.status });

  let body: any = null;
  try {
    body = await req.json();
  } catch {
    return NextResponse.json({ ok: false, error: "Invalid JSON body" }, { status: 400 });
  }

  const profile = body?.profile;
  const targetJob = body?.targetJob || "";
  const langRaw = body?.lang || "fr";
  const contract = body?.contract || "";
  const jobLink = body?.jobLink || "";
  const jobDescription = body?.jobDescription || "";

  const lm = body?.lm || {};
  const companyName = lm?.companyName || "";
  const jobTitle = lm?.jobTitle || targetJob || "";
  const lmJobDescription = lm?.jobDescription || jobDescription || "";
  const lmLangRaw = lm?.lang || langRaw;

  const lang = String(langRaw).toLowerCase().startsWith("en") ? "en" : "fr";
  const lmLang = String(lmLangRaw).toLowerCase().startsWith("en") ? "en" : "fr";

  if (!profile) return NextResponse.json({ ok: false, error: "Missing profile" }, { status: 400 });

  // ✅ Débit -2 crédits (CV + LM) + log
  try {
    await consumeCreditsAndLog({
      uid: auth.uid,
      email: auth.email,
      cost: 2,
      tool: "generateCvLmZip",
      docType: "other",
      meta: { targetJob, jobTitle, companyName, lang, lmLang },
    });
  } catch (e: any) {
    if (e?.code === "NO_CREDITS" || e?.message === "NO_CREDITS") {
      return NextResponse.json({ ok: false, error: "NO_CREDITS" }, { status: 402 });
    }
    console.error("consumeCreditsAndLog error:", e);
    return NextResponse.json({ ok: false, error: "CREDITS_ERROR" }, { status: 500 });
  }

  // CV PDF
  let cvBuffer: Buffer;
  try {
    cvBuffer = await createSimpleCvPdf(profile, {
      targetJob,
      lang,
      contract,
      jobLink,
      jobDescription,
    });
  } catch (e: any) {
    console.error("CV PDF error:", e);
    return NextResponse.json({ ok: false, error: e?.message || "CV_PDF_ERROR" }, { status: 500 });
  }

  // LM BODY via Gemini
  const GEMINI_API_KEY = process.env.GEMINI_API_KEY || "";
  const cvText = buildProfileContextForIA(profile);

  let coverLetterBody = "";

  if (GEMINI_API_KEY) {
    const promptLm =
      lmLang === "en"
        ? `
You are a senior career coach and recruiter.

TASK:
Write ONLY the BODY of a cover letter tailored to the job, using ONLY the provided information (CV + job description).

INPUTS:
- Job title: "${jobTitle || "the role"}"
- Company: "${companyName || "your company"}"
- Job description:
${lmJobDescription || "—"}

- Candidate profile (source of truth):
${cvText}

STRICT RULES:
- Do NOT invent facts (no fake metrics, clients, tools, dates).
- 3 to 5 paragraphs separated by ONE blank line.
- No header, no subject line, no greeting, no signature.
- Output MUST be STRICT JSON only:
{ "body": "..." }
`.trim()
        : `
Tu es un coach carrières senior et recruteur.

MISSION :
Rédige UNIQUEMENT le CORPS d’une lettre de motivation adaptée au poste, basée UNIQUEMENT sur les infos fournies (CV + fiche de poste).

ENTRÉES :
- Intitulé : "${jobTitle || targetJob || "le poste"}"
- Entreprise : "${companyName || "votre entreprise"}"
- Fiche de poste :
${lmJobDescription || "—"}

- Profil candidat :
${cvText}

RÈGLES :
- Ne pas inventer (pas de chiffres/clients/technos non présents).
- 3 à 5 paragraphes séparés par une ligne vide.
- Pas d’en-tête, pas d’objet, pas de salutation, pas de signature.
- Réponds STRICTEMENT en JSON :
{ "body": "..." }
`.trim();

    try {
      const rawLm = await callGeminiText(promptLm, GEMINI_API_KEY, 0.65, 1400);
      const cleaned = String(rawLm).replace(/```json|```/gi, "").trim();
      try {
        const parsed = JSON.parse(cleaned);
        coverLetterBody = typeof parsed.body === "string" ? parsed.body.trim() : "";
      } catch {
        coverLetterBody = String(rawLm || "").trim();
      }
    } catch (e) {
      console.error("Gemini LM error:", e);
    }
  }

  if (!coverLetterBody) {
    coverLetterBody = buildFallbackLetterBody(profile, jobTitle, companyName, lmLang);
  }

  // LM PDF
  let lmBuffer: Buffer;
  try {
    lmBuffer = await createLetterPdf(coverLetterBody, {
      jobTitle,
      companyName,
      candidateName: profile.fullName || "",
      lang: lmLang,
    });
  } catch (e: any) {
    console.error("LM PDF error:", e);
    return NextResponse.json({ ok: false, error: e?.message || "LM_PDF_ERROR" }, { status: 500 });
  }

  // ZIP ✅ (avec cast pour calmer TypeScript)
  try {
    const zip = new JSZip();
    zip.file("cv-ia.pdf", cvBuffer);
    zip.file(lmLang === "en" ? "cover-letter.pdf" : "lettre-motivation.pdf", lmBuffer);

    const zipContent = await zip.generateAsync({ type: "uint8array" });

    return new NextResponse(zipContent as unknown as BodyInitCompat, {
      status: 200,
      headers: {
        "Content-Type": "application/zip",
        "Content-Disposition": 'attachment; filename="cv-lm-ia.zip"',
        "Content-Length": String(zipContent.byteLength),
      },
    });
  } catch (e: any) {
    console.error("ZIP error:", e);
    return NextResponse.json({ ok: false, error: e?.message || "ZIP_ERROR" }, { status: 500 });
  }
}
````

## File: server/_api_disabled/api/generateInterviewQA/route.ts
````typescript
// app/api/generateInterviewQA/route.ts
import { NextRequest, NextResponse } from "next/server";

export const runtime = "nodejs";

// Petit helper pour récupérer un JSON même si Gemini met des ```json ... ```
function extractJson(text: string): any | null {
  if (!text) return null;

  let t = text.trim();

  // Si Gemini renvoie ```json ... ```
  if (t.startsWith("```")) {
    // retire ```json ou ``` et la dernière ```
    t = t.replace(/^```[a-zA-Z]*\s*/, "").replace(/```$/, "").trim();
  }

  // 1ère tentative : parser tout
  try {
    return JSON.parse(t);
  } catch {
    // ignore, on tente plus bas
  }

  // 2ème tentative : chercher le premier bloc {...}
  const match = t.match(/\{[\s\S]*\}/);
  if (match) {
    try {
      return JSON.parse(match[0]);
    } catch {
      // toujours pas bon
    }
  }

  return null;
}

export async function POST(req: NextRequest) {
  try {
    const body = await req.json();
    const { profile, experienceIndex, lang = "fr" } = body;

    if (!profile || typeof experienceIndex !== "number") {
      return NextResponse.json(
        { error: "Missing profile or experienceIndex" },
        { status: 400 }
      );
    }

    const experiences: any[] =
      (profile.experiences as any[]) ||
      (profile.experience as any[]) ||
      [];

    const exp = experiences[experienceIndex];
    if (!exp) {
      return NextResponse.json(
        { error: "Experience not found" },
        { status: 404 }
      );
    }

    const bullets = Array.isArray(exp.bullets)
      ? exp.bullets.join("\n- ")
      : "";

    const prompt = `
Tu es un coach d'entretien. Génère 5 questions d'entretien pour le candidat,
basées sur cette expérience de son CV, avec des réponses de qualité.

Tu dois renvoyer STRICTEMENT un objet JSON valide, sans aucun texte avant ou après.

Format de sortie EXACT :
{
  "questions": [
    {
      "question": "string",
      "answer": "string"
    }
  ]
}

Pas de commentaires, pas de texte hors de cet objet JSON.

Langue : ${lang === "en" ? "anglais" : "français"}.

Expérience :
- Poste : ${exp.role || exp.title || ""}
- Entreprise : ${exp.company || ""}
- Lieu : ${exp.city || exp.location || ""}
- Dates : ${exp.dates || ""}

Missions / résultats :
- ${bullets}
    `.trim();

    const apiKey = process.env.GEMINI_API_KEY;
    if (!apiKey) {
      console.warn("[generateInterviewQA] GEMINI_API_KEY manquant → mode démo.");
      // Fallback démo simple
      return NextResponse.json({
        questions: [
          {
            question:
              lang === "en"
                ? "Tell me about a challenge in this role and how you handled it."
                : "Parle-moi d’un défi que tu as rencontré sur ce poste et comment tu l’as géré.",
            answer:
              lang === "en"
                ? "Sample answer here…"
                : "Exemple de réponse ici…",
          },
        ],
        lang,
      });
    }

    const model =
      process.env.GEMINI_MODEL || "models/gemini-2.5-flash";

    const url = `https://generativelanguage.googleapis.com/v1beta/${model}:generateContent?key=${apiKey}`;

    const payload = {
      contents: [
        {
          role: "user",
          parts: [{ text: prompt }],
        },
      ],
      // >>> IMPORTANT : on force une réponse en JSON pur
      generationConfig: {
        response_mime_type: "application/json",
      },
    };

    const resp = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    });

    if (!resp.ok) {
      const errorText = await resp.text();
      console.error(
        "Gemini error (generateInterviewQA):",
        resp.status,
        errorText
      );

      if (resp.status === 429) {
        console.warn(
          "[generateInterviewQA] Quota Gemini dépassé → fallback démo."
        );
        return NextResponse.json({
          questions: [
            {
              question:
                lang === "en"
                  ? "Demo mode (quota exceeded): what did you learn in this experience?"
                  : "Mode démo (quota dépassé) : qu’as-tu appris dans cette expérience ?",
              answer:
                lang === "en"
                  ? "Sample answer here…"
                  : "Exemple de réponse ici…",
            },
          ],
          lang,
        });
      }

      return NextResponse.json(
        { error: "Gemini call failed" },
        { status: 500 }
      );
    }

    const data = await resp.json();

    const textRaw: string =
      data?.candidates?.[0]?.content?.parts
        ?.map((p: any) => p?.text || "")
        .join("")
        .trim() || "";

    if (!textRaw) {
      console.error("Empty Gemini response (generateInterviewQA):", data);
      // On ne jette plus une 500, on renvoie un fallback propre
      return NextResponse.json({
        questions: [
          {
            question:
              lang === "en"
                ? "Based on this experience, what are you most proud of?"
                : "De quoi es-tu le plus fier dans cette expérience ?",
            answer:
              lang === "en"
                ? "Sample answer here…"
                : "Exemple de réponse ici…",
          },
        ],
        lang,
      });
    }

    const parsed = extractJson(textRaw);

    if (!parsed || !Array.isArray(parsed.questions)) {
      console.error(
        "JSON parse error generateInterviewQA: texte non exploitable",
        textRaw
      );
      // Toujours un fallback pour ne plus avoir de 500 côté front
      return NextResponse.json({
        questions: [
          {
            question:
              lang === "en"
                ? "Tell me about this role and your main responsibilities."
                : "Parle-moi de ce poste et de tes principales responsabilités.",
            answer:
              lang === "en"
                ? "Sample answer here…"
                : "Exemple de réponse ici…",
          },
        ],
        lang,
      });
    }

    // On force la langue si absente
    if (!parsed.lang) {
      parsed.lang = lang;
    }

    return NextResponse.json(parsed);
  } catch (err) {
    console.error("generateInterviewQA API error:", err);
    return NextResponse.json(
      { error: "Internal error" },
      { status: 500 }
    );
  }
}
````

## File: server/_api_disabled/api/generateLetterAndPitch/route.ts
````typescript
// app/api/generateLetterAndPitch/route.ts
import { NextResponse } from "next/server";

export const runtime = "nodejs";

const CF_LETTER_AND_PITCH_URL =
  process.env.FUNCTIONS_BASE_URL
    ? `${process.env.FUNCTIONS_BASE_URL}/generateLetterAndPitch`
    : "https://europe-west1-assistant-ia-v4.cloudfunctions.net/generateLetterAndPitch";

// --------------------
// Helpers (server)
// --------------------
function safeText(v: any) {
  return String(v ?? "").trim();
}

function cleanGeneratedLetter(raw: string): string {
  if (!raw) return "";
  let txt = String(raw);

  txt = txt.replace(/<\/?body[^>]*>/gi, "");
  txt = txt.replace(/<\/?html[^>]*>/gi, "");
  txt = txt.replace(/<\/?head[^>]*>[\s\S]*?<\/head>/gi, "");
  txt = txt.replace(/<\/?[^>]+>/g, "");

  return txt.replace(/\r\n/g, "\n").replace(/\n{3,}/g, "\n\n").trim();
}

function extractBodyFromLetterText(letterText: string, lang: "fr" | "en", fullName?: string) {
  const raw = safeText(letterText);
  if (!raw) return "";

  const lines = raw
    .split(/\r?\n/)
    .map((l) => l.trim())
    .filter(Boolean);

  if (!lines.length) return raw;

  const first = lines[0].toLowerCase();
  const isGreeting =
    (lang === "fr" && (first.startsWith("madame") || first.startsWith("bonjour"))) ||
    (lang === "en" && (first.startsWith("dear") || first.startsWith("hello")));

  if (isGreeting) lines.shift();

  while (lines.length) {
    const last = lines[lines.length - 1].toLowerCase();

    if (
      last.includes("cordialement") ||
      last.includes("bien cordialement") ||
      last.includes("salutations") ||
      last.includes("sincerely") ||
      last.includes("best regards") ||
      last.includes("kind regards")
    ) {
      lines.pop();
      continue;
    }

    if (fullName && last.includes(fullName.toLowerCase())) {
      lines.pop();
      continue;
    }

    break;
  }

  return lines.join("\n\n").trim() || raw;
}

// --------------------
// Route
// --------------------
export async function POST(req: Request) {
  // 1) Parse JSON
  let body: any = null;
  try {
    body = await req.json();
  } catch {
    return NextResponse.json({ error: "Corps JSON invalide." }, { status: 400 });
  }

  try {
    // 2) Headers vers Cloud Function
    const headers: Record<string, string> = {
      "Content-Type": "application/json",
    };

    const authHeader = req.headers.get("authorization");
    if (authHeader) headers["Authorization"] = authHeader;

    // ✅ reCAPTCHA : body OU header (front envoie souvent dans le body)
    const recaptchaFromHeader =
      req.headers.get("x-recaptcha-token") || req.headers.get("X-Recaptcha-Token");

    const recaptchaFromBody = typeof body?.recaptchaToken === "string" ? body.recaptchaToken.trim() : "";

    const recaptchaToken = recaptchaFromBody || recaptchaFromHeader || "";
    if (recaptchaToken) headers["X-Recaptcha-Token"] = recaptchaToken;

    // optionnel mais propre : ne pas forward le token dans le body si la CF attend un header
    if (body && "recaptchaToken" in body) delete body.recaptchaToken;

    // 3) Timeout (évite req qui pend)
    const controller = new AbortController();
    const timeout = setTimeout(() => controller.abort(), 45_000);

    const cfRes = await fetch(CF_LETTER_AND_PITCH_URL, {
      method: "POST",
      headers,
      body: JSON.stringify(body),
      signal: controller.signal,
    }).finally(() => clearTimeout(timeout));

    const status = cfRes.status;
    const contentType = cfRes.headers.get("content-type") || "";

    // 4) Si pas JSON -> erreur explicite
    if (!contentType.includes("application/json")) {
      const text = await cfRes.text().catch(() => "");
      return NextResponse.json(
        {
          error: "La Cloud Function generateLetterAndPitch ne renvoie pas de JSON.",
          status,
          rawBody: text.slice(0, 800),
        },
        { status: status || 500 }
      );
    }

    const json = await cfRes.json().catch(() => null);

    // 5) Propager erreur backend CF
    if (!cfRes.ok) {
      return NextResponse.json(json || { error: "Erreur backend generateLetterAndPitch" }, { status });
    }

    // 6) ✅ Normalisation : garantir letterBody côté front
    // - si la CF renvoie déjà letterBody : on le clean
    // - sinon fallback coverLetter -> on extrait un body propre
    const lang = (body?.lang === "en" ? "en" : "fr") as "fr" | "en";
    const fullName = safeText(body?.profile?.fullName);

    const apiLetterBody = typeof json?.letterBody === "string" ? json.letterBody : "";
    const apiCoverLetter = typeof json?.coverLetter === "string" ? json.coverLetter : "";

    const cleanedPrimary = cleanGeneratedLetter(apiLetterBody || apiCoverLetter);
    const bodyOnly = extractBodyFromLetterText(cleanedPrimary, lang, fullName);

    const out = {
      ...json,
      // ✅ on force un champ stable
      letterBody: bodyOnly || cleanedPrimary || "",
      // (optionnel) on garde coverLetter intact si tu l’utilises ailleurs
      coverLetter: typeof json?.coverLetter === "string" ? json.coverLetter : apiCoverLetter || "",
    };

    return NextResponse.json(out, { status });
  } catch (e: any) {
    const isAbort = e?.name === "AbortError";
    console.error("Erreur proxy /api/generateLetterAndPitch :", e);

    return NextResponse.json(
      {
        error: isAbort
          ? "Timeout lors de l'appel à generateLetterAndPitch."
          : "Erreur interne dans la route Next /api/generateLetterAndPitch (proxy).",
        details: e?.message ?? String(e),
      },
      { status: isAbort ? 504 : 500 }
    );
  }
}
````

## File: server/_api_disabled/api/interview/route.ts
````typescript
// app/api/interview/route.ts
import { NextRequest, NextResponse } from "next/server";
import {
  buildPrompt,
  InterviewLevel,
  InterviewChannel,
  HistoryItem,
} from "@/lib/interviewPrompt";
import { verifyUserAndCredits, consumeCredit } from "@/lib/server/credits";

export const runtime = "nodejs";

/**
 * ✅ reCAPTCHA OFF par défaut
 * -> Active uniquement si INTERVIEW_REQUIRE_RECAPTCHA=true
 */
const REQUIRE_RECAPTCHA =
  (process.env.INTERVIEW_REQUIRE_RECAPTCHA || "").toLowerCase().trim() ===
  "true";

// ---- Sessions en mémoire (DEV) ---- //
type InterviewSession = {
  userId: string;
  createdAt: string;
  lastUpdated: string;
  jobDesc: string;
  cvSummary: string;
  mode: string;
  level: InterviewLevel;
  channel: InterviewChannel;
  status: "active" | "completed";
  currentStep: number;
  history: HistoryItem[];
  score?: number | null;
  finalSummary?: string | null;
};

const memorySessions = new Map<string, InterviewSession>();

function createSessionId() {
  try {
    // @ts-ignore
    return crypto.randomUUID();
  } catch {
    return Math.random().toString(36).slice(2) + "-" + Date.now().toString(36);
  }
}

function purgeOldSessions(maxAgeMs = 1000 * 60 * 60 * 6) {
  const now = Date.now();
  for (const [sid, s] of memorySessions.entries()) {
    const t = Date.parse(s.lastUpdated || s.createdAt);
    if (!Number.isNaN(t) && now - t > maxAgeMs) memorySessions.delete(sid);
  }
}

// ---------------- reCAPTCHA (Enterprise via CF recaptchaVerify) ----------------
type RecaptchaVerifyResult =
  | { ok: true; score?: number }
  | { ok: false; reason: string; score?: number };

function stripTrailingSlash(s: string) {
  return s.endsWith("/") ? s.slice(0, -1) : s;
}

function getApiBaseServer(): string {
  return stripTrailingSlash(
    process.env.CLOUD_FUNCTIONS_BASE_URL ||
      process.env.API_BASE_URL ||
      "https://europe-west1-assistant-ia-v4.cloudfunctions.net"
  );
}

async function verifyRecaptchaEnterpriseViaCF(
  token: string,
  action: string
): Promise<RecaptchaVerifyResult> {
  const base = getApiBaseServer();
  try {
    const res = await fetch(`${base}/recaptchaVerify`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ token, action: (action || "").trim() }),
      cache: "no-store",
    });

    const data: any = await res.json().catch(() => null);

    if (!res.ok || !data?.ok) {
      return {
        ok: false,
        reason: String(data?.reason || data?.error || "recaptcha_failed"),
        score: typeof data?.score === "number" ? data.score : undefined,
      };
    }

    return {
      ok: true,
      score: typeof data?.score === "number" ? data.score : undefined,
    };
  } catch (e: any) {
    return { ok: false, reason: e?.message || "network_error" };
  }
}

// ---- Handler principal ---- //
export async function POST(req: NextRequest) {
  try {
    purgeOldSessions();

    const body = await req.json().catch(() => null);
    if (!body || typeof body !== "object") {
      return NextResponse.json({ error: "Invalid JSON body" }, { status: 400 });
    }

    const { action } = body as any;

    // ✅ token peut venir de plusieurs endroits (selon ton front)
    const recaptchaToken =
      (body as any)?.recaptchaToken ||
      (body as any)?.token ||
      (body as any)?.recaptcha?.token ||
      null;

    const recaptchaAction =
      (body as any)?.recaptchaAction ||
      (body as any)?.recaptcha?.action ||
      "interview";

    // ✅ reCAPTCHA (optionnel)
    if (REQUIRE_RECAPTCHA) {
      if (!recaptchaToken || typeof recaptchaToken !== "string") {
        return NextResponse.json(
          {
            error: "reCAPTCHA failed",
            details: "token_missing_or_invalid",
            requireRecaptcha: true,
            expectedAction: recaptchaAction,
          },
          { status: 403 }
        );
      }

      const rec = await verifyRecaptchaEnterpriseViaCF(
        recaptchaToken,
        recaptchaAction
      );

      if (!rec.ok) {
        return NextResponse.json(
          {
            error: "reCAPTCHA failed",
            details: rec.reason,
            score: rec.score ?? null,
            requireRecaptcha: true,
            expectedAction: recaptchaAction,
          },
          { status: 403 }
        );
      }
    }

    // ---------- START ---------- //
    if (action === "start") {
      const { userId, jobDesc, cvSummary, mode, channel, level } = body as any;

      if (!userId) {
        return NextResponse.json({ error: "Missing userId" }, { status: 400 });
      }

      const user = await verifyUserAndCredits(userId);
      if (!user) {
        return NextResponse.json(
          { error: "Unauthorized or no credits" },
          { status: 401 }
        );
      }

      const nowIso = new Date().toISOString();
      const safeMode = (mode || "mixed") as string;
      const safeChannel = (channel || "written") as InterviewChannel;
      const safeLevel = (level || "junior") as InterviewLevel;

      const sessionId = createSessionId();

      const sessionData: InterviewSession = {
        userId,
        createdAt: nowIso,
        lastUpdated: nowIso,
        jobDesc: jobDesc || "",
        cvSummary: cvSummary || "",
        mode: safeMode,
        level: safeLevel,
        channel: safeChannel,
        status: "active",
        currentStep: 1,
        history: [],
      };

      memorySessions.set(sessionId, sessionData);

      const prompt = buildPrompt({
        cvSummary: sessionData.cvSummary,
        jobDesc: sessionData.jobDesc,
        mode: sessionData.mode,
        level: sessionData.level,
        channel: sessionData.channel,
        history: [],
        step: 1,
      });

      const llmResponseText = await callLLM(prompt);

      let parsed: any;
      try {
        parsed = JSON.parse(llmResponseText);
      } catch {
        parsed = { next_question: "Parlez-moi de vous.", short_analysis: null };
      }

      const firstQuestion = parsed.next_question || "Parlez-moi de vous.";

      const historyItem: HistoryItem = {
        role: "interviewer",
        text: firstQuestion,
        createdAt: new Date().toISOString(),
      };

      const updatedSession = memorySessions.get(sessionId);
      if (updatedSession) {
        updatedSession.history.push(historyItem);
        updatedSession.currentStep = 1;
        updatedSession.lastUpdated = new Date().toISOString();
        memorySessions.set(sessionId, updatedSession);
      }

      await consumeCredit(userId);

      return NextResponse.json({
        sessionId,
        firstQuestion,
        shortAnalysis: parsed.short_analysis ?? null,
      });
    }

    // ---------- ANSWER ---------- //
    if (action === "answer") {
      const { userId, sessionId, userMessage, channel, step } = body as any;

      if (!userId || !sessionId || !userMessage?.trim()) {
        return NextResponse.json(
          { error: "Missing userId, sessionId or userMessage" },
          { status: 400 }
        );
      }

      const user = await verifyUserAndCredits(userId);
      if (!user) {
        return NextResponse.json(
          { error: "Unauthorized or no credits" },
          { status: 401 }
        );
      }

      const session = memorySessions.get(sessionId);
      if (!session) {
        return NextResponse.json({ error: "Session not found" }, { status: 404 });
      }

      if (session.userId !== userId) {
        return NextResponse.json({ error: "Forbidden" }, { status: 403 });
      }

      const history = Array.isArray(session.history) ? [...session.history] : [];

      history.push({
        role: "candidate",
        text: userMessage,
        createdAt: new Date().toISOString(),
      });

      const nextStep =
        typeof step === "number" && Number.isFinite(step)
          ? step
          : (session.currentStep || 1) + 1;

      const prompt = buildPrompt({
        cvSummary: session.cvSummary,
        jobDesc: session.jobDesc,
        mode: session.mode,
        level: (session.level || "junior") as InterviewLevel,
        channel: (channel || session.channel || "written") as InterviewChannel,
        history,
        step: nextStep,
      });

      const llmResponseText = await callLLM(prompt);

      let parsed: any;
      try {
        parsed = JSON.parse(llmResponseText);
      } catch {
        parsed = {
          next_question: "Merci. Peux-tu illustrer avec un exemple concret ?",
          short_analysis: "",
          final_summary: null,
          final_score: null,
        };
      }

      const nextQuestion =
        parsed.next_question || "Merci, l’entretien est terminé.";
      const shortAnalysis = parsed.short_analysis ?? "";
      const isFinal = Boolean(parsed.final_summary);

      history.push({
        role: "interviewer",
        text: nextQuestion,
        createdAt: new Date().toISOString(),
      });

      const updated: InterviewSession = {
        ...session,
        history,
        lastUpdated: new Date().toISOString(),
        currentStep: nextStep,
      };

      if (isFinal) {
        updated.status = "completed";
        updated.score = parsed.final_score ?? null;
        updated.finalSummary = parsed.final_summary ?? null;
      }

      memorySessions.set(sessionId, updated);

      await consumeCredit(userId);

      return NextResponse.json({
        nextQuestion,
        shortAnalysis,
        finalSummary: parsed.final_summary ?? null,
        finalScore: parsed.final_score ?? null,
        isFinal,
      });
    }

    return NextResponse.json({ error: "Unknown action" }, { status: 400 });
  } catch (err) {
    console.error("Interview API error:", err);
    return NextResponse.json({ error: "Internal error" }, { status: 500 });
  }
}

// ---- APPEL GEMINI ---- //
async function callLLM(prompt: string): Promise<string> {
  const apiKey = process.env.GEMINI_API_KEY;

  if (!apiKey) {
    return JSON.stringify({
      next_question:
        "Mode démo : peux-tu me résumer ton expérience la plus récente en lien avec ce poste ?",
      short_analysis:
        "Mode démo sans Gemini : configure GEMINI_API_KEY pour avoir l’analyse réelle.",
      final_summary: null,
      final_score: null,
    });
  }

  const modelRaw = process.env.GEMINI_MODEL || "models/gemini-2.5-flash";
  const model = modelRaw.startsWith("models/") ? modelRaw : `models/${modelRaw}`;
  const url = `https://generativelanguage.googleapis.com/v1beta/${model}:generateContent?key=${apiKey}`;

  const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };

  const resp = await fetch(url, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload),
  });

  if (!resp.ok) {
    const errorText = await resp.text().catch(() => "");
    console.error("Gemini error (interview):", resp.status, errorText);
    return JSON.stringify({
      next_question:
        "Je n'arrive pas à joindre l’IA. Donne-moi : contexte / actions / résultats (STAR).",
      short_analysis: `Fallback Gemini HTTP ${resp.status}`,
      final_summary: null,
      final_score: null,
    });
  }

  const data = await resp.json().catch(() => null);

  const textRaw: string =
    data?.candidates?.[0]?.content?.parts
      ?.map((p: any) => p.text || "")
      .join("")
      .trim() || "";

  if (!textRaw) {
    return JSON.stringify({
      next_question: "Peux-tu préciser ?",
      short_analysis: "",
      final_summary: null,
      final_score: null,
    });
  }

  return textRaw.trim();
}
````

## File: server/_api_disabled/api/jobs/route.ts
````typescript
// app/api/jobs/route.ts
import { NextRequest, NextResponse } from "next/server";

export const runtime = "nodejs";

// Clés Adzuna côté serveur Next
const ADZUNA_APP_ID = process.env.ADZUNA_APP_ID;
const ADZUNA_APP_KEY = process.env.ADZUNA_APP_KEY;

// Base CF pour vérifier reCAPTCHA côté serveur (anti-bypass)
const DEFAULT_API_BASE =
  "https://europe-west1-assistant-ia-v4.cloudfunctions.net";
const API_BASE = (
  process.env.NEXT_PUBLIC_API_BASE_URL ||
  process.env.API_BASE_URL ||
  DEFAULT_API_BASE
).replace(/\/+$/, "");

async function verifyRecaptchaServer(token: string, action: string) {
  const res = await fetch(`${API_BASE}/recaptchaVerify`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ token, action: (action || "").trim().toLowerCase() }),
    cache: "no-store",
  });

  const data: any = await res.json().catch(() => ({}));
  return { ok: res.ok && data?.ok === true, data };
}

type AdzunaRawJob = {
  id?: string;
  title?: string;
  company?: { display_name?: string };
  location?: { display_name?: string };
  redirect_url?: string;
  description?: string;
  created?: string;
  salary_min?: number;
  salary_max?: number;
};

type AdzunaRawResponse = {
  results?: AdzunaRawJob[];
  count?: number;
  mean?: number;
};

const ALLOWED_COUNTRIES = new Set([
  "fr",
  "be",
  "ch",
  "ca",
  "gb",
  "es",
  "de",
  "it",
]);

function asNumber(v: any): number | undefined {
  const n = typeof v === "number" ? v : Number(v);
  return Number.isFinite(n) ? n : undefined;
}

export async function POST(req: NextRequest) {
  try {
    const body = await req.json();

    const {
      query,
      location,
      country = "fr",
      page = 1,
      results_per_page = 50,

      // Filtres optionnels (front)
      contract_time, // "any" | "full_time" | "part_time"
      contract_type, // "any" | "permanent" | "contract"
      salary_min,
      salary_max,
      max_days_old,

      recaptchaToken,
    } = body || {};

    // ✅ reCAPTCHA (anti-bypass)
    const check = await verifyRecaptchaServer(
      String(recaptchaToken || ""),
      "jobs_search"
    );
    if (!check.ok) {
      return NextResponse.json(
        { error: "reCAPTCHA refusé", details: check.data },
        { status: 403 }
      );
    }

    if (!query && !location) {
      return NextResponse.json(
        { error: "query ou location requis" },
        { status: 400 }
      );
    }

    if (!ADZUNA_APP_ID || !ADZUNA_APP_KEY) {
      console.error("ADZUNA_APP_ID ou ADZUNA_APP_KEY manquants");
      return NextResponse.json(
        {
          error:
            "Clés Adzuna non configurées côté serveur. Ajoute ADZUNA_APP_ID et ADZUNA_APP_KEY dans ton .env.local.",
        },
        { status: 500 }
      );
    }

    const safeCountry = String(country || "fr").toLowerCase().trim();
    const countryCode = ALLOWED_COUNTRIES.has(safeCountry) ? safeCountry : "fr";

    const safePage = asNumber(page) && (page as number) > 0 ? Number(page) : 1;

    const rppRaw = asNumber(results_per_page) ?? 50;
    const safeRpp = Math.max(1, Math.min(100, Math.floor(rppRaw)));

    const params = new URLSearchParams();
    params.set("app_id", ADZUNA_APP_ID);
    params.set("app_key", ADZUNA_APP_KEY);
    params.set("results_per_page", String(safeRpp));
    params.set("content-type", "application/json");

    if (query) params.set("what", String(query));
    if (location) params.set("where", String(location));

    // Filtres Adzuna
    const salMin = asNumber(salary_min);
    const salMax = asNumber(salary_max);
    const maxDays = asNumber(max_days_old);

    if (salMin !== undefined) params.set("salary_min", String(Math.floor(salMin)));
    if (salMax !== undefined) params.set("salary_max", String(Math.floor(salMax)));
    if (maxDays !== undefined) params.set("max_days_old", String(Math.floor(maxDays)));

    // contract_time
    if (contract_time === "full_time") params.set("full_time", "1");
    if (contract_time === "part_time") params.set("part_time", "1");

    // contract_type
    if (contract_type === "permanent") params.set("permanent", "1");
    if (contract_type === "contract") params.set("contract", "1");

    // URL
    const url = `https://api.adzuna.com/v1/api/jobs/${countryCode}/search/${safePage}?${params.toString()}`;

    const resp = await fetch(url, {
      method: "GET",
      headers: { Accept: "application/json" },
    });

    if (!resp.ok) {
      const textErr = await resp.text();
      console.error("Erreur Adzuna:", resp.status, textErr);
      return NextResponse.json(
        { error: "Erreur lors de l'appel à l'API Adzuna." },
        { status: 500 }
      );
    }

    const data: AdzunaRawResponse = await resp.json();

    const jobs =
      (data.results || []).map((job, index) => ({
        id: job.id || `job-${safePage}-${index}`,
        title: job.title || "Offre sans titre",
        company: job.company?.display_name || "Entreprise non renseignée",
        location: job.location?.display_name || "Lieu non précisé",
        url: job.redirect_url || "",
        description: job.description || "",
        created: job.created || "",
        // ✅ important pour ton front (il calcule salary avec salary_min/max)
        salary_min: typeof job.salary_min === "number" ? job.salary_min : undefined,
        salary_max: typeof job.salary_max === "number" ? job.salary_max : undefined,
      })) || [];

    return NextResponse.json({
      jobs,
      meta: {
        country: countryCode,
        page: safePage,
        results_per_page: safeRpp,
        count: typeof data.count === "number" ? data.count : undefined,
      },
    });
  } catch (err) {
    console.error("Erreur /api/jobs:", err);
    return NextResponse.json(
      { error: "Erreur interne lors de la recherche d'offres (API jobs)." },
      { status: 500 }
    );
  }
}
````

## File: server/_api_disabled/api/letterAndPitch/route.ts
````typescript
// app/api/letterAndPitch/route.ts
import { NextRequest, NextResponse } from "next/server";

export const runtime = "nodejs";

function getModelPath(envValue: string | undefined, fallback: string): string {
  const raw = (envValue || fallback).trim();
  return raw.startsWith("models/") ? raw : `models/${raw}`;
}

// Base Cloud Functions pour vérifier reCAPTCHA côté serveur
const DEFAULT_API_BASE =
  "https://europe-west1-assistant-ia-v4.cloudfunctions.net";
const API_BASE = (
  process.env.NEXT_PUBLIC_API_BASE_URL ||
  process.env.API_BASE_URL ||
  DEFAULT_API_BASE
).replace(/\/+$/, "");

async function verifyRecaptchaServer(token: string, action: string) {
  const res = await fetch(`${API_BASE}/recaptchaVerify`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ token, action: (action || "").trim().toLowerCase() }),
    cache: "no-store",
  });

  const data: any = await res.json().catch(() => ({}));
  return { ok: res.ok && data?.ok === true, data };
}

// Helper: enlève ```json ... ``` si besoin
function extractJson(text: string): any | null {
  if (!text) return null;
  let t = text.trim();

  if (t.startsWith("```")) {
    t = t.replace(/^```[a-zA-Z]*\s*/, "").replace(/```$/, "").trim();
  }

  try {
    return JSON.parse(t);
  } catch {
    const match = t.match(/\{[\s\S]*\}/);
    if (match) {
      try {
        return JSON.parse(match[0]);
      } catch {
        return null;
      }
    }
    return null;
  }
}

export async function POST(req: NextRequest) {
  try {
    const body = await req.json();
    const {
      profile,
      jobTitle = "",
      companyName = "",
      jobDescription = "",
      lang = "fr",
      recaptchaToken,
    } = body || {};

    // ✅ Vérif reCAPTCHA (anti-bypass)
    const check = await verifyRecaptchaServer(
      String(recaptchaToken || ""),
      "generate_letter_pitch"
    );
    if (!check.ok) {
      return NextResponse.json(
        { error: "reCAPTCHA refusé", details: check.data },
        { status: 403 }
      );
    }

    if (!profile) {
      return NextResponse.json({ error: "Missing profile" }, { status: 400 });
    }

    const apiKey = process.env.GEMINI_API_KEY;
    if (!apiKey) {
      console.warn("[letterAndPitch] GEMINI_API_KEY manquant → mode démo.");
      return NextResponse.json({
        coverLetter:
          lang === "en"
            ? "Demo mode: here would be a tailored cover letter based on your CV and the job description."
            : "Mode démo : ici apparaîtrait une lettre de motivation personnalisée à partir de ton CV et de l'offre.",
        pitch:
          lang === "en"
            ? "Demo mode: here would be a short elevator pitch summarizing your profile for this job."
            : "Mode démo : ici apparaîtrait un court pitch d’ascenseur résumant ton profil pour ce poste.",
        lang,
      });
    }

    const model = getModelPath(process.env.GEMINI_MODEL, "gemini-2.5-flash");
    const url = `https://generativelanguage.googleapis.com/v1beta/${model}:generateContent?key=${apiKey}`;

    const profileJson = JSON.stringify(profile ?? {}).slice(0, 20000);

    const prompt = `
Tu es un assistant expert en candidatures.

À partir :
- du profil CV du candidat (en JSON),
- du poste visé (intitulé, entreprise),
- et d'éventuels extraits d'annonce,

tu dois produire :
1) une lettre de motivation complète (1 page max) prête à être envoyée,
2) un pitch d'ascenseur de 2 à 4 phrases pour se présenter rapidement.

Langue de sortie : ${lang === "en" ? "anglais" : "français"}.

Réponds STRICTEMENT au format JSON suivant, sans aucun texte avant ou après :

{
  "coverLetter": "string",
  "pitch": "string",
  "lang": "fr"
}

Où "lang" est "fr" ou "en".

Profil CV (JSON) :
${profileJson}

Informations sur le poste :
- Intitulé : ${jobTitle}
- Entreprise : ${companyName}
- Description / extraits d'annonce : ${jobDescription}
`.trim();

    const payload = {
      contents: [{ role: "user", parts: [{ text: prompt }] }],
      generationConfig: { response_mime_type: "application/json" },
    };

    const resp = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    });

    if (!resp.ok) {
      const errorText = await resp.text().catch(() => "");
      console.error("Gemini error (letterAndPitch):", resp.status, errorText);

      if (resp.status === 429) {
        return NextResponse.json({
          coverLetter:
            lang === "en"
              ? "Demo mode (quota exceeded): here is a short sample cover letter. Please try again later when the quota is reset."
              : "Mode démo (quota dépassé) : voici un exemple de lettre. Réessaie plus tard quand le quota sera réinitialisé.",
          pitch:
            lang === "en"
              ? "Demo mode (quota exceeded): here is a sample elevator pitch."
              : "Mode démo (quota dépassé) : voici un exemple de pitch d’ascenseur.",
          lang,
        });
      }

      return NextResponse.json({ error: "Gemini call failed" }, { status: 500 });
    }

    const data = await resp.json().catch(() => null);

    const textRaw: string =
      data?.candidates?.[0]?.content?.parts
        ?.map((p: any) => p?.text || "")
        .join("")
        .trim() || "";

    if (!textRaw) {
      console.error("Empty Gemini response (letterAndPitch):", data);
      return NextResponse.json({
        coverLetter:
          lang === "en"
            ? "Based on your experience and this role, explain in 3–4 paragraphs why you are a good fit."
            : "En te basant sur ton expérience et ce poste, explique en 3–4 paragraphes pourquoi tu es un bon profil.",
        pitch:
          lang === "en"
            ? "Summarize your profile in 2–3 sentences as if you were introducing yourself at the start of an interview."
            : "Résume ton profil en 2–3 phrases comme si tu te présentais en début d’entretien.",
        lang,
      });
    }

    const parsed = extractJson(textRaw);

    const coverLetter =
      typeof parsed?.coverLetter === "string" ? parsed.coverLetter.trim() : "";
    const pitch =
      typeof parsed?.pitch === "string" ? parsed.pitch.trim() : "";
    const outLang = typeof parsed?.lang === "string" ? parsed.lang : lang;

    if (!coverLetter && !pitch) {
      console.error("letterAndPitch: JSON non exploitable, texte brut :", textRaw);
      return NextResponse.json({
        coverLetter:
          lang === "en"
            ? "Based on your CV and this job, write a motivation letter explaining why you are a good match."
            : "À partir de ton CV et de cette offre, rédige une lettre de motivation expliquant pourquoi tu corresponds au poste.",
        pitch:
          lang === "en"
            ? "Give a short pitch (2–4 sentences) summarizing your profile for this job."
            : "Donne un court pitch (2–4 phrases) résumant ton profil pour ce poste.",
        lang,
      });
    }

    return NextResponse.json({ coverLetter, pitch, lang: outLang });
  } catch (err) {
    console.error("letterAndPitch API error:", err);
    return NextResponse.json({ error: "Internal error" }, { status: 500 });
  }
}
````

## File: server/_api_disabled/api/linkedin/exchange/route.ts
````typescript
// app/api/linkedin/exchange/route.ts
import { NextRequest, NextResponse } from "next/server";
import qs from "querystring";

// ⚠️ Mets ces valeurs dans .env.local (voir plus bas)
const CLIENT_ID = process.env.LINKEDIN_CLIENT_ID!;
const CLIENT_SECRET = process.env.LINKEDIN_CLIENT_SECRET!;
const REDIRECT_URI = process.env.LINKEDIN_REDIRECT_URI!; // doit matcher l'URL callback

export async function POST(req: NextRequest) {
  try {
    const { code } = await req.json();

    if (!code) {
      return NextResponse.json(
        { error: "Missing authorization code" },
        { status: 400 }
      );
    }

    // 1) Échanger le code contre un access_token + id_token
    const tokenResp = await fetch(
      "https://www.linkedin.com/oauth/v2/accessToken",
      {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded"
        },
        body: qs.stringify({
          grant_type: "authorization_code",
          code,
          redirect_uri: REDIRECT_URI,
          client_id: CLIENT_ID,
          client_secret: CLIENT_SECRET
        })
      }
    );

    if (!tokenResp.ok) {
      const text = await tokenResp.text();
      console.error("LinkedIn token error:", text);
      return NextResponse.json(
        { error: "Failed to exchange code", details: text },
        { status: 400 }
      );
    }

    const tokenJson = (await tokenResp.json()) as any;

    // LinkedIn peut renvoyer un id_token si on a demandé scope "openid"
    const idToken = tokenJson.id_token;
    const accessToken = tokenJson.access_token;

    if (!idToken) {
      // On peut continuer avec accessToken si besoin, mais pour Firebase OIDC,
      // on veut surtout un id_token. Si pas dispo, renvoie erreur claire.
      return NextResponse.json(
        {
          error:
            "LinkedIn n'a pas renvoyé d'id_token (vérifie que le scope openid est bien activé)"
        },
        { status: 400 }
      );
    }

    return NextResponse.json({ idToken, accessToken });
  } catch (e: any) {
    console.error("LinkedIn exchange error:", e);
    return NextResponse.json(
      { error: "Server error", details: e.message },
      { status: 500 }
    );
  }
}
````

## File: server/_api_disabled/api/linkedin/token/route.ts
````typescript
// app/api/linkedin/token/route.ts
import { NextRequest, NextResponse } from "next/server";

export async function POST(req: NextRequest) {
  try {
    const { code } = await req.json();

    if (!code) {
      return NextResponse.json(
        { error: "code manquant" },
        { status: 400 }
      );
    }

    const clientId = process.env.LINKEDIN_CLIENT_ID!;
    const clientSecret = process.env.LINKEDIN_CLIENT_SECRET!;
    const redirectUri = process.env.LINKEDIN_REDIRECT_URI!;

    const body = new URLSearchParams({
      grant_type: "authorization_code",
      code,
      redirect_uri: redirectUri,
      client_id: clientId,
      client_secret: clientSecret,
    });

    // Appel LinkedIn pour échanger le code
    const resp = await fetch("https://www.linkedin.com/oauth/v2/accessToken", {
      method: "POST",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded",
      },
      body: body.toString(),
    });

    const data = await resp.json();

    if (!resp.ok) {
      console.error("LinkedIn token error:", data);
      return NextResponse.json(
        { error: "Erreur LinkedIn", details: data },
        { status: 400 }
      );
    }

    // Avec le scope "openid", LinkedIn peut renvoyer un id_token
    const idToken = (data as any).id_token;

    if (!idToken) {
      return NextResponse.json(
        {
          error:
            "id_token manquant dans la réponse LinkedIn. Vérifie que le scope 'openid' est bien activé.",
          details: data,
        },
        { status: 400 }
      );
    }

    return NextResponse.json({ idToken });
  } catch (e: any) {
    console.error("API /api/linkedin/token error:", e);
    return NextResponse.json(
      { error: e.message ?? "Erreur serveur" },
      { status: 500 }
    );
  }
}
````

## File: server/_api_disabled/api/polar/checkout/route.ts
````typescript
// src/app/api/polar/checkout/route.ts
// @ts-nocheck
import { NextRequest, NextResponse } from "next/server";
import { createPolarCheckout, CreditPackId } from "@/lib/polar";

// Cette route tourne en mode node en dev / en mode serveur
export const runtime = "nodejs";
// ⚠️ NE PAS mettre `export const dynamic = "force-dynamic"` ici en output: "export"

export async function POST(req: NextRequest) {
  try {
    let body: any = null;
    try {
      body = await req.json();
    } catch (e) {
      console.error("[/api/polar/checkout] Body non JSON ou vide");
      return NextResponse.json(
        {
          ok: false,
          error: "Body JSON invalide pour /api/polar/checkout.",
        },
        { status: 400 }
      );
    }

    const packId = body.packId as CreditPackId | undefined;
    const userId = body.userId as string | undefined;
    const email = body.email as string | undefined;

    console.log("[/api/polar/checkout] body reçu :", body);

    if (!packId || !userId || !email) {
      console.error("[/api/polar/checkout] Paramètres manquants", {
        packId,
        userId,
        email,
      });
      return NextResponse.json(
        {
          ok: false,
          error:
            "Paramètres manquants. Il faut packId ('20' | '50' | '100'), userId et email.",
        },
        { status: 400 }
      );
    }

    // Vérif rapide des variables d'env
    if (!process.env.POLAR_ACCESS_TOKEN) {
      console.error("[/api/polar/checkout] POLAR_ACCESS_TOKEN manquant");
      return NextResponse.json(
        {
          ok: false,
          error: "Config Polar manquante (POLAR_ACCESS_TOKEN).",
        },
        { status: 500 }
      );
    }

    const { url } = await createPolarCheckout({
      packId,
      userId,
      email,
    });

    console.log("[/api/polar/checkout] Checkout créé, URL :", url);

    // Toujours renvoyer du JSON
    return NextResponse.json({ ok: true, url }, { status: 200 });
  } catch (error: any) {
    console.error("[/api/polar/checkout] ERREUR :", error);

    return NextResponse.json(
      {
        ok: false,
        error: "Erreur lors de la création du checkout Polar.",
        detail: error?.message ?? String(error),
      },
      { status: 500 }
    );
  }
}
````

## File: server/_api_disabled/api/polar/test/route.ts
````typescript
// src/app/api/polar/test/route.ts
import { NextResponse } from "next/server";
import { polar } from "@/lib/polar";

export async function GET() {
  try {
    // Appel simple à l'API Polar en prod
    const result = await polar.products.list({});

    // On renvoie directement ce que Polar renvoie,
    // sans essayer de boucler ni de faire des "..."
    return NextResponse.json({ ok: true, result });
  } catch (error: any) {
    console.error("Erreur Polar test (prod):", error);
    return NextResponse.json(
      {
        ok: false,
        message:
          "Erreur d'appel à Polar (prod). Vérifie POLAR_ACCESS_TOKEN si ça persiste.",
        detail: error?.message ?? String(error),
      },
      { status: 500 }
    );
  }
}
````

## File: server/_api_disabled/api/stt/route.ts
````typescript
import { NextRequest, NextResponse } from "next/server";

export const runtime = "nodejs";

// Nettoie le nom du modèle si nécessaire
function getModelName(envValue: string | undefined, fallback: string): string {
  const raw = (envValue || fallback).trim();
  // On accepte "gemini-2.5-flash" ou "models/gemini-2.5-flash"
  return raw.replace(/^models\//, "");
}

export async function POST(req: NextRequest) {
  try {
    const formData = await req.formData();
    const file = formData.get("audio") as File | null;

    if (!file) {
      return NextResponse.json(
        { error: "Aucun fichier audio reçu (champ 'audio' manquant)." },
        { status: 400 }
      );
    }

    const arrayBuffer = await file.arrayBuffer();
    const buffer = Buffer.from(arrayBuffer);
    const base64 = buffer.toString("base64");
    const mimeType = file.type || "audio/webm";

    const apiKey = process.env.GEMINI_API_KEY;
    if (!apiKey) {
      console.error("[/api/stt] GEMINI_API_KEY manquant.");
      return NextResponse.json(
        { error: "GEMINI_API_KEY manquant côté serveur." },
        { status: 500 }
      );
    }

    // Modèle audio (configurable via env)
    const configuredModel = getModelName(
      process.env.GEMINI_STT_MODEL,
      "gemini-2.5-flash"
    );

    const url = `https://generativelanguage.googleapis.com/v1beta/models/${configuredModel}:generateContent?key=${apiKey}`;

    const prompt =
      "Transcris mot à mot l'audio suivant en texte. " +
      "Réponds uniquement par la transcription, sans guillemets ni commentaire.";

    const payload = {
      contents: [
        {
          role: "user",
          parts: [
            { text: prompt },
            {
              inlineData: {
                mimeType,
                data: base64,
              },
            },
          ],
        },
      ],
    };

    const resp = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    });

    const status = resp.status;
    const bodyText = await resp.text().catch(() => "");

    if (!resp.ok) {
      console.error("Erreur Gemini STT:", status, bodyText);

      if (status === 429) {
        return NextResponse.json(
          {
            error:
              "Quota Gemini STT dépassé. Réessaie un peu plus tard.",
          },
          { status: 429 }
        );
      }

      return NextResponse.json(
        { error: `Erreur Gemini (${status})` },
        { status: 500 }
      );
    }

    let data: any;
    try {
      data = JSON.parse(bodyText);
    } catch {
      return NextResponse.json(
        { error: "Réponse invalide de Gemini (JSON)" },
        { status: 500 }
      );
    }

    const transcript: string =
      data?.candidates?.[0]?.content?.parts
        ?.map((p: any) => p?.text || "")
        .join("")
        .trim() || "";

    return NextResponse.json({ transcript });
  } catch (err) {
    console.error("Erreur interne /api/stt:", err);
    return NextResponse.json(
      { error: "Erreur interne sur /api/stt" },
      { status: 500 }
    );
  }
}
````

## File: server/_api_disabled/api/webhook/polar/route.ts
````typescript
// @ts-nocheck
import { NextRequest, NextResponse } from "next/server";
import {
  validateEvent,
  WebhookVerificationError,
  WebhookHeaders,
} from "@polar-sh/sdk/webhooks";
import {
  addCreditsToUserById,
  addCreditsToUserByEmail,
} from "@/lib/credits";

export const runtime = "nodejs";

// ✅ mapping product_id -> crédits (depuis tes .env)
const PRODUCT_ID_TO_CREDITS: Record<string, number> = {};

if (process.env.POLAR_PRODUCT_20_ID) {
  PRODUCT_ID_TO_CREDITS[process.env.POLAR_PRODUCT_20_ID] = 20;
}
if (process.env.POLAR_PRODUCT_50_ID) {
  PRODUCT_ID_TO_CREDITS[process.env.POLAR_PRODUCT_50_ID] = 50;
}
if (process.env.POLAR_PRODUCT_100_ID) {
  PRODUCT_ID_TO_CREDITS[process.env.POLAR_PRODUCT_100_ID] = 100;
}

// GET juste pour tester depuis le navigateur
export async function GET() {
  return NextResponse.json({
    ok: true,
    env: process.env.POLAR_ENV,
    mappedProducts: PRODUCT_ID_TO_CREDITS,
    message:
      "Endpoint webhook Polar OK. Utilisé en POST par Polar, pas en GET par le navigateur.",
  });
}

// Webhook POST appelé par Polar
export async function POST(req: NextRequest) {
  const secret = process.env.POLAR_WEBHOOK_SECRET;
  if (!secret) {
    console.error("POLAR_WEBHOOK_SECRET manquant");
    return new NextResponse("Config manquante", { status: 500 });
  }

  // 1) Body brut (texte) pour la vérification de signature
  const body = await req.text();

  // 2) Headers envoyés par Polar
  const headers: WebhookHeaders = {
    "webhook-id": req.headers.get("webhook-id") ?? "",
    "webhook-timestamp": req.headers.get("webhook-timestamp") ?? "",
    "webhook-signature": req.headers.get("webhook-signature") ?? "",
  };

  let event: any;
  try {
    // 3) Vérifier la signature + parser l'event
    event = validateEvent(body, headers, secret);
  } catch (error) {
    if (error instanceof WebhookVerificationError) {
      console.error("Signature Polar invalide");
      return new NextResponse("Signature invalide", { status: 403 });
    }
    console.error("Erreur webhook Polar:", error);
    return new NextResponse("Erreur interne", { status: 500 });
  }

  console.log("📬 Webhook Polar reçu:", event.type);

  // 4) Gestion des événements
  switch (event.type) {
    case "order.paid": {
      const data = event.data;

      console.log("💰 order.paid data brut:", JSON.stringify(data, null, 2));

      const productId = data.product_id as string | undefined;
      const creditsToAdd =
        (productId && PRODUCT_ID_TO_CREDITS[productId]) ?? 0;

      const externalId: string | undefined =
        (data.customer?.external_id as string | undefined) ?? undefined;
      const email: string | undefined =
        (data.customer?.email as string | undefined) ?? undefined;

      console.log("👤 Client pour crédit:", {
        productId,
        creditsToAdd,
        externalId,
        email,
      });

      if (creditsToAdd > 0) {
        try {
          if (externalId) {
            await addCreditsToUserById(externalId, creditsToAdd);
          } else if (email) {
            await addCreditsToUserByEmail(email, creditsToAdd);
          } else {
            console.warn(
              "⚠️ Aucun externalId ni email dans l'order.paid, impossible de créditer l'utilisateur."
            );
          }
        } catch (e) {
          console.error("Erreur lors de l'ajout de crédits Firestore:", e);
          // On n'échoue pas le webhook : Polar considère le paiement OK
        }
      } else {
        console.log(
          "Produit non mappé dans PRODUCT_ID_TO_CREDITS, aucun crédit ajouté."
        );
      }

      break;
    }

    default:
      console.log("Event non géré explicitement:", event.type);
  }

  // 5) Réponse OK pour Polar
  return NextResponse.json({ received: true });
}
````

## File: .firebase/hosting.Lm5leHQ.cache
````
required-server-files.json,1764026729350,faa6020d48adf6312d77ee01042cf6db7bce645322cec2497961e1fcf6323c07
react-loadable-manifest.json,1764026716482,a4b04944443134617e3f0ce2d83bd80777944443377c1b3d27d20980cd705f74
prerender-manifest.json,1764026735152,c2dc04e5dabc25e9acc484a2f3460a62c09af8ede877366b92f51c7fdddba5d4
routes-manifest.json,1764026698224,c555d09020c1ff150941161b9ffc7c997b163ac15f30362a0bed428829832180
prerender-manifest.js,1764026735242,c303b184a8a946bc7e3178fc2577c9d562e9b2ffef83363530d37b0e22dc244c
package.json,1764026698223,bcb9a16329e98e1c8a36644006703f1ec868425fd8a87f6e56461c280b826234
next-minimal-server.js.nft.json,1764026743650,03fda4dba157e3caf24f302b96fe9664d8bec48b55b00d683b6ba17d486fa52f
next-server.js.nft.json,1764026743650,f4f5ad4c61d468a0f4acf7234de162444a89622b9f67a97128027b3fe92923c2
images-manifest.json,1764026735376,5debd95a6cb1ddabb0f4052b9ffa429290ee932f8cafc4ec0aab6d9f85e1cf55
export-marker.json,1764026735452,56b9bc6d101d87fcd90a42b4b20f18c87e9ad5fd6523ba1b2fa67f01c00843a2
build-manifest.json,1764026716483,1ea5b8a9339bbe2731223db127d0d67559807118e45a5a2ff7df9eff69b2dc9b
app-path-routes-manifest.json,1764026727489,0f7e2d1f6b9259941d2a2314c3a8947307a1354e3fd6cff1cf2a39e00b2d6e92
app-build-manifest.json,1764026716483,a85c7e52f7458bcba0e631143f1bb4177504b67e10dda402725ccbae62600efe
BUILD_ID,1764026729338,8ffea43f5de75690d4b9438d09393a005a72499ab5e565a70be72287abf8b43c
types/package.json,1764026705341,fb83e1c2e553bcd88716e880a7ad4c4a77e92bdc857ac531d99436a10cea04cf
types/app/page.ts,1764026705308,eb5f4e457ec07e31870d6aea56e3e55b8554c6024ca41292e56de4fb3092cc68
types/app/layout.ts,1764026705341,e84d5dc310608f208720abf21293e6a60114940444c9cff3f4ba76a03ba4d588
types/app/tech/page.ts,1764026705308,1c1809941d2ff3ec07d2670ca7367cb0175ce3159f37236a2e406a21575490c3
types/app/signup/page.ts,1764026705308,2ecd725092fe78e6df6710e98a6065a24f4023f08ec6cf7f96891ffbb3c7dbb1
types/app/login/page.ts,1764026705308,f25be1d3cca2bde80b18561cd235c15fd1b027514d619b383d05879d6b191d67
types/app/auth/verify-email/page.ts,1764026705310,ca58d246324b7d9e65b0b840cbb8277cc29eba583b02c633b24572c91e756bc7
types/app/assistance-candidature/page.ts,1764026705308,55d4152496dbd96043d2461bd92ed9da4526a59d5e65da62bfa38eb804b59adf
types/app/app/page.ts,1764026705310,e72891a038ac654f4c1eee106b84fe9c84d104e5c1fa943bfaa683c9417ea831
types/app/app/tracker/page.ts,1764026705335,486c4ede492e2d58ecd1ef492aab0801a80663818e5869f2000076da64e38ec5
types/app/app/settings/page.ts,1764026705340,005d08996f221e5a26fd79615992288bf4683e2b1424625003e18b105621d539
types/app/app/pitch/page.ts,1764026705323,32b4c30794640bfcfac04ad8decfabf7b8f2d683346bb53b2bed1132b02005b5
types/app/app/lm/page.ts,1764026705340,2233e5615e959240bac8ad67c0db8beea8f9f19fee57661de34b9f380fa6d789
types/app/app/interview/page.ts,1764026705340,9d78266af5c0f20bec41e7f03cae3681fc6c654a722e359d3fab95613039099b
types/app/app/history/page.ts,1764026705341,8a87b2de60976ed83e769956351c4a520f2a9971134d448ead947683c9894e53
types/app/app/cv/page.ts,1764026705340,f3976927c7206640aa5edeb639f91394c004ac0e7df3b2d6776a34345c5629f1
types/app/app/credits/page.ts,1764026705335,9318f268d91b6cbb421d05fba6440521dda42fcbd8de5eeded42c1e17609cd19
types/app/app/apply/page.ts,1764026705340,fbf31f45950016f60250a4a68be2f3844580fe28ee8746ec3eeda1be96949288
types/app/api/polar/webhook/route.ts,1764026705336,ef908572982192c9c27ede864e28b0adc21ecb6b5999a92fd24bbb20d48e04ba
types/app/api/linkedin/token/route.ts,1764026705336,b6acc7578d8b261dde27ca5221926edc9dcc6ffae4b7c717086247f186ec126d
types/app/api/linkedin/exchange/route.ts,1764026705337,4ea317891c345be889c9f48705e043e68f2bb2ffedb699eaf7f391dd572e3151
types/app/admin/page.ts,1764026705308,f4adbbf8eb01a045ab920a9c925ee8829da2e3c2869fcf007ac944e6ff12573f
types/app/admin/login/page.ts,1764026705313,45292f68178863776fa57801f8e2cc7839220fbc6799ea95a35d9feb770d2a60
static/chunks/webpack-91b2d14d0f678b80.js,1764026716472,7c5b4f6fc9c1c64625417a25000feb25495d11438ab49c90c36caf9d44e92e41
static/css/f22078e41cee5400.css,1764026716494,c7f33f4b5844e54993038946795c4511df4869cc0e7bd46d4f354a67714e0dc2
static/chunks/main-app-2e7364934d9bcc31.js,1764026716459,7202fc85e98aa93028029008f04ed2823d9a1809fcb72df44136c86df86c7def
trace,1764026743694,f8982d26a68ebf31317c92875f27a5817a817abfb80054656438167c9ea5d48a
static/chunks/621-3d25d5ee54bc5eb1.js,1764026716483,d5ce8437d45b55a2628db37c20cfe2c717971b5e9ca112e83beae4c6ca49bf52
static/chunks/polyfills-78c92fac7aa8fdd8.js,1764026716483,a5b39edcc77b6069d442b5dbeb8091cf27ac47ac7a1a99cfc325213bdaae2fb5
static/chunks/main-2794a98e2503d678.js,1764026716459,8835a50251026fb0b1617e03639469a4ad86883c4ec70e881e041e31ba8ec66a
static/chunks/69806262-c31872e60297e46d.js,1764026716473,4f4211a27aba4cfd537d50cd51661fcb603d911bd0635b3487c5bc4980bc0c6f
static/chunks/pages/_error-1be831200e60c5c0.js,1764026716460,7ba7b69d070dbc710e451691d369b4ce050c7aff928d7ff030baa21135383430
static/chunks/pages/_app-6a626577ffa902a4.js,1764026716459,033ba1808728c513ad0a88d7ddf19b808f355e4bccb8e18dd6b1928961cf7a45
static/chunks/138-7507c07ab2f9fc1d.js,1764026716483,91e92091a4d37d24da31f94ea676dce2e0025aa584bf1d4a0d8c3524724926b4
static/chunks/app/not-found-0d92631d0244d996.js,1764026716459,c13384c322e45582ecb54e7581d10f6105a2e6f929d88b88a4fb3699c2042dab
static/chunks/app/layout-a618519e30fc5082.js,1764026716459,ead943790b104200135437395cd72a436cd761755cff12d9bb499a995f5ba3c7
static/chunks/app/page-190ea484f1cfb43c.js,1764026716459,3edcd45c01c081de96cde9e577c19bfb60fa523fb8db2130b72c31fb37db2fdc
static/chunks/955-3cd8599ce6aa07c2.js,1764026716482,480a8d35d35df333d9754ff92b6c5e523e4649270ebf535ec31aff8256bab0ca
static/chunks/app/tech/page-53b001589ec4b409.js,1764026716460,82387e0dc4c5ab6527090c260f51d025e5a2e07867679264f4dd83d63acb4954
static/chunks/app/signup/page-591af0428c3c8d19.js,1764026716459,6eea57794e7ad969d32d0aba976ae81201105f5d07cb42995c36d713dac2679c
static/chunks/app/login/page-383e7d3fb5f56246.js,1764026716460,97e046275c288f6cc40e2aeb32c4ecbb409ba7f415b3805ca275fbd88034cc0a
static/chunks/app/auth/verify-email/page-ac86f774492d8f10.js,1764026716460,b49a5154c933ccf2153a02edf6e8f7607f7c022c12ef2cef4fda7b3c38a01fef
static/chunks/app/assistance-candidature/page-4e3c0a0fbfaa46b9.js,1764026716459,5ea28e433b8f80ac391dace8d3af730568b30c0fc88328dab306688b43caff8b
static/chunks/app/app/lm/page-d2424b1c58ec485f.js,1764026716471,4b7b2dc1668e8a9af41882a291f8498c0917ee195675af10a3ab0c05347585ce
static/chunks/app/app/page-93cc857ad2ae5002.js,1764026716472,deb3b43928d34631b9960284e84ae575600416f3f4e43d00878ec476cb85f157
static/chunks/app/app/credits/page-e697f2bb8d726ec9.js,1764026716474,d738c16316413f56a09a8bb7246b9ad9df561eec2205c30b83af6a422e156272
static/chunks/app/app/layout-6aed7b227000a15a.js,1764026716472,c3e1ff34f45c8e28aed9bb74fe054d4c3d26940b7b7dc015dd2b4249cad51507
static/chunks/app/app/apply/page-ff605542414d7f7f.js,1764026716471,3d1a478dc7704b5fb18f64410fc3872edea77f1e7d65c0820632b79f0991982c
static/chunks/app/admin/login/page-240daa14bb4852c0.js,1764026716460,ae17b8fa6940c6f38f0c1e6268f3d82a79d22b6033f0f074c834c9e4831618e1
static/chunks/app/admin/page-8857cf2a57926d01.js,1764026716459,9045bdbd33a422215036810dbb37d02cac3c3d959114dfef839ff197ec9c3a40
static/chunks/app/_not-found/page-29db342e34374c89.js,1764026716459,13d3e75033764ed3306d7ec29efe4c83d3e4cc0af66065fd8578935ffb4df03a
static/-dT6A1SvnRSySsEbysDYr/_ssgManifest.js,1764026735319,02dbc1aeab6ef0a6ff2ff9a1643158cf9bb38929945eaa343a3627dee9ba6778
static/-dT6A1SvnRSySsEbysDYr/_buildManifest.js,1764026716489,d69e5a007397f17b35522afa5231f150a71e70144a0b25094b29b45bb5e6de96
server/server-reference-manifest.json,1764026705342,ca34e4b77172d3b8b2702eaac9586210574c409b034aa6dc731084dbc23786a9
server/webpack-runtime.js,1764026705293,f45ae6f81d5f7169cc53c6f3fa69a4c25238876a6692c08599ed810c58bd416f
server/pages-manifest.json,1764026734952,6b5834025a891ba7f8c4c4d40d486c8fc382a0b20353347d0b1e3e9265a45d00
server/next-font-manifest.json,1764026716491,7b3fdd39ef88a4f1a399b6c5db0e293276d61e74616d22506da791d19c18853d
server/middleware-react-loadable-manifest.js,1764026716485,ab4b3550c791b0ce095966989fb559527bc579db9697f53478f9996a28acf179
server/next-font-manifest.js,1764026716491,0516113d642299cc41ed8dfbcc3411732df29e0731dcf16fb2c18ce648e556fc
server/server-reference-manifest.js,1764026705341,ad544a760a19d613df67fe08face8e009a2f0d83a57ba0b29760deaf00b01ece
server/middleware-manifest.json,1764026708873,44131e01ea364a61de764fb249651ffe6fdcae5b7ab75e7f56ab60aeeed8e9dc
server/interception-route-rewrite-manifest.js,1764026708873,0e1ba25843e7639a44c34068a45a9e043402eeb3cd1ccc5c2d84b99b6ec810ac
server/middleware-build-manifest.js,1764026716485,5be83cf816efb1c65bf3cda845c83b875abf6811bc389e40bbaaf1f6857801a6
static/chunks/app/app/tracker/page-0ce47c9c65c0fc6d.js,1764026716471,3e41ecc6f797416d7f4830d2bb5fda4439984de5cc9c13501438412b3a9f5cef
server/functions-config-manifest.json,1764026729286,6b736f30bb3e680388457fe5fbb0293db3a6fb06c47a7df50a348236717fa747
static/chunks/app/app/cv/page-4c9c75503c5069c8.js,1764026716474,058266404ce25a3d25b9fc797c1af672ab0d4dc7873c60615413bc7db1e7f7b5
static/chunks/app/app/settings/page-8c2e33a56a848599.js,1764026716471,97a5c69d6ab86734367532759ccada046ef4b8a39a261f0ec60e4650d0308778
static/chunks/framework-aec844d2ccbe7592.js,1764026716472,7885994d6203224805fffa95f6a6551af6903a76bbec7b9292d3ea205e7d447f
static/chunks/app/app/pitch/page-c31ce7b3525e659c.js,1764026716472,6531b907e07757401e38643ff35e9a408b220fdaa1469a164e10575627a68391
server/font-manifest.json,1764026705298,6731668a37f6a3ed10d77860e21c7ba693c377a061571ffa58564d1d699c1798
static/chunks/app/app/history/page-ba2f61e7c7cba866.js,1764026716474,544e40ded57e5639de2f84d5c6885ec08d561ee40ce2cfbccc9a821ad27f6b45
static/chunks/app/app/interview/page-bd53d6b7237f5620.js,1764026716471,dcd71273057154c86d38f8fd2ebd663e8283f8917a5571838ebd0a8e557d1707
static/chunks/fd9d1056-41afe60f3d3c21b2.js,1764026716488,1ad5b60900951695550bcfb3b5d43784825075257435b5badf3d5a7ed4b9e1f9
server/app-paths-manifest.json,1764026708856,45cdce38d3d1053f583b65c1192527cc7fb98391a72500cc8ef6a7ff0ef4ad7c
static/chunks/ca377847-ba88b40a0691822b.js,1764026716483,f3518b038f5ba71224751678bfd02c707f512eefa5d99b943a692d6f622dc782
server/pages/_error.js.nft.json,1764026743627,f3103a2cfb0e52a9142f5cc1cec951e7df09a28c7866b47c952c49f6d6948448
static/chunks/23-a018d5b946342a64.js,1764026716483,ecc22580e6753b5bc285b46a3d4336d95e37f088effb8ab7d47f4d409d6fee9e
server/pages/_error.js,1764026705283,9d1484768dbdce62ae27550ee0aac87c0536b4b01538cf2ebe5915abb36d73aa
server/pages/_document.js.nft.json,1764026743625,1dd6b313b1f1df84db1c05ed61eecb61fb22a30586efffacb790ec02f90c4bb3
static/chunks/bc9e92e6-c92f39a73848b8a1.js,1764026716472,0ca8c089ad5759331761854b39e094ef24612544c3168410548694e9c6e39b55
server/pages/_document.js,1764026705289,ca5276420d329a86d6e2c6caef0b20a86f4060fb2bd896f4402c340574b1bccd
server/pages/_app.js.nft.json,1764026743632,f2ae4965a89bff1105ee000b4bc1f1ba040469c3f396e9ed79df07183847998c
server/pages/404.html,1764026734419,2a92d454d1b10bcb8e5b90c0b4f5713a80604534421865f4718537521ce9edf3
server/pages/_app.js,1764026705283,a096157015a2ee91a3984993ff98682529ad435c4329eb6ab6ec2f4fb7526ee6
server/pages/500.html,1764026732565,9dedaef1bccf8b51bbd4c1384d7ccfdf9058f85fdb7135ff8bc28f98d09e713b
server/chunks/682.js,1764026705296,6a55378f19ef26f47fbf66ad6b48b5748e5a7362772a03d202666923760c1e0e
server/chunks/972.js,1764026705294,043102158eeed7586923d8ccb7f4919c6e03838e09781a28a7e21c0bf501347f
server/chunks/10.js,1764026705298,58062128d087253d99f7dc626327229010b1b42eb620ebcf62f2e031b37a535e
server/app/tech.rsc,1764026734276,d2b3ffaec2c87d96c92d6e8573f916400a5c6808c7e6962e210f8a37cf9c4070
server/app/signup.rsc,1764026734275,2669465a36bda815d470758e6a29eb4acf66315049fb7254ee472293bc1a839f
server/app/tech.html,1764026734280,1a0a62430c185dd4733e86cfe9094b29d914812ffa81565f975dacb7c6a212cd
server/app/signup.meta,1764026734283,1cf7ec4b44fa726f7cf2f4f406aa5858e7ddd0a3ace5f41848d08fdbdc3710b8
server/app/signup.html,1764026734280,c0f3d377ca269e095072bfcaca236b264be51d202d3e0e53ad6c6bce28425614
server/app/tech.meta,1764026734282,b606cdc8a28c2ca43bbf810d893410eacf65cb38d5936bf1d2a2cbb096aeb47e
server/app/page_client-reference-manifest.js,1764026716491,f6666f371b5566cb6dc0332593948d0ab1db8fc5c7ff837e91d373e7be52044c
server/app/login.meta,1764026733996,679384b27256e79d6787a0422a20ff18e239f15a72dce53443e9a3672ebb9462
server/app/index.meta,1764026734058,e9cb1abe59404b1848c500ac3b6029bf17116af5bbd827f20260f2f077fe0d2f
server/app/login.html,1764026733996,c71b92cb4e734cfcb97cd05aec2f5e4f1d2d6be200473feaaa788dbfbad5bced
server/app/index.rsc,1764026734056,c22cc93a96116d70263e1b8ddd916282c26dc7766c69551e435fdd7bd2b78958
static/chunks/537-ce8c447b5bd64451.js,1764026716482,0450691049244cddbca2d67e1e0dc5006bb87db3de4d8241e8025d00a35df387
server/app/page.js.nft.json,1764026743625,6c24862ba2dc96868dbae9fc6285e6849eecf4935514c919bab08319abc6ac42
server/app/assistance-candidature.meta,1764026733756,00a26dd8b3f23eea682f5680b5e19dc2cb4208d4582978a5cfad884598ed8cf1
server/app/page.js,1764026705284,8077e599228bd79bd609dafa51a3bc9eefa7310575c321e8a733b6f9acbfba8d
server/app/app.meta,1764026734137,2194b0478a36dd1305b778f19930aa2c5e954f69368a9754cca6497d31a38a03
server/app/assistance-candidature.html,1764026733755,ca0785855d9a6e74ca71b7c592d04e9729dea0be113c5e8f123a6baf291d7c3d
server/app/index.html,1764026734057,b3c358fe8644453109f63842214c39e781bd028ba8f564c3a46600d1dc73b6bf
server/app/assistance-candidature.rsc,1764026733753,085b5f5d02075cc7831e5685da4698bd195f8bca8e5d98d90dc04a43ab770d00
server/app/app.rsc,1764026734134,c063a2c72b60a0ab00edb158b474794fafe3f163caedf530b40b9317f66959fb
server/app/login.rsc,1764026733995,2d3efda02f056683d18904c2a8b90691f9431fc2f7886ad620a956633d9c2ae5
server/app/admin.meta,1764026734286,bad0bdc40e9b73db07237079f2a6b06235490bc56fd7f6a8b690715b776fdbef
server/app/admin.rsc,1764026734281,190316dacf7193c6adfcbd5432605d3fb8558101e679859b05935b4dfc74e0a0
server/app/_not-found.rsc,1764026733382,5696cea366f6693fba34d602c73bd7006e98acb9452eba68627691b7ced74b34
server/chunks/font-manifest.json,1764026705282,6731668a37f6a3ed10d77860e21c7ba693c377a061571ffa58564d1d699c1798
server/app/_not-found.meta,1764026733388,9b0ddfb98f277970ee75de2f4f80679d4dd59e2a89b379098d839d061197756a
server/app/app.html,1764026734136,264f638ccb796245130f1b0de12b5a272a5c951f8feb62814b753befd2d0d966
server/app/admin.html,1764026734284,5a291647c83b11c32fefd0be5b61a8c39663adb4d4dec39d978a76d91657e978
server/app/_not-found.html,1764026733383,2a92d454d1b10bcb8e5b90c0b4f5713a80604534421865f4718537521ce9edf3
server/app/tech/page_client-reference-manifest.js,1764026716491,4cb279f8a0aa972deca94ab59fbc5f8e189e66fc09bea71b9715d13da8db44ee
server/app/tech/page.js.nft.json,1764026743625,c0c74ad18a7a75c1ca768f1e20ff8ec89e2456a16a4c8a18732f99f2cae9733a
server/app/tech/page.js,1764026705287,a338325f6261aa37b8ff54536cc6d2163a31893183bc3c6b06b04aa98432b0ad
server/app/signup/page_client-reference-manifest.js,1764026716491,0aa207798d24880c6d135e4015cca8c449b4ca38af6f4f888b8f578e142b1dc0
server/app/signup/page.js.nft.json,1764026743625,c0c74ad18a7a75c1ca768f1e20ff8ec89e2456a16a4c8a18732f99f2cae9733a
server/chunks/948.js,1764026705293,45033c1f6d5616f7e5e9016c200b580bf07b343b92364805de6aa6522f4baaea
server/app/login/page.js.nft.json,1764026743625,c0c74ad18a7a75c1ca768f1e20ff8ec89e2456a16a4c8a18732f99f2cae9733a
server/app/signup/page.js,1764026705287,aa26db4277e6d7c8363bee453fc727fb805b8bc4885aeaf917159869a4c0b00e
server/app/login/page_client-reference-manifest.js,1764026716491,fc53f4672b147e77f93994ff59677cad50faea7f79ee1ae6abee092981cac522
server/app/login/page.js,1764026705287,100fab30d891de1777220a3b2d636c694d5e838ea5f497dfe5e9b30bef2cd90b
server/app/auth/verify-email.rsc,1764026733892,79b6010bd5bc699a565a762c7be931b4a555f4506f32e506274c48f566f0bc1a
server/app/auth/verify-email.meta,1764026733894,a566cf5ac4ba42c2c0c00beafe61da29f999e19cd8c2f05a8379d230a3412914
server/chunks/622.js,1764026705294,84df62a3bfcba640cfe8018c547ed03638c80ae16a43f7963854170dd8ee1cf1
server/app/auth/verify-email/page_client-reference-manifest.js,1764026716491,b2fd220f62f00eb4a627dd91df75ead2640bbf193dcb5f4f5571eb9622cc15c0
server/app/auth/verify-email/page.js.nft.json,1764026743625,5ba162c85b003181ae736d2e1d05076f88aaf5cbe721466503d5c8640b140c48
server/app/auth/verify-email/page.js,1764026705287,dd31014c15fdba7ecb3cc643106596df8d4eff65d74834c9cee62974474c2bfd
server/app/assistance-candidature/page_client-reference-manifest.js,1764026716491,857b2dff3047f4ae127742ffdc690c6ecc540238bc988e09e511142399efa91c
server/app/auth/verify-email.html,1764026733894,05d9001c10b2514cf36f1eb5341bab3e4f9cd6ab61243f2d51c6ae8a6b88fca1
server/app/assistance-candidature/page.js.nft.json,1764026743625,bb7cde0f585498f675b44c936d6db59207a8a065f1c839ed176cd5854079e479
server/app/assistance-candidature/page.js,1764026705288,c4b01b81449cd03b8a733e00d7977cb6866536d97738436bc9e3993af4b668d1
server/app/app/tracker.rsc,1764026733929,39c199c3ee9cd454a35278d7c1f09c111b7f4407d81b01bdb0d26bfd9b22a84a
server/app/app/tracker.html,1764026733929,52e436ececac03f3b47c8a470c8d72905eaddd4d83a300bec3b3b7196dfece14
server/app/app/settings.rsc,1764026733675,144434b7221c5c2c7213ab483f13a87310465f53a4c724acdd1deca64f84179e
server/app/app/settings.html,1764026733676,bd000bf4703766b0872915a134cea49e197b7e70f8857b11b8f9c43014883f3c
server/app/app/settings.meta,1764026733677,61e24ac4645b6bfc1e4edde2a706de0cef571be36472d53bd09fda1d3cd766f2
server/app/app/pitch.meta,1764026733671,b96294f210dc68d6ed5f7d7fd558aa6f8787909611ddea3b1529f5d65c3d8de1
server/app/app/pitch.rsc,1764026733667,30160839b0a11e25a396a9c21be74191942befae16617684362db089f8bb9b7b
server/app/app/tracker.meta,1764026733930,2bf5058e644cfa342725213c7bef725d7b39c603242e7c99aba6f52f2bc55efc
server/app/app/pitch.html,1764026733668,f34dc2a9a7890a8756dc387cdcc400fac197c755ca613e7dc317ceef11946f8d
server/app/app/page_client-reference-manifest.js,1764026716492,1478c5671b574133bf876646be0f37e193f46c2b909fa0608410c90bb15e5573
server/app/app/page.js.nft.json,1764026743625,dcf52dadbcbb7b55bad9cb8051b63e4f0c20cbeff8c824d8820b078d94034704
server/app/app/lm.rsc,1764026733734,922564088718544373245fc64366051cf06b48d25f563f7fab8b60c583804402
server/app/app/lm.html,1764026733738,703720e85c6544a8438840f384f215da49842c1161c08a288dfc028bc1d16654
server/app/app/lm.meta,1764026733738,04a1afc9b5c9d3c66420d60fe724a4eb7846889efde9ec68eb2d28fa4191cc51
server/app/app/interview.rsc,1764026733556,e87c2d76458a38059baa71e503caa00f9b9d10b945be5f4b18d1c2af7a6c6af1
server/app/app/interview.meta,1764026733560,316676f311368fc2a2b64e6be3ef9a1f33d111fa54869f250d3fcfe6515fa983
server/app/app/history.rsc,1764026734132,1f04abaf4db2a5cf34dcf30e5ceb0b61378ed2684baad1429837c12dbe7aa338
server/app/app/history.html,1764026734133,c70e6519c39281428d61e3f950ed38c3ffc48131d2ce6b1357a0feacd89390f3
server/app/app/interview.html,1764026733559,193c4e41647330cdc58d410fbf4247571147c0fcd27b38c15f8601b2e5d4bb8d
server/app/app/history.meta,1764026734134,ccfd2db673d40cdeaf7ef0d7aad5c0140d1af7f2107aff2d9858775ac2a52c6c
server/app/app/cv.meta,1764026733543,3bc75ba2cf927dd094e9fa7a7ebd18fdfc2df8a83e1082be80613c591c294565
server/app/app/cv.rsc,1764026733541,b0ea1f052e4d6e113f68e0ed0abc865c064f1464a9258d42da78aff460e72874
server/app/app/cv.html,1764026733542,9ccde8b13ff0feb3aaf78c333c81ef790fb49422c77f9e8c9e24314150e622a0
server/app/app/credits.meta,1764026733391,0ba7583a8c447a60bbd5ac60a625ebe737ef41e8825560751188929d0c6e4085
server/app/app/credits.rsc,1764026733389,610d4ed1679ca8b7ba24c984f8f432c775479a3474cc02f01075888ec8c421d3
server/app/app/credits.html,1764026733390,2bdef619a6b0247140759d6c8d378164e0435977f6ac67d9b244dfc2a9d27d12
server/app/app/apply.rsc,1764026734179,f1cbab3b0699564ada0bf2e7c8c86f679d06db904ce35a25a533064fa15e9845
server/app/app/apply.meta,1764026734181,7733dc31718f9147899aeb7818e83a5bd27b05e1dfa3dbcaaaab829f920e187d
server/app/app/apply.html,1764026734180,d9b7d3dd31f64871027a766cdb774d6eb9dcac8065d59871e885f44bd06f7cdb
server/app/app/tracker/page_client-reference-manifest.js,1764026716492,7dc70b31a812727224db784c3ff186987998bde6813dc5c3cd712c42493d310c
server/app/app/tracker/page.js.nft.json,1764026743627,3ea3e05e656da738b8ceac6244f7cb7ccc89f908351e572d52acbefbea231341
server/app/app/tracker/page.js,1764026705291,0bdfadb6960f3c49a85b58eb4e401ede157447f23e4dac787f1f7d8c58efd4b5
server/app/app/settings/page_client-reference-manifest.js,1764026716494,99394414ac94dc0d3468e9959d8a8069c83c818dadbfd5b71b695eafc22be045
server/app/app/settings/page.js.nft.json,1764026743625,4d505ac5f1de0adeeaf4d41bbb52795670e5cb6751a67d106fbeb72adcc412d4
server/app/app/pitch/page_client-reference-manifest.js,1764026716491,cbb7b827a1962ca7753a901ac058c83d8d8761f50c978bc34b810aa00a989ec8
server/app/app/settings/page.js,1764026705292,8bf4afa0a640fc674223306db7b1afa61d32e5d333a1cb8c1fc772a90f60203f
server/app/app/pitch/page.js.nft.json,1764026743625,4d505ac5f1de0adeeaf4d41bbb52795670e5cb6751a67d106fbeb72adcc412d4
server/app/app/pitch/page.js,1764026705292,b5788dd6ca77fde290f62233a6b0c9dc63e63e2f6346a9cb8fe5f4be36463e63
server/app/app/lm/page_client-reference-manifest.js,1764026716494,01d6f42ca5e38af024902d6b46c72064659a7419fd8f784eeb527b8e3be1c1a9
server/app/app/lm/page.js.nft.json,1764026743625,3ea3e05e656da738b8ceac6244f7cb7ccc89f908351e572d52acbefbea231341
server/app/app/lm/page.js,1764026705292,dc68758656ded45c5c838c5973f755ddc0d39bbc052cb7559febf842e8c86352
server/app/app/interview/page_client-reference-manifest.js,1764026716494,2aa911daae2fa6c2cb63a897720e02e24d04481411314742231389076ef4100f
server/app/app/interview/page.js,1764026705292,bc6264f28f5fc843559065f5db61da590d2d28596d3fb85347844d752223af80
server/app/app/interview/page.js.nft.json,1764026743630,4d505ac5f1de0adeeaf4d41bbb52795670e5cb6751a67d106fbeb72adcc412d4
server/app/app/history/page_client-reference-manifest.js,1764026716494,6683f41479fae4f70fc6094786f73c52c3275f7620164339958944af59ddc88a
server/app/app/history/page.js,1764026705293,6d8cbc3d3314683dd1059fc371f6b8823c1e99dccbf148dcf6a5ca40fa2bbf75
server/app/app/history/page.js.nft.json,1764026743627,4d505ac5f1de0adeeaf4d41bbb52795670e5cb6751a67d106fbeb72adcc412d4
server/app/app/cv/page_client-reference-manifest.js,1764026716494,e4852e761a7aa0fb29845adbfbc671741b0d54bafea4345740a71e76d279474f
server/app/app/cv/page.js,1764026705292,529d9f56c4746a0e546329cb6d2af8d3a7bdd1448dc8f4a7093c82ebb806101e
server/app/app/cv/page.js.nft.json,1764026743627,4d505ac5f1de0adeeaf4d41bbb52795670e5cb6751a67d106fbeb72adcc412d4
server/app/app/credits/page_client-reference-manifest.js,1764026716491,a8a13feeed10060e54772e9e9a98873da43b9fee1e16d4853bd222a47f542313
server/app/app/credits/page.js,1764026705292,d8e4004b336bc4a8023bd57de455140dbd05fdc25fa9e794faf47d5f57a4771f
server/app/app/credits/page.js.nft.json,1764026743625,4d505ac5f1de0adeeaf4d41bbb52795670e5cb6751a67d106fbeb72adcc412d4
server/app/app/apply/page.js.nft.json,1764026743632,4d505ac5f1de0adeeaf4d41bbb52795670e5cb6751a67d106fbeb72adcc412d4
server/app/api/polar/webhook/route.js.nft.json,1764026743625,796be69d4da4af17133295c67ec12e7c14bb8d1846829ef52135dcc1244ecb6e
server/app/api/polar/webhook/route.js,1764026705290,eed78a62a284f29f754001abdf2ea1b5c76dc6bafc4b705747e89fc73c21b1f7
server/app/app/apply/page_client-reference-manifest.js,1764026716494,d1495ce120debe8d48ae02504dc4737ca80382495fa094a985a9e9c62d8808cd
server/app/api/linkedin/token/route.js.nft.json,1764026743625,796be69d4da4af17133295c67ec12e7c14bb8d1846829ef52135dcc1244ecb6e
server/app/app/apply/page.js,1764026705293,27ff452aa7e4655fed48993499211eb55935426d0c4944b01b40c2f96418aa20
server/app/api/linkedin/exchange/route.js,1764026705289,412b09c643df42cb268df80aaa2f7db76ff94910a5d23caf087bc1cd3ad3f59e
server/app/api/linkedin/token/route.js,1764026705288,99340dca17580ce19363ed568dc0be2b9a4f1dc9e1a5d802f69d4d8aec472581
server/app/api/linkedin/exchange/route.js.nft.json,1764026743625,796be69d4da4af17133295c67ec12e7c14bb8d1846829ef52135dcc1244ecb6e
server/app/admin/page_client-reference-manifest.js,1764026716491,206a1603a7be6b0d4d2bbbf94865dc5078bd0ca815be5c3e6cec1228c4150037
server/app/admin/page.js.nft.json,1764026743625,6d0f9f3a635e0052395e591d0fbca8a18ce5429ee90d8191f79869b286c5d174
server/app/admin/login.rsc,1764026733266,a1bbb5ab018ab12c977c5164b2147d2dbb3b600d551849d8fa475cc494426415
server/app/admin/login.meta,1764026733268,e5221f8e14d92870d3b29f6391ce660c8ee7d86bfd9d5bd874d0c608a628f946
server/app/admin/page.js,1764026705286,03bb00ca7abcc3197eb670b8486599c3f66d1800bc5e7195467cbbfbe27c6ba8
server/app/admin/login/page.js,1764026705287,131dcf4415189b38bb5f00ccc3d730920f8962b012d1d8f1996ec1e1f8032fda
server/app/admin/login/page_client-reference-manifest.js,1764026716491,9f056511577a3b0d63cc1b95f47fa60a76f164d5ae6aa3a5bdce99a33dfab75b
server/app/admin/login/page.js.nft.json,1764026743625,5ba162c85b003181ae736d2e1d05076f88aaf5cbe721466503d5c8640b140c48
server/app/_not-found/page.js,1764026705286,5b5f5335a4fc20ac15e06452ec3cb31a7a7ddc2858bd3b2efd3e5ebb180ad48b
server/app/_not-found/page.js.nft.json,1764026743625,c0c74ad18a7a75c1ca768f1e20ff8ec89e2456a16a4c8a18732f99f2cae9733a
server/app/_not-found/page_client-reference-manifest.js,1764026716490,d4f29cd13c3c59844cfb92c82d6bd6dcef46cb05170f2dac570924fefe5f313d
server/app/admin/login.html,1764026733267,4886c912d168d1a7907f7405c625bb07b7f31fbebff904e1bd07217502e1865f
cache/webpack/server-production/2.pack,1764026706592,3be9ce6cecf649c02c6e3bb2b2f9f1f9f8e1fe2fef377d731f676f7ac833b274
cache/webpack/server-development/6.pack.gz,1764024287161,af5813aca905aa5a7a97b1e5b7675dc1bc28e341312bd4a612cdb818b2aeb31e
server/app/app/page.js,1764026705291,e61535bddd23ff85f3fc9c7b1510de0b11213d229b6f3f1ca21e0168ac85d787
cache/webpack/server-development/15.pack.gz,1764024478922,6fbe853fac4248b73a11c90a43eba6edf59782530d783b9b50e564644cc6707f
cache/webpack/server-development/11.pack.gz,1764024287152,f875f25d7e9093fb1bb816db2d754d685d094346225cd1435787fc6902f14853
cache/webpack/edge-server-production/index.pack,1764024896487,f930deff61cd0f8e15d35a5996abae25ec091975ed6689e2c5028eed3c27209b
cache/webpack/edge-server-production/0.pack,1764024896487,59c753cc45ee8a4ca8e89f9074c0a493819b5a37358aa131156273515da76376
cache/webpack/client-production/5.pack,1764026717087,ba616cd5a26fbda70e6ff6b8f14e3a3a1cb8635b87032c101a988d4ef179ae3e
cache/webpack/client-production/4.pack,1764025809169,861564f47b4fdb92bff604be45c3bea1c58dedf0432dbe6aaf4381238de5e484
cache/webpack/client-production/1.pack,1764025809180,50b578df7a32ddf4a70c34244efd930eaf761adc713daf3767e17e95803a11e6
cache/webpack/client-production/3.pack,1764026717058,82fe9b530572ab47659b5ec28f4686614d8c68bc03a131ffbc4f66a0936d5791
cache/webpack/client-development-fallback/1.pack.gz,1763726991041,f61803af34be4773ca38272a9a924a1832e7e70eb24147e6927f887e02893095
cache/webpack/client-development/9.pack.gz,1764026444340,dd8810dda553ee803e79954b8ae9c5607043a113d89694c64706949615648a89
cache/webpack/server-development/16.pack.gz,1764024478931,415172b8deca54ed5cff8de0255b48d7ad101fb669bcacb27885294a1f0b0e32
cache/webpack/client-production/2.pack,1764025809168,5f956b09fd3adc12a5a125f8657055a1de340df6b44092b01e04e046601d0ec0
cache/webpack/client-development/21.pack.gz,1763988536526,1be651da5078a64070533b34658b5803c831a94f26a9ac326964ff164d23976b
cache/webpack/client-development/22.pack.gz,1763987316980,2ecfbaf7023039a0da19ae122ba501122d185e196efa7d0c9ecaa7bfc82968a1
cache/webpack/client-development/24.pack.gz,1763987528318,c57f090c3bc52cb27b948397439f3b3a7bf0b1f5fb9e542dca27c58f16ef81e1
cache/webpack/client-development-fallback/index.pack.gz,1763921497081,a01df9400632244658fa28a8106a1ff323ed5a9a45ae22939fcf99659e193e04
cache/webpack/client-development-fallback/index.pack.gz.old,1763873529452,d766420aee69fc87896c35c03c6be1a0237bd250e9c6ae951c957d590e8b39c5
cache/webpack/server-development/0.pack.gz,1764026442370,947f307d0df9d1ae306ad9748558cfe9b56ac4f658da5c9dd94cd75aa7cf68fe
cache/webpack/server-development/7.pack.gz,1764024478941,b0c569ad7f0b726945445af7def37bde26e6ddb6b113879c63a88a1bff0e37ba
cache/webpack/client-development/17.pack.gz,1763986942086,f84688711ef56374c6c18a20a6fa2d6097471b63927a3490bd9c26a22e52be27
cache/webpack/client-development/11.pack.gz,1764024858312,d3f516b8392a8a6308a85dd9d03bde944f0fc5082b9f0c3f60665abb703e1a7e
cache/webpack/server-development/4.pack.gz,1764026444268,94dfc57db1f0a25e4edda508660f2bb4004099963e0f514443c08fde2dfe5153
cache/webpack/client-development/16.pack.gz,1764021355468,f769bfe625095718462c540a33d16a33e6602f16fc66e4e5e94c6381928e4a65
cache/webpack/server-development/3.pack.gz,1764026444386,74023dfe4317e765d61dd6a9807f1a04ad62e8da248ab69128d2329e5b785e54
cache/webpack/server-development/5.pack.gz,1763989632258,1ec658b7b8d89f228d50afb2f679d425a78fe12cb66f22a9cf45842f5d672638
cache/webpack/server-development/index.pack.gz,1764026444350,03f2b92eec824712f05d4ef5397a98c9e95e39538ad86c90fcf04b4417a6e769
cache/webpack/server-development/index.pack.gz.old,1764024859308,9bd96307be040e788a47d131f398d4a53e30371f03440151489f0dd1dbd09b38
cache/webpack/server-development/1.pack.gz,1764023592035,59630e27ca9506cf51d0b98f9dddc6112e7ad46bfe06773d76bbf3120ff1cf23
cache/webpack/client-development/0.pack.gz,1764026444335,67333172fd61e9d5387c1189a4ca6d76838c0e6519de4341cdee49f07e605fba
server/chunks/254.js,1764026705294,df597731c4b651bc4792c8298bd15cd2384c0225e24ef1b49526d91d3efb8a0a
cache/webpack/server-development/2.pack.gz,1764023829411,d21f7bf5b0c8d4e1f65f8278814cb3b730d6f68bbe4fd36fadaa546e0f64918d
cache/webpack/server-development/12.pack.gz,1764024478936,28f0ee449337ebf528c0a44fe10537395258b7735279cb86935a1315749d7ebf
cache/webpack/client-development/14.pack.gz,1764026444365,ee6e6204e9b89ade016ab1a82b6c6d7e73ea21ea9c698487ff1985ec0cfec373
cache/webpack/client-production/7.pack,1764026717064,c243fbe1ad78cc2cbb8891c69e93b5d8d5de25afa7bdfab674a3099d95bf513b
cache/webpack/server-development/13.pack.gz,1763988902299,71c14dc314fe4d95d8477f72260e428fbd47d442d217ff342dd0ab839c696c04
cache/webpack/client-development/index.pack.gz.old,1764025787240,73dbc14890d1674cb365356ae99df5c3dacbc04b58f945aef1ade0694d6c09c5
cache/webpack/client-development/index.pack.gz,1764026444390,d3c9b99283a328761c60faefb956265c5b8d2a573d3e256872f25c402ca4f4a4
cache/webpack/server-development/17.pack.gz,1764026442362,d2ad7444e57888e6b7afa447265c86e17488e6e2bdb9cfe737588f57f4d39a14
cache/webpack/client-development/15.pack.gz,1764024414530,13373de1947ff8b169256b3cabefda95b88bb3a815281c2306ec9e1addc3c01b
cache/webpack/server-development/10.pack.gz,1764026442369,61880f9607c3e89f652b4bd92a0127d29ff6601f5e11f64824f185bbb8d7f97f
cache/webpack/client-development/13.pack.gz,1763968188144,639e5a9ab4ed71fcba7416618b84710e2537303485689576bb143a809567b566
cache/webpack/server-production/1.pack,1764026706591,4af1d06e9e5435925d39a4631d84d9537ad600da6690e84cc19509045a5fe4eb
cache/webpack/client-development/12.pack.gz,1763951604099,76bd1da3fac92263b39565f6165a4a25fa27b1039fdd4f9897f38ab27a07b8a1
cache/webpack/server-production/index.pack.old,1764025799422,d66f3f0f5f96a5952fc9e370e0c42c3973ca739d7350f50ca4b944cab92674d6
cache/webpack/server-production/index.pack,1764026706594,b1654556d94073ee618e490103f6570666a2e3a015aa9aeadc31650dc0b365ae
cache/webpack/client-production/index.pack.old,1764026016461,de941ba7ef440c1f8173f7c48d341bdbf87c675c853c37331da6bb7a2baaf23b
cache/webpack/client-production/index.pack,1764026717091,f6700140c332fed5a67176912c463afd0f2859638736490c0d7070799ab2e53c
cache/webpack/server-development/9.pack.gz,1763951604183,1004351b0acb99281e1c7415dd77c5157ea07d77ea8c1651b28de8b2f8d2dbd0
cache/webpack/server-development/8.pack.gz,1764024111083,88112fd577fe747768bde149380e95477c68963162452faa3f584043af1dbdde
cache/webpack/client-development/6.pack.gz,1764026444697,d7e7471f7c6aa20e8a12a431c521199ae55fdeb81eda2cf50dbe8b61f0ed1c3c
cache/webpack/client-development/18.pack.gz,1763987528813,22caf0af068a091156465524c89c17c5f3c815cea362405a9ab8c1f4e82ccba1
cache/webpack/client-development/7.pack.gz,1763983814599,98e647b9a55f43f38005c38f3ee5a5487a98ba64dbc9638eb2fca57530c61506
cache/webpack/client-development/1.pack.gz,1763990016627,20c3229ba3dd2a052bc3ad8949ecc5be9bad8a9c72e0b41cdddf471d2eb24eea
cache/webpack/client-development/8.pack.gz,1763983997981,66ae1347be96206145361fa304a1fe57a826a4e5a04c56e5ac3df2ee8d89d2be
cache/webpack/client-development/5.pack.gz,1763945324748,505c70bb2acfb85da18bf8d7e24b17fce54b57aa36716f653191abacb7a15b08
cache/webpack/client-development/19.pack.gz,1763987669403,25aa2f30e282fd12a9e29dab8a86f4e9be4ff3f3b4dba37eca1166817ca1baa4
cache/webpack/client-development/4.pack.gz,1763988536836,733ff9ece11cdd38504cf809ec97e4a65d24adad77093589fd7317224020b2b5
cache/webpack/client-development/10.pack.gz,1764025787234,283a69de3a025bbe55f3f6807ef44a08299fd5cabcbc7e72033fbc9426658af4
cache/webpack/client-development/2.pack.gz,1763942931149,6b697172bbde5161c5e917cc0c4fe84214decdf303778b260285612b753480b8
cache/webpack/client-development/20.pack.gz,1763986671864,760fe4ccd7765c8166608397a1346525c1bb9154a7a061501712b1a77413291b
cache/webpack/client-production/6.pack,1764026717134,fd9dbc57ea55aca90888ddb84ac8c6f5ea9b4cc3a495c2ba2f22d2f4118c6a4d
cache/webpack/client-development/3.pack.gz,1764023831064,9d9368d90de2535715bd0edf4a48453e135abce85afccce08f9a4382fad51e3c
cache/webpack/client-development-fallback/0.pack.gz,1763921497803,c97aaf6f15fa631a6664be64d4c9cf42945fa7e05595920edd7fb24ea1a9c2fd
cache/webpack/server-production/0.pack,1764026706676,8d8e8dfd045c0535d1fe3571d15e1a82fd2d5f1b4b0d56419dabc5650df37d7a
cache/webpack/client-development/25.pack.gz,1763894293590,7538527500128b39b36e55f3e63eb1d48e5aea4bc1e91f74d510a9415eb5d54c
cache/webpack/server-development/14.pack.gz,1764024289034,45edb5b8908cc95ba77914137c1ba47da29fa0120ea9d7af464b1573e6ad8ff8
cache/webpack/client-development/23.pack.gz,1763986672120,fc4708bebdd6f16423170a4b9d7ceb88231b67e0c1bde408758d3f46b4353f4e
cache/webpack/server-production/3.pack,1764026706769,b043e64e56d8c46d1717601643778a12dba1d7586e1155a6fc5612feed533b78
cache/webpack/client-production/0.pack,1764026717221,2e4a71900671a280a59332cd93725570040238a7c09ba8c0b846e01ae8aa3a30
````

## File: .firebaserc
````
{
  "projects": {
    "a": "assistant-ia-v4",
    "ncg": "assistant-ia-v4"
  },
  "targets": {},
  "etags": {}
}
````

## File: .gitignore
````
node_modules/
.next/
out/
.env
.env.*
serviceAccountKey.json
*.log
.DS_Store
serviceAccountKey*.json
````

## File: api.txt
````
SMTP et API
Serveur SMTP
smtp-relay.brevo.com
Port
587
Connexion
9c1210001@smtp-brevo.com
STARTTLS
key: bskt8NcPaWFVZUh

firebase functions:config:set smtp.host="smtp-relay.brevo.com"
firebase functions:config:set smtp.port="587"
firebase functions:config:set smtp.secure="false"
firebase functions:config:set smtp.user="9c1210001@smtp-brevo.com"
firebase functions:config:set smtp.pass="bskt8NcPaWFVZUh"
firebase functions:config:set smtp.from='"Assistant IA" <aakane0105@gmail.com>'
firebase functions:config:set smtp.from='"Assistant IA" <no-reply@tondomaine.com>'
firebase functions:config:set smtp.from='"Assistant IA" <no-reply@assistant-ia-v4.com>'
````

## File: app/admin/login/page.tsx
````typescript
"use client";

import { useState, FormEvent } from "react";
import Link from "next/link";
import { useRouter } from "next/navigation";
import {
  signInWithEmailAndPassword,
  GoogleAuthProvider,
  signInWithPopup,
} from "firebase/auth";
import { auth } from "@/lib/firebase";

export default function AdminLoginPage() {
  // Simples états de formulaire et de soumission
  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [submitting, setSubmitting] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const router = useRouter();

  const mapFirebaseError = (code?: string) => {
    switch (code) {
      case "auth/invalid-email":
        return "Adresse email invalide.";
      case "auth/user-not-found":
      case "auth/wrong-password":
        return "Email ou mot de passe incorrect.";
      case "auth/user-disabled":
        return "Ce compte a été désactivé. Contacte l’administrateur.";
      case "auth/popup-closed-by-user":
        return "Connexion annulée.";
      default:
        return "Impossible de te connecter. Réessaie dans un instant.";
    }
  };

  const handleSubmit = async (e: FormEvent) => {
    e.preventDefault();
    setError(null);
    setSubmitting(true);

    try {
      const cred = await signInWithEmailAndPassword(auth, email, password);
      console.log("Admin login success (email/password):", cred.user.uid);

      // Redirection vers le dashboard admin (à adapter si besoin)
      router.push("/admin/dashboard");
    } catch (err: any) {
      console.error(err);
      const msg = mapFirebaseError(err?.code);
      setError(msg);
    } finally {
      setSubmitting(false);
    }
  };

  const handleGoogleLogin = async () => {
    setError(null);
    setSubmitting(true);

    try {
      const provider = new GoogleAuthProvider();
      provider.setCustomParameters({
        prompt: "select_account",
      });

      const result = await signInWithPopup(auth, provider);
      console.log("Admin login success (Google):", result.user.uid);

      // Redirection vers le dashboard admin (à adapter si besoin)
      router.push("/admin/dashboard");
    } catch (err: any) {
      console.error(err);
      const msg = mapFirebaseError(err?.code);
      setError(msg);
    } finally {
      setSubmitting(false);
    }
  };

  return (
    <div className="min-h-screen flex flex-col bg-slate-950 text-slate-100">
      {/* Navbar (Minimal Admin Header) */}
      <header className="border-b border-slate-800/80 bg-slate-950/80 backdrop-blur">
        <div className="max-w-5xl mx-auto px-4 sm:px-6 py-3 flex items-center justify-between gap-3">
          <div className="flex items-center gap-2">
            <div className="w-8 h-8 rounded-xl bg-gradient-to-br from-red-500 to-red-400 flex items-center justify-center text-[10px] font-semibold text-slate-950 shadow-lg shadow-red-500/40">
              AD
            </div>
            <div className="flex flex-col">
              <span className="text-[10px] uppercase tracking-[0.18em] text-slate-400">
                Accès réservé
              </span>
              <span className="text-xs font-medium text-slate-100">
                Administration
              </span>
            </div>
          </div>
          <Link
            href="/login" // Lien de retour vers la connexion utilisateur classique
            className="px-2 py-1 rounded-full border border-slate-700/80 hover:border-red-500/80 text-slate-300 hover:text-red-300 transition-colors text-[11px]"
          >
            ← Retour Client
          </Link>
        </div>
      </header>

      {/* CONTENU PRINCIPAL - Centré */}
      <main className="flex-1 flex items-center justify-center px-4 py-6">
        <div className="glass max-w-sm w-full p-6 sm:p-7 rounded-2xl border border-slate-800 bg-slate-950/80 shadow-2xl shadow-red-900/40">
          <div className="mb-5">
            <p className="inline-flex items-center gap-2 rounded-full bg-slate-900/80 border border-slate-700 px-3 py-1 mb-2">
              <span className="text-xs text-red-400">🚨</span>
              <span className="text-[11px] uppercase tracking-[0.18em] text-slate-300">
                Accès Admin
              </span>
            </p>
            <h1 className="text-lg sm:text-xl font-semibold text-slate-50">
              Connexion administrateur
            </h1>
            <p className="text-xs text-slate-400 mt-1">
              Veuillez utiliser vos identifiants de sécurité.
            </p>
          </div>

          {error && (
            <div className="mb-4 rounded-lg border border-red-500/70 bg-red-500/10 px-3 py-2 text-[11px] text-red-100">
              {error}
            </div>
          )}

          {/* FORMULAIRE */}
          <form onSubmit={handleSubmit} className="space-y-4 text-sm">
            <div>
              <label className="block mb-1 text-xs text-slate-300">
                Email
              </label>
              <input
                type="email"
                required
                className="w-full rounded-lg bg-slate-900/80 border border-slate-700 px-3 py-2 text-xs text-slate-100 placeholder:text-slate-500 outline-none focus:ring-1 focus:ring-red-500 focus:border-red-500"
                placeholder="admin@example.com"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                disabled={submitting}
              />
            </div>

            <div>
              <label className="block mb-1 text-xs text-slate-300">
                Mot de passe
              </label>
              <input
                type="password"
                required
                className="w-full rounded-lg bg-slate-900/80 border border-slate-700 px-3 py-2 text-xs text-slate-100 placeholder:text-slate-500 outline-none focus:ring-1 focus:ring-red-500 focus:border-red-500"
                placeholder="••••••••"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                disabled={submitting}
              />
              {/* Le lien "Mot de passe oublié ?" est intentionnellement omis ici */}
            </div>

            <button
              type="submit"
              disabled={submitting}
              className="w-full inline-flex items-center justify-center rounded-lg bg-red-600 hover:bg-red-700 disabled:opacity-60 disabled:cursor-not-allowed text-xs font-medium text-white px-3 py-2 transition-colors mt-2"
            >
              {submitting ? "Connexion en cours..." : "Se connecter"}
            </button>
          </form>

          {/* Séparateur */}
          <div className="flex items-center gap-3 my-4">
            <div className="h-px flex-1 bg-slate-800" />
            <span className="text-[10px] text-slate-500 uppercase tracking-[0.18em]">
              ou
            </span>
            <div className="h-px flex-1 bg-slate-800" />
          </div>

          {/* BOUTON GOOGLE */}
          <button
            type="button"
            onClick={handleGoogleLogin}
            disabled={submitting}
            className="w-full inline-flex items-center justify-center gap-2 rounded-lg bg-slate-900/80 hover:bg-slate-900 disabled:opacity-60 disabled:cursor-not-allowed border border-slate-700 px-3 py-2 text-xs font-medium text-slate-100 transition-colors"
          >
            {/* Icône Google minimaliste (SVG) */}
            <span className="w-4 h-4 rounded-sm bg-white flex items-center justify-center">
              <span className="text-[11px] font-bold text-slate-900">G</span>
            </span>
            <span>
              {submitting
                ? "Connexion en cours..."
                : "Se connecter avec Google"}
            </span>
          </button>
        </div>
      </main>
    </div>
  );
}
````

## File: app/admin/logs/page.tsx
````typescript
"use client";

import { useEffect, useState } from "react";
import { motion } from "framer-motion";
import { db } from "@/lib/firebase";
import {
  collection,
  getDocs,
  limit,
  orderBy,
  query,
} from "firebase/firestore";
import { useAdminGuard } from "@/hooks/useAdminGuard";

interface UsageLogRow {
  id: string;
  userId: string;
  email?: string | null;
  type: string;
  createdAt?: Date | null;
  meta?: any;
}

function formatDateTime(date?: Date | null): string {
  if (!date) return "—";
  return date.toLocaleString("fr-FR", {
    dateStyle: "short",
    timeStyle: "short",
  });
}

export default function AdminLogsPage() {
  const { loading, isAdmin } = useAdminGuard();
  const [logs, setLogs] = useState<UsageLogRow[]>([]);
  const [loadingLogs, setLoadingLogs] = useState(true);

  useEffect(() => {
    if (!isAdmin || loading) return;

    const fetchLogs = async () => {
      try {
        const q = query(
          collection(db, "usageLogs"),
          orderBy("createdAt", "desc"),
          limit(200)
        );
        const snap = await getDocs(q);
        const rows: UsageLogRow[] = snap.docs.map((d) => {
          const data = d.data() as any;
          const createdAt =
            data.createdAt?.toDate?.() &&
            typeof data.createdAt.toDate === "function"
              ? data.createdAt.toDate()
              : null;

          return {
            id: d.id,
            userId: data.userId ?? "—",
            email: data.email ?? null,
            type: data.type ?? "—",
            createdAt,
            meta: data.meta ?? {},
          };
        });
        setLogs(rows);
      } catch (err) {
        console.error("Erreur chargement logs:", err);
      } finally {
        setLoadingLogs(false);
      }
    };

    fetchLogs();
  }, [loading, isAdmin]);

  if (loading) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <p className="text-xs text-[var(--muted)]">
          Chargement de l&apos;admin…
        </p>
      </div>
    );
  }

  if (!isAdmin) return null;

  return (
    <div className="min-h-screen px-4 sm:px-8 py-6 bg-[var(--bg)] text-[var(--ink)]">
      <div className="max-w-6xl mx-auto flex flex-col gap-4">
        <motion.div
          initial={{ opacity: 0, y: 10 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.25 }}
        >
          <h1 className="text-xl sm:text-2xl font-semibold">
            Logs d&apos;utilisation
          </h1>
          <p className="text-xs sm:text-sm text-[var(--muted)] mt-1 max-w-xl">
            Historique des actions des utilisateurs (génération de CV, LM,
            etc.).
          </p>
        </motion.div>

        <motion.div
          initial={{ opacity: 0, y: 10 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.25, delay: 0.05 }}
          className="glass rounded-2xl p-4 overflow-x-auto"
        >
          {loadingLogs ? (
            <p className="text-[12px] text-[var(--muted)]">
              Chargement des logs…
            </p>
          ) : logs.length === 0 ? (
            <p className="text-[12px] text-[var(--muted)]">
              Aucun log pour le moment.
            </p>
          ) : (
            <table className="w-full text-[11px] sm:text-xs">
              <thead className="text-[10px] uppercase tracking-[0.18em] text-[var(--muted)]">
                <tr className="text-left border-b border-[var(--border)]">
                  <th className="py-2 pr-2">Date</th>
                  <th className="py-2 pr-2">User</th>
                  <th className="py-2 pr-2">Type</th>
                  <th className="py-2 pr-2">Meta</th>
                </tr>
              </thead>
              <tbody>
                {logs.map((log) => (
                  <tr
                    key={log.id}
                    className="border-b border-[var(--border)]/60 last:border-none align-top"
                  >
                    <td className="py-2 pr-2">
                      {formatDateTime(log.createdAt)}
                    </td>
                    <td className="py-2 pr-2">
                      <div className="flex flex-col">
                        <span className="font-medium text-[11px]">
                          {log.email || "—"}
                        </span>
                        <span className="text-[10px] text-[var(--muted)]">
                          UID: {log.userId?.slice(0, 8) || "—"}…
                        </span>
                      </div>
                    </td>
                    <td className="py-2 pr-2">
                      <span className="inline-flex px-2 py-[2px] rounded-full border border-[var(--border)] text-[10px]">
                        {log.type}
                      </span>
                    </td>
                    <td className="py-2 pr-2 max-w-xs">
                      <pre className="text-[10px] whitespace-pre-wrap break-words text-[var(--muted)]">
                        {JSON.stringify(log.meta ?? {}, null, 2)}
                      </pre>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          )}
        </motion.div>
      </div>
    </div>
  );
}
````

## File: app/admin/page.tsx
````typescript
// app/admin/page.tsx
"use client";

import { useEffect, useState, useRef } from "react";
import { motion } from "framer-motion";
import { db } from "@/lib/firebase";
import {
  collection,
  onSnapshot,
  doc,
  updateDoc,
  query,
  orderBy,
  limit,
  deleteDoc,
} from "firebase/firestore";
import Chart from "chart.js/auto";
import { useAdminGuard } from "@/hooks/useAdminGuard";
import { useAuth } from "@/context/AuthContext";

type AdminUser = {
  id: string;
  email: string;
  displayName?: string | null;
  createdAt?: number | null;
  lastLoginAt?: number | null;
  lastSeenAt?: number | null;
  lastSeenPage?: string | null;
  credits?: number;
  blocked?: boolean;
  emailVerified?: boolean;
  provider?: string;

  role?: string | null;

  lastIp?: string | null;
  country?: string | null;
  city?: string | null;

  lastAction?: string | null;
  lastActionAt?: number | null;
  lastDeviceType?: string | null; // "iphone" | "ipad" | "mac" | "mobile" | "tablet" | "desktop" | ...
  lastOs?: string | null;
  lastBrowser?: string | null;

  totalIaCalls?: number | null;
  totalCvGenerated?: number | null;
  totalLmGenerated?: number | null;
  totalDocumentsGenerated?: number | null;

  authFailedCount?: number | null;
};

type UsageLog = {
  id: string;
  userId: string;
  email?: string | null;
  action: string;
  tool?: string | null;
  docType?: string | null;
  eventType?: string | null;
  createdAt?: number | null;

  ip?: string | null;
  country?: string | null;
  city?: string | null;
  path?: string | null;
  creditsDelta?: number | null;

  deviceType?: string | null;
  os?: string | null;
  browser?: string | null;
};

function formatDate(ts?: number | null) {
  if (!ts) return "—";
  const d = new Date(ts);
  return new Intl.DateTimeFormat("fr-FR", {
    day: "2-digit",
    month: "short",
    year: "numeric",
    hour: "2-digit",
    minute: "2-digit",
  }).format(d);
}

function formatRelative(ts?: number | null): string {
  if (!ts) return "Jamais vu·e";
  const now = Date.now();
  const diffMs = now - ts;
  if (diffMs < 0) return "Dans le futur 🤔";

  const diffSec = Math.floor(diffMs / 1000);
  if (diffSec < 60) return `Il y a ${diffSec}s`;

  const diffMin = Math.floor(diffSec / 60);
  if (diffMin < 60) return `Il y a ${diffMin} min`;

  const diffH = Math.floor(diffMin / 60);
  if (diffH < 48) return `Il y a ${diffH} h`;

  const diffJ = Math.floor(diffH / 24);
  return `Il y a ${diffJ} j`;
}

function getPresence(lastSeenAt?: number | null) {
  if (!lastSeenAt) {
    return {
      label: "Jamais vu·e",
      dotClass: "bg-slate-500",
      badgeClass:
        "bg-slate-500/10 text-slate-200 border border-slate-500/40",
    };
  }

  const now = Date.now();
  const diff = now - lastSeenAt;

  if (diff < 2 * 60 * 1000) {
    return {
      label: "En ligne",
      dotClass: "bg-emerald-400",
      badgeClass:
        "bg-emerald-500/10 text-emerald-200 border border-emerald-500/50",
    };
  }

  if (diff < 60 * 60 * 1000) {
    return {
      label: formatRelative(lastSeenAt),
      dotClass: "bg-amber-400",
      badgeClass:
        "bg-amber-500/10 text-amber-200 border border-amber-500/40",
    };
  }

  return {
    label: formatRelative(lastSeenAt),
    dotClass: "bg-slate-400",
    badgeClass:
      "bg-slate-500/10 text-slate-200 border border-slate-500/40",
  };
}

function getCountryFlag(country?: string | null): string {
  if (!country) return "🏳️";
  const c = country.toLowerCase();

  if (c.includes("france")) return "🇫🇷";
  if (c.includes("belgique") || c.includes("belgium")) return "🇧🇪";
  if (c.includes("suisse") || c.includes("switzerland")) return "🇨🇭";
  if (c.includes("canada")) return "🇨🇦";
  if (c.includes("maroc")) return "🇲🇦";
  if (c.includes("tunisie") || c.includes("tunisia")) return "🇹🇳";
  if (c.includes("algérie") || c.includes("algerie")) return "🇩🇿";
  if (c.includes("luxembourg")) return "🇱🇺";

  if (
    c.includes("united states") ||
    c.includes("usa") ||
    c.includes("états-unis") ||
    c.includes("etats-unis")
  )
    return "🇺🇸";
  if (c.includes("spain") || c.includes("espagne")) return "🇪🇸";
  if (c.includes("germany") || c.includes("allemagne")) return "🇩🇪";
  if (c.includes("italy") || c.includes("italie")) return "🇮🇹";
  if (c.includes("portugal")) return "🇵🇹";
  if (c.includes("netherlands") || c.includes("pays-bas")) return "🇳🇱";
  if (
    c.includes("united kingdom") ||
    c.includes("uk") ||
    c.includes("royaume-uni")
  )
    return "🇬🇧";

  return "🌍";
}

// Traduction du path en section lisible
function getPageLabel(path?: string | null): string {
  if (!path) return "Inconnu";
  const [clean] = path.split("?");
  if (!clean) return "Inconnu";

  if (clean === "/" || clean === "/app") return "Accueil (app)";
  if (clean.startsWith("/lm")) return "Lettre de motivation IA";
  if (
    clean.startsWith("/applications") ||
    clean.startsWith("/tracker") ||
    clean.startsWith("/suivi")
  )
    return "Suivi de candidatures";
  if (clean.startsWith("/credits")) return "Page crédits";
  if (clean.startsWith("/login") || clean.startsWith("/signup"))
    return "Connexion / Inscription";
  if (clean.startsWith("/admin")) return "Administration";
  if (clean.startsWith("/profil") || clean.startsWith("/profile"))
    return "Profil candidat";

  return clean;
}

// Affichage lisible du device, avec différenciation iPhone / iPad / macOS
function formatDevice(
  deviceType?: string | null,
  os?: string | null
): string {
  if (!deviceType && !os) return "—";

  let label: string;

  switch (deviceType) {
    case "iphone":
      label = "📱 iPhone";
      break;
    case "ipad":
      label = "📱 iPad";
      break;
    case "mac":
      label = "💻 macOS";
      break;
    case "mobile":
      label = "📱 Mobile";
      break;
    case "tablet":
      label = "📱 Tablette";
      break;
    case "desktop":
      label = "🖥 Desktop";
      break;
    default:
      label = "❓ Appareil";
  }

  if (os) label += ` · ${os}`;

  return label;
}

export default function AdminDashboardPage() {
  const { loading, isAdmin } = useAdminGuard();
  const { logout } = useAuth();

  const [users, setUsers] = useState<AdminUser[]>([]);
  const [loadingUsers, setLoadingUsers] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [editingCredits, setEditingCredits] = useState<
    Record<string, string>
  >({});
  const [updatingIds, setUpdatingIds] = useState<Record<string, boolean>>(
    {}
  );

  const [activeTab, setActiveTab] = useState<"users" | "logs">("users");

  const [usageLogs, setUsageLogs] = useState<UsageLog[]>([]);
  const [loadingLogs, setLoadingLogs] = useState(false);

  // 🔎 nouveau : filtre sur les logs (tous / seulement auth_failed)
  const [logFilter, setLogFilter] = useState<"all" | "auth_failed">("all");

  // Chart.js pour les logs
  const logsChartRef = useRef<HTMLCanvasElement | null>(null);
  const [logsChart, setLogsChart] = useState<Chart | null>(null);

  // --- USERS SUB ---
  useEffect(() => {
    if (!isAdmin) {
      setUsers([]);
      setLoadingUsers(false);
      return;
    }

    setLoadingUsers(true);

    const unsub = onSnapshot(
      collection(db, "users"),
      (snap) => {
        const list: AdminUser[] = snap.docs.map((d) => {
          const data = d.data() as any;
          return {
            id: d.id,
            email: data.email || "—",
            displayName: data.displayName || null,
            createdAt:
              typeof data.createdAt === "number" ? data.createdAt : null,
            lastLoginAt:
              typeof data.lastLoginAt === "number"
                ? data.lastLoginAt
                : null,
            lastSeenAt:
              typeof data.lastSeenAt === "number" ? data.lastSeenAt : null,
            lastSeenPage: data.lastSeenPage || null,
            credits:
              typeof data.credits === "number"
                ? data.credits
                : data.credits ?? 0,
            blocked: !!data.blocked,
            emailVerified: !!data.emailVerified,
            provider: data.provider || "",

            role: data.role || (data.isAdmin ? "admin" : "user"),

            lastIp: data.lastSeenIp || null,
            country: data.lastSeenCountry || null,
            city: data.lastSeenCity || null,
            lastAction: data.lastAction || null,
            lastActionAt:
              typeof data.lastActionAt === "number"
                ? data.lastActionAt
                : null,
            lastDeviceType: data.lastDeviceType || null,
            lastOs: data.lastOs || null,
            lastBrowser: data.lastBrowser || null,

            totalIaCalls:
              typeof data.totalIaCalls === "number"
                ? data.totalIaCalls
                : null,
            totalCvGenerated:
              typeof data.totalCvGenerated === "number"
                ? data.totalCvGenerated
                : null,
            totalLmGenerated:
              typeof data.totalLmGenerated === "number"
                ? data.totalLmGenerated
                : null,
            totalDocumentsGenerated:
              typeof data.totalDocumentsGenerated === "number"
                ? data.totalDocumentsGenerated
                : null,
            authFailedCount:
              typeof data.authFailedCount === "number"
                ? data.authFailedCount
                : null,
          };
        });

        list.sort((a, b) => {
          const ta = a.createdAt || 0;
          const tb = b.createdAt || 0;
          return tb - ta;
        });

        setUsers(list);
        setLoadingUsers(false);
        setError(null);
      },
      (err) => {
        console.error("Erreur onSnapshot(users):", err);
        setError("Impossible de charger les utilisateurs.");
        setLoadingUsers(false);
      }
    );

    return () => {
      unsub();
    };
  }, [isAdmin]);

  // --- USAGE LOGS SUB ---
  useEffect(() => {
    if (!isAdmin || activeTab !== "logs") {
      setUsageLogs([]);
      setLoadingLogs(false);
      return;
    }

    setLoadingLogs(true);

    const qLogs = query(
      collection(db, "usageLogs"),
      orderBy("createdAt", "desc"),
      limit(200)
    );

    const unsub = onSnapshot(
      qLogs,
      (snap) => {
        const list: UsageLog[] = snap.docs.map((d) => {
          const data = d.data() as any;
          return {
            id: d.id,
            userId: data.userId,
            email: data.email ?? null,
            action: data.action || "—",
            tool: data.tool ?? null,
            docType: data.docType ?? null,
            eventType: data.eventType ?? null,
            createdAt:
              typeof data.createdAt === "number"
                ? data.createdAt
                : null,
            ip: data.ip ?? null,
            country: data.country ?? null,
            city: data.city ?? null,
            path: data.path ?? null,
            creditsDelta:
              typeof data.creditsDelta === "number"
                ? data.creditsDelta
                : null,
            deviceType: data.deviceType ?? null,
            os: data.os ?? null,
            browser: data.browser ?? null,
          };
        });

        setUsageLogs(list);
        setLoadingLogs(false);
      },
      (err) => {
        console.error("Erreur onSnapshot(usageLogs):", err);
        setLoadingLogs(false);
      }
    );

    return () => {
      unsub();
    };
  }, [isAdmin, activeTab]);

  // --- CHARTS SUR LES LOGS (LM / CV par jour) ---
  useEffect(() => {
    if (activeTab !== "logs") return;
    if (!logsChartRef.current) return;

    const ctx = logsChartRef.current.getContext("2d");
    if (!ctx) return;

    if (logsChart) {
      logsChart.destroy();
    }

    if (usageLogs.length === 0) {
      setLogsChart(null);
      return;
    }

    const byDate: Record<
      string,
      { total: number; lm: number; cv: number }
    > = {};

    usageLogs.forEach((log) => {
      if (!log.createdAt) return;
      const d = new Date(log.createdAt);
      const key = d.toISOString().slice(0, 10); // YYYY-MM-DD

      if (!byDate[key]) {
        byDate[key] = { total: 0, lm: 0, cv: 0 };
      }

      byDate[key].total += 1;

      if (log.docType === "lm") {
        byDate[key].lm += 1;
      } else if (log.docType === "cv") {
        byDate[key].cv += 1;
      }
    });

    const labels = Object.keys(byDate).sort();
    const totalData = labels.map((k) => byDate[k].total);
    const lmData = labels.map((k) => byDate[k].lm);
    const cvData = labels.map((k) => byDate[k].cv);

    const chart = new Chart(ctx, {
      type: "line",
      data: {
        labels,
        datasets: [
          {
            label: "Total appels IA",
            data: totalData,
            borderWidth: 2,
            tension: 0.3,
          },
          {
            label: "LM générées",
            data: lmData,
            borderWidth: 2,
            tension: 0.3,
          },
          {
            label: "CV générés",
            data: cvData,
            borderWidth: 2,
            tension: 0.3,
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            labels: {
              color: "#e5e7eb",
              font: { size: 11 },
            },
          },
        },
        scales: {
          x: {
            ticks: { color: "#9ca3af", font: { size: 10 } },
            grid: { color: "rgba(55,65,81,0.4)" },
          },
          y: {
            ticks: { color: "#9ca3af", font: { size: 10 } },
            grid: { color: "rgba(55,65,81,0.4)" },
          },
        },
      },
    });

    setLogsChart(chart);

    return () => {
      chart.destroy();
    };
  }, [usageLogs, activeTab]);

  // --- ACTIONS ADMIN ---

  const handleSaveCredits = async (u: AdminUser) => {
    const raw = editingCredits[u.id];
    if (raw == null) return;

    const parsed = Number(raw);
    if (Number.isNaN(parsed)) {
      alert("Merci de saisir un nombre valide.");
      return;
    }

    try {
      setUpdatingIds((prev) => ({ ...prev, [u.id]: true }));
      const ref = doc(db, "users", u.id);
      await updateDoc(ref, { credits: parsed });
    } catch (e) {
      console.error("Erreur update credits:", e);
      alert("Erreur en mettant à jour les crédits.");
    } finally {
      setUpdatingIds((prev) => ({ ...prev, [u.id]: false }));
    }
  };

  const handleToggleBlocked = async (u: AdminUser) => {
    try {
      setUpdatingIds((prev) => ({ ...prev, [u.id]: true }));
      const ref = doc(db, "users", u.id);
      await updateDoc(ref, { blocked: !u.blocked });
    } catch (e) {
      console.error("Erreur toggle blocked:", e);
      alert("Erreur en mettant à jour le statut de blocage.");
    } finally {
      setUpdatingIds((prev) => ({ ...prev, [u.id]: false }));
    }
  };

  const handleDeleteUser = async (u: AdminUser) => {
    const sure = window.confirm(
      `Supprimer l'utilisateur ${u.email} de Firestore ?\n\n(Le compte Auth ne sera pas supprimé automatiquement.)`
    );
    if (!sure) return;

    try {
      setUpdatingIds((prev) => ({ ...prev, [u.id]: true }));
      const ref = doc(db, "users", u.id);
      await deleteDoc(ref);
    } catch (e) {
      console.error("Erreur delete user:", e);
      alert("Erreur lors de la suppression de l'utilisateur.");
    } finally {
      setUpdatingIds((prev) => ({ ...prev, [u.id]: false }));
    }
  };

  const handleLogout = async () => {
    try {
      await logout();
      window.location.href = "/login";
    } catch (e) {
      console.error("Erreur logout:", e);
    }
  };

  if (loading) {
    return (
      <div className="min-h-screen flex items-center justify-center text-sm text-slate-300">
        Vérification des droits admin…
      </div>
    );
  }

  if (!isAdmin) {
    return null;
  }

  const totalCredits = users.reduce(
    (sum, u) => sum + (u.credits ?? 0),
    0
  );
  const blockedCount = users.filter((u) => u.blocked).length;
  const totalDocs = users.reduce(
    (sum, u) => sum + (u.totalDocumentsGenerated ?? 0),
    0
  );

  const lmTotal = users.reduce(
    (sum, u) => sum + (u.totalLmGenerated ?? 0),
    0
  );
  const cvTotal = users.reduce(
    (sum, u) => sum + (u.totalCvGenerated ?? 0),
    0
  );

  const suspiciousLogs = usageLogs.filter(
    (l) => l.action === "auth_failed"
  ).length;

  // 🔎 on applique le filtre pour le tableau
  const filteredLogs =
    logFilter === "auth_failed"
      ? usageLogs.filter((l) => l.action === "auth_failed")
      : usageLogs;

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-950 via-slate-900 to-slate-950 px-3 sm:px-6 py-5">
      <div className="max-w-7xl mx-auto flex flex-col gap-4">
        {/* HEADER */}
        <motion.header
          initial={{ opacity: 0, y: 10 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.25 }}
          className="flex items-center justify-between gap-3"
        >
          <div>
            <p className="inline-flex items-center gap-1.5 rounded-full border border-sky-500/30 bg-sky-500/10 px-2 py-[3px]">
              <span className="w-1.5 h-1.5 rounded-full bg-emerald-400" />
              <span className="text-[11px] uppercase tracking-[0.18em] text-sky-100/80">
                Espace admin
              </span>
            </p>
            <h1 className="mt-2 text-xl sm:text-2xl font-semibold text-white">
              Tableau de bord administrateur
            </h1>
            <p className="text-xs sm:text-sm text-slate-300/80 mt-1 max-w-xl">
              Vue globale sur les comptes, la localisation des utilisateurs,
              les documents IA générés et les appels à l&apos;assistant.
            </p>
          </div>

          <div className="flex items-center gap-2">
            <button
              type="button"
              className="hidden sm:inline-flex items-center gap-1.5 rounded-full border border-slate-700 bg-slate-900/60 px-3 py-1.5 text-[11px] text-slate-200"
            >
              <span className="w-2 h-2 rounded-full bg-emerald-400 animate-pulse" />
              <span>Admin connecté</span>
            </button>
            <button
              type="button"
              onClick={handleLogout}
              className="inline-flex items-center gap-1.5 rounded-full bg-slate-100 text-slate-900 px-3 py-1.5 text-[12px] font-medium hover:bg-white transition-colors"
            >
              <span>Se déconnecter</span>
              <span className="text-[13px]">↩</span>
            </button>
          </div>
        </motion.header>

        {/* TABS */}
        <div className="flex items-center gap-2 border-b border-slate-800/80">
          <button
            type="button"
            onClick={() => setActiveTab("users")}
            className={`relative px-3 py-2 text-[12px] sm:text-[13px] ${
              activeTab === "users"
                ? "text-white"
                : "text-slate-400 hover:text-slate-200"
            }`}
          >
            Utilisateurs
            {activeTab === "users" && (
              <span className="absolute inset-x-2 -bottom-px h-[2px] rounded-full bg-sky-400" />
            )}
          </button>
          <button
            type="button"
            onClick={() => setActiveTab("logs")}
            className={`relative px-3 py-2 text-[12px] sm:text-[13px] ${
              activeTab === "logs"
                ? "text-white"
                : "text-slate-400 hover:text-slate-200"
            }`}
          >
            Logs IA
            {activeTab === "logs" && (
              <span className="absolute inset-x-2 -bottom-px h-[2px] rounded-full bg-sky-400" />
            )}
          </button>
        </div>

        {/* ONGLET UTILISATEURS */}
        {activeTab === "users" && (
          <>
            {/* STATS RAPIDES */}
            <div className="grid gap-3 md:grid-cols-4">
              <div className="rounded-2xl border border-slate-800 bg-slate-900/70 p-4 shadow-sm shadow-sky-500/5">
                <p className="text-[11px] uppercase tracking-[0.18em] text-slate-400 mb-1">
                  Utilisateurs
                </p>
                <p className="text-2xl font-semibold text-white">
                  {loadingUsers ? "…" : users.length}
                </p>
                <p className="text-[11px] text-slate-400">
                  Nombre total de comptes dans{" "}
                  <code className="text-sky-300">users</code>.
                </p>
              </div>

              <div className="rounded-2xl border border-slate-800 bg-slate-900/70 p-4 shadow-sm shadow-sky-500/5">
                <p className="text-[11px] uppercase tracking-[0.18em] text-slate-400 mb-1">
                  Utilisateurs bloqués
                </p>
                <p className="text-2xl font-semibold text-white">
                  {loadingUsers ? "…" : blockedCount}
                </p>
                <p className="text-[11px] text-slate-400">
                  Comptes avec{" "}
                  <code className="text-sky-300">blocked = true</code>.
                </p>
              </div>

              <div className="rounded-2xl border border-slate-800 bg-slate-900/70 p-4 shadow-sm shadow-sky-500/5">
                <p className="text-[11px] uppercase tracking-[0.18em] text-slate-400 mb-1">
                  Crédits totaux
                </p>
                <p className="text-2xl font-semibold text-white">
                  {loadingUsers ? "…" : totalCredits}
                </p>
                <p className="text-[11px] text-slate-400">
                  Somme de tous les crédits utilisateurs.
                </p>
              </div>

              <div className="rounded-2xl border border-slate-800 bg-slate-900/70 p-4 shadow-sm shadow-sky-500/5">
                <p className="text-[11px] uppercase tracking-[0.18em] text-slate-400 mb-1">
                  Docs IA générés
                </p>
                <p className="text-2xl font-semibold text-white">
                  {loadingUsers ? "…" : totalDocs}
                </p>
                <p className="text-[11px] text-slate-400">
                  LM: {lmTotal} · CV: {cvTotal}
                </p>
              </div>
            </div>

            {/* TABLE UTILISATEURS */}
            <div className="rounded-2xl border border-slate-800 bg-slate-950/80 p-4 sm:p-5 shadow-inner shadow-black/40">
              <div className="flex items-center justify-between mb-3 gap-2">
                <h2 className="text-sm sm:text-base font-semibold text-white">
                  Liste des utilisateurs
                </h2>
                {loadingUsers && (
                  <span className="text-[11px] text-slate-400">
                    Chargement…
                  </span>
                )}
              </div>

              {error && (
                <div className="mb-3 rounded-lg border border-red-500/40 bg-red-500/10 px-3 py-2 text-[11px] text-red-100">
                  {error}
                </div>
              )}

              {!loadingUsers && users.length === 0 && !error && (
                <p className="text-[12px] text-slate-400">
                  Aucun utilisateur trouvé dans{" "}
                  <code className="text-sky-300">users</code>.
                  <br />
                  Vérifie que ta fonction{" "}
                  <code className="text-sky-300">upsertUserOnLogin</code> est
                  bien appelée après chaque connexion.
                </p>
              )}

              {users.length > 0 && (
                <div className="overflow-x-auto mt-2">
                  <table className="w-full text-[11px] sm:text-[12px] border-collapse">
                    <thead>
                      <tr className="text-slate-400 border-b border-slate-800">
                        <th className="text-left py-2 pr-3">Utilisateur</th>
                        <th className="text-left py-2 pr-3 hidden sm:table-cell">
                          Localisation / Appareil
                        </th>
                        <th className="text-left py-2 pr-3">Crédits</th>
                        <th className="text-left py-2 pr-3">Statut</th>
                        <th className="text-left py-2 pr-3 hidden md:table-cell">
                          Dernier login
                        </th>
                        <th className="text-left py-2 pr-3 hidden lg:table-cell">
                          Dernière activité
                        </th>
                        <th className="text-left py-2 pl-3">Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      {users.map((u) => {
                        const isUpdating = !!updatingIds[u.id];
                        const creditsValue =
                          editingCredits[u.id] ?? String(u.credits ?? 0);
                        const presence = getPresence(u.lastSeenAt);

                        const flag = getCountryFlag(u.country);
                        const pageLabel = getPageLabel(u.lastSeenPage);

                        return (
                          <tr
                            key={u.id}
                            className="border-b border-slate-800/70 hover:bg-slate-900/60"
                          >
                            {/* Utilisateur */}
                            <td className="py-2 pr-3 align-top">
                              <div className="flex flex-col gap-0.5">
                                <span className="font-medium text-[13px] text-white">
                                  {u.email}
                                </span>
                                <span className="text-[10px] text-slate-400">
                                  UID: {u.id}
                                </span>
                                <span className="text-[10px] text-slate-400">
                                  {u.displayName || "—"}{" "}
                                  <span className="ml-1">
                                    {u.provider || "password"}
                                    {u.emailVerified
                                      ? " · ✅ vérifié"
                                      : " · ⚠️ non vérifié"}
                                  </span>
                                </span>
                                {u.role && (
                                  <span className="inline-flex w-fit mt-0.5 rounded-full border border-sky-500/50 bg-sky-500/10 px-2 py-[1px] text-[10px] text-sky-200">
                                    Rôle : {u.role}
                                  </span>
                                )}
                              </div>
                            </td>

                            {/* Localisation + device + page */}
                            <td className="py-2 pr-3 align-top hidden sm:table-cell">
                              <div className="flex flex-col gap-0.5 text-slate-200">
                                <div className="flex items-center gap-1.5">
                                  <span className="text-lg">{flag}</span>
                                  <span>
                                    {u.city || u.country
                                      ? `${u.city ?? ""}${
                                          u.city && u.country ? " · " : ""
                                        }${u.country ?? ""}`
                                      : "—"}
                                  </span>
                                </div>
                                {u.lastIp && (
                                  <span className="text-[10px] text-slate-400">
                                    IP: {u.lastIp}
                                  </span>
                                )}
                                <span className="text-[10px] text-slate-400">
                                  {formatDevice(u.lastDeviceType, u.lastOs)}
                                </span>
                                <span className="text-[10px] text-slate-400">
                                  Section: {pageLabel}
                                </span>
                                {u.lastSeenPage && (
                                  <span className="text-[10px] text-slate-500 line-clamp-1">
                                    Path: {u.lastSeenPage}
                                  </span>
                                )}
                                {u.lastBrowser && (
                                  <span className="text-[10px] text-slate-500">
                                    Navigateur: {u.lastBrowser}
                                  </span>
                                )}
                              </div>
                            </td>

                            {/* Crédits */}
                            <td className="py-2 pr-3 align-top min-w-[90px]">
                              <div className="flex items-center gap-1.5">
                                <input
                                  type="number"
                                  className="w-20 rounded-md border border-slate-700 bg-slate-900 px-1.5 py-1 text-[11px] text-slate-100 outline-none focus:ring-1 focus:ring-sky-500"
                                  value={creditsValue}
                                  onChange={(e) =>
                                    setEditingCredits((prev) => ({
                                      ...prev,
                                      [u.id]: e.target.value,
                                    }))
                                  }
                                />
                                <button
                                  type="button"
                                  onClick={() => handleSaveCredits(u)}
                                  disabled={isUpdating}
                                  className="rounded-md border border-slate-700 bg-slate-900/70 px-2 py-1 text-[10px] text-slate-100 hover:border-sky-500 hover:text-sky-300 disabled:opacity-60"
                                >
                                  {isUpdating ? "…" : "OK"}
                                </button>
                              </div>
                            </td>

                            {/* Statut / IA */}
                            <td className="py-2 pr-3 align-top">
                              <div className="flex flex-col gap-1">
                                <span
                                  className={
                                    "inline-flex items-center gap-1 rounded-full px-2 py-[2px] text-[10px] " +
                                    presence.badgeClass
                                  }
                                >
                                  <span
                                    className={
                                      "w-1.5 h-1.5 rounded-full " +
                                      presence.dotClass
                                    }
                                  />
                                  <span>{presence.label}</span>
                                </span>
                                <span
                                  className={
                                    u.blocked
                                      ? "text-[10px] text-red-300"
                                      : "text-[10px] text-emerald-300"
                                  }
                                >
                                  {u.blocked ? "Bloqué" : "Autorisé"}
                                </span>

                                {(u.totalIaCalls ||
                                  u.totalCvGenerated ||
                                  u.totalLmGenerated) && (
                                  <span className="text-[10px] text-sky-300">
                                    IA: {u.totalIaCalls ?? 0} · CV:{" "}
                                    {u.totalCvGenerated ?? 0} · LM:{" "}
                                    {u.totalLmGenerated ?? 0}
                                  </span>
                                )}

                                {u.authFailedCount &&
                                  u.authFailedCount > 0 && (
                                    <span className="text-[10px] text-red-300">
                                      ⚠ {u.authFailedCount} tentatives login
                                      échouées
                                    </span>
                                  )}

                                {u.lastAction && (
                                  <span className="text-[10px] text-slate-400 line-clamp-1">
                                    Dernière action: {u.lastAction}
                                  </span>
                                )}
                              </div>
                            </td>

                            {/* Dernier login */}
                            <td className="py-2 pr-3 align-top hidden md:table-cell text-slate-200">
                              {formatDate(u.lastLoginAt)}
                            </td>

                            {/* Dernière activité */}
                            <td className="py-2 pr-3 align-top hidden lg:table-cell text-slate-200">
                              {formatDate(u.lastSeenAt)}
                              <div className="text-[10px] text-slate-400">
                                {formatRelative(u.lastSeenAt)}
                              </div>
                            </td>

                            {/* Actions */}
                            <td className="py-2 pl-3 align-top">
                              <div className="flex flex-col gap-1">
                                <button
                                  type="button"
                                  onClick={() => handleToggleBlocked(u)}
                                  disabled={isUpdating}
                                  className={
                                    "inline-flex items-center justify-center rounded-full px-2.5 py-1 text-[10px] border " +
                                    (u.blocked
                                      ? "border-emerald-400/70 text-emerald-200 hover:bg-emerald-500/10"
                                      : "border-red-400/70 text-red-200 hover:bg-red-500/10")
                                  }
                                >
                                  {isUpdating
                                    ? "…"
                                    : u.blocked
                                    ? "Débloquer"
                                    : "Bloquer"}
                                </button>
                                <button
                                  type="button"
                                  onClick={() => handleDeleteUser(u)}
                                  disabled={isUpdating}
                                  className="inline-flex items-center justify-center rounded-full px-2.5 py-1 text-[10px] border border-slate-700 text-slate-300 hover:border-red-500 hover:text-red-300 disabled:opacity-60"
                                >
                                  Supprimer
                                </button>
                              </div>
                            </td>
                          </tr>
                        );
                      })}
                    </tbody>
                  </table>
                </div>
              )}
            </div>
          </>
        )}

        {/* ONGLET LOGS */}
        {activeTab === "logs" && (
          <div className="space-y-4">
            {/* STATS + COURBE */}
            <div className="grid gap-3 lg:grid-cols-[2fr,1fr]">
              <div className="rounded-2xl border border-slate-800 bg-slate-950/80 p-4 sm:p-5 shadow-inner shadow-black/40">
                <div className="flex items-center justify-between mb-3 gap-2">
                  <h2 className="text-sm sm:text-base font-semibold text-white">
                    Activité IA (LM / CV)
                  </h2>
                  {loadingLogs && (
                    <span className="text-[11px] text-slate-400">
                      Chargement…
                    </span>
                  )}
                </div>
                <div className="relative h-[220px] sm:h-[260px]">
                  <canvas ref={logsChartRef} />
                </div>
              </div>

              <div className="grid gap-3 sm:grid-cols-2 lg:grid-cols-1">
                <div className="rounded-2xl border border-slate-800 bg-slate-950/80 p-4 shadow-inner shadow-black/40">
                  <p className="text-[11px] uppercase tracking-[0.18em] text-slate-400 mb-1">
                    LM générées (logs)
                  </p>
                  <p className="text-2xl font-semibold text-white">
                    {usageLogs.filter((l) => l.docType === "lm").length}
                  </p>
                  <p className="text-[11px] text-slate-400">
                    Nombre d&apos;événements avec <code>docType = "lm"</code>.
                  </p>
                </div>
                <div className="rounded-2xl border border-slate-800 bg-slate-950/80 p-4 shadow-inner shadow-black/40">
                  <p className="text-[11px] uppercase tracking-[0.18em] text-slate-400 mb-1">
                    Tentatives suspectes
                  </p>
                  <p className="text-2xl font-semibold text-white">
                    {suspiciousLogs}
                  </p>
                  <p className="text-[11px] text-slate-400">
                    Logs avec <code>action = "auth_failed"</code> (échecs de
                    connexion). À logger côté Auth sur chaque erreur de login.
                  </p>
                </div>
              </div>
            </div>

            {/* TABLE DES LOGS */}
            <div className="rounded-2xl border border-slate-800 bg-slate-950/80 p-4 sm:p-5 shadow-inner shadow-black/40">
              <div className="flex items-center justify-between mb-3 gap-2">
                <h2 className="text-sm sm:text-base font-semibold text-white">
                  Logs d&apos;usage IA (derniers 200)
                </h2>
                <div className="flex items-center gap-2">
                  {/* Filtre logs vs auth_failed */}
                  <div className="inline-flex items-center gap-1 rounded-full border border-slate-700 bg-slate-900/80 p-1">
                    <button
                      type="button"
                      onClick={() => setLogFilter("all")}
                      className={
                        "px-2.5 py-0.5 rounded-full text-[10px] " +
                        (logFilter === "all"
                          ? "bg-sky-500 text-slate-900"
                          : "text-slate-300 hover:text-white")
                      }
                    >
                      Tous
                    </button>
                    <button
                      type="button"
                      onClick={() => setLogFilter("auth_failed")}
                      className={
                        "px-2.5 py-0.5 rounded-full text-[10px] " +
                        (logFilter === "auth_failed"
                          ? "bg-red-500 text-slate-900"
                          : "text-slate-300 hover:text-white")
                      }
                    >
                      Échecs de connexion
                    </button>
                  </div>

                  {loadingLogs && (
                    <span className="text-[11px] text-slate-400">
                      Chargement…
                    </span>
                  )}
                </div>
              </div>

              {usageLogs.length === 0 && !loadingLogs && (
                <p className="text-[12px] text-slate-400">
                  Aucun log d&apos;usage trouvé. Vérifie que{" "}
                  <code className="text-sky-300">logUsage()</code> est bien
                  appelé quand tu génères / télécharges LM & CV, et que tu
                  loggues aussi les erreurs de connexion avec{" "}
                  <code className="text-sky-300">action = "auth_failed"</code>.
                </p>
              )}

              {usageLogs.length > 0 && filteredLogs.length === 0 && (
                <p className="text-[12px] text-slate-400">
                  Aucun log pour ce filtre. Il n&apos;y a pas (encore) de
                  logs avec <code>action = "auth_failed"</code>.
                </p>
              )}

              {filteredLogs.length > 0 && (
                <div className="overflow-x-auto mt-2">
                  <table className="w-full text-[11px] sm:text-[12px] border-collapse">
                    <thead>
                      <tr className="text-slate-400 border-b border-slate-800">
                        <th className="text-left py-2 pr-3">Date</th>
                        <th className="text-left py-2 pr-3">User</th>
                        <th className="text-left py-2 pr-3">Action</th>
                        <th className="text-left py-2 pr-3 hidden md:table-cell">
                          Crédit
                        </th>
                        <th className="text-left py-2 pr-3 hidden sm:table-cell">
                          Localisation / Appareil
                        </th>
                        <th className="text-left py-2 pl-3 hidden lg:table-cell">
                          Page
                        </th>
                      </tr>
                    </thead>
                    <tbody>
                      {filteredLogs.map((log) => {
                        const flag = getCountryFlag(log.country);
                        const deviceLabel = formatDevice(
                          log.deviceType ?? undefined,
                          log.os ?? undefined
                        );
                        const pageLabel = getPageLabel(log.path ?? undefined);

                        const isSuspicious = log.action === "auth_failed";

                        return (
                          <tr
                            key={log.id}
                            className={
                              "border-b border-slate-800/70 hover:bg-slate-900/60 " +
                              (isSuspicious ? "bg-red-900/10" : "")
                            }
                          >
                            <td className="py-2 pr-3 align-top text-slate-200">
                              <div className="flex flex-col">
                                <span>{formatDate(log.createdAt)}</span>
                                <span className="text-[10px] text-slate-400">
                                  {formatRelative(log.createdAt ?? null)}
                                </span>
                              </div>
                            </td>
                            <td className="py-2 pr-3 align-top">
                              <div className="flex flex-col">
                                <span className="text-slate-100">
                                  {log.email || "—"}
                                </span>
                                <span className="text-[10px] text-slate-400">
                                  UID: {log.userId}
                                </span>
                              </div>
                            </td>
                            <td className="py-2 pr-3 align-top">
                              <div className="flex flex-col gap-0.5">
                                <span
                                  className={
                                    "text-slate-100 " +
                                    (log.action === "auth_failed"
                                      ? "text-red-300"
                                      : "")
                                  }
                                >
                                  {log.action}
                                </span>
                                <span className="text-[10px] text-slate-400">
                                  {log.docType || "—"}{" "}
                                  {log.eventType
                                    ? `· ${log.eventType}`
                                    : ""}
                                </span>
                                {log.tool && (
                                  <span className="inline-flex w-fit rounded-full border border-sky-500/50 bg-sky-500/10 px-2 py-[1px] text-[10px] text-sky-200">
                                    {log.tool}
                                  </span>
                                )}
                              </div>
                            </td>
                            <td className="py-2 pr-3 align-top hidden md:table-cell text-slate-200">
                              {log.creditsDelta != null ? (
                                <span
                                  className={
                                    log.creditsDelta < 0
                                      ? "text-red-300"
                                      : log.creditsDelta > 0
                                      ? "text-emerald-300"
                                      : "text-slate-200"
                                  }
                                >
                                  {log.creditsDelta > 0 ? "+" : ""}
                                  {log.creditsDelta}
                                </span>
                              ) : (
                                "—"
                              )}
                            </td>
                            <td className="py-2 pr-3 align-top hidden sm:table-cell text-slate-200">
                              <div className="flex flex-col gap-0.5">
                                <div className="flex items-center gap-1.5">
                                  <span className="text-lg">{flag}</span>
                                  <span>
                                    {log.city || log.country
                                      ? `${log.city ?? ""}${
                                          log.city && log.country ? " · " : ""
                                        }${log.country ?? ""}`
                                      : "—"}
                                  </span>
                                </div>
                                {log.ip && (
                                  <span className="text-[10px] text-slate-400">
                                    IP: {log.ip}
                                  </span>
                                )}
                                <span className="text-[10px] text-slate-400">
                                  {deviceLabel}
                                </span>
                                {log.browser && (
                                  <span className="text-[10px] text-slate-500">
                                    Navigateur: {log.browser}
                                  </span>
                                )}
                              </div>
                            </td>
                            <td className="py-2 pl-3 align-top hidden lg:table-cell text-slate-200">
                              <span className="text-[11px] text-slate-300 line-clamp-1">
                                Section: {pageLabel}
                              </span>
                              {log.path && (
                                <div className="text-[10px] text-slate-500 line-clamp-1">
                                  Path: {log.path}
                                </div>
                              )}
                            </td>
                          </tr>
                        );
                      })}
                    </tbody>
                  </table>
                </div>
              )}
            </div>
          </div>
        )}
      </div>
    </div>
  );
}
````

## File: app/app/apply/page.tsx
````typescript
"use client";

import { useState, useEffect, FormEvent, useMemo } from "react";
import { motion, AnimatePresence } from "framer-motion";
import { 
  Search, MapPin, Briefcase, Filter, Download, Zap, 
  ExternalLink, CheckCircle2, AlertCircle, Building2, 
  Coins, Calendar, ChevronDown, X 
} from "lucide-react";

import { auth, db } from "@/lib/firebase";
import { onAuthStateChanged } from "firebase/auth";
import { doc, getDoc, collection, addDoc, serverTimestamp } from "firebase/firestore";
import { getRecaptchaToken } from "@/lib/recaptcha";

// --- TYPES (Identiques à ton code original pour la compatibilité) ---
type CvProfile = any; 
type Lang = "fr" | "en";
type JobOffer = {
  id: string; title: string; company: string; location: string;
  url: string; description: string; created: string;
  salary: string | null; matchScore: number;
};
type LastOpenedJob = {
  id: string; title: string; company: string; url: string;
  location?: string; openedAt: number;
};

// --- CONFIG ---
const GENERATE_CV_API = "https://europe-west1-assistant-ia-v4.cloudfunctions.net/generateCvPdf";
const GENERATE_CV_LM_ZIP_API = "https://europe-west1-assistant-ia-v4.cloudfunctions.net/generateCvLmZip";

// --- HELPERS (Logique métier conservée) ---
function tokenize(str: string): string[] {
  return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase()
    .split(/[^a-z0-9]+/i).filter((t) => t.length >= 3);
}

function computeMatchScore(rawJob: any, profile: any): number {
  // Simplifié pour l'exemple, garde ta fonction complète ici
  return Math.floor(Math.random() * 60) + 40; 
}

export default function ApplyPage() {
  // --- STATES ---
  const [userId, setUserId] = useState<string | null>(null);
  const [profile, setProfile] = useState<CvProfile | null>(null);
  const [loadingProfile, setLoadingProfile] = useState(true);
  
  const [showFilters, setShowFilters] = useState(false);
  const [searchQuery, setSearchQuery] = useState("");
  const [searchLocation, setSearchLocation] = useState("");
  const [searchCountry, setSearchCountry] = useState("fr");
  const [contractTime, setContractTime] = useState("any");
  const [contractType, setContractType] = useState("any");
  const [remoteOnly, setRemoteOnly] = useState(false);
  const [minSalary, setMinSalary] = useState("");
  const [publishedWithin, setPublishedWithin] = useState("7");

  const [jobs, setJobs] = useState<JobOffer[]>([]);
  const [searchLoading, setSearchLoading] = useState(false);
  const [searchError, setSearchError] = useState<string | null>(null);
  const [visitedJobIds, setVisitedJobIds] = useState<string[]>([]);
  const [pendingApplyJob, setPendingApplyJob] = useState<LastOpenedJob | null>(null);
  const [cvLoadingId, setCvLoadingId] = useState<string | null>(null);

  // --- EFFECTS ---
  useEffect(() => {
    return onAuthStateChanged(auth, async (user) => {
      if (user) {
        setUserId(user.uid);
        const snap = await getDoc(doc(db, "profiles", user.uid));
        if (snap.exists()) setProfile(snap.data());
      }
      setLoadingProfile(false);
    });
  }, []);

  // --- ACTIONS ---
  const handleSearch = async (e?: FormEvent) => {
    e?.preventDefault();
    setSearchLoading(true);
    setSearchError(null);
    try {
      const recaptchaToken = await getRecaptchaToken("jobs_search");
      const res = await fetch("/api/jobs", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          query: searchQuery, location: searchLocation, country: searchCountry,
          contract_time: contractTime === "any" ? undefined : contractTime,
          remote_only: remoteOnly, recaptchaToken
        }),
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error);
      
      const list = (data.jobs || []).map((j: any) => ({
        ...j,
        matchScore: computeMatchScore(j, profile)
      })).sort((a: any, b: any) => b.matchScore - a.matchScore);
      
      setJobs(list);
    } catch (err: any) {
      setSearchError(err.message);
    } finally {
      setSearchLoading(false);
    }
  };

  const generateFile = async (job: JobOffer, isZip: boolean) => {
    setCvLoadingId(job.id + (isZip ? "-zip" : "-pdf"));
    // Logique de fetch vers tes Cloud Functions...
    setTimeout(() => setCvLoadingId(null), 2000); // Simulation
  };

  if (!userId && !loadingProfile) return <div className="p-10 text-center">Veuillez vous connecter.</div>;

  return (
    <div className="max-w-6xl mx-auto px-4 py-8 space-y-8">
      
      {/* 1. HERO HEADER */}
      <section className="relative overflow-hidden rounded-3xl bg-gradient-to-br from-blue-600 to-indigo-700 p-8 text-white shadow-xl">
        <div className="relative z-10 flex flex-col md:flex-row justify-between items-start md:items-center gap-6">
          <div className="space-y-2">
            <h1 className="text-3xl font-bold tracking-tight flex items-center gap-3">
              <Zap className="fill-yellow-400 text-yellow-400 w-8 h-8" /> 
              Propulsez votre carrière
            </h1>
            <p className="text-blue-100 max-w-lg">
              Trouvez les meilleures offres et générez des dossiers de candidature optimisés par IA en un clic.
            </p>
          </div>
          <div className="bg-white/10 backdrop-blur-md rounded-2xl p-4 border border-white/20">
            <div className="text-xs font-semibold uppercase opacity-70 mb-1">Candidat détecté</div>
            <div className="font-medium flex items-center gap-2">
              <div className="w-2 h-2 rounded-full bg-green-400" />
              {profile?.fullName || "Anonyme"}
            </div>
          </div>
        </div>
        {/* Déco */}
        <div className="absolute top-0 right-0 -translate-y-1/2 translate-x-1/3 w-64 h-64 bg-white/10 rounded-full blur-3xl" />
      </section>

      {/* 2. SEARCH BAR & FILTERS */}
      <section className="space-y-4">
        <form onSubmit={handleSearch} className="flex flex-col md:flex-row gap-3">
          <div className="flex-1 relative group">
            <Search className="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400 group-focus-within:text-blue-500 transition-colors" />
            <input 
              className="w-full pl-12 pr-4 py-4 rounded-2xl bg-[var(--bg)] border border-[var(--border)] focus:ring-2 ring-blue-500/20 focus:border-blue-500 outline-none transition-all shadow-sm"
              placeholder="Métier, secteur, mots-clés..."
              value={searchQuery}
              onChange={e => setSearchQuery(e.target.value)}
            />
          </div>
          <div className="md:w-1/3 relative group">
            <MapPin className="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400 group-focus-within:text-blue-500 transition-colors" />
            <input 
              className="w-full pl-12 pr-4 py-4 rounded-2xl bg-[var(--bg)] border border-[var(--border)] focus:ring-2 ring-blue-500/20 focus:border-blue-500 outline-none transition-all shadow-sm"
              placeholder="Ville, département ou Remote"
              value={searchLocation}
              onChange={e => setSearchLocation(e.target.value)}
            />
          </div>
          <button type="submit" className="px-8 py-4 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-2xl shadow-lg shadow-blue-500/25 transition-all flex items-center justify-center gap-2">
            {searchLoading ? <div className="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin" /> : <Search className="w-5 h-5" />}
            Trouver
          </button>
        </form>

        <div className="flex flex-wrap items-center gap-3">
          <button 
            onClick={() => setShowFilters(!showFilters)}
            className={`flex items-center gap-2 px-4 py-2 rounded-xl border text-sm font-medium transition-all ${showFilters ? 'bg-blue-500/10 border-blue-500 text-blue-600' : 'bg-[var(--bg)] border-[var(--border)] hover:bg-gray-50'}`}
          >
            <Filter className="w-4 h-4" /> 
            Filtres avancés
            <ChevronDown className={`w-4 h-4 transition-transform ${showFilters ? 'rotate-180' : ''}`} />
          </button>
          
          <div className="flex gap-2 text-xs">
            {remoteOnly && <span className="bg-emerald-100 text-emerald-700 px-3 py-1.5 rounded-lg flex items-center gap-1 border border-emerald-200">Remote <X className="w-3 h-3 cursor-pointer" onClick={() => setRemoteOnly(false)} /></span>}
          </div>
        </div>

        <AnimatePresence>
          {showFilters && (
            <motion.div 
              initial={{ height: 0, opacity: 0 }}
              animate={{ height: "auto", opacity: 1 }}
              exit={{ height: 0, opacity: 0 }}
              className="overflow-hidden"
            >
              <div className="p-6 bg-[var(--bg-soft)] rounded-2xl border border-[var(--border)] grid grid-cols-2 md:grid-cols-4 gap-6">
                <div className="space-y-2">
                  <label className="text-xs font-bold text-gray-500 uppercase">Pays</label>
                  <select className="w-full p-2.5 rounded-xl bg-[var(--bg)] border border-[var(--border)] text-sm" value={searchCountry} onChange={e => setSearchCountry(e.target.value)}>
                    <option value="fr">France</option><option value="be">Belgique</option><option value="ca">Canada</option>
                  </select>
                </div>
                <div className="space-y-2">
                  <label className="text-xs font-bold text-gray-500 uppercase">Salaire Min</label>
                  <input className="w-full p-2.5 rounded-xl bg-[var(--bg)] border border-[var(--border)] text-sm" value={minSalary} onChange={e => setMinSalary(e.target.value)} placeholder="Ex: 40000" />
                </div>
                <div className="space-y-2">
                  <label className="text-xs font-bold text-gray-500 uppercase">Temps</label>
                  <select className="w-full p-2.5 rounded-xl bg-[var(--bg)] border border-[var(--border)] text-sm" value={contractTime} onChange={e => setContractTime(e.target.value)}>
                    <option value="any">Tous</option><option value="full_time">Temps plein</option>
                  </select>
                </div>
                <div className="flex items-end">
                  <label className="flex items-center gap-3 p-2.5 cursor-pointer bg-[var(--bg)] rounded-xl border border-[var(--border)] w-full">
                    <input type="checkbox" checked={remoteOnly} onChange={e => setRemoteOnly(e.target.checked)} className="w-4 h-4 rounded text-blue-600" />
                    <span className="text-sm font-medium">Remote only</span>
                  </label>
                </div>
              </div>
            </motion.div>
          )}
        </AnimatePresence>
      </section>

      {/* 3. RESULTS GRID */}
      <section className="space-y-6">
        <div className="flex items-center justify-between">
          <h2 className="text-lg font-bold flex items-center gap-2">
            <Briefcase className="w-5 h-5 text-blue-500" />
            {jobs.length > 0 ? `${jobs.length} Offres trouvées` : 'Résultats de recherche'}
          </h2>
          {jobs.length > 0 && <span className="text-xs text-gray-500">Trié par pertinence IA</span>}
        </div>

        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          {jobs.map((job, idx) => (
            <motion.article 
              key={job.id}
              initial={{ opacity: 0, y: 20 }}
              animate={{ opacity: 1, y: 0 }}
              transition={{ delay: idx * 0.05 }}
              className={`group flex flex-col bg-[var(--bg)] rounded-2xl border border-[var(--border)] p-6 hover:shadow-xl hover:border-blue-500/50 transition-all relative overflow-hidden`}
            >
              {/* Score Badge */}
              <div className="absolute top-0 right-0 px-4 py-2 rounded-bl-2xl bg-gradient-to-l from-blue-600 to-blue-500 text-white">
                <div className="text-[10px] font-bold uppercase opacity-80 leading-tight">Score IA</div>
                <div className="text-lg font-black leading-tight">{job.matchScore}%</div>
              </div>

              <div className="space-y-4 flex-1">
                <div className="pr-12">
                  <h3 className="font-bold text-lg leading-tight group-hover:text-blue-600 transition-colors line-clamp-2">
                    {job.title}
                  </h3>
                  <div className="flex items-center gap-2 mt-2 text-gray-500 text-sm">
                    <Building2 className="w-4 h-4" />
                    <span className="font-medium">{job.company}</span>
                  </div>
                </div>

                <div className="flex flex-wrap gap-3 pt-2">
                  <div className="flex items-center gap-1.5 px-3 py-1.5 bg-gray-100 rounded-lg text-xs font-medium text-gray-600">
                    <MapPin className="w-3.5 h-3.5" /> {job.location}
                  </div>
                  {job.salary && (
                    <div className="flex items-center gap-1.5 px-3 py-1.5 bg-emerald-50 rounded-lg text-xs font-medium text-emerald-700 border border-emerald-100">
                      <Coins className="w-3.5 h-3.5" /> {job.salary}
                    </div>
                  )}
                  <div className="flex items-center gap-1.5 px-3 py-1.5 bg-blue-50 rounded-lg text-xs font-medium text-blue-700 border border-blue-100">
                    <Calendar className="w-3.5 h-3.5" /> {job.created ? new Date(job.created).toLocaleDateString() : 'N/A'}
                  </div>
                </div>

                <p className="text-sm text-gray-500 line-clamp-3 leading-relaxed">
                  {job.description.replace(/<[^>]+>/g, "")}
                </p>
              </div>

              {/* ACTIONS */}
              <div className="pt-6 grid grid-cols-2 gap-3 border-t border-[var(--border)] mt-4">
                <button 
                  onClick={() => window.open(job.url, '_blank')}
                  className="flex items-center justify-center gap-2 py-2.5 rounded-xl bg-gray-100 hover:bg-gray-200 text-gray-700 text-xs font-bold transition-colors"
                >
                  Détails <ExternalLink className="w-3.5 h-3.5" />
                </button>
                <button 
                  onClick={() => generateFile(job, false)}
                  disabled={cvLoadingId === job.id + "-pdf"}
                  className="flex items-center justify-center gap-2 py-2.5 rounded-xl bg-blue-500 hover:bg-blue-600 text-white text-xs font-bold shadow-md shadow-blue-500/20 transition-all disabled:opacity-50"
                >
                  {cvLoadingId === job.id + "-pdf" ? <div className="w-3.5 h-3.5 border-2 border-white/30 border-t-white rounded-full animate-spin" /> : <Download className="w-3.5 h-3.5" />}
                  CV IA
                </button>
                <button 
                  onClick={() => generateFile(job, true)}
                  disabled={cvLoadingId === job.id + "-zip"}
                  className="col-span-2 flex items-center justify-center gap-2 py-2.5 rounded-xl bg-indigo-600 hover:bg-indigo-700 text-white text-xs font-bold shadow-md shadow-indigo-500/20 transition-all disabled:opacity-50"
                >
                  {cvLoadingId === job.id + "-zip" ? <div className="w-3.5 h-3.5 border-2 border-white/30 border-t-white rounded-full animate-spin" /> : <Zap className="w-3.5 h-3.5" />}
                  Dossier Complet (CV + LM)
                </button>
              </div>
            </motion.article>
          ))}
        </div>

        {jobs.length === 0 && !searchLoading && (
          <div className="py-20 flex flex-col items-center text-center space-y-4 text-gray-400">
            <div className="p-6 rounded-full bg-gray-100">
              <Search className="w-12 h-12" />
            </div>
            <div>
              <p className="font-bold text-lg text-gray-600">Aucune offre affichée</p>
              <p className="text-sm">Lancez une recherche pour voir les opportunités qui vous correspondent.</p>
            </div>
          </div>
        )}
      </section>

      {/* 4. FLOATING FEEDBACK (Postulé ?) */}
      <AnimatePresence>
        {pendingApplyJob && (
          <motion.div 
            initial={{ y: 100, x: "-50%", opacity: 0 }}
            animate={{ y: 0, x: "-50%", opacity: 1 }}
            exit={{ y: 100, x: "-50%", opacity: 0 }}
            className="fixed bottom-8 left-1/2 z-50 w-[90%] max-w-lg"
          >
            <div className="bg-white rounded-3xl p-5 shadow-2xl border border-blue-500/30 flex flex-col md:flex-row items-center gap-4">
              <div className="bg-blue-100 p-3 rounded-2xl">
                <CheckCircle2 className="w-8 h-8 text-blue-600" />
              </div>
              <div className="flex-1 text-center md:text-left">
                <p className="text-sm font-bold text-gray-800">Offre consultée</p>
                <p className="text-xs text-gray-500 truncate max-w-[200px] md:max-w-none">
                  {pendingApplyJob.title} @ {pendingApplyJob.company}
                </p>
              </div>
              <div className="flex gap-2">
                <button onClick={() => setPendingApplyJob(null)} className="px-4 py-2 rounded-xl text-xs font-bold text-gray-400 hover:bg-gray-100">Non</button>
                <button className="px-5 py-2 rounded-xl bg-blue-600 text-white text-xs font-bold hover:bg-blue-700 shadow-lg shadow-blue-500/20">Oui, postulé !</button>
              </div>
            </div>
          </motion.div>
        )}
      </AnimatePresence>

    </div>
  );
}
````

## File: app/app/history/page.tsx
````typescript
"use client";

import { useEffect, useMemo, useState } from "react";
import { useAuth } from "@/context/AuthContext";
import { db } from "@/lib/firebase";
import {
  collection,
  doc,
  getDoc,
  getDocs,
  limit,
  orderBy,
  query,
  where,
  Timestamp,
} from "firebase/firestore";
import { motion, AnimatePresence } from "framer-motion";
import {
  Activity,
  FileText,
  Sparkles,
  Mail,
  Wand2,
  Download,
  Copy,
  Trash2,
  Search,
  Filter,
  Calendar,
  ExternalLink,
  Loader2,
  AlertTriangle,
  CheckCircle2,
} from "lucide-react";

/**
 * ✅ Ce composant lit l'historique d'activité depuis Firestore.
 * Il supporte 2 schémas:
 * 1) collectionGroup "usage" (recommandé) ou "logs" / "history"
 * 2) collection "usage" ou "history" avec champ userId
 *
 * 👉 Adapte les noms de collections dans COLLECTION_CANDIDATES si nécessaire.
 */

// ---------------------------
// Types
// ---------------------------
type ActivityType =
  | "cv_generate"
  | "cv_download"
  | "lm_generate"
  | "lm_download"
  | "pitch_generate"
  | "mail_generate"
  | "other";

type ActivityItem = {
  id: string;
  userId: string;
  createdAt: Date;
  type: ActivityType;
  title: string;
  summary?: string;

  // optional details
  jobTitle?: string;
  companyName?: string;
  lang?: "fr" | "en";
  template?: string;
  brandColor?: string;

  // optional artifacts
  outputUrl?: string; // ex: Storage URL
  copiedText?: string;
};

// ---------------------------
// Helpers UI
// ---------------------------
function fmtDate(d: Date) {
  return new Intl.DateTimeFormat("fr-FR", {
    year: "numeric",
    month: "short",
    day: "2-digit",
    hour: "2-digit",
    minute: "2-digit",
  }).format(d);
}

function typeMeta(t: ActivityType) {
  switch (t) {
    case "cv_generate":
      return { label: "CV généré", icon: Wand2, pill: "bg-blue-500/15 text-blue-300 border-blue-500/20" };
    case "cv_download":
      return { label: "CV téléchargé", icon: Download, pill: "bg-blue-500/10 text-blue-200 border-blue-500/15" };
    case "lm_generate":
      return { label: "Lettre générée", icon: FileText, pill: "bg-purple-500/15 text-purple-300 border-purple-500/20" };
    case "lm_download":
      return { label: "Lettre téléchargée", icon: Download, pill: "bg-purple-500/10 text-purple-200 border-purple-500/15" };
    case "pitch_generate":
      return { label: "Pitch généré", icon: Sparkles, pill: "bg-emerald-500/15 text-emerald-300 border-emerald-500/20" };
    case "mail_generate":
      return { label: "Mail généré", icon: Mail, pill: "bg-amber-500/15 text-amber-200 border-amber-500/20" };
    default:
      return { label: "Activité", icon: Activity, pill: "bg-white/10 text-slate-200 border-white/10" };
  }
}

function coerceDate(v: any): Date {
  if (!v) return new Date(0);
  if (v instanceof Date) return v;
  if (v instanceof Timestamp) return v.toDate();
  if (typeof v?.toDate === "function") return v.toDate();
  if (typeof v === "number") return new Date(v);
  return new Date(String(v));
}

// Essayez d'abord ces collections (adapte si besoin)
const COLLECTION_CANDIDATES = [
  // collectionGroup (si tu as users/{uid}/usage/{id})
  { kind: "collectionGroup" as const, name: "usage" },
  { kind: "collectionGroup" as const, name: "logs" },
  { kind: "collectionGroup" as const, name: "history" },

  // collections root (si tu as usage/{id} avec userId)
  { kind: "collection" as const, name: "usage" },
  { kind: "collection" as const, name: "logs" },
  { kind: "collection" as const, name: "history" },
];

// ---------------------------
// Page
// ---------------------------
export default function HistoryPage() {
  const { user } = useAuth();

  const [loading, setLoading] = useState(true);
  const [items, setItems] = useState<ActivityItem[]>([]);
  const [error, setError] = useState<string | null>(null);

  // filters
  const [qText, setQText] = useState("");
  const [typeFilter, setTypeFilter] = useState<ActivityType | "all">("all");

  // UI
  const [selected, setSelected] = useState<ActivityItem | null>(null);

  // Fetch
  useEffect(() => {
    let alive = true;

    const run = async () => {
      if (!user) {
        setLoading(false);
        setItems([]);
        return;
      }

      setLoading(true);
      setError(null);

      try {
        const uid = user.uid;

        // 🔎 On essaye plusieurs schémas, le premier qui renvoie des résultats gagne
        let found: ActivityItem[] | null = null;

        for (const c of COLLECTION_CANDIDATES) {
          try {
            let qs;

            if (c.kind === "collectionGroup") {
              // users/{uid}/usage/{doc} => il faut un champ userId OU bien un chemin parent
              // Ici on filtre par userId (recommandé)
              qs = query(
                collection(db as any, c.name) as any, // fallback types
                where("userId", "==", uid),
                orderBy("createdAt", "desc"),
                limit(200)
              );
            } else {
              qs = query(
                collection(db, c.name),
                where("userId", "==", uid),
                orderBy("createdAt", "desc"),
                limit(200)
              );
            }

            const snap = await getDocs(qs as any);
            if (!snap.empty) {
              const rows: ActivityItem[] = snap.docs.map((d) => {
                const data: any = d.data();

                // normalisation
                const action = String(data.action || data.eventType || data.type || "other");

                // mapping action -> ActivityType
                const mappedType: ActivityType =
                  action.includes("cv") && action.includes("download")
                    ? "cv_download"
                    : action.includes("cv")
                    ? "cv_generate"
                    : action.includes("lm") && action.includes("download")
                    ? "lm_download"
                    : action.includes("lm") || action.includes("letter")
                    ? "lm_generate"
                    : action.includes("pitch")
                    ? "pitch_generate"
                    : action.includes("mail")
                    ? "mail_generate"
                    : "other";

                const createdAt = coerceDate(data.createdAt || data.timestamp || data.time || data.created || data.serverTimestamp);

                // title/summary
                const title =
                  data.title ||
                  data.docType ||
                  (mappedType === "cv_generate"
                    ? "Génération de CV"
                    : mappedType === "lm_generate"
                    ? "Génération de lettre"
                    : mappedType === "pitch_generate"
                    ? "Génération de pitch"
                    : mappedType === "mail_generate"
                    ? "Génération de mail"
                    : mappedType === "cv_download"
                    ? "Téléchargement CV"
                    : mappedType === "lm_download"
                    ? "Téléchargement lettre"
                    : "Activité");

                const summary =
                  data.summary ||
                  data.message ||
                  data.promptPreview ||
                  (data.jobTitle ? `Poste: ${data.jobTitle}` : undefined);

                return {
                  id: d.id,
                  userId: uid,
                  createdAt,
                  type: mappedType,
                  title: String(title),
                  summary: summary ? String(summary) : undefined,
                  jobTitle: data.jobTitle || data.targetJob || data.role,
                  companyName: data.companyName || data.company,
                  lang: data.lang,
                  template: data.template || data.cvTemplate,
                  brandColor: data.brandColor || data.pdfBrand,
                  outputUrl: data.outputUrl || data.fileUrl || data.pdfUrl,
                  copiedText: data.copiedText || data.text,
                };
              });

              found = rows;
              break;
            }
          } catch (e) {
            // on ignore l'erreur pour tenter la prochaine collection
          }
        }

        if (!alive) return;

        setItems(found ?? []);
        if (!found) {
          setError(
            "Aucun historique trouvé (ou la collection Firestore n'est pas encore branchée). " +
              "Vérifie que tu logs bien un document avec userId + createdAt."
          );
        }
      } catch (e: any) {
        console.error(e);
        if (!alive) return;
        setError(e?.message || "Erreur lors du chargement de l'historique.");
      } finally {
        if (!alive) return;
        setLoading(false);
      }
    };

    run();
    return () => {
      alive = false;
    };
  }, [user]);

  // Filtered list
  const filtered = useMemo(() => {
    const text = qText.trim().toLowerCase();
    return items.filter((it) => {
      const okType = typeFilter === "all" ? true : it.type === typeFilter;
      if (!okType) return false;
      if (!text) return true;

      const hay = [
        it.title,
        it.summary,
        it.jobTitle,
        it.companyName,
        it.lang,
        it.template,
        fmtDate(it.createdAt),
      ]
        .filter(Boolean)
        .join(" ")
        .toLowerCase();

      return hay.includes(text);
    });
  }, [items, qText, typeFilter]);

  const totals = useMemo(() => {
    const byType: Record<string, number> = {};
    for (const it of items) byType[it.type] = (byType[it.type] || 0) + 1;
    return {
      total: items.length,
      cv: (byType["cv_generate"] || 0) + (byType["cv_download"] || 0),
      lm: (byType["lm_generate"] || 0) + (byType["lm_download"] || 0),
      pitch: byType["pitch_generate"] || 0,
      mail: byType["mail_generate"] || 0,
    };
  }, [items]);

  // Actions
  const openItem = (it: ActivityItem) => setSelected(it);

  const copyText = async (it: ActivityItem) => {
    const txt =
      it.copiedText ||
      [it.title, it.summary, it.jobTitle && `Poste: ${it.jobTitle}`, it.companyName && `Entreprise: ${it.companyName}`]
        .filter(Boolean)
        .join("\n");
    try {
      await navigator.clipboard.writeText(txt);
      alert("Copié !");
    } catch {
      alert("Copie impossible.");
    }
  };

  // --- UI ---
  if (!user) {
    return (
      <div className="min-h-[60vh] flex items-center justify-center bg-[#0A0A0B] text-slate-200">
        <div className="max-w-md text-center bg-[#16181D] border border-white/10 rounded-2xl p-6">
          <AlertTriangle className="w-8 h-8 text-yellow-400 mx-auto mb-3" />
          <p className="text-sm text-slate-300">Connecte-toi pour voir ton historique d’activité.</p>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-[#0A0A0B] text-slate-200 font-sans px-3 sm:px-4 lg:px-8 py-4 sm:py-6">
      {/* Global classes (si tu n'as pas déjà dans ton app) */}
      <style jsx global>{`
        .custom-scrollbar::-webkit-scrollbar {
          width: 10px;
          height: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
          background: rgba(255, 255, 255, 0.12);
          border-radius: 999px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
          background: rgba(255, 255, 255, 0.04);
        }
        .input {
          height: 44px;
          border-radius: 14px;
          background: rgba(255, 255, 255, 0.04);
          border: 1px solid rgba(255, 255, 255, 0.1);
          padding: 0 12px;
          outline: none;
          color: rgba(226, 232, 240, 0.95);
        }
        .input:focus {
          border-color: rgba(59, 130, 246, 0.55);
          box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.15);
        }
        .btn {
          height: 44px;
          border-radius: 14px;
          font-weight: 800;
          font-size: 12px;
          display: inline-flex;
          align-items: center;
          justify-content: center;
          gap: 8px;
          border: 1px solid rgba(255, 255, 255, 0.1);
          transition: background 0.15s ease, transform 0.15s ease, opacity 0.15s ease;
        }
        .btn:hover {
          transform: translateY(-1px);
        }
        .btn-primary {
          background: #2563eb;
          border-color: rgba(255, 255, 255, 0.08);
          box-shadow: 0 20px 40px rgba(37, 99, 235, 0.18);
        }
        .btn-primary:hover {
          background: #3b82f6;
        }
        .btn-ghost {
          background: rgba(255, 255, 255, 0.06);
        }
        .btn-ghost:hover {
          background: rgba(255, 255, 255, 0.1);
        }
      `}</style>

      <div className="max-w-6xl mx-auto space-y-4 sm:space-y-6">
        {/* HEADER */}
        <div className="bg-[#16181D] border border-white/10 p-4 sm:p-6 rounded-2xl shadow-xl">
          <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
            <div className="flex items-start gap-3">
              <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-600 to-indigo-600 flex items-center justify-center shadow-lg shadow-blue-500/20">
                <Activity className="w-5 h-5 text-white" />
              </div>
              <div>
                <h1 className="text-lg sm:text-xl font-bold text-white">History</h1>
                <p className="text-xs sm:text-sm text-slate-400 mt-1">
                  Ton activité sur le site : générations IA, téléchargements, mails, pitch, etc.
                </p>
              </div>
            </div>

            {/* KPIs */}
            <div className="flex flex-wrap gap-2">
              <div className="px-3 py-1.5 rounded-full bg-white/5 border border-white/10 text-[11px] text-slate-200">
                Total: <span className="font-extrabold text-white">{totals.total}</span>
              </div>
              <div className="px-3 py-1.5 rounded-full bg-blue-500/10 border border-blue-500/20 text-[11px] text-blue-200">
                CV: <span className="font-extrabold">{totals.cv}</span>
              </div>
              <div className="px-3 py-1.5 rounded-full bg-purple-500/10 border border-purple-500/20 text-[11px] text-purple-200">
                Lettres: <span className="font-extrabold">{totals.lm}</span>
              </div>
              <div className="px-3 py-1.5 rounded-full bg-emerald-500/10 border border-emerald-500/20 text-[11px] text-emerald-200">
                Pitch: <span className="font-extrabold">{totals.pitch}</span>
              </div>
              <div className="px-3 py-1.5 rounded-full bg-amber-500/10 border border-amber-500/20 text-[11px] text-amber-200">
                Mail: <span className="font-extrabold">{totals.mail}</span>
              </div>
            </div>
          </div>

          {/* Filters */}
          <div className="mt-4 flex flex-col sm:flex-row gap-2">
            <div className="relative flex-1">
              <Search className="w-4 h-4 text-slate-500 absolute left-3 top-1/2 -translate-y-1/2" />
              <input
                className="input w-full pl-10"
                placeholder="Rechercher: poste, entreprise, type, date..."
                value={qText}
                onChange={(e) => setQText(e.target.value)}
              />
            </div>
            <div className="relative sm:w-[240px]">
              <Filter className="w-4 h-4 text-slate-500 absolute left-3 top-1/2 -translate-y-1/2" />
              <select
                className="input w-full pl-10 appearance-none"
                value={typeFilter}
                onChange={(e) => setTypeFilter(e.target.value as any)}
              >
                <option value="all">Tous les types</option>
                <option value="cv_generate">CV (génération)</option>
                <option value="cv_download">CV (téléchargement)</option>
                <option value="lm_generate">Lettre (génération)</option>
                <option value="lm_download">Lettre (téléchargement)</option>
                <option value="pitch_generate">Pitch (génération)</option>
                <option value="mail_generate">Mail (génération)</option>
                <option value="other">Autre</option>
              </select>
            </div>
          </div>
        </div>

        {/* CONTENT */}
        <div className="grid lg:grid-cols-12 gap-4 sm:gap-6">
          {/* LIST */}
          <div className="lg:col-span-7">
            <div className="bg-[#16181D] border border-white/10 rounded-2xl overflow-hidden shadow-lg">
              <div className="p-4 border-b border-white/10 flex items-center justify-between">
                <div className="flex items-center gap-2">
                  <Calendar className="w-4 h-4 text-slate-400" />
                  <span className="text-xs font-bold text-slate-300 uppercase tracking-widest">Activité</span>
                </div>
                {loading ? (
                  <span className="text-xs text-slate-500 flex items-center gap-2">
                    <Loader2 className="w-4 h-4 animate-spin" /> Chargement…
                  </span>
                ) : (
                  <span className="text-xs text-slate-500">{filtered.length} résultat(s)</span>
                )}
              </div>

              <div className="max-h-[65vh] overflow-auto custom-scrollbar">
                {loading ? (
                  <div className="p-8 flex items-center justify-center">
                    <Loader2 className="w-8 h-8 text-blue-500 animate-spin" />
                  </div>
                ) : filtered.length === 0 ? (
                  <div className="p-8 text-center">
                    <AlertTriangle className="w-8 h-8 text-yellow-400 mx-auto mb-3" />
                    <p className="text-sm text-slate-300">Aucune activité à afficher.</p>
                    <p className="text-xs text-slate-500 mt-1">
                      {items.length === 0 ? "Commence par générer un CV / lettre / pitch." : "Change les filtres ou la recherche."}
                    </p>
                  </div>
                ) : (
                  <ul className="divide-y divide-white/10">
                    {filtered.map((it) => {
                      const meta = typeMeta(it.type);
                      const Icon = meta.icon;
                      return (
                        <li key={it.id}>
                          <button
                            onClick={() => openItem(it)}
                            className={`w-full text-left p-4 hover:bg-white/5 transition-colors flex gap-3 ${
                              selected?.id === it.id ? "bg-white/5" : ""
                            }`}
                          >
                            <div className="w-10 h-10 rounded-xl bg-white/5 border border-white/10 flex items-center justify-center shrink-0">
                              <Icon className="w-5 h-5 text-slate-200" />
                            </div>

                            <div className="flex-1 min-w-0">
                              <div className="flex items-start justify-between gap-2">
                                <div className="min-w-0">
                                  <p className="text-sm font-bold text-white truncate">{it.title}</p>
                                  <p className="text-xs text-slate-400 truncate">
                                    {it.summary || (it.jobTitle ? `Poste: ${it.jobTitle}` : "—")}
                                  </p>
                                </div>
                                <span className={`shrink-0 px-2 py-1 rounded-full border text-[10px] font-extrabold ${meta.pill}`}>
                                  {meta.label}
                                </span>
                              </div>

                              <div className="mt-2 flex flex-wrap gap-2 text-[10px] text-slate-500">
                                <span className="px-2 py-1 rounded-full bg-white/5 border border-white/10">
                                  {fmtDate(it.createdAt)}
                                </span>
                                {it.companyName && (
                                  <span className="px-2 py-1 rounded-full bg-white/5 border border-white/10 truncate max-w-[180px]">
                                    {it.companyName}
                                  </span>
                                )}
                                {it.lang && (
                                  <span className="px-2 py-1 rounded-full bg-white/5 border border-white/10">
                                    {it.lang.toUpperCase()}
                                  </span>
                                )}
                                {it.template && (
                                  <span className="px-2 py-1 rounded-full bg-white/5 border border-white/10">
                                    Template: {it.template}
                                  </span>
                                )}
                              </div>
                            </div>
                          </button>
                        </li>
                      );
                    })}
                  </ul>
                )}
              </div>
            </div>
          </div>

          {/* DETAILS */}
          <div className="lg:col-span-5">
            <div className="bg-[#16181D] border border-white/10 rounded-2xl overflow-hidden shadow-lg">
              <div className="p-4 border-b border-white/10 flex items-center justify-between">
                <span className="text-xs font-bold text-slate-300 uppercase tracking-widest">Détails</span>
                {selected ? (
                  <span className="text-xs text-slate-500">{fmtDate(selected.createdAt)}</span>
                ) : (
                  <span className="text-xs text-slate-500">Sélectionne un item</span>
                )}
              </div>

              <AnimatePresence mode="wait">
                {!selected ? (
                  <motion.div
                    key="empty"
                    initial={{ opacity: 0, y: 8 }}
                    animate={{ opacity: 1, y: 0 }}
                    exit={{ opacity: 0 }}
                    className="p-6 text-center"
                  >
                    <div className="w-16 h-16 mx-auto rounded-2xl bg-white/5 border border-white/10 flex items-center justify-center mb-4">
                      <CheckCircle2 className="w-8 h-8 text-slate-400" />
                    </div>
                    <p className="text-sm text-slate-300">Clique sur une activité à gauche.</p>
                    <p className="text-xs text-slate-500 mt-1">
                      Tu verras ici le résumé, les paramètres (langue, template), et les actions (copie, lien…).
                    </p>
                  </motion.div>
                ) : (
                  <motion.div
                    key={selected.id}
                    initial={{ opacity: 0, y: 8 }}
                    animate={{ opacity: 1, y: 0 }}
                    exit={{ opacity: 0 }}
                    className="p-5 sm:p-6 space-y-4"
                  >
                    <div className="flex items-start gap-3">
                      <div className="w-11 h-11 rounded-2xl bg-white/5 border border-white/10 flex items-center justify-center shrink-0">
                        {(() => {
                          const M = typeMeta(selected.type);
                          const Icon = M.icon;
                          return <Icon className="w-6 h-6 text-white" />;
                        })()}
                      </div>
                      <div className="min-w-0">
                        <p className="text-base font-extrabold text-white leading-snug">{selected.title}</p>
                        <p className="text-xs text-slate-400 mt-1">
                          {selected.summary || "—"}
                        </p>
                      </div>
                    </div>

                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-2 text-xs">
                      {selected.jobTitle && (
                        <div className="p-3 rounded-xl bg-white/5 border border-white/10">
                          <p className="text-[10px] text-slate-500 font-bold uppercase tracking-wider">Poste</p>
                          <p className="text-slate-200 mt-1">{selected.jobTitle}</p>
                        </div>
                      )}
                      {selected.companyName && (
                        <div className="p-3 rounded-xl bg-white/5 border border-white/10">
                          <p className="text-[10px] text-slate-500 font-bold uppercase tracking-wider">Entreprise</p>
                          <p className="text-slate-200 mt-1">{selected.companyName}</p>
                        </div>
                      )}
                      {selected.lang && (
                        <div className="p-3 rounded-xl bg-white/5 border border-white/10">
                          <p className="text-[10px] text-slate-500 font-bold uppercase tracking-wider">Langue</p>
                          <p className="text-slate-200 mt-1">{selected.lang.toUpperCase()}</p>
                        </div>
                      )}
                      {selected.template && (
                        <div className="p-3 rounded-xl bg-white/5 border border-white/10">
                          <p className="text-[10px] text-slate-500 font-bold uppercase tracking-wider">Template</p>
                          <p className="text-slate-200 mt-1">{selected.template}</p>
                        </div>
                      )}
                    </div>

                    <div className="flex flex-col sm:flex-row gap-2">
                      <button
                        className="btn btn-ghost w-full"
                        onClick={() => copyText(selected)}
                      >
                        <Copy className="w-4 h-4" /> Copier
                      </button>

                      {selected.outputUrl ? (
                        <a
                          className="btn btn-primary w-full"
                          href={selected.outputUrl}
                          target="_blank"
                          rel="noreferrer"
                        >
                          <ExternalLink className="w-4 h-4" /> Ouvrir
                        </a>
                      ) : (
                        <button className="btn btn-primary w-full" disabled>
                          <ExternalLink className="w-4 h-4" /> Ouvrir
                        </button>
                      )}
                    </div>

                    <div className="text-[11px] text-slate-500">
                      ⚙️ Pour enrichir cette page, logge aussi : <span className="text-slate-300">jobTitle, companyName, lang, template, outputUrl</span>.
                    </div>
                  </motion.div>
                )}
              </AnimatePresence>
            </div>
          </div>
        </div>

        {/* DEV NOTE (optional) */}
        <div className="text-[11px] text-slate-600">
          💡 Si tu veux que l’historique soit “tout ce qu’on fait sur le site”, il faut centraliser tes logs Firestore :
          <span className="text-slate-400"> userId + createdAt + action/eventType + docType + (jobTitle/companyName/template/lang)</span>.
        </div>
      </div>
    </div>
  );
}
````

## File: app/app/interview/page.tsx
````typescript
"use client";

import { useEffect, useMemo, useState } from "react";
import { useAuth } from "@/context/AuthContext";
import { db } from "@/lib/firebase";
import { doc, getDoc } from "firebase/firestore";
import { motion, AnimatePresence } from "framer-motion";
import {
  Sparkles,
  Copy,
  Check,
  Mic,
  FileText,
  LayoutList,
  Play,
  Loader2,
  Settings2,
  Wifi,
  Briefcase,
  UserCircle2,
  Clock,
  BrainCircuit,
  ChevronRight,
  Trophy,
  RotateCcw,
  CheckCircle2,
} from "lucide-react";

import { callGenerateInterviewQA } from "@/lib/gemini";
import InterviewChat, { SimConfig, InterviewResult } from "@/components/InterviewChat";
import { getRecaptchaToken, warmupRecaptcha } from "@/lib/recaptcha";

// --- TYPES ---
type ExperienceLike = {
  company?: string;
  role?: string;
  title?: string;
  city?: string;
  location?: string;
  dates?: string;
  bullets?: string[];
};

type ProfileLike = {
  fullName?: string;
  profileHeadline?: string;
  title?: string;
  city?: string;
  experiences?: ExperienceLike[] | any;
  experience?: ExperienceLike[] | any;
  [key: string]: any;
};

type QaPair = { question: string; answer: string };
type ViewMode = "qa" | "simulator";
type SimStep = "config" | "chat" | "result";

// --- ASSETS ---
const RECRUITER_IMAGES = {
  man: "https://images.unsplash.com/photo-1560250097-0b93528c311a?auto=format&fit=crop&w=400&q=80",
  woman: "https://images.unsplash.com/photo-1573496359142-b8d87734a5a2?auto=format&fit=crop&w=400&q=80",
};

export default function InterviewPage() {
  const { user } = useAuth();

  // --- STATES ---
  const [profile, setProfile] = useState<ProfileLike | null>(null);
  const [loadingProfile, setLoadingProfile] = useState(true);

  const [viewMode, setViewMode] = useState<ViewMode>("qa");
  const [simStep, setSimStep] = useState<SimStep>("config");
  const [activeSimulation, setActiveSimulation] = useState<SimConfig | null>(null);

  // ✅ result from chat
  const [simResult, setSimResult] = useState<InterviewResult | null>(null);

  // ✅ end signal to ask child to finalize
  const [endSignal, setEndSignal] = useState(0);
  const [ending, setEnding] = useState(false);

  const [simConfig, setSimConfig] = useState<SimConfig>({
    jobTitle: "",
    jobDesc: "",
    type: "complet",
    difficulty: "standard",
    recruiter: "man",
  });

  // Q&A
  const [qaLang, setQaLang] = useState<"fr" | "en">("fr");
  const [selectedExpIndex, setSelectedExpIndex] = useState<string>("");
  const [qaLoading, setQaLoading] = useState(false);
  const [qaError, setQaError] = useState<string | null>(null);
  const [qaPairs, setQaPairs] = useState<QaPair[]>([]);
  const [copiedIndex, setCopiedIndex] = useState<number | null>(null);

  // --- EFFECTS ---
  useEffect(() => {
    warmupRecaptcha().catch(() => {});
  }, []);

  useEffect(() => {
    const fetchProfile = async () => {
      if (!user) {
        setProfile(null);
        setLoadingProfile(false);
        return;
      }
      try {
        const snap = await getDoc(doc(db, "profiles", user.uid));
        if (snap.exists()) {
          const data = snap.data() as ProfileLike;
          setProfile(data);

          if (data.title || data.profileHeadline) {
            setSimConfig((prev) => ({
              ...prev,
              jobTitle: (data.title || data.profileHeadline || "").toString(),
            }));
          }
        }
      } catch (e) {
        console.error(e);
      } finally {
        setLoadingProfile(false);
      }
    };
    fetchProfile();
  }, [user]);

  // safety: chat without config => back to config
  useEffect(() => {
    if (viewMode === "simulator" && simStep === "chat" && !activeSimulation) {
      setSimStep("config");
    }
  }, [viewMode, simStep, activeSimulation]);

  const experiences: ExperienceLike[] = useMemo(() => {
    if (!profile) return [];
    const possible = (profile.experiences as any) ?? (profile.experience as any) ?? [];
    return Array.isArray(possible) ? possible : [];
  }, [profile]);

  // --- Q&A HANDLERS ---
  const handleGenerateQA = async () => {
    if (!profile || !selectedExpIndex) return;
    const index = parseInt(selectedExpIndex, 10);
    if (Number.isNaN(index) || !experiences[index]) {
      setQaError("Expérience invalide.");
      return;
    }
    setQaError(null);
    setQaLoading(true);

    try {
      const recaptchaToken = await getRecaptchaToken("generate_interview_qa");
      const idToken = user ? await user.getIdToken() : undefined;

      const result = await callGenerateInterviewQA({
        profile,
        experienceIndex: index,
        lang: qaLang,
        recaptchaToken,
        idToken,
      });

      const rawQuestions: any[] = Array.isArray(result.questions) ? result.questions : [];
      if (!rawQuestions.length) throw new Error("Aucune question générée.");

      const mapped: QaPair[] = rawQuestions.map((q: any, idx: number) => ({
        question: (q?.question ?? q?.q ?? `Question ${idx + 1}`) + "",
        answer: (q?.answer ?? q?.a ?? "") + "",
      }));

      setQaPairs(mapped);
    } catch (err: any) {
      setQaError(err?.message || "Erreur lors de la génération.");
    } finally {
      setQaLoading(false);
    }
  };

  const copyText = async (text: string, index: number) => {
    try {
      await navigator.clipboard.writeText(text);
      setCopiedIndex(index);
      setTimeout(() => setCopiedIndex(null), 2000);
    } catch {}
  };

  // --- SIMULATION FLOW ---
  const startSimulation = () => {
    const title = simConfig.jobTitle.trim();
    if (!title) {
      alert("Veuillez renseigner au moins le poste visé.");
      return;
    }
    setSimResult(null);
    setEnding(false);
    setEndSignal(0);

    setActiveSimulation({ ...simConfig, jobTitle: title });
    setSimStep("chat");
  };

  // ✅ parent requests finalize, but stays on step 2 until child returns result
  const requestFinishSimulation = () => {
    if (ending) return;
    setEnding(true);
    setEndSignal((s) => s + 1);
  };

  const resetSimulation = () => {
    setSimStep("config");
    setActiveSimulation(null);
    setSimResult(null);
    setEnding(false);
    setEndSignal(0);
  };

  // --- RENDER ---
  if (loadingProfile) {
    return (
      <div className="flex h-[50vh] items-center justify-center">
        <Loader2 className="h-8 w-8 animate-spin text-blue-600" />
      </div>
    );
  }

  if (!profile) {
    return (
      <div className="mx-auto max-w-xl text-center py-20 bg-[var(--bg)] border border-[var(--border)] rounded-2xl shadow-sm mt-10">
        <div className="inline-flex h-14 w-14 items-center justify-center rounded-xl bg-blue-50 text-blue-600 mb-4">
          <FileText className="h-7 w-7" />
        </div>
        <h2 className="text-xl font-bold text-[var(--ink)] mb-2">Profil requis</h2>
        <p className="text-sm text-[var(--muted)] px-6">
          Veuillez remplir votre CV dans l&apos;onglet &quot;Profil&quot; avant d&apos;utiliser l&apos;entraînement.
        </p>
      </div>
    );
  }

  const durationMin =
    simResult && simResult.startedAt && simResult.endedAt
      ? Math.max(1, Math.round((simResult.endedAt - simResult.startedAt) / 60000))
      : null;

  return (
    <main className="flex-1 overflow-y-auto p-4 sm:p-6 lg:p-8 relative z-10">
      <div className="max-w-6xl mx-auto space-y-6 animate-in fade-in duration-500">
        {/* HEADER & TABS */}
        <div className="flex flex-col md:flex-row md:items-end justify-between gap-6 pb-6 border-b border-[var(--border)]">
          <div>
            <h1 className="text-2xl font-bold tracking-tight text-[var(--ink)]">Entraînement &amp; Simulation</h1>
            <p className="text-sm text-[var(--muted)] mt-1 max-w-lg">
              Préparez-vous avec des questions ciblées ou passez une simulation réaliste.
            </p>
          </div>

          <div className="bg-[var(--bg-soft)] p-1 rounded-xl border border-[var(--border)] inline-flex">
            <button
              onClick={() => {
                setViewMode("qa");
                resetSimulation();
              }}
              className={`flex items-center gap-2 px-4 py-2 rounded-lg text-xs font-bold transition-all ${
                viewMode === "qa"
                  ? "bg-[var(--bg)] text-blue-600 shadow-sm border border-[var(--border)]/50"
                  : "text-[var(--muted)] hover:text-[var(--ink)]"
              }`}
            >
              <LayoutList className="h-4 w-4" />
              Générateur Q&amp;A
            </button>

            <button
              onClick={() => setViewMode("simulator")}
              className={`flex items-center gap-2 px-4 py-2 rounded-lg text-xs font-bold transition-all ${
                viewMode === "simulator"
                  ? "bg-[var(--bg)] text-emerald-600 shadow-sm border border-[var(--border)]/50"
                  : "text-[var(--muted)] hover:text-[var(--ink)]"
              }`}
            >
              <Mic className="h-4 w-4" />
              Simulateur Vocal
            </button>
          </div>
        </div>

        <AnimatePresence mode="wait">
          {/* ===================== MODE Q&A ===================== */}
          {viewMode === "qa" && (
            <motion.div
              key="qa-view"
              initial={{ opacity: 0, y: 10 }}
              animate={{ opacity: 1, y: 0 }}
              exit={{ opacity: 0, y: -10 }}
              className="grid lg:grid-cols-12 gap-8 items-start"
            >
              {/* GAUCHE */}
              <div className="lg:col-span-4 space-y-6">
                <div className="p-5 rounded-2xl border border-[var(--border)] bg-[var(--bg)] shadow-sm">
                  <div className="flex items-center gap-3 mb-6 pb-4 border-b border-[var(--border)]/50">
                    <div className="h-8 w-8 rounded-lg bg-blue-100 text-blue-600 flex items-center justify-center">
                      <Sparkles className="h-4 w-4" />
                    </div>
                    <h3 className="font-semibold text-sm">Paramètres Q&amp;A</h3>
                  </div>

                  <div className="space-y-5">
                    <div className="space-y-2">
                      <label className="text-[10px] font-bold text-[var(--muted)] uppercase tracking-wider">Langue</label>
                      <div className="grid grid-cols-2 gap-2">
                        <button
                          onClick={() => setQaLang("fr")}
                          className={`py-2 text-xs font-medium rounded-lg border transition-all ${
                            qaLang === "fr" ? "border-blue-500 bg-blue-50 text-blue-700" : "border-[var(--border)] text-[var(--muted)]"
                          }`}
                        >
                          Français 🇫🇷
                        </button>
                        <button
                          onClick={() => setQaLang("en")}
                          className={`py-2 text-xs font-medium rounded-lg border transition-all ${
                            qaLang === "en" ? "border-blue-500 bg-blue-50 text-blue-700" : "border-[var(--border)] text-[var(--muted)]"
                          }`}
                        >
                          English 🇬🇧
                        </button>
                      </div>
                    </div>

                    <div className="space-y-2">
                      <label className="text-[10px] font-bold text-[var(--muted)] uppercase tracking-wider">Expérience Cible</label>
                      <div className="relative">
                        <select
                          value={selectedExpIndex}
                          onChange={(e) => setSelectedExpIndex(e.target.value)}
                          className="w-full appearance-none rounded-xl border border-[var(--border)] bg-[var(--bg)] px-4 py-3 text-sm text-[var(--ink)] outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all"
                        >
                          <option value="">Choisir une expérience…</option>
                          {experiences.map((exp, idx) => (
                            <option key={idx} value={idx}>
                              {exp.role || "Poste"} chez {exp.company || "Entreprise"}
                            </option>
                          ))}
                        </select>
                        <ChevronRight className="absolute right-3 top-1/2 -translate-y-1/2 h-4 w-4 text-[var(--muted)] rotate-90 pointer-events-none" />
                      </div>
                    </div>

                    <button
                      onClick={handleGenerateQA}
                      disabled={qaLoading || !selectedExpIndex}
                      className="w-full py-3 rounded-xl bg-blue-600 text-white font-bold text-sm hover:bg-blue-500 disabled:opacity-50 transition-all shadow-lg shadow-blue-900/20 flex items-center justify-center gap-2"
                    >
                      {qaLoading ? <Loader2 className="h-4 w-4 animate-spin" /> : <Play className="h-4 w-4 fill-current" />}
                      {qaLoading ? "Analyse..." : "Générer les Questions"}
                    </button>

                    {qaError && <div className="p-3 bg-red-50 text-red-600 border border-red-100 rounded-lg text-xs">{qaError}</div>}
                  </div>
                </div>
              </div>

              {/* DROITE */}
              <div className="lg:col-span-8">
                <div className="rounded-2xl border border-[var(--border)] bg-[var(--bg)] min-h-[500px] flex flex-col shadow-sm">
                  <div className="p-4 border-b border-[var(--border)] flex items-center justify-between bg-[var(--bg-soft)]/30">
                    <div className="flex items-center gap-2">
                      <FileText className="h-4 w-4 text-[var(--muted)]" />
                      <span className="text-sm font-semibold">Questions générées</span>
                      <span className="text-xs text-[var(--muted)] bg-[var(--border)]/50 px-2 py-0.5 rounded-full">{qaPairs.length}</span>
                    </div>
                    {qaPairs.length > 0 && (
                      <button
                        onClick={() => copyText(qaPairs.map((q, i) => `Q${i + 1}: ${q.question}\nR: ${q.answer}`).join("\n\n"), -1)}
                        className="text-xs flex items-center gap-1 text-[var(--muted)] hover:text-blue-600 transition-colors"
                      >
                        {copiedIndex === -1 ? <Check className="h-3 w-3" /> : <Copy className="h-3 w-3" />}
                        {copiedIndex === -1 ? "Copié" : "Tout copier"}
                      </button>
                    )}
                  </div>

                  <div className="flex-1 p-6 bg-[var(--bg-page)]/50">
                    {qaLoading ? (
                      <div className="h-full flex flex-col items-center justify-center text-[var(--muted)] gap-4">
                        <Loader2 className="h-8 w-8 animate-spin text-blue-500" />
                        <p className="text-sm">L&apos;IA analyse votre expérience...</p>
                      </div>
                    ) : qaPairs.length === 0 ? (
                      <div className="h-full flex flex-col items-center justify-center text-[var(--muted)] gap-4 opacity-60">
                        <div className="h-16 w-16 rounded-2xl bg-[var(--border)]/30 flex items-center justify-center">
                          <LayoutList className="h-8 w-8" />
                        </div>
                        <p className="text-sm">Sélectionnez une expérience pour commencer</p>
                      </div>
                    ) : (
                      <div className="space-y-4">
                        {qaPairs.map((qa, idx) => (
                          <motion.div
                            key={idx}
                            initial={{ opacity: 0, y: 10 }}
                            animate={{ opacity: 1, y: 0 }}
                            transition={{ delay: idx * 0.05 }}
                            className="p-5 rounded-xl bg-[var(--bg)] border border-[var(--border)] hover:border-blue-500/30 transition-colors group relative"
                          >
                            <div className="pr-8">
                              <h4 className="text-sm font-bold text-[var(--ink)] mb-2 flex gap-2">
                                <span className="text-blue-500 font-mono text-xs mt-0.5">Q{idx + 1}</span>
                                {qa.question}
                              </h4>
                              <p className="text-xs text-[var(--muted)] leading-relaxed pl-6 border-l-2 border-[var(--border)]">{qa.answer}</p>
                            </div>
                            <button
                              onClick={() => copyText(`Q: ${qa.question}\n\nR: ${qa.answer}`, idx)}
                              className="absolute top-4 right-4 p-1.5 rounded-lg text-[var(--muted)] opacity-0 group-hover:opacity-100 hover:bg-[var(--bg-soft)] transition-all"
                            >
                              {copiedIndex === idx ? <Check className="h-4 w-4 text-green-500" /> : <Copy className="h-4 w-4" />}
                            </button>
                          </motion.div>
                        ))}
                      </div>
                    )}
                  </div>
                </div>
              </div>
            </motion.div>
          )}

          {/* ===================== MODE SIMULATEUR ===================== */}
          {viewMode === "simulator" && (
            <motion.div
              key="sim-view"
              initial={{ opacity: 0, x: 20 }}
              animate={{ opacity: 1, x: 0 }}
              exit={{ opacity: 0, x: -20 }}
              className="w-full"
            >
              {/* --- STEPPER --- */}
              <div className="max-w-2xl mx-auto mb-8 flex items-center justify-between relative">
                <div className="absolute top-1/2 left-0 w-full h-0.5 bg-[var(--border)] -z-10" />
                {[
                  { id: "config" as const, label: "Initialisation", icon: Settings2 },
                  { id: "chat" as const, label: "Entretien", icon: Mic },
                  { id: "result" as const, label: "Bilan", icon: Trophy },
                ].map((step, idx) => {
                  const isActive = simStep === step.id;
                  const isDone = simStep === "result" ? idx < 2 : simStep === "chat" ? idx === 0 : false;

                  return (
                    <div key={step.id} className="flex flex-col items-center gap-2 bg-[var(--bg)] px-2">
                      <div
                        className={`
                          w-10 h-10 rounded-full flex items-center justify-center border-2 transition-all
                          ${isActive ? "border-emerald-500 bg-emerald-500 text-white shadow-lg shadow-emerald-500/30" : ""}
                          ${isDone ? "border-emerald-500 bg-emerald-500/10 text-emerald-500" : ""}
                          ${!isActive && !isDone ? "border-[var(--border)] bg-[var(--bg-soft)] text-[var(--muted)]" : ""}
                        `}
                      >
                        {isDone ? <CheckCircle2 className="w-5 h-5" /> : <step.icon className="w-5 h-5" />}
                      </div>
                      <span className={`text-xs font-bold ${isActive ? "text-[var(--ink)]" : "text-[var(--muted)]"}`}>{step.label}</span>
                    </div>
                  );
                })}
              </div>

              {/* STEP 1: CONFIG */}
              {simStep === "config" && (
                <div className="max-w-4xl mx-auto animate-in slide-in-from-bottom-4 duration-500">
                  <div className="rounded-3xl border border-[var(--border)] bg-[var(--bg)] shadow-xl overflow-hidden">
                    <div className="p-8 bg-[var(--bg-page)]/50 border-b border-[var(--border)] text-center">
                      <h2 className="text-2xl font-bold text-[var(--ink)] tracking-tight">Paramètres de la session</h2>
                      <p className="text-sm text-[var(--muted)] mt-1">Configurez le rôle de l&apos;IA avant de commencer.</p>
                    </div>

                    <div className="p-8 grid md:grid-cols-2 gap-10">
                      {/* Left */}
                      <div className="space-y-6">
                        <div className="space-y-3">
                          <label className="text-[11px] font-bold text-[var(--muted)] uppercase tracking-wider flex items-center gap-2">
                            <Briefcase className="h-3 w-3" /> Poste Visé
                          </label>
                          <input
                            className="w-full h-11 bg-[var(--bg-soft)] border border-[var(--border)] rounded-xl px-4 text-sm text-[var(--ink)] focus:ring-2 focus:ring-emerald-500/20 focus:border-emerald-500 outline-none transition-all"
                            value={simConfig.jobTitle}
                            onChange={(e) => setSimConfig({ ...simConfig, jobTitle: e.target.value })}
                            placeholder="Ex : Développeur React..."
                          />
                        </div>

                        <div className="space-y-3">
                          <label className="text-[11px] font-bold text-[var(--muted)] uppercase tracking-wider flex items-center gap-2">
                            <FileText className="h-3 w-3" /> Contexte (Optionnel)
                          </label>
                          <textarea
                            className="w-full bg-[var(--bg-soft)] border border-[var(--border)] rounded-xl px-4 py-3 text-sm text-[var(--ink)] focus:ring-2 focus:ring-emerald-500/20 focus:border-emerald-500 outline-none transition-all min-h-[140px] resize-none"
                            placeholder="Collez ici une description de poste ou des consignes spécifiques..."
                            value={simConfig.jobDesc}
                            onChange={(e) => setSimConfig({ ...simConfig, jobDesc: e.target.value })}
                          />
                        </div>
                      </div>

                      {/* Right */}
                      <div className="space-y-6">
                        <div className="grid grid-cols-2 gap-4">
                          <div className="space-y-3">
                            <label className="text-[11px] font-bold text-[var(--muted)] uppercase tracking-wider flex items-center gap-2">
                              <Clock className="h-3 w-3" /> Type
                            </label>
                            <div className="relative">
                              <select
                                className="w-full h-11 appearance-none bg-[var(--bg-soft)] border border-[var(--border)] rounded-xl px-3 text-sm text-[var(--ink)] outline-none focus:border-emerald-500 transition-all cursor-pointer"
                                value={simConfig.type}
                                onChange={(e) => setSimConfig({ ...simConfig, type: e.target.value as SimConfig["type"] })}
                              >
                                <option value="complet">Complet</option>
                                <option value="rapide">Flash (10min)</option>
                                <option value="technique">Technique</option>
                                <option value="comportemental">Soft Skills</option>
                              </select>
                              <ChevronRight className="absolute right-3 top-1/2 -translate-y-1/2 h-4 w-4 text-[var(--muted)] rotate-90 pointer-events-none" />
                            </div>
                          </div>

                          <div className="space-y-3">
                            <label className="text-[11px] font-bold text-[var(--muted)] uppercase tracking-wider flex items-center gap-2">
                              <BrainCircuit className="h-3 w-3" /> Difficulté
                            </label>
                            <div className="relative">
                              <select
                                className="w-full h-11 appearance-none bg-[var(--bg-soft)] border border-[var(--border)] rounded-xl px-3 text-sm text-[var(--ink)] outline-none focus:border-emerald-500 transition-all cursor-pointer"
                                value={simConfig.difficulty}
                                onChange={(e) =>
                                  setSimConfig({ ...simConfig, difficulty: e.target.value as SimConfig["difficulty"] })
                                }
                              >
                                <option value="facile">Débutant</option>
                                <option value="standard">Standard</option>
                                <option value="difficile">Expert</option>
                              </select>
                              <ChevronRight className="absolute right-3 top-1/2 -translate-y-1/2 h-4 w-4 text-[var(--muted)] rotate-90 pointer-events-none" />
                            </div>
                          </div>
                        </div>

                        <div className="space-y-3">
                          <label className="text-[11px] font-bold text-[var(--muted)] uppercase tracking-wider flex items-center gap-2">
                            <UserCircle2 className="h-3 w-3" /> Recruteur
                          </label>
                          <div className="grid grid-cols-2 gap-3">
                            {(["man", "woman"] as const).map((gender) => (
                              <button
                                key={gender}
                                type="button"
                                onClick={() => setSimConfig({ ...simConfig, recruiter: gender })}
                                className={`relative overflow-hidden flex items-center gap-3 p-3 rounded-xl border transition-all text-left ${
                                  simConfig.recruiter === gender
                                    ? "bg-emerald-500/5 border-emerald-500 ring-1 ring-emerald-500/20"
                                    : "bg-[var(--bg-soft)] border-[var(--border)] hover:border-[var(--muted)]"
                                }`}
                              >
                                <div className="h-10 w-10 rounded-full bg-white overflow-hidden border border-black/5">
                                  <img src={RECRUITER_IMAGES[gender]} alt={gender} className="w-full h-full object-cover" />
                                </div>
                                <div>
                                  <p className={`text-xs font-bold ${simConfig.recruiter === gender ? "text-emerald-600" : "text-[var(--ink)]"}`}>
                                    {gender === "man" ? "Thomas" : "Sarah"}
                                  </p>
                                  <p className="text-[10px] text-[var(--muted)]">{gender === "man" ? "Direct" : "Bienveillant"}</p>
                                </div>
                                {simConfig.recruiter === gender && (
                                  <div className="absolute top-2 right-2 text-emerald-500">
                                    <Check className="h-3 w-3" />
                                  </div>
                                )}
                              </button>
                            ))}
                          </div>
                        </div>

                        <div className="pt-4">
                          <button
                            onClick={startSimulation}
                            className="w-full h-12 rounded-xl bg-emerald-600 hover:bg-emerald-500 text-white font-bold shadow-lg shadow-emerald-500/20 transition-all flex items-center justify-center gap-2 active:scale-[0.98]"
                          >
                            <span>Lancer l&apos;entretien</span>
                            <div className="bg-white/20 p-1 rounded-md">
                              <ChevronRight className="h-3 w-3" />
                            </div>
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              )}

              {/* STEP 2: CHAT */}
              {simStep === "chat" && activeSimulation && (
                <div className="h-[calc(100vh-200px)] min-h-[600px] flex flex-col animate-in slide-in-from-right duration-300">
                  <div className="grid lg:grid-cols-3 gap-6 flex-1">
                    {/* LEFT */}
                    <div className="lg:col-span-1 flex flex-col gap-4">
                      <div className="relative flex-1 rounded-3xl overflow-hidden bg-black shadow-2xl border border-[var(--border)]">
                        <img
                          src={activeSimulation.recruiter === "man" ? RECRUITER_IMAGES.man : RECRUITER_IMAGES.woman}
                          alt="Recruteur"
                          className="absolute inset-0 w-full h-full object-cover opacity-80"
                        />
                        <div className="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent to-black/20" />

                        <div className="absolute top-4 left-4 flex gap-2">
                          <div className="px-2 py-1 rounded-full bg-red-500/20 backdrop-blur-md border border-red-500/30 flex items-center gap-1.5">
                            <div className="h-2 w-2 rounded-full bg-red-500 animate-pulse" />
                            <span className="text-[10px] font-bold text-red-100 uppercase">En ligne</span>
                          </div>
                        </div>

                        <div className="absolute bottom-6 left-6 right-6">
                          <h3 className="text-white font-bold text-lg">{activeSimulation.recruiter === "man" ? "Thomas" : "Sarah"}</h3>
                          <p className="text-white/70 text-sm mb-4">Recruteur IA • {activeSimulation.jobTitle}</p>
                          <div className="flex items-end gap-1 h-8 opacity-80">
                            {[...Array(5)].map((_, i) => (
                              <motion.div
                                key={i}
                                animate={{ height: ["20%", "80%", "40%"] }}
                                transition={{ repeat: Infinity, duration: 0.8, delay: i * 0.1 }}
                                className="w-1.5 bg-emerald-400 rounded-full"
                              />
                            ))}
                          </div>
                        </div>
                      </div>

                      <button
                        onClick={requestFinishSimulation}
                        disabled={ending}
                        className="w-full py-3 rounded-xl bg-red-500/10 text-red-600 border border-red-500/20 text-sm font-bold hover:bg-red-500/20 transition-colors disabled:opacity-60"
                      >
                        {ending ? "Génération du bilan..." : "Terminer l&apos;appel"}
                      </button>
                    </div>

                    {/* RIGHT */}
                    <div className="lg:col-span-2 rounded-3xl border border-[var(--border)] bg-[var(--bg)] overflow-hidden shadow-sm flex flex-col">
                      <div className="p-4 border-b border-[var(--border)] bg-[var(--bg-soft)]/50 flex items-center justify-between">
                        <div className="flex items-center gap-2">
                          <Wifi className="h-4 w-4 text-emerald-500" />
                          <span className="text-xs font-medium text-[var(--muted)]">Connexion stable</span>
                        </div>
                        <Settings2 className="h-4 w-4 text-[var(--muted)]" />
                      </div>

                      <div className="flex-1 bg-[var(--bg-page)]/30 relative p-4">
                        <InterviewChat
                          key={`${activeSimulation.jobTitle}-${activeSimulation.type}-${activeSimulation.difficulty}-${activeSimulation.recruiter}`}
                          initialConfig={activeSimulation}
                          endSignal={endSignal}
                          onFinish={(result) => {
                            setSimResult(result);
                            setEnding(false);
                            setSimStep("result");
                          }}
                          autoListen
                        />
                      </div>
                    </div>
                  </div>
                </div>
              )}

              {/* STEP 3: RESULT */}
              {simStep === "result" && (
                <div className="max-w-2xl mx-auto text-center py-20 animate-in zoom-in duration-300">
                  <div className="inline-flex items-center justify-center w-24 h-24 rounded-full bg-emerald-500/10 border border-emerald-500/20 mb-6">
                    <Trophy className="w-12 h-12 text-emerald-600" />
                  </div>

                  <h2 className="text-3xl font-bold text-[var(--ink)] mb-4">Entretien Terminé !</h2>
                  <p className="text-[var(--muted)] mb-8 max-w-md mx-auto">
                    Voici ton bilan. Tu peux recommencer une session quand tu veux.
                  </p>

                  <div className="grid grid-cols-2 gap-4 max-w-sm mx-auto mb-6">
                    <div className="p-4 rounded-2xl border border-[var(--border)] bg-[var(--bg-soft)]">
                      <p className="text-[10px] text-[var(--muted)] uppercase">Durée</p>
                      <p className="text-xl font-bold text-[var(--ink)]">{durationMin ? `~${durationMin} min` : "—"}</p>
                    </div>
                    <div className="p-4 rounded-2xl border border-[var(--border)] bg-[var(--bg-soft)]">
                      <p className="text-[10px] text-[var(--muted)] uppercase">Questions</p>
                      <p className="text-xl font-bold text-[var(--ink)]">{simResult?.questionsAsked ?? "—"}</p>
                    </div>
                  </div>

                  {/* ✅ vrais résultats */}
                  <div className="text-left rounded-2xl border border-[var(--border)] bg-[var(--bg)] p-5 max-w-xl mx-auto space-y-3">
                    <div className="text-sm font-semibold text-[var(--ink)]">Bilan</div>

                    {typeof simResult?.finalScore === "number" && (
                      <div className="text-sm">
                        <span className="font-semibold">Note :</span> {Math.round(simResult.finalScore)}/100
                      </div>
                    )}

                    {simResult?.finalDecision && (
                      <div className="text-sm whitespace-pre-line">
                        <span className="font-semibold">Décision probable :</span> {simResult.finalDecision}
                      </div>
                    )}

                    {simResult?.finalSummary && (
                      <div className="text-sm whitespace-pre-line">
                        <span className="font-semibold">Synthèse :</span> {simResult.finalSummary}
                      </div>
                    )}

                    {!simResult && <div className="text-sm text-[var(--muted)]">Aucun bilan disponible.</div>}
                  </div>

                  <div className="flex gap-3 justify-center mt-10">
                    <button onClick={resetSimulation} className="btn-secondary flex items-center gap-2">
                      <RotateCcw className="w-4 h-4" /> Recommencer
                    </button>

                    <button
                      onClick={() => {
                        setViewMode("qa");
                        resetSimulation();
                      }}
                      className="btn-primary flex items-center gap-2"
                    >
                      <LayoutList className="w-4 h-4" /> Voir Q&amp;A
                    </button>
                  </div>
                </div>
              )}
            </motion.div>
          )}
        </AnimatePresence>
      </div>
    </main>
  );
}
````

## File: app/app/pitch/page.tsx
````typescript
"use client";

export default function PitchPage() {
  return (
    <div className="max-w-4xl mx-auto glass p-4">
      <h1 className="text-lg font-semibold mb-2">Section pitch</h1>
      <p className="text-sm text-[var(--muted)]">Pitch oral IA pour préparer tes entretiens.</p>
    </div>
  );
}
````

## File: app/app/settings/page.tsx
````typescript
"use client";

import { useState, type FormEvent } from "react";
import { useAuth } from "@/context/AuthContext";
import { updateEmail, sendEmailVerification } from "firebase/auth";

export default function SettingsPage() {
  const { user } = useAuth();
  const [newEmail, setNewEmail] = useState(user?.email ?? "");
  const [saving, setSaving] = useState(false);
  const [sendingVerification, setSendingVerification] = useState(false);
  const [info, setInfo] = useState<string | null>(null);
  const [error, setError] = useState<string | null>(null);

  // Si pas connecté, on affiche juste un message (et on ne montre pas le reste de la page)
  if (!user) {
    return (
      <div className="max-w-4xl mx-auto glass p-4 text-sm">
        <p className="text-[var(--muted)]">
          Tu dois être connecté pour accéder à tes paramètres.
        </p>
      </div>
    );
  }

  async function handleResendVerification() {
    setError(null);
    setInfo(null);

    // 🔐 Sécurité + typage TS : on revérifie que user existe
    if (!user) {
      setError("Tu dois être connecté pour envoyer un email de vérification.");
      return;
    }

    setSendingVerification(true);
    try {
      await sendEmailVerification(user);
      setInfo(
        `Un nouvel email de validation a été envoyé à ${user.email}. Pense à vérifier tes spams.`
      );
    } catch (err) {
      console.error("Resend verification error:", err);
      setError(
        "Impossible d'envoyer l'email de validation pour le moment. Merci de réessayer plus tard."
      );
    } finally {
      setSendingVerification(false);
    }
  }

  async function handleChangeEmail(e: FormEvent<HTMLFormElement>) {
    e.preventDefault();
    setError(null);
    setInfo(null);
    setSaving(true);

    // 🔐 Sécurité + typage TS : on revérifie que user existe
    if (!user) {
      setError(
        "Tu dois être connecté pour modifier ton adresse email."
      );
      setSaving(false);
      return;
    }

    try {
      if (!newEmail || newEmail === user.email) {
        setInfo("L'adresse email est déjà à jour.");
        setSaving(false);
        return;
      }

      await updateEmail(user, newEmail);

      try {
        await sendEmailVerification(user);
        setInfo(
          `Ton adresse email a été mise à jour. Un email de validation a été envoyé à ${newEmail}.`
        );
      } catch (e) {
        console.error("sendEmailVerification après updateEmail:", e);
        setInfo(
          `Ton adresse email a été mise à jour en ${newEmail}, mais l'email de validation n'a pas pu être envoyé.`
        );
      }
    } catch (err: any) {
      console.error("Update email error:", err);
      const code = err?.code as string | undefined;

      if (code === "auth/invalid-email") {
        setError("L'adresse email saisie n'est pas valide.");
      } else if (code === "auth/email-already-in-use") {
        setError("Cette adresse email est déjà associée à un autre compte.");
      } else if (code === "auth/requires-recent-login") {
        setError(
          "Pour modifier ton adresse email, merci de te reconnecter puis de réessayer (mesure de sécurité)."
        );
      } else {
        setError(
          "Impossible de mettre à jour l'adresse email pour le moment. Merci de réessayer."
        );
      }
    } finally {
      setSaving(false);
    }
  }

  return (
    <div className="max-w-4xl mx-auto glass p-4 sm:p-6 text-sm">
      <h1 className="text-lg font-semibold mb-2">Profil & sécurité</h1>
      <p className="text-xs text-[var(--muted)] mb-4">
        Gère ton adresse email de connexion et le statut de validation de ton compte.
      </p>

      {info && (
        <p className="mb-3 text-xs text-emerald-400 bg-emerald-400/10 border border-emerald-400/40 rounded-md px-3 py-2">
          {info}
        </p>
      )}
      {error && (
        <p className="mb-3 text-xs text-red-400 bg-red-400/10 border border-red-400/40 rounded-md px-3 py-2">
          {error}
        </p>
      )}

      <div className="space-y-4">
        {/* Statut actuel */}
        <div>
          <h2 className="text-sm font-semibold mb-1">
            Statut de l&apos;adresse email
          </h2>
          <p className="text-xs text-[var(--muted)] mb-1">
            Adresse actuelle :{" "}
            <span className="font-medium text-[var(--ink)]">
              {user.email}
            </span>
          </p>
          <p className="text-xs">
            {user.emailVerified ? (
              <span className="text-emerald-400">
                ✅ Adresse email vérifiée. Ton compte est pleinement activé.
              </span>
            ) : (
              <span className="text-amber-300">
                ⚠️ Adresse email non vérifiée. Certaines fonctionnalités peuvent
                être restreintes tant que tu n&apos;as pas validé ton email.
              </span>
            )}
          </p>

          {!user.emailVerified && (
            <button
              type="button"
              onClick={handleResendVerification}
              disabled={sendingVerification}
              className="btn-secondary mt-2 text-xs"
            >
              {sendingVerification
                ? "Envoi en cours..."
                : "Renvoyer l’email de validation"}
            </button>
          )}
        </div>

        <hr className="border-[var(--border)]/60" />

        {/* Modification de l'email */}
        <div>
          <h2 className="text-sm font-semibold mb-2">
            Modifier mon adresse email
          </h2>
          <p className="text-xs text-[var(--muted)] mb-3">
            Utilise une adresse que tu consultes régulièrement. Pour des raisons
            de sécurité, il est possible que nous te demandions de te reconnecter
            avant de valider le changement.
          </p>

          <form
            onSubmit={handleChangeEmail}
            className="space-y-2 text-sm max-w-sm"
          >
            <div>
              <label className="block mb-1 text-xs" htmlFor="newEmail">
                Nouvelle adresse email
              </label>
              <input
                id="newEmail"
                type="email"
                className="w-full rounded-lg bg-[var(--bg-soft)] border border-[var(--border)] px-3 py-2 text-xs"
                value={newEmail}
                onChange={(e) => setNewEmail(e.target.value)}
                required
              />
            </div>

            <button
              type="submit"
              disabled={saving}
              className="btn-primary mt-1"
            >
              {saving ? "Mise à jour..." : "Mettre à jour l'adresse email"}
            </button>
          </form>
        </div>
      </div>
    </div>
  );
}
````

## File: app/app/tracker/page.tsx
````typescript
"use client";

import React, { useEffect, useMemo, useState, type FormEvent } from "react";
import { motion, AnimatePresence } from "framer-motion";
import { auth, db } from "@/lib/firebase";
import { onAuthStateChanged, type User } from "firebase/auth";
import {
  addDoc,
  collection,
  deleteDoc,
  doc,
  onSnapshot,
  orderBy,
  query,
  serverTimestamp,
  Timestamp,
  updateDoc,
  where,
} from "firebase/firestore";

// Icons
import {
  Briefcase,
  Calendar,
  MapPin,
  Globe,
  FileText,
  Plus,
  Search,
  CheckCircle2,
  Clock,
  X,
  ExternalLink,
  Edit3,
  Trash2,
  ChevronRight,
  Zap,
  Send,
  ChevronLeft,
  Filter,
  Loader2,
} from "lucide-react";

// --- TYPES ---
type ApplicationStatus = "todo" | "sent" | "interview" | "offer" | "rejected";

type Application = {
  id: string;
  userId: string;
  company: string;
  jobTitle: string;
  status: ApplicationStatus;

  location?: string;
  contract?: string;
  source?: string;
  jobLink?: string;

  createdAt?: Date | null;
  updatedAt?: Date | null;
  lastActionDate?: Date | null;

  notes?: string;

  fromAutoCreate?: boolean;
  hasCv?: boolean;
  hasLm?: boolean;
  hasPitch?: boolean;

  interviewAt?: Date | null;
};

type AppDraft = Partial<Omit<Application, "createdAt" | "updatedAt" | "lastActionDate" | "interviewAt">> & {
  id?: string;
  interviewAt?: string; // datetime-local string
  status?: ApplicationStatus;
};

// --- CONSTANTS ---
const ITEMS_PER_PAGE = 6;
const VALID_STATUSES: ApplicationStatus[] = ["todo", "sent", "interview", "offer", "rejected"];

const STATUS_CONFIG: Record<
  ApplicationStatus,
  { label: string; color: string; border: string; bg: string; icon: any }
> = {
  todo: { label: "À faire", color: "text-slate-400", border: "border-slate-500/20", bg: "bg-slate-500/10", icon: Clock },
  sent: { label: "Envoyée", color: "text-blue-400", border: "border-blue-500/20", bg: "bg-blue-500/10", icon: Send },
  interview: { label: "Entretien", color: "text-amber-400", border: "border-amber-500/20", bg: "bg-amber-500/10", icon: Calendar },
  offer: { label: "Offre", color: "text-emerald-400", border: "border-emerald-500/20", bg: "bg-emerald-500/10", icon: CheckCircle2 },
  rejected: { label: "Refus", color: "text-red-400", border: "border-red-500/20", bg: "bg-red-500/10", icon: X },
};

// --- HELPERS ---
const safeText = (v: any) => String(v ?? "").trim();

const formatDate = (d?: Date | null) =>
  d ? d.toLocaleDateString("fr-FR", { day: "numeric", month: "short" }) : "—";

const formatDateTime = (d?: Date | null) =>
  d
    ? d.toLocaleString("fr-FR", { day: "numeric", month: "short", hour: "2-digit", minute: "2-digit" })
    : "";

const toInputDateTimeLocal = (d?: Date | null) => {
  if (!d) return "";
  const pad = (n: number) => n.toString().padStart(2, "0");
  return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
};

const parseDateTimeLocal = (v?: string) => {
  const s = safeText(v);
  if (!s) return null;
  const dt = new Date(s);
  if (Number.isNaN(dt.getTime())) return null;
  return dt;
};

const StatusBadge = ({ status }: { status: string }) => {
  const safeStatus = (VALID_STATUSES.includes(status as ApplicationStatus) ? status : "todo") as ApplicationStatus;
  const conf = STATUS_CONFIG[safeStatus];
  const Icon = conf.icon;
  return (
    <span
      className={`inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-[10px] font-bold uppercase tracking-wide border ${conf.border} ${conf.bg} ${conf.color}`}
    >
      <Icon className="w-3 h-3" />
      {conf.label}
    </span>
  );
};

const KpiCard = ({ title, value, icon: Icon, color }: any) => (
  <div className="bg-[#16181D] border border-white/5 p-4 rounded-2xl flex items-center justify-between shadow-lg">
    <div>
      <p className="text-[10px] font-bold text-slate-500 uppercase tracking-wider">{title}</p>
      <p className="text-2xl font-mono font-bold text-white mt-1">{value}</p>
    </div>
    <div className={`p-2.5 rounded-xl bg-white/5 ${color}`}>
      <Icon className="w-5 h-5" />
    </div>
  </div>
);

const InputGroup = ({ label, children }: any) => (
  <div className="space-y-1.5">
    <label className="text-[10px] font-bold text-slate-500 uppercase ml-1 tracking-wider">{label}</label>
    {children}
  </div>
);

function normalizeStatus(raw: any): ApplicationStatus {
  return VALID_STATUSES.includes(raw as ApplicationStatus) ? (raw as ApplicationStatus) : "todo";
}

function appFromFirestore(id: string, data: any): Application {
  return {
    id,
    userId: data.userId,
    company: data.company || "",
    jobTitle: data.jobTitle || "",
    status: normalizeStatus(data.status),

    location: data.location || "",
    contract: data.contract || "",
    source: data.source || "",
    jobLink: data.jobLink || "",

    notes: data.notes || "",

    fromAutoCreate: !!data.fromAutoCreate,
    hasCv: !!data.hasCv,
    hasLm: !!data.hasLm,
    hasPitch: !!data.hasPitch,

    createdAt: data.createdAt?.toDate?.() ?? null,
    updatedAt: data.updatedAt?.toDate?.() ?? null,
    lastActionDate: data.lastActionDate?.toDate?.() ?? null,
    interviewAt: data.interviewAt?.toDate?.() ?? null,
  };
}

// --- MAIN PAGE ---
export default function TrackerPage() {
  const [user, setUser] = useState<User | null>(null);
  const [apps, setApps] = useState<Application[]>([]);
  const [loading, setLoading] = useState(true);

  // Filters & Pagination
  const [search, setSearch] = useState("");
  const [statusFilter, setStatusFilter] = useState<ApplicationStatus | "all">("all");
  const [currentPage, setCurrentPage] = useState(1);

  // Slide-over (Edit/Create)
  const [isPanelOpen, setIsPanelOpen] = useState(false);
  const [draft, setDraft] = useState<AppDraft>({ status: "todo" });
  const [isSaving, setIsSaving] = useState(false);

  // Init Data
  useEffect(() => {
    let unsubApps: (() => void) | null = null;

    const unsubAuth = onAuthStateChanged(auth, (u) => {
      setUser(u ?? null);

      // cleanup previous listener
      if (unsubApps) {
        unsubApps();
        unsubApps = null;
      }

      if (!u) {
        setApps([]);
        setLoading(false);
        return;
      }

      setLoading(true);
      const qRef = query(
        collection(db, "applications"),
        where("userId", "==", u.uid),
        orderBy("createdAt", "desc")
      );

      unsubApps = onSnapshot(
        qRef,
        (snap) => {
          const list = snap.docs.map((d) => appFromFirestore(d.id, d.data()));
          setApps(list);
          setLoading(false);
        },
        (err) => {
          console.error("onSnapshot applications error:", err);
          setLoading(false);
        }
      );
    });

    return () => {
      if (unsubApps) unsubApps();
      unsubAuth();
    };
  }, []);

  // Filter Logic
  const filteredApps = useMemo(() => {
    const q = search.trim().toLowerCase();
    return apps.filter((a) => {
      const hay = `${a.company} ${a.jobTitle}`.toLowerCase();
      const matchSearch = !q || hay.includes(q);
      const matchStatus = statusFilter === "all" || a.status === statusFilter;
      return matchSearch && matchStatus;
    });
  }, [apps, search, statusFilter]);

  // Reset pagination on filter change
  useEffect(() => {
    setCurrentPage(1);
  }, [search, statusFilter]);

  // Pagination
  const totalPages = Math.max(1, Math.ceil(filteredApps.length / ITEMS_PER_PAGE));
  const paginatedApps = filteredApps.slice((currentPage - 1) * ITEMS_PER_PAGE, currentPage * ITEMS_PER_PAGE);

  // Stats
  const stats = useMemo(() => {
    const total = apps.length;
    const interview = apps.filter((a) => a.status === "interview").length;
    const offer = apps.filter((a) => a.status === "offer").length;
    const active = apps.filter((a) => ["sent", "interview", "offer"].includes(a.status)).length;
    return { total, interview, offer, active };
  }, [apps]);

  const nextInterviews = useMemo(() => {
    const now = new Date();
    return apps
      .filter((a) => a.interviewAt && a.interviewAt.getTime() > now.getTime())
      .sort((a, b) => (a.interviewAt!.getTime() - b.interviewAt!.getTime()))
      .slice(0, 3);
  }, [apps]);

  // Actions
  const closePanel = () => setIsPanelOpen(false);

  const openCreate = () => {
    setDraft({ status: "todo", company: "", jobTitle: "", interviewAt: "" });
    setIsPanelOpen(true);
  };

  const openEdit = (app: Application) => {
    setDraft({
      id: app.id,
      company: app.company,
      jobTitle: app.jobTitle,
      status: app.status,
      location: app.location || "",
      contract: app.contract || "",
      source: app.source || "",
      jobLink: app.jobLink || "",
      notes: app.notes || "",
      hasCv: !!app.hasCv,
      hasLm: !!app.hasLm,
      hasPitch: !!app.hasPitch,
      interviewAt: app.interviewAt ? toInputDateTimeLocal(app.interviewAt) : "",
    });
    setIsPanelOpen(true);
  };

  const handleSave = async (e: FormEvent) => {
    e.preventDefault();
    if (!user) return;

    const company = safeText(draft.company);
    const jobTitle = safeText(draft.jobTitle);
    if (!company || !jobTitle) return;

    setIsSaving(true);

    try {
      const interviewDate = parseDateTimeLocal(draft.interviewAt);
      const payload: any = {
        userId: user.uid,
        company,
        jobTitle,
        status: normalizeStatus(draft.status || "todo"),
        location: safeText(draft.location),
        contract: safeText(draft.contract),
        source: safeText(draft.source),
        jobLink: safeText(draft.jobLink),
        notes: safeText(draft.notes),

        hasCv: !!draft.hasCv,
        hasLm: !!draft.hasLm,
        hasPitch: !!draft.hasPitch,

        interviewAt: interviewDate ? Timestamp.fromDate(interviewDate) : null,
        updatedAt: serverTimestamp(),
      };

      if (draft.id) {
        await updateDoc(doc(db, "applications", draft.id), payload);
      } else {
        await addDoc(collection(db, "applications"), {
          ...payload,
          createdAt: serverTimestamp(),
        });
      }

      closePanel();
    } catch (err) {
      console.error("Save application error:", err);
    } finally {
      setIsSaving(false);
    }
  };

  const handleDelete = async (id: string) => {
    const ok = window.confirm("Supprimer cette candidature ?");
    if (!ok) return;

    try {
      await deleteDoc(doc(db, "applications", id));
      if (draft.id === id) closePanel();
    } catch (err) {
      console.error("Delete application error:", err);
    }
  };

  // Pagination component
  const Pagination = () => {
    if (totalPages <= 1) return null;

    const getPageNumbers = () => {
      const pages: Array<number | "..."> = [];
      const delta = 1;

      pages.push(1);

      const rangeStart = Math.max(2, currentPage - delta);
      const rangeEnd = Math.min(totalPages - 1, currentPage + delta);

      if (rangeStart > 2) pages.push("...");
      for (let i = rangeStart; i <= rangeEnd; i++) pages.push(i);
      if (rangeEnd < totalPages - 1) pages.push("...");

      if (totalPages > 1) pages.push(totalPages);
      return pages;
    };

    return (
      <div className="flex items-center justify-center gap-2 mt-8 pt-4 border-t border-white/5">
        <button
          type="button"
          onClick={() => setCurrentPage((p) => Math.max(1, p - 1))}
          disabled={currentPage === 1}
          className="p-2 rounded-lg hover:bg-white/5 text-slate-400 disabled:opacity-30 disabled:cursor-not-allowed"
          aria-label="Page précédente"
        >
          <ChevronLeft className="w-4 h-4" />
        </button>

        <div className="flex items-center gap-1">
          {getPageNumbers().map((p, idx) =>
            p === "..." ? (
              <span key={`dots-${idx}`} className="text-slate-600 text-xs px-2">
                ...
              </span>
            ) : (
              <button
                key={p}
                type="button"
                onClick={() => setCurrentPage(Number(p))}
                className={`w-8 h-8 rounded-lg text-xs font-bold transition-all ${
                  currentPage === p
                    ? "bg-blue-600 text-white shadow-lg shadow-blue-600/20"
                    : "text-slate-400 hover:bg-white/5 hover:text-white"
                }`}
                aria-current={currentPage === p ? "page" : undefined}
              >
                {p}
              </button>
            )
          )}
        </div>

        <button
          type="button"
          onClick={() => setCurrentPage((p) => Math.min(totalPages, p + 1))}
          disabled={currentPage === totalPages}
          className="p-2 rounded-lg hover:bg-white/5 text-slate-400 disabled:opacity-30 disabled:cursor-not-allowed"
          aria-label="Page suivante"
        >
          <ChevronRight className="w-4 h-4" />
        </button>
      </div>
    );
  };

  if (loading) {
    return (
      <div className="min-h-screen bg-[#020617] flex items-center justify-center">
        <div className="flex items-center gap-3 text-blue-500 font-mono text-sm">
          <div className="w-2 h-2 bg-blue-500 rounded-full animate-ping" />
          CHARGEMENT...
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-[#0A0A0B] text-slate-200 font-sans selection:bg-blue-500/30 p-4 lg:p-8">
      <style jsx global>{`
        @import url("https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap");
        .custom-scrollbar::-webkit-scrollbar {
          width: 4px;
          height: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
          background: rgba(255, 255, 255, 0.1);
          border-radius: 10px;
        }
        .glass-panel {
          background: rgba(22, 24, 29, 0.7);
          backdrop-filter: blur(12px);
          border: 1px solid rgba(255, 255, 255, 0.05);
        }
      `}</style>

      <div className="max-w-7xl mx-auto space-y-8">
        {/* HEADER & KPI */}
        <header className="space-y-6">
          <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
            <div>
              <h1 className="text-2xl font-black text-white tracking-tight flex items-center gap-3">
                <Briefcase className="h-6 w-6 text-blue-500" />
                SUIVI CANDIDATURES
              </h1>
              <p className="text-xs text-slate-500 font-mono mt-1 uppercase tracking-widest">
                Dashboard // {user?.email || "—"}
              </p>
            </div>

            <button
              type="button"
              onClick={openCreate}
              className="px-6 py-2.5 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-xl shadow-lg shadow-blue-900/20 flex items-center gap-2 transition-all hover:scale-105"
            >
              <Plus className="h-4 w-4" /> Nouvelle Candidature
            </button>
          </div>

          <div className="grid grid-cols-2 lg:grid-cols-4 gap-4">
            <KpiCard title="Total Suivi" value={stats.total} icon={FileText} color="text-slate-400" />
            <KpiCard title="En Cours" value={stats.active} icon={Zap} color="text-blue-400" />
            <KpiCard title="Entretiens" value={stats.interview} icon={Calendar} color="text-amber-400" />
            <KpiCard title="Offres" value={stats.offer} icon={CheckCircle2} color="text-emerald-400" />
          </div>
        </header>

        {/* MAIN LAYOUT */}
        <div className="grid lg:grid-cols-[1fr,340px] gap-8">
          {/* LISTE */}
          <section className="flex flex-col min-h-[600px]">
            {/* TOOLBAR */}
            <div className="sticky top-4 z-20 glass-panel p-2 rounded-2xl flex flex-col sm:flex-row gap-3 items-center justify-between shadow-xl mb-4">
              <div className="flex items-center bg-slate-950/50 border border-white/10 rounded-xl px-3 py-2.5 w-full sm:w-auto flex-1 max-w-md">
                <Search className="h-4 w-4 text-slate-500 mr-2" />
                <input
                  className="bg-transparent border-none outline-none text-sm text-white w-full placeholder:text-slate-600"
                  placeholder="Rechercher une entreprise, un poste..."
                  value={search}
                  onChange={(e) => setSearch(e.target.value)}
                />
              </div>

              <div className="flex gap-1 overflow-x-auto pb-1 sm:pb-0 w-full sm:w-auto custom-scrollbar">
                {(["all", "todo", "sent", "interview", "offer", "rejected"] as const).map((s) => (
                  <button
                    key={s}
                    type="button"
                    onClick={() => setStatusFilter(s)}
                    className={`px-3 py-2 rounded-lg text-[10px] font-bold uppercase tracking-wider transition-colors whitespace-nowrap ${
                      statusFilter === s
                        ? "bg-white text-slate-900 shadow-md"
                        : "text-slate-500 hover:bg-white/5 hover:text-slate-300"
                    }`}
                  >
                    {s === "all" ? "Tout" : STATUS_CONFIG[s].label}
                  </button>
                ))}
              </div>
            </div>

            {/* LIST */}
            <div className="flex-1 space-y-3">
              <AnimatePresence mode="popLayout">
                {paginatedApps.map((app) => (
                  <motion.div
                    key={app.id}
                    layout
                    initial={{ opacity: 0, scale: 0.98 }}
                    animate={{ opacity: 1, scale: 1 }}
                    exit={{ opacity: 0, scale: 0.98 }}
                    onClick={() => openEdit(app)}
                    className="group relative bg-[#16181D] border border-white/5 hover:border-blue-500/30 rounded-2xl p-5 transition-all cursor-pointer hover:shadow-lg hover:shadow-black/50"
                    role="button"
                    tabIndex={0}
                    onKeyDown={(e) => {
                      if (e.key === "Enter" || e.key === " ") openEdit(app);
                    }}
                  >
                    <div className="flex justify-between items-start mb-3 gap-4">
                      <div className="min-w-0">
                        <h3 className="font-bold text-white text-lg truncate">{app.jobTitle}</h3>
                        <p className="text-sm text-blue-400 font-medium flex flex-wrap items-center gap-2 mt-0.5">
                          <span className="truncate">{app.company}</span>
                          {app.location ? (
                            <span className="text-slate-600 text-xs font-normal flex items-center gap-1">
                              • <MapPin className="h-3 w-3" /> {app.location}
                            </span>
                          ) : null}
                        </p>
                      </div>
                      <StatusBadge status={app.status} />
                    </div>

                    <div className="flex items-center gap-4 text-xs text-slate-500 font-mono flex-wrap">
                      <span>AJOUTÉ LE {formatDate(app.createdAt)}</span>
                      {app.interviewAt ? (
                        <span className="text-amber-400 flex items-center gap-1.5 bg-amber-500/10 px-2 py-0.5 rounded-md border border-amber-500/20">
                          <Calendar className="h-3 w-3" />
                          {formatDateTime(app.interviewAt)}
                        </span>
                      ) : null}
                    </div>

                    <div className="absolute right-4 bottom-4 opacity-0 group-hover:opacity-100 transition-opacity flex gap-2">
                      {app.jobLink ? (
                        <a
                          href={app.jobLink}
                          target="_blank"
                          rel="noreferrer"
                          onClick={(e) => e.stopPropagation()}
                          className="p-2 hover:bg-white/10 rounded-lg text-slate-400 hover:text-white transition-colors border border-transparent hover:border-white/10"
                          aria-label="Ouvrir l'offre"
                        >
                          <ExternalLink className="h-4 w-4" />
                        </a>
                      ) : null}

                      <button
                        type="button"
                        onClick={(e) => {
                          e.stopPropagation();
                          openEdit(app);
                        }}
                        className="p-2 hover:bg-white/10 rounded-lg text-slate-400 hover:text-blue-400 transition-colors border border-transparent hover:border-white/10"
                        aria-label="Modifier"
                      >
                        <Edit3 className="h-4 w-4" />
                      </button>
                    </div>

                    {/* IA Badges */}
                    <div className="absolute top-4 right-20 sm:top-auto sm:bottom-4 sm:right-4 flex gap-1.5 justify-end pointer-events-none">
                      {app.hasCv ? (
                        <span className="text-[9px] font-bold px-1.5 py-0.5 rounded bg-blue-500/10 text-blue-400 border border-blue-500/20">
                          CV
                        </span>
                      ) : null}
                      {app.hasLm ? (
                        <span className="text-[9px] font-bold px-1.5 py-0.5 rounded bg-purple-500/10 text-purple-400 border border-purple-500/20">
                          LM
                        </span>
                      ) : null}
                      {app.hasPitch ? (
                        <span className="text-[9px] font-bold px-1.5 py-0.5 rounded bg-emerald-500/10 text-emerald-400 border border-emerald-500/20">
                          PITCH
                        </span>
                      ) : null}
                    </div>
                  </motion.div>
                ))}
              </AnimatePresence>

              {filteredApps.length === 0 ? (
                <div className="py-20 text-center border-2 border-dashed border-white/5 rounded-2xl flex flex-col items-center gap-4">
                  <div className="p-4 rounded-full bg-white/5">
                    <Filter className="w-6 h-6 text-slate-500" />
                  </div>
                  <p className="text-sm text-slate-500 font-mono uppercase">Aucune candidature trouvée</p>
                </div>
              ) : null}
            </div>

            <Pagination />
          </section>

          {/* SIDEBAR */}
          <aside className="space-y-6">
            <div className="glass-panel rounded-3xl p-6 sticky top-24">
              <h3 className="text-xs font-bold text-white uppercase tracking-widest flex items-center gap-2 mb-6">
                <Calendar className="h-4 w-4 text-amber-500" />
                Agenda Entretiens
              </h3>

              <div className="space-y-3">
                {nextInterviews.length > 0 ? (
                  nextInterviews.map((app) => (
                    <div
                      key={app.id}
                      onClick={() => openEdit(app)}
                      className="p-3.5 rounded-xl bg-white/5 border border-white/5 hover:border-amber-500/30 hover:bg-white/10 cursor-pointer transition-all group"
                      role="button"
                      tabIndex={0}
                      onKeyDown={(e) => {
                        if (e.key === "Enter" || e.key === " ") openEdit(app);
                      }}
                    >
                      <div className="flex justify-between items-start mb-1.5">
                        <span className="text-amber-400 font-mono text-xs font-bold bg-amber-500/10 px-1.5 py-0.5 rounded">
                          {app.interviewAt ? formatDateTime(app.interviewAt).split(" ")[0] : ""}{" "}
                          <span className="text-amber-200/60 ml-1">
                            {app.interviewAt ? formatDateTime(app.interviewAt).split(" ")[1] : ""}
                          </span>
                        </span>
                        <ChevronRight className="h-3 w-3 text-slate-600 group-hover:text-white" />
                      </div>
                      <p className="font-bold text-sm text-white line-clamp-1">{app.company}</p>
                      <p className="text-xs text-slate-500 line-clamp-1">{app.jobTitle}</p>
                    </div>
                  ))
                ) : (
                  <div className="text-center py-6">
                    <p className="text-xs text-slate-600 italic">Aucun entretien à venir.</p>
                    <p className="text-[10px] text-slate-700 mt-1">C'est calme... trop calme.</p>
                  </div>
                )}
              </div>

              <div className="mt-8 pt-6 border-t border-white/5">
                <h3 className="text-xs font-bold text-slate-500 uppercase tracking-widest mb-4">Statistiques</h3>

                <div className="space-y-4">
                  <div>
                    <div className="flex justify-between text-xs mb-1.5">
                      <span className="text-slate-400">Entretiens / Candidatures</span>
                      <span className="text-white font-mono">
                        {stats.interview}/{stats.total}
                      </span>
                    </div>
                    <div className="w-full bg-white/5 h-1.5 rounded-full overflow-hidden">
                      <div
                        className="bg-amber-500 h-full"
                        style={{ width: `${(stats.interview / (stats.total || 1)) * 100}%` }}
                      />
                    </div>
                  </div>

                  <div>
                    <div className="flex justify-between text-xs mb-1.5">
                      <span className="text-slate-400">CV Optimisés IA</span>
                      <span className="text-white font-mono">{apps.filter((a) => a.hasCv).length}</span>
                    </div>
                    <div className="w-full bg-white/5 h-1.5 rounded-full overflow-hidden">
                      <div
                        className="bg-blue-500 h-full"
                        style={{ width: `${(apps.filter((a) => a.hasCv).length / (apps.length || 1)) * 100}%` }}
                      />
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </aside>
        </div>
      </div>

      {/* SLIDE-OVER EDIT PANEL */}
      <AnimatePresence>
        {isPanelOpen ? (
          <>
            <motion.div
              initial={{ opacity: 0 }}
              animate={{ opacity: 1 }}
              exit={{ opacity: 0 }}
              onClick={closePanel}
              className="fixed inset-0 bg-black/70 backdrop-blur-sm z-40"
            />

            <motion.div
              initial={{ x: "100%" }}
              animate={{ x: 0 }}
              exit={{ x: "100%" }}
              transition={{ type: "spring", damping: 30, stiffness: 300 }}
              className="fixed right-0 top-0 h-full w-full max-w-lg bg-[#0F1115] border-l border-white/10 shadow-2xl z-50 flex flex-col"
              role="dialog"
              aria-modal="true"
            >
              <div className="p-6 border-b border-white/5 flex items-center justify-between bg-[#16181D]">
                <h2 className="text-lg font-bold text-white flex items-center gap-2">
                  {draft.id ? <Edit3 className="w-5 h-5 text-blue-500" /> : <Plus className="w-5 h-5 text-emerald-500" />}
                  {draft.id ? "Modifier Candidature" : "Nouvelle Candidature"}
                </h2>

                <button
                  type="button"
                  onClick={closePanel}
                  className="p-2 hover:bg-white/10 rounded-full transition-colors"
                  aria-label="Fermer"
                >
                  <X className="h-5 w-5 text-slate-400" />
                </button>
              </div>

              <form onSubmit={handleSave} className="flex-1 overflow-y-auto p-6 space-y-8 custom-scrollbar">
                {/* STATUS SELECTOR */}
                <div className="space-y-3">
                  <label className="text-[10px] font-bold text-slate-500 uppercase tracking-widest ml-1">Statut Actuel</label>

                  <div className="grid grid-cols-5 gap-2 p-1.5 bg-[#0A0A0B] rounded-2xl border border-white/5">
                    {(Object.keys(STATUS_CONFIG) as ApplicationStatus[]).map((s) => {
                      const isActive = draft.status === s;
                      const conf = STATUS_CONFIG[s];
                      const Icon = conf.icon;

                      return (
                        <button
                          key={s}
                          type="button"
                          onClick={() => setDraft((prev) => ({ ...prev, status: s }))}
                          className={`flex flex-col items-center justify-center gap-1.5 py-3 rounded-xl transition-all relative ${
                            isActive ? "bg-white/10 text-white shadow-md" : "text-slate-600 hover:text-slate-300 hover:bg-white/5"
                          }`}
                          title={conf.label}
                        >
                          <Icon className={`h-5 w-5 ${isActive ? conf.color.split(" ")[0] : "currentColor"}`} />
                          {isActive ? (
                            <div className={`absolute -bottom-1 w-1 h-1 rounded-full ${conf.color.split(" ")[0].replace("text", "bg")}`} />
                          ) : null}
                        </button>
                      );
                    })}
                  </div>

                  <div className="text-center">
                    {draft.status ? (
                      <span
                        className={`text-xs font-bold px-3 py-1 rounded-full border ${STATUS_CONFIG[draft.status].color} ${STATUS_CONFIG[draft.status].bg} ${STATUS_CONFIG[draft.status].border}`}
                      >
                        {STATUS_CONFIG[draft.status].label}
                      </span>
                    ) : null}
                  </div>
                </div>

                <div className="space-y-5">
                  <InputGroup label="Entreprise">
                    <input
                      required
                      className="cyber-input"
                      value={draft.company || ""}
                      onChange={(e) => setDraft((p) => ({ ...p, company: e.target.value }))}
                      placeholder="Ex: Google"
                    />
                  </InputGroup>

                  <InputGroup label="Poste">
                    <input
                      required
                      className="cyber-input"
                      value={draft.jobTitle || ""}
                      onChange={(e) => setDraft((p) => ({ ...p, jobTitle: e.target.value }))}
                      placeholder="Ex: Frontend Dev"
                    />
                  </InputGroup>

                  <div className="grid grid-cols-2 gap-4">
                    <InputGroup label="Lieu">
                      <input
                        className="cyber-input"
                        value={draft.location || ""}
                        onChange={(e) => setDraft((p) => ({ ...p, location: e.target.value }))}
                        placeholder="Paris"
                      />
                    </InputGroup>
                    <InputGroup label="Contrat">
                      <input
                        className="cyber-input"
                        value={draft.contract || ""}
                        onChange={(e) => setDraft((p) => ({ ...p, contract: e.target.value }))}
                        placeholder="CDI"
                      />
                    </InputGroup>
                  </div>

                  <InputGroup label="Lien de l'offre">
                    <div className="relative">
                      <Globe className="absolute left-3 top-3 h-4 w-4 text-slate-500" />
                      <input
                        className="cyber-input pl-10"
                        value={draft.jobLink || ""}
                        onChange={(e) => setDraft((p) => ({ ...p, jobLink: e.target.value }))}
                        placeholder="https://..."
                      />
                    </div>
                  </InputGroup>

                  {/* DATE ENTRETIEN */}
                  <div className="p-5 rounded-2xl bg-amber-500/5 border border-amber-500/10 space-y-2">
                    <label className="text-[10px] font-bold text-amber-500 uppercase flex items-center gap-2">
                      <Calendar className="h-3.5 w-3.5" /> Date d'entretien
                    </label>
                    <input
                      type="datetime-local"
                      className="cyber-input bg-black/20 border-amber-500/20 text-amber-100 focus:border-amber-500"
                      value={draft.interviewAt || ""}
                      onChange={(e) => setDraft((p) => ({ ...p, interviewAt: e.target.value }))}
                    />
                  </div>

                  <InputGroup label="Notes & Rappels">
                    <textarea
                      rows={5}
                      className="cyber-input resize-none leading-relaxed"
                      value={draft.notes || ""}
                      onChange={(e) => setDraft((p) => ({ ...p, notes: e.target.value }))}
                      placeholder="Contact RH, questions à poser, étapes suivantes..."
                    />
                  </InputGroup>

                  {/* IA TOGGLES */}
                  <div className="p-4 rounded-2xl bg-white/5 border border-white/5">
                    <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-3">Documents générés</p>
                    <div className="flex gap-4">
                      {([
                        ["hasCv", "CV"],
                        ["hasLm", "Lettre"],
                        ["hasPitch", "Pitch"],
                      ] as const).map(([key, label]) => (
                        <label key={key} className="flex items-center gap-2 cursor-pointer group select-none">
                          <div
                            className={`w-5 h-5 rounded-md border flex items-center justify-center transition-all ${
                              (draft as any)[key]
                                ? "bg-blue-600 border-blue-600"
                                : "border-slate-600 bg-transparent group-hover:border-slate-400"
                            }`}
                          >
                            {(draft as any)[key] ? <CheckCircle2 className="h-3.5 w-3.5 text-white" /> : null}
                          </div>
                          <input
                            type="checkbox"
                            className="hidden"
                            checked={!!(draft as any)[key]}
                            onChange={(e) => setDraft((p) => ({ ...p, [key]: e.target.checked }))}
                          />
                          <span className={`text-xs font-bold ${(draft as any)[key] ? "text-white" : "text-slate-400"} group-hover:text-white`}>
                            {label}
                          </span>
                        </label>
                      ))}
                    </div>
                  </div>
                </div>
              </form>

              <div className="p-6 border-t border-white/10 bg-[#16181D] flex gap-3">
                {draft.id ? (
                  <button
                    type="button"
                    onClick={() => handleDelete(draft.id!)}
                    className="p-3.5 rounded-xl bg-red-500/10 text-red-500 border border-red-500/20 hover:bg-red-500/20 transition-colors"
                    aria-label="Supprimer"
                  >
                    <Trash2 className="h-5 w-5" />
                  </button>
                ) : null}

                <button
                  type="submit"
                  disabled={isSaving}
                  className="flex-1 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-xl py-3.5 shadow-lg shadow-blue-900/20 transition-all disabled:opacity-50 flex items-center justify-center gap-2"
                >
                  {isSaving ? <Loader2 className="w-5 h-5 animate-spin" /> : <Send className="w-5 h-5" />}
                  {isSaving ? "Sauvegarde..." : "Enregistrer"}
                </button>
              </div>
            </motion.div>
          </>
        ) : null}
      </AnimatePresence>

      <style jsx>{`
        .cyber-input {
          width: 100%;
          background: rgba(15, 23, 42, 0.6);
          border: 1px solid rgba(255, 255, 255, 0.1);
          border-radius: 0.75rem;
          padding: 0.75rem 1rem;
          font-size: 0.875rem;
          color: white;
          outline: none;
          transition: all 0.2s;
        }
        .cyber-input:focus {
          border-color: #3b82f6;
          background: rgba(15, 23, 42, 0.9);
          box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
        }
      `}</style>
    </div>
  );
}
````

## File: app/assistance-candidature/page.tsx
````typescript
export default function AssistanceCandidaturePage() {
  // ...
}
````

## File: app/auth/verify-email/page.tsx
````typescript
"use client";

import { useEffect, useState, Suspense } from "react";
import { useSearchParams, useRouter } from "next/navigation";
import Link from "next/link";
import { applyActionCode, sendEmailVerification } from "firebase/auth";
import { auth } from "@/lib/firebase";
import { useAuth } from "@/context/AuthContext";

type Status = "idle" | "processing" | "success" | "error";

function VerifyEmailPageInner() {
  const searchParams = useSearchParams();
  const router = useRouter();
  const { user, logout } = useAuth();

  const [status, setStatus] = useState<Status>("idle");
  const [message, setMessage] = useState<string | null>(null);

  const oobCode = searchParams.get("oobCode");

  // Cas 1 : on arrive depuis le lien de vérification (oobCode dans l'URL)
  useEffect(() => {
    const verify = async () => {
      if (!oobCode) return;

      setStatus("processing");
      setMessage("Vérification de ton email en cours...");

      try {
        await applyActionCode(auth, oobCode);

        if (auth.currentUser) {
          await auth.currentUser.reload();
        }

        setStatus("success");
        setMessage(
          "Email vérifié avec succès. Tu peux maintenant accéder à ton espace candidat."
        );
      } catch (err) {
        console.error("Erreur de vérification d’email :", err);
        setStatus("error");
        setMessage(
          "Le lien de vérification est invalide ou expiré. Demande un nouveau mail de vérification."
        );
      }
    };

    verify();
  }, [oobCode]);

  const handleResend = async () => {
    if (!user) {
      setStatus("error");
      setMessage(
        "Tu dois d’abord te connecter pour renvoyer l’email de vérification."
      );
      return;
    }

    try {
      setStatus("processing");
      setMessage("Envoi d’un nouvel email de vérification...");
      await sendEmailVerification(user);
      setStatus("success");
      setMessage(
        "Email de vérification renvoyé. Vérifie ta boîte de réception."
      );
    } catch (err) {
      console.error("Erreur renvoi email :", err);
      setStatus("error");
      setMessage(
        "Impossible de renvoyer l’email pour le moment. Réessaie plus tard."
      );
    }
  };

  // 🔁 Bouton pour accéder à l'espace candidat
  const handleGoToApp = async () => {
    if (!user) {
      setStatus("error");
      setMessage(
        "Tu dois être connecté pour accéder à l’espace candidat. Connecte-toi puis reviens ici."
      );
      return;
    }

    try {
      setStatus("processing");
      setMessage("Vérification de l’état de ton email...");

      // on rafraîchit le user pour avoir le bon état de emailVerified
      if (user.reload) {
        await user.reload();
      } else if (auth.currentUser) {
        await auth.currentUser.reload();
      }

      const refreshedUser = auth.currentUser ?? user;

      if (!refreshedUser.emailVerified) {
        setStatus("error");
        setMessage(
          "Ton email n’est toujours pas vérifié. Clique sur le lien dans l’email reçu, puis réessaie."
        );
        return;
      }

      setStatus("idle");
      setMessage(null);
      router.push("/app");
    } catch (err) {
      console.error("Erreur lors du check emailVerified :", err);
      setStatus("error");
      setMessage(
        "Impossible de vérifier l’état de ton email pour le moment. Réessaie dans quelques instants."
      );
    }
  };

  // 🔌 Bouton de déconnexion → redirection vers /login
  const handleLogout = async () => {
    try {
      await logout();
      router.push("/login");
    } catch (err) {
      console.error("Erreur déconnexion :", err);
    }
  };

  return (
    <div className="min-h-screen bg-[var(--page)] text-[var(--text)]">
      {/* fond léger comme les autres pages */}
      <div className="pointer-events-none fixed inset-0 -z-10 bg-[radial-gradient(circle_at_top,_rgba(56,189,248,0.16),_transparent_55%),radial-gradient(circle_at_bottom,_rgba(94,234,212,0.12),_transparent_55%)]" />

      <div className="mx-auto flex min-h-screen max-w-6xl flex-col px-3 sm:px-4">
        {/* NAVBAR HAUT DE PAGE */}
        <header className="sticky top-0 z-20 flex items-center justify-between gap-3 border-b border-[var(--border)]/80 bg-[var(--page)]/90 px-0 py-3 backdrop-blur">
          {/* Logo + retour accueil */}
          <Link href="/" className="flex items-center gap-2">
            <div className="flex h-9 w-9 items-center justify-center rounded-2xl border border-[var(--brand)]/40 bg-[var(--brand)]/10 text-lg">
              ⚡
            </div>
            <div className="flex flex-col">
              <span className="text-xs font-semibold">
                Assistant Candidature IA
              </span>
              <span className="text-[10px] text-[var(--muted)]">
                Retour à l&apos;accueil
              </span>
            </div>
          </Link>

          {/* Liens Connexion / Inscription / Déconnexion */}
          <div className="flex items-center gap-2 text-[11px]">
            {!user && (
              <>
                <Link
                  href="/login"
                  className="rounded-full border border-[var(--border)] bg-[var(--bg-soft)] px-3 py-1.5 text-[var(--muted)] transition-colors hover:border-[var(--brand)]/60 hover:text-[var(--ink)]"
                >
                  Se connecter
                </Link>
                <Link
                  href="/signup"
                  className="rounded-full border border-[var(--brand)]/70 bg-[var(--brand)]/20 px-3 py-1.5 text-[var(--ink)] transition-colors hover:bg-[var(--brand)]/30"
                >
                  S&apos;inscrire
                </Link>
              </>
            )}

            {user && (
              <button
                type="button"
                onClick={handleLogout}
                className="rounded-full border border-[var(--border)] bg-[var(--bg-soft)] px-3 py-1.5 text-[var(--muted)] transition-colors hover:border-red-500/70 hover:text-red-200"
              >
                Se déconnecter
              </button>
            )}
          </div>
        </header>

        {/* CONTENU PRINCIPAL */}
        <main className="flex flex-1 items-center justify-center py-10">
          <div className="relative w-full max-w-md">
            {/* halo derrière la card */}
            <div className="pointer-events-none absolute -inset-6 -z-10 rounded-[32px] bg-[radial-gradient(circle_at_top,_rgba(56,189,248,0.25),_transparent_55%)] opacity-80" />

            <div className="glass space-y-5 rounded-2xl border border-[var(--border)]/80 bg-[var(--bg)]/85 px-6 py-6 shadow-[0_22px_50px_rgba(0,0,0,0.55)]">
              {/* badge étape */}
              <div className="inline-flex items-center gap-2 rounded-full border border-[var(--border)]/80 bg-[var(--bg-soft)] px-3 py-1 text-[10px] text-[var(--muted)]">
                <span className="inline-flex h-4 w-4 items-center justify-center rounded-full bg-[var(--brand)]/30 text-[9px]">
                  2
                </span>
                <span>Étape 2 · Validation du compte</span>
              </div>

              <div className="flex items-start gap-3">
                <div className="flex h-9 w-9 items-center justify-center rounded-2xl border border-[var(--brand)]/40 bg-[var(--brand)]/12 text-lg">
                  ✉️
                </div>
                <div className="space-y-1">
                  <h1 className="text-sm font-semibold">
                    Vérifie ton adresse email
                  </h1>
                  <p className="text-[11px] text-[var(--muted)] leading-relaxed">
                    Pour sécuriser ton espace candidat et activer les fonctionnalités
                    IA, nous devons vérifier ton adresse email.
                  </p>
                </div>
              </div>

              {message && (
                <div
                  className={[
                    "text-[12px] rounded-lg px-3 py-2 border leading-relaxed",
                    status === "error"
                      ? "border-red-500/60 bg-red-500/5 text-red-200"
                      : status === "success"
                      ? "border-emerald-500/60 bg-emerald-500/5 text-emerald-200"
                      : "border-[var(--border)]/80 bg-[var(--bg-soft)] text-[var(--muted)]",
                  ].join(" ")}
                >
                  {message}
                </div>
              )}

              {!oobCode && (
                <div className="space-y-2">
                  <p className="text-[11px] text-[var(--muted)] leading-relaxed">
                    Nous t’avons envoyé un lien de vérification par email. Clique sur
                    le bouton dans l’email pour valider ton compte, puis reviens sur
                    cette page.
                  </p>
                  <ul className="space-y-1 text-[11px] text-[var(--muted)]">
                    <li>• Vérifie aussi les spams / courriers indésirables</li>
                    <li>• Le lien est valable pendant un temps limité</li>
                  </ul>
                </div>
              )}

              <div className="flex flex-col gap-2 text-[12px]">
                <button
                  type="button"
                  onClick={handleResend}
                  className="w-full rounded-full border border-[var(--border)] bg-[var(--bg-soft)] px-3 py-2 text-[var(--muted)] transition-colors hover:border-[var(--brand)]/60 hover:text-[var(--ink)] disabled:opacity-60 disabled:cursor-not-allowed"
                  disabled={status === "processing"}
                >
                  Renvoyer l’email de vérification
                </button>

                <button
                  type="button"
                  onClick={handleGoToApp}
                  className="w-full rounded-full border border-[var(--brand)]/70 bg-[var(--brand)]/20 px-3 py-2 text-[var(--ink)] transition-colors hover:bg-[var(--brand)]/30"
                >
                  Accéder à l&apos;espace candidat
                </button>
              </div>

              <p className="text-center text-[10px] text-[var(--muted)]">
                Si tu ne vois pas l’email, pense à vérifier les spams ou l’onglet
                &quot;Promotions&quot; de ta boîte de réception.
              </p>
            </div>
          </div>
        </main>
      </div>
    </div>
  );
}

/**
 * Wrapper avec Suspense → obligatoire quand on utilise useSearchParams
 * dans une page client pour que le build Next.js ne plante pas.
 */
export default function VerifyEmailPage() {
  return (
    <Suspense
      fallback={
        <div className="min-h-screen flex items-center justify-center text-sm text-slate-400">
          Chargement…
        </div>
      }
    >
      <VerifyEmailPageInner />
    </Suspense>
  );
}
````

## File: app/debug/polar/page.tsx
````typescript
// app/debug/polar/page.tsx
"use client";

import { useEffect, useState } from "react";
import type { CreditPackId } from "@/lib/polar";
import { auth, db } from "@/lib/firebase";
import { onAuthStateChanged } from "firebase/auth";
import { doc, getDoc } from "firebase/firestore";

type UserProfile = {
  id: string;
  email: string;
  displayName?: string;
  credits?: number;
};

type PackConfig = {
  id: CreditPackId;
  title: string;
  subtitle: string;
  credits: number;
  priceText: string;
  highlight?: boolean;
};

// ✅ Packs alignés avec tes produits Polar : 20 / 50 / 100
const PACKS: PackConfig[] = [
  {
    id: "20",
    title: "Pack 20 crédits",
    subtitle: "≈ 20 crédits",
    credits: 20,
    priceText: "≈ 10 $ (config Polar)",
  },
  {
    id: "50",
    title: "Pack 50 crédits",
    subtitle: "≈ 50 crédits",
    credits: 50,
    priceText: "≈ 25 $ (config Polar)",
    highlight: true,
  },
  {
    id: "100",
    title: "Pack 100 crédits",
    subtitle: "≈ 100 crédits",
    credits: 100,
    priceText: "≈ 40 $ (config Polar)",
  },
];

export default function PolarDebugPage() {
  const [firebaseUser, setFirebaseUser] = useState<any | null>(null);
  const [profile, setProfile] = useState<UserProfile | null>(null);
  const [loadingUser, setLoadingUser] = useState(true);

  const [loadingPack, setLoadingPack] = useState<CreditPackId | null>(null);
  const [message, setMessage] = useState<string | null>(null);
  const [rawResponse, setRawResponse] = useState<any>(null);
  const [showDetails, setShowDetails] = useState(false);
  const [lastPack, setLastPack] = useState<CreditPackId | null>(null);

  // 🔐 On récupère l'utilisateur Firebase + son doc Firestore ("users/{uid}")
  useEffect(() => {
    const unsubscribe = onAuthStateChanged(auth, async (user) => {
      setFirebaseUser(user);
      if (!user) {
        setProfile(null);
        setLoadingUser(false);
        return;
      }

      try {
        const ref = doc(db, "users", user.uid);
        const snap = await getDoc(ref);
        const data = snap.exists() ? (snap.data() as any) : {};

        const credits =
          typeof data.credits === "number" ? (data.credits as number) : undefined;

        const displayName =
          data.displayName ??
          data.name ??
          data.fullName ??
          user.displayName ??
          undefined;

        const email = user.email ?? data.email ?? "";

        setProfile({
          id: user.uid,
          email,
          displayName,
          credits,
        });
      } catch (err) {
        console.error("[Debug Polar] Erreur chargement profil Firestore :", err);
      } finally {
        setLoadingUser(false);
      }
    });

    return () => unsubscribe();
  }, []);

  const handleBuy = async (packId: CreditPackId) => {
    try {
      setMessage(null);
      setRawResponse(null);
      setLoadingPack(packId);
      setLastPack(packId);

      if (!profile?.id || !profile.email) {
        setMessage(
          "❌ Impossible de lancer le paiement : utilisateur non connecté ou email manquant."
        );
        return;
      }

      const res = await fetch("/api/polar/checkout", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          packId,
          userId: profile.id,
          email: profile.email,
        }),
      });

      const data = await res.json();
      console.error("Réponse /api/polar/checkout :", data);
      setRawResponse(data);

      if (!data.ok || !data.url) {
        const msg =
          data.error ||
          data.detail ||
          "❌ Erreur lors de la création du paiement (réponse API).";
        setMessage(msg);
        return;
      }

      // Redirection vers la page de paiement Polar
      window.location.href = data.url;
    } catch (error) {
      console.error("Erreur handleBuy:", error);
      setMessage("❌ Une erreur est survenue côté client.");
    } finally {
      setLoadingPack(null);
    }
  };

  const isLoading = (pack: CreditPackId) => loadingPack === pack;
  const isAuthenticated = !!firebaseUser && !!profile;

  return (
    <main
      style={{
        minHeight: "100vh",
        margin: 0,
        padding: "2rem",
        fontFamily: "system-ui, -apple-system, BlinkMacSystemFont, sans-serif",
        background:
          "radial-gradient(circle at top, #111827 0, #020617 45%, #000 100%)",
        color: "#e5e7eb",
        display: "flex",
        justifyContent: "center",
      }}
    >
      <div style={{ width: "100%", maxWidth: "960px" }}>
        {/* Header */}
        <header
          style={{
            marginBottom: "1.5rem",
            display: "flex",
            justifyContent: "space-between",
            gap: "1rem",
            alignItems: "flex-start",
          }}
        >
          <div>
            <h1
              style={{
                fontSize: "1.8rem",
                marginBottom: "0.3rem",
                color: "#f9fafb",
              }}
            >
              Mode debug Polar
            </h1>
            <p style={{ margin: 0, color: "#9ca3af", maxWidth: "32rem" }}>
              Cette page te permet de tester les paiements Polar et le crédit
              de l’utilisateur dans Firestore, sans toucher à ton UI principale.
            </p>
          </div>

          <div
            style={{
              padding: "0.75rem 1rem",
              borderRadius: "0.75rem",
              backgroundColor: "rgba(15, 23, 42, 0.85)",
              border: "1px solid rgba(148, 163, 184, 0.4)",
              fontSize: "0.8rem",
              lineHeight: 1.35,
              minWidth: "220px",
            }}
          >
            <div style={{ marginBottom: "0.25rem", fontWeight: 600 }}>
              {loadingUser
                ? "Chargement utilisateur…"
                : isAuthenticated
                ? "Utilisateur connecté"
                : "Aucun utilisateur connecté"}
            </div>

            {isAuthenticated && profile && (
              <>
                {profile.displayName && (
                  <div>
                    <span style={{ color: "#9ca3af" }}>Nom :</span>{" "}
                    <strong>{profile.displayName}</strong>
                  </div>
                )}
                <div>
                  <span style={{ color: "#9ca3af" }}>Email :</span>{" "}
                  <strong>{profile.email}</strong>
                </div>
                <div>
                  <span style={{ color: "#9ca3af" }}>ID :</span>{" "}
                  <code
                    style={{
                      backgroundColor: "rgba(15,23,42,0.9)",
                      padding: "0.1rem 0.3rem",
                      borderRadius: "0.25rem",
                    }}
                  >
                    {profile.id}
                  </code>
                </div>
                {typeof profile.credits === "number" && (
                  <div style={{ marginTop: "0.25rem" }}>
                    <span style={{ color: "#9ca3af" }}>Crédits :</span>{" "}
                    <strong>{profile.credits}</strong>
                  </div>
                )}
              </>
            )}

            {!loadingUser && !isAuthenticated && (
              <div style={{ color: "#f97316", marginTop: "0.3rem" }}>
                Connecte-toi dans l’app pour tester les paiements.
              </div>
            )}
          </div>
        </header>

        {/* Boutons de contrôle */}
        <div
          style={{
            display: "flex",
            gap: "0.5rem",
            marginBottom: "1.5rem",
            flexWrap: "wrap",
          }}
        >
          <button
            type="button"
            onClick={() => setShowDetails((v) => !v)}
            style={{
              padding: "0.5rem 0.9rem",
              borderRadius: "999px",
              border: "1px solid rgba(148, 163, 184, 0.6)",
              backgroundColor: showDetails
                ? "rgba(34, 197, 94, 0.15)"
                : "rgba(15,23,42,0.9)",
              color: showDetails ? "#bbf7d0" : "#e5e7eb",
              fontSize: "0.8rem",
              cursor: "pointer",
            }}
          >
            {showDetails ? "Masquer les détails API" : "Afficher les détails API"}
          </button>

          {lastPack && (
            <button
              type="button"
              onClick={() => handleBuy(lastPack)}
              style={{
                padding: "0.5rem 0.9rem",
                borderRadius: "999px",
                border: "1px solid rgba(148, 163, 184, 0.4)",
                backgroundColor: "rgba(15,23,42,0.9)",
                color: "#e5e7eb",
                fontSize: "0.8rem",
                cursor: "pointer",
              }}
            >
              Relancer le pack testé ({lastPack})
            </button>
          )}

          <button
            type="button"
            onClick={() => {
              setMessage(null);
              setRawResponse(null);
            }}
            style={{
              padding: "0.5rem 0.9rem",
              borderRadius: "999px",
              border: "1px solid rgba(55, 65, 81, 0.9)",
              backgroundColor: "transparent",
              color: "#9ca3af",
              fontSize: "0.8rem",
              cursor: "pointer",
            }}
          >
            Effacer les messages
          </button>
        </div>

        {/* Cartes de packs */}
        <section
          style={{
            display: "grid",
            gridTemplateColumns: "repeat(auto-fit, minmax(240px, 1fr))",
            gap: "1rem",
            marginBottom: "1.5rem",
          }}
        >
          {PACKS.map((pack) => {
            const loading = isLoading(pack.id);
            const disabled = !isAuthenticated || loading;

            return (
              <article
                key={pack.id}
                style={{
                  position: "relative",
                  borderRadius: "1rem",
                  padding: "1.1rem 1.1rem 1rem",
                  background:
                    "linear-gradient(145deg, rgba(15,23,42,0.96), rgba(15,23,42,0.9))",
                  border: pack.highlight
                    ? "1px solid rgba(96, 165, 250, 0.9)"
                    : "1px solid rgba(31, 41, 55, 1)",
                  boxShadow: pack.highlight
                    ? "0 0 0 1px rgba(59,130,246,0.3), 0 18px 40px rgba(15,23,42,0.9)"
                    : "0 14px 35px rgba(15,23,42,0.85)",
                  overflow: "hidden",
                }}
              >
                {pack.highlight && (
                  <div
                    style={{
                      position: "absolute",
                      top: "0.7rem",
                      right: "0.9rem",
                      fontSize: "0.7rem",
                      padding: "0.15rem 0.5rem",
                      borderRadius: "999px",
                      background:
                        "linear-gradient(to right, #2563eb, #22c55e)",
                      color: "#f9fafb",
                      fontWeight: 600,
                      letterSpacing: "0.04em",
                      textTransform: "uppercase",
                    }}
                  >
                    Recommandé
                  </div>
                )}

                <div style={{ marginBottom: "0.75rem" }}>
                  <h2
                    style={{
                      fontSize: "1rem",
                      margin: 0,
                      color: "#f9fafb",
                    }}
                  >
                    {pack.title}
                  </h2>
                  <p
                    style={{
                      margin: "0.15rem 0 0",
                      fontSize: "0.8rem",
                      color: "#9ca3af",
                    }}
                  >
                    {pack.subtitle} • {pack.priceText}
                  </p>
                </div>

                <div
                  style={{
                    display: "flex",
                    alignItems: "baseline",
                    gap: "0.5rem",
                    marginBottom: "0.5rem",
                  }}
                >
                  <div style={{ fontSize: "2rem", fontWeight: 700 }}>
                    {pack.credits}
                  </div>
                  <div
                    style={{
                      fontSize: "0.8rem",
                      textTransform: "uppercase",
                      letterSpacing: "0.08em",
                      color: "#9ca3af",
                      fontWeight: 500,
                    }}
                  >
                    crédits
                  </div>
                </div>

                <p
                  style={{
                    margin: 0,
                    fontSize: "0.8rem",
                    color: "#9ca3af",
                    minHeight: "2.4rem",
                  }}
                >
                  Crédits utilisables pour les actions IA (analyse CV,
                  candidatures, etc.).
                </p>

                <div
                  style={{
                    marginTop: "0.9rem",
                    display: "flex",
                    justifyContent: "space-between",
                    alignItems: "center",
                    gap: "0.75rem",
                  }}
                >
                  <button
                    type="button"
                    onClick={() => handleBuy(pack.id)}
                    disabled={disabled}
                    style={{
                      flex: 1,
                      padding: "0.55rem 0.8rem",
                      borderRadius: "999px",
                      border: "none",
                      cursor: disabled ? "default" : "pointer",
                      background: pack.highlight
                        ? "linear-gradient(to right, #2563eb, #22c55e)"
                        : "linear-gradient(to right, #4b5563, #1f2937)",
                      color: "#f9fafb",
                      fontSize: "0.85rem",
                      fontWeight: 600,
                      textAlign: "center",
                      opacity: disabled ? 0.5 : 1,
                      transition:
                        "transform 0.12s ease, box-shadow 0.12s ease, opacity 0.12s ease",
                    }}
                  >
                    {loading
                      ? "Redirection..."
                      : isAuthenticated
                      ? "Tester ce pack"
                      : "Connexion requise"}
                  </button>

                  <div
                    style={{
                      fontSize: "0.7rem",
                      color: "#6b7280",
                      textAlign: "right",
                    }}
                  >
                    ID interne :{" "}
                    <code
                      style={{
                        backgroundColor: "rgba(15,23,42,0.9)",
                        padding: "0.15rem 0.35rem",
                        borderRadius: "999px",
                      }}
                    >
                      {pack.id}
                    </code>
                  </div>
                </div>
              </article>
            );
          })}
        </section>

        {/* Message d'erreur simple */}
        {message && (
          <div
            style={{
              marginBottom: "1rem",
              padding: "0.75rem 1rem",
              borderRadius: "0.75rem",
              backgroundColor: "rgba(127, 29, 29, 0.4)",
              border: "1px solid rgba(248, 113, 113, 0.7)",
              color: "#fecaca",
              fontSize: "0.85rem",
            }}
          >
            <strong style={{ display: "block", marginBottom: "0.15rem" }}>
              Erreur
            </strong>
            <span>{message}</span>
          </div>
        )}

        {/* Détails API (raw JSON) */}
        {showDetails && rawResponse && (
          <section>
            <h2
              style={{
                fontSize: "0.9rem",
                marginBottom: "0.4rem",
                color: "#e5e7eb",
              }}
            >
              Détails de la dernière réponse API
            </h2>
            <pre
              style={{
                margin: 0,
                padding: "1rem",
                background:
                  "linear-gradient(135deg, rgba(15,23,42,0.98), rgba(15,23,42,0.95))",
                borderRadius: "0.75rem",
                fontSize: "0.78rem",
                overflowX: "auto",
                border: "1px solid rgba(31, 41, 55, 1)",
              }}
            >
{JSON.stringify(rawResponse, null, 2)}
            </pre>
          </section>
        )}
      </div>
    </main>
  );
}
````

## File: app/forgot-password/page.tsx
````typescript
"use client";

import { useState, FormEvent } from "react";
import Script from "next/script";
import Link from "next/link";
import { sendPasswordResetEmail } from "firebase/auth";
import { auth } from "@/lib/firebase";
import { getRecaptchaToken, verifyRecaptcha } from "@/lib/recaptcha";

export default function ForgotPasswordPage() {
  const [email, setEmail] = useState("");
  const [submitting, setSubmitting] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [info, setInfo] = useState<string | null>(null);

  const handleSubmit = async (e: FormEvent) => {
    e.preventDefault();
    setError(null);
    setInfo(null);
    setSubmitting(true);

    try {
      // ✅ reCAPTCHA avant envoi reset email
      const action = "PASSWORD_RESET";
      let token = "";
      try {
        token = await getRecaptchaToken(action);
      } catch {
        setError(
          "Sécurité: impossible de valider reCAPTCHA (script bloqué ?). Désactive l'adblock et réessaie."
        );
        return;
      }

      const check = await verifyRecaptcha(token, action);
      if (!check.ok) {
        setError("Demande refusée par sécurité. Réessayez dans quelques secondes.");
        return;
      }

      await sendPasswordResetEmail(auth, email);
      setInfo(
        "Si un compte existe pour cette adresse email, un lien de réinitialisation vient de t'être envoyé. Pense à vérifier tes spams."
      );
    } catch (err: any) {
      console.error("Forgot password error:", err);
      const code = err?.code as string | undefined;

      if (code === "auth/invalid-email") {
        setError("Adresse email invalide.");
      } else {
        setError(
          "Impossible d'envoyer l'email de réinitialisation pour le moment. Réessaie dans quelques instants."
        );
      }
    } finally {
      setSubmitting(false);
    }
  };

  return (
    <div className="min-h-screen flex flex-col bg-gradient-to-b from-slate-950 via-slate-950/95 to-slate-900 text-slate-100">
      <Script
        src={`https://www.google.com/recaptcha/enterprise.js?render=${process.env.NEXT_PUBLIC_RECAPTCHA_SITE_KEY}`}
        strategy="afterInteractive"
      />

      <header className="border-b border-slate-800/80 bg-slate-950/80 backdrop-blur">
        <div className="max-w-5xl mx-auto px-4 sm:px-6 py-3 flex items-center justify-between gap-3">
          <div className="flex items-center gap-2">
            <div className="w-8 h-8 rounded-xl bg-gradient-to-br from-sky-500 to-sky-400 flex items-center justify-center text-[10px] font-semibold text-slate-950 shadow-lg shadow-sky-500/40">
              IA
            </div>
            <div className="flex flex-col">
              <span className="text-[10px] uppercase tracking-[0.18em] text-slate-400">
                Assistant candidatures
              </span>
              <span className="text-xs font-medium text-slate-100">Mot de passe oublié</span>
            </div>
          </div>
          <nav className="flex items-center gap-2 text-[11px]">
            <Link
              href="/"
              className="px-2 py-1 rounded-full border border-slate-700/80 hover:border-sky-500/80 text-slate-300 hover:text-sky-300 transition-colors"
            >
              ← Accueil
            </Link>
            <Link
              href="/login"
              className="px-3 py-1 rounded-full bg-sky-500/90 text-slate-950 font-medium hover:bg-sky-400 transition-colors"
            >
              Se connecter
            </Link>
            <Link
              href="/signup"
              className="px-3 py-1 rounded-full border border-slate-700/80 text-slate-300 hover:border-sky-500/80 hover:text-sky-300 transition-colors"
            >
              S&apos;inscrire
            </Link>
          </nav>
        </div>
      </header>

      <main className="flex-1 flex items-center justify-center px-4 py-6">
        <div className="glass max-w-md w-full p-6 sm:p-7 rounded-2xl border border-slate-800 bg-slate-950/80 shadow-2xl shadow-sky-900/40">
          <div className="mb-4">
            <p className="inline-flex items-center gap-2 rounded-full bg-slate-900/80 border border-slate-700 px-3 py-1 mb-2">
              <span className="text-xs">💬</span>
              <span className="text-[11px] uppercase tracking-[0.18em] text-slate-300">
                Mot de passe oublié
              </span>
            </p>
            <h1 className="text-lg sm:text-xl font-semibold text-slate-50">
              Réinitialiser ton mot de passe
            </h1>
            <p className="text-xs text-slate-400 mt-1">
              Entre l&apos;adresse email liée à ton compte. Si elle existe, tu recevras un lien sécurisé.
            </p>
          </div>

          {info && (
            <div className="mb-2 rounded-lg border border-emerald-500/70 bg-emerald-500/10 px-3 py-2 text-[11px] text-emerald-100">
              {info}
            </div>
          )}

          {error && (
            <div className="mb-2 rounded-lg border border-rose-500/70 bg-rose-500/10 px-3 py-2 text-[11px] text-rose-100">
              {error}
            </div>
          )}

          <form onSubmit={handleSubmit} className="space-y-3 text-sm">
            <div>
              <label className="block mb-1 text-xs text-slate-300" htmlFor="email">
                Adresse email
              </label>
              <input
                id="email"
                type="email"
                required
                autoComplete="email"
                className="w-full rounded-lg bg-slate-900/80 border border-slate-700 px-3 py-2 text-xs text-slate-100 placeholder:text-slate-500 outline-none focus:ring-1 focus:ring-sky-500 focus:border-sky-500"
                placeholder="toi@example.com"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                disabled={submitting}
              />
            </div>

            <button
              type="submit"
              disabled={submitting}
              className="w-full inline-flex items-center justify-center rounded-lg bg-sky-500 hover:bg-sky-600 disabled:opacity-60 disabled:cursor-not-allowed text-xs font-medium text-white px-3 py-2 transition-colors mt-1"
            >
              {submitting ? "Envoi du lien..." : "Envoyer le lien de réinitialisation"}
            </button>
          </form>

          <p className="mt-4 text-[11px] text-slate-400 text-center">
            Tu te souviens de ton mot de passe ?{" "}
            <Link href="/login" className="text-sky-400 hover:text-sky-300 hover:underline font-medium">
              Retour à la connexion
            </Link>
          </p>
        </div>
      </main>
    </div>
  );
}
````

## File: app/not-found.tsx
````typescript
"use client";

import Link from "next/link";
import { useAuth } from "@/context/AuthContext";

export default function NotFound() {
  const { user } = useAuth();

  return (
    <div className="min-h-screen flex flex-col items-center justify-center bg-[var(--bg)] text-[var(--ink)] px-4">
      <div className="glass max-w-md w-full p-6 border border-[var(--border)]/80 text-center">
        <h1 className="text-xl font-semibold mb-2">Page introuvable</h1>
        <p className="text-sm text-[var(--muted)] mb-4">
          Le lien que tu as suivi est invalide ou cette page n&apos;existe pas.
        </p>
        <div className="flex flex-wrap gap-3 justify-center">
          <Link href="/" className="btn-secondary text-xs sm:text-sm">
            Retour à l&apos;accueil
          </Link>
          {user && (
            <Link href="/app" className="btn-primary text-xs sm:text-sm">
              Aller au dashboard
            </Link>
          )}
        </div>
      </div>
    </div>
  );
}
````

## File: app/signup/page.tsx
````typescript
"use client";

import { Suspense, useState, useMemo, FormEvent } from "react";
import Script from "next/script";
import { useRouter, useSearchParams } from "next/navigation";
import Link from "next/link";
import {
  createUserWithEmailAndPassword,
  updateProfile,
  sendEmailVerification,
  signInWithPopup,
  GoogleAuthProvider,
} from "firebase/auth";
import { auth, googleProvider } from "@/lib/firebase";
import { getRecaptchaToken, verifyRecaptcha } from "@/lib/recaptcha";
import { 
  ArrowLeft, UserPlus, Mail, Lock, User, 
  CheckCircle2, AlertCircle, Loader2, Eye, EyeOff
} from "lucide-react";

// --- VALIDATION MOT DE PASSE ---
function checkPasswordRules(pwd: string) {
  const min = pwd.length >= 8;
  const upper = /[A-Z]/.test(pwd);
  const digit = /[0-9]/.test(pwd);
  const special = /[!@#$%^&*(),.?":{}|<>]/.test(pwd);
  const ok = min && upper && digit && special;
  return { min, upper, digit, special, ok };
}

function SignupPageInner() {
  const router = useRouter();
  const searchParams = useSearchParams();

  const [firstName, setFirstName] = useState("");
  const [lastName, setLastName] = useState("");
  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [showPwd, setShowPwd] = useState(false);

  const [error, setError] = useState<string | null>(null);
  const [info, setInfo] = useState<string | null>(null);
  const [loading, setLoading] = useState(false);

  const pwdRules = useMemo(() => checkPasswordRules(password), [password]);

  function mapSignupError(err: any) {
    const code = err?.code as string | undefined;
    if (code === "auth/email-already-in-use") return "Cette adresse email est déjà utilisée.";
    if (code === "auth/invalid-email") return "Adresse email invalide.";
    if (code === "auth/weak-password") return "Mot de passe trop faible.";
    return "Une erreur est survenue lors de l'inscription.";
  }

  async function handleSubmit(e: FormEvent) {
    e.preventDefault();
    setError(null); setInfo(null);

    if (!pwdRules.ok) {
      setError("Le mot de passe ne respecte pas les critères de sécurité.");
      return;
    }

    setLoading(true);
    try {
      const action = "SIGNUP";
      let token = "";
      try {
        token = await getRecaptchaToken(action);
      } catch {
        setError("Impossible de valider la sécurité (reCAPTCHA bloqué). Désactivez AdBlock.");
        return;
      }

      const check = await verifyRecaptcha(token, action);
      if (!check.ok) {
        setError("Inscription refusée par sécurité. Réessayez.");
        return;
      }

      const cred = await createUserWithEmailAndPassword(auth, email, password);
      const displayName = `${firstName} ${lastName}`.trim() || email;
      if (displayName) await updateProfile(cred.user, { displayName });
      
      await sendEmailVerification(cred.user);
      router.push("/login?justSignedUp=1");

    } catch (err: any) {
      console.error("Signup error:", err);
      setError(mapSignupError(err));
    } finally {
      setLoading(false);
    }
  }

  async function handleGoogleSignup() {
    setError(null); setInfo(null); setLoading(true);
    try {
      const action = "SIGNUP_GOOGLE";
      const token = await getRecaptchaToken(action);
      const check = await verifyRecaptcha(token, action);
      
      if (!check.ok) {
        setError("Inscription Google refusée par sécurité.");
        return;
      }

      const provider = googleProvider || new GoogleAuthProvider();
      const result = await signInWithPopup(auth, provider);
      const user = result.user;
      
      setInfo(`Compte créé ! Bienvenue ${user.displayName || ""} 👋`);
      const redirectTo = searchParams.get("redirect") || "/app";
      router.push(redirectTo);

    } catch (err: any) {
      console.error("Google signup error:", err);
      if (err.code === "auth/account-exists-with-different-credential") {
        setError("Compte existant. Connectez-vous avec votre mot de passe.");
      } else {
        setError("Erreur lors de l'inscription Google.");
      }
    } finally {
      setLoading(false);
    }
  }

  return (
    <div className="min-h-screen flex flex-col bg-gradient-to-b from-slate-950 via-slate-950/95 to-slate-900 text-slate-100">
      <Script
        src={`https://www.google.com/recaptcha/enterprise.js?render=${process.env.NEXT_PUBLIC_RECAPTCHA_SITE_KEY}`}
        strategy="afterInteractive"
      />

      {/* NAVBAR SIMPLIFIÉE */}
      <header className="border-b border-slate-800/80 bg-slate-950/80 backdrop-blur">
        <div className="max-w-5xl mx-auto px-4 sm:px-6 py-3 flex items-center justify-between gap-3">
          <div className="flex items-center gap-2">
            <div className="w-8 h-8 rounded-xl bg-gradient-to-br from-sky-500 to-sky-400 flex items-center justify-center text-[10px] font-semibold text-slate-950 shadow-lg shadow-sky-500/40">
              IA
            </div>
            <div className="flex flex-col">
              <span className="text-[10px] uppercase tracking-[0.18em] text-slate-400">Assistant candidatures</span>
              <span className="text-xs font-medium text-slate-100">Inscription</span>
            </div>
          </div>
          <nav className="flex items-center gap-2 text-[11px]">
            <Link href="/" className="px-2 py-1 rounded-full border border-slate-700/80 hover:border-sky-500/80 text-slate-300 hover:text-sky-300 transition-colors flex items-center gap-1">
              <ArrowLeft className="w-3 h-3" /> Retour
            </Link>
            <Link href="/login" className="px-3 py-1 rounded-full bg-sky-500/90 text-slate-950 font-medium hover:bg-sky-400 transition-colors">
              Se connecter
            </Link>
          </nav>
        </div>
      </header>

      {/* CONTENU */}
      <main className="flex-1 flex items-center justify-center px-4 py-8">
        <div className="glass max-w-md w-full p-6 sm:p-7 rounded-2xl border border-slate-800 bg-slate-950/80 shadow-2xl shadow-sky-900/40">
          
          <div className="mb-6 text-center sm:text-left">
            <p className="inline-flex items-center gap-2 rounded-full bg-slate-900/80 border border-slate-700 px-3 py-1 mb-3">
              <UserPlus className="w-3 h-3 text-sky-400" />
              <span className="text-[10px] uppercase tracking-[0.18em] text-slate-300">Inscription</span>
            </p>
            <h1 className="text-xl font-bold text-slate-50 mb-1">Créer un compte</h1>
            <p className="text-xs text-slate-400">Rejoignez SmartApply et commencez à décrocher des entretiens.</p>
          </div>

          {/* MESSAGES ALERTE */}
          {info && (
            <div className="mb-4 p-3 rounded-lg bg-emerald-500/10 border border-emerald-500/20 text-emerald-200 text-xs flex gap-2 items-start">
              <CheckCircle2 className="w-4 h-4 flex-shrink-0 mt-0.5" /> <span>{info}</span>
            </div>
          )}
          {error && (
            <div className="mb-4 p-3 rounded-lg bg-rose-500/10 border border-rose-500/20 text-rose-200 text-xs flex gap-2 items-start">
              <AlertCircle className="w-4 h-4 flex-shrink-0 mt-0.5" /> <span>{error}</span>
            </div>
          )}

          <form onSubmit={handleSubmit} className="space-y-4">
            <div className="grid grid-cols-2 gap-3">
              <div className="space-y-1.5">
                <label className="text-xs font-medium text-slate-300 ml-1">Prénom</label>
                <div className="relative">
                  <User className="absolute left-3 top-2.5 w-4 h-4 text-slate-500" />
                  <input 
                    type="text" required value={firstName} onChange={e => setFirstName(e.target.value)}
                    className="w-full bg-[#0A0A0B] border border-white/10 rounded-xl pl-10 pr-3 py-2 text-xs text-white placeholder:text-slate-600 focus:border-sky-500 focus:ring-1 focus:ring-sky-500 outline-none transition-all"
                    placeholder="Jean"
                  />
                </div>
              </div>
              <div className="space-y-1.5">
                <label className="text-xs font-medium text-slate-300 ml-1">Nom</label>
                <div className="relative">
                  <User className="absolute left-3 top-2.5 w-4 h-4 text-slate-500" />
                  <input 
                    type="text" required value={lastName} onChange={e => setLastName(e.target.value)}
                    className="w-full bg-[#0A0A0B] border border-white/10 rounded-xl pl-10 pr-3 py-2 text-xs text-white placeholder:text-slate-600 focus:border-sky-500 focus:ring-1 focus:ring-sky-500 outline-none transition-all"
                    placeholder="Dupont"
                  />
                </div>
              </div>
            </div>

            <div className="space-y-1.5">
              <label className="text-xs font-medium text-slate-300 ml-1">Email</label>
              <div className="relative">
                <Mail className="absolute left-3 top-2.5 w-4 h-4 text-slate-500" />
                <input 
                  type="email" required value={email} onChange={e => setEmail(e.target.value)}
                  className="w-full bg-[#0A0A0B] border border-white/10 rounded-xl pl-10 pr-3 py-2 text-xs text-white placeholder:text-slate-600 focus:border-sky-500 focus:ring-1 focus:ring-sky-500 outline-none transition-all"
                  placeholder="exemple@email.com"
                />
              </div>
            </div>

            <div className="space-y-1.5">
              <label className="text-xs font-medium text-slate-300 ml-1">Mot de passe</label>
              <div className="relative">
                <Lock className="absolute left-3 top-2.5 w-4 h-4 text-slate-500" />
                <input 
                  type={showPwd ? "text" : "password"} required value={password} onChange={e => setPassword(e.target.value)}
                  className={`w-full bg-[#0A0A0B] border rounded-xl pl-10 pr-10 py-2 text-xs text-white placeholder:text-slate-600 focus:border-sky-500 focus:ring-1 focus:ring-sky-500 outline-none transition-all ${password && !pwdRules.ok ? "border-rose-500/50" : "border-white/10"}`}
                  placeholder="••••••••"
                />
                <button type="button" onClick={() => setShowPwd(!showPwd)} className="absolute right-3 top-2.5 text-slate-500 hover:text-white transition-colors">
                  {showPwd ? <EyeOff className="w-4 h-4" /> : <Eye className="w-4 h-4" />}
                </button>
              </div>

              {/* REGLES MDP */}
              <div className="grid grid-cols-2 gap-x-2 gap-y-1 mt-2 pl-1">
                <div className={`flex items-center gap-1.5 text-[10px] ${pwdRules.min ? "text-emerald-400" : "text-slate-500"}`}>
                  <div className={`w-1.5 h-1.5 rounded-full ${pwdRules.min ? "bg-emerald-400" : "bg-slate-600"}`} /> 8+ caractères
                </div>
                <div className={`flex items-center gap-1.5 text-[10px] ${pwdRules.upper ? "text-emerald-400" : "text-slate-500"}`}>
                  <div className={`w-1.5 h-1.5 rounded-full ${pwdRules.upper ? "bg-emerald-400" : "bg-slate-600"}`} /> 1 Majuscule
                </div>
                <div className={`flex items-center gap-1.5 text-[10px] ${pwdRules.digit ? "text-emerald-400" : "text-slate-500"}`}>
                  <div className={`w-1.5 h-1.5 rounded-full ${pwdRules.digit ? "bg-emerald-400" : "bg-slate-600"}`} /> 1 Chiffre
                </div>
                <div className={`flex items-center gap-1.5 text-[10px] ${pwdRules.special ? "text-emerald-400" : "text-slate-500"}`}>
                  <div className={`w-1.5 h-1.5 rounded-full ${pwdRules.special ? "bg-emerald-400" : "bg-slate-600"}`} /> 1 Caractère spécial
                </div>
              </div>
            </div>

            <button 
              type="submit" 
              disabled={loading}
              className="w-full h-11 rounded-xl bg-sky-500 hover:bg-sky-400 text-white font-semibold text-sm transition-all shadow-lg shadow-sky-500/20 disabled:opacity-50 flex items-center justify-center gap-2 mt-2"
            >
              {loading ? <Loader2 className="w-4 h-4 animate-spin" /> : "S'inscrire"}
            </button>
          </form>

          <div className="flex items-center gap-3 my-5">
            <div className="h-px flex-1 bg-slate-800" />
            <span className="text-[10px] text-slate-500 uppercase tracking-widest font-bold">Ou</span>
            <div className="h-px flex-1 bg-slate-800" />
          </div>

          <button 
            onClick={handleGoogleSignup} 
            disabled={loading}
            className="w-full h-11 rounded-xl bg-slate-900 border border-slate-700 hover:border-sky-500/50 text-slate-200 font-medium text-xs flex items-center justify-center gap-2 transition-all hover:bg-slate-800 disabled:opacity-50"
          >
            <svg className="w-4 h-4" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.84z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
            Continuer avec Google
          </button>

          <p className="mt-6 text-center text-xs text-slate-500">
            Déjà inscrit ? <Link href="/login" className="text-sky-400 hover:text-sky-300 font-semibold underline decoration-sky-500/30">Se connecter</Link>
          </p>
        </div>
      </main>
    </div>
  );
}

export default function SignupPage() {
  return (
    <Suspense fallback={<div className="min-h-screen bg-[#0A0A0B] flex items-center justify-center"><Loader2 className="w-6 h-6 text-slate-500 animate-spin" /></div>}>
      <SignupPageInner />
    </Suspense>
  );
}
````

## File: app/tech/page.tsx
````typescript
"use client";

export default function TechPage() {
  return (
    <div className="min-h-screen px-4 sm:px-8 py-8">
      <div className="max-w-4xl mx-auto glass p-6">
        <h1 className="text-xl font-semibold mb-3">Technologies utilisées</h1>
        <p className="text-sm text-[var(--muted)] mb-4">
          Bien que le site lui-même ne liste pas explicitement les technologies de son frontend
          dans le contenu visible, l'analyse du code source et des pratiques courantes pour ce
          type de plateforme moderne suggère fortement l'utilisation de la pile suivante :
        </p>
        <ul className="list-disc pl-5 space-y-2 text-sm">
          <li>
            <span className="font-semibold">Frontend — React / Next.js :</span>{" "}
            Framework JavaScript moderne pour construire l&apos;interface utilisateur,
            avec un routage optimisé et un rendu performant.
          </li>
          <li>
            <span className="font-semibold">Styling — Tailwind CSS :</span>{" "}
            Framework CSS utilitaire permettant de construire rapidement des designs
            réactifs et cohérents.
          </li>
          <li>
            <span className="font-semibold">Animations — Framer Motion :</span>{" "}
            Bibliothèque React dédiée aux animations fluides, transitions interactives
            et gestes avancés.
          </li>
        </ul>
        <p className="text-sm text-[var(--muted)] mt-4">
          Le style sombre, les cartes en verre (glassmorphism) et les transitions rapides
          sont caractéristiques d&apos;une approche basée sur Next.js couplé à Tailwind CSS
          et Framer Motion pour les effets au scroll et à l&apos;interaction.
        </p>
      </div>
    </div>
  );
}
````

## File: components/ActivityTracker.tsx
````typescript
// components/ActivityTracker.tsx
"use client";

import { useEffect } from "react";
import { useAuth } from "@/context/AuthContext";
import { updateLastActive } from "@/lib/userTracking";

/**
 * Composant invisible qui met à jour lastActiveAt
 * toutes les 60 secondes tant que l'utilisateur est connecté.
 * On en profite pour envoyer:
 *  - la page actuelle (path)
 *  - le device (iPhone / iPad / macOS / etc.)
 *  - l’IP + pays + ville (via userTracking)
 */
export default function ActivityTracker() {
  const { user } = useAuth();

  useEffect(() => {
    if (!user) return;

    let cancelled = false;

    const tick = () => {
      if (!user || cancelled) return;

      const path =
        typeof window !== "undefined"
          ? window.location.pathname + window.location.search
          : undefined;

      updateLastActive(user, {
        path,
        action: "heartbeat",
      });
    };

    // première mise à jour immédiate
    tick();
    const id = setInterval(tick, 60_000); // toutes les 60 secondes

    return () => {
      cancelled = true;
      clearInterval(id);
    };
  }, [user]);

  return null;
}
````

## File: components/AOSProvider.tsx
````typescript
"use client";

import { useEffect } from "react";
import AOS from "aos";
import "aos/dist/aos.css";

export default function AOSProvider({ children }: { children: React.ReactNode }) {
  useEffect(() => {
    AOS.init({
      duration: 1000, // durée des animations
      once: true,     // n’anime qu’une seule fois
      easing: "ease-out-cubic",
      offset: 60
    });
  }, []);

  return <>{children}</>;
}
````

## File: components/assistant/CvPdfEditorModal.tsx
````typescript
"use client";

import { useEffect, useMemo, useRef, useState } from "react";
import { motion, AnimatePresence } from "framer-motion";
import type { CvDocModel } from "@/lib/pdf/templates/cvAts";
import { downloadBlob } from "@/lib/pdf/pdfmakeClient";

type SectionKey = "profile" | "skills" | "xp" | "education" | "certs" | "languages" | "hobbies";

type CvDocModelExt = CvDocModel & {
  __meta?: {
    hide?: Partial<Record<SectionKey, boolean>>;
  };
};

function safeText(v: any) {
  return String(v ?? "").replace(/\u00A0/g, " ").trim();
}

function Modal({
  open,
  title,
  onClose,
  children,
}: {
  open: boolean;
  title: string;
  onClose: () => void;
  children: React.ReactNode;
}) {
  return (
    <AnimatePresence>
      {open && (
        <motion.div
          className="fixed inset-0 z-[90] flex items-center justify-center px-2 sm:px-4"
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          exit={{ opacity: 0 }}
        >
          <div className="absolute inset-0 bg-black/55" onClick={onClose} />
          <motion.div
            className="relative w-full max-w-6xl h-[92vh] rounded-2xl border border-[var(--border)] bg-[var(--bg)] shadow-xl overflow-hidden"
            initial={{ y: 14, opacity: 0, scale: 0.99 }}
            animate={{ y: 0, opacity: 1, scale: 1 }}
            exit={{ y: 10, opacity: 0, scale: 0.99 }}
            transition={{ duration: 0.18 }}
          >
            <div className="flex items-center justify-between gap-3 border-b border-[var(--border)] px-4 py-3">
              <div>
                <p className="text-[12px] text-[var(--muted)]">Éditeur CV</p>
                <h3 className="text-[14px] font-semibold text-[var(--ink)]">{title}</h3>
              </div>
              <button className="btn-secondary" type="button" onClick={onClose}>
                Fermer
              </button>
            </div>

            <div className="h-[calc(92vh-56px)] grid grid-cols-1 lg:grid-cols-[420px_1fr]">
              {children}
            </div>
          </motion.div>
        </motion.div>
      )}
    </AnimatePresence>
  );
}

export default function CvPdfEditorModal({
  open,
  onClose,
  initialModel,
  title,
  fileName = "cv-ia.pdf",
  templateLabel,
  renderPdf,
  onSaveModel,
}: {
  open: boolean;
  onClose: () => void;
  initialModel: CvDocModel;
  title: string;
  fileName?: string;
  templateLabel?: string;
  renderPdf: (model: CvDocModel) => Promise<{ blob: Blob; bestScale: number }>;
  onSaveModel?: (model: CvDocModel) => void;
}) {
  const [model, setModel] = useState<CvDocModelExt>(initialModel as CvDocModelExt);

  const [busy, setBusy] = useState(false);
  const [err, setErr] = useState<string | null>(null);

  const [blob, setBlob] = useState<Blob | null>(null);
  const [bestScale, setBestScale] = useState<number | null>(null);

  const [blobUrl, setBlobUrl] = useState<string>("");

  const debounceRef = useRef<any>(null);

  // reset when open/initial changes
  useEffect(() => {
    if (!open) return;
    setModel(initialModel as CvDocModelExt);
  }, [open, initialModel]);

  // revoke old url
  useEffect(() => {
    return () => {
      if (blobUrl) URL.revokeObjectURL(blobUrl);
    };
  }, [blobUrl]);

  const hide = model.__meta?.hide || {};

  const setHide = (k: SectionKey, v: boolean) => {
    setModel((m) => ({
      ...m,
      __meta: { ...(m.__meta || {}), hide: { ...(m.__meta?.hide || {}), [k]: v } },
    }));
  };

  const regenerate = async (m: CvDocModel) => {
    setErr(null);
    setBusy(true);
    try {
      const out = await renderPdf(m);
      setBlob(out.blob);
      setBestScale(out.bestScale);
      const url = URL.createObjectURL(out.blob);
      setBlobUrl((prev) => {
        if (prev) URL.revokeObjectURL(prev);
        return url;
      });
    } catch (e: any) {
      setErr(e?.message || "Erreur génération PDF (preview).");
    } finally {
      setBusy(false);
    }
  };

  // ✅ debounce regen on model change (while open)
  useEffect(() => {
    if (!open) return;
    if (debounceRef.current) clearTimeout(debounceRef.current);
    debounceRef.current = setTimeout(() => {
      regenerate(model);
    }, 350);
    return () => clearTimeout(debounceRef.current);
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [open, JSON.stringify(model)]);

  // first render when open
  useEffect(() => {
    if (!open) return;
    regenerate(model);
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [open]);

  const allSkills = useMemo(() => {
    const s: any = (model as any).skills || {};
    const pack = (k: string) => (Array.isArray(s[k]) ? s[k] : []);
    return {
      cloud: pack("cloud"),
      sec: pack("sec"),
      sys: pack("sys"),
      auto: pack("auto"),
      tools: pack("tools"),
      soft: pack("soft"),
    };
  }, [model]);

  const updateSkills = (key: keyof typeof allSkills, next: string[]) => {
    setModel((m: any) => ({
      ...m,
      skills: { ...(m.skills || {}), [key]: next },
    }));
  };

  const removeSkill = (key: keyof typeof allSkills, idx: number) => {
    const arr = [...(allSkills[key] || [])];
    arr.splice(idx, 1);
    updateSkills(key, arr);
  };

  const [skillDraft, setSkillDraft] = useState("");
  const [skillBucket, setSkillBucket] = useState<keyof typeof allSkills>("tools");

  useEffect(() => {
    if (!open) return;
    setSkillDraft("");
    setSkillBucket("tools");
  }, [open]);

  const addSkill = () => {
    const s = safeText(skillDraft);
    if (!s) return;
    const arr = [...(allSkills[skillBucket] || [])];
    arr.push(s);
    updateSkills(skillBucket, arr);
    setSkillDraft("");
  };

  const xp = Array.isArray((model as any).xp) ? ((model as any).xp as any[]) : [];
  const updateXp = (next: any[]) => setModel((m: any) => ({ ...m, xp: next }));

  const edu = Array.isArray((model as any).education) ? ((model as any).education as string[]) : [];
  const updateEdu = (next: string[]) => setModel((m: any) => ({ ...m, education: next }));

  return (
    <Modal
      open={open}
      onClose={onClose}
      title={title}
    >
      {/* LEFT: controls */}
      <div className="border-r border-[var(--border)] bg-[var(--bg-soft)] overflow-auto">
        <div className="p-4 space-y-3">
          <div className="rounded-xl border border-[var(--border)] bg-[var(--bg)] p-3">
            <div className="flex items-start justify-between gap-3">
              <div>
                <p className="text-[11px] text-[var(--muted)]">Template</p>
                <p className="text-[13px] font-semibold text-[var(--ink)]">{templateLabel || "CV"}</p>
                {bestScale != null && (
                  <p className="text-[11px] text-[var(--muted)] mt-1">Scale: {bestScale.toFixed(2)} (fit 1 page)</p>
                )}
              </div>

              <div className="flex flex-col gap-2">
                <button
                  type="button"
                  className="btn-primary"
                  disabled={!blob || busy}
                  onClick={() => blob && downloadBlob(blob, fileName)}
                >
                  {busy ? "Génération…" : "Télécharger"}
                </button>

                <button
                  type="button"
                  className="btn-secondary"
                  onClick={() => onSaveModel?.(model as CvDocModel)}
                >
                  Enregistrer
                </button>

                <button
                  type="button"
                  className="btn-secondary"
                  onClick={() => setModel(initialModel as CvDocModelExt)}
                >
                  Réinitialiser
                </button>
              </div>
            </div>

            {err && <p className="mt-2 text-[11px] text-red-400">{err}</p>}
          </div>

          {/* Hide toggles */}
          <div className="rounded-xl border border-[var(--border)] bg-[var(--bg)] p-3">
            <p className="text-[12px] font-semibold text-[var(--ink)] mb-2">Masquer des sections</p>
            <div className="grid grid-cols-2 gap-2 text-[12px]">
              {(
                [
                  ["profile", "Profil"],
                  ["skills", "Compétences"],
                  ["education", "Formation"],
                  ["xp", "Expérience"],
                  ["languages", "Langues"],
                  ["certs", "Certifs"],
                  ["hobbies", "Hobbies"],
                ] as Array<[SectionKey, string]>
              ).map(([k, label]) => (
                <label key={k} className="flex items-center gap-2 cursor-pointer">
                  <input
                    type="checkbox"
                    checked={!!hide[k]}
                    onChange={(e) => setHide(k, e.target.checked)}
                  />
                  <span className="text-[var(--muted)]">{label}</span>
                </label>
              ))}
            </div>
          </div>

          {/* General */}
          <div className="rounded-xl border border-[var(--border)] bg-[var(--bg)] p-3 space-y-2">
            <p className="text-[12px] font-semibold text-[var(--ink)]">Infos</p>
            <div>
              <label className="block text-[11px] text-[var(--muted)] mb-1">Nom</label>
              <input
                className="input w-full bg-[var(--bg)]"
                value={safeText((model as any).name)}
                onChange={(e) => setModel((m: any) => ({ ...m, name: e.target.value }))}
              />
            </div>
            <div>
              <label className="block text-[11px] text-[var(--muted)] mb-1">Titre</label>
              <input
                className="input w-full bg-[var(--bg)]"
                value={safeText((model as any).title)}
                onChange={(e) => setModel((m: any) => ({ ...m, title: e.target.value }))}
              />
            </div>
            <div>
              <label className="block text-[11px] text-[var(--muted)] mb-1">Ligne contact</label>
              <input
                className="input w-full bg-[var(--bg)]"
                value={safeText((model as any).contactLine)}
                onChange={(e) => setModel((m: any) => ({ ...m, contactLine: e.target.value }))}
              />
            </div>
          </div>

          {/* Profile */}
          <div className="rounded-xl border border-[var(--border)] bg-[var(--bg)] p-3 space-y-2">
            <p className="text-[12px] font-semibold text-[var(--ink)]">Profil</p>
            <textarea
              className="input textarea w-full bg-[var(--bg)] text-[13px]"
              rows={4}
              value={safeText((model as any).profile)}
              onChange={(e) => setModel((m: any) => ({ ...m, profile: e.target.value }))}
            />
          </div>

          {/* Skills */}
          <div className="rounded-xl border border-[var(--border)] bg-[var(--bg)] p-3 space-y-3">
            <div className="flex items-center justify-between">
              <p className="text-[12px] font-semibold text-[var(--ink)]">Compétences</p>
              <div className="flex items-center gap-2">
                <select
                  className="select-brand bg-[var(--bg-soft)] text-[12px]"
                  value={skillBucket}
                  onChange={(e) => setSkillBucket(e.target.value as any)}
                >
                  <option value="tools">Tools</option>
                  <option value="cloud">Cloud</option>
                  <option value="sec">Sécurité</option>
                  <option value="sys">Systèmes</option>
                  <option value="auto">Auto/DevOps</option>
                  <option value="soft">Soft</option>
                </select>
              </div>
            </div>

            <div className="flex gap-2">
              <input
                className="input flex-1 bg-[var(--bg)]"
                placeholder="Ajouter une compétence…"
                value={skillDraft}
                onChange={(e) => setSkillDraft(e.target.value)}
                onKeyDown={(e) => {
                  if (e.key === "Enter") {
                    e.preventDefault();
                    addSkill();
                  }
                }}
              />
              <button type="button" className="btn-secondary" onClick={addSkill}>
                Ajouter
              </button>
            </div>

            {(
              [
                ["cloud", "Cloud"],
                ["sec", "Sécurité"],
                ["sys", "Systèmes"],
                ["auto", "Auto/DevOps"],
                ["tools", "Tools"],
                ["soft", "Soft"],
              ] as Array<[keyof typeof allSkills, string]>
            ).map(([k, label]) => (
              <div key={k}>
                <p className="text-[11px] text-[var(--muted)] mb-2">{label}</p>
                <div className="flex flex-wrap gap-2">
                  {(allSkills[k] || []).map((it, idx) => (
                    <button
                      type="button"
                      key={`${k}-${idx}`}
                      className="text-[11px] px-2 py-[2px] rounded-full border border-[var(--border)] bg-[var(--bg-soft)] hover:border-red-400 hover:text-red-400 transition"
                      title="Cliquer pour supprimer"
                      onClick={() => removeSkill(k, idx)}
                    >
                      {it} <span className="ml-1">×</span>
                    </button>
                  ))}
                  {!allSkills[k]?.length && (
                    <span className="text-[11px] text-[var(--muted)]">—</span>
                  )}
                </div>
              </div>
            ))}
          </div>

          {/* Experience */}
          <div className="rounded-xl border border-[var(--border)] bg-[var(--bg)] p-3 space-y-3">
            <div className="flex items-center justify-between">
              <p className="text-[12px] font-semibold text-[var(--ink)]">Expériences</p>
              <button
                type="button"
                className="btn-secondary"
                onClick={() =>
                  updateXp([
                    ...xp,
                    { role: "Poste", company: "Entreprise", dates: "2023–2025", city: "", bullets: ["Impact / résultat chiffré"] },
                  ])
                }
              >
                + Ajouter
              </button>
            </div>

            <div className="space-y-3">
              {xp.map((x, i) => (
                <div key={i} className="rounded-xl border border-[var(--border)] bg-[var(--bg-soft)] p-3">
                  <div className="flex items-start justify-between gap-2">
                    <p className="text-[12px] font-semibold text-[var(--ink)]">EXP #{i + 1}</p>
                    <button
                      type="button"
                      className="text-[12px] text-red-400 hover:underline"
                      onClick={() => {
                        const next = [...xp];
                        next.splice(i, 1);
                        updateXp(next);
                      }}
                    >
                      Supprimer
                    </button>
                  </div>

                  <div className="grid grid-cols-2 gap-2 mt-2">
                    <div>
                      <label className="block text-[11px] text-[var(--muted)] mb-1">Poste</label>
                      <input
                        className="input w-full bg-[var(--bg)]"
                        value={safeText(x.role)}
                        onChange={(e) => {
                          const next = [...xp];
                          next[i] = { ...next[i], role: e.target.value };
                          updateXp(next);
                        }}
                      />
                    </div>
                    <div>
                      <label className="block text-[11px] text-[var(--muted)] mb-1">Entreprise</label>
                      <input
                        className="input w-full bg-[var(--bg)]"
                        value={safeText(x.company)}
                        onChange={(e) => {
                          const next = [...xp];
                          next[i] = { ...next[i], company: e.target.value };
                          updateXp(next);
                        }}
                      />
                    </div>
                    <div>
                      <label className="block text-[11px] text-[var(--muted)] mb-1">Dates</label>
                      <input
                        className="input w-full bg-[var(--bg)]"
                        value={safeText(x.dates)}
                        onChange={(e) => {
                          const next = [...xp];
                          next[i] = { ...next[i], dates: e.target.value };
                          updateXp(next);
                        }}
                      />
                    </div>
                    <div>
                      <label className="block text-[11px] text-[var(--muted)] mb-1">Ville</label>
                      <input
                        className="input w-full bg-[var(--bg)]"
                        value={safeText(x.city)}
                        onChange={(e) => {
                          const next = [...xp];
                          next[i] = { ...next[i], city: e.target.value };
                          updateXp(next);
                        }}
                      />
                    </div>
                  </div>

                  <div className="mt-2">
                    <label className="block text-[11px] text-[var(--muted)] mb-1">
                      Bullets (1 ligne = 1 bullet)
                    </label>
                    <textarea
                      className="input textarea w-full bg-[var(--bg)] text-[13px]"
                      rows={4}
                      value={Array.isArray(x.bullets) ? x.bullets.join("\n") : ""}
                      onChange={(e) => {
                        const next = [...xp];
                        next[i] = {
                          ...next[i],
                          bullets: e.target.value
                            .split("\n")
                            .map((l) => l.trim())
                            .filter(Boolean),
                        };
                        updateXp(next);
                      }}
                    />

                    <div className="flex gap-2 mt-2">
                      <button
                        type="button"
                        className="btn-secondary"
                        onClick={() => {
                          const next = [...xp];
                          const bullets = Array.isArray(next[i].bullets) ? [...next[i].bullets] : [];
                          bullets.push("Exemple : Automatisation / optimisation → -30% temps de traitement");
                          next[i] = { ...next[i], bullets };
                          updateXp(next);
                        }}
                      >
                        + Exemple
                      </button>

                      <button
                        type="button"
                        className="btn-secondary"
                        onClick={() => {
                          const next = [...xp];
                          const bullets = Array.isArray(next[i].bullets) ? [...next[i].bullets] : [];
                          // nettoyage simple : unique + trim
                          const seen = new Set<string>();
                          const clean = bullets
                            .map((b) => b.trim())
                            .filter(Boolean)
                            .filter((b) => {
                              const k = b.toLowerCase();
                              if (seen.has(k)) return false;
                              seen.add(k);
                              return true;
                            });
                          next[i] = { ...next[i], bullets: clean };
                          updateXp(next);
                        }}
                      >
                        Nettoyer
                      </button>
                    </div>
                  </div>
                </div>
              ))}
              {!xp.length && <p className="text-[11px] text-[var(--muted)]">Aucune expérience.</p>}
            </div>
          </div>

          {/* Education */}
          <div className="rounded-xl border border-[var(--border)] bg-[var(--bg)] p-3 space-y-3">
            <div className="flex items-center justify-between">
              <p className="text-[12px] font-semibold text-[var(--ink)]">Formation</p>
              <button
                type="button"
                className="btn-secondary"
                onClick={() => updateEdu([...edu, "Diplôme — École — 2022 — Paris"])}
              >
                + Ajouter
              </button>
            </div>

            <div className="space-y-2">
              {edu.map((line, i) => (
                <div key={i} className="flex gap-2">
                  <input
                    className="input flex-1 bg-[var(--bg)]"
                    value={safeText(line)}
                    onChange={(e) => {
                      const next = [...edu];
                      next[i] = e.target.value;
                      updateEdu(next);
                    }}
                  />
                  <button
                    type="button"
                    className="btn-secondary"
                    onClick={() => {
                      const next = [...edu];
                      next.splice(i, 1);
                      updateEdu(next);
                    }}
                  >
                    ×
                  </button>
                </div>
              ))}
              {!edu.length && <p className="text-[11px] text-[var(--muted)]">Aucune formation.</p>}
            </div>
          </div>

          {/* Lang / certs / hobbies */}
          <div className="rounded-xl border border-[var(--border)] bg-[var(--bg)] p-3 space-y-2">
            <p className="text-[12px] font-semibold text-[var(--ink)]">Langues / Certifs / Hobbies</p>

            <div>
              <label className="block text-[11px] text-[var(--muted)] mb-1">Langues (ligne)</label>
              <input
                className="input w-full bg-[var(--bg)]"
                value={safeText((model as any).langLine)}
                onChange={(e) => setModel((m: any) => ({ ...m, langLine: e.target.value }))}
              />
            </div>

            <div>
              <label className="block text-[11px] text-[var(--muted)] mb-1">Certifications</label>
              <textarea
                className="input textarea w-full bg-[var(--bg)] text-[13px]"
                rows={2}
                value={safeText((model as any).certs)}
                onChange={(e) => setModel((m: any) => ({ ...m, certs: e.target.value }))}
              />
            </div>

            <div>
              <label className="block text-[11px] text-[var(--muted)] mb-1">Hobbies (séparés par virgule)</label>
              <input
                className="input w-full bg-[var(--bg)]"
                value={Array.isArray((model as any).hobbies) ? (model as any).hobbies.join(", ") : ""}
                onChange={(e) =>
                  setModel((m: any) => ({
                    ...m,
                    hobbies: e.target.value
                      .split(",")
                      .map((x) => x.trim())
                      .filter(Boolean),
                  }))
                }
              />
            </div>
          </div>

          <p className="px-1 pb-3 text-[10px] text-[var(--muted)]">
            💡 Tout ce que tu modifies ici régénère le PDF : tu “édites” ton CV directement depuis ton site.
          </p>
        </div>
      </div>

      {/* RIGHT: preview */}
      <div className="bg-[var(--bg)] overflow-hidden">
        <div className="h-full w-full relative">
          {busy && (
            <div className="absolute inset-0 z-10 bg-white/40 backdrop-blur-[2px] flex items-center justify-center">
              <div className="rounded-full bg-[var(--bg)] border border-[var(--border)] px-3 py-2 text-[11px] text-[var(--muted)] flex items-center gap-2">
                <span className="inline-flex w-3 h-3 rounded-full border-2 border-[var(--brand)] border-t-transparent animate-spin" />
                <span>Régénération PDF…</span>
              </div>
            </div>
          )}

          {blobUrl ? (
            <iframe title="cv-preview" src={blobUrl} className="w-full h-full" />
          ) : (
            <div className="h-full flex items-center justify-center text-[11px] text-[var(--muted)]">
              Preview PDF…
            </div>
          )}
        </div>
      </div>
    </Modal>
  );
}
````

## File: components/assistant/CvTemplatePicker.tsx
````typescript
"use client";

import { useMemo, useState } from "react";
import { motion, AnimatePresence } from "framer-motion";
import type { CvTemplateId, CvTemplateMeta } from "@/lib/pdf/templates/cvTemplates";

type Props = {
  templates: CvTemplateMeta[];
  value: CvTemplateId;
  onChange: (id: CvTemplateId) => void;
};

function Modal({
  open,
  title,
  onClose,
  children,
}: {
  open: boolean;
  title: string;
  onClose: () => void;
  children: React.ReactNode;
}) {
  return (
    <AnimatePresence>
      {open && (
        <motion.div
          className="fixed inset-0 z-[80] flex items-center justify-center px-3"
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          exit={{ opacity: 0 }}
        >
          <div className="absolute inset-0 bg-black/50" onClick={onClose} />
          <motion.div
            className="relative w-full max-w-4xl rounded-2xl border border-[var(--border)] bg-[var(--bg)] shadow-xl"
            initial={{ y: 14, opacity: 0, scale: 0.98 }}
            animate={{ y: 0, opacity: 1, scale: 1 }}
            exit={{ y: 10, opacity: 0, scale: 0.98 }}
            transition={{ duration: 0.18 }}
          >
            <div className="flex items-center justify-between gap-3 border-b border-[var(--border)] px-4 py-3">
              <div>
                <p className="text-[12px] text-[var(--muted)]">Choix du template</p>
                <h3 className="text-[14px] font-semibold text-[var(--ink)]">{title}</h3>
              </div>
              <button className="btn-secondary" type="button" onClick={onClose}>
                Fermer
              </button>
            </div>
            <div className="p-4">{children}</div>
          </motion.div>
        </motion.div>
      )}
    </AnimatePresence>
  );
}

function TemplateCard({
  t,
  active,
  onPick,
}: {
  t: CvTemplateMeta;
  active: boolean;
  onPick: () => void;
}) {
  return (
    <button
      type="button"
      onClick={onPick}
      className={`text-left rounded-xl border p-2 bg-[var(--bg-soft)] transition w-full
      ${active ? "border-[var(--brand)] ring-2 ring-[var(--brand)]/20" : "border-[var(--border)] hover:border-[var(--brand)]/50"}`}
    >
      <img
        src={t.previewSrc}
        alt={t.label}
        className="w-full h-[140px] object-cover rounded-lg border border-[var(--border)] bg-white"
      />
      <div className="mt-2">
        <p className="text-[12px] font-semibold text-[var(--ink)] flex items-center justify-between gap-2">
          <span>{t.label}</span>
          {active && (
            <span className="text-[10px] px-2 py-[2px] rounded-full bg-[var(--brand)]/10 text-[var(--brand)] border border-[var(--brand)]/20">
              Sélectionné
            </span>
          )}
        </p>
        <p className="text-[10px] text-[var(--muted)]">{t.description}</p>
      </div>
    </button>
  );
}

export default function CvTemplatePicker({ templates, value, onChange }: Props) {
  const [open, setOpen] = useState(false);
  const [q, setQ] = useState("");

  const selected = templates.find((t) => t.id === value);

  // ✅ 3 visibles : on force le template sélectionné + 2 autres
  const top3 = useMemo(() => {
    const others = templates.filter((t) => t.id !== value);
    return [selected, ...others.slice(0, 2)].filter(Boolean) as CvTemplateMeta[];
  }, [templates, value, selected]);

  const filtered = useMemo(() => {
    const s = q.trim().toLowerCase();
    if (!s) return templates;
    return templates.filter((t) => {
      const hay = `${t.label} ${t.description} ${t.id}`.toLowerCase();
      return hay.includes(s);
    });
  }, [templates, q]);

  return (
    <>
      <div className="grid grid-cols-2 sm:grid-cols-4 gap-3">
        {top3.map((t) => (
          <TemplateCard key={t.id} t={t} active={t.id === value} onPick={() => onChange(t.id)} />
        ))}

        {/* ✅ "Voir plus" */}
        <button
          type="button"
          onClick={() => setOpen(true)}
          className="rounded-xl border border-[var(--border)] bg-[var(--bg-soft)] p-3 hover:border-[var(--brand)]/50 transition flex flex-col items-center justify-center gap-2"
        >
          <span className="w-9 h-9 rounded-xl bg-[var(--brand)]/10 text-[var(--brand)] flex items-center justify-center text-lg">
            +
          </span>
          <div className="text-center">
            <p className="text-[12px] font-semibold text-[var(--ink)]">Voir plus</p>
            <p className="text-[10px] text-[var(--muted)]">Tous les modèles</p>
          </div>
        </button>
      </div>

      <p className="mt-2 text-[10px] text-[var(--muted)]">
        Les images doivent être dans <strong>/public/cv-templates/</strong> (ex:{" "}
        <span className="font-mono">/cv-templates/cv-template-modern.png</span>).
      </p>

      <Modal
        open={open}
        title="Tous les templates CV"
        onClose={() => setOpen(false)}
      >
        <div className="flex flex-col sm:flex-row gap-3 sm:items-center sm:justify-between mb-3">
          <input
            className="input w-full sm:max-w-sm bg-[var(--bg)]"
            placeholder="Rechercher un template…"
            value={q}
            onChange={(e) => setQ(e.target.value)}
          />
          {selected ? (
            <div className="text-[11px] text-[var(--muted)]">
              Sélection actuelle : <span className="font-medium text-[var(--ink)]">{selected.label}</span>
            </div>
          ) : null}
        </div>

        <div className="grid grid-cols-2 sm:grid-cols-3 gap-3">
          {filtered.map((t) => (
            <TemplateCard
              key={t.id}
              t={t}
              active={t.id === value}
              onPick={() => {
                onChange(t.id);
                setOpen(false);
              }}
            />
          ))}
        </div>
      </Modal>
    </>
  );
}
````

## File: components/BlockedOverlay.tsx
````typescript
// components/BlockedOverlay.tsx
"use client";

import { useAuth } from "@/context/AuthContext";
import { useUserProfile } from "@/hooks/useUserProfile";

/**
 * Affiche un overlay pleine page si le user est marqué "blocked" dans Firestore.
 * Résultat : impossible de cliquer / utiliser l'app.
 */
export default function BlockedOverlay() {
  const { user } = useAuth();
  const { profile, loading } = useUserProfile();

  // pas connecté ou encore en chargement -> pas d'overlay
  if (!user || loading) return null;

  if (!profile?.blocked) return null;

  return (
    <div className="fixed inset-0 z-[9999] bg-black/80 backdrop-blur-sm flex items-center justify-center px-4">
      <div className="max-w-md w-full glass border border-red-500/40 rounded-2xl p-6 text-center">
        <h2 className="text-lg font-semibold mb-2 text-red-100">
          Accès bloqué
        </h2>
        <p className="text-xs text-[var(--muted)] mb-4">
          Ton compte a été temporairement bloqué par l&apos;administration.
          Tu ne peux plus utiliser l&apos;assistant tant que le blocage est
          actif.
        </p>
        <p className="text-[11px] text-[var(--muted)] mb-4">
          Si tu penses qu&apos;il s&apos;agit d&apos;une erreur, contacte le
          support ou l&apos;administrateur.
        </p>
        <p className="text-[10px] text-[var(--muted)]/70">
          ID utilisateur :{" "}
          <span className="font-mono">
            {profile.id.slice(0, 8)}…
          </span>
        </p>
      </div>
    </div>
  );
}
````

## File: components/BuyCreditsButtons.tsx
````typescript
// src/components/BuyCreditsButtons.tsx
"use client";

import { useState } from "react";

type CreditPackId = "10" | "20" | "30";

interface BuyCreditsButtonsProps {
  user: {
    id: string;
    email: string;
  };
}

export function BuyCreditsButtons({ user }: BuyCreditsButtonsProps) {
  const [loadingPack, setLoadingPack] = useState<CreditPackId | null>(null);

  const handleBuy = async (packId: CreditPackId) => {
    try {
      setLoadingPack(packId);

      const res = await fetch("/api/polar/checkout", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          packId,
          email: user.email,
          userId: user.id,
        }),
      });

      const data = await res.json();

      if (!data.ok || !data.url) {
        console.error("Erreur réponse API Polar:", data);
        alert("Erreur lors de la création du paiement.");
        return;
      }

      // Redirection vers la page de paiement Polar
      window.location.href = data.url;
    } catch (error) {
      console.error("Erreur handleBuy:", error);
      alert("Une erreur est survenue.");
    } finally {
      setLoadingPack(null);
    }
  };

  const isLoading = (pack: CreditPackId) => loadingPack === pack;

  return (
    <div className="flex flex-col gap-3">
      <button onClick={() => handleBuy("10")} disabled={isLoading("10")}>
        {isLoading("10") ? "Redirection..." : "Acheter 10 crédits"}
      </button>
      <button onClick={() => handleBuy("20")} disabled={isLoading("20")}>
        {isLoading("20") ? "Redirection..." : "Acheter 20 crédits"}
      </button>
      <button onClick={() => handleBuy("30")} disabled={isLoading("30")}>
        {isLoading("30") ? "Redirection..." : "Acheter 30 crédits"}
      </button>
    </div>
  );
}
````

## File: components/CvTemplatePicker.tsx
````typescript
// src/components/CvTemplatePicker.tsx
"use client";

import Image from "next/image";
import { getCvTemplates, type CvTemplateId } from "@/lib/pdf/templates/cvTemplates";

export function CvTemplatePicker({
  value,
  onChange,
}: {
  value: CvTemplateId;
  onChange: (id: CvTemplateId) => void;
}) {
  const templates = getCvTemplates();

  return (
    <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
      {templates.map((t) => {
        const selected = t.id === value;
        return (
          <button
            key={t.id}
            type="button"
            onClick={() => onChange(t.id)}
            className={[
              "text-left rounded-xl border p-3 hover:bg-[var(--bg-soft)] transition",
              selected ? "border-[var(--brand)] ring-2 ring-[var(--brand)]/20" : "border-[var(--border)]",
            ].join(" ")}
          >
            <div className="relative w-full aspect-[4/3] rounded-lg overflow-hidden bg-white border border-[var(--border)]">
              <Image
                src={t.previewSrc}
                alt={t.label}
                fill
                className="object-cover"
                sizes="(max-width: 768px) 50vw, 33vw"
              />
            </div>

            <div className="mt-2">
              <div className="flex items-center justify-between gap-2">
                <p className="font-medium text-[var(--ink)]">{t.label}</p>
                {selected ? (
                  <span className="text-[10px] px-2 py-1 rounded-full bg-[var(--brand)]/10 text-[var(--brand)] border border-[var(--brand)]/20">
                    Sélectionné
                  </span>
                ) : null}
              </div>
              <p className="text-[11px] text-[var(--muted)] mt-1">{t.description}</p>
            </div>
          </button>
        );
      })}
    </div>
  );
}
````

## File: components/HeroPage.tsx
````typescript
// components/HeroPage.tsx (par ex.)
"use client";

import { useI18n } from "@/context/I18nContext";

export default function HeroPage() {
  const { t } = useI18n();

  return (
    <div className="glass rounded-2xl border border-[var(--border)]/80 p-6">
      <h1 className="text-xl font-semibold">{t("heroTitle")}</h1>
      <p className="mt-2 text-sm text-[var(--muted)]">{t("heroSubtitle")}</p>

      <div className="mt-4 flex gap-2">
        <button className="btn-primary">{t("startFree")}</button>
        <button className="btn-secondary">{t("alreadyHaveAccount")}</button>
      </div>
    </div>
  );
}
````

## File: components/I18nClientProvider.tsx
````typescript
// components/I18nClientProvider.tsx
"use client";

import "@/lib/i18n"; // initialise i18n une fois
import { ReactNode, useEffect } from "react";
import i18n from "@/lib/i18n";

export default function I18nClientProvider({ children }: { children: ReactNode }) {
  // Optionnel : mettre <html lang> et RTL
  useEffect(() => {
    const apply = (lng: string) => {
      document.documentElement.lang = lng;
      document.documentElement.dir = lng === "ar" ? "rtl" : "ltr";
    };

    apply(i18n.language);
    i18n.on("languageChanged", apply);
    return () => {
      i18n.off("languageChanged", apply);
    };
  }, []);

  return <>{children}</>;
}
````

## File: components/LandingFeatures.tsx
````typescript
"use client";

import { motion } from "framer-motion";

const features = [
  {
    title: "CV IA optimisé",
    desc: "Importe ton CV PDF, laisse Gemini en extraire le profil et génère un CV optimisé."
  },
  {
    title: "Lettres sur-mesure",
    desc: "Colle une offre, obtiens une lettre adaptée à ton profil et à l'entreprise ciblée."
  },
  {
    title: "Suivi simplifié",
    desc: "Garde une trace de toutes tes candidatures avec un tracker clair et visuel."
  }
];

export default function LandingFeatures() {
  return (
    <section className="px-4 sm:px-8 pb-6">
      <div className="max-w-6xl mx-auto grid gap-3 md:grid-cols-3">
        {features.map((f, idx) => (
          <motion.div
            key={f.title}
            initial={{ opacity: 0, y: 8 }}
            whileInView={{ opacity: 1, y: 0 }}
            viewport={{ once: true, amount: 0.4 }}
            transition={{ duration: 0.2, delay: idx * 0.05 }}
            className="glass p-4 text-sm"
          >
            <h3 className="text-sm font-semibold mb-1">{f.title}</h3>
            <p className="text-xs text-[var(--muted)]">{f.desc}</p>
          </motion.div>
        ))}
      </div>
    </section>
  );
}
````

## File: components/LandingHero.tsx
````typescript
"use client";

import { motion } from "framer-motion";
import Link from "next/link";

export default function LandingHero() {
  return (
    <section className="px-4 sm:px-8 pt-8 pb-6">
      <div className="max-w-6xl mx-auto flex flex-col gap-6 md:flex-row md:items-center">
        <motion.div
          initial={{ opacity: 0, y: 12 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.25 }}
          className="flex-1"
        >
          <p className="badge-muted mb-3">
            <span className="w-1 h-1 rounded-full bg-emerald-400" />
            <span>IA appliquée aux candidatures</span>
          </p>
          <h1 className="text-2xl sm:text-3xl md:text-4xl font-semibold leading-tight mb-3">
            Ton bureau de candidature, piloté par l&apos;IA.
          </h1>
          <p className="text-sm sm:text-base text-[var(--muted)] max-w-xl mb-4">
            Importe ton CV, génère des lettres de motivation ciblées, prépare ton pitch oral
            et suis toutes tes candidatures depuis un seul espace, pensé pour les profils tech
            et cybersécurité.
          </p>
          <div className="flex flex-wrap gap-2">
            <Link href="/signup" className="btn-primary text-xs sm:text-sm">
              Essayer gratuitement
            </Link>
            <Link href="/login" className="btn-secondary text-xs sm:text-sm">
              Se connecter
            </Link>
          </div>
        </motion.div>

        <motion.div
          initial={{ opacity: 0, y: 12 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.25, delay: 0.05 }}
          className="flex-1"
        >
          <div className="glass p-4 text-xs text-[var(--muted)]">
            <p className="mb-2 text-[11px] uppercase tracking-[0.18em]">
              Aperçu temps réel
            </p>
            <p>
              Un tableau de bord unique pour ton CV, tes LM, ton pitch et ton suivi de
              candidatures. Design inspiré de ton interface actuelle, en Next.js + Tailwind CSS
              + Framer Motion.
            </p>
          </div>
        </motion.div>
      </div>
    </section>
  );
}
````

## File: components/LandingPage.tsx
````typescript
"use client";

import Link from "next/link";
import { motion } from "framer-motion";
import { useRef, useState, type UIEvent, useEffect, type MouseEvent } from "react";
import { useRouter } from "next/navigation";
import { onAuthStateChanged, type User } from "firebase/auth";
import { auth } from "@/lib/firebase";

const fadeUp = (delay = 0) => ({
  initial: { opacity: 0, y: 20 },
  whileInView: { opacity: 1, y: 0 },
  transition: { duration: 0.4, delay },
  viewport: { once: false, amount: 0.4 },
});

const SECTION_IDS: string[] = ["hero", "features", "how", "pricing", "stack", "faq"];

export default function LandingPage() {
  const scrollRef = useRef<HTMLDivElement | null>(null);
  const [progress, setProgress] = useState(0);
  const [activeSection, setActiveSection] = useState<string>("hero");

  // 🔐 état d'auth Firebase
  const [currentUser, setCurrentUser] = useState<User | null>(null);
  const [navigating, setNavigating] = useState(false);
  const router = useRouter();

  useEffect(() => {
    const unsub = onAuthStateChanged(auth, (user) => {
      setCurrentUser(user);
    });
    return () => unsub();
  }, []);

  const handleSmartLoginClick = () => {
    if (navigating) return;
    setNavigating(true);
    if (currentUser) router.push("/app");
    else router.push("/login");
  };

  const handleScroll = (e: UIEvent<HTMLDivElement>) => {
    const el = e.currentTarget;
    const maxScroll = el.scrollHeight - el.clientHeight;

    if (maxScroll <= 0) setProgress(0);
    else setProgress((el.scrollTop / maxScroll) * 100);

    const containerRect = el.getBoundingClientRect();
    let closestId: string = activeSection;
    let minDelta = Infinity;

    SECTION_IDS.forEach((id) => {
      const sec = document.getElementById(id) as HTMLElement | null;
      if (!sec) return;
      const rect = sec.getBoundingClientRect();
      const delta = Math.abs(rect.top - containerRect.top);
      if (delta < minDelta) {
        minDelta = delta;
        closestId = id;
      }
    });

    if (closestId !== activeSection) setActiveSection(closestId);
  };

  const baseNavLink =
    "relative inline-flex items-center gap-1 text-[11px] px-2 py-1 rounded-full transition-colors";

  const scrollToSection = (id: string) => (e: MouseEvent<HTMLAnchorElement>) => {
    e.preventDefault();
    const sec = document.getElementById(id);
    if (sec) sec.scrollIntoView({ behavior: "smooth", block: "start" });
  };

  return (
    <div className="relative min-h-screen bg-[var(--bg)] text-[var(--ink)] flex flex-col overflow-x-hidden">
      {/* Background premium */}
      <div className="hero-bg" />
      <div className="noise" />

      {/* NAVBAR FIXE */}
      <header className="relative z-40 fixed top-0 left-0 right-0 bg-[var(--bg)]/90 backdrop-blur-xl">
        <div className="max-w-6xl mx-auto px-4 sm:px-8 h-14 flex items-center justify-between">
          {/* Logo + titre */}
          <div className="flex items-center gap-2">
            <div className="w-8 h-8 rounded-2xl bg-gradient-to-br from-[var(--brand)] to-[var(--brandDark)] shadow-lg shadow-[var(--brand)]/30 flex items-center justify-center text-[11px] font-semibold">
              AI
            </div>
            <div className="flex flex-col leading-tight">
              <span className="text-[11px] uppercase tracking-[0.22em] text-[var(--muted)]">
                Assistant candidatures
              </span>
              <span className="text-xs font-medium">Smart CV · LM · Pitch</span>
            </div>
          </div>

          {/* Liens + CTA */}
          <nav className="hidden sm:flex items-center gap-4 text-[11px]">
            {[
              ["hero", "Accueil"],
              ["features", "Fonctionnalités"],
              ["how", "Comment ça marche"],
              ["pricing", "Tarifs"],
              ["stack", "Tech"],
              ["faq", "Questions fréquentes"],
            ].map(([id, label]) => (
              <a
                key={id}
                href={`#${id}`}
                onClick={scrollToSection(id)}
                className={
                  activeSection === id
                    ? `${baseNavLink} bg-[var(--bg-soft)] text-[var(--ink)]`
                    : `${baseNavLink} text-[var(--muted)] hover:text-[var(--ink)]`
                }
              >
                {activeSection === id && (
                  <span className="inline-flex w-1.5 h-1.5 rounded-full bg-[var(--brand)] animate-pulse" />
                )}
                <span>{label}</span>
              </a>
            ))}
          </nav>

          <div className="flex items-center gap-2">
            <button
              type="button"
              onClick={handleSmartLoginClick}
              disabled={navigating}
              className="hidden sm:inline-flex text-[11px] text-[var(--muted)] hover:text-[var(--ink)] disabled:opacity-50"
            >
              Se connecter
            </button>

            <Link
              href="/signup"
              className="inline-flex items-center justify-center text-[11px] sm:text-xs px-3 sm:px-4 py-1.5 rounded-full bg-[var(--brand)] hover:bg-[var(--brandDark)] text-white shadow-lg shadow-[var(--brand)]/40 transition-colors"
            >
              Essayer gratuitement
            </Link>
          </div>
        </div>
      </header>

      {/* CONTENU */}
      <div className="relative z-10 flex-1 pt-14">
        {/* Barre de progression */}
        <div className="hidden md:block h-[2px] w-full bg-[var(--border)]/40 sticky top-14 z-30">
          <div
            className="scroll-progress-bar h-full bg-[var(--brand)] transition-[width] duration-150"
            style={{ width: `${progress}%` }}
          />
        </div>

        <main
          ref={scrollRef}
          onScroll={handleScroll}
          className="
            snap-none 
            md:snap-y md:snap-mandatory
            md:h-[calc(100vh-3.5rem-2px)] md:overflow-y-scroll
            scroll-smooth
          "
        >
          {/* HERO */}
          <section
            id="hero"
            className="md:snap-start md:min-h-[calc(100vh-3.5rem-2px)] flex items-center px-4 sm:px-8 py-10 md:py-0"
          >
            <div className="max-w-6xl mx-auto grid gap-8 md:grid-cols-[1.1fr,0.9fr] items-center">
              <motion.div {...fadeUp(0)}>
                <div className="inline-flex items-center gap-2 rounded-full border border-[var(--border)] bg-[var(--bg-soft)] px-2 py-1 mb-4">
                  <span className="inline-flex h-4 w-4 rounded-full bg-emerald-400/20 border border-emerald-400/50">
                    <span className="m-auto h-2 w-2 rounded-full bg-emerald-400" />
                  </span>
                  <span className="text-[11px] text-[var(--muted)]">
                    Gagne jusqu&apos;à{" "}
                    <span className="text-[var(--ink)] font-medium">4h par semaine</span>{" "}
                    sur tes candidatures.
                  </span>
                </div>

                <h1 className="text-[1.9rem] sm:text-3xl md:text-[2.6rem] font-semibold leading-tight mb-3">
                  L&apos;assistant IA pour candidater comme un pro,
                  <span className="text-[var(--brand)]"> sans y passer tes soirées.</span>
                </h1>

                <p className="text-sm sm:text-base text-[var(--muted)] max-w-xl mb-5">
                  Importe ton CV, colle une offre d’emploi, laisse l’IA générer une lettre de motivation
                  ciblée, un pitch oral et suis toutes tes candidatures depuis un tableau de bord unique.
                </p>

                <div className="flex flex-wrap items-center gap-3 mb-4">
                  <Link href="/signup" className="btn-primary text-xs sm:text-sm">
                    Essayer gratuitement
                  </Link>

                  <button
                    type="button"
                    onClick={handleSmartLoginClick}
                    disabled={navigating}
                    className="btn-secondary text-xs sm:text-sm disabled:opacity-50"
                  >
                    Se connecter
                  </button>
                </div>

                <p className="text-[11px] text-[var(--muted)]">
                  Aucun CB requise • Crédits offerts à l’inscription • Pensé pour les profils tech & cybersécurité
                </p>
              </motion.div>

              <motion.div {...fadeUp(0.1)} className="relative">
                <div className="glass rounded-2xl p-4 text-[11px] sm:text-xs shadow-2xl shadow-black/60 border border-[var(--border)]/80">
                  <div className="flex items-center justify-between mb-3">
                    <div>
                      <p className="text-[10px] uppercase tracking-[0.18em] text-[var(--muted)]">
                        Aperçu du dashboard
                      </p>
                      <p className="text-xs font-medium mt-1">
                        CV, lettres, pitch & suivi en un coup d&apos;œil.
                      </p>
                    </div>
                    <span className="px-2 py-1 rounded-full bg-emerald-400/10 text-emerald-300 border border-emerald-400/40 text-[10px]">
                      IA activée
                    </span>
                  </div>

                  <div className="grid gap-2 sm:grid-cols-3 mb-3">
                    <div className="rounded-xl bg-[var(--bg-soft)] border border-[var(--border)]/80 px-3 py-2">
                      <p className="text-[10px] text-[var(--muted)] mb-1">Crédits restants</p>
                      <p className="text-lg font-semibold">124</p>
                      <p className="text-[10px] text-[var(--muted)]">~ 30 lettres + 15 pitchs</p>
                    </div>
                    <div className="rounded-xl bg-[var(--bg-soft)] border border-[var(--border)]/80 px-3 py-2">
                      <p className="text-[10px] text-[var(--muted)] mb-1">Candidatures envoyées</p>
                      <p className="text-lg font-semibold">18</p>
                      <p className="text-[10px] text-[var(--muted)]">5 en entretien 🔥</p>
                    </div>
                    <div className="rounded-xl bg-[var(--bg-soft)] border border-[var(--border)]/80 px-3 py-2">
                      <p className="text-[10px] text-[var(--muted)] mb-1">Temps économisé</p>
                      <p className="text-lg font-semibold">7h / semaine</p>
                      <p className="text-[10px] text-[var(--muted)]">vs candidatures manuelles</p>
                    </div>
                  </div>

                  <div className="rounded-xl bg-gradient-to-br from-[var(--bg-soft)] to-[var(--card-elevated)] border border-[var(--border)]/90 p-3 space-y-2">
                    <div className="flex items-center justify-between text-[10px] text-[var(--muted)]">
                      <span>Offre · Ingénieur cybersécurité</span>
                      <span>
                        Match profil :{" "}
                        <span className="text-emerald-300 font-semibold">92%</span>
                      </span>
                    </div>
                    <div className="h-1.5 w-full rounded-full bg-[var(--bg-soft)] overflow-hidden">
                      <div className="h-full w-[92%] bg-gradient-to-r from-emerald-400 to-[var(--brand)]" />
                    </div>
                    <div className="flex flex-wrap gap-2 text-[10px]">
                      <span className="px-2 py-1 rounded-full bg-emerald-400/10 text-emerald-200 border border-emerald-400/40">
                        LM générée
                      </span>
                      <span className="px-2 py-1 rounded-full bg-[var(--brand)]/10 text-[var(--brand)] border border-[var(--brand)]/40">
                        Pitch prêt
                      </span>
                      <span className="px-2 py-1 rounded-full bg-[var(--bg-soft)] text-[var(--muted)] border border-[var(--border)]/70">
                        Suivi : En cours
                      </span>
                    </div>
                  </div>
                </div>

                <div className="pointer-events-none absolute -inset-10 -z-10 bg-[radial-gradient(circle_at_top,_rgba(88,166,255,0.35),_transparent_60%),radial-gradient(circle_at_bottom,_rgba(16,185,129,0.2),_transparent_55%)] opacity-80" />
              </motion.div>
            </div>
          </section>

          {/* FEATURES */}
          <section
            id="features"
            className="md:snap-start md:min-h-[calc(100vh-3.5rem-2px)] flex items-center px-4 sm:px-8 py-10 md:py-0"
          >
            <div className="max-w-6xl mx-auto w-full">
              <motion.div
                {...fadeUp(0)}
                className="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-3 mb-6"
              >
                <div>
                  <p className="text-[11px] uppercase tracking-[0.22em] text-[var(--muted)] mb-1">
                    Pensé pour ton quotidien
                  </p>
                  <h2 className="text-lg sm:text-xl font-semibold">
                    Tout ce dont tu as besoin pour candidater au calme.
                  </h2>
                </div>
              </motion.div>

              <div className="grid gap-4 md:grid-cols-3">
                {[
                  {
                    title: "CV IA optimisé",
                    desc: "Importe ton CV PDF, l’IA extrait ton profil et te propose une version claire et impactante pour les recruteurs.",
                  },
                  {
                    title: "Lettres ciblées",
                    desc: "Colle une offre d’emploi, l’assistant adapte ta lettre à l’entreprise, au poste et à ton parcours.",
                  },
                  {
                    title: "Pitch d’entretien",
                    desc: "Génère un pitch oral structuré pour te présenter en 30 à 90 secondes en entretien ou en réseautage.",
                  },
                  {
                    title: "Tracker de candidatures",
                    desc: "Garde la main sur tout : qui t’a répondu, où tu en es, quelles relances tu dois faire.",
                  },
                  {
                    title: "Historique IA",
                    desc: "Retrouve facilement tes lettres, tes pitchs et les versions de ton CV, sans te perdre dans les dossiers.",
                  },
                  {
                    title: "Crédits flexibles",
                    desc: "Des packs adaptés à ton rythme : quelques candidatures ciblées ou une vraie campagne d’attaque.",
                  },
                ].map((f, i) => (
                  <motion.div
                    key={f.title}
                    {...fadeUp(0.05 * i)}
                    className="glass card-hover p-4 border border-[var(--border)]/80 hover:border-[var(--brand)]/60 transition-colors"
                  >
                    <h3 className="text-sm font-semibold mb-1">{f.title}</h3>
                    <p className="text-[11px] sm:text-xs text-[var(--muted)]">{f.desc}</p>
                  </motion.div>
                ))}
              </div>
            </div>
          </section>

          {/* HOW / PRICING / STACK / FAQ */}
          {/* ➜ garde ton code tel quel ici (inchangé) */}
        </main>
      </div>
    </div>
  );
}
````

## File: components/LandingStack.tsx
````typescript
"use client";

import { motion } from "framer-motion";
import Link from "next/link";

export default function LandingStack() {
  return (
    <section className="px-4 sm:px-8 pb-10">
      <div className="max-w-6xl mx-auto glass p-4 sm:p-5">
        <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-3">
          <div>
            <p className="badge-muted mb-1">
              <span>Stack technique</span>
            </p>
            <h2 className="text-sm sm:text-base font-semibold">
              Une stack moderne pour une expérience fluide
            </h2>
          </div>
          <Link href="/tech" className="text-[11px] text-[var(--brand)] underline">
            Voir les détails techniques
          </Link>
        </div>
        <div className="grid gap-3 sm:grid-cols-3 text-xs sm:text-sm">
          <motion.div
            initial={{ opacity: 0, y: 8 }}
            whileInView={{ opacity: 1, y: 0 }}
            viewport={{ once: true }}
            transition={{ duration: 0.2 }}
          >
            <p className="font-semibold mb-1">Frontend · React / Next.js</p>
            <p className="text-[var(--muted)]">
              Framework JavaScript moderne pour construire une interface rapide,
              SEO-friendly et bien routée.
            </p>
          </motion.div>
          <motion.div
            initial={{ opacity: 0, y: 8 }}
            whileInView={{ opacity: 1, y: 0 }}
            viewport={{ once: true }}
            transition={{ duration: 0.2, delay: 0.05 }}
          >
            <p className="font-semibold mb-1">Styling · Tailwind CSS</p>
            <p className="text-[var(--muted)]">
              Un framework utilitaire qui permet de décliner ton design sombre actuel
              dans une grille cohérente et responsive.
            </p>
          </motion.div>
          <motion.div
            initial={{ opacity: 0, y: 8 }}
            whileInView={{ opacity: 1, y: 0 }}
            viewport={{ once: true }}
            transition={{ duration: 0.2, delay: 0.1 }}
          >
            <p className="font-semibold mb-1">Animations · Framer Motion</p>
            <p className="text-[var(--muted)]">
              Des transitions douces et maîtrisées pour donner vie aux cartes,
              modales et panneaux comme dans ton design original.
            </p>
          </motion.div>
        </div>
      </div>
    </section>
  );
}
````

## File: components/layout/AppHeader.tsx
````typescript
"use client";

import { ReactNode } from "react";
import { Menu, Bell, Search, Command } from "lucide-react";

interface AppHeaderProps {
  title: string;
  description?: string;
  creditsBadge?: ReactNode;
  userBadge?: ReactNode; // Le bouton avatar/profil
  onToggleSidebar: () => void;
}

export function AppHeader({
  title,
  description,
  creditsBadge,
  userBadge,
  onToggleSidebar,
}: AppHeaderProps) {
  return (
    <header className="sticky top-0 z-30 w-full border-b border-[var(--border)]/50 bg-[var(--bg)]/80 backdrop-blur-xl transition-all">
      <div className="flex h-16 items-center justify-between px-4 sm:px-6 lg:px-8">
        
        {/* GAUCHE : Toggle Mobile + Titre */}
        <div className="flex items-center gap-4">
          <button
            type="button"
            onClick={onToggleSidebar}
            className="md:hidden -ml-2 p-2 rounded-lg text-[var(--muted)] hover:text-[var(--ink)] hover:bg-[var(--bg-soft)] transition-colors"
          >
            <Menu className="h-5 w-5" />
          </button>

          <div className="flex flex-col">
            <h1 className="text-sm font-semibold text-[var(--ink)] tracking-tight">
              {title}
            </h1>
            {description && (
              <span className="text-[10px] text-[var(--muted)] hidden sm:block">
                {description}
              </span>
            )}
          </div>
        </div>

        {/* CENTRE : Barre de recherche fake (Optionnel pour effet "App") */}
        <div className="hidden md:flex items-center justify-center flex-1 max-w-md mx-4">
          <button className="w-full flex items-center justify-between px-3 py-1.5 rounded-lg border border-[var(--border)] bg-[var(--bg-soft)]/50 text-[var(--muted)] text-xs hover:border-[var(--border)]/80 hover:bg-[var(--bg-soft)] transition-all group">
            <div className="flex items-center gap-2">
              <Search className="h-3.5 w-3.5 group-hover:text-[var(--ink)]" />
              <span>Rechercher...</span>
            </div>
            <div className="flex items-center gap-1 opacity-50">
              <Command className="h-3 w-3" />
              <span>K</span>
            </div>
          </button>
        </div>

        {/* DROITE : Actions */}
        <div className="flex items-center gap-3 sm:gap-4">
          {/* Credits Badge */}
          <div className="hidden sm:block">
            {creditsBadge}
          </div>

          {/* Notifications */}
          <button className="relative p-2 rounded-full text-[var(--muted)] hover:bg-[var(--bg-soft)] hover:text-[var(--ink)] transition-colors">
            <Bell className="h-4 w-4" />
            <span className="absolute top-2 right-2 h-2 w-2 rounded-full bg-red-500 border-2 border-[var(--bg)]" />
          </button>

          {/* Séparateur */}
          <div className="h-6 w-px bg-[var(--border)]" />

          {/* User Menu Trigger */}
          {userBadge}
        </div>
      </div>
    </header>
  );
}
````

## File: components/layout/AppLayout.tsx
````typescript
"use client";

import { ReactNode, useEffect, useState } from "react";
import Link from "next/link";
import { usePathname, useRouter } from "next/navigation";
import { useAuth } from "@/context/AuthContext";
import { db } from "@/lib/firebase";
import { doc, onSnapshot } from "firebase/firestore";

const navLinks = [
  { href: "/app", label: "Profil CV IA", icon: "📄" },
  { href: "/app/lm", label: "Assistant candidature", icon: "✨" },
  { href: "/app/tracker", label: "Suivi candidatures", icon: "📊" },
  { href: "/app/interview", label: "Préparer entretien", icon: "🎤" },
  { href: "/app/apply", label: "Postuler", icon: "📨" },
  { href: "/app/history", label: "Historique IA", icon: "🕒" },
  { href: "/app/credits", label: "Crédits", icon: "⚡" },
];

export default function UserAppLayout({ children }: { children: ReactNode }) {
  const { user, loading, logout } = useAuth();
  const router = useRouter();
  const pathname = usePathname();
  const [sidebarOpen, setSidebarOpen] = useState(false);

  // ✅ flag pour être sûr qu'on est côté client
  const [clientReady, setClientReady] = useState(false);
  useEffect(() => {
    setClientReady(true);
  }, []);

  // ✅ Crédits utilisateur (Firestorm)
  const [credits, setCredits] = useState<number | null>(null);

  // 🔒 Protection des routes /app : login + email vérifié
  useEffect(() => {
    if (!clientReady) return;
    if (loading) return;

    if (!user) {
      router.replace("/login");
      return;
    }

    if (!user.emailVerified) {
      router.replace("/auth/verify-email");
      return;
    }
  }, [clientReady, user, loading, router]);

  // 🛡 Surveillance du doc user : blocage + crédits
  useEffect(() => {
    if (!clientReady) return;
    if (!user) return;

    const ref = doc(db, "users", user.uid);

    const unsub = onSnapshot(
      ref,
      (snap) => {
        const data = snap.data() as any | undefined;

        // blocage
        if (data?.blocked) {
          logout()
            .catch((e) =>
              console.error("Erreur déconnexion après blocage :", e)
            )
            .finally(() => {
              router.replace("/login?blocked=1");
            });
          return;
        }

        // crédits
        if (typeof data?.credits === "number") {
          setCredits(data.credits);
        } else {
          setCredits(0);
        }
      },
      (err) => {
        console.error("Erreur surveillance utilisateur :", err);
      }
    );

    return () => {
      unsub();
    };
  }, [clientReady, user, logout, router]);

  // ferme le menu mobile au changement de page
  useEffect(() => {
    setSidebarOpen(false);
  }, [pathname]);

  // ⚠️ Tant qu'on n'est pas prêt ou pas autorisé → on ne rend PAS le dashboard
  if (!clientReady || loading || !user || !user.emailVerified) {
    return null;
  }

  const handleLogout = async () => {
    try {
      await logout();
      router.replace("/login");
    } catch (e) {
      console.error("Erreur déconnexion :", e);
    }
  };

  const currentNav = navLinks.find(
    (link) =>
      pathname === link.href || pathname.startsWith(link.href + "/")
  );
  const pageTitle = currentNav?.label ?? "Espace candidat";

  const CreditsBadge =
    credits === null ? null : (
      <div className="inline-flex items-center gap-1 rounded-full px-2 py-1 text-[11px] bg-[var(--bg-soft)] border border-[var(--border)]/80 text-[var(--ink)]">
        <span className="text-[13px]">⚡</span>
        <span>
          <span className="font-semibold">{credits}</span> crédits
        </span>
      </div>
    );

  return (
    <div className="min-h-screen flex bg-[var(--bg)] text-[var(--ink)]">
      {/* SIDEBAR DESKTOP */}
      <aside className="hidden md:flex w-60 shrink-0 flex-col border-r border-[var(--border)] bg-[var(--bg-soft)]/60">
        <div className="flex items-center gap-2 px-3 py-4 border-b border-[var(--border)]/70">
          <Link href="/app" className="flex items-center gap-2">
            <div className="w-9 h-9 rounded-2xl bg-[var(--brand)]/10 border border-[var(--brand)]/40 flex items-center justify-center text-lg">
              ⚡
            </div>
            <div className="flex flex-col">
              <span className="text-xs font-semibold">
                Assistant Candidature IA
              </span>
              <span className="text-[10px] text-[var(--muted)]">
                Espace candidat
              </span>
            </div>
          </Link>
        </div>

        <nav className="flex-1 px-2 py-3 space-y-1 text-[13px] overflow-y-auto">
          {navLinks.map((link) => {
            const active =
              pathname === link.href ||
              pathname.startsWith(link.href + "/");
            return (
              <Link
                key={link.href}
                href={link.href}
                className={[
                  "flex items-center gap-2 rounded-lg px-2 py-1.5 transition-colors border border-transparent",
                  active
                    ? "bg-[var(--bg)] text-[var(--ink)] border-[var(--brand)]/60"
                    : "text-[var(--muted)] hover:text-[var(--ink)] hover:bg-[var(--bg-soft)]",
                ].join(" ")}
              >
                <span className="w-5 text-center text-[13px]">
                  {link.icon}
                </span>
                <span>{link.label}</span>
              </Link>
            );
          })}
        </nav>

        <div className="border-t border-[var(--border)]/70 px-3 py-3 text-[11px] flex flex-col gap-2">
          {/* Badge crédits dans le bas de la sidebar */}
          {CreditsBadge}

          {user?.email && (
            <p className="text-[var(--muted)]">
              Connecté·e :{" "}
              <span className="font-medium text-[var(--ink)]">
                {user.email}
              </span>
            </p>
          )}
          <button
            type="button"
            onClick={handleLogout}
            className="w-full text-[11px] rounded-full border border-[var(--border)] px-3 py-1.5 bg-[var(--bg)] hover:border-red-500 hover:text-red-300 transition-colors"
          >
            Se déconnecter
          </button>
        </div>
      </aside>

      {/* COLONNE CONTENU */}
      <div className="flex-1 flex flex-col relative">
        <div className="pointer-events-none absolute inset-0 -z-10 bg-[radial-gradient(circle_at_top,_rgba(56,189,248,0.16),_transparent_55%),radial-gradient(circle_at_bottom,_rgba(94,234,212,0.12),_transparent_55%)]" />

        {/* TOPBAR */}
        <header className="sticky top-0 z-30 border-b border-[var(--border)]/80 bg-[var(--bg)]/95 backdrop-blur">
          <div className="flex items-center justify-between gap-3 px-3 sm:px-6 py-3">
            <div className="flex items-center gap-3">
              <button
                type="button"
                aria-label="Ouvrir la navigation"
                onClick={() => setSidebarOpen(true)}
                className="md:hidden rounded-full p-2 bg-[var(--bg-soft)] border border-[var(--border)]/80 shadow-sm focus:outline-none focus:ring-2 focus:ring-[var(--brand)]/60"
              >
                <div className={`menu-icon1 ${sidebarOpen ? "is-open" : ""}`}>
                  <div className="menu-icon1_line-top"></div>
                  <div className="menu-icon1_line-middle">
                    <div className="menu-icon1_line-middle-inner"></div>
                  </div>
                  <div className="menu-icon1_line-bottom"></div>
                </div>
              </button>

              <div className="flex flex-col">
                <span className="text-[11px] font-medium uppercase tracking-wide text-[var(--muted)]">
                  Tableau de bord
                </span>
                <span className="text-sm font-semibold">{pageTitle}</span>
              </div>
            </div>

            <div className="flex items-center gap-3">
              {/* Badge crédits visible dans la topbar */}
              {CreditsBadge}

              {user?.email && (
                <span className="hidden sm:inline text-[11px] text-[var(--muted)]">
                  {user.email}
                </span>
              )}
              <button
                type="button"
                onClick={handleLogout}
                className="text-[11px] rounded-full border border-[var(--border)] px-3 py-1.5 bg-[var(--bg-soft)] hover:border-red-500 hover:text-red-300 transition-colors"
              >
                Se déconnecter
              </button>
            </div>
          </div>
        </header>

        <main className="flex-1 overflow-y-auto">
          <div className="px-3 sm:px-6 lg:px-8 py-4 lg:py-6">
            <div className="max-w-6xl mx-auto space-y-4">{children}</div>
          </div>
        </main>
      </div>

      {/* MENU MOBILE (DRAWER) */}
      <div
        className={`fixed inset-0 z-40 md:hidden transition ${
          sidebarOpen ? "pointer-events-auto" : "pointer-events-none"
        }`}
      >
        <div
          className={`absolute inset-0 bg-black/50 transition-opacity ${
            sidebarOpen ? "opacity-100" : "opacity-0"
          }`}
          onClick={() => setSidebarOpen(false)}
        />

        <div
          className={`absolute left-0 top-0 h-full w-64 bg-[var(--bg)] border-r border-[var(--border)] shadow-xl transform transition-transform ${
            sidebarOpen ? "translate-x-0" : "-translate-x-full"
          }`}
        >
          <div className="flex items-center justify-between px-3 py-3 border-b border-[var(--border)]/80">
            <div className="flex items-center gap-2">
              <div className="menu-icon1">
                <div className="menu-icon1_line-top"></div>
                <div className="menu-icon1_line-middle">
                  <div className="menu-icon1_line-middle-inner"></div>
                </div>
                <div className="menu-icon1_line-bottom"></div>
              </div>
              <div className="flex flex-col">
                <span className="text-xs font-semibold">Menu</span>
                <span className="text-[10px] text-[var(--muted)]">
                  Navigation
                </span>
              </div>
            </div>
            <button
              type="button"
              onClick={() => setSidebarOpen(false)}
              className="text-[11px] rounded-full border border-[var(--border)] px-2 py-1 hover:bg-[var(--bg-soft)]"
            >
              ✕
            </button>
          </div>

          <nav className="px-2 py-3 flex flex-col gap-1 text-[13px] overflow-y-auto">
            {navLinks.map((link) => {
              const active =
                pathname === link.href ||
                pathname.startsWith(link.href + "/");
              return (
                <Link
                  key={link.href}
                  href={link.href}
                  className={[
                    "flex items-center gap-2 rounded-lg px-2 py-1.5 transition-colors border border-transparent",
                    active
                      ? "bg-[var(--bg)] text-[var(--ink)] border-[var(--brand)]/60"
                      : "text-[var(--muted)] hover:text-[var(--ink)] hover:bg-[var(--bg-soft)]",
                  ].join(" ")}
                >
                  <span className="w-5 text-center text-[13px]">
                    {link.icon}
                  </span>
                  <span>{link.label}</span>
                </Link>
              );
            })}
          </nav>

          <div className="border-t border-[var(--border)]/70 px-3 py-3 text-[11px] space-y-2">
            {/* Badge crédits aussi dans le menu mobile */}
            {CreditsBadge}

            {user?.email && (
              <p className="mb-1 text-[var(--muted)]">
                Connecté·e :{" "}
                <span className="font-medium text-[var(--ink)]">
                  {user.email}
                </span>
              </p>
            )}
            <button
              type="button"
              onClick={handleLogout}
              className="w-full text-[11px] rounded-full border border-[var(--border)] px-3 py-1.5 bg-[var(--bg)] hover:border-red-500 hover:text-red-300 transition-colors"
            >
              Se déconnecter
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}
````

## File: components/layout/MobileBottomNav.tsx
````typescript
"use client";

export function MobileBottomNav() {
  return null;
}
````

## File: components/PaymentHeader.jsx
````javascript
"use client";

import { useEffect } from "react";

export default function PaymentHeader({ onClose, autoCloseMs = 0 }) {
  useEffect(() => {
    if (!autoCloseMs) return;
    const t = setTimeout(() => onClose?.(), autoCloseMs);
    return () => clearTimeout(t);
  }, [autoCloseMs, onClose]);

  return (
    <div className="flex items-center justify-between px-4 py-2 border-b border-[var(--border)]/70 bg-[var(--bg-soft)]/80">
      <div className="flex flex-col">
        <span className="text-[12px] font-semibold text-[var(--ink)]">
          Paiement sécurisé
        </span>
        <span className="text-[11px] text-[var(--muted)]">
          Transaction gérée par Polar (Stripe)
        </span>
      </div>

      <button
        type="button"
        onClick={onClose}
        className="text-[11px] rounded-full border border-[var(--border)] px-2 py-1 hover:bg-[var(--bg)]"
        aria-label="Fermer"
      >
        ✕
      </button>
    </div>
  );
}
````

## File: components/pdf/PdfEditorModal.tsx
````typescript
"use client";

import { ReactNode } from "react";
import { motion } from "framer-motion";
import PdfViewer from "./PdfViewer";

type Props = {
  open: boolean;
  title: string;
  subtitle?: string;
  fileUrl: string | null;

  onClose: () => void;

  // ✅ jamais d’auto-download : on télécharge uniquement sur clic
  onDownload: () => void;
  downloadDisabled?: boolean;

  leftPanel?: ReactNode; // ton éditeur (CV ou LM)
};

export default function PdfEditorModal({
  open,
  title,
  subtitle,
  fileUrl,
  onClose,
  onDownload,
  downloadDisabled,
  leftPanel,
}: Props) {
  if (!open) return null;

  return (
    <div className="fixed inset-0 z-[80]">
      <div className="absolute inset-0 bg-black/70" onClick={onClose} />

      <motion.div
        initial={{ opacity: 0, y: 10, scale: 0.985 }}
        animate={{ opacity: 1, y: 0, scale: 1 }}
        transition={{ duration: 0.18 }}
        className="absolute inset-2 sm:inset-4 rounded-2xl border border-[var(--border)] bg-[var(--bg)] shadow-2xl overflow-hidden flex flex-col"
        role="dialog"
        aria-modal="true"
      >
        {/* Header */}
        <div className="flex items-center justify-between gap-2 p-3 sm:p-4 border-b border-[var(--border)] bg-[var(--bg-soft)]">
          <div>
            <p className="text-[13px] font-semibold text-[var(--ink)]">{title}</p>
            {subtitle ? <p className="text-[11px] text-[var(--muted)]">{subtitle}</p> : null}
          </div>

          <div className="flex items-center gap-2">
            <button
              type="button"
              className="btn-secondary !py-2 !px-3 text-[12px]"
              onClick={onClose}
            >
              Fermer
            </button>

            <button
              type="button"
              className="btn-primary !py-2 !px-3 text-[12px]"
              disabled={downloadDisabled}
              onClick={onDownload}
            >
              Télécharger
            </button>
          </div>
        </div>

        {/* Body full height */}
        <div className="flex-1 min-h-0 grid grid-cols-1 lg:grid-cols-[440px_1fr]">
          {/* Left editor */}
          <div className="min-h-0 overflow-auto border-b lg:border-b-0 lg:border-r border-[var(--border)] bg-[var(--bg)] p-3 sm:p-4">
            {leftPanel ? (
              leftPanel
            ) : (
              <div className="text-[12px] text-[var(--muted)]">
                Aucun éditeur fourni.
              </div>
            )}
          </div>

          {/* Right preview */}
          <div className="min-h-0 overflow-auto bg-[var(--bg)] p-3 sm:p-4">
            <PdfViewer fileUrl={fileUrl} />
          </div>
        </div>
      </motion.div>
    </div>
  );
}
````

## File: components/pdf/PdfViewer.tsx
````typescript
"use client";

import { useEffect, useMemo, useRef, useState } from "react";
import { Document, Page, pdfjs } from "react-pdf";

// ✅ Worker pdf.js (Next 14 OK)
pdfjs.GlobalWorkerOptions.workerSrc = new URL(
  "pdfjs-dist/build/pdf.worker.min.mjs",
  import.meta.url
).toString();

type Props = {
  fileUrl: string | null; // objectURL (Blob) ou URL
  className?: string;
};

export default function PdfViewer({ fileUrl, className }: Props) {
  const wrapRef = useRef<HTMLDivElement | null>(null);
  const [wrapW, setWrapW] = useState(900);

  const [numPages, setNumPages] = useState(1);
  const [page, setPage] = useState(1);
  const [zoom, setZoom] = useState(1);

  useEffect(() => {
    if (!wrapRef.current) return;
    const el = wrapRef.current;

    const ro = new ResizeObserver(() => {
      const w = Math.floor(el.getBoundingClientRect().width);
      if (w > 50) setWrapW(w);
    });
    ro.observe(el);
    return () => ro.disconnect();
  }, []);

  useEffect(() => {
    // reset quand on change de fichier
    setPage(1);
    setZoom(1);
  }, [fileUrl]);

  const canPrev = page > 1;
  const canNext = page < numPages;

  const width = useMemo(() => {
    // un peu de marge interne
    return Math.max(200, Math.floor(wrapW - 24));
  }, [wrapW]);

  if (!fileUrl) {
    return (
      <div className={`rounded-xl border border-[var(--border)] bg-[var(--bg)] p-4 text-[12px] text-[var(--muted)] ${className || ""}`}>
        Aucun aperçu pour l’instant.
      </div>
    );
  }

  return (
    <div ref={wrapRef} className={className}>
      {/* Toolbar custom (pas celle de Chrome) */}
      <div className="flex flex-wrap items-center justify-between gap-2 rounded-xl border border-[var(--border)] bg-[var(--bg-soft)] px-3 py-2">
        <div className="flex items-center gap-2 text-[11px] text-[var(--muted)]">
          <button
            type="button"
            className="btn-secondary !py-1 !px-2 text-[11px]"
            disabled={!canPrev}
            onClick={() => setPage((p) => Math.max(1, p - 1))}
          >
            ←
          </button>
          <span className="min-w-[80px] text-center">
            Page <span className="font-medium text-[var(--ink)]">{page}</span> / {numPages}
          </span>
          <button
            type="button"
            className="btn-secondary !py-1 !px-2 text-[11px]"
            disabled={!canNext}
            onClick={() => setPage((p) => Math.min(numPages, p + 1))}
          >
            →
          </button>
        </div>

        <div className="flex items-center gap-2">
          <button
            type="button"
            className="btn-secondary !py-1 !px-2 text-[11px]"
            onClick={() => setZoom((z) => Math.max(0.6, +(z - 0.1).toFixed(2)))}
          >
            −
          </button>
          <span className="text-[11px] text-[var(--muted)] w-[54px] text-center">
            {(zoom * 100).toFixed(0)}%
          </span>
          <button
            type="button"
            className="btn-secondary !py-1 !px-2 text-[11px]"
            onClick={() => setZoom((z) => Math.min(2.0, +(z + 0.1).toFixed(2)))}
          >
            +
          </button>

          <button
            type="button"
            className="btn-secondary !py-1 !px-3 text-[11px]"
            onClick={() => setZoom(1)}
          >
            100%
          </button>
        </div>
      </div>

      <div className="mt-2 rounded-xl border border-[var(--border)] bg-white overflow-auto p-3">
        <Document
          file={fileUrl}
          loading={<div className="text-[12px] text-[var(--muted)]">Chargement du PDF…</div>}
          onLoadSuccess={(info) => {
            setNumPages(info.numPages || 1);
            setPage(1);
          }}
          onLoadError={(e) => console.error("PDF load error:", e)}
        >
          <Page
            pageNumber={page}
            width={width}
            scale={zoom}
            renderTextLayer={false}
            renderAnnotationLayer={false}
            loading={<div className="text-[12px] text-[var(--muted)]">Rendu…</div>}
          />
        </Document>
      </div>
    </div>
  );
}
````

## File: components/PolarCheckoutModal.jsx
````javascript
"use client";

import { useEffect } from "react";
import PaymentHeader from "./PaymentHeader";

export default function PolarCheckoutModal({ open, url, onClose, onDone }) {
  useEffect(() => {
    if (!open) return;

    function handleMessage(e) {
      // On accepte uniquement les messages venant de NOTRE domaine
      if (e.origin !== window.location.origin) return;

      const data = e.data;
      if (!data || typeof data !== "object") return;
      if (data.type !== "POLAR_CHECKOUT_DONE") return;

      onDone?.(data.status);
      onClose?.();
    }

    window.addEventListener("message", handleMessage);
    return () => window.removeEventListener("message", handleMessage);
  }, [open, onClose, onDone]);

  if (!open) return null;

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/40 p-4">
      <div className="w-full max-w-3xl overflow-hidden rounded-2xl bg-white shadow-xl">
        <PaymentHeader onClose={onClose} />

        <div className="h-[80vh] bg-white">
          {url ? (
            <iframe
              title="Polar checkout"
              src={url}
              className="h-full w-full"
              allow="payment *"
            />
          ) : (
            <div className="p-4 text-sm">Chargement…</div>
          )}
        </div>
      </div>
    </div>
  );
}
````

## File: components/SidebarUser.tsx
````typescript
"use client";

import Link from "next/link";
import { usePathname } from "next/navigation";
import { useState } from "react";

type AppLink = {
  href: string;
  label: string;
  icon?: string;
};

// Liens principaux
const MAIN_LINKS: AppLink[] = [
  { href: "/app", label: "Profil CV IA", icon: "📄" },
  { href: "/app/lm", label: "Assistant candidature", icon: "✨" },
  { href: "/app/tracker", label: "Suivi candidatures", icon: "📊" },
  { href: "/app/interview", label: "Préparer entretien", icon: "🎤" },
  { href: "/app/apply", label: "Postuler", icon: "📨" },
  { href: "/app/history", label: "Historique IA", icon: "🕒" },
  { href: "/app/credits", label: "Crédits", icon: "⚡" },
];

const SETTINGS_LINK: AppLink = {
  href: "/app/settings",
  label: "Paramètres",
  icon: "⚙️",
};

export default function SidebarUser() {
  const pathname = usePathname();

  // Desktop collapse
  const [collapsed, setCollapsed] = useState(false);

  // Mobile sidebar
  const [mobileOpen, setMobileOpen] = useState(false);

  const baseItem =
    "flex items-center gap-2 rounded-lg px-2 py-1.5 text-[11px] transition-colors";

  const isLinkActive = (href: string) =>
    pathname === href || pathname.startsWith(href + "/");

  return (
    <>
      {/* === BOUTON HAMBURGER MOBILE === */}
      <button
        className="menu-icon1 md:hidden fixed top-3 left-3 z-50"
        onClick={() => setMobileOpen((o) => !o)}
      >
        <div className="menu-icon1_line-top"></div>
        <div className="menu-icon1_line-middle">
          <div className="menu-icon1_line-middle-inner"></div>
        </div>
        <div className="menu-icon1_line-bottom"></div>
      </button>

      {/* === OVERLAY MOBILE (clic pour fermer) === */}
      {mobileOpen && (
        <div
          className="fixed inset-0 bg-black/40 backdrop-blur-sm z-40 md:hidden"
          onClick={() => setMobileOpen(false)}
        ></div>
      )}

      {/* === SIDEBAR === */}
      <aside
        className={`
          bg-[var(--bg-soft)]
          border-r border-[var(--border)]/80
          h-screen
          flex flex-col
          sticky top-0
          z-50
          transition-all duration-300

          md:w-[210px] md:relative md:translate-x-0
          ${collapsed ? "md:w-[60px]" : "md:w-[210px]"}
          
          /* Mobile offcanvas */
          fixed top-0 left-0 w-[230px]
          md:static
          ${mobileOpen ? "translate-x-0" : "-translate-x-full"}
        `}
      >
        {/* Header Desktop (bouton collapse) */}
        <div className="hidden md:flex items-center justify-start px-2 py-3 border-b border-[var(--border)]/70">
          <button
            type="button"
            onClick={() => setCollapsed((c) => !c)}
            aria-label={collapsed ? "Déplier navigation" : "Replier navigation"}
            className="menu-icon1 inline-flex items-center justify-center w-7 h-7 rounded-lg border border-[var(--border)] bg-[var(--bg)] text-[var(--muted)] hover:text-[var(--ink)] hover:bg-[var(--bg-soft)] text-[11px]"
          >
            {collapsed ? "»" : "«"}
          </button>
        </div>

        {/* Mobile : petit espace en haut */}
        <div className="md:hidden h-[60px]"></div>

        {/* Liens */}
        <nav className="flex-1 px-2 py-3 flex flex-col gap-1 overflow-y-auto">
          {MAIN_LINKS.map((link) => {
            const active = isLinkActive(link.href);
            return (
              <Link
                key={link.href}
                href={link.href}
                onClick={() => setMobileOpen(false)} // fermer sidebar mobile
                className={
                  active
                    ? `${baseItem} bg-[var(--bg)] text-[var(--ink)] border border-[var(--brand)]/60`
                    : `${baseItem} text-[var(--muted)] hover:text-[var(--ink)] hover:bg-[var(--bg)]`
                }
              >
                <span className="w-5 text-center text-[12px]">
                  {link.icon ?? "•"}
                </span>
                {!collapsed && <span>{link.label}</span>}
              </Link>
            );
          })}
        </nav>

        {/* Paramètres */}
        <div className="px-2 py-3 border-t border-[var(--border)]/70">
          <Link
            href={SETTINGS_LINK.href}
            onClick={() => setMobileOpen(false)}
            className={
              isLinkActive(SETTINGS_LINK.href)
                ? `${baseItem} bg-[var(--bg)] text-[var(--ink)] border border-[var(--brand)]/60`
                : `${baseItem} text-[var(--muted)] hover:text-[var(--ink)] hover:bg-[var(--bg)]`
            }
          >
            <span className="w-5 text-center text-[12px]">
              {SETTINGS_LINK.icon}
            </span>
            {!collapsed && <span>{SETTINGS_LINK.label}</span>}
          </Link>
        </div>
      </aside>
    </>
  );
}
````

## File: components/TopbarUser.tsx
````typescript
"use client";

import Link from "next/link";
import { useRouter } from "next/navigation";
import { useAuth } from "@/context/AuthContext";

export default function TopbarUser() {
  const router = useRouter();
  const { user, logout } = useAuth();

  const handleLogout = async () => {
    try {
      await logout(); // ou ton signOut(auth) dans le contexte
      router.push("/login");
    } catch (err) {
      console.error("Erreur déconnexion :", err);
    }
  };

  // On privilégie le displayName (Prénom Nom)
  const displayName =
    user?.displayName ||
    (user?.email ? user.email.split("@")[0] : "Utilisateur");

  return (
    <header className="sticky top-0 z-30 bg-[var(--bg)]/90 backdrop-blur-xl border-b border-[var(--border)]/70">
      <div className="max-w-6xl mx-auto px-4 sm:px-8 h-14 flex items-center justify-between gap-4">
        {/* Logo + mini titre à gauche */}
        <Link href="/app" className="flex items-center gap-2 shrink-0">
          <div className="w-8 h-8 rounded-2xl bg-gradient-to-br from-[var(--brand)] to-[var(--brandDark)] shadow-lg shadow-[var(--brand)]/30 flex items-center justify-center text-[11px] font-semibold">
            AI
          </div>
          <div className="hidden sm:flex flex-col leading-tight">
            <span className="text-[11px] uppercase tracking-[0.22em] text-[var(--muted)]">
              Assistant candidatures
            </span>
            <span className="text-xs font-medium">Espace connecté</span>
          </div>
        </Link>

        {/* À droite : connecté en tant que + bouton déconnexion */}
        <div className="flex items-center gap-3 ml-auto">
          {user && (
            <div className="flex flex-col items-end leading-tight text-[10px] sm:text-[11px]">
              <span className="text-[var(--muted)] hidden sm:inline">
                Connecté·e en tant que
              </span>
              <span className="text-[var(--ink)] font-medium max-w-[160px] truncate">
                {displayName}
              </span>
            </div>
          )}

          <button
            type="button"
            onClick={handleLogout}
            className="inline-flex items-center justify-center text-[11px] sm:text-[12px] px-3 py-1.5 rounded-full border border-[var(--border)] bg-[var(--bg-soft)] hover:bg-[var(--bg)] text-[var(--muted)] hover:text-[var(--ink)] transition-colors"
          >
            Se déconnecter
          </button>
        </div>
      </div>
    </header>
  );
}
````

## File: components/ui/DebugI18nTheme.tsx
````typescript
"use client";
import { useTheme } from "@/context/ThemeContext";
import { useI18n } from "@/context/I18nContext";

export function DebugI18nTheme() {
  const { theme, toggleTheme } = useTheme();
  const { lang, setLang } = useI18n();

  return (
    <div style={{ position: "fixed", bottom: 12, left: 12, zIndex: 50, padding: 8, background: "rgba(0,0,0,0.6)", color: "white", borderRadius: 10, fontSize: 12 }}>
      <div>theme: {theme}</div>
      <div>lang: {lang}</div>
      <div style={{ display: "flex", gap: 6, marginTop: 6 }}>
        <button onClick={toggleTheme}>toggle theme</button>
        <button onClick={() => setLang("fr")}>FR</button>
        <button onClick={() => setLang("en")}>EN</button>
      </div>
    </div>
  );
}
````

## File: components/ui/Starfield.tsx
````typescript
// components/ui/Starfield.tsx
"use client";

import { useEffect, useRef } from "react";
import { useTheme } from "@/context/ThemeContext";

type Star = {
  x: number;
  y: number;
  radius: number;
  alpha: number;
  speed: number;
};

export const Starfield = () => {
  const canvasRef = useRef<HTMLCanvasElement | null>(null);
  const { theme } = useTheme();

  useEffect(() => {
    const canvas = canvasRef.current;
    if (!canvas) return;

    const ctx = canvas.getContext("2d");
    if (!ctx) return;

    let width = window.innerWidth;
    let height = window.innerHeight;
    let stars: Star[] = [];
    let animationId: number;

    const resize = () => {
      width = window.innerWidth;
      height = window.innerHeight;
      canvas.width = width;
      canvas.height = height;
      createStars();
    };

    const createStars = () => {
      const count = Math.floor((width * height) / 9000);
      stars = [];
      for (let i = 0; i < count; i++) {
        stars.push({
          x: Math.random() * width,
          y: Math.random() * height,
          radius: Math.random() * 1.4 + 0.3,
          alpha: Math.random(),
          speed: Math.random() * 0.4 + 0.05,
        });
      }
    };

    const draw = () => {
      const isLight = theme === "light";

      // ✅ on efface seulement → fond TRANSPARENT
      ctx.clearRect(0, 0, width, height);

      ctx.save();
      ctx.globalCompositeOperation = "lighter";

      for (const star of stars) {
        star.alpha += star.speed * 0.01;
        if (star.alpha > 1) star.alpha = 0.2;

        ctx.beginPath();
        ctx.arc(star.x, star.y, star.radius, 0, Math.PI * 2);
        ctx.fillStyle = isLight
          ? `rgba(37, 99, 235, ${star.alpha})`
          : `rgba(129, 140, 248, ${star.alpha})`;
        ctx.fill();
      }

      ctx.restore();
      animationId = requestAnimationFrame(draw);
    };

    window.addEventListener("resize", resize);
    resize();
    draw();

    return () => {
      window.removeEventListener("resize", resize);
      cancelAnimationFrame(animationId);
    };
  }, [theme]);

  return (
    <canvas
      ref={canvasRef}
      className="starry-background"
    />
  );
};
````

## File: components/ui/ThemeLangSwitcher.tsx
````typescript
// components/ui/ThemeLangSwitcher.tsx
"use client";

import { useEffect, useMemo, useState } from "react";
import { useTheme } from "@/context/ThemeContext";
import { useTranslation } from "react-i18next";
import i18n from "@/lib/i18n";

type Lang = "fr" | "en";

const LANGS: { code: Lang; label: string }[] = [
  { code: "fr", label: "FR" },
  { code: "en", label: "EN" },
];

export function ThemeLangSwitcher() {
  const { theme, toggleTheme } = useTheme();
  useTranslation(); // force le re-render quand la langue change
  const [open, setOpen] = useState(false);

  const currentLang = useMemo<Lang>(() => {
    const lng = (i18n.resolvedLanguage || i18n.language || "fr")
      .toLowerCase()
      .slice(0, 2);
    return (lng === "en" ? "en" : "fr") as Lang;
  }, [i18n.resolvedLanguage, i18n.language]);

  // ferme le menu si on clique ailleurs
  useEffect(() => {
    const onClick = () => setOpen(false);
    if (!open) return;
    window.addEventListener("click", onClick);
    return () => window.removeEventListener("click", onClick);
  }, [open]);

  const setLang = (lng: Lang) => {
    i18n.changeLanguage(lng);
    setOpen(false);
  };

  return (
    <div className="flex items-center gap-2" onClick={(e) => e.stopPropagation()}>
      {/* Langues */}
      <div className="relative">
        <button
          type="button"
          onClick={() => setOpen((v) => !v)}
          className="flex items-center gap-1 rounded-full border border-[var(--border)] px-2 py-1 text-[11px] bg-[var(--bg-soft)]"
          aria-label="Changer la langue"
        >
          🌐 <span>{currentLang.toUpperCase()}</span>
        </button>

        {open && (
          <div className="absolute right-0 mt-1 w-20 rounded-xl bg-[var(--bg-soft)] border border-[var(--border)]/80 shadow-xl text-[11px] overflow-hidden">
            {LANGS.map((l) => (
              <button
                key={l.code}
                type="button"
                className={`block w-full text-left px-2 py-1 hover:bg-[var(--bg)] ${
                  l.code === currentLang
                    ? "text-[var(--brand)]"
                    : "text-[var(--muted)]"
                }`}
                onClick={() => setLang(l.code)}
              >
                {l.label}
              </button>
            ))}
          </div>
        )}
      </div>

      {/* Thème */}
      <button
        type="button"
        onClick={toggleTheme}
        className="rounded-full border border-[var(--border)] px-2 py-1 text-[12px] bg-[var(--bg-soft)]"
        aria-label="Changer le thème"
      >
        {theme === "light" ? "🌞" : "🌙"}
      </button>
    </div>
  );
}
````

## File: components/user/CreditsBadge.tsx
````typescript
"use client";

import { useUserCredits } from "@/hooks/useUserCredits";

export function CreditsBadge() {
  const { credits, loading } = useUserCredits();

  return (
    <div className="inline-flex items-center gap-1 rounded-full px-2 py-1 text-[11px] bg-[var(--bg-soft)] border border-[var(--border)]/80 text-[var(--ink)]">
      <span className="text-[13px]">⚡</span>
      {loading ? (
        <span className="opacity-70">Chargement…</span>
      ) : (
        <span>
          <span className="font-semibold">{credits}</span> crédits
        </span>
      )}
    </div>
  );
}
````

## File: context/AuthContext.tsx
````typescript
"use client";

import {
  createContext,
  useContext,
  useEffect,
  useState,
  type ReactNode,
} from "react";
import {
  onIdTokenChanged,
  signOut,
  type User,
  getIdTokenResult,
} from "firebase/auth";
import { auth, db } from "@/lib/firebase";
import { doc, getDoc } from "firebase/firestore";

type AuthContextType = {
  user: User | null;
  loading: boolean;
  isAdmin: boolean;
  blocked: boolean;
  logout: () => Promise<void>;
};

const AuthContext = createContext<AuthContextType>({
  user: null,
  loading: true,
  isAdmin: false,
  blocked: false,
  logout: async () => {},
});

export function AuthProvider({ children }: { children: ReactNode }) {
  const [user, setUser] = useState<User | null>(null);
  const [loading, setLoading] = useState(true);
  const [isAdmin, setIsAdmin] = useState(false);
  const [blocked, setBlocked] = useState(false);

  useEffect(() => {
    const unsub = onIdTokenChanged(auth, async (firebaseUser) => {
      setLoading(true);

      // Déconnecté
      if (!firebaseUser) {
        setUser(null);
        setIsAdmin(false);
        // IMPORTANT: on ne force pas blocked=false ici,
        // comme ça si un compte vient d’être rejeté car bloqué,
        // la page /login peut garder le message.
        setLoading(false);
        return;
      }

      // 1) ✅ Vérif Firestore AVANT d’exposer user
      try {
        const ref = doc(db, "users", firebaseUser.uid);
        const snap = await getDoc(ref);
        const data = snap.data() as any | undefined;

        if (data?.blocked) {
          // 🔒 Compte bloqué : on rejette la session AVANT toute redirection / rendu /app
          setBlocked(true);
          setUser(null);
          setIsAdmin(false);
          setLoading(false);

          try {
            await signOut(auth);
          } catch (e) {
            console.error("Erreur signOut (blocked):", e);
          }
          return;
        }

        // Compte OK → on reset blocked
        setBlocked(false);
      } catch (e) {
        // 🔐 Par sécurité + pour éviter le flash,
        // si la vérif Firestore plante, on refuse la session.
        console.error("Erreur vérification blocked:", e);

        setBlocked(true);
        setUser(null);
        setIsAdmin(false);
        setLoading(false);

        try {
          await signOut(auth);
        } catch (err) {
          console.error("Erreur signOut (firestore check failed):", err);
        }
        return;
      }

      // 2) ✅ Admin claims (après validation blocked)
      try {
        const tokenResult = await getIdTokenResult(firebaseUser, true);
        const claims = tokenResult.claims || {};
        const adminFlag =
          claims.isAdmin === true || claims.email === "aakane0105@gmail.com";
        setIsAdmin(adminFlag);
      } catch (e) {
        console.error("Erreur récupération des custom claims:", e);
        setIsAdmin(false);
      }

      // 3) ✅ On expose user seulement maintenant
      setUser(firebaseUser);
      setLoading(false);
    });

    return () => unsub();
  }, []);

  const logout = async () => {
    // logout volontaire => on efface le statut blocked UI
    setBlocked(false);
    await signOut(auth);
  };

  return (
    <AuthContext.Provider value={{ user, loading, isAdmin, blocked, logout }}>
      {children}
    </AuthContext.Provider>
  );
}

export function useAuth() {
  return useContext(AuthContext);
}
````

## File: context/CreditsContext.tsx
````typescript
"use client";

import { createContext, useContext, useEffect, useState } from "react";
import { useAuth } from "@/context/AuthContext";
// TODO: brancher Firestore pour écouter les crédits en temps réel

interface CreditsContextValue {
  credits: number | null;
}

const CreditsContext = createContext<CreditsContextValue>({
  credits: null
});

export function CreditsProvider({ children }: { children: React.ReactNode }) {
  const { user } = useAuth();
  const [credits, setCredits] = useState<number | null>(null);

  useEffect(() => {
    if (!user) {
      setCredits(null);
      return;
    }
    // TODO: écouter doc Firestore "users/{uid}" et lire le champ credits
  }, [user]);

  return (
    <CreditsContext.Provider value={{ credits }}>
      {children}
    </CreditsContext.Provider>
  );
}

export const useCredits = () => useContext(CreditsContext);
````

## File: context/I18nContext.tsx
````typescript
// context/I18nContext.tsx
"use client";

import React, {
  createContext,
  useContext,
  useEffect,
  useState,
  type ReactNode,
} from "react";

export type LangCode = "fr" | "en" | "ar" | "zh";

type I18nContextValue = {
  lang: LangCode;
  setLang: (lang: LangCode) => void;
  t: (key: string) => string;
};

const I18nContext = createContext<I18nContextValue | undefined>(undefined);

const LANG_KEY = "acv-lang";

const translations: Record<LangCode, Record<string, string>> = {
  fr: {
    appTitle: "Assistant Candidatures V4",
    heroTitle:
      "L'assistant IA pour candidater comme un pro, sans y passer tes soirées.",
    heroSubtitle:
      "Importe ton CV, colle une offre d’emploi, laisse l’IA générer une lettre ciblée, un pitch oral et suis toutes tes candidatures depuis un tableau de bord unique.",
    startFree: "Essayer gratuitement",
    alreadyHaveAccount: "J'ai déjà un compte",
    logout: "Se déconnecter",
    creditsShort: "Cr.",
  },
  en: {
    appTitle: "Job Application Assistant V4",
    heroTitle:
      "The AI assistant to apply like a pro, without spending your evenings on it.",
    heroSubtitle:
      "Upload your resume, paste a job offer, let the AI generate a tailored cover letter, an interview pitch and track all your applications from one dashboard.",
    startFree: "Start for free",
    alreadyHaveAccount: "I already have an account",
    logout: "Logout",
    creditsShort: "Cr.",
  },
  ar: {
    appTitle: "مساعد التقديم على الوظائف V4",
    heroTitle:
      "مساعدك بالذكاء الاصطناعي للتقديم باحتراف، بدون أن تضيع أمسياتك.",
    heroSubtitle:
      "ارفع سيرتك الذاتية، والصق عرض العمل، ودع الذكاء الاصطناعي يُنشئ رسالة تحفيز موجهة، و«بيتش» للمقابلة، مع تتبع لجميع طلباتك في لوحة تحكم واحدة.",
    startFree: "ابدأ مجانًا",
    alreadyHaveAccount: "لدي حساب بالفعل",
    logout: "تسجيل الخروج",
    creditsShort: "رصيد",
  },
  zh: {
    appTitle: "AI 求职助手 V4",
    heroTitle: "用 AI 像专业人士一样投递，而不用熬夜写材料。",
    heroSubtitle:
      "上传简历、粘贴职位描述，AI 为你生成定制求职信和自我介绍，并在一个看板里跟踪所有投递。",
    startFree: "免费开始",
    alreadyHaveAccount: "我已有账号",
    logout: "退出登录",
    creditsShort: "点数",
  },
};

export const I18nProvider = ({ children }: { children: ReactNode }) => {
  const [lang, setLangState] = useState<LangCode>("fr");

  useEffect(() => {
    const stored = localStorage.getItem(LANG_KEY) as LangCode | null;
    if (stored && translations[stored]) {
      setLangState(stored);
      document.documentElement.dir = stored === "ar" ? "rtl" : "ltr";
    }
  }, []);

  const setLang = (next: LangCode) => {
    setLangState(next);
    localStorage.setItem(LANG_KEY, next);
    document.documentElement.dir = next === "ar" ? "rtl" : "ltr";
  };

  const t = (key: string) => {
    return translations[lang]?.[key] ?? key;
  };

  return (
    <I18nContext.Provider value={{ lang, setLang, t }}>
      {children}
    </I18nContext.Provider>
  );
};

export const useI18n = () => {
  const ctx = useContext(I18nContext);
  if (!ctx) {
    throw new Error("useI18n must be used inside I18nProvider");
  }
  return ctx;
};
````

## File: context/ThemeContext.tsx
````typescript
// context/ThemeContext.tsx
"use client";

import React, {
  createContext,
  useContext,
  useEffect,
  useState,
  type ReactNode,
} from "react";

export type Theme = "light" | "dark";

type ThemeContextValue = {
  theme: Theme;
  toggleTheme: () => void;
  setTheme: (theme: Theme) => void;
};

const ThemeContext = createContext<ThemeContextValue | undefined>(undefined);

const THEME_KEY = "acv-theme";

export const ThemeProvider = ({ children }: { children: ReactNode }) => {
  const [theme, setThemeState] = useState<Theme>("dark");

  const applyThemeClass = (next: Theme) => {
    const root = document.documentElement;
    if (next === "light") root.classList.add("theme-light");
    else root.classList.remove("theme-light");
  };

  useEffect(() => {
    const stored = localStorage.getItem(THEME_KEY) as Theme | null;

    if (stored === "light" || stored === "dark") {
      setThemeState(stored);
      applyThemeClass(stored);
      return;
    }

    const prefersDark =
      window.matchMedia &&
      window.matchMedia("(prefers-color-scheme: dark)").matches;

    const initial: Theme = prefersDark ? "dark" : "light";
    setThemeState(initial);
    applyThemeClass(initial);
  }, []);

  const setTheme = (next: Theme) => {
    setThemeState(next);
    localStorage.setItem(THEME_KEY, next);
    applyThemeClass(next);
  };

  const toggleTheme = () => setTheme(theme === "light" ? "dark" : "light");

  return (
    <ThemeContext.Provider value={{ theme, toggleTheme, setTheme }}>
      {children}
    </ThemeContext.Provider>
  );
};

export const useTheme = () => {
  const ctx = useContext(ThemeContext);
  if (!ctx) throw new Error("useTheme must be used inside ThemeProvider");
  return ctx;
};
````

## File: firestore.indexes.json
````json
{
  "indexes": [
    {
      "collectionGroup": "applications",
      "queryScope": "COLLECTION",
      "fields": [
        { "fieldPath": "userId", "order": "ASCENDING" },
        { "fieldPath": "createdAt", "order": "DESCENDING" }
      ]
    }
  ],
  "fieldOverrides": []
}
````

## File: firestore.rules
````
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helpers ---
    function isSignedIn() {
      return request.auth != null;
    }

    function isAdmin() {
      return isSignedIn() && (
        request.auth.token.isAdmin == true ||
        request.auth.token.email == "aakane0105@gmail.com"
      );
    }

    // --- COLLECTION users ---
    match /users/{userId} {
      // L'utilisateur peut lire/écrire uniquement SON doc
      allow read, write: if isSignedIn() && request.auth.uid == userId;

      // L'admin peut tout lire/écrire
      allow read, write: if isAdmin();
    }

    // --- COLLECTION profiles ---
    match /profiles/{userId} {
      // L'utilisateur gère son profil
      allow read, write: if isSignedIn() && request.auth.uid == userId;

      // Admin peut tout lire/écrire
      allow read, write: if isAdmin();
    }

    // --- COLLECTION applications ---
    match /applications/{appId} {
      // Création d'une candidature : userId dans le doc = auth.uid
      allow create: if isSignedIn()
        && request.resource.data.userId == request.auth.uid;

      // Lecture / update / delete par le propriétaire
      allow read, update, delete: if isSignedIn()
        && resource.data.userId == request.auth.uid;

      // Admin : lecture/écriture si besoin (stats, corrections, etc.)
      allow read, write: if isAdmin();
    }

    // --- COLLECTION usageLogs ---
    match /usageLogs/{logId} {
      // 1) logs normaux d'un user connecté (LM, CV, etc.)
      // 2) logs d'échec de connexion (auth_failed) AVANT login (pas d'auth)
      allow create: if
        (
          isSignedIn() &&
          request.resource.data.userId == request.auth.uid
        )
        ||
        (
          !isSignedIn() &&
          request.resource.data.action == "auth_failed"
        );

      // lecture / modif / suppression : admin uniquement
      allow read, update, delete: if isAdmin();
    }

    // --- CATCH-ALL ADMIN ---
    match /{document=**} {
      allow read, write: if isAdmin();
    }
  }
}
````

## File: hooks/useAdminGuard.ts
````typescript
// src/hooks/useAdminGuard.ts
"use client";

import { useEffect } from "react";
import { useRouter, usePathname } from "next/navigation";
import type { User } from "firebase/auth";
import { useAuth } from "@/context/AuthContext";

// 👉 Emails qui sont admin "hardcodés" en plus du custom claim isAdmin
const ADMIN_EMAILS = ["aakane0105@gmail.com"];

export type UseAdminGuardResult = {
  loading: boolean;
  isAdmin: boolean;
  user: User | null;
};

export function useAdminGuard(): UseAdminGuardResult {
  const { user, loading, isAdmin: isAdminFromContext } = useAuth();
  const router = useRouter();
  const pathname = usePathname();

  // fallback : si jamais le claim n'est pas encore set, mais que l'email est dans la whitelist
  const email = (user?.email || "").toLowerCase();
  const hasAdminEmail = ADMIN_EMAILS.includes(email);

  const isAdmin = isAdminFromContext || hasAdminEmail;

  useEffect(() => {
    if (loading) return;

    const onAdminRoute = pathname?.startsWith("/admin");

    // Pas connecté et route /admin → renvoie vers /admin/login
    if (!user && onAdminRoute) {
      router.push("/admin/login");
      return;
    }

    // Connecté mais pas admin et route /admin (hors /admin/login) → renvoie vers /
    if (
      user &&
      !isAdmin &&
      onAdminRoute &&
      pathname !== "/admin/login"
    ) {
      router.push("/");
    }
  }, [user, loading, isAdmin, pathname, router]);

  return { loading, isAdmin, user };
}
````

## File: hooks/useRechargeHistory.ts
````typescript
"use client";

import { useEffect, useState } from "react";
import { collection, limit, onSnapshot, orderBy, query, Timestamp } from "firebase/firestore";
import { db } from "@/lib/firebase";
import { useAuth } from "@/context/AuthContext";

export type RechargeHistoryItem = {
  id: string;
  provider?: string;
  orderId?: string | null;
  checkoutId?: string | null;

  creditsAdded?: number;

  // si Polar renvoie des montants en cents (souvent), on stocke tel quel et on affiche /100
  amount?: number | null;
  currency?: string | null;

  status?: string | null;
  eventType?: string | null;

  productIds?: string[];
  priceIds?: string[];

  createdAt?: number; // ms
};

function toMillis(v: unknown): number | undefined {
  if (!v) return undefined;
  if (typeof v === "number") return v;
  if (v instanceof Date) return v.getTime();
  if (typeof v === "object" && (v as any).toMillis) return (v as Timestamp).toMillis();
  return undefined;
}

export function useRechargeHistory(maxItems = 30) {
  const { user } = useAuth();
  const [items, setItems] = useState<RechargeHistoryItem[]>([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    if (!user?.uid) {
      setItems([]);
      setLoading(false);
      setError(null);
      return;
    }

    setLoading(true);

    const q = query(
      collection(db, "users", user.uid, "rechargeHistory"),
      orderBy("createdAt", "desc"),
      limit(maxItems)
    );

    const unsub = onSnapshot(
      q,
      (snap) => {
        const list = snap.docs.map((d) => {
          const data = d.data() as any;
          return {
            id: d.id,
            ...data,
            createdAt: toMillis(data.createdAt),
          } as RechargeHistoryItem;
        });
        setItems(list);
        setLoading(false);
      },
      (e) => {
        console.error("useRechargeHistory:", e);
        setError(e?.message || "Erreur chargement historique");
        setLoading(false);
      }
    );

    return () => unsub();
  }, [user?.uid, maxItems]);

  return { items, loading, error };
}
````

## File: hooks/useUserCredits.ts
````typescript
"use client";

import { useEffect, useState } from "react";
import { doc, onSnapshot } from "firebase/firestore";
import { db } from "@/lib/firebase";
import { useAuth } from "@/context/AuthContext";

type CreditsState = {
  credits: number;
  loading: boolean;
  error: string | null;
};

export function useUserCredits(): CreditsState {
  const { user } = useAuth();
  const [credits, setCredits] = useState<number>(0);
  const [loading, setLoading] = useState<boolean>(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    // reset à chaque changement d'user
    setError(null);

    if (!user?.uid) {
      setCredits(0);
      setLoading(false);
      return;
    }

    setLoading(true);

    const ref = doc(db, "users", user.uid);

    const unsub = onSnapshot(
      ref,
      (snap) => {
        const data = snap.exists() ? (snap.data() as any) : {};
        const value = typeof data?.credits === "number" ? data.credits : 0;

        setCredits(value);
        setLoading(false);
      },
      (err) => {
        console.error("Erreur Firestore (credits):", err);
        setError("Impossible de charger les crédits.");
        setLoading(false);
      }
    );

    return () => unsub();
  }, [user?.uid]);

  return { credits, loading, error };
}
````

## File: hooks/useUserProfile.ts
````typescript
"use client";

import { useEffect, useState } from "react";
import { doc, onSnapshot } from "firebase/firestore";
import { db } from "@/lib/firebase";
import { useAuth } from "@/context/AuthContext";

export interface UserProfile {
  id: string;
  email?: string | null;
  displayName?: string | null;
  credits?: number;
  blocked?: boolean;
  ip?: string | null;
  city?: string | null;
  country?: string | null;
  emailVerified?: boolean;
  lastLoginAt?: Date | null;
  lastActiveAt?: Date | null;
}

export function useUserProfile() {
  const { user } = useAuth();
  const [profile, setProfile] = useState<UserProfile | null>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    if (!user) {
      setProfile(null);
      setLoading(false);
      return;
    }

    const ref = doc(db, "users", user.uid);

    const unsub = onSnapshot(
      ref,
      (snap) => {
        if (!snap.exists()) {
          setProfile({
            id: user.uid,
            email: user.email ?? null,
            displayName: user.displayName ?? null,
          });
          setLoading(false);
          return;
        }

        const data = snap.data() as any;

        const lastLoginAt =
          data.lastLoginAt?.toDate?.() &&
          typeof data.lastLoginAt.toDate === "function"
            ? data.lastLoginAt.toDate()
            : null;

        const lastActiveAt =
          data.lastActiveAt?.toDate?.() &&
          typeof data.lastActiveAt.toDate === "function"
            ? data.lastActiveAt.toDate()
            : null;

        const profile: UserProfile = {
          id: snap.id,
          email: data.email ?? user.email ?? null,
          displayName: data.displayName ?? user.displayName ?? null,
          credits:
            typeof data.credits === "number"
              ? data.credits
              : data.credits
              ? Number(data.credits)
              : undefined,
          blocked: data.blocked === true,
          ip: data.ip ?? null,
          city: data.city ?? null,
          country: data.country ?? null,
          emailVerified:
            typeof data.emailVerified === "boolean"
              ? data.emailVerified
              : user.emailVerified ?? false,
          lastLoginAt,
          lastActiveAt,
        };

        setProfile(profile);
        setLoading(false);
      },
      (error) => {
        console.error("Erreur onSnapshot user profile:", error);
        setProfile(null);
        setLoading(false);
      }
    );

    return () => unsub();
  }, [user]);

  return { profile, loading };
}
````

## File: lib/apiClient.ts
````typescript
"use client";

import { API_BASE, tryGetRecaptchaToken } from "@/lib/recaptcha";

type JsonHeaders = Record<string, string>;

function normalizePath(path: string) {
  return (path || "").replace(/^\/+/, "");
}

function buildRecaptchaError(action: string) {
  return new Error(
    `reCAPTCHA indisponible pour l’action "${action}". ` +
      `Vérifie : (1) NEXT_PUBLIC_RECAPTCHA_SITE_KEY, (2) script chargé, (3) adblock, (4) domaine autorisé côté Google.`
  );
}

export async function postJsonWithRecaptcha<T>(
  path: string,
  action: string,
  body: any,
  extraHeaders: JsonHeaders = {}
): Promise<T> {
  const token = await tryGetRecaptchaToken(action);
  if (!token) throw buildRecaptchaError(action);

  const res = await fetch(`${API_BASE}/${normalizePath(path)}`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-Recaptcha-Token": token,
      ...extraHeaders,
    },
    body: JSON.stringify({
      ...body,
      recaptchaToken: token, // ✅ compatible avec ton backend
      recaptchaAction: action,
    }),
    cache: "no-store",
  });

  const text = await res.text();
  let data: any = null;
  try {
    data = text ? JSON.parse(text) : null;
  } catch {
    // si le backend renvoie pas du JSON
  }

  if (!res.ok) {
    const msg =
      (data && (data.error || data.message)) ||
      text ||
      `HTTP ${res.status}`;
    throw new Error(msg);
  }

  return data as T;
}

export async function postBlobWithRecaptcha(
  path: string,
  action: string,
  body: any,
  extraHeaders: JsonHeaders = {}
): Promise<Blob> {
  const token = await tryGetRecaptchaToken(action);
  if (!token) throw buildRecaptchaError(action);

  const res = await fetch(`${API_BASE}/${normalizePath(path)}`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-Recaptcha-Token": token,
      ...extraHeaders,
    },
    body: JSON.stringify({
      ...body,
      recaptchaToken: token,
      recaptchaAction: action,
    }),
    cache: "no-store",
  });

  if (!res.ok) {
    const text = await res.text().catch(() => "");
    let data: any = null;
    try {
      data = text ? JSON.parse(text) : null;
    } catch {}
    const msg =
      (data && (data.error || data.message)) ||
      text ||
      `HTTP ${res.status}`;
    throw new Error(msg);
  }

  return await res.blob();
}
````

## File: lib/auth.ts
````typescript
"use client";

import { auth } from "./firebase";
import {
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  signOut,
  updateProfile,
  sendEmailVerification,
} from "firebase/auth";

export async function signupWithEmail(
  firstName: string,
  lastName: string,
  email: string,
  password: string
) {
  const cred = await createUserWithEmailAndPassword(auth, email, password);

  await updateProfile(cred.user, {
    displayName: `${firstName} ${lastName}`.trim(),
  });

  // 👉 ICI : on laisse Firebase envoyer son email standard
  await sendEmailVerification(cred.user);

  return cred;
}

export async function loginWithEmail(email: string, password: string) {
  return signInWithEmailAndPassword(auth, email, password);
}

export async function logout() {
  return signOut(auth);
}
````

## File: lib/credits.ts
````typescript
// src/lib/credits.ts
import {
  collection,
  doc,
  getDoc,
  getDocs,
  increment,
  query,
  setDoc,
  updateDoc,
  where,
} from "firebase/firestore";
import { db } from "@/lib/firebase";

/**
 * Ajoute des crédits à un utilisateur identifié par son userId (document users/{userId}).
 */
export async function addCreditsToUserById(
  userId: string,
  creditsToAdd: number
): Promise<void> {
  if (!userId) {
    console.error("[credits] userId manquant");
    return;
  }
  if (!creditsToAdd || creditsToAdd <= 0) {
    console.warn("[credits] creditsToAdd <= 0, rien à ajouter", {
      userId,
      creditsToAdd,
    });
    return;
  }

  const ref = doc(db, "users", userId);
  const snap = await getDoc(ref);

  if (!snap.exists()) {
    console.warn(
      "[credits] Doc user inexistant, création avec crédits initiaux",
      { userId, creditsToAdd }
    );
    await setDoc(ref, {
      credits: creditsToAdd,
      createdAt: new Date(),
    });
    return;
  }

  console.log("[credits] Ajout de crédits par userId", { userId, creditsToAdd });

  await updateDoc(ref, {
    credits: increment(creditsToAdd),
  });
}

/**
 * Ajoute des crédits à (tous) les utilisateurs qui ont cet email.
 * Fallback si on n’a pas externalId dans l’event Polar.
 */
export async function addCreditsToUserByEmail(
  email: string,
  creditsToAdd: number
): Promise<void> {
  if (!email) {
    console.error("[credits] email manquant");
    return;
  }
  if (!creditsToAdd || creditsToAdd <= 0) {
    console.warn("[credits] creditsToAdd <= 0, rien à ajouter", {
      email,
      creditsToAdd,
    });
    return;
  }

  const usersCol = collection(db, "users");
  const q = query(usersCol, where("email", "==", email));
  const qs = await getDocs(q);

  if (qs.empty) {
    console.warn(
      "[credits] Aucun user trouvé avec cet email, création impossible",
      { email, creditsToAdd }
    );
    return;
  }

  console.log(
    "[credits] Ajout de crédits par email (tous les users trouvés)",
    { email, creditsToAdd, count: qs.size }
  );

  const promises: Promise<any>[] = [];
  qs.forEach((docSnap) => {
    promises.push(
      updateDoc(docSnap.ref, {
        credits: increment(creditsToAdd),
      })
    );
  });

  await Promise.all(promises);
}

/**
 * Consomme des crédits pour un utilisateur.
 *
 * Pour être flexible avec ton code existant, cette fonction accepte :
 *  - consumeCredits(userId, 3)
 *  - consumeCredits({ userId: "xxx", amount: 3 })
 *  - consumeCredits({ userId: "xxx", credits: 3 })
 */
export async function consumeCredits(arg1: any, arg2?: any): Promise<void> {
  let userId: string | undefined;
  let toConsume = 0;

  if (typeof arg1 === "string") {
    userId = arg1;
    toConsume = typeof arg2 === "number" ? arg2 : 0;
  } else if (typeof arg1 === "object" && arg1 !== null) {
    userId = arg1.userId || arg1.uid;
    toConsume =
      arg1.amount ?? arg1.credits ?? arg1.count ?? arg1.nb ?? 0;
  }

  if (!userId || !toConsume || toConsume <= 0) {
    console.warn(
      "[credits] consumeCredits appelé sans paramètres valides",
      { arg1, arg2 }
    );
    return;
  }

  const ref = doc(db, "users", userId);
  const snap = await getDoc(ref);

  if (!snap.exists()) {
    console.warn(
      "[credits] user inexistant pour consumeCredits, aucun débit",
      { userId }
    );
    return;
  }

  console.log("[credits] Consommation de crédits", {
    userId,
    toConsume,
  });

  await updateDoc(ref, {
    credits: increment(-toConsume),
  });
}
````

## File: lib/firebaseAdmin.ts
````typescript
// lib/firebaseAdmin.ts
import admin from "firebase-admin";

if (!admin.apps.length) {
  const projectId = process.env.FIREBASE_PROJECT_ID;
  const clientEmail = process.env.FIREBASE_CLIENT_EMAIL;
  const rawPrivateKey = process.env.FIREBASE_PRIVATE_KEY;

  if (projectId && clientEmail && rawPrivateKey) {
    const privateKey = rawPrivateKey.replace(/\\n/g, "\n");
    try {
      admin.initializeApp({
        credential: admin.credential.cert({
          projectId,
          clientEmail,
          privateKey,
        }),
      });
      console.log("[firebaseAdmin] Initialisé avec les variables d'env");
    } catch (err) {
      console.error("[firebaseAdmin] Erreur d'initialisation :", err);
    }
  } else {
    console.warn(
      "[firebaseAdmin] Variables d'env manquantes. Admin ne sera pas initialisé (OK en DEV)."
    );
  }
}

export default admin;
````

## File: lib/i18n.ts
````typescript
// lib/i18n.ts
import i18n from "i18next";
import { initReactI18next } from "react-i18next";
import LanguageDetector from "i18next-browser-languagedetector";

import common_fr from "@/public/locales/fr/common.json";
import common_en from "@/public/locales/en/common.json";

const supportedLngs = ["fr", "en"] as const;

if (!i18n.isInitialized) {
  i18n
    .use(LanguageDetector) // détecte langue du navigateur + cache
    .use(initReactI18next)
    .init({
      resources: {
        fr: { common: common_fr },
        en: { common: common_en },
      },
      supportedLngs: [...supportedLngs],
      fallbackLng: "fr",

      defaultNS: "common",
      ns: ["common"],

      interpolation: { escapeValue: false },

      detection: {
        // ordre simple et fiable
        order: ["localStorage", "cookie", "navigator", "htmlTag"],
        caches: ["localStorage", "cookie"],
        lookupLocalStorage: "i18nextLng"
      },

      react: { useSuspense: false }
    });
}

export default i18n;
````

## File: lib/interviewPrompt.ts
````typescript
// lib/interviewPrompt.ts

// Canal de l'entretien : écrit (chat) ou oral (avec micro + TTS plus tard)
export type InterviewChannel = "written" | "oral";

// Niveau de difficulté / séniorité
export type InterviewLevel = "junior" | "intermediate" | "senior";

// Élément d'historique échangé pendant l'entretien
export type HistoryItem = {
  role: "interviewer" | "candidate";
  text: string;
  createdAt?: string; // <-- IMPORTANT pour ne plus avoir createdAt en rouge
  analysis?: string | null;
};

export type BuildPromptArgs = {
  cvSummary: string;
  jobDesc: string;
  mode: string; // "mixed" | "tech" | "rh" | "hard" etc.
  level: InterviewLevel;
  channel: InterviewChannel;
  history: HistoryItem[];
  step: number;
};

/**
 * Construit le prompt envoyé à Gemini pour générer :
 * - la prochaine question
 * - l'analyse rapide de la réponse précédente
 * - le résumé final + score quand l'IA estime avoir assez d'informations
 */
export function buildPrompt({
  cvSummary,
  jobDesc,
  mode,
  level,
  channel,
  history,
  step,
}: BuildPromptArgs): string {
  const historyText =
    history.length === 0
      ? "Aucun échange pour le moment (début d'entretien)."
      : history
          .map((h) => {
            const who =
              h.role === "interviewer" ? "INTERVIEWER" : "CANDIDAT";
            return `- [${who}] ${h.text}`;
          })
          .join("\n");

  let modeDescription = "";
  switch (mode) {
    case "tech":
      modeDescription =
        "Pose principalement des questions techniques (cloud, sécurité, réseau, etc.).";
      break;
    case "rh":
      modeDescription =
        "Pose surtout des questions RH, motivation, soft-skills, culture d'entreprise.";
      break;
    case "hard":
      modeDescription =
        "Sois très exigeant, avec des questions difficiles, de relance et de mise en situation.";
      break;
    default:
      modeDescription =
        "Mélange de questions techniques et RH/motivation.";
  }

  let levelDescription = "";
  switch (level) {
    case "junior":
      levelDescription =
        "Considère un profil plutôt junior : évalue le potentiel, la motivation et les bases techniques.";
      break;
    case "intermediate":
      levelDescription =
        "Considère un profil intermédiaire : quelques années d'expérience, autonomie moyenne.";
      break;
    case "senior":
      levelDescription =
        "Considère un profil senior : forte expertise, autonomie, leadership possible.";
      break;
  }

  const channelDescription =
    channel === "oral"
      ? "Le candidat répond à l'oral. Les questions doivent être plutôt courtes, conversationnelles, comme dans un vrai échange vocal."
      : "Le candidat répond à l'écrit via un chat. Tu peux poser des questions un peu plus détaillées mais reste concis.";

  return `
Tu joues le rôle d'un recruteur humain qui fait passer un entretien d'embauche en français.

Contexte candidat (résumé de CV) :
${cvSummary || "Non renseigné."}

Contexte poste (fiche de poste / offre) :
${jobDesc || "Non renseigné."}

Mode d'entretien : ${mode}
${modeDescription}

Niveau d'entretien : ${level}
${levelDescription}

Canal : ${channel}
${channelDescription}

Étape actuelle de l'entretien : ${step}
Historique des échanges (du plus ancien au plus récent) :
${historyText}

OBJECTIF :
- Poser des questions pertinentes par rapport au poste et au profil.
- Être honnête et exigeant sur la compatibilité avec la fiche de poste.
- Quand tu estimes avoir assez d'informations, produire un résumé final détaillé + un score global de compatibilité sur 100.

⚠️ TRÈS IMPORTANT : FORMAT DE RÉPONSE OBLIGATOIRE ⚠️
Tu dois répondre STRICTEMENT en JSON valide, sans texte autour, sans Markdown, sans commentaires, sans \`\`\`.

Format exact attendu :

{
  "next_question": string | null,
  "short_analysis": string | null,
  "final_summary": string | null,
  "final_score": number | null
}

Règles :
- Tant que l'entretien continue :
  - "next_question" = la prochaine question à poser au candidat (en français).
  - "short_analysis" = une analyse très courte (2-3 phrases max) de la dernière réponse du candidat.
  - "final_summary" = null
  - "final_score" = null
- Quand tu estimes que l'entretien est terminé :
  - "next_question" = null
  - "short_analysis" = une courte phrase de conclusion si tu veux
  - "final_summary" = un résumé structuré de la performance du candidat, points forts / points faibles, recommandation (oui / non / à voir).
  - "final_score" = un nombre entier de 0 à 100 représentant la compatibilité globale avec la fiche de poste.

Ta réponse DOIT être un JSON pur, directement parsable par JSON.parse en JavaScript.
  `.trim();
}
````

## File: lib/ipLocation.ts
````typescript
// lib/ipLocation.ts
// Récupère IP + pays + ville côté client, avec un petit cache en sessionStorage

export type ClientLocation = {
  ip: string | null;
  country: string | null;
  city: string | null;
};

let inMemoryLocation: ClientLocation | null = null;
let inFlightPromise: Promise<ClientLocation | null> | null = null;

function loadFromSession(): ClientLocation | null {
  if (typeof window === "undefined") return null;
  try {
    const raw = window.sessionStorage.getItem("smartcv_location_cache");
    if (!raw) return null;
    const parsed = JSON.parse(raw);
    if (
      typeof parsed === "object" &&
      parsed !== null &&
      "ip" in parsed &&
      "country" in parsed &&
      "city" in parsed
    ) {
      return parsed as ClientLocation;
    }
  } catch {
    // ignore
  }
  return null;
}

function saveToSession(loc: ClientLocation) {
  if (typeof window === "undefined") return;
  try {
    window.sessionStorage.setItem(
      "smartcv_location_cache",
      JSON.stringify(loc)
    );
  } catch {
    // ignore
  }
}

export async function getClientLocation(): Promise<ClientLocation | null> {
  if (typeof window === "undefined") return null;

  if (inMemoryLocation) return inMemoryLocation;

  const cached = loadFromSession();
  if (cached) {
    inMemoryLocation = cached;
    return cached;
  }

  if (inFlightPromise) return inFlightPromise;

  inFlightPromise = (async () => {
    try {
      const res = await fetch("https://ipapi.co/json/");
      if (!res.ok) throw new Error("IP API error");
      const data = await res.json();

      const loc: ClientLocation = {
        ip: data.ip || null,
        country: data.country_name || data.country || null,
        city: data.city || null,
      };

      inMemoryLocation = loc;
      saveToSession(loc);
      return loc;
    } catch (e) {
      console.error("Erreur getClientLocation:", e);
      const loc: ClientLocation = {
        ip: null,
        country: null,
        city: null,
      };
      inMemoryLocation = loc;
      saveToSession(loc);
      return loc;
    }
  })();

  return inFlightPromise;
}
````

## File: lib/linkedin.ts
````typescript
// Fichier : lib/auth.ts

// Vous devez vous assurer que ces imports sont valides dans votre structure
import { auth } from "@/lib/firebase"; // Import de l'instance d'authentification Firebase
import { signInWithCustomToken, UserCredential } from "firebase/auth";

// 👉 Login via LinkedIn
// idToken ici est le Custom Token Firebase généré par votre Cloud Function.
export async function loginWithLinkedInIdToken(idToken: string): Promise<UserCredential> {
  console.log(
    "[auth] Tentative de connexion via Custom Token LinkedIn...",
    idToken
  );

  try {
    // 1. Utilisez le Custom Token pour connecter l'utilisateur Firebase.
    const credential = await signInWithCustomToken(auth, idToken);
    
    console.log("[auth] Connexion LinkedIn réussie:", credential.user.uid);
    
    // Le Custom Token est échangé contre une session utilisateur complète.
    return credential; 
    
  } catch (error) {
    console.error("[auth] Erreur lors de la connexion via Custom Token:", error);
    throw new Error("Impossible de se connecter à Firebase avec le Custom Token fourni.");
  }
}
````

## File: lib/logAuthFailed.ts
````typescript
// src/lib/logAuthFailed.ts
import { addDoc, collection, serverTimestamp } from "firebase/firestore";
import { db } from "@/lib/firebase";

export interface LogAuthFailedParams {
  email?: string;
  provider?: string;
  errorCode?: string;
  errorMessage?: string;
}

/**
 * Détection OS / device / navigateur à partir du userAgent
 */
function parseUserAgent(uaRaw: string | null | undefined) {
  const ua = (uaRaw ?? "").toLowerCase();

  let deviceType: string | null = null;
  let os: string | null = null;
  let browser: string | null = null;

  // --- Device ---
  if (ua.includes("iphone")) {
    deviceType = "iphone";
  } else if (ua.includes("ipad")) {
    deviceType = "ipad";
  } else if (ua.includes("android") && ua.includes("mobile")) {
    deviceType = "mobile";
  } else if (ua.includes("android")) {
    deviceType = "tablet";
  } else if (ua.includes("macintosh") || ua.includes("mac os x")) {
    deviceType = "desktop";
  } else if (ua.includes("windows")) {
    deviceType = "desktop";
  } else {
    deviceType = "desktop";
  }

  // --- OS ---
  if (ua.includes("iphone") || ua.includes("ipad") || ua.includes("ipod")) {
    os = "iOS";
  } else if (ua.includes("android")) {
    os = "Android";
  } else if (ua.includes("mac os x") || ua.includes("macintosh")) {
    os = "macOS";
  } else if (ua.includes("windows nt")) {
    os = "Windows";
  } else if (ua.includes("linux")) {
    os = "Linux";
  }

  // --- Navigateur ---
  if (ua.includes("safari") && !ua.includes("chrome") && !ua.includes("crios")) {
    browser = "Safari";
  } else if (
    (ua.includes("chrome") || ua.includes("crios")) &&
    !ua.includes("edge") &&
    !ua.includes("edg/")
  ) {
    browser = "Chrome";
  } else if (ua.includes("firefox") || ua.includes("fxios")) {
    browser = "Firefox";
  } else if (ua.includes("edg/")) {
    browser = "Edge";
  } else if (ua.includes("opera") || ua.includes("opr/")) {
    browser = "Opera";
  }

  return { deviceType, os, browser };
}

/**
 * Récupère l'IP + ville + pays via un petit service public
 * (tu peux changer pour ton propre endpoint si tu veux).
 */
async function fetchIpInfo() {
  if (typeof window === "undefined") return null;

  try {
    const res = await fetch("https://ipapi.co/json/");
    if (!res.ok) return null;
    const json: any = await res.json();

    return {
      ip: json.ip || null,
      country: json.country_name || null,
      city: json.city || null,
    };
  } catch {
    return null;
  }
}

/**
 * Log d'une tentative de connexion échouée (auth_failed)
 * → écrit dans la collection "usageLogs"
 * → enrichi avec IP, pays, ville, device, OS, navigateur, path
 */
export async function logAuthFailed(params: LogAuthFailedParams) {
  try {
    const ua =
      typeof window !== "undefined"
        ? window.navigator.userAgent || ""
        : "";

    const path =
      typeof window !== "undefined"
        ? window.location.pathname + window.location.search
        : "";

    const { deviceType, os, browser } = parseUserAgent(ua);

    const geo = await fetchIpInfo();

    await addDoc(collection(db, "usageLogs"), {
      action: "auth_failed",
      userId: null, // pas connecté
      email: params.email || "",
      provider: params.provider || "password",
      errorCode: params.errorCode || "",
      errorMessage: params.errorMessage || "",

      // contexte technique
      ua,
      path,
      deviceType: deviceType ?? null,
      os: os ?? null,
      browser: browser ?? null,

      // géoloc basique
      ip: geo?.ip ?? null,
      country: geo?.country ?? null,
      city: geo?.city ?? null,

      createdAt: serverTimestamp(),
    });
  } catch (e) {
    // On ne bloque pas l'utilisateur si le log plante
    console.error("Erreur logAuthFailed:", e);
  }
}
````

## File: lib/logUsage.ts
````typescript
// src/lib/logUsage.ts
import {
  addDoc,
  collection,
  doc,
  updateDoc,
  increment,
} from "firebase/firestore";
import { db } from "@/lib/firebase";
import type { User } from "firebase/auth";

export type UsageDocType = "lm" | "cv" | "other";

interface LogUsageOptions {
  user: User;
  action: string;      // ex: "generate_document", "download_document"
  docType?: UsageDocType; // "lm" | "cv" | "other"
  eventType?: string;  // ex: "generate", "download"
  tool?: string;       // ex: "generateLetterAndPitch", "generateCvPdf"
  creditsDelta?: number; // ex: -1 si tu consommes 1 crédit
  path?: string;       // path courant (optionnel)
}

/**
 * Log d'usage IA côté client :
 * - crée un document dans "usageLogs"
 * - met à jour les compteurs dans "users/{uid}"
 *
 * → Permet à ton admin d'afficher :
 *   - LM générées (logs) : docType = "lm"
 *   - CV générés (logs) : docType = "cv"
 *   - totalIaCalls, totalDocumentsGenerated, totalLmGenerated, totalCvGenerated
 */
export async function logUsage(options: LogUsageOptions) {
  const {
    user,
    action,
    docType = "other",
    eventType,
    tool,
    creditsDelta,
  } = options;

  try {
    const now = Date.now();
    const path =
      options.path ||
      (typeof window !== "undefined"
        ? window.location.pathname + window.location.search
        : "");

    // 1) LOG dans usageLogs
    await addDoc(collection(db, "usageLogs"), {
      userId: user.uid,
      email: user.email ?? "",
      action,         // ex: "generate_document"
      docType,        // "lm" | "cv" | "other"
      eventType: eventType ?? null, // ex: "generate"
      tool: tool ?? null,           // ex: "generateCvPdf"

      creditsDelta: typeof creditsDelta === "number" ? creditsDelta : null,

      path,
      createdAt: now, // number → ton admin new Date(createdAt)

      ip: null,
      country: null,
      city: null,
      deviceType: null,
      os: null,
      browser: null,
    });

    // 2) Mise à jour des compteurs dans users/{uid}
    const userRef = doc(db, "users", user.uid);

    const updates: Record<string, any> = {
      totalIaCalls: increment(1),
    };

    // Document IA → compteur global
    if (docType === "lm" || docType === "cv") {
      updates.totalDocumentsGenerated = increment(1);
    }

    if (docType === "lm") {
      updates.totalLmGenerated = increment(1);
    }
    if (docType === "cv") {
      updates.totalCvGenerated = increment(1);
    }

    if (typeof creditsDelta === "number" && creditsDelta !== 0) {
      updates.credits = increment(creditsDelta);
    }

    await updateDoc(userRef, updates);
  } catch (err) {
    console.error("Erreur logUsage:", err);
    // on ne bloque JAMAIS l'utilisateur si le log plante
  }
}
````

## File: lib/pdf/colors.ts
````typescript
// lib/pdf/colors.ts
export type PdfColors = {
  brand: string;
  brandDark: string;
  ink: string;
  muted: string;
  border: string;
  bgSoft: string;
  hair: string; // ✅ requis par letter.ts
};

function clamp(n: number, a: number, b: number) {
  return Math.max(a, Math.min(b, n));
}

function normalizeHex(hex: string) {
  let h = (hex || "").trim();
  if (!h.startsWith("#")) h = `#${h}`;
  if (h.length === 4) {
    // #RGB -> #RRGGBB
    h = `#${h[1]}${h[1]}${h[2]}${h[2]}${h[3]}${h[3]}`;
  }
  if (!/^#[0-9a-fA-F]{6}$/.test(h)) return "#2563eb";
  return h.toLowerCase();
}

function hexToRgb(hex: string) {
  const h = normalizeHex(hex).slice(1);
  return {
    r: parseInt(h.slice(0, 2), 16),
    g: parseInt(h.slice(2, 4), 16),
    b: parseInt(h.slice(4, 6), 16),
  };
}

function rgbToHex(r: number, g: number, b: number) {
  const to = (x: number) =>
    clamp(Math.round(x), 0, 255).toString(16).padStart(2, "0");
  return `#${to(r)}${to(g)}${to(b)}`;
}

function darken(hex: string, amount = 28) {
  const { r, g, b } = hexToRgb(hex);
  return rgbToHex(r - amount, g - amount, b - amount);
}

export function makePdfColors(brandHex: string): PdfColors {
  const brand = normalizeHex(brandHex);
  return {
    brand,
    brandDark: darken(brand, 28),

    ink: "#0f172a", // slate-900
    muted: "#475569", // slate-600
    border: "#e2e8f0", // slate-200
    bgSoft: "#f1f5f9", // slate-100
    hair: "#cbd5e1", // slate-300 (ligne fine)
  };
}
````

## File: lib/pdf/fitOnePage.ts
````typescript
// src/lib/pdf/fitOnePage.ts
import { PDFDocument } from "pdf-lib";
import { pdfMakeToBlob } from "./pdfmakeClient";

export async function countPdfPages(blob: Blob): Promise<number> {
  const ab = await blob.arrayBuffer();
  const pdf = await PDFDocument.load(ab);
  return pdf.getPageCount();
}

export async function fitOnePage(
  buildDoc: (scale: number) => any,
  opts?: { min?: number; max?: number; iterations?: number; initial?: number }
): Promise<{ blob: Blob; bestScale: number }> {
  const min = opts?.min ?? 0.8;
  const max = opts?.max ?? 1.6;
  const iterations = opts?.iterations ?? 8;
  const initial = opts?.initial ?? 1.0;

  let low = min;
  let high = max;

  // test initial
  let bestBlob: Blob | null = null;
  let bestScale = initial;

  let testBlob = await pdfMakeToBlob(buildDoc(initial));
  let pages = await countPdfPages(testBlob);

  if (pages > 1) {
    high = initial;
  } else {
    bestBlob = testBlob;
    low = initial;
  }

  for (let i = 0; i < iterations; i++) {
    const mid = +(((low + high) / 2)).toFixed(3);
    const blob = await pdfMakeToBlob(buildDoc(mid));
    const n = await countPdfPages(blob);

    if (n > 1) {
      high = mid - 0.01;
    } else {
      bestBlob = blob;
      bestScale = mid;
      low = mid + 0.01;
    }
    if (high - low < 0.01) break;
  }

  if (!bestBlob) {
    bestBlob = await pdfMakeToBlob(buildDoc(min));
    bestScale = min;
  }

  return { blob: bestBlob, bestScale };
}
````

## File: lib/pdf/mergePdfs.ts
````typescript
// src/lib/pdf/mergePdfs.ts
import { PDFDocument } from "pdf-lib";

/**
 * Merge plusieurs PDFs (Blob) en un seul PDF (Blob).
 * Compatible Next.js / TS: évite le type Uint8Array<ArrayBufferLike> non accepté par BlobPart.
 */
export async function mergePdfBlobs(blobs: Blob[]): Promise<Blob> {
  const merged = await PDFDocument.create();

  for (const b of blobs) {
    const ab = await b.arrayBuffer();
    const pdf = await PDFDocument.load(ab);

    const pages = await merged.copyPages(pdf, pdf.getPageIndices());
    for (const p of pages) merged.addPage(p);
  }

  const bytes = await merged.save();

  // ✅ Cast sûr pour BlobPart (ArrayBuffer-backed)
  const safeBytes = new Uint8Array(bytes);

  return new Blob([safeBytes], { type: "application/pdf" });
}
````

## File: lib/pdf/templates/cvAts.ts
````typescript
// src/lib/pdf/templates/cvAts.ts
import type { PdfColors } from "../colors";

export type CvDocModel = {
  name: string;
  title: string;
  contactLine: string;
  profile: string;

  skills: {
    cloud?: string[];
    sec?: string[];
    sys?: string[];
    auto?: string[];
    tools?: string[];
    soft?: string[];
  };

  xp: Array<{
    company: string;
    city?: string;
    role: string;
    dates: string;
    bullets: string[];
  }>;

  education: string[];
  certs?: string;
  langLine?: string;
  hobbies?: string[];
};

function stripMd(s: string) {
  return String(s || "")
    .replace(/\*\*(.*?)\*\*/g, "$1")
    .replace(/\*(.*?)\*/g, "$1")
    .replace(/`(.*?)`/g, "$1")
    .replace(/\[(.*?)\]\(.*?\)/g, "$1")
    .trim();
}

function cleanBullet(s: string) {
  return stripMd(s).replace(/^[•\-–]\s*/, "").trim();
}

function smartCompactProfile(profile: string, est: number) {
  const p = stripMd(profile);
  // petit “compact” si beaucoup de contenu (même idée que ton HTML auto) :contentReference[oaicite:3]{index=3}
  if (est > 3600 && p.length > 420) return p.slice(0, 420).replace(/\s+\S*$/, "…");
  if (est > 3000 && p.length > 480) return p.slice(0, 480).replace(/\s+\S*$/, "…");
  return p;
}

// CV A4 1 page — style auto/compact/expanded + scale (zoom global)
export function buildCvAtsPdf(
  cv: CvDocModel,
  lang: "fr" | "en",
  colors: PdfColors,
  styleMode: "auto" | "compact" | "expanded" = "auto",
  scale = 1
) {
  const est =
    (cv.profile?.length || 0) +
    (cv.certs?.length || 0) +
    (cv.langLine?.length || 0) +
    (cv.hobbies || []).join(" ").length +
    (cv.education || []).join(" ").length +
    (cv.xp || [])
      .map((x) => (x.role || "") + (x.company || "") + (x.city || "") + (x.dates || "") + (x.bullets || []).join(" "))
      .join(" ").length +
    Object.values(cv.skills || {})
      .flat()
      .join(" ").length;

  let fontSize: number, headSize: number, titleSize: number, lineH: number, margins: number[];

  if (styleMode === "compact") {
    fontSize = 9.0; headSize = 18.0; titleSize = 11.8; lineH = 1.04; margins = [16, 12, 16, 12];
  } else if (styleMode === "expanded") {
    fontSize = 11.4; headSize = 22.5; titleSize = 15.2; lineH = 1.26; margins = [30, 26, 30, 28];
  } else {
    if (est < 1900) { fontSize = 11.4; headSize = 22.5; titleSize = 15.2; lineH = 1.26; margins = [30, 26, 30, 28]; }
    else if (est < 2200) { fontSize = 11.1; headSize = 22.0; titleSize = 14.8; lineH = 1.22; margins = [28, 24, 28, 26]; }
    else if (est < 2600) { fontSize = 10.8; headSize = 21.2; titleSize = 14.4; lineH = 1.18; margins = [26, 22, 26, 24]; }
    else if (est < 3000) { fontSize = 10.5; headSize = 20.6; titleSize = 14.0; lineH = 1.15; margins = [24, 20, 24, 22]; }
    else if (est < 3400) { fontSize = 10.1; headSize = 19.8; titleSize = 13.4; lineH = 1.12; margins = [22, 18, 22, 18]; }
    else if (est < 3800) { fontSize = 9.8; headSize = 19.2; titleSize = 12.8; lineH = 1.08; margins = [20, 16, 20, 16]; }
    else if (est < 4300) { fontSize = 9.4; headSize = 18.6; titleSize = 12.4; lineH = 1.06; margins = [18, 14, 18, 14]; }
    else { fontSize = 9.0; headSize = 18.0; titleSize = 11.8; lineH = 1.04; margins = [16, 12, 16, 12]; }
  }

  // zoom global
  fontSize = +(fontSize * scale).toFixed(2);
  headSize = +(headSize * scale).toFixed(2);
  titleSize = +(titleSize * scale).toFixed(2);
  lineH = +(1 + (lineH - 1) * (0.8 + 0.2 * scale)).toFixed(3);
  margins = margins.map((m) => Math.max(12, Math.round(m * (0.95 + 0.05 * scale))));

  const profileText = smartCompactProfile(cv.profile, est);

  const H = (t: string) => ({
    text: t,
    color: colors.brand,
    bold: true,
    fontSize: Math.max(10.6, fontSize + 0.6),
    margin: [0, 6, 0, 3],
  });

  const thin = {
    canvas: [{ type: "line", x1: 0, y1: 0, x2: 515, y2: 0, lineWidth: 0.7, lineColor: colors.border }],
    margin: [0, 2, 0, 6],
  };

  const s = cv.skills || {};
  const skillsGrid = {
    columns: [
      {
        width: "*",
        stack: [
          { text: lang === "fr" ? "Architecture & Cloud" : "Architecture & Cloud", bold: true, color: colors.muted, margin: [0, 0, 0, 1] },
          { text: (s.cloud || []).join(", "), alignment: "justify" },

          { text: lang === "fr" ? "Cybersécurité" : "Cybersecurity", bold: true, color: colors.muted, margin: [0, 5, 0, 1] },
          { text: (s.sec || []).join(", "), alignment: "justify" },

          { text: lang === "fr" ? "Soft skills" : "Soft skills", bold: true, color: colors.muted, margin: [0, 5, 0, 1] },
          { text: (s.soft || []).join(", "), alignment: "justify" },
        ],
      },
      {
        width: "*",
        stack: [
          { text: lang === "fr" ? "Systèmes & Réseaux" : "Systems & Networks", bold: true, color: colors.muted, margin: [0, 0, 0, 1] },
          { text: (s.sys || []).join(", "), alignment: "justify" },

          { text: lang === "fr" ? "Automatisation & Outils (IA/API)" : "Automation & Tools (AI/API)", bold: true, color: colors.muted, margin: [0, 5, 0, 1] },
          { text: ([...(s.auto || []), ...(s.tools || [])]).join(", "), alignment: "justify" },
        ],
      },
    ],
    columnGap: 14,
  };

  function xpBlock(x: CvDocModel["xp"][number]) {
    const header = {
      text: `${x.company}${x.city ? " — " + x.city : ""} — ${x.role} | ${x.dates}`,
      margin: [0, 0.5, 0, 1],
      bold: true,
    };
    const bullets = (x.bullets || []).map((b) => ({
      text: `- ${cleanBullet(b)}`,
      margin: [0, 0, 0, 0.4],
      alignment: "justify",
    }));
    return [header, ...bullets];
  }

  const content: any[] = [
    { text: cv.name, fontSize: headSize, bold: true, alignment: "center", margin: [0, 0, 0, 0] },
    { text: cv.title, fontSize: titleSize, color: colors.brand, bold: true, alignment: "center", margin: [0, 1, 0, 3] },
    { text: stripMd(cv.contactLine), bold: true, margin: [0, 0, 0, 4], alignment: "center" },
    thin,

    H(lang === "fr" ? "Profil" : "Profile"),
    { text: profileText, margin: [0, 0, 0, 2], alignment: "justify" },

    H(lang === "fr" ? "Compétences clés" : "Key Skills"),
    skillsGrid,

    H(lang === "fr" ? "Expériences professionnelles" : "Professional Experience"),
    ...(cv.xp || []).flatMap(xpBlock),

    H(lang === "fr" ? "Formation" : "Education"),
    { ul: (cv.education || []).map((e) => stripMd(e)), margin: [0, 0, 0, 1] },

    H(lang === "fr" ? "Certifications" : "Certifications"),
    { text: stripMd(cv.certs || ""), margin: [0, 0, 0, 1], alignment: "justify" },

    H(lang === "fr" ? "Langues" : "Languages"),
    { text: stripMd(cv.langLine || "") },
  ];

  if (Array.isArray(cv.hobbies) && cv.hobbies.length) {
    content.push(H(lang === "fr" ? "Centres d’intérêt / Hobbies" : "Interests"));
    content.push({ text: cv.hobbies.join(" • "), margin: [0, 0, 0, 1] });
  }

  return {
    pageSize: "A4",
    pageMargins: margins,
    defaultStyle: { font: "Roboto", fontSize, lineHeight: lineH, color: colors.ink },
    content,
  };
}
````

## File: lib/pdf/templates/types.ts
````typescript
// src/lib/pdf/templates/types.ts
export type Lang = "fr" | "en";

export type CvDocModel = {
  name: string;
  title: string;
  contact: string; // "Paris | +33... | mail | linkedin"
  profile: string;

  skills: {
    cloud?: string[];
    sec?: string[];
    sys?: string[];
    auto?: string[];
    tools?: string[];
    soft?: string[];
  };

  xp: Array<{
    company: string;
    city?: string;
    role: string;
    dates: string;
    bullets: string[];
  }>;

  education: string[];
  certs: string;
  langLine: string;
  hobbies?: string[];
};

export type LmModel = {
  lang: Lang;
  name: string;
  contactLines: string[]; // ["Téléphone: ...", "Email: ..."]
  service: string;
  companyName: string;
  companyAddr?: string; // multi-line
  city: string;
  dateStr: string;
  aPrefix: string; // "À " (FR) / "At " (EN)
  subject: string;
  salutation: string;
  body: string; // paragraphes séparés par \n\n
  closing: string;
  signature: string;
};
````

## File: lib/polar-checkout.ts
````typescript
// src/lib/polar-checkout.ts
import { polar } from "@/lib/polar";

// Mappe les packs utilisés dans ton app vers les Product IDs Polar
// Ici on suppose trois packs : 10, 20, 30 crédits
const PACK_TO_PRODUCT_ID: Record<string, string> = {
  "10": process.env.POLAR_PRODUCT_10_ID || "",
  "20": process.env.POLAR_PRODUCT_20_ID || "",
  "30": process.env.POLAR_PRODUCT_30_ID || "",
};

const APP_URL =
  process.env.NEXT_PUBLIC_APP_URL ?? "https://assistant-ia-v4.web.app";

export type CreditPackId = "10" | "20" | "30";

export interface CreateCheckoutOptions {
  customerEmail?: string;
  externalCustomerId?: string; // ex: id utilisateur (Firebase, Supabase, etc.)
}

/**
 * Crée une session de paiement Polar pour un pack donné.
 *
 * @param packId - "10", "20" ou "30" (nombre de crédits du pack)
 * @param opts - infos client (email, id externe)
 */
export async function createPolarCheckout(
  packId: CreditPackId,
  opts?: CreateCheckoutOptions
) {
  const productId = PACK_TO_PRODUCT_ID[packId];

  if (!productId) {
    throw new Error(
      `Pack inconnu côté Polar : "${packId}". Vérifie PACK_TO_PRODUCT_ID dans src/lib/polar-checkout.ts`
    );
  }

  // Polar remplace {CHECKOUT_ID} par l'id réel du checkout
  const successUrl = `${APP_URL}/paiement/success?checkout_id={CHECKOUT_ID}`;
  const returnUrl = `${APP_URL}/paiement/canceled`;

  const checkout = await polar.checkouts.create({
    products: [productId],
    successUrl,
    returnUrl,
    customerEmail: opts?.customerEmail,
    externalCustomerId: opts?.externalCustomerId,
  });

  if (!checkout.url) {
    throw new Error("Polar n'a pas renvoyé d'URL de checkout");
  }

  return { url: checkout.url };
}
````

## File: lib/polar.ts
````typescript
// src/lib/polar.ts
import { Polar } from "@polar-sh/sdk";

const server =
  process.env.POLAR_ENV === "production" ? "production" : "sandbox";

if (!process.env.POLAR_ACCESS_TOKEN) {
  throw new Error("POLAR_ACCESS_TOKEN manquant dans .env");
}

// Instance Polar
export const polar = new Polar({
  accessToken: process.env.POLAR_ACCESS_TOKEN,
  // @ts-ignore : selon la version du SDK, server peut être optionnel
  server,
});

// ⚠️ Packs alignés avec ton UI : 20 / 50 / 100 crédits
export type CreditPackId = "20" | "50" | "100";

// ✅ IDs produits liés aux packs, alimentés par tes variables d'env
const PACK_TO_PRODUCT_ID: Record<CreditPackId, string> = {
  "20": process.env.POLAR_PRODUCT_20_ID ?? "",
  "50": process.env.POLAR_PRODUCT_50_ID ?? "",
  "100": process.env.POLAR_PRODUCT_100_ID ?? "",
};

function getProductIdForPack(packId: CreditPackId): string {
  const productId = PACK_TO_PRODUCT_ID[packId];
  if (!productId) {
    throw new Error(
      `Aucun POLAR_PRODUCT_${packId}_ID configuré dans les variables d'env pour le pack "${packId}".`
    );
  }
  return productId;
}

interface CreateCheckoutOptions {
  packId: CreditPackId;
  userId: string;
  email: string;
}

/**
 * Crée un checkout Polar pour un pack de crédits et renvoie l'URL de paiement.
 * Fonctionne autant en sandbox qu'en production (selon POLAR_ENV + les IDs).
 * Cette URL sera utilisée dans l'Embedded Checkout (pop-up dans ton site).
 */
export async function createPolarCheckout(options: CreateCheckoutOptions) {
  const { packId, userId, email } = options;

  const productId = getProductIdForPack(packId);

  const baseAppUrl =
    process.env.NEXT_PUBLIC_APP_URL || "http://localhost:3000";

  // 👉 utilisé pour la redirection *si tu laisses Polar rediriger*
  const successUrl = `${baseAppUrl}/app/credits?status=success&pack=${packId}`;
  const returnUrl = `${baseAppUrl}/app/credits?status=cancel`;

  // 👉 très important pour l'Embedded Checkout
  // Polar docs : embed_origin = origin de la page qui intègre le checkout :contentReference[oaicite:1]{index=1}
  const embedOrigin = baseAppUrl; // NEXT_PUBLIC_APP_URL doit être du style https://mon-site.com

  console.log("[Polar] Création checkout", {
    env: process.env.POLAR_ENV,
    packId,
    productId,
    userId,
    email,
    successUrl,
    returnUrl,
    embedOrigin,
  });

  const payload: any = {
    products: [productId],
    success_url: successUrl,
    return_url: returnUrl,
    embed_origin: embedOrigin,
    customer_email: email, // ⚠️ vrai email
    external_customer_id: userId,

    allow_discount_codes: true,
    require_billing_address: false,
    allow_trial: true,
    is_business_customer: false,
  };

  const checkout = await (polar as any).checkouts.create(payload);

  if (!checkout?.url) {
    console.error(
      "[Polar] Checkout créé mais pas d'URL dans la réponse:",
      checkout
    );
    throw new Error("Checkout Polar créé mais URL manquante.");
  }

  console.log("[Polar] Checkout URL:", checkout.url);

  return {
    url: checkout.url as string,
    checkout,
  };
}
````

## File: lib/server/credits.ts
````typescript
// lib/server/credits.ts
//
// VERSION DEV SANS FIRESTORE
// --------------------------
// On simule juste des crédits illimités pour tous les utilisateurs.
// Ça évite les erreurs Firebase Admin en local.
// Quand tu voudras brancher Firestore côté serveur, tu pourras
// rétablir la logique avec firebase-admin ici.

type DevUser = {
  id: string;
  credits: number;
};

export async function verifyUserAndCredits(
  userId: string
): Promise<DevUser | null> {
  if (!userId) return null;

  // En DEV : tous les users sont autorisés, avec beaucoup de crédits.
  return {
    id: userId,
    credits: 9999,
  };
}

export async function consumeCredit(
  userId: string,
  amount = 1
): Promise<void> {
  // En DEV : on ne fait rien, on log juste.
  console.log(
    `[DEV][credits] Consommation simulée de ${amount} crédit(s) pour l'utilisateur ${userId}`
  );
}
````

## File: lib/userTracking.ts
````typescript
// lib/userTracking.ts
import { User } from "firebase/auth";
import {
  collection,
  addDoc,
  doc,
  setDoc,
  increment,
} from "firebase/firestore";
import { db } from "@/lib/firebase";

/**
 * Infos IP / localisation
 */
type IpInfo = {
  ip: string;
  country: string;
  city: string;
};

// Cache en mémoire pour éviter d'appeler l'API à chaque fois
let ipInfoCache: IpInfo | null = null;
let ipInfoPromise: Promise<IpInfo | null> | null = null;

async function getIpInfo(): Promise<IpInfo | null> {
  if (ipInfoCache) return ipInfoCache;
  if (typeof window === "undefined") return null;

  if (ipInfoPromise) return ipInfoPromise;

  ipInfoPromise = (async () => {
    try {
      // API publique simple, tu peux la changer si besoin
      const res = await fetch("https://ipapi.co/json/");
      if (!res.ok) throw new Error("IP API error");
      const data = await res.json();
      const info: IpInfo = {
        ip: data.ip,
        country: data.country_name,
        city: data.city,
      };
      ipInfoCache = info;
      return info;
    } catch (e) {
      console.error("Erreur getIpInfo:", e);
      return null;
    } finally {
      ipInfoPromise = null;
    }
  })();

  return ipInfoPromise;
}

/**
 * Infos device / OS / navigateur
 * ➜ différencie iPhone / iPad / macOS / Android / Windows…
 */
type DeviceInfo = {
  deviceType: string; // "iphone" | "ipad" | "mac" | "mobile" | "tablet" | "desktop" | "unknown"
  os: string;
  browser: string;
};

function detectDeviceInfo(): DeviceInfo {
  if (typeof navigator === "undefined") {
    return { deviceType: "unknown", os: "unknown", browser: "unknown" };
  }

  const ua = navigator.userAgent || "";
  const lower = ua.toLowerCase();

  let deviceType = "unknown";
  let os = "unknown";
  let browser = "unknown";

  // --- OS + device ---
  if (/iphone/i.test(ua)) {
    deviceType = "iphone";
    os = "iOS";
  } else if (/ipad/i.test(ua)) {
    deviceType = "ipad";
    os = "iPadOS";
  } else if (/android/i.test(ua)) {
    os = "Android";
    deviceType = /mobile/i.test(ua) ? "mobile" : "tablet";
  } else if (/macintosh|mac os x/i.test(ua)) {
    os = "macOS";
    deviceType = "mac";
  } else if (/windows/i.test(ua)) {
    os = "Windows";
    deviceType = "desktop";
  } else if (/linux/i.test(ua)) {
    os = "Linux";
    deviceType = "desktop";
  }

  // --- navigateur ---
  if (lower.includes("edg/")) {
    browser = "Edge";
  } else if (lower.includes("opr/") || lower.includes("opera")) {
    browser = "Opera";
  } else if (lower.includes("firefox")) {
    browser = "Firefox";
  } else if (lower.includes("chrome") && !lower.includes("edge") && !lower.includes("opr")) {
    browser = "Chrome";
  } else if (lower.includes("safari") && !lower.includes("chrome")) {
    browser = "Safari";
  }

  return { deviceType, os, browser };
}

/**
 * Mise à jour du doc "users/{uid}" pour suivre :
 * - dernière activité
 * - dernière page
 * - IP / pays / ville
 * - device / OS / navigateur
 */
export async function updateLastActive(
  user: User,
  extra?: { path?: string; action?: string }
) {
  if (!user) return;

  try {
    const [ipInfo, device] = await Promise.all([
      getIpInfo(),
      Promise.resolve(detectDeviceInfo()),
    ]);

    const ref = doc(db, "users", user.uid);

    const path =
      extra?.path ??
      (typeof window !== "undefined"
        ? window.location.pathname + window.location.search
        : null);

    const now = Date.now();

    const payload: any = {
      email: user.email ?? null,
      displayName: user.displayName ?? null,
      lastSeenAt: now,
      lastSeenPage: path,
      lastDeviceType: device.deviceType,
      lastOs: device.os,
      lastBrowser: device.browser,
    };

    if (user.metadata?.lastSignInTime) {
      payload.lastLoginAt = new Date(
        user.metadata.lastSignInTime
      ).getTime();
    }

    if (ipInfo) {
      payload.lastSeenIp = ipInfo.ip;
      payload.lastSeenCountry = ipInfo.country;
      payload.lastSeenCity = ipInfo.city;
    }

    if (extra?.action) {
      payload.lastAction = extra.action;
      payload.lastActionAt = now;
    }

    await setDoc(ref, payload, { merge: true });
  } catch (e) {
    console.error("Erreur updateLastActive:", e);
  }
}

/**
 * Options pour les logs d’usage
 * - action = nom de l’évènement (ex: "lm_generate", "lm_download", "cv_generate")
 * - docType = "lm" | "cv" | "pitch"...
 * - eventType = "generate" | "download" | "view"...
 * - tool = comment tu catégorises ton outil (ex: "lm", "cv", "assistant")
 * - creditsDelta = variation de crédits (ex: -1 quand tu consommes 1 crédit)
 *
 * ➜ grâce à [key: string]: any, tu peux passer
 *    feature, template, lang, contract, targetJob, companyName, etc.
 */
export type LogUsageOptions = {
  tool?: string;
  docType?: "lm" | "cv" | "pitch" | string;
  eventType?: "generate" | "download" | "view" | "auth" | string;
  creditsDelta?: number;
  path?: string;
  meta?: Record<string, any>;
  // pour autoriser des clés libres (feature, template, lang, etc.)
  [key: string]: any;
};

/**
 * Log d’un événement important (appel IA, génération LM/CV, téléchargement…)
 * ➜ crée un doc dans usageLogs
 * ➜ met à jour les compteurs dans users
 *
 * Tous les champs supplémentaires (feature, template, lang, jobTitle, etc.)
 * sont rangés dans log.meta.
 */
export async function logUsage(
  user: User | null,
  action: string,
  options?: LogUsageOptions
) {
  if (!user) return;

  try {
    const [ipInfo, device] = await Promise.all([
      getIpInfo(),
      Promise.resolve(detectDeviceInfo()),
    ]);

    const now = Date.now();

    // On extrait les options "connues" et on met le reste dans `rest`
    const {
      tool,
      docType,
      eventType,
      creditsDelta,
      path: optPath,
      meta,
      ...rest
    } = options ?? {};

    const path =
      optPath ??
      (typeof window !== "undefined"
        ? window.location.pathname + window.location.search
        : null);

    // --- 1) Créer un document dans usageLogs ---
    const log: any = {
      userId: user.uid,
      email: user.email ?? null,
      action,
      tool: tool ?? null,
      docType: docType ?? null,
      eventType: eventType ?? null,
      createdAt: now,
      path,
      creditsDelta:
        typeof creditsDelta === "number" ? creditsDelta : null,
      deviceType: device.deviceType,
      os: device.os,
      browser: device.browser,
    };

    if (ipInfo) {
      log.ip = ipInfo.ip;
      log.country = ipInfo.country;
      log.city = ipInfo.city;
    }

    // Fusionne meta + toutes les autres clés libres (feature, template, ...)
    if (meta || Object.keys(rest).length > 0) {
      log.meta = {
        ...(meta || {}),
        ...rest,
      };
    }

    const logsRef = collection(db, "usageLogs");
    await addDoc(logsRef, log);

    // --- 2) Mettre à jour les compteurs dans users/{uid} ---
    const userRef = doc(db, "users", user.uid);

    const update: any = {
      lastSeenAt: now,
      lastSeenPage: path,
      lastDeviceType: device.deviceType,
      lastOs: device.os,
      lastBrowser: device.browser,
    };

    if (ipInfo) {
      update.lastSeenIp = ipInfo.ip;
      update.lastSeenCountry = ipInfo.country;
      update.lastSeenCity = ipInfo.city;
    }

    const inc: any = {};

    // Appels IA
    if (tool) {
      inc.totalIaCalls = increment(1);
    }

    // Documents générés
    if (docType) {
      inc.totalDocumentsGenerated = increment(1);
      if (docType === "lm") {
        inc.totalLmGenerated = increment(1);
      }
      if (docType === "cv") {
        inc.totalCvGenerated = increment(1);
      }
    }

    // Crédits consommés / ajoutés
    if (typeof creditsDelta === "number") {
      inc.credits = increment(creditsDelta);
    }

    Object.assign(update, inc);

    await setDoc(userRef, update, { merge: true });
  } catch (e) {
    console.error("Erreur logUsage:", e);
  }
}
````

## File: next-env.d.ts
````typescript
/// <reference types="next" />
/// <reference types="next/image-types/global" />

// NOTE: This file should not be edited
// see https://nextjs.org/docs/app/building-your-application/configuring/typescript for more information.
````

## File: postcss.config.js
````javascript
module.exports = {
  plugins: {
    tailwindcss: {},
    autoprefixer: {}
  }
};
````

## File: public/locales/en/common.json
````json
{
  "header": {
    "title": "AI Applications Assistant",
    "space": "Candidate area",
    "connected": "Signed in:",
    "logout": "Log out"
  },
  "nav": {
    "profile": "AI CV Profile",
    "coverLetter": "Application assistant",
    "tracker": "Application tracker",
    "interview": "Interview prep",
    "apply": "Apply",
    "history": "AI history",
    "credits": "Credits",
    "settings": "Settings"
  },
  "landing": {
    "badge": "AI for job applications",
    "title": "Your AI-powered job application workspace.",
    "subtitle": "Upload your CV, generate targeted cover letters, prepare your pitch and track your applications in one place.",
    "ctaPrimary": "Start for free",
    "ctaSecondary": "I already have an account"
  },
  "dashboard": {
    "title": "Dashboard",
    "welcome": "Welcome",
    "creditsLabel": "credits",
    "creditsLoading": "Loading…"
  },
  "auth": {
    "loginTitle": "Log in",
    "signupTitle": "Create an account",
    "email": "Email",
    "password": "Password",
    "confirmPassword": "Confirm password",
    "forgotPassword": "Forgot password?",
    "noAccount": "Don't have an account yet?",
    "haveAccount": "Already have an account?",
    "createAccount": "Create account",
    "signIn": "Log in",
    "signOut": "Log out",
    "continue": "Continue",
    "back": "Back",
    "verifyEmailTitle": "Verify your email",
    "verifyEmailDesc": "We sent you a verification email. Click the link to activate your account.",
    "resend": "Resend email",
    "resendDone": "Email resent.",
    "blockedTitle": "Account blocked",
    "blockedDesc": "Your account has been blocked. Contact support if needed."
  },
  "common": {
    "loading": "Loading…",
    "menu": "Menu",
    "navigation": "Navigation",
    "save": "Save",
    "cancel": "Cancel",
    "close": "Close",
    "delete": "Delete",
    "edit": "Edit",
    "confirm": "Confirm",
    "yes": "Yes",
    "no": "No",
    "search": "Search",
    "copy": "Copy",
    "copied": "Copied!",
    "error": "Something went wrong.",
    "retry": "Retry"
  },
  "errors": {
    "blocked": "Your account has been blocked. Contact support if needed.",
    "unauthorized": "Access denied.",
    "notFound": "Page not found."
  }
}
````

## File: public/locales/fr/common.json
````json
{
  "header": {
    "title": "Assistant Candidatures IA",
    "space": "Espace candidat",
    "connected": "Connecté·e :",
    "logout": "Se déconnecter"
  },
  "nav": {
    "profile": "Profil CV IA",
    "coverLetter": "Assistant candidature",
    "tracker": "Suivi candidatures",
    "interview": "Préparer entretien",
    "apply": "Postuler",
    "history": "Historique IA",
    "credits": "Crédits",
    "settings": "Paramètres"
  },
  "landing": {
    "badge": "IA appliquée aux candidatures",
    "title": "Ton bureau de candidature, piloté par l’IA.",
    "subtitle": "Importe ton CV, génère des lettres ciblées, prépare ton pitch et suis tes candidatures depuis un seul espace.",
    "ctaPrimary": "Essayer gratuitement",
    "ctaSecondary": "J’ai déjà un compte"
  },
  "dashboard": {
    "title": "Tableau de bord",
    "welcome": "Bienvenue",
    "creditsLabel": "crédits",
    "creditsLoading": "Chargement…"
  },
  "auth": {
    "loginTitle": "Se connecter",
    "signupTitle": "Créer un compte",
    "email": "Email",
    "password": "Mot de passe",
    "confirmPassword": "Confirmer le mot de passe",
    "forgotPassword": "Mot de passe oublié ?",
    "noAccount": "Pas encore de compte ?",
    "haveAccount": "Déjà un compte ?",
    "createAccount": "Créer un compte",
    "signIn": "Se connecter",
    "signOut": "Se déconnecter",
    "continue": "Continuer",
    "back": "Retour",
    "verifyEmailTitle": "Vérifie ton email",
    "verifyEmailDesc": "Un email de vérification t’a été envoyé. Clique sur le lien pour activer ton compte.",
    "resend": "Renvoyer l’email",
    "resendDone": "Email renvoyé.",
    "blockedTitle": "Compte bloqué",
    "blockedDesc": "Ton compte a été bloqué. Contacte le support si besoin."
  },
  "common": {
    "loading": "Chargement…",
    "menu": "Menu",
    "navigation": "Navigation",
    "save": "Enregistrer",
    "cancel": "Annuler",
    "close": "Fermer",
    "delete": "Supprimer",
    "edit": "Modifier",
    "confirm": "Confirmer",
    "yes": "Oui",
    "no": "Non",
    "search": "Rechercher",
    "copy": "Copier",
    "copied": "Copié !",
    "error": "Une erreur est survenue.",
    "retry": "Réessayer"
  },
  "errors": {
    "blocked": "Ton compte a été bloqué. Contacte le support si besoin.",
    "unauthorized": "Accès refusé.",
    "notFound": "Page introuvable."
  }
}
````

## File: public/manifest.webmanifest
````
{
  "name": "SmartCV",
  "short_name": "SmartCV",
  "start_url": "/",
  "display": "standalone",
  "background_color": "#020617",
  "theme_color": "#0ea5e9",
  "icons": []
}
````

## File: setAdmin.js
````javascript
// setAdmin.js
const admin = require("firebase-admin");
const serviceAccount = require("./serviceAccountKey.json");

admin.initializeApp({
  credential: admin.credential.cert(serviceAccount),
});

async function main() {
  // 👉 Mets ici l'email EXACT utilisé dans Firebase Authentication
  const email = "aakane0105@gmail.com"; // <--- NE PAS OUBLIER LE GUILLEMET DE FIN

  try {
    // On récupère l'utilisateur via son email
    const userRecord = await admin.auth().getUserByEmail(email);
    console.log("Utilisateur trouvé ✅");
    console.log("UID :", userRecord.uid);
    console.log("Email :", userRecord.email);

    // On lui ajoute le rôle admin
    await admin.auth().setCustomUserClaims(userRecord.uid, { isAdmin: true });

    console.log("✅ isAdmin = true pour :", userRecord.uid);
  } catch (err) {
    console.error("Erreur setAdmin:", err);
  }
}

main();
````

## File: syncAuthUsersToFirestore.js
````javascript
// syncAuthUsersToFirestore.js
//
// Script une fois pour toutes : synchronise tous les comptes Firebase Auth
// vers la collection Firestore "users", pour qu'ils apparaissent dans ton admin.

const admin = require("firebase-admin");
const serviceAccount = require("./serviceAccountKey.json");

admin.initializeApp({
  credential: admin.credential.cert(serviceAccount),
});

const db = admin.firestore();

function toMillis(str) {
  if (!str) return null;
  const t = Date.parse(str);
  return Number.isNaN(t) ? null : t;
}

async function syncAllUsers(nextPageToken) {
  const result = await admin.auth().listUsers(1000, nextPageToken);

  for (const user of result.users) {
    const uid = user.uid;
    const ref = db.collection("users").doc(uid);
    const snap = await ref.get();

    const baseData = {
      email: user.email || null,
      displayName: user.displayName || null,
      emailVerified: user.emailVerified || false,
      provider:
        (user.providerData[0] && user.providerData[0].providerId) ||
        "password",
      createdAt: toMillis(user.metadata.creationTime) || Date.now(),
      lastLoginAt: toMillis(user.metadata.lastSignInTime) || null,
    };

    if (!snap.exists) {
      // Nouveau doc user créé
      await ref.set({
        ...baseData,
        credits: 0,
        blocked: false,
      });
      console.log("✅ Créé doc users pour", uid, baseData.email);
    } else {
      // Doc déjà existant → on ne touche pas aux crédits / blocked
      await ref.set(baseData, { merge: true });
      console.log("🔁 Mis à jour doc users pour", uid, baseData.email);
    }
  }

  if (result.pageToken) {
    await syncAllUsers(result.pageToken);
  }
}

async function main() {
  await syncAllUsers();
  console.log("🎉 Sync terminé");
  process.exit(0);
}

main().catch((err) => {
  console.error("Erreur syncAllUsers:", err);
  process.exit(1);
});
````

## File: tailwind.config.js
````javascript
/** @type {import('tailwindcss').Config} */
module.exports = {
  content: [
    "./app/**/*.{js,ts,jsx,tsx}",
    "./components/**/*.{js,ts,jsx,tsx}"
  ],
  theme: {
    extend: {}
  },
  plugins: []
}
````

## File: tsconfig.json
````json
{
  "compilerOptions": {
    "target": "ESNext",
    "lib": [
      "DOM",
      "DOM.Iterable",
      "ESNext"
    ],
    "allowJs": false,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "ESNext",
    "moduleResolution": "Node",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "preserve",
    "paths": {
      "@/*": [
        "./*"
      ]
    },
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ]
  },
  "include": [
    "next-env.d.ts",
    "**/*.ts",
    "**/*.tsx",
    ".next/types/**/*.ts"
  ],
  "exclude": [
    "node_modules"
  ]
}
````

## File: types/cv.ts
````typescript
// types/cv.ts

export type CvSkills = {
  // Compétences métier (finance, RH, IT, marketing, etc.)
  domain?: string[];
  // Outils / logiciels (Excel, Word, PowerPoint, SAP, Canva, etc.)
  tools?: string[];
};

export type CvExperience = {
  company?: string;
  role?: string;
  location?: string;
  dates?: string;
  bullets?: string[];
};

export type CvProfile = {
  fullName?: string;
  email?: string;
  phone?: string;
  linkedin?: string;
  contractType?: string;

  // Résumé court du profil (max 3 phrases)
  profileSummary?: string;

  // Ligne compacte pour les langues : "Français (natif) · Anglais (B2 – TOEIC) · ..."
  langLine?: string;

  skills?: CvSkills;

  // Formation courte, lignes prêtes à afficher
  // ex: "2022–2024 · MSc Expert Financier – ESAM, Paris"
  educationShort?: string[];

  // Certifications principales
  certifications?: string[];

  // Centres d'intérêt détaillés
  interests?: string[];

  // Centres d'intérêt sur une seule ligne : "Musique, piano, voyages, ..."
  interestsLine?: string;

  // Expériences détaillées (utile plus tard pour les LM, pitch, etc.)
  experiences?: CvExperience[];
};

export type CvApiResponse = {
  success: boolean;
  profile?: CvProfile;
  error?: string;
};
````

## File: app/app/credits/page.tsx
````typescript
"use client";

import { useEffect, useRef, useState } from "react";
import { motion, AnimatePresence } from "framer-motion";
import { 
  Zap, 
  History, 
  ShieldCheck, 
  CreditCard, 
  ArrowRight, 
  CheckCircle2, 
  Loader2, 
  Sparkles,
  Clock,
  Info
} from "lucide-react";

import { useUserCredits } from "@/hooks/useUserCredits";
import { useAuth } from "@/context/AuthContext";
import { getRecaptchaToken } from "@/lib/recaptcha";
import { useRechargeHistory } from "@/hooks/useRechargeHistory";

// --- TYPES ---
type PackKey = "20" | "50" | "100";

const CREDIT_PACKS: {
  key: PackKey;
  label: string;
  credits: number;
  price: string;
  desc: string;
  color: string;
  popular?: boolean;
}[] = [
  {
    key: "20",
    credits: 20,
    price: "4.99€",
    label: "Pack Découverte",
    desc: "Idéal pour tester les fonctionnalités IA ponctuellement.",
    color: "from-blue-500 to-cyan-500",
  },
  {
    key: "50",
    credits: 50,
    price: "9.99€",
    label: "Pack Boost",
    desc: "Parfait pour une phase active de recherche d'emploi.",
    color: "from-indigo-600 to-blue-600",
    popular: true,
  },
  {
    key: "100",
    credits: 100,
    price: "17.99€",
    label: "Pack Intensif",
    desc: "Pour une préparation complète : CV, lettres et entretiens.",
    color: "from-purple-600 to-indigo-600",
  },
];

const DEFAULT_API_BASE = "https://europe-west1-assistant-ia-v4.cloudfunctions.net";
const API_BASE = (process.env.NEXT_PUBLIC_API_BASE_URL || DEFAULT_API_BASE).replace(/\/+$/, "");

export default function CreditsPage() {
  const { user } = useAuth();
  const { credits, loading, error } = useUserCredits();
  const { items: recharges, loading: rechargesLoading } = useRechargeHistory(30);

  const [buyLoading, setBuyLoading] = useState<PackKey | null>(null);
  const [buyError, setBuyError] = useState<string | null>(null);
  const [embedUrl, setEmbedUrl] = useState<string | null>(null);
  const [showSuccessAnimation, setShowSuccessAnimation] = useState(false);
  const [creditsBeforePurchase, setCreditsBeforePurchase] = useState<number | null>(null);
  const [statusMessage, setStatusMessage] = useState<string | null>(null);

  const iframeRef = useRef<HTMLIFrameElement | null>(null);

  // --- ACTIONS ---
  const handleBuy = async (pack: PackKey) => {
    try {
      setBuyError(null);
      if (!user?.uid || !user.email) return setBuyError("Veuillez vous connecter.");

      setBuyLoading(pack);
      setCreditsBeforePurchase(credits ?? 0);

      const recaptchaToken = await getRecaptchaToken("polar_checkout");
      const res = await fetch(`${API_BASE}/polarCheckout`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ packId: pack, userId: user.uid, email: user.email, recaptchaToken }),
      });

      const data = await res.json();
      if (!res.ok || !data?.url) throw new Error(data?.error || "Erreur de paiement.");

      const fullUrl = `${data.url}${data.url.includes("?") ? "&" : "?"}embed=true&embed_origin=${encodeURIComponent(window.location.origin)}`;
      setEmbedUrl(fullUrl);
    } catch (e: any) {
      setBuyError(e.message);
      setBuyLoading(null);
    }
  };

  // Fermeture auto quand les crédits sont reçus
  useEffect(() => {
    if (embedUrl && creditsBeforePurchase !== null && credits !== null && credits > creditsBeforePurchase) {
      setEmbedUrl(null);
      setBuyLoading(null);
      setShowSuccessAnimation(true);
      setTimeout(() => setShowSuccessAnimation(false), 5000);
    }
  }, [credits, embedUrl, creditsBeforePurchase]);

  return (
    <div className="max-w-5xl mx-auto px-4 py-8 space-y-10">
      
      {/* NOTIFICATION SUCCÈS */}
      <AnimatePresence>
        {showSuccessAnimation && (
          <motion.div 
            initial={{ y: -50, opacity: 0 }} 
            animate={{ y: 0, opacity: 1 }} 
            exit={{ y: -50, opacity: 0 }}
            className="fixed top-6 left-1/2 -translate-x-1/2 z-50 pointer-events-none"
          >
            <div className="bg-emerald-600 text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-3">
              <Sparkles className="w-5 h-5 fill-yellow-400" />
              <span className="font-bold text-sm">Crédits ajoutés avec succès !</span>
            </div>
          </motion.div>
        )}
      </AnimatePresence>

      {/* HEADER & BALANCE */}
      <header className="flex flex-col md:flex-row md:items-end justify-between gap-6">
        <div className="space-y-2">
          <h1 className="text-3xl font-bold tracking-tight">Crédits IA</h1>
          <p className="text-gray-500 text-sm max-w-md">
            Utilisez vos crédits pour propulser vos candidatures avec nos outils d'analyse et de génération intelligente.
          </p>
        </div>

        <div className="relative group">
          <div className="absolute -inset-0.5 bg-gradient-to-r from-blue-500 to-indigo-600 rounded-2xl blur opacity-20 group-hover:opacity-40 transition"></div>
          <div className="relative bg-[var(--bg)] border border-[var(--border)] p-4 rounded-2xl flex items-center gap-4 min-w-[200px]">
            <div className="w-12 h-12 rounded-xl bg-blue-500/10 flex items-center justify-center text-blue-600">
              <Zap className="w-6 h-6 fill-blue-600" />
            </div>
            <div>
              <div className="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Solde Actuel</div>
              <div className="text-2xl font-black text-[var(--ink)]">
                {loading ? "..." : credits} <span className="text-xs font-medium text-gray-400">⚡</span>
              </div>
            </div>
          </div>
        </div>
      </header>

      {/* PACKS SECTION */}
      <section className="space-y-6">
        <div className="flex items-center gap-2">
          <CreditCard className="w-5 h-5 text-blue-500" />
          <h2 className="text-lg font-bold">Rechargement sécurisé</h2>
        </div>

        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
          {CREDIT_PACKS.map((pack) => (
            <motion.div
              key={pack.key}
              whileHover={{ y: -5 }}
              className={`relative bg-[var(--bg)] border border-[var(--border)] rounded-3xl p-6 flex flex-col justify-between shadow-sm transition-all ${pack.popular ? 'ring-2 ring-blue-500/50' : ''}`}
            >
              {pack.popular && (
                <div className="absolute -top-3 left-1/2 -translate-x-1/2 bg-blue-600 text-white text-[10px] font-black px-3 py-1 rounded-full uppercase tracking-tighter">
                  Le plus populaire
                </div>
              )}

              <div className="space-y-4">
                <div className={`w-12 h-12 rounded-2xl bg-gradient-to-br ${pack.color} flex items-center justify-center text-white shadow-lg`}>
                  <Zap className="w-6 h-6 fill-current" />
                </div>
                <div>
                  <h3 className="text-lg font-bold">{pack.label}</h3>
                  <p className="text-xs text-gray-500 mt-1 leading-relaxed">{pack.desc}</p>
                </div>
                <div className="flex items-baseline gap-1 pt-2">
                  <span className="text-3xl font-black">{pack.price}</span>
                  <span className="text-xs text-gray-400">pour {pack.credits} crédits</span>
                </div>
              </div>

              <button
                onClick={() => handleBuy(pack.key)}
                disabled={!!buyLoading}
                className={`mt-8 w-full py-3 rounded-xl font-bold text-sm flex items-center justify-center gap-2 transition-all ${
                  pack.popular 
                    ? 'bg-blue-600 text-white hover:bg-blue-700 shadow-lg shadow-blue-500/20' 
                    : 'bg-gray-100 text-gray-800 hover:bg-gray-200'
                } disabled:opacity-50`}
              >
                {buyLoading === pack.key ? (
                  <Loader2 className="w-4 h-4 animate-spin" />
                ) : (
                  <>Recharger <ArrowRight className="w-4 h-4" /></>
                )}
              </button>
            </motion.div>
          ))}
        </div>
        
        <div className="flex flex-col md:flex-row items-center justify-center gap-6 text-[10px] text-gray-400 uppercase font-bold tracking-widest pt-4">
          <div className="flex items-center gap-2"><ShieldCheck className="w-4 h-4 text-emerald-500" /> Transaction SSL 256-bit</div>
          <div className="flex items-center gap-2"><CreditCard className="w-4 h-4 text-emerald-500" /> Propulsé par Stripe & Polar</div>
          <div className="flex items-center gap-2"><CheckCircle2 className="w-4 h-4 text-emerald-500" /> Aucun abonnement</div>
        </div>
      </section>

      {/* HISTORIQUE */}
      <section className="bg-[var(--bg-soft)] rounded-3xl border border-[var(--border)] overflow-hidden">
        <div className="p-6 border-b border-[var(--border)] flex items-center justify-between">
          <div className="flex items-center gap-2">
            <History className="w-5 h-5 text-gray-400" />
            <h2 className="text-sm font-bold uppercase tracking-wider text-gray-500">Historique des transactions</h2>
          </div>
        </div>

        <div className="overflow-x-auto">
          <table className="w-full text-left text-sm">
            <thead className="bg-gray-50/50 text-gray-400 text-[10px] font-black uppercase tracking-widest">
              <tr>
                <th className="px-6 py-4">Date & Heure</th>
                <th className="px-6 py-4">Pack</th>
                <th className="px-6 py-4">Crédits</th>
                <th className="px-6 py-4">Montant</th>
                <th className="px-6 py-4">Statut</th>
              </tr>
            </thead>
            <tbody className="divide-y divide-[var(--border)]">
              {rechargesLoading ? (
                <tr><td colSpan={5} className="px-6 py-10 text-center text-gray-400">Chargement de l'historique...</td></tr>
              ) : recharges.length === 0 ? (
                <tr><td colSpan={5} className="px-6 py-10 text-center text-gray-400">Aucune transaction trouvée.</td></tr>
              ) : (
                recharges.map((r) => (
                  <tr key={r.id} className="hover:bg-white/50 transition-colors">
                    <td className="px-6 py-4 text-gray-600 flex items-center gap-2">
                      <Clock className="w-3.5 h-3.5 opacity-40" />
                      {r.createdAt ? new Date(r.createdAt).toLocaleString("fr-FR", { dateStyle: 'short', timeStyle: 'short' }) : '—'}
                    </td>
                    <td className="px-6 py-4 font-semibold">Pack {r.creditsAdded}</td>
                    <td className="px-6 py-4"><span className="text-emerald-600 font-bold">+{r.creditsAdded} ⚡</span></td>
                    <td className="px-6 py-4 font-medium">{(Number(r.amount) / 100).toFixed(2)} {String(r.currency).toUpperCase()}</td>
                    <td className="px-6 py-4">
                      <span className={`px-2 py-1 rounded-full text-[10px] font-bold uppercase ${
                        r.status === 'success' ? 'bg-emerald-100 text-emerald-700' : 'bg-amber-100 text-amber-700'
                      }`}>
                        {r.status || 'pending'}
                      </span>
                    </td>
                  </tr>
                ))
              )}
            </tbody>
          </table>
        </div>
      </section>

      {/* INFOS FOOTER */}
      <div className="flex items-start gap-3 p-4 bg-blue-50 rounded-2xl border border-blue-100 text-blue-700 text-xs">
        <Info className="w-4 h-4 mt-0.5 flex-shrink-0" />
        <p className="leading-relaxed">
          <strong>Comment ça marche ?</strong> Un crédit correspond à une action IA majeure (Analyse CV, lettre de motivation, etc.). Vos crédits n'expirent jamais. En cas de problème lors du paiement, contactez le support.
        </p>
      </div>

      {/* IFRAME MODAL (Paiement) */}
      <AnimatePresence>
        {embedUrl && (
          <motion.div 
            initial={{ opacity: 0 }} 
            animate={{ opacity: 1 }} 
            exit={{ opacity: 0 }}
            className="fixed inset-0 z-[60] flex items-center justify-center p-4 sm:p-6 bg-black/80 backdrop-blur-md"
          >
            <motion.div 
              initial={{ scale: 0.9, y: 20 }} 
              animate={{ scale: 1, y: 0 }}
              className="relative w-full max-w-xl bg-white rounded-3xl shadow-2xl overflow-hidden flex flex-col h-[650px] max-h-full"
            >
              <div className="px-6 py-4 border-b border-gray-100 flex items-center justify-between">
                <div className="flex items-center gap-3">
                  <div className="w-8 h-8 rounded-lg bg-blue-600 flex items-center justify-center text-white">
                    <ShieldCheck className="w-5 h-5" />
                  </div>
                  <div>
                    <h3 className="text-sm font-bold">Paiement Sécurisé</h3>
                    <p className="text-[10px] text-gray-400 uppercase tracking-tighter">Propulsé par Polar & Stripe</p>
                  </div>
                </div>
                <button 
                  onClick={() => { setEmbedUrl(null); setBuyLoading(null); }}
                  className="p-2 hover:bg-gray-100 rounded-full transition-colors"
                >
                  <X className="w-5 h-5" />
                </button>
              </div>

              <iframe
                ref={iframeRef}
                src={embedUrl}
                className="w-full flex-1 border-0"
                title="Polar Checkout"
                allow="payment *; publickey-credentials-get *"
              />
            </motion.div>
          </motion.div>
        )}
      </AnimatePresence>
    </div>
  );
}

const X = ({ className }: { className?: string }) => (
  <svg className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor">
    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
  </svg>
);
````

## File: app/app/cv/page.tsx
````typescript
"use client";

import { useEffect, useMemo, useState } from "react";
import { useAuth } from "@/context/AuthContext";
import { db } from "@/lib/firebase";
import { doc, getDoc } from "firebase/firestore";
import { motion, AnimatePresence } from "framer-motion";
import {
  BrainCircuit, Trophy, Loader2, ArrowRight, RefreshCcw,
  FileText, AlertTriangle, Sparkles, Copy, MonitorPlay,
  CheckCircle2, XCircle, HelpCircle, BarChart3
} from "lucide-react";

// --- TYPES ---
type Question = {
  id: number;
  question: string;
  options: string[];
  correctAnswer: number;
  explanation: string;
};

type QuizState = "idle" | "loading" | "playing" | "finished";

// --- MOCK AI GENERATOR (À remplacer par ton appel réel plus tard) ---
const mockGenerateQuiz = async (jobTitle: string): Promise<Question[]> => {
  await new Promise((resolve) => setTimeout(resolve, 1500));
  return [
    {
      id: 1,
      question: `Dans le cadre d'un poste de ${jobTitle}, quelle est la priorité absolue lors d'un incident critique ?`,
      options: [
        "Chercher un coupable",
        "Communiquer et isoler le problème",
        "Éteindre tous les systèmes",
        "Attendre que ça passe"
      ],
      correctAnswer: 1,
      explanation: "La communication et l'endiguement sont les premières étapes pour limiter l'impact."
    },
    {
      id: 2,
      question: "Quel outil de collaboration est le plus adapté pour suivre l'avancement des tâches ?",
      options: ["Excel (local)", "Jira / Trello", "WhatsApp", "Post-it sur l'écran"],
      correctAnswer: 1,
      explanation: "Les outils agiles comme Jira permettent une traçabilité et une collaboration temps réel."
    },
    {
      id: 3,
      question: "Quelle soft skill est la plus valorisée pour ce rôle ?",
      options: ["L'autorité", "L'écoute active", "La vitesse de frappe", "La mémorisation"],
      correctAnswer: 1,
      explanation: "L'écoute active est fondamentale pour comprendre les besoins réels des parties prenantes."
    },
    {
      id: 4,
      question: "Comment gérer un conflit d'équipe ?",
      options: ["Ignorer le conflit", "Médiation factuelle", "Prendre parti immédiatement", "Licencier tout le monde"],
      correctAnswer: 1,
      explanation: "Une approche factuelle et neutre permet de désamorcer les tensions émotionnelles."
    }
  ];
};

export default function QuizPage() {
  const { user } = useAuth();
  
  // Profil
  const [jobTitle, setJobTitle] = useState<string | null>(null);
  const [loadingProfile, setLoadingProfile] = useState(true);

  // Quiz State
  const [status, setStatus] = useState<QuizState>("idle");
  const [questions, setQuestions] = useState<Question[]>([]);
  const [currentIndex, setCurrentIndex] = useState(0);
  const [score, setScore] = useState(0);
  const [selectedOption, setSelectedOption] = useState<number | null>(null);
  const [isAnswered, setIsAnswered] = useState(false);
  const [errorMsg, setErrorMsg] = useState<string | null>(null);

  // Load Profile
  useEffect(() => {
    if (!user) { setLoadingProfile(false); return; }
    getDoc(doc(db, "profiles", user.uid)).then(snap => {
      if (snap.exists()) setJobTitle(snap.data().title || null);
      setLoadingProfile(false);
    });
  }, [user]);

  // Actions
  const startQuiz = async () => {
    if (!jobTitle) return;
    setStatus("loading");
    setErrorMsg(null);
    try {
      const data = await mockGenerateQuiz(jobTitle);
      setQuestions(data);
      setCurrentIndex(0);
      setScore(0);
      setIsAnswered(false);
      setSelectedOption(null);
      setStatus("playing");
    } catch (e) {
      console.error(e);
      setErrorMsg("Erreur génération quiz.");
      setStatus("idle");
    }
  };

  const handleAnswer = (idx: number) => {
    if (isAnswered) return;
    setSelectedOption(idx);
    setIsAnswered(true);
    if (idx === questions[currentIndex].correctAnswer) setScore(s => s + 1);
  };

  const nextQuestion = () => {
    if (currentIndex < questions.length - 1) {
      setCurrentIndex(c => c + 1);
      setIsAnswered(false);
      setSelectedOption(null);
    } else {
      setStatus("finished");
    }
  };

  const resetQuiz = () => {
    setStatus("idle");
    setQuestions([]);
    setCurrentIndex(0);
    setScore(0);
  };

  if (loadingProfile) return <div className="h-screen flex items-center justify-center bg-[#0A0A0B]"><Loader2 className="w-8 h-8 text-blue-500 animate-spin" /></div>;

  const progress = questions.length > 0 ? ((currentIndex + 1) / questions.length) * 100 : 0;
  const scorePercent = questions.length > 0 ? Math.round((score / questions.length) * 100) : 0;

  return (
    <div className="min-h-screen bg-[#0A0A0B] text-slate-200 font-sans p-4 lg:p-8">
       <div className="max-w-6xl mx-auto grid lg:grid-cols-[350px,1fr] gap-6 h-[calc(100vh-4rem)]">
          
          {/* GAUCHE : INFO & STATUT */}
          <div className="flex flex-col gap-4">
             {/* Header Card */}
             <div className="bg-[#16181D] border border-white/10 rounded-2xl p-6 shadow-xl">
                <div className="flex items-center gap-3 mb-4">
                    <div className="w-10 h-10 rounded-lg bg-gradient-to-br from-purple-600 to-indigo-600 flex items-center justify-center shadow-lg shadow-purple-500/20">
                        <BrainCircuit className="w-5 h-5 text-white" />
                    </div>
                    <div>
                        <h1 className="font-bold text-white leading-tight">Quiz IA</h1>
                        <p className="text-[10px] text-purple-400 font-mono uppercase tracking-wider">Skill Check</p>
                    </div>
                </div>
                
                <div className="p-3 bg-white/5 rounded-xl border border-white/5 space-y-2">
                   <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Cible</p>
                   {jobTitle ? (
                      <div className="flex items-center gap-2 text-sm font-medium text-white">
                         <BriefcaseIcon className="w-4 h-4 text-slate-400" />
                         {jobTitle}
                      </div>
                   ) : (
                      <div className="flex items-center gap-2 text-sm text-yellow-500">
                         <AlertTriangle className="w-4 h-4" /> Aucun poste détecté
                      </div>
                   )}
                </div>
             </div>

             {/* Stats Card (Visible only when playing/finished) */}
             <AnimatePresence>
               {(status === "playing" || status === "finished") && (
                 <motion.div 
                   initial={{ opacity: 0, y: 10 }} animate={{ opacity: 1, y: 0 }}
                   className="bg-[#16181D] border border-white/10 rounded-2xl p-6 shadow-lg flex-1"
                 >
                    <div className="flex items-center justify-between mb-4">
                       <span className="text-xs font-bold text-slate-400 uppercase tracking-wider">Score actuel</span>
                       <BarChart3 className="w-4 h-4 text-slate-600" />
                    </div>
                    <div className="flex items-baseline gap-2">
                       <span className="text-4xl font-black text-white">{score}</span>
                       <span className="text-sm text-slate-500 font-medium">/ {questions.length}</span>
                    </div>
                    <div className="w-full bg-white/5 rounded-full h-1.5 mt-4 overflow-hidden">
                       <motion.div 
                         className="h-full bg-purple-500" 
                         initial={{ width: 0 }} 
                         animate={{ width: `${(score / questions.length) * 100}%` }} 
                       />
                    </div>
                 </motion.div>
               )}
             </AnimatePresence>
          </div>

          {/* DROITE : ZONE DE JEU */}
          <div className="flex flex-col h-full min-h-0 bg-[#16181D] border border-white/10 rounded-3xl shadow-2xl relative overflow-hidden">
             
             {/* IDLE STATE */}
             {status === "idle" && (
                <div className="flex-1 flex flex-col items-center justify-center p-8 text-center space-y-6">
                   <div className="w-24 h-24 bg-purple-500/10 rounded-full flex items-center justify-center border border-purple-500/20 mb-4">
                      <Sparkles className="w-10 h-10 text-purple-500" />
                   </div>
                   <div>
                      <h2 className="text-2xl font-bold text-white mb-2">Testez vos connaissances</h2>
                      <p className="text-slate-400 max-w-md mx-auto">
                         L'IA va générer un quiz technique unique basé sur votre poste de <span className="text-white font-semibold">{jobTitle || "..."}</span>.
                      </p>
                   </div>
                   <button 
                     onClick={startQuiz} 
                     disabled={!jobTitle}
                     className="px-8 py-3 rounded-xl bg-purple-600 hover:bg-purple-500 text-white font-bold shadow-lg shadow-purple-500/25 transition-all flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
                   >
                     <MonitorPlay className="w-4 h-4" /> Démarrer le Quiz
                   </button>
                   {!jobTitle && <p className="text-xs text-red-400 bg-red-500/10 px-3 py-1 rounded-full">Veuillez d'abord compléter votre profil CV.</p>}
                </div>
             )}

             {/* LOADING STATE */}
             {status === "loading" && (
                <div className="flex-1 flex flex-col items-center justify-center p-8 text-center space-y-4">
                   <Loader2 className="w-12 h-12 text-purple-500 animate-spin" />
                   <p className="text-slate-300 font-medium">L'IA analyse votre profil...</p>
                </div>
             )}

             {/* PLAYING STATE */}
             {status === "playing" && (
                <div className="flex flex-col h-full">
                   {/* Progress Bar Top */}
                   <div className="h-1 w-full bg-white/5">
                      <motion.div 
                        className="h-full bg-purple-500" 
                        initial={{ width: 0 }} 
                        animate={{ width: `${progress}%` }} 
                        transition={{ type: "spring", stiffness: 50 }}
                      />
                   </div>

                   <div className="flex-1 overflow-y-auto p-6 md:p-10 flex flex-col max-w-3xl mx-auto w-full">
                      <div className="mb-8">
                         <span className="inline-block px-3 py-1 rounded-full bg-white/5 border border-white/10 text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-4">
                            Question {currentIndex + 1}
                         </span>
                         <h3 className="text-xl md:text-2xl font-bold text-white leading-relaxed">
                            {questions[currentIndex].question}
                         </h3>
                      </div>

                      <div className="space-y-3">
                         {questions[currentIndex].options.map((opt, idx) => {
                            let stateClass = "border-white/10 bg-white/5 hover:bg-white/10 text-slate-300";
                            let icon = <div className="w-5 h-5 rounded-full border border-white/20 flex items-center justify-center text-[10px]">{String.fromCharCode(65+idx)}</div>;

                            if (isAnswered) {
                               if (idx === questions[currentIndex].correctAnswer) {
                                  stateClass = "border-green-500/50 bg-green-500/10 text-green-200";
                                  icon = <CheckCircle2 className="w-5 h-5 text-green-500" />;
                               } else if (idx === selectedOption) {
                                  stateClass = "border-red-500/50 bg-red-500/10 text-red-200";
                                  icon = <XCircle className="w-5 h-5 text-red-500" />;
                               } else {
                                  stateClass = "opacity-40 border-white/5 bg-transparent";
                               }
                            } else if (selectedOption === idx) {
                               stateClass = "border-purple-500 bg-purple-500/20 text-white";
                            }

                            return (
                               <button 
                                 key={idx}
                                 onClick={() => handleAnswer(idx)}
                                 disabled={isAnswered}
                                 className={`w-full p-4 rounded-xl border flex items-center gap-4 text-left transition-all ${stateClass}`}
                               >
                                  {icon}
                                  <span className="font-medium text-sm md:text-base">{opt}</span>
                               </button>
                            );
                         })}
                      </div>

                      {/* Explanation Reveal */}
                      <AnimatePresence>
                         {isAnswered && (
                            <motion.div 
                              initial={{ opacity: 0, y: 20 }} 
                              animate={{ opacity: 1, y: 0 }} 
                              className="mt-8 p-4 rounded-xl bg-blue-500/10 border border-blue-500/20"
                            >
                               <div className="flex items-start gap-3">
                                  <HelpCircle className="w-5 h-5 text-blue-400 shrink-0 mt-0.5" />
                                  <div>
                                     <p className="text-xs font-bold text-blue-300 uppercase mb-1">Explication</p>
                                     <p className="text-sm text-slate-300 leading-relaxed">{questions[currentIndex].explanation}</p>
                                  </div>
                               </div>
                               <div className="mt-4 flex justify-end">
                                  <button onClick={nextQuestion} className="px-6 py-2 rounded-lg bg-white text-black font-bold text-sm hover:bg-slate-200 transition-colors flex items-center gap-2">
                                     Suivant <ArrowRight className="w-4 h-4" />
                                  </button>
                               </div>
                            </motion.div>
                         )}
                      </AnimatePresence>
                   </div>
                </div>
             )}

             {/* FINISHED STATE */}
             {status === "finished" && (
                <div className="flex-1 flex flex-col items-center justify-center p-8 text-center">
                   <motion.div 
                     initial={{ scale: 0.8, opacity: 0 }} 
                     animate={{ scale: 1, opacity: 1 }} 
                     className="relative mb-8"
                   >
                      <div className="absolute inset-0 bg-purple-500 blur-[60px] opacity-20" />
                      <div className="relative w-32 h-32 bg-gradient-to-tr from-purple-500 to-indigo-500 rounded-full flex items-center justify-center shadow-2xl border-4 border-[#16181D]">
                         <Trophy className="w-14 h-14 text-white" />
                      </div>
                      <div className="absolute -bottom-3 left-1/2 -translate-x-1/2 bg-[#16181D] border border-white/10 px-4 py-1 rounded-full text-xs font-bold text-white shadow-lg whitespace-nowrap">
                         Score Final
                      </div>
                   </motion.div>

                   <h2 className="text-3xl font-black text-white mb-2">{score} / {questions.length}</h2>
                   <p className="text-slate-400 mb-8 max-w-xs mx-auto">
                      {scorePercent >= 80 ? "Excellent travail ! Vous maîtrisez votre sujet." : 
                       scorePercent >= 50 ? "Bien joué ! Encore quelques efforts pour l'excellence." : 
                       "Continuez à vous entraîner, la maîtrise viendra !"}
                   </p>

                   <div className="flex gap-3">
                      <button onClick={resetQuiz} className="px-6 py-3 rounded-xl bg-white/5 hover:bg-white/10 border border-white/10 text-white font-bold transition-all flex items-center gap-2">
                         <RefreshCcw className="w-4 h-4" /> Recommencer
                      </button>
                      <button onClick={() => { navigator.clipboard.writeText(`J'ai fait ${score}/${questions.length} au quiz ${jobTitle} sur SmartApply !`); alert("Copié !"); }} className="px-6 py-3 rounded-xl bg-purple-600 hover:bg-purple-500 text-white font-bold shadow-lg shadow-purple-500/20 transition-all flex items-center gap-2">
                         <Copy className="w-4 h-4" /> Partager
                      </button>
                   </div>
                </div>
             )}

          </div>

       </div>
    </div>
  );
}

// Icon helper
function BriefcaseIcon(props: any) {
  return (
    <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="20" height="14" x="2" y="7" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>
  );
}
````

## File: app/app/layout.tsx
````typescript
"use client";

import React, { ReactNode, useEffect, useMemo, useRef, useState } from "react";
import Link from "next/link";
import { usePathname, useRouter } from "next/navigation";
import {
  collection,
  doc,
  onSnapshot,
  orderBy,
  query,
  where,
} from "firebase/firestore";
import { AnimatePresence, motion } from "framer-motion";
import { useTranslation } from "react-i18next";
import {
  LayoutDashboard,
  Target,
  Mic,
  History,
  Zap,
  Settings,
  LogOut,
  ChevronRight,
  Moon,
  Sun,
  Check,
  X,
  Wand2,
  GraduationCap,
  Menu,
  Search,
  Command,
  Bell,
  Globe,
  Briefcase,
  ExternalLink,
} from "lucide-react";

import { useAuth } from "@/context/AuthContext";
import { db, auth } from "@/lib/firebase";
import { signOut } from "firebase/auth";

/**
 * ✅ AMÉLIORATIONS:
 * - Mode Jour/Nuit robuste (class + localStorage + meta theme-color)
 * - Barre de recherche dispo mobile (bouton + overlay)
 * - Langues étendues + menu propre (FR/EN/ES/DE/IT/PT)
 * - Notifications “réelles” côté UI (badge + panel) avec contenu basé sur candidatures
 * - Nav responsive + accessibilité + fermeture via ESC + click outside
 */

// --- CONFIG NAV ---
const NAV_LINKS = [
  { href: "/app", key: "profile", label: "Tableau de bord", icon: LayoutDashboard },
  { href: "/app/lm", key: "assistant", label: "Assistant Candidature", icon: Wand2 },
  { href: "/app/tracker", key: "tracker", label: "Suivi Job", icon: Target },
  { href: "/app/interview", key: "interview", label: "Interview IA", icon: Mic },
  { href: "/app/cv", key: "quiz", label: "Quiz & Tests", icon: GraduationCap },
  { href: "/app/history", key: "history", label: "Historique", icon: History },
  { href: "/app/credits", key: "credits", label: "Crédits & Plan", icon: Zap },
] as const;

type AppLang = "fr" | "en" | "es" | "de" | "it" | "pt";

const LANGUAGES: Array<{ code: AppLang; label: string; flag: string }> = [
  { code: "fr", label: "Français", flag: "🇫🇷" },
  { code: "en", label: "English", flag: "🇺🇸" },
  { code: "es", label: "Español", flag: "🇪🇸" },
  { code: "de", label: "Deutsch", flag: "🇩🇪" },
  { code: "it", label: "Italiano", flag: "🇮🇹" },
  { code: "pt", label: "Português", flag: "🇵🇹" },
];

// --- TYPES ---
type ApplicationLite = {
  id: string;
  company?: string;
  jobTitle?: string;
  status?: string;
  jobLink?: string;
  interviewAt?: any;
  createdAt?: any;
};

// --- THEME HELPERS ---
type ThemeMode = "dark" | "light";
const THEME_KEY = "theme_mode_v1";

function applyTheme(mode: ThemeMode) {
  const root = document.documentElement;
  if (mode === "dark") root.classList.add("dark");
  else root.classList.remove("dark");

  // optionnel: meta theme-color (mobile chrome)
  const meta = document.querySelector('meta[name="theme-color"]');
  if (meta) meta.setAttribute("content", mode === "dark" ? "#0A0A0B" : "#F8FAFC");
}

function detectInitialTheme(): ThemeMode {
  if (typeof window === "undefined") return "dark";
  const saved = window.localStorage.getItem(THEME_KEY) as ThemeMode | null;
  if (saved === "dark" || saved === "light") return saved;
  const isSystemDark = window.matchMedia?.("(prefers-color-scheme: dark)")?.matches ?? true;
  return isSystemDark ? "dark" : "light";
}

// --- DATE HELPERS ---
function safeToDate(v: any): Date | null {
  try {
    if (!v) return null;
    if (v instanceof Date) return v;
    if (typeof v?.toDate === "function") return v.toDate();
    const d = new Date(v);
    return Number.isFinite(d.getTime()) ? d : null;
  } catch {
    return null;
  }
}

function fmtDateTime(d?: Date | null) {
  if (!d) return "";
  return d.toLocaleString("fr-FR", {
    day: "2-digit",
    month: "short",
    hour: "2-digit",
    minute: "2-digit",
  });
}

// --- APP HEADER ---
interface AppHeaderProps {
  title: string;
  credits: number | null;
  user: any;
  applications: ApplicationLite[];
  onToggleSidebar: () => void;
  handleLogout: () => void;
}

function AppHeader({
  title,
  credits,
  user,
  applications,
  onToggleSidebar,
  handleLogout,
}: AppHeaderProps) {
  const { i18n } = useTranslation();
  const router = useRouter();

  // Theme
  const [theme, setTheme] = useState<ThemeMode>("dark");

  // Menus
  const [showLangMenu, setShowLangMenu] = useState(false);
  const [showUserMenu, setShowUserMenu] = useState(false);
  const [showNotifs, setShowNotifs] = useState(false);

  // Search
  const [searchQuery, setSearchQuery] = useState("");
  const [searchOpenDesktop, setSearchOpenDesktop] = useState(false);
  const [searchOpenMobile, setSearchOpenMobile] = useState(false);

  // Refs
  const langRef = useRef<HTMLDivElement>(null);
  const userRef = useRef<HTMLDivElement>(null);
  const notifRef = useRef<HTMLDivElement>(null);
  const searchRef = useRef<HTMLDivElement>(null);

  // Init theme
  useEffect(() => {
    const initial = detectInitialTheme();
    setTheme(initial);
    applyTheme(initial);
  }, []);

  const toggleTheme = () => {
    const next: ThemeMode = theme === "dark" ? "light" : "dark";
    setTheme(next);
    applyTheme(next);
    localStorage.setItem(THEME_KEY, next);
  };

  const changeLang = (code: AppLang) => {
    i18n.changeLanguage(code);
    setShowLangMenu(false);
  };

  // Close on outside click
  useEffect(() => {
    const onDown = (e: MouseEvent) => {
      const t = e.target as Node;
      if (langRef.current && !langRef.current.contains(t)) setShowLangMenu(false);
      if (userRef.current && !userRef.current.contains(t)) setShowUserMenu(false);
      if (notifRef.current && !notifRef.current.contains(t)) setShowNotifs(false);
      if (searchRef.current && !searchRef.current.contains(t)) setSearchOpenDesktop(false);
    };
    document.addEventListener("mousedown", onDown);
    return () => document.removeEventListener("mousedown", onDown);
  }, []);

  // Close on ESC
  useEffect(() => {
    const onKey = (e: KeyboardEvent) => {
      if (e.key === "Escape") {
        setShowLangMenu(false);
        setShowUserMenu(false);
        setShowNotifs(false);
        setSearchOpenDesktop(false);
        setSearchOpenMobile(false);
      }
      // Ctrl/Cmd+K => open search
      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === "k") {
        e.preventDefault();
        setSearchOpenDesktop(true);
      }
    };
    window.addEventListener("keydown", onKey);
    return () => window.removeEventListener("keydown", onKey);
  }, []);

  // 🔍 Mixed search (pages + apps)
  const q = searchQuery.trim().toLowerCase();

  const filteredPages = useMemo(() => {
    if (!q) return [];
    return NAV_LINKS.filter((l) => l.label.toLowerCase().includes(q)).slice(0, 6);
  }, [q]);

  const filteredApps = useMemo(() => {
    if (!q) return [];
    return applications
      .filter((app) => {
        const a = (app.company || "").toLowerCase();
        const b = (app.jobTitle || "").toLowerCase();
        return a.includes(q) || b.includes(q);
      })
      .slice(0, 6);
  }, [q, applications]);

  // 🔔 Notifications (simple + utile)
  const now = Date.now();
  const upcomingInterviews = useMemo(() => {
    return applications
      .map((a) => ({ ...a, interviewDate: safeToDate((a as any).interviewAt) }))
      .filter((a) => a.interviewDate && a.interviewDate.getTime() > now)
      .sort((a, b) => a.interviewDate!.getTime() - b.interviewDate!.getTime())
      .slice(0, 5);
  }, [applications, now]);

  const notifs = useMemo(() => {
    const items: Array<{
      id: string;
      title: string;
      desc?: string;
      href?: string;
      icon: React.ReactNode;
      tone: "info" | "warn";
    }> = [];

    for (const it of upcomingInterviews) {
      items.push({
        id: `interview-${it.id}`,
        title: `Entretien à venir : ${it.company || "Entreprise"}`,
        desc: `${it.jobTitle || "Poste"} • ${fmtDateTime(it.interviewDate)}`,
        href: "/app/tracker",
        icon: <Bell className="h-4 w-4" />,
        tone: "warn",
      });
    }

    // Suggestion / reminder
    items.push({
      id: "tip-1",
      title: "Astuce : optimise ton CV pour une offre",
      desc: "Dans Assistant candidature → colle l’offre → Téléchargement optimisé IA.",
      href: "/app/lm",
      icon: <Wand2 className="h-4 w-4" />,
      tone: "info",
    });

    return items.slice(0, 6);
  }, [upcomingInterviews]);

  const notifCount = notifs.length;

  const SearchResults = ({ onPick }: { onPick: () => void }) => (
    <div className="bg-[var(--panel)] border border-[var(--border)] rounded-xl shadow-2xl overflow-hidden">
      {(filteredPages.length > 0 || filteredApps.length > 0) ? (
        <div className="divide-y divide-[var(--border)]/70">
          {filteredPages.length > 0 && (
            <div className="p-2">
              <p className="px-2 py-1 text-[10px] font-bold text-[var(--muted)] uppercase tracking-wider">
                Navigation
              </p>
              {filteredPages.map((link) => (
                <button
                  key={link.key}
                  onClick={() => {
                    router.push(link.href);
                    onPick();
                  }}
                  className="w-full flex items-center gap-3 px-3 py-2 text-xs text-[var(--ink)]/90 hover:bg-[var(--bg-soft)] rounded-lg transition-colors text-left"
                >
                  <link.icon className="h-4 w-4 text-[var(--muted)]" />
                  <span className="truncate">{link.label}</span>
                </button>
              ))}
            </div>
          )}

          {filteredApps.length > 0 && (
            <div className="p-2">
              <p className="px-2 py-1 text-[10px] font-bold text-[var(--muted)] uppercase tracking-wider">
                Mes candidatures
              </p>
              {filteredApps.map((app) => (
                <button
                  key={app.id}
                  onClick={() => {
                    router.push("/app/tracker");
                    onPick();
                  }}
                  className="w-full flex items-center gap-3 px-3 py-2 text-xs hover:bg-[var(--bg-soft)] rounded-lg transition-colors text-left group"
                >
                  <Briefcase className="h-4 w-4 text-blue-500" />
                  <div className="min-w-0">
                    <div className="truncate">
                      <span className="text-[var(--ink)] font-medium">{app.jobTitle || "Poste"}</span>
                      <span className="text-[var(--muted)] mx-1">chez</span>
                      <span className="text-blue-400 group-hover:underline">{app.company || "Entreprise"}</span>
                    </div>
                    {app.jobLink ? (
                      <div className="text-[10px] text-[var(--muted)] flex items-center gap-1 mt-0.5">
                        <ExternalLink className="h-3 w-3" />
                        Lien offre
                      </div>
                    ) : null}
                  </div>
                </button>
              ))}
            </div>
          )}
        </div>
      ) : (
        <div className="p-4 text-center text-xs text-[var(--muted)]">
          Aucun résultat pour &quot;{searchQuery}&quot;
        </div>
      )}
    </div>
  );

  // CSS vars for both themes (keeps your page standalone)
  // You can move this to globals later.
  const ThemeVars = (
    <style jsx global>{`
      :root {
        --bg: #0a0a0b;
        --bg-soft: rgba(255, 255, 255, 0.05);
        --panel: #16181d;
        --ink: #e5e7eb;
        --muted: rgba(148, 163, 184, 0.9);
        --border: rgba(255, 255, 255, 0.08);
        --brand: #3b82f6;
      }
      :root:not(.dark) {
        --bg: #f8fafc;
        --bg-soft: rgba(15, 23, 42, 0.04);
        --panel: #ffffff;
        --ink: #0f172a;
        --muted: rgba(71, 85, 105, 0.85);
        --border: rgba(15, 23, 42, 0.10);
        --brand: #2563eb;
      }
      .custom-scrollbar::-webkit-scrollbar {
        width: 10px;
        height: 10px;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb {
        background: rgba(148, 163, 184, 0.25);
        border-radius: 999px;
      }
      .custom-scrollbar::-webkit-scrollbar-track {
        background: transparent;
      }
    `}</style>
  );

  return (
    <>
      {ThemeVars}

      <header className="sticky top-0 z-30 w-full border-b border-[var(--border)] bg-[var(--bg)]/80 backdrop-blur-xl transition-all">
        <div className="flex h-16 items-center justify-between px-4 sm:px-6 lg:px-8">
          {/* LEFT */}
          <div className="flex items-center gap-3">
            <button
              onClick={onToggleSidebar}
              className="md:hidden -ml-2 p-2 rounded-lg text-[var(--muted)] hover:text-[var(--ink)] hover:bg-[var(--bg-soft)] transition-colors"
              aria-label="Ouvrir le menu"
            >
              <Menu className="h-5 w-5" />
            </button>

            <div className="flex flex-col">
              <h1 className="text-sm font-semibold text-[var(--ink)] tracking-tight truncate max-w-[45vw] sm:max-w-none">
                {title}
              </h1>
              <span className="text-[10px] text-[var(--muted)] hidden sm:block">
                {user?.email}
              </span>
            </div>
          </div>

          {/* CENTER (Desktop search) */}
          <div className="hidden md:flex items-center justify-center flex-1 max-w-md mx-4 relative" ref={searchRef}>
            <div
              className={[
                "w-full flex items-center justify-between px-3 py-1.5 rounded-lg border bg-[var(--bg-soft)] text-xs transition-all",
                searchOpenDesktop ? "border-[var(--brand)]/50 ring-2 ring-[var(--brand)]/10" : "border-[var(--border)] hover:border-[var(--border)]/80",
              ].join(" ")}
            >
              <div className="flex items-center gap-2 flex-1">
                <Search className="h-3.5 w-3.5 text-[var(--muted)]" />
                <input
                  className="bg-transparent border-none outline-none text-[var(--ink)] w-full placeholder:text-[var(--muted)] h-full py-1"
                  placeholder="Rechercher (pages + candidatures)…"
                  value={searchQuery}
                  onFocus={() => setSearchOpenDesktop(true)}
                  onChange={(e) => setSearchQuery(e.target.value)}
                />
              </div>

              {!searchOpenDesktop && (
                <div className="flex items-center gap-1 opacity-60 bg-[var(--bg-soft)] px-1.5 rounded text-[10px] border border-[var(--border)]">
                  <Command className="h-3 w-3" />
                  <span>K</span>
                </div>
              )}
            </div>

            <AnimatePresence>
              {searchOpenDesktop && searchQuery.trim() && (
                <motion.div
                  initial={{ opacity: 0, y: 6 }}
                  animate={{ opacity: 1, y: 0 }}
                  exit={{ opacity: 0, y: 6 }}
                  className="absolute top-full left-0 right-0 mt-2 z-50"
                >
                  <SearchResults onPick={() => setSearchOpenDesktop(false)} />
                </motion.div>
              )}
            </AnimatePresence>
          </div>

          {/* RIGHT */}
          <div className="flex items-center gap-2 sm:gap-3">
            {/* Mobile search button */}
            <button
              onClick={() => setSearchOpenMobile(true)}
              className="md:hidden p-2 rounded-full text-[var(--muted)] hover:text-[var(--ink)] hover:bg-[var(--bg-soft)] transition-colors"
              aria-label="Rechercher"
            >
              <Search className="h-4 w-4" />
            </button>

            {/* Language */}
            <div className="relative hidden sm:block" ref={langRef}>
              <button
                onClick={() => setShowLangMenu((v) => !v)}
                className="flex items-center gap-1.5 px-2 py-1.5 rounded-lg text-xs font-medium text-[var(--muted)] hover:text-[var(--ink)] hover:bg-[var(--bg-soft)] transition-colors"
                aria-label="Changer la langue"
              >
                <Globe className="h-4 w-4" />
                <span className="uppercase">{(i18n.language || "fr").slice(0, 2)}</span>
              </button>

              <AnimatePresence>
                {showLangMenu && (
                  <motion.div
                    initial={{ opacity: 0, scale: 0.96, y: 6 }}
                    animate={{ opacity: 1, scale: 1, y: 0 }}
                    exit={{ opacity: 0, scale: 0.96, y: 6 }}
                    className="absolute right-0 top-full mt-2 w-44 bg-[var(--panel)] border border-[var(--border)] rounded-xl shadow-xl z-50 overflow-hidden"
                  >
                    <div className="p-1">
                      {LANGUAGES.map((lang) => (
                        <button
                          key={lang.code}
                          onClick={() => changeLang(lang.code)}
                          className={[
                            "w-full flex items-center justify-between px-3 py-2 text-xs rounded-lg transition-colors",
                            i18n.language === lang.code
                              ? "bg-[var(--brand)]/10 text-[var(--brand)]"
                              : "text-[var(--ink)]/90 hover:bg-[var(--bg-soft)]",
                          ].join(" ")}
                        >
                          <span className="flex items-center gap-2">
                            <span>{lang.flag}</span>
                            <span>{lang.label}</span>
                          </span>
                          {i18n.language === lang.code && <Check className="h-3.5 w-3.5" />}
                        </button>
                      ))}
                    </div>
                  </motion.div>
                )}
              </AnimatePresence>
            </div>

            {/* Theme */}
            <button
              onClick={toggleTheme}
              className="p-2 rounded-full text-[var(--muted)] hover:text-[var(--brand)] hover:bg-[var(--bg-soft)] transition-colors"
              aria-label="Basculer le thème"
            >
              {theme === "dark" ? <Moon className="h-4 w-4" /> : <Sun className="h-4 w-4" />}
            </button>

            {/* Notifications */}
            <div className="relative" ref={notifRef}>
              <button
                onClick={() => setShowNotifs((v) => !v)}
                className="relative p-2 rounded-full text-[var(--muted)] hover:text-[var(--ink)] hover:bg-[var(--bg-soft)] transition-colors"
                aria-label="Notifications"
              >
                <Bell className="h-4 w-4" />
                {notifCount > 0 && (
                  <span className="absolute -top-0.5 -right-0.5 min-w-[16px] h-[16px] px-1 rounded-full bg-red-500 text-white text-[10px] leading-[16px] text-center border border-[var(--bg)]">
                    {Math.min(9, notifCount)}
                  </span>
                )}
              </button>

              <AnimatePresence>
                {showNotifs && (
                  <motion.div
                    initial={{ opacity: 0, y: 8, scale: 0.98 }}
                    animate={{ opacity: 1, y: 0, scale: 1 }}
                    exit={{ opacity: 0, y: 8, scale: 0.98 }}
                    className="absolute right-0 top-full mt-2 w-[320px] max-w-[85vw] rounded-xl border border-[var(--border)] bg-[var(--panel)] shadow-2xl overflow-hidden z-50"
                  >
                    <div className="p-3 border-b border-[var(--border)] flex items-center justify-between">
                      <p className="text-xs font-bold text-[var(--ink)] uppercase tracking-wider">
                        Notifications
                      </p>
                      <button
                        onClick={() => setShowNotifs(false)}
                        className="p-1 rounded-lg hover:bg-[var(--bg-soft)] text-[var(--muted)] hover:text-[var(--ink)]"
                        aria-label="Fermer"
                      >
                        <X className="h-4 w-4" />
                      </button>
                    </div>

                    <div className="max-h-[360px] overflow-auto custom-scrollbar">
                      {notifs.map((n) => (
                        <button
                          key={n.id}
                          onClick={() => {
                            if (n.href) router.push(n.href);
                            setShowNotifs(false);
                          }}
                          className="w-full text-left p-3 hover:bg-[var(--bg-soft)] transition-colors border-b border-[var(--border)] last:border-b-0"
                        >
                          <div className="flex items-start gap-3">
                            <div
                              className={[
                                "mt-0.5 h-8 w-8 rounded-xl flex items-center justify-center border",
                                n.tone === "warn"
                                  ? "bg-amber-500/10 border-amber-500/20 text-amber-500"
                                  : "bg-[var(--brand)]/10 border-[var(--brand)]/20 text-[var(--brand)]",
                              ].join(" ")}
                            >
                              {n.icon}
                            </div>
                            <div className="min-w-0">
                              <p className="text-xs font-semibold text-[var(--ink)] truncate">
                                {n.title}
                              </p>
                              {n.desc ? (
                                <p className="text-[11px] text-[var(--muted)] mt-0.5 line-clamp-2">
                                  {n.desc}
                                </p>
                              ) : null}
                            </div>
                          </div>
                        </button>
                      ))}
                      {notifs.length === 0 && (
                        <div className="p-4 text-center text-xs text-[var(--muted)]">
                          Rien à signaler.
                        </div>
                      )}
                    </div>
                  </motion.div>
                )}
              </AnimatePresence>
            </div>

            {/* Credits */}
            <Link
              href="/app/credits"
              className="hidden md:flex items-center gap-1.5 px-3 py-1 rounded-full bg-[var(--brand)]/10 border border-[var(--brand)]/20 text-[var(--brand)] text-xs font-medium whitespace-nowrap hover:bg-[var(--brand)]/15 transition-colors"
            >
              <Zap className="h-3.5 w-3.5 fill-current" />
              <span>{credits ?? "..."}</span>
            </Link>

            {/* User */}
            <div className="relative" ref={userRef}>
              <button
                onClick={() => setShowUserMenu((v) => !v)}
                className="flex items-center gap-2 p-1 pl-2 pr-1 rounded-full border border-[var(--border)] bg-[var(--panel)] hover:bg-[var(--bg-soft)] transition-all outline-none"
                aria-label="Menu utilisateur"
              >
                <span className="text-xs font-medium text-[var(--ink)] max-w-[120px] truncate hidden lg:block">
                  {user?.displayName || user?.email}
                </span>
                <div className="h-8 w-8 rounded-full bg-gradient-to-tr from-blue-600 to-indigo-600 flex items-center justify-center text-white text-xs font-bold shadow-md ring-2 ring-[var(--bg)]">
                  {(user?.email?.[0] || "U").toUpperCase()}
                </div>
              </button>

              <AnimatePresence>
                {showUserMenu && (
                  <motion.div
                    initial={{ opacity: 0, y: 8, scale: 0.96 }}
                    animate={{ opacity: 1, y: 0, scale: 1 }}
                    exit={{ opacity: 0, y: 8, scale: 0.96 }}
                    className="absolute right-0 top-full mt-2 w-56 rounded-xl border border-[var(--border)] bg-[var(--panel)] shadow-2xl z-50 overflow-hidden"
                  >
                    <div className="p-4 border-b border-[var(--border)] bg-[var(--bg-soft)]">
                      <p className="text-sm font-semibold text-[var(--ink)] truncate">
                        {user?.displayName || "Utilisateur"}
                      </p>
                      <p className="text-xs text-[var(--muted)] truncate">{user?.email}</p>
                    </div>
                    <div className="p-1.5 flex flex-col gap-0.5">
                      <Link
                        href="/app/settings"
                        className="flex items-center gap-2 px-3 py-2 text-xs rounded-lg text-[var(--ink)]/90 hover:bg-[var(--bg-soft)] transition-colors"
                      >
                        <Settings className="h-4 w-4 text-[var(--muted)]" />
                        <span>Paramètres</span>
                      </Link>

                      <button
                        onClick={handleLogout}
                        className="w-full flex items-center gap-2 px-3 py-2 text-xs rounded-lg text-red-400 hover:bg-red-500/10 transition-colors"
                      >
                        <LogOut className="h-4 w-4" />
                        <span>Déconnexion</span>
                      </button>
                    </div>
                  </motion.div>
                )}
              </AnimatePresence>
            </div>
          </div>
        </div>
      </header>

      {/* MOBILE SEARCH OVERLAY */}
      <AnimatePresence>
        {searchOpenMobile && (
          <>
            <motion.div
              initial={{ opacity: 0 }}
              animate={{ opacity: 1 }}
              exit={{ opacity: 0 }}
              onClick={() => setSearchOpenMobile(false)}
              className="fixed inset-0 bg-black/60 backdrop-blur-sm z-[60] md:hidden"
            />
            <motion.div
              initial={{ y: 20, opacity: 0, scale: 0.98 }}
              animate={{ y: 0, opacity: 1, scale: 1 }}
              exit={{ y: 20, opacity: 0, scale: 0.98 }}
              className="fixed left-0 right-0 top-0 z-[70] md:hidden p-3"
            >
              <div className="mx-auto max-w-xl rounded-2xl border border-[var(--border)] bg-[var(--panel)] shadow-2xl overflow-hidden">
                <div className="p-3 border-b border-[var(--border)] flex items-center gap-2">
                  <Search className="h-4 w-4 text-[var(--muted)]" />
                  <input
                    autoFocus
                    className="flex-1 bg-transparent outline-none text-sm text-[var(--ink)] placeholder:text-[var(--muted)]"
                    placeholder="Rechercher (pages + candidatures)…"
                    value={searchQuery}
                    onChange={(e) => setSearchQuery(e.target.value)}
                  />
                  <button
                    onClick={() => setSearchOpenMobile(false)}
                    className="p-2 rounded-lg hover:bg-[var(--bg-soft)] text-[var(--muted)] hover:text-[var(--ink)]"
                    aria-label="Fermer"
                  >
                    <X className="h-4 w-4" />
                  </button>
                </div>

                <div className="p-2">
                  {searchQuery.trim() ? (
                    <SearchResults onPick={() => setSearchOpenMobile(false)} />
                  ) : (
                    <div className="p-4 text-center text-xs text-[var(--muted)]">
                      Tape pour rechercher.
                    </div>
                  )}
                </div>
              </div>
            </motion.div>
          </>
        )}
      </AnimatePresence>
    </>
  );
}

// --- LAYOUT PRINCIPAL ---
export default function UserAppLayout({ children }: { children: ReactNode }) {
  const { user, loading } = useAuth();
  const router = useRouter();
  const pathname = usePathname();

  const [credits, setCredits] = useState<number | null>(null);
  const [applications, setApplications] = useState<ApplicationLite[]>([]);
  const [clientReady, setClientReady] = useState(false);

  const [sidebarOpen, setSidebarOpen] = useState(false);
  const [desktopExpanded, setDesktopExpanded] = useState(true);

  useEffect(() => setClientReady(true), []);

  // Close drawer on route change
  useEffect(() => setSidebarOpen(false), [pathname]);

  // Fetch user credits + applications for global search
  useEffect(() => {
    if (!clientReady || loading) return;
    if (!user) {
      router.replace("/login");
      return;
    }

    const unsubUser = onSnapshot(doc(db, "users", user.uid), async (snap) => {
      if (!snap.exists()) return;
      const data: any = snap.data();
      if (data?.blocked) {
        await signOut(auth);
        router.replace("/login?blocked=1");
        return;
      }
      setCredits(typeof data?.credits === "number" ? data.credits : 0);
    });

    const qApps = query(
      collection(db, "applications"),
      where("userId", "==", user.uid),
      orderBy("createdAt", "desc")
    );

    const unsubApps = onSnapshot(qApps, (snap) => {
      const list = snap.docs.map((d) => ({ id: d.id, ...d.data() })) as any[];
      setApplications(list);
    });

    return () => {
      unsubUser();
      unsubApps();
    };
  }, [clientReady, loading, user, router]);

  const handleLogout = async () => {
    await signOut(auth);
    router.replace("/login");
  };

  const pageTitle =
    NAV_LINKS.find((l) => pathname === l.href || pathname.startsWith(l.href + "/"))?.label ||
    "Tableau de bord";

  if (!clientReady || loading || !user) {
    return (
      <div className="min-h-screen bg-[var(--bg)] flex items-center justify-center">
        <div className="animate-spin h-8 w-8 border-4 border-[var(--brand)] rounded-full border-t-transparent" />
      </div>
    );
  }

  return (
    <div className="flex h-screen bg-[var(--bg)] text-[var(--ink)] overflow-hidden font-sans selection:bg-[var(--brand)]/30">
      {/* SIDEBAR (Desktop) */}
      <motion.aside
        initial={false}
        animate={{ width: desktopExpanded ? 260 : 80 }}
        className="hidden md:flex flex-col border-r border-[var(--border)] bg-[var(--panel)] z-40 transition-all duration-300"
      >
        <div className="h-16 flex items-center px-4 border-b border-[var(--border)]">
          <Link href="/app" className="flex items-center gap-3 overflow-hidden">
            <div className="h-9 w-9 min-w-[2.25rem] rounded-xl bg-[var(--brand)]/10 border border-[var(--brand)]/25 flex items-center justify-center text-[var(--brand)] shadow-sm">
              <Zap className="h-4 w-4 fill-current" />
            </div>

            {desktopExpanded && (
              <motion.div
                initial={{ opacity: 0 }}
                animate={{ opacity: 1 }}
                transition={{ delay: 0.08 }}
                className="flex flex-col whitespace-nowrap"
              >
                <span className="text-sm font-bold text-[var(--ink)] tracking-tight">SmartApply</span>
                <span className="text-[10px] text-[var(--muted)]">Suite IA</span>
              </motion.div>
            )}
          </Link>
        </div>

        <nav className="flex-1 overflow-y-auto p-3 space-y-1 custom-scrollbar">
          {NAV_LINKS.map((link) => {
            const isActive = pathname === link.href || pathname.startsWith(link.href + "/");
            return (
              <Link
                key={link.key}
                href={link.href}
                className={[
                  "group flex items-center gap-3 px-3 py-2.5 rounded-xl text-sm font-medium transition-all border border-transparent",
                  isActive
                    ? "bg-[var(--brand)] text-white shadow-md shadow-[var(--brand)]/20"
                    : "text-[var(--muted)] hover:text-[var(--ink)] hover:bg-[var(--bg-soft)]",
                ].join(" ")}
                title={!desktopExpanded ? link.label : ""}
              >
                <link.icon
                  className={[
                    "h-5 w-5 flex-shrink-0",
                    isActive ? "text-white" : "text-[var(--muted)] group-hover:text-[var(--ink)]",
                  ].join(" ")}
                />
                {desktopExpanded && (
                  <motion.span initial={{ opacity: 0 }} animate={{ opacity: 1 }} className="truncate">
                    {link.label}
                  </motion.span>
                )}
              </Link>
            );
          })}
        </nav>

        <div className="p-4 border-t border-[var(--border)]">
          <button
            onClick={() => setDesktopExpanded((v) => !v)}
            className="w-full flex items-center justify-center p-2 rounded-xl text-[var(--muted)] hover:bg-[var(--bg-soft)] hover:text-[var(--ink)] transition-colors"
            aria-label="Réduire/agrandir la sidebar"
          >
            <ChevronRight className={`h-5 w-5 transition-transform ${desktopExpanded ? "rotate-180" : ""}`} />
          </button>
        </div>
      </motion.aside>

      {/* CONTENT */}
      <div className="flex-1 flex flex-col min-w-0 relative">
        {/* subtle background */}
        <div className="pointer-events-none absolute inset-0 -z-10 bg-[radial-gradient(circle_at_top,_rgba(37,99,235,0.12),_transparent_55%),radial-gradient(circle_at_bottom,_rgba(16,185,129,0.10),_transparent_55%)]" />

        <AppHeader
          title={pageTitle}
          credits={credits}
          user={user}
          applications={applications}
          onToggleSidebar={() => setSidebarOpen(true)}
          handleLogout={handleLogout}
        />

        <main className="flex-1 overflow-y-auto p-4 sm:p-6 lg:p-8 relative z-10 custom-scrollbar">
          <div className="max-w-7xl mx-auto space-y-6">{children}</div>
        </main>
      </div>

      {/* MOBILE DRAWER */}
      <AnimatePresence>
        {sidebarOpen && (
          <>
            <motion.div
              initial={{ opacity: 0 }}
              animate={{ opacity: 1 }}
              exit={{ opacity: 0 }}
              onClick={() => setSidebarOpen(false)}
              className="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 md:hidden"
            />
            <motion.div
              initial={{ x: "-100%" }}
              animate={{ x: 0 }}
              exit={{ x: "-100%" }}
              transition={{ type: "spring", stiffness: 320, damping: 34 }}
              className="fixed inset-y-0 left-0 w-3/4 max-w-[300px] bg-[var(--panel)] border-r border-[var(--border)] z-50 md:hidden shadow-2xl flex flex-col"
            >
              <div className="h-16 flex items-center justify-between px-5 border-b border-[var(--border)]">
                <div className="flex items-center gap-3">
                  <div className="h-9 w-9 rounded-xl bg-[var(--brand)]/10 border border-[var(--brand)]/25 flex items-center justify-center text-[var(--brand)]">
                    <Zap className="h-4 w-4 fill-current" />
                  </div>
                  <span className="font-bold text-[var(--ink)]">SmartApply</span>
                </div>
                <button
                  onClick={() => setSidebarOpen(false)}
                  className="p-2 rounded-lg hover:bg-[var(--bg-soft)] text-[var(--muted)] hover:text-[var(--ink)]"
                  aria-label="Fermer"
                >
                  <X className="w-5 h-5" />
                </button>
              </div>

              <div className="flex-1 overflow-y-auto p-4 space-y-1 custom-scrollbar">
                {NAV_LINKS.map((link) => {
                  const active = pathname === link.href || pathname.startsWith(link.href + "/");
                  return (
                    <Link
                      key={link.key}
                      href={link.href}
                      onClick={() => setSidebarOpen(false)}
                      className={[
                        "flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium border border-transparent transition-colors",
                        active
                          ? "bg-[var(--brand)] text-white shadow-lg shadow-[var(--brand)]/20"
                          : "text-[var(--muted)] hover:bg-[var(--bg-soft)] hover:text-[var(--ink)]",
                      ].join(" ")}
                    >
                      <link.icon className="h-5 w-5" />
                      <span className="truncate">{link.label}</span>
                    </Link>
                  );
                })}
              </div>

              <div className="p-4 border-t border-[var(--border)] space-y-2">
                <div className="flex items-center justify-between text-xs text-[var(--muted)]">
                  <span>Crédits</span>
                  <span className="text-[var(--ink)] font-bold">{credits ?? "—"}</span>
                </div>
                <button
                  onClick={handleLogout}
                  className="w-full flex items-center gap-2 px-4 py-3 text-sm rounded-xl text-red-400 hover:bg-red-500/10 transition-colors"
                >
                  <LogOut className="h-4 w-4" />
                  <span>Déconnexion</span>
                </button>
              </div>
            </motion.div>
          </>
        )}
      </AnimatePresence>
    </div>
  );
}
````

## File: app/app/page.tsx
````typescript
"use client";

import React, { useEffect, useMemo, useRef, useState, ChangeEvent, FormEvent } from "react";
import { motion, AnimatePresence } from "framer-motion";
import Chart from "chart.js/auto";

// Firebase
import { auth, db } from "@/lib/firebase";
import { onAuthStateChanged } from "firebase/auth";
import { doc, getDoc, setDoc, collection, query, where, onSnapshot } from "firebase/firestore";

// Contexts / services
import { useAuth } from "@/context/AuthContext";
import { useUserProfile } from "@/hooks/useUserProfile";
import { consumeCredits } from "@/lib/credits";
import { logUsage } from "@/lib/userTracking";
import { getRecaptchaToken } from "@/lib/recaptcha";

// Icons
import {
  Zap,
  FileText,
  Mail,
  Phone,
  Linkedin,
  MapPin,
  Briefcase,
  Car,
  BadgeCheck,
  Languages,
  Sparkles,
  Upload,
  ChevronRight,
  Info,
  PencilLine,
  X,
  Plus,
  Trash2,
  Save,
  Download,
  ArrowUp,
  ArrowDown,
  ShieldCheck,
  Cpu,
  AlertTriangle,
  CheckCircle2,
} from "lucide-react";

// ✅ Proxy Next.js
const WORKER_URL = "/api/extractProfile";

/* =========================
   TYPES
========================= */
type CvSkillsSection = { title: string; items: string[] };
type CvSkills = { sections: CvSkillsSection[]; tools: string[] };

type CvExperience = {
  company: string;
  role: string;
  dates: string;
  bullets: string[];
  location?: string;
};

type CvEducation = {
  school: string;
  degree: string;
  dates: string;
  location?: string;
};

type CvProfile = {
  fullName: string;
  email: string;
  phone: string;
  linkedin: string;
  profileSummary: string;

  city?: string;
  address?: string;

  contractType: string;
  contractTypeStandard?: string;
  contractTypeFull?: string;

  primaryDomain?: string;
  secondaryDomains?: string[];
  softSkills?: string[];

  drivingLicense?: string;
  vehicle?: string;

  skills: CvSkills;
  experiences: CvExperience[];
  education: CvEducation[];
  educationShort: string[];
  certs: string;
  langLine: string;
  hobbies: string[];

  updatedAt?: number;
};

type DashboardCounts = { totalApps: number; cvCount: number; lmCount: number };

type ActiveModal = "infos" | "skills" | "experience" | "education" | "languages" | "hobbies" | null;

type ExperienceDraft = { company: string; role: string; dates: string; bulletsText: string; location?: string };
type EducationDraft = { school: string; degree: string; dates: string; location: string };
type LanguageDraft = { language: string; level: string };

/* =========================
   CONSTANTES / OPTIONS
========================= */
const LANGUAGE_OPTIONS = [
  "Français",
  "Anglais",
  "Espagnol",
  "Allemand",
  "Italien",
  "Portugais",
  "Néerlandais",
  "Arabe",
  "Russe",
  "Chinois (Mandarin)",
  "Japonais",
  "Coréen",
  "Hindi",
  "Turc",
];

const LANGUAGE_LEVEL_OPTIONS = [
  "Natif / Bilingue (C2)",
  "Courant (C1)",
  "Intermédiaire (B2)",
  "Opérationnel (B1)",
  "Débutant (A2 - A1)",
];

const CONTRACT_TYPE_OPTIONS = ["CDI", "CDD", "Intérim", "Alternance", "Stage", "Freelance", "Temps plein", "Temps partiel"];

const CERTIFICATION_OPTIONS = [
  "TOEIC",
  "TOEFL",
  "IELTS",
  "CCNA",
  "CCNP",
  "CompTIA Security+",
  "CompTIA Network+",
  "AWS Cloud Practitioner",
  "AWS Solutions Architect Associate",
  "Azure AZ-900",
  "Azure AZ-104",
  "Azure AZ-500",
  "Azure SC-900",
  "Azure MS-900",
  "Google Cloud Digital Leader",
  "PMI PMP",
  "Prince2 Foundation",
  "Prince2 Practitioner",
  "ITIL Foundation",
  "CFA Niveau 1",
  "AMF",
  "Tosa Excel",
];

const HOBBY_OPTIONS = [
  "Voyage",
  "Lecture",
  "Musique",
  "Piano",
  "Guitare",
  "Sport (Football)",
  "Sport (Basketball)",
  "Fitness / Musculation",
  "Course à pied",
  "Randonnée",
  "Natation",
  "Cinéma",
  "Séries",
  "Jeux vidéo",
  "Photographie",
  "Cuisine",
  "Pâtisserie",
  "Dessin",
  "Peinture",
  "Art digital",
  "Bénévolat",
  "Entrepreneuriat",
  "Technologie / veille tech",
  "Échecs",
  "Podcasts",
];

/* =========================
   HELPERS UI / TEXT
========================= */
function getInitials(name?: string) {
  if (!name) return "IA";
  const parts = name.trim().split(/\s+/);
  if (!parts.length) return "IA";
  if (parts.length === 1) return (parts[0][0] || "I").toUpperCase();
  return (((parts[0][0] || "I") + (parts[parts.length - 1][0] || "A")).toUpperCase()).slice(0, 2);
}

function formatUpdatedAt(ts?: number) {
  if (!ts) return "";
  const d = new Date(ts);
  return new Intl.DateTimeFormat("fr-FR", {
    day: "2-digit",
    month: "short",
    year: "numeric",
    hour: "2-digit",
    minute: "2-digit",
  }).format(d);
}

function normalizeText(str: string): string {
  return (str || "").normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
}

function getFlagEmoji(langPart: string): string {
  if (!langPart) return "🌐";
  const lower = langPart.toLowerCase();
  let base = lower.replace(/\(.*?\)/g, " ").trim();

  const levelWords = [
    "natif",
    "bilingue",
    "courant",
    "intermédiaire",
    "intermediaire",
    "débutant",
    "debutant",
    "langue maternelle",
    "maternelle",
    "c1",
    "c2",
    "b1",
    "b2",
    "a1",
    "a2",
  ];

  levelWords.forEach((w) => {
    base = base.replace(new RegExp("\\b" + w + "\\b", "g"), " ");
  });

  base = base.trim() || lower;

  if (base.match(/\bfrançais\b|\bfrancais\b|\bfrench\b/)) return "🇫🇷";
  if (base.match(/\banglais\b|\benglish\b/)) return "🇬🇧";
  if (base.match(/\bamericain\b|\bétats-unis\b|\busa\b|\bamerican\b/)) return "🇺🇸";
  if (base.match(/\bespagnol\b|\bspanish\b/)) return "🇪🇸";
  if (base.match(/\ballemand\b|\bgerman\b/)) return "🇩🇪";
  if (base.match(/\bitalien\b|\bitalian\b/)) return "🇮🇹";
  if (base.match(/\bportugais\b|\bportuguese\b/)) return "🇵🇹";
  if (base.match(/\bnéerlandais\b|\bdutch\b/)) return "🇳🇱";
  if (base.match(/\barabe\b|\barabic\b/)) return "🇸🇦";
  if (base.match(/\bchinois\b|\bmandarin\b|\bchinese\b/)) return "🇨🇳";
  if (base.match(/\brusse\b|\brussian\b/)) return "🇷🇺";
  if (base.match(/\bjaponais\b|\bjapanese\b/)) return "🇯🇵";
  if (base.match(/\bcoréen\b|\bcoreen\b|\bkorean\b/)) return "🇰🇷";
  if (base.match(/\bhindi\b/)) return "🇮🇳";
  if (base.match(/\bturc\b|\bturkish\b/)) return "🇹🇷";

  return "🌐";
}

function parseLangLine(langLine: string): { flag: string; text: string }[] {
  if (!langLine) return [];
  const parts = langLine
    .split("·")
    .join("|")
    .split(",")
    .join("|")
    .split("|")
    .map((p) => p.trim())
    .filter(Boolean);

  return parts.map((part) => ({ flag: getFlagEmoji(part), text: part }));
}

function getHobbyEmoji(hobby: string): string {
  const p = hobby.toLowerCase();
  if (p.includes("football") || p.includes("foot")) return "⚽";
  if (p.includes("basket")) return "🏀";
  if (p.includes("sport") || p.includes("fitness") || p.includes("gym")) return "💪";
  if (p.includes("musique") || p.includes("guitare") || p.includes("piano")) return "🎵";
  if (p.includes("lecture") || p.includes("livre")) return "📚";
  if (p.includes("cinéma") || p.includes("cinema") || p.includes("film")) return "🎬";
  if (p.includes("jeu") || p.includes("gaming")) return "🎮";
  if (p.includes("voyage") || p.includes("travel")) return "✈️";
  if (p.includes("cuisine") || p.includes("cooking")) return "🍳";
  if (p.includes("photo")) return "📸";
  if (p.includes("dessin") || p.includes("peinture") || p.includes("art")) return "🎨";
  if (p.includes("randonnée") || p.includes("rando") || p.includes("hiking")) return "🥾";
  return "⭐";
}

function fileToBase64(file: File): Promise<string> {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onerror = () => reject(new Error("Impossible de lire le fichier."));
    reader.onload = () => {
      const result = reader.result as string;
      const base64 = result.split(",")[1];
      if (!base64) reject(new Error("Encodage base64 invalide."));
      else resolve(base64);
    };
    reader.readAsDataURL(file);
  });
}

function downloadJson(filename: string, data: unknown) {
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json;charset=utf-8" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

/* =========================
   RADAR (multi-domaines)
========================= */
type RadarAxisDef = { id: string; label: string; keywords: string[] };

const DOMAIN_AXES: RadarAxisDef[] = [
  { id: "finance", label: "Finance & Contrôle", keywords: ["finance", "audit", "ifrs", "budget", "reporting", "tresorerie", "trésorerie", "controle de gestion", "contrôle de gestion"] },
  { id: "it_dev", label: "IT & Développement", keywords: ["react", "next", "typescript", "javascript", "python", "api", "node", "git", "docker", "kubernetes", "devops"] },
  { id: "cyber", label: "Cybersécurité & Réseaux", keywords: ["cyber", "pentest", "soc", "siem", "owasp", "vpn", "firewall", "nmap", "kali", "wireshark"] },
  { id: "data", label: "Data & Analytics", keywords: ["data", "sql", "power bi", "tableau", "pandas", "numpy", "machine learning", "ia", "analyse de données"] },
  { id: "marketing", label: "Marketing & Communication", keywords: ["seo", "sea", "community", "social media", "branding", "campagne", "communication"] },
  { id: "sales", label: "Commerce & Vente", keywords: ["commercial", "vente", "prospection", "negociation", "pipeline", "account manager", "business developer", "b2b"] },
  { id: "hr", label: "RH & Recrutement", keywords: ["rh", "recrutement", "talent acquisition", "paie", "gestion du personnel", "onboarding"] },
  { id: "project", label: "Gestion de projet", keywords: ["chef de projet", "agile", "scrum", "kanban", "roadmap", "planning", "pilotage"] },
];

const SOFT_SKILLS_KEYWORDS = [
  "communication",
  "travail en equipe",
  "collaboration",
  "autonomie",
  "rigoureux",
  "organise",
  "adaptabilite",
  "gestion du stress",
  "leadership",
  "esprit d analyse",
  "empathie",
  "relationnel",
];

function countHits(keywords: string[], text: string): number {
  let hits = 0;
  for (const k of keywords) if (text.includes(normalizeText(k))) hits++;
  return hits;
}

function scaleScore(hits: number): number {
  if (hits <= 0) return 3;
  if (hits === 1) return 5;
  if (hits === 2) return 7;
  if (hits === 3) return 9;
  return 10;
}

function buildRadarData(profile: CvProfile | null) {
  const defaultLabels = ["Analyse", "Organisation", "Outils", "Apprentissage", "Soft skills"];
  if (!profile) return { labels: defaultLabels, data: [3, 3, 3, 3, 3] };

  const rawText =
    JSON.stringify(profile.skills?.sections || []) +
    JSON.stringify(profile.skills?.tools || []) +
    JSON.stringify(profile.experiences || []) +
    JSON.stringify(profile.education || []) +
    (profile.profileSummary || "") +
    (profile.certs || "") +
    (profile.langLine || "");

  const lower = normalizeText(rawText);

  // Si domaines fournis, on les privilégie ; sinon top 4 par hits.
  const ids = new Set<string>();
  if (profile.primaryDomain) ids.add(profile.primaryDomain);
  (profile.secondaryDomains || []).forEach((d) => d && ids.add(d));

  let relevant = Array.from(ids)
    .map((id) => DOMAIN_AXES.find((a) => a.id === id))
    .filter(Boolean) as RadarAxisDef[];

  if (!relevant.length) {
    relevant = DOMAIN_AXES
      .map((axis) => ({ axis, hits: countHits(axis.keywords, lower) }))
      .filter((x) => x.hits > 0)
      .sort((a, b) => b.hits - a.hits)
      .slice(0, 4)
      .map((x) => x.axis);
  }

  const softHits = countHits(SOFT_SKILLS_KEYWORDS, lower) + Math.min(4, Math.floor((profile.softSkills?.length || 0) / 2));
  const softScore = scaleScore(softHits);

  if (!relevant.length) {
    const generic = [
      scaleScore(countHits(["analyse", "diagnostic"], lower)),
      scaleScore(countHits(["processus", "organisation"], lower)),
      scaleScore(countHits(["outil", "logiciel", "technique"], lower)),
      scaleScore(countHits(["apprentissage", "formation", "veille"], lower)),
    ];
    return { labels: defaultLabels, data: [...generic, softScore] };
  }

  const labels = relevant.map((r) => r.label).concat("Soft skills");
  const data = relevant.map((r) => scaleScore(countHits(r.keywords, lower))).concat(softScore);

  return { labels, data };
}

/* =========================
   NAV
========================= */
type NavItem = {
  id: string;
  label: string;
  icon: React.ComponentType<{ className?: string }>;
};

const navItems: NavItem[] = [
  { id: "infos-personnelles", label: "Dashboard", icon: Cpu },
  { id: "competences", label: "Expertise", icon: Sparkles },
  { id: "experience", label: "Expériences", icon: Briefcase },
  { id: "formation", label: "Formations", icon: BadgeCheck },
  { id: "langues", label: "Langues", icon: Languages },
  { id: "hobbies", label: "Loisirs", icon: Sparkles },
];

/* =========================
   UI ATOMS
========================= */
function KpiItem({ label, value, sub, icon: Icon, color }: any) {
  return (
    <div className="p-5 rounded-[1.5rem] bg-slate-900/50 border border-white/5 backdrop-blur-md">
      <div className="flex items-center gap-3 mb-3">
        <div className={`p-2 rounded-lg bg-white/5 ${color}`}>
          <Icon className="h-4 w-4" />
        </div>
        <p className="text-[10px] font-black uppercase tracking-widest text-slate-500">{label}</p>
      </div>
      <p className="text-2xl font-mono font-bold text-white">{value}</p>
      <p className="text-[10px] text-slate-600 mt-1 uppercase font-bold tracking-tighter">{sub}</p>
    </div>
  );
}

function SectionWrapper({ id, title, icon: Icon, children, onEdit }: any) {
  return (
    <section id={id} className="p-8 rounded-[2rem] bg-slate-900/40 border border-white/5 relative group">
      <div className="flex justify-between items-center mb-8">
        <div className="flex items-center gap-4">
          <div className="p-3 rounded-2xl bg-blue-600/10 border border-blue-600/20">
            <Icon className="h-6 w-6 text-blue-500" />
          </div>
          <h3 className="text-2xl font-black text-white tracking-tighter italic">{title}</h3>
        </div>
        {onEdit && (
          <button
            onClick={onEdit}
            className="p-2 rounded-xl bg-white/5 border border-white/10 opacity-0 group-hover:opacity-100 transition-all text-blue-400 hover:bg-blue-600 hover:text-white"
          >
            <PencilLine className="h-4 w-4" />
          </button>
        )}
      </div>
      {children}
    </section>
  );
}

function EmptyState({ text }: { text: string }) {
  return (
    <div className="py-12 border-2 border-dashed border-white/5 rounded-3xl text-center">
      <p className="text-sm text-slate-600 italic font-mono uppercase tracking-widest">{text}</p>
    </div>
  );
}

function Toast({ text, tone = "info" }: { text: string; tone?: "info" | "success" | "error" }) {
  const toneCls =
    tone === "success"
      ? "border-emerald-500/30 bg-emerald-500/10 text-emerald-50"
      : tone === "error"
      ? "border-red-500/30 bg-red-500/10 text-red-50"
      : "border-blue-500/30 bg-blue-500/10 text-blue-50";

  return (
    <motion.div
      initial={{ opacity: 0, y: 8, scale: 0.98 }}
      animate={{ opacity: 1, y: 0, scale: 1 }}
      exit={{ opacity: 0, y: 8, scale: 0.98 }}
      className={`fixed bottom-5 left-1/2 -translate-x-1/2 z-[200] px-4 py-3 rounded-2xl border ${toneCls} backdrop-blur-xl shadow-xl`}
    >
      <div className="flex items-center gap-2 text-sm">
        {tone === "success" ? <CheckCircle2 className="h-4 w-4" /> : tone === "error" ? <AlertTriangle className="h-4 w-4" /> : <Info className="h-4 w-4" />}
        <span className="font-medium">{text}</span>
      </div>
    </motion.div>
  );
}

/* =========================
   PAGE
========================= */
export default function FullProfilCVIAPageMerged() {
  const { user } = useAuth();
  const { profile: accountProfile, loading: loadingAccountProfile } = useUserProfile();
  const remainingCredits = accountProfile?.credits ?? 0;
  const isBlocked = accountProfile?.blocked === true;

  const [profile, setProfile] = useState<CvProfile | null>(null);
  const [loadingProfileFromDb, setLoadingProfileFromDb] = useState(true);

  const [dashboardCounts, setDashboardCounts] = useState<DashboardCounts>({ totalApps: 0, cvCount: 0, lmCount: 0 });
  const [loadingCounts, setLoadingCounts] = useState(true);

  // Upload states
  const [file, setFile] = useState<File | null>(null);
  const [uploading, setUploading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  // UI
  const [activeSection, setActiveSection] = useState<string>("infos-personnelles");
  const [activeModal, setActiveModal] = useState<ActiveModal>(null);

  // Toast
  const [toast, setToast] = useState<{ text: string; tone?: "info" | "success" | "error" } | null>(null);
  const toastTimer = useRef<number | null>(null);
  const showToast = (text: string, tone: "info" | "success" | "error" = "info") => {
    setToast({ text, tone });
    if (toastTimer.current) window.clearTimeout(toastTimer.current);
    toastTimer.current = window.setTimeout(() => setToast(null), 2600);
  };

  // Radar
  const radarCanvasRef = useRef<HTMLCanvasElement | null>(null);

  // ====== Modals drafts ======
  const [infosDraft, setInfosDraft] = useState({
    fullName: "",
    email: "",
    phone: "",
    linkedin: "",
    contractType: "",
    profileSummary: "",
    drivingLicense: "",
    vehicle: "",
    address: "",
  });

  const [skillsSectionsText, setSkillsSectionsText] = useState("");
  const [skillsToolsText, setSkillsToolsText] = useState("");

  const [experiencesDraft, setExperiencesDraft] = useState<ExperienceDraft[]>([]);
  const [educationDrafts, setEducationDrafts] = useState<EducationDraft[]>([]);
  const [certsList, setCertsList] = useState<string[]>([]);
  const [certInput, setCertInput] = useState("");

  const [languagesDraft, setLanguagesDraft] = useState<LanguageDraft[]>([]);
  const [hobbiesList, setHobbiesList] = useState<string[]>([]);
  const [hobbyInput, setHobbyInput] = useState("");

  // ====== scroll spy (IntersectionObserver) ======
  useEffect(() => {
    const ids = navItems.map((n) => n.id);
    const els = ids.map((id) => document.getElementById(id)).filter(Boolean) as HTMLElement[];
    if (!els.length) return;

    const obs = new IntersectionObserver(
      (entries) => {
        const best = entries
          .filter((e) => e.isIntersecting)
          .sort((a, b) => (b.intersectionRatio ?? 0) - (a.intersectionRatio ?? 0))[0];
        if (best?.target?.id) setActiveSection(best.target.id);
      },
      { threshold: [0.2, 0.35, 0.5], rootMargin: "-20% 0px -65% 0px" }
    );

    els.forEach((el) => obs.observe(el));
    return () => obs.disconnect();
  }, []);

  // ====== Load auth + profile realtime + applications stats realtime ======
  useEffect(() => {
    let unsubProfile: (() => void) | null = null;
    let unsubApps: (() => void) | null = null;

    const unsubAuth = onAuthStateChanged(auth, async (fbUser) => {
      if (unsubProfile) unsubProfile();
      if (unsubApps) unsubApps();

      if (!fbUser) {
        setProfile(null);
        setLoadingProfileFromDb(false);
        setDashboardCounts({ totalApps: 0, cvCount: 0, lmCount: 0 });
        setLoadingCounts(false);
        return;
      }

      // Profil realtime
      setLoadingProfileFromDb(true);
      const ref = doc(db, "profiles", fbUser.uid);
      unsubProfile = onSnapshot(
        ref,
        (snap) => {
          if (snap.exists()) {
            const data = snap.data() as any;
            const loadedProfile: CvProfile = {
              fullName: data.fullName || "",
              email: data.email || "",
              phone: data.phone || "",
              linkedin: data.linkedin || "",
              profileSummary: data.profileSummary || "",
              city: data.city || "",
              address: data.address || "",
              contractType: data.contractType || data.contractTypeStandard || "",
              contractTypeStandard: data.contractTypeStandard || "",
              contractTypeFull: data.contractTypeFull || "",
              primaryDomain: data.primaryDomain || "",
              secondaryDomains: Array.isArray(data.secondaryDomains) ? data.secondaryDomains : [],
              softSkills: Array.isArray(data.softSkills) ? data.softSkills : [],
              drivingLicense: data.drivingLicense || "",
              vehicle: data.vehicle || "",
              skills: {
                sections: Array.isArray(data.skills?.sections) ? data.skills.sections : [],
                tools: Array.isArray(data.skills?.tools) ? data.skills.tools : [],
              },
              experiences: Array.isArray(data.experiences) ? data.experiences : [],
              education: Array.isArray(data.education) ? data.education : [],
              educationShort: Array.isArray(data.educationShort) ? data.educationShort : [],
              certs: data.certs || "",
              langLine: data.langLine || "",
              hobbies: Array.isArray(data.hobbies) ? data.hobbies : [],
              updatedAt: typeof data.updatedAt === "number" ? data.updatedAt : undefined,
            };
            setProfile(loadedProfile);
          } else {
            setProfile(null);
          }
          setLoadingProfileFromDb(false);
        },
        () => setLoadingProfileFromDb(false)
      );

      // Apps stats realtime
      setLoadingCounts(true);
      const q = query(collection(db, "applications"), where("userId", "==", fbUser.uid));
      unsubApps = onSnapshot(
        q,
        (snap) => {
          let totalApps = 0;
          let cvCount = 0;
          let lmCount = 0;
          snap.docs.forEach((d) => {
            const data = d.data() as any;
            totalApps++;
            if (data.hasCv) cvCount++;
            if (data.hasLm) lmCount++;
          });
          setDashboardCounts({ totalApps, cvCount, lmCount });
          setLoadingCounts(false);
        },
        () => setLoadingCounts(false)
      );
    });

    return () => {
      if (unsubProfile) unsubProfile();
      if (unsubApps) unsubApps();
      unsubAuth();
    };
  }, []);

  // ====== Save helpers ======
  const saveProfileToDb = async (p: CvProfile) => {
    if (!user) return;
    const ref = doc(db, "profiles", user.uid);
    await setDoc(ref, { ...p, ownerUid: user.uid, ownerEmail: user.email ?? null, updatedAt: Date.now() }, { merge: true });
  };

  // ====== Radar chart render ======
  useEffect(() => {
    if (!radarCanvasRef.current) return;

    const ctx = radarCanvasRef.current.getContext("2d");
    if (!ctx) return;

    const existing = Chart.getChart(radarCanvasRef.current as any);
    if (existing) existing.destroy();

    const { labels, data } = buildRadarData(profile);

    const chart = new Chart(ctx, {
      type: "radar",
      data: {
        labels,
        datasets: [
          {
            label: "Niveau estimé",
            data,
            backgroundColor: "rgba(59, 130, 246, 0.18)",
            borderColor: "rgba(59, 130, 246, 0.85)",
            borderWidth: 2,
            pointBackgroundColor: "rgba(59, 130, 246, 1)",
            pointRadius: 3,
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        devicePixelRatio: typeof window !== "undefined" ? window.devicePixelRatio : 1,
        scales: {
          r: {
            beginAtZero: true,
            min: 0,
            max: 10,
            ticks: { stepSize: 2, showLabelBackdrop: false, display: false },
            grid: { color: "rgba(255, 255, 255, 0.08)" },
            angleLines: { color: "rgba(255, 255, 255, 0.08)" },
            pointLabels: { font: { size: 11 }, color: "rgba(226, 232, 240, 0.7)" },
          },
        },
        plugins: { legend: { display: false } },
      },
    });

    return () => chart.destroy();
  }, [profile]);

  // ====== Upload handlers ======
  const handleFileChange = (e: ChangeEvent<HTMLInputElement>) => {
    setError(null);
    const f = e.target.files?.[0];
    if (!f) return;
    if (!f.type.includes("pdf")) {
      setError("Merci d'importer un CV au format PDF.");
      return;
    }
    setFile(f);
  };

  const handleUpload = async () => {
    if (!file) return setError("Choisis d'abord un CV au format PDF.");
    if (!user) return setError("Tu dois être connecté pour analyser ton CV.");
    if (loadingAccountProfile) return setError("Ton profil utilisateur charge, réessaie dans un instant.");
    if (isBlocked) return setError("Ton compte est bloqué. Contacte l'administrateur.");

    const cost = 1;
    if (remainingCredits < cost) return setError("Tu n'as plus assez de crédits pour analyser un CV.");

    setError(null);
    setUploading(true);

    try {
      await logUsage(user, "cv_analyze", { fileName: file.name, fileSize: file.size, feature: "cv-profile-merged" });

      const base64Pdf = await fileToBase64(file);
      const idToken = await user.getIdToken();
      const recaptchaToken = await getRecaptchaToken("extract_profile");

      const res = await fetch(WORKER_URL, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${idToken}`,
          "X-Recaptcha-Token": recaptchaToken,
        },
        body: JSON.stringify({
          base64Pdf,
          meta: { fileName: file.name, fileSize: file.size, feature: "cv-profile-merged" },
        }),
      });

      const json = await res.json().catch(() => null);
      if (!res.ok) {
        const msg = (json && (json.error || json.message)) || `HTTP ${res.status}`;
        throw new Error(msg);
      }

      // ✅ On consomme le crédit après un OK
      await consumeCredits(user.uid, cost);

      const now = Date.now();
      const rawProfile = json?.profile ?? json;

      const receivedProfile: CvProfile = {
        fullName: rawProfile.fullName || "",
        email: rawProfile.email || user.email || "",
        phone: rawProfile.phone || "",
        linkedin: rawProfile.linkedin || "",
        profileSummary: rawProfile.profileSummary || "",
        city: rawProfile.city || "",
        address: rawProfile.address || "",
        contractType: rawProfile.contractType || rawProfile.contractTypeStandard || "",
        contractTypeStandard: rawProfile.contractTypeStandard || "",
        contractTypeFull: rawProfile.contractTypeFull || "",
        primaryDomain: rawProfile.primaryDomain || "",
        secondaryDomains: Array.isArray(rawProfile.secondaryDomains) ? rawProfile.secondaryDomains : [],
        softSkills: Array.isArray(rawProfile.softSkills) ? rawProfile.softSkills : [],
        drivingLicense: rawProfile.drivingLicense || "",
        vehicle: rawProfile.vehicle || "",
        skills: {
          sections: Array.isArray(rawProfile.skills?.sections) ? rawProfile.skills.sections : [],
          tools: Array.isArray(rawProfile.skills?.tools) ? rawProfile.skills.tools : [],
        },
        experiences: Array.isArray(rawProfile.experiences) ? rawProfile.experiences : [],
        education: Array.isArray(rawProfile.education) ? rawProfile.education : [],
        educationShort: Array.isArray(rawProfile.educationShort) ? rawProfile.educationShort : [],
        certs: rawProfile.certs || "",
        langLine: rawProfile.langLine || "",
        hobbies: Array.isArray(rawProfile.hobbies) ? rawProfile.hobbies : [],
        updatedAt: now,
      };

      setProfile(receivedProfile);
      await saveProfileToDb(receivedProfile);
      showToast("CV analysé et profil mis à jour ✅", "success");
    } catch (err: any) {
      console.error(err);
      setError(err?.message || "Impossible d'analyser ton CV pour le moment.");
      showToast("Erreur d'analyse du CV", "error");
    } finally {
      setUploading(false);
    }
  };

  /* =========================
     NOUVEAU : Profil Strength + Checklist
  ========================= */
  const profileStrength = useMemo(() => {
    if (!profile) return { score: 0, filled: 0, total: 10 };

    const checks = [
      !!profile.fullName?.trim(),
      !!(profile.email || user?.email)?.trim(),
      !!profile.phone?.trim(),
      !!profile.linkedin?.trim(),
      !!profile.profileSummary?.trim(),
      !!profile.contractType?.trim(),
      (profile.skills?.sections?.length || 0) > 0 || (profile.skills?.tools?.length || 0) > 0,
      (profile.experiences?.length || 0) > 0,
      (profile.education?.length || 0) > 0 || !!profile.certs?.trim(),
      !!profile.langLine?.trim(),
    ];

    const filled = checks.filter(Boolean).length;
    const total = checks.length;
    const score = Math.round((filled / total) * 100);
    return { score, filled, total };
  }, [profile, user?.email]);

  const checklist = useMemo(() => {
    if (!profile) {
      return [
        { label: "Analyser ton CV", modal: null as ActiveModal, action: "upload" as const },
      ];
    }

    const items: { label: string; modal: ActiveModal; ok: boolean }[] = [
      { label: "Compléter tes infos (email/tel/LinkedIn)", modal: "infos", ok: !!(profile.email && profile.phone && profile.linkedin) },
      { label: "Ajouter un résumé de profil", modal: "infos", ok: !!profile.profileSummary?.trim() },
      { label: "Renseigner tes compétences & outils", modal: "skills", ok: (profile.skills?.sections?.length || 0) > 0 || (profile.skills?.tools?.length || 0) > 0 },
      { label: "Ajouter au moins une expérience", modal: "experience", ok: (profile.experiences?.length || 0) > 0 },
      { label: "Ajouter formation / certifs", modal: "education", ok: (profile.education?.length || 0) > 0 || !!profile.certs?.trim() },
      { label: "Ajouter tes langues", modal: "languages", ok: !!profile.langLine?.trim() },
      { label: "Ajouter tes loisirs", modal: "hobbies", ok: (profile.hobbies?.length || 0) > 0 },
    ];

    return items;
  }, [profile]);

  /* =========================
     MODAL OPENERS
  ========================= */
  const openInfosModal = () => {
    if (!profile) return;
    setInfosDraft({
      fullName: profile.fullName || "",
      email: profile.email || user?.email || "",
      phone: profile.phone || "",
      linkedin: profile.linkedin || "",
      contractType: profile.contractType || profile.contractTypeStandard || "",
      profileSummary: profile.profileSummary || "",
      drivingLicense: profile.drivingLicense || "",
      vehicle: profile.vehicle || "",
      address: profile.address || profile.city || "",
    });
    setActiveModal("infos");
  };

  const openSkillsModal = () => {
    if (!profile) return;
    const sectionsText = (profile.skills.sections || [])
      .map((sec) => `${sec.title}: ${sec.items.join(", ")}`)
      .join("\n");
    const toolsText = (profile.skills.tools || []).join(", ");
    setSkillsSectionsText(sectionsText);
    setSkillsToolsText(toolsText);
    setActiveModal("skills");
  };

  const openExperienceModal = () => {
    if (!profile) return;
    const drafts: ExperienceDraft[] =
      profile.experiences?.map((exp) => ({
        company: exp.company || "",
        role: exp.role || "",
        dates: exp.dates || "",
        bulletsText: (exp.bullets || []).join("\n"),
        location: exp.location || "",
      })) || [];
    if (drafts.length === 0) drafts.push({ company: "", role: "", dates: "", bulletsText: "" });
    setExperiencesDraft(drafts);
    setActiveModal("experience");
  };

  const openEducationModal = () => {
    if (!profile) return;
    const drafts: EducationDraft[] =
      Array.isArray(profile.education) && profile.education.length > 0
        ? profile.education.map((edu) => ({
            school: edu.school || "",
            degree: edu.degree || "",
            dates: edu.dates || "",
            location: (edu.location || "") as string,
          }))
        : [{ school: "", degree: "", dates: "", location: "" }];

    setEducationDrafts(drafts);

    const list =
      profile.certs
        ?.split(/[,\n]/)
        .map((c) => c.trim())
        .filter(Boolean) || [];

    setCertsList(list);
    setCertInput("");
    setActiveModal("education");
  };

  const openLanguagesModal = () => {
    if (!profile) return;
    const parsed = parseLangLine(profile.langLine || "");
    let drafts: LanguageDraft[] = [];

    if (parsed.length > 0) {
      drafts = parsed.map((p) => {
        const txt = p.text;
        const match = txt.match(/^(.*?)\s*\((.*)\)$/);
        if (match) return { language: match[1].trim(), level: match[2].trim() };
        return { language: txt, level: "" };
      });
    }

    if (drafts.length === 0) drafts = [{ language: "", level: "" }];
    setLanguagesDraft(drafts);
    setActiveModal("languages");
  };

  const openHobbiesModal = () => {
    if (!profile) return;
    setHobbiesList(profile.hobbies || []);
    setHobbyInput("");
    setActiveModal("hobbies");
  };

  /* =========================
     REORDER (NEW)
  ========================= */
  const moveItem = <T,>(arr: T[], from: number, to: number) => {
    const copy = [...arr];
    const item = copy.splice(from, 1)[0];
    copy.splice(to, 0, item);
    return copy;
  };

  /* =========================
     MODAL SAVE
  ========================= */
  const handleModalSave = async (e?: FormEvent) => {
    if (e) e.preventDefault();
    if (!profile || !activeModal) {
      setActiveModal(null);
      return;
    }

    let updated: CvProfile = { ...profile };

    if (activeModal === "infos") {
      updated = {
        ...profile,
        fullName: infosDraft.fullName.trim(),
        email: infosDraft.email.trim(),
        phone: infosDraft.phone.trim(),
        linkedin: infosDraft.linkedin.trim(),
        contractType: infosDraft.contractType.trim(),
        profileSummary: infosDraft.profileSummary.trim(),
        drivingLicense: infosDraft.drivingLicense.trim(),
        vehicle: infosDraft.vehicle.trim(),
        address: infosDraft.address.trim(),
        city: infosDraft.address.trim().split(",")[0].trim() || profile.city || "",
      };
    }

    if (activeModal === "skills") {
      const sections: CvSkillsSection[] = skillsSectionsText
        .split("\n")
        .map((l) => l.trim())
        .filter(Boolean)
        .map((line) => {
          const [titlePart, itemsPart] = line.split(":");
          const title = (titlePart || "Compétences").trim();
          const items = itemsPart
            ? itemsPart.split(",").map((s) => s.trim()).filter(Boolean)
            : [];
          return { title, items };
        });

      const tools = skillsToolsText.split(",").map((t) => t.trim()).filter(Boolean);
      updated = { ...profile, skills: { sections, tools } };
    }

    if (activeModal === "experience") {
      const experiences: CvExperience[] = experiencesDraft
        .map((d) => ({
          company: d.company.trim(),
          role: d.role.trim(),
          dates: d.dates.trim(),
          location: (d.location || "").trim(),
          bullets: d.bulletsText.split("\n").map((b) => b.trim()).filter(Boolean),
        }))
        .filter((exp) => exp.company || exp.role || exp.dates || exp.bullets.length > 0);

      updated = { ...profile, experiences };
    }

    if (activeModal === "education") {
      const education: CvEducation[] = educationDrafts
        .map((d) => ({
          school: d.school.trim(),
          degree: d.degree.trim(),
          dates: d.dates.trim(),
          location: d.location.trim(),
        }))
        .filter((ed) => ed.school || ed.degree || ed.dates || (ed.location ?? "").length);

      const educationShort = education.map((ed) => {
        const parts: string[] = [];
        if (ed.dates) parts.push(ed.dates);

        let main = "";
        if (ed.degree && ed.school) main = `${ed.degree} – ${ed.school}`;
        else if (ed.degree) main = ed.degree;
        else if (ed.school) main = ed.school;

        if (main) parts.push(main);
        if (ed.location) {
          if (parts.length > 1) parts[parts.length - 1] = `${parts[parts.length - 1]} (${ed.location})`;
          else parts.push(`(${ed.location})`);
        }
        return parts.join(" · ");
      });

      updated = { ...profile, education, educationShort, certs: certsList.join(", ") };
    }

    if (activeModal === "languages") {
      const cleaned = languagesDraft
        .map((l) => ({ language: l.language.trim(), level: l.level.trim() }))
        .filter((l) => l.language.length > 0);

      const langLine = cleaned.map((l) => (l.level ? `${l.language} (${l.level})` : `${l.language}`)).join(" · ");
      updated = { ...profile, langLine };
    }

    if (activeModal === "hobbies") {
      updated = { ...profile, hobbies: hobbiesList.map((h) => h.trim()).filter(Boolean) };
    }

    setProfile(updated);
    await saveProfileToDb(updated);
    setActiveModal(null);
    showToast("Modifications sauvegardées ✅", "success");
  };

  const updatedLabel =
    profile?.updatedAt ? `Profil mis à jour le ${formatUpdatedAt(profile.updatedAt)}` : profile ? "Profil non encore enregistré" : "";

  const langDisplay = parseLangLine(profile?.langLine || "");

  // Export
  const handleExport = () => {
    if (!profile) return;
    downloadJson(`profil-${(profile.fullName || "candidat").replace(/\s+/g, "-").toLowerCase()}.json`, profile);
    showToast("Export JSON prêt ✅", "success");
  };

  return (
    <div className="min-h-screen bg-[#020617] text-slate-300 font-sans">
      {/* MOBILE TOPBAR */}
      <div className="lg:hidden sticky top-0 z-50 bg-slate-900/80 backdrop-blur-md border-b border-white/5 p-4 flex justify-between items-center">
        <h1 className="text-lg font-bold text-white flex items-center gap-2">
          <Cpu className="h-5 w-5 text-blue-500" /> Profil IA
        </h1>
        <div className="flex items-center gap-2 bg-blue-500/10 px-3 py-1 rounded-full border border-blue-500/20">
          <Zap className="h-3 w-3 text-yellow-400" />
          <span className="text-xs font-mono font-bold text-white">{loadingAccountProfile ? "…" : remainingCredits}</span>
        </div>
      </div>

      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 lg:flex gap-8">
        {/* SIDEBAR */}
        <aside className="hidden lg:block w-64 shrink-0">
          <div className="sticky top-8 space-y-6">
            <div className="p-6 rounded-3xl bg-gradient-to-b from-slate-900 to-slate-950 border border-white/5 shadow-2xl">
              <div className="h-16 w-16 rounded-2xl bg-blue-600 flex items-center justify-center text-2xl font-bold text-white mb-4 shadow-lg shadow-blue-900/40">
                {getInitials(profile?.fullName || user?.email || "")}
              </div>
              <h2 className="text-white font-bold text-lg truncate">{profile?.fullName || "Utilisateur"}</h2>
              <p className="text-xs text-slate-500 font-mono mt-1 uppercase tracking-tighter">
                Status: {user ? "Connecté" : "Invité"} {loadingProfileFromDb ? "· Sync..." : ""}
              </p>

              <div className="mt-4">
                <div className="flex items-center justify-between text-[11px] text-slate-400 font-mono">
                  <span>Profile Strength</span>
                  <span className="text-white font-bold">{profileStrength.score}%</span>
                </div>
                <div className="mt-2 h-2 rounded-full bg-white/5 overflow-hidden border border-white/5">
                  <div className="h-full bg-blue-500" style={{ width: `${profileStrength.score}%` }} />
                </div>
                <p className="mt-2 text-[10px] text-slate-500">
                  {profileStrength.filled}/{profileStrength.total} éléments complétés · {updatedLabel}
                </p>
              </div>

              <div className="mt-4 flex gap-2">
                <button
                  onClick={handleExport}
                  disabled={!profile}
                  className="flex-1 px-3 py-2 rounded-xl bg-white/5 border border-white/10 hover:bg-white/10 text-xs font-bold text-white flex items-center justify-center gap-2 disabled:opacity-50"
                >
                  <Download className="h-4 w-4" />
                  Export
                </button>
                <button
                  onClick={() => openInfosModal()}
                  disabled={!profile}
                  className="px-3 py-2 rounded-xl bg-blue-600 hover:bg-blue-500 text-xs font-bold text-white border border-blue-500/30 disabled:opacity-50"
                >
                  Edit
                </button>
              </div>
            </div>

            <nav className="space-y-1">
              {navItems.map((item) => (
                <a
                  key={item.id}
                  href={`#${item.id}`}
                  className={`flex items-center justify-between px-4 py-3 rounded-2xl transition-all duration-200 group ${
                    activeSection === item.id
                      ? "bg-blue-600 text-white shadow-lg shadow-blue-900/20"
                      : "text-slate-500 hover:bg-white/5 hover:text-slate-200"
                  }`}
                >
                  <div className="flex items-center gap-3">
                    <item.icon className="h-4 w-4" />
                    <span className="text-sm font-semibold">{item.label}</span>
                  </div>
                  <ChevronRight className={`h-3 w-3 transition-transform ${activeSection === item.id ? "rotate-90" : "group-hover:translate-x-1"}`} />
                </a>
              ))}
            </nav>

            {/* NEW: Checklist */}
            <div className="p-4 rounded-2xl bg-slate-900/30 border border-white/5">
              <div className="flex items-center gap-3 mb-3">
                <AlertTriangle className="h-4 w-4 text-amber-400" />
                <span className="text-xs font-bold text-slate-400 uppercase tracking-widest">À compléter</span>
              </div>

              <div className="space-y-2">
                {checklist.map((it: any, idx: number) => {
                  if (it.action === "upload") {
                    return (
                      <button
                        key={idx}
                        onClick={() => document.getElementById("file-input-hidden")?.click()}
                        className="w-full text-left px-3 py-2 rounded-xl bg-white/5 border border-white/10 hover:bg-white/10 text-xs text-slate-200"
                      >
                        • {it.label}
                      </button>
                    );
                  }

                  return (
                    <button
                      key={idx}
                      onClick={() => it.ok ? null : setActiveModal(it.modal)}
                      className={`w-full text-left px-3 py-2 rounded-xl border text-xs ${
                        it.ok
                          ? "bg-emerald-500/10 border-emerald-500/20 text-emerald-100"
                          : "bg-white/5 border-white/10 hover:bg-white/10 text-slate-200"
                      }`}
                      title={it.ok ? "OK" : "Cliquer pour compléter"}
                    >
                      {it.ok ? "✓" : "•"} {it.label}
                    </button>
                  );
                })}
              </div>
            </div>

            <div className="p-4 rounded-2xl bg-slate-900/30 border border-white/5">
              <div className="flex items-center gap-3 mb-3">
                <ShieldCheck className="h-4 w-4 text-emerald-500" />
                <span className="text-xs font-bold text-slate-400 uppercase tracking-widest">Confidentialité</span>
              </div>
              <p className="text-[10px] text-slate-500 leading-relaxed">
                Données chiffrées · utilisées pour optimiser tes candidatures via IA.
              </p>
            </div>
          </div>
        </aside>

        {/* MAIN */}
        <main className="flex-1 space-y-8">
          {/* KPI ROW */}
          <section className="grid grid-cols-2 md:grid-cols-4 gap-4">
            <KpiItem label="Crédits IA" value={loadingAccountProfile ? "…" : remainingCredits} sub="Disponibles" icon={Zap} color="text-yellow-400" />
            <KpiItem label="CV générés" value={loadingCounts ? "…" : dashboardCounts.cvCount} sub="Depuis candidatures" icon={FileText} color="text-blue-400" />
            <KpiItem label="Force Profil" value={`${profileStrength.score}%`} sub="Score global" icon={Sparkles} color="text-purple-400" />
            <KpiItem label="Candidatures" value={loadingCounts ? "…" : dashboardCounts.totalApps} sub="Suivies" icon={Briefcase} color="text-emerald-400" />
          </section>

          {/* HERO + RADAR */}
          <section id="infos-personnelles" className="grid lg:grid-cols-[1fr,350px] gap-6">
            <motion.div
              className="p-8 rounded-[2rem] bg-slate-900/50 border border-white/10 shadow-2xl relative overflow-hidden"
              whileHover={{ borderColor: "rgba(59, 130, 246, 0.3)" }}
            >
              <div className="relative z-10">
                <div className="flex justify-between items-start">
                  <div>
                    <h3 className="text-3xl font-black text-white tracking-tighter">
                      {profile?.fullName || "Configure ton identité"}
                    </h3>
                    <p className="text-blue-400 font-mono text-sm mt-2 uppercase tracking-widest flex items-center gap-2">
                      <Cpu className="h-4 w-4" /> {profile?.contractType || "Recherche active"}
                    </p>
                    <p className="mt-2 text-xs text-slate-500 font-mono">
                      {loadingProfileFromDb ? "Synchronisation..." : updatedLabel}
                    </p>
                  </div>

                  <button
                    onClick={openInfosModal}
                    disabled={!profile}
                    className="p-3 rounded-2xl bg-white/5 hover:bg-blue-600 hover:text-white transition-all border border-white/10 disabled:opacity-50"
                  >
                    <PencilLine className="h-5 w-5" />
                  </button>
                </div>

                <p className="mt-6 text-slate-400 text-sm leading-relaxed max-w-2xl line-clamp-3">
                  {profile?.profileSummary || "Importe ton CV PDF pour générer ton profil IA automatiquement."}
                </p>

                <div className="mt-10 flex flex-wrap gap-4 items-center">
                  <div className="flex-1 min-w-[240px]">
                    <label className="flex items-center gap-4 p-4 rounded-2xl border-2 border-dashed border-white/10 hover:border-blue-500/50 hover:bg-blue-500/5 transition-all cursor-pointer group">
                      <input
                        id="file-input-hidden"
                        type="file"
                        accept="application/pdf"
                        className="hidden"
                        onChange={handleFileChange}
                      />
                      <div className="p-2 rounded-lg bg-white/5 group-hover:bg-blue-500 group-hover:text-white transition-colors">
                        <Upload className="h-5 w-5" />
                      </div>
                      <span className="text-sm font-semibold truncate">
                        {file ? file.name : "Glisser / choisir ton CV (PDF)"}
                      </span>
                    </label>
                  </div>

                  <button
                    onClick={handleUpload}
                    disabled={!file || uploading || loadingAccountProfile || isBlocked || remainingCredits <= 0}
                    className="h-14 px-8 rounded-2xl bg-blue-600 hover:bg-blue-500 text-white font-bold shadow-lg shadow-blue-900/40 transition-all disabled:opacity-50 flex items-center gap-3"
                  >
                    {uploading ? (
                      <motion.div animate={{ rotate: 360 }} transition={{ repeat: Infinity, duration: 1 }}>
                        <Cpu className="h-5 w-5" />
                      </motion.div>
                    ) : (
                      <Zap className="h-5 w-5" />
                    )}
                    {uploading ? "Analyse..." : isBlocked ? "Compte bloqué" : remainingCredits <= 0 ? "Plus de crédits" : "Analyser l'Expertise"}
                  </button>
                </div>

                {error && (
                  <div className="mt-4 rounded-2xl border border-red-500/30 bg-red-500/10 px-4 py-3 text-sm text-red-100">
                    {error}
                  </div>
                )}
              </div>
              <div className="absolute -right-20 -top-20 h-64 w-64 bg-blue-600/10 rounded-full blur-[100px]" />
            </motion.div>

            <div className="p-8 rounded-[2rem] bg-slate-900 border border-white/5 flex flex-col items-center">
              <h4 className="text-[10px] font-black uppercase tracking-[0.2em] text-slate-500 mb-8 flex items-center gap-2">
                <Sparkles className="h-3 w-3" /> Skill_Matrix.v3
              </h4>
              <div className="w-full h-64">
                <canvas ref={radarCanvasRef} />
              </div>
              <div className="mt-8 grid grid-cols-2 gap-2 w-full">
                <div className="p-3 rounded-xl bg-white/5 border border-white/5 text-center">
                  <p className="text-[10px] text-slate-500 uppercase font-bold">Profil</p>
                  <p className="text-white font-mono font-bold">{profileStrength.score}%</p>
                </div>
                <div className="p-3 rounded-xl bg-white/5 border border-white/5 text-center">
                  <p className="text-[10px] text-slate-500 uppercase font-bold">Crédits</p>
                  <p className="text-white font-mono font-bold">{loadingAccountProfile ? "…" : remainingCredits}</p>
                </div>
              </div>
            </div>
          </section>

          {/* INFOS KEY */}
          <SectionWrapper id="infos" title="Informations clés" icon={Info} onEdit={openInfosModal}>
            {profile ? (
              <div className="grid md:grid-cols-2 gap-4 text-sm">
                <InfoRow icon={Mail} label="Email" value={profile.email || user?.email || "—"} />
                <InfoRow icon={Phone} label="Téléphone" value={profile.phone || "—"} />
                <InfoRow icon={Linkedin} label="LinkedIn" value={profile.linkedin || "—"} />
                <InfoRow icon={MapPin} label="Adresse" value={profile.address || profile.city || "—"} />
                <InfoRow icon={Briefcase} label="Contrat" value={profile.contractType || "—"} />
                <InfoRow
                  icon={Car}
                  label="Permis / Véhicule"
                  value={`${profile.drivingLicense || "—"}${profile.vehicle ? ` · ${profile.vehicle}` : ""}`}
                />
              </div>
            ) : (
              <EmptyState text={loadingProfileFromDb ? "Chargement du profil..." : "Aucun profil. Analyse un CV pour commencer."} />
            )}
          </SectionWrapper>

          {/* EXPERIENCE */}
          <SectionWrapper id="experience" title="Parcours Professionnel" icon={Briefcase} onEdit={openExperienceModal}>
            <div className="space-y-4">
              {profile?.experiences?.length ? (
                profile.experiences.map((exp, i) => (
                  <div key={i} className="p-6 rounded-2xl bg-white/5 border border-white/5 hover:border-blue-500/30 transition-all relative">
                    <div className="flex items-start justify-between gap-3">
                      <div>
                        <h4 className="text-white font-bold text-lg">{exp.role || "Poste"}</h4>
                        <p className="text-blue-400 font-semibold">{exp.company || "Entreprise"}</p>
                        {exp.location && <p className="text-xs text-slate-500 mt-1">{exp.location}</p>}
                      </div>
                      <div className="flex items-center gap-2">
                        <span className="text-xs font-mono bg-slate-800 px-3 py-1 rounded-full h-fit border border-white/10 uppercase">
                          {exp.dates || "—"}
                        </span>
                      </div>
                    </div>

                    {!!exp.bullets?.length && (
                      <ul className="mt-4 space-y-2">
                        {exp.bullets.map((b, j) => (
                          <li key={j} className="text-sm text-slate-400 flex items-start gap-3">
                            <div className="h-1.5 w-1.5 rounded-full bg-blue-500 mt-1.5 shrink-0" />
                            {b}
                          </li>
                        ))}
                      </ul>
                    )}
                  </div>
                ))
              ) : (
                <EmptyState text="Aucune expérience ajoutée." />
              )}
            </div>
          </SectionWrapper>

          {/* SKILLS + LANGUAGES */}
          <div className="grid md:grid-cols-2 gap-6">
            <SectionWrapper id="competences" title="Expertise" icon={Sparkles} onEdit={openSkillsModal}>
              {profile?.skills ? (
                <div className="space-y-6">
                  {!!profile.skills.sections?.length && (
                    <div className="space-y-5">
                      {profile.skills.sections.map((sec, i) => (
                        <div key={i} className="space-y-3">
                          <p className="text-[10px] font-black uppercase text-slate-500 tracking-widest">{sec.title}</p>
                          <div className="flex flex-wrap gap-2">
                            {sec.items.map((item, j) => (
                              <span key={j} className="px-3 py-1 rounded-lg bg-blue-500/10 border border-blue-500/20 text-xs font-medium text-blue-300">
                                {item}
                              </span>
                            ))}
                          </div>
                        </div>
                      ))}
                    </div>
                  )}

                  {!!profile.skills.tools?.length && (
                    <div className="pt-4 border-t border-white/5">
                      <p className="text-[10px] font-black uppercase text-slate-500 tracking-widest mb-3">Outils</p>
                      <div className="flex flex-wrap gap-2">
                        {profile.skills.tools.map((tool, idx) => (
                          <span key={idx} className="px-3 py-1 rounded-lg bg-white/5 border border-white/10 text-xs font-medium text-slate-300">
                            {tool}
                          </span>
                        ))}
                      </div>
                    </div>
                  )}
                </div>
              ) : (
                <EmptyState text="Aucune compétence renseignée." />
              )}
            </SectionWrapper>

            <SectionWrapper id="langues" title="Langues & Communication" icon={Languages} onEdit={openLanguagesModal}>
              <div className="grid gap-4">
                {langDisplay.length ? (
                  langDisplay.map((lang, i) => (
                    <div key={i} className="flex items-center justify-between p-4 rounded-2xl bg-white/5 border border-white/5">
                      <div className="flex items-center gap-4">
                        <span className="text-2xl">{lang.flag}</span>
                        <span className="font-bold text-white">{lang.text}</span>
                      </div>
                      <BadgeCheck className="h-5 w-5 text-blue-500" />
                    </div>
                  ))
                ) : (
                  <EmptyState text="Aucune langue renseignée." />
                )}
              </div>
            </SectionWrapper>
          </div>

          {/* FORMATION */}
          <SectionWrapper id="formation" title="Formations & Certifications" icon={BadgeCheck} onEdit={openEducationModal}>
            {profile ? (
              <div className="space-y-6">
                {profile.educationShort?.length ? (
                  <div className="space-y-2">
                    {profile.educationShort.map((l, idx) => (
                      <div key={idx} className="p-4 rounded-2xl bg-white/5 border border-white/5 text-sm text-slate-300">
                        {l}
                      </div>
                    ))}
                  </div>
                ) : (
                  <EmptyState text="Aucune formation renseignée." />
                )}

                {profile.certs?.trim() ? (
                  <div className="p-4 rounded-2xl bg-white/5 border border-white/5">
                    <p className="text-[10px] font-black uppercase text-slate-500 tracking-widest mb-2">Certifications</p>
                    <p className="text-sm text-slate-200">{profile.certs}</p>
                  </div>
                ) : null}
              </div>
            ) : (
              <EmptyState text="Aucun profil chargé." />
            )}
          </SectionWrapper>

          {/* HOBBIES */}
          <SectionWrapper id="hobbies" title="Loisirs & Centres d'intérêt" icon={Sparkles} onEdit={openHobbiesModal}>
            {profile?.hobbies?.length ? (
              <div className="flex flex-wrap gap-2">
                {profile.hobbies.map((h) => (
                  <span key={h} className="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-white/5 border border-white/10 text-xs text-slate-200">
                    <span>{getHobbyEmoji(h)}</span>
                    <span>{h}</span>
                  </span>
                ))}
              </div>
            ) : (
              <EmptyState text="Aucun loisir renseigné." />
            )}
          </SectionWrapper>
        </main>
      </div>

      {/* MODAL ENGINE */}
      <AnimatePresence>
        {activeModal && (
          <div className="fixed inset-0 z-[100] flex items-center justify-center p-4">
            <motion.div
              initial={{ opacity: 0 }}
              animate={{ opacity: 1 }}
              exit={{ opacity: 0 }}
              className="absolute inset-0 bg-slate-950/80 backdrop-blur-xl"
              onClick={() => setActiveModal(null)}
            />
            <motion.form
              onSubmit={handleModalSave}
              initial={{ scale: 0.95, opacity: 0, y: 20 }}
              animate={{ scale: 1, opacity: 1, y: 0 }}
              exit={{ scale: 0.95, opacity: 0, y: 20 }}
              className="relative w-full max-w-2xl bg-slate-900 border border-white/10 rounded-[2.5rem] shadow-3xl overflow-hidden flex flex-col max-h-[90vh]"
            >
              <div className="p-8 border-b border-white/5 flex justify-between items-center bg-slate-900">
                <div>
                  <h3 className="text-2xl font-bold text-white tracking-tighter capitalize flex items-center gap-3">
                    <PencilLine className="h-6 w-6 text-blue-500" />
                    {activeModal === "infos" && "Modifier informations"}
                    {activeModal === "skills" && "Modifier compétences"}
                    {activeModal === "experience" && "Modifier expériences"}
                    {activeModal === "education" && "Modifier formation"}
                    {activeModal === "languages" && "Modifier langues"}
                    {activeModal === "hobbies" && "Modifier loisirs"}
                  </h3>
                  <p className="text-xs text-slate-500 uppercase font-mono mt-1">Section_Update // {activeModal}</p>
                </div>
                <button type="button" onClick={() => setActiveModal(null)} className="p-2 hover:bg-white/5 rounded-full">
                  <X />
                </button>
              </div>

              <div className="p-8 overflow-y-auto custom-scrollbar space-y-6">
                {/* INFOS */}
                {activeModal === "infos" && (
                  <div className="space-y-6">
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <Field label="Nom complet">
                        <input className={inputCls} value={infosDraft.fullName} onChange={(e) => setInfosDraft((p) => ({ ...p, fullName: e.target.value }))} />
                      </Field>
                      <Field label="Email">
                        <input className={inputCls} value={infosDraft.email} onChange={(e) => setInfosDraft((p) => ({ ...p, email: e.target.value }))} />
                      </Field>
                      <Field label="Téléphone">
                        <input className={inputCls} value={infosDraft.phone} onChange={(e) => setInfosDraft((p) => ({ ...p, phone: e.target.value }))} />
                      </Field>
                      <Field label="LinkedIn">
                        <input className={inputCls} value={infosDraft.linkedin} onChange={(e) => setInfosDraft((p) => ({ ...p, linkedin: e.target.value }))} />
                      </Field>
                      <Field label="Contrat recherché">
                        <input list="contract-type-options" className={inputCls} value={infosDraft.contractType} onChange={(e) => setInfosDraft((p) => ({ ...p, contractType: e.target.value }))} />
                        <datalist id="contract-type-options">
                          {CONTRACT_TYPE_OPTIONS.map((c) => (
                            <option key={c} value={c} />
                          ))}
                        </datalist>
                      </Field>
                      <Field label="Adresse">
                        <input className={inputCls} placeholder="Ex : 12 rue Exemple, 75000 Paris" value={infosDraft.address} onChange={(e) => setInfosDraft((p) => ({ ...p, address: e.target.value }))} />
                      </Field>
                      <Field label="Permis">
                        <input className={inputCls} placeholder="Ex : Permis B" value={infosDraft.drivingLicense} onChange={(e) => setInfosDraft((p) => ({ ...p, drivingLicense: e.target.value }))} />
                      </Field>
                      <Field label="Véhicule">
                        <input className={inputCls} placeholder="Ex : Véhiculé" value={infosDraft.vehicle} onChange={(e) => setInfosDraft((p) => ({ ...p, vehicle: e.target.value }))} />
                      </Field>
                    </div>

                    <Field label="Résumé de profil">
                      <textarea rows={5} className={textareaCls} value={infosDraft.profileSummary} onChange={(e) => setInfosDraft((p) => ({ ...p, profileSummary: e.target.value }))} />
                    </Field>
                  </div>
                )}

                {/* SKILLS */}
                {activeModal === "skills" && (
                  <div className="space-y-6">
                    <Field label="Sections (1 ligne = 1 section) · Format : Titre: item1, item2">
                      <textarea rows={6} className={textareaCls} value={skillsSectionsText} onChange={(e) => setSkillsSectionsText(e.target.value)} placeholder={"Ex:\nIT: React, Next.js, TypeScript\nCloud: AWS, Azure"} />
                    </Field>
                    <Field label="Outils / logiciels (virgules)">
                      <textarea rows={3} className={textareaCls} value={skillsToolsText} onChange={(e) => setSkillsToolsText(e.target.value)} placeholder="VS Code, Docker, Jira..." />
                    </Field>
                  </div>
                )}

                {/* EXPERIENCE (NEW: reorder) */}
                {activeModal === "experience" && (
                  <div className="space-y-4">
                    {experiencesDraft.map((exp, idx) => (
                      <div key={idx} className="p-5 rounded-[2rem] bg-white/5 border border-white/10 relative space-y-4">
                        <div className="absolute top-4 right-4 flex gap-2">
                          <button
                            type="button"
                            onClick={() => idx > 0 && setExperiencesDraft((p) => moveItem(p, idx, idx - 1))}
                            className="p-2 rounded-full hover:bg-white/5 text-slate-300"
                            title="Monter"
                          >
                            <ArrowUp className="h-4 w-4" />
                          </button>
                          <button
                            type="button"
                            onClick={() => idx < experiencesDraft.length - 1 && setExperiencesDraft((p) => moveItem(p, idx, idx + 1))}
                            className="p-2 rounded-full hover:bg-white/5 text-slate-300"
                            title="Descendre"
                          >
                            <ArrowDown className="h-4 w-4" />
                          </button>
                          <button
                            type="button"
                            onClick={() => setExperiencesDraft((p) => p.filter((_, i) => i !== idx))}
                            className="p-2 rounded-full hover:bg-red-500/10 text-red-300"
                            title="Supprimer"
                          >
                            <Trash2 className="h-4 w-4" />
                          </button>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                          <Field label="Entreprise">
                            <input className={inputCls} value={exp.company} onChange={(e) => setExperiencesDraft((p) => p.map((x, i) => (i === idx ? { ...x, company: e.target.value } : x)))} />
                          </Field>
                          <Field label="Poste">
                            <input className={inputCls} value={exp.role} onChange={(e) => setExperiencesDraft((p) => p.map((x, i) => (i === idx ? { ...x, role: e.target.value } : x)))} />
                          </Field>
                          <Field label="Dates">
                            <input className={inputCls} placeholder="Ex : 2022 - Présent" value={exp.dates} onChange={(e) => setExperiencesDraft((p) => p.map((x, i) => (i === idx ? { ...x, dates: e.target.value } : x)))} />
                          </Field>
                          <Field label="Lieu (optionnel)">
                            <input className={inputCls} placeholder="Paris, FR" value={exp.location || ""} onChange={(e) => setExperiencesDraft((p) => p.map((x, i) => (i === idx ? { ...x, location: e.target.value } : x)))} />
                          </Field>
                        </div>

                        <Field label="Missions (1 par ligne)">
                          <textarea rows={4} className={textareaCls} value={exp.bulletsText} onChange={(e) => setExperiencesDraft((p) => p.map((x, i) => (i === idx ? { ...x, bulletsText: e.target.value } : x)))} />
                        </Field>
                      </div>
                    ))}

                    <button
                      type="button"
                      onClick={() => setExperiencesDraft((p) => [...p, { company: "", role: "", dates: "", bulletsText: "" }])}
                      className="w-full py-4 border-2 border-dashed border-white/10 rounded-2xl text-slate-300 hover:border-blue-500 hover:text-blue-300 font-bold flex items-center justify-center gap-2"
                    >
                      <Plus className="h-5 w-5" /> Ajouter une expérience
                    </button>
                  </div>
                )}

                {/* EDUCATION (NEW: reorder) */}
                {activeModal === "education" && (
                  <div className="space-y-6">
                    <div className="space-y-4">
                      {educationDrafts.map((edu, idx) => (
                        <div key={idx} className="p-5 rounded-[2rem] bg-white/5 border border-white/10 relative space-y-4">
                          <div className="absolute top-4 right-4 flex gap-2">
                            <button
                              type="button"
                              onClick={() => idx > 0 && setEducationDrafts((p) => moveItem(p, idx, idx - 1))}
                              className="p-2 rounded-full hover:bg-white/5 text-slate-300"
                              title="Monter"
                            >
                              <ArrowUp className="h-4 w-4" />
                            </button>
                            <button
                              type="button"
                              onClick={() => idx < educationDrafts.length - 1 && setEducationDrafts((p) => moveItem(p, idx, idx + 1))}
                              className="p-2 rounded-full hover:bg-white/5 text-slate-300"
                              title="Descendre"
                            >
                              <ArrowDown className="h-4 w-4" />
                            </button>
                            {educationDrafts.length > 1 && (
                              <button
                                type="button"
                                onClick={() => setEducationDrafts((p) => p.filter((_, i) => i !== idx))}
                                className="p-2 rounded-full hover:bg-red-500/10 text-red-300"
                                title="Supprimer"
                              >
                                <Trash2 className="h-4 w-4" />
                              </button>
                            )}
                          </div>

                          <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <Field label="Diplôme">
                              <input className={inputCls} value={edu.degree} onChange={(e) => setEducationDrafts((p) => p.map((x, i) => (i === idx ? { ...x, degree: e.target.value } : x)))} />
                            </Field>
                            <Field label="École">
                              <input className={inputCls} value={edu.school} onChange={(e) => setEducationDrafts((p) => p.map((x, i) => (i === idx ? { ...x, school: e.target.value } : x)))} />
                            </Field>
                            <Field label="Lieu">
                              <input className={inputCls} value={edu.location} onChange={(e) => setEducationDrafts((p) => p.map((x, i) => (i === idx ? { ...x, location: e.target.value } : x)))} />
                            </Field>
                            <Field label="Dates">
                              <input className={inputCls} placeholder="Ex : 2022–2024" value={edu.dates} onChange={(e) => setEducationDrafts((p) => p.map((x, i) => (i === idx ? { ...x, dates: e.target.value } : x)))} />
                            </Field>
                          </div>
                        </div>
                      ))}
                    </div>

                    <button
                      type="button"
                      onClick={() => setEducationDrafts((p) => [...p, { school: "", degree: "", dates: "", location: "" }])}
                      className="w-full py-4 border-2 border-dashed border-white/10 rounded-2xl text-slate-300 hover:border-blue-500 hover:text-blue-300 font-bold flex items-center justify-center gap-2"
                    >
                      <Plus className="h-5 w-5" /> Ajouter une formation
                    </button>

                    {/* Certifications */}
                    <div className="space-y-2">
                      <p className="text-[10px] font-bold text-slate-500 uppercase ml-2">Certifications (auto-complétion)</p>
                      <div className="flex gap-2">
                        <input
                          list="certification-options"
                          className={inputCls}
                          placeholder="Ex : Azure AZ-900..."
                          value={certInput}
                          onChange={(e) => setCertInput(e.target.value)}
                        />
                        <button
                          type="button"
                          onClick={() => {
                            const val = certInput.trim();
                            if (!val) return;
                            if (!certsList.includes(val)) setCertsList((p) => [...p, val]);
                            setCertInput("");
                          }}
                          className="px-4 rounded-xl bg-blue-600 hover:bg-blue-500 text-white text-sm font-bold"
                        >
                          Ajouter
                        </button>
                        <datalist id="certification-options">
                          {CERTIFICATION_OPTIONS.map((c) => (
                            <option key={c} value={c} />
                          ))}
                        </datalist>
                      </div>

                      {!!certsList.length && (
                        <div className="flex flex-wrap gap-2 pt-2">
                          {certsList.map((cert) => (
                            <span key={cert} className="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-white/5 border border-white/10 text-xs">
                              {cert}
                              <button type="button" onClick={() => setCertsList((p) => p.filter((x) => x !== cert))} className="text-slate-400 hover:text-red-300">
                                ✕
                              </button>
                            </span>
                          ))}
                        </div>
                      )}
                    </div>
                  </div>
                )}

                {/* LANGUAGES */}
                {activeModal === "languages" && (
                  <div className="space-y-4">
                    {languagesDraft.map((lang, idx) => {
                      const flag = lang.language.trim() ? getFlagEmoji(lang.language) : "🌐";
                      return (
                        <div key={idx} className="p-4 rounded-2xl bg-white/5 border border-white/10 flex items-start gap-3">
                          <div className="text-2xl w-10 text-center pt-2">{flag}</div>
                          <div className="flex-1 grid grid-cols-1 md:grid-cols-2 gap-3">
                            <Field label="Langue">
                              <input
                                list="language-options"
                                className={inputCls}
                                value={lang.language}
                                onChange={(e) => setLanguagesDraft((p) => p.map((x, i) => (i === idx ? { ...x, language: e.target.value } : x)))}
                              />
                            </Field>
                            <Field label="Niveau">
                              <select
                                className={selectCls}
                                value={lang.level}
                                onChange={(e) => setLanguagesDraft((p) => p.map((x, i) => (i === idx ? { ...x, level: e.target.value } : x)))}
                              >
                                <option value="">Sélectionner</option>
                                {LANGUAGE_LEVEL_OPTIONS.map((lvl) => (
                                  <option key={lvl} value={lvl} className="bg-slate-900">
                                    {lvl}
                                  </option>
                                ))}
                              </select>
                            </Field>
                          </div>

                          {languagesDraft.length > 1 && (
                            <button type="button" onClick={() => setLanguagesDraft((p) => p.filter((_, i) => i !== idx))} className="p-2 rounded-full hover:bg-red-500/10 text-red-300">
                              <Trash2 className="h-4 w-4" />
                            </button>
                          )}
                        </div>
                      );
                    })}

                    <datalist id="language-options">
                      {LANGUAGE_OPTIONS.map((l) => (
                        <option key={l} value={l} />
                      ))}
                    </datalist>

                    <button
                      type="button"
                      onClick={() => setLanguagesDraft((p) => [...p, { language: "", level: "" }])}
                      className="w-full py-4 border-2 border-dashed border-white/10 rounded-2xl text-slate-300 hover:border-blue-500 hover:text-blue-300 font-bold flex items-center justify-center gap-2"
                    >
                      <Plus className="h-5 w-5" /> Ajouter une langue
                    </button>
                  </div>
                )}

                {/* HOBBIES */}
                {activeModal === "hobbies" && (
                  <div className="space-y-3">
                    <Field label="Ajouter un loisir (auto-complétion)">
                      <div className="flex gap-2">
                        <input list="hobby-options" className={inputCls} value={hobbyInput} onChange={(e) => setHobbyInput(e.target.value)} placeholder="Voyage, Lecture..." />
                        <button
                          type="button"
                          onClick={() => {
                            const val = hobbyInput.trim();
                            if (!val) return;
                            if (!hobbiesList.includes(val)) setHobbiesList((p) => [...p, val]);
                            setHobbyInput("");
                          }}
                          className="px-4 rounded-xl bg-blue-600 hover:bg-blue-500 text-white text-sm font-bold"
                        >
                          Ajouter
                        </button>
                        <datalist id="hobby-options">
                          {HOBBY_OPTIONS.map((h) => (
                            <option key={h} value={h} />
                          ))}
                        </datalist>
                      </div>
                    </Field>

                    {!!hobbiesList.length ? (
                      <div className="flex flex-wrap gap-2">
                        {hobbiesList.map((h) => (
                          <span key={h} className="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-white/5 border border-white/10 text-xs">
                            <span>{getHobbyEmoji(h)}</span>
                            <span>{h}</span>
                            <button type="button" onClick={() => setHobbiesList((p) => p.filter((x) => x !== h))} className="text-slate-400 hover:text-red-300">
                              ✕
                            </button>
                          </span>
                        ))}
                      </div>
                    ) : (
                      <EmptyState text="Aucun loisir ajouté pour le moment." />
                    )}
                  </div>
                )}
              </div>

              <div className="p-6 border-t border-white/5 flex justify-end gap-3 bg-slate-900">
                <button
                  type="button"
                  onClick={() => setActiveModal(null)}
                  className="px-5 py-3 rounded-2xl bg-white/5 border border-white/10 text-slate-200 font-bold hover:bg-white/10"
                >
                  Annuler
                </button>
                <button
                  type="submit"
                  className="px-5 py-3 rounded-2xl bg-blue-600 border border-blue-500/30 text-white font-bold hover:bg-blue-500 flex items-center gap-2"
                >
                  <Save className="h-5 w-5" /> Enregistrer
                </button>
              </div>
            </motion.form>
          </div>
        )}
      </AnimatePresence>

      <AnimatePresence>{toast && <Toast text={toast.text} tone={toast.tone} />}</AnimatePresence>
    </div>
  );
}

/* =========================
   SMALL COMPONENTS
========================= */
function InfoRow({ icon: Icon, label, value }: any) {
  return (
    <div className="p-4 rounded-2xl bg-white/5 border border-white/5 flex items-center gap-3">
      <div className="p-2 rounded-xl bg-white/5 border border-white/10">
        <Icon className="h-4 w-4 text-slate-300" />
      </div>
      <div className="flex-1">
        <p className="text-[10px] font-black uppercase tracking-widest text-slate-500">{label}</p>
        <p className="text-sm text-white break-all">{value}</p>
      </div>
    </div>
  );
}

function Field({ label, children }: { label: string; children: React.ReactNode }) {
  return (
    <div className="space-y-2">
      <label className="text-[10px] font-bold text-slate-500 uppercase ml-2">{label}</label>
      {children}
    </div>
  );
}

const inputCls =
  "w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-white focus:border-blue-500 outline-none placeholder:text-slate-500";
const textareaCls =
  "w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-white focus:border-blue-500 outline-none resize-none placeholder:text-slate-500";
const selectCls =
  "w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-white focus:border-blue-500 outline-none";
````

## File: app/globals.css
````css
@tailwind base;
@tailwind components;
@tailwind utilities;

/* =========================
   Thème global (Dark default)
   ========================= */
:root {
  --bg: #020617;              /* fond général */
  --bg-soft: #020617;         /* blocs soft */
  --card-elevated: #020617;   /* cartes en relief */
  --ink: #f9fafb;             /* texte principal */
  --muted: #9ca3af;           /* texte secondaire */
  --brand: #60a5fa;           /* bleu principal */
  --brandDark: #1d4ed8;       /* bleu plus foncé */
  --border: #1f2933;          /* bordures */
}

/* =========================
   Thème clair (override)
   Ajoute la classe "theme-light" sur <html>
   ========================= */
.theme-light {
  --bg: #f8fafc;
  --bg-soft: rgba(255, 255, 255, 0.85);
  --card-elevated: rgba(255, 255, 255, 0.75);
  --ink: #0f172a;
  --muted: rgba(51, 65, 85, 0.85);
  --border: rgba(15, 23, 42, 0.14);

  --brand: #2563eb;
  --brandDark: #1d4ed8;
}

/* =========================
   Base HTML/BODY
   ========================= */
html,
body {
  padding: 0;
  margin: 0;
  height: 100%;
  min-height: 100%;
  overflow-x: hidden;
}

body {
  background: radial-gradient(circle at top, #020617 0, #020617 40%, #000 100%);
  color: var(--ink);
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Inter", sans-serif;
  overscroll-behavior-y: contain;
  -webkit-tap-highlight-color: transparent;
}

/* Fond en mode clair */
.theme-light body {
  background: radial-gradient(circle at top, #eef2ff 0, #f8fafc 45%, #e5e7eb 100%);
}

/* Pages router fallback (si présent) */
#__next {
  min-height: 100%;
}

/* =========================
   ⭐ Canvas étoiles (Starfield overlay)
   ========================= */
.starry-background {
  position: fixed;
  inset: 0;
  width: 100vw;
  height: 100vh;
  z-index: 50;          /* au-dessus du fond et des sections */
  pointer-events: none; /* ne bloque pas les clics */
}

/* =========================
   Scrollbar globale
   ========================= */

/* Firefox */
* {
  scrollbar-width: thin;
  scrollbar-color: var(--brand) transparent;
}

/* Chrome / Edge / Safari */
*::-webkit-scrollbar {
  width: 8px;
}
*::-webkit-scrollbar-track {
  background: transparent;
}
*::-webkit-scrollbar-thumb {
  background-image: linear-gradient(to bottom, var(--brand), var(--brandDark));
  border-radius: 9999px;
}
::-webkit-scrollbar-corner {
  background: transparent;
}

/* Scrollbar verticale sur main (si main scroll) */
main::-webkit-scrollbar {
  width: 6px;
}
main::-webkit-scrollbar-track {
  background: transparent;
}
main::-webkit-scrollbar-thumb {
  background: var(--brand);
  border-radius: 999px;
}
main {
  scrollbar-width: thin;
  scrollbar-color: var(--brand) transparent;
}

/* Barre de progression en haut */
.scroll-progress-bar {
  border-radius: 9999px;
}

/* =========================
   Utilitaires UI
   ========================= */

.glass {
  background: radial-gradient(
      circle at top left,
      rgba(148, 163, 184, 0.16),
      transparent 55%
    ),
    rgba(15, 23, 42, 0.92);
  backdrop-filter: blur(18px);
}

/* Variante glass en mode clair */
.theme-light .glass {
  background: radial-gradient(
      circle at top left,
      rgba(37, 99, 235, 0.10),
      transparent 55%
    ),
    rgba(255, 255, 255, 0.78);
  backdrop-filter: blur(18px);
}

/* Bouton primaire */
.btn-primary {
  @apply inline-flex items-center justify-center px-4 py-2 rounded-full text-xs sm:text-sm font-medium;
  background-image: linear-gradient(to right, var(--brand), var(--brandDark));
  color: white;
  box-shadow: 0 10px 30px rgba(37, 99, 235, 0.4);
  transition: transform 0.12s ease-out, box-shadow 0.12s ease-out,
    filter 0.12s ease-out;
}
.btn-primary:hover {
  transform: translateY(-1px);
  box-shadow: 0 14px 32px rgba(37, 99, 235, 0.6);
  filter: brightness(1.05);
}
.btn-primary:active {
  transform: translateY(0);
  box-shadow: 0 8px 20px rgba(37, 99, 235, 0.4);
}

/* Bouton secondaire */
.btn-secondary {
  @apply inline-flex items-center justify-center px-4 py-2 rounded-full text-xs sm:text-sm font-medium border;
  border-color: rgba(148, 163, 184, 0.5);
  background: rgba(15, 23, 42, 0.8);
  color: var(--ink);
  transition: background-color 0.12s ease-out, border-color 0.12s ease-out,
    color 0.12s ease-out;
}
.btn-secondary:hover {
  border-color: var(--brand);
  color: white;
}

/* Mode clair : bouton secondaire plus lisible */
.theme-light .btn-secondary {
  background: rgba(255, 255, 255, 0.75);
  border-color: rgba(15, 23, 42, 0.18);
}
.theme-light .btn-secondary:hover {
  color: var(--ink);
}

/* Petites helpers pour cartes */
.card-border {
  border: 1px solid rgba(148, 163, 184, 0.35);
  border-radius: 0.75rem;
}
.theme-light .card-border {
  border-color: rgba(15, 23, 42, 0.14);
}

/* Lien hover subtil */
.link-soft {
  color: var(--muted);
  transition: color 0.12s ease-out;
}
.link-soft:hover {
  color: var(--ink);
}

/* =========================
   FORM CONTROLS
   ========================= */

.input,
textarea.input,
textarea.textarea,
select.select-brand {
  width: 100%;
  border-radius: 0.75rem;
  border: 1px solid var(--border);
  background-color: var(--bg-soft);
  color: var(--ink);
  font-size: 0.875rem;
  padding: 0.45rem 0.7rem;
  outline: none;
  transition: border-color 0.15s ease, box-shadow 0.15s ease,
    background-color 0.15s ease, color 0.15s ease;
}

.input::placeholder,
textarea.input::placeholder,
textarea.textarea::placeholder {
  color: var(--muted);
  opacity: 1;
}

.input:focus,
textarea.input:focus,
textarea.textarea:focus,
select.select-brand:focus {
  border-color: var(--brand);
  box-shadow: 0 0 0 1px color-mix(in srgb, var(--brand) 60%, transparent);
}

/* Textarea */
textarea.input,
textarea.textarea {
  resize: vertical;
  min-height: 3rem;
}

/* Select */
select.select-brand {
  padding-right: 2rem;
  appearance: none;
}

/* =========================
   BADGES / CARTES / TOGGLE
   ========================= */

.badge-muted {
  display: inline-flex;
  align-items: center;
  border-radius: 9999px;
  padding: 0.15rem 0.6rem;
  font-size: 0.7rem;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  background-color: rgba(15, 23, 42, 0.9);
  border: 1px solid rgba(148, 163, 184, 0.5);
  color: var(--muted);
}
.theme-light .badge-muted {
  background-color: rgba(255, 255, 255, 0.75);
  border-color: rgba(15, 23, 42, 0.14);
  color: rgba(51, 65, 85, 0.85);
}

/* Carte soft */
.card-soft {
  background: rgba(15, 23, 42, 0.92);
}
.theme-light .card-soft {
  background: rgba(255, 255, 255, 0.78);
}

/* Toggle checkbox */
.toggle-checkbox {
  width: 1rem;
  height: 1rem;
  border-radius: 0.3rem;
  border: 1px solid var(--border);
  background-color: transparent;
  accent-color: var(--brand);
}

/* =========================
   LOADER
   ========================= */

.loader {
  border-radius: 9999px;
  border: 2px solid var(--border);
  border-top-color: var(--brand);
  width: 1.1rem;
  height: 1.1rem;
  animation: spin-loader 0.7s linear infinite;
}

@keyframes spin-loader {
  to {
    transform: rotate(360deg);
  }
}

/* =========================
   BANDEAU chargement (optionnel)
   ========================= */
.assistant-loading-bar {
  border-radius: 9999px;
  backdrop-filter: blur(10px);
}

/* =========================
   reCAPTCHA badge
   ========================= */
.grecaptcha-badge {
  visibility: hidden;
}
````

## File: app/login/page.tsx
````typescript
"use client";

import { Suspense, useState, useEffect, FormEvent } from "react";
import Link from "next/link";
import { useRouter, useSearchParams } from "next/navigation";
import {
  signInWithEmailAndPassword,
  signInWithPopup,
  signInWithRedirect,
  getRedirectResult,
  GoogleAuthProvider,
} from "firebase/auth";
import { auth, googleProvider, db } from "@/lib/firebase";
import { doc, getDoc } from "firebase/firestore";
import { useAuth } from "@/context/AuthContext";
import { logAuthFailed } from "@/lib/logAuthFailed";
import { getRecaptchaToken, verifyRecaptcha } from "@/lib/recaptcha";
import { 
  ArrowLeft, LogIn, Mail, Lock, CheckCircle2, 
  AlertCircle, Loader2, Eye, EyeOff 
} from "lucide-react";

// --- CONFIG & HELPERS (Logique inchangée) ---
const MAX_ATTEMPTS = 5;
const LOCK_DURATION_MS = 60_000;

function isProbablyMobile() {
  if (typeof navigator === "undefined") return false;
  return /android|iphone|ipad|ipod|mobile/i.test(navigator.userAgent);
}

function isInAppBrowser() {
  if (typeof navigator === "undefined") return false;
  const ua = navigator.userAgent || "";
  return /FBAN|FBAV|Instagram|Line|LinkedInApp|Twitter|X;/i.test(ua);
}

function shouldUseRedirectFlow() {
  return isProbablyMobile() || isInAppBrowser();
}

function formatRecaptchaDetails(check: any) {
  const reason = String(check?.reason || "unknown");
  const score = typeof check?.score === "number" ? `score=${check.score.toFixed(2)}` : null;
  const parts = [reason, score].filter(Boolean);
  return parts.length ? `(${parts.join(", ")})` : "";
}

async function checkRecaptchaOrDegrade(params: {
  action: string;
  emailForLog: string;
  providerForLog: "password" | "google";
  onError: (msg: string) => void;
}) {
  const { action, emailForLog, providerForLog, onError } = params;
  const allowDegraded = shouldUseRedirectFlow();

  let token = "";
  try {
    token = await getRecaptchaToken(action);
  } catch (e: any) {
    logAuthFailed({
      email: emailForLog,
      provider: providerForLog,
      errorCode: "recaptcha:token_error",
      errorMessage: e?.message || "getRecaptchaToken failed",
    });

    if (allowDegraded) {
      onError("⚠️ reCAPTCHA indisponible. Connexion dégradée.");
      return { ok: true, degraded: true };
    }

    onError("Sécurité : reCAPTCHA bloqué. Désactivez AdBlock.");
    return { ok: false, degraded: false };
  }

  const check: any = await verifyRecaptcha(token, action);
  if (!check.ok) {
    const details = formatRecaptchaDetails(check);
    logAuthFailed({
      email: emailForLog,
      provider: providerForLog,
      errorCode: `recaptcha:${check.reason}`,
      errorMessage: `score=${check.score ?? "?"}`,
    });

    if (allowDegraded && (check.reason === "timeout" || check.reason === "unavailable")) {
      return { ok: true, degraded: true };
    }

    onError(`Connexion refusée par sécurité. ${details}`);
    return { ok: false, degraded: false };
  }

  return { ok: true, degraded: false };
}

function LoginPageInner() {
  const router = useRouter();
  const searchParams = useSearchParams();
  const { user, loading, blocked } = useAuth();

  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [showPwd, setShowPwd] = useState(false);
  const [submitting, setSubmitting] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [info, setInfo] = useState<string | null>(null);

  const [attempts, setAttempts] = useState(0);
  const [isLocked, setIsLocked] = useState(false);
  const [lockEnd, setLockEnd] = useState<number | null>(null);
  const [lockRemaining, setLockRemaining] = useState(0);

  // --- EFFECTS ---
  useEffect(() => {
    if (blocked) {
      setInfo(null);
      setError("Votre compte est bloqué. Contactez le support.");
    }
  }, [blocked]);

  useEffect(() => {
    if (!loading && !blocked && user && !submitting) {
      const redirectTo = searchParams.get("redirect") || "/app";
      router.replace(redirectTo);
    }
  }, [loading, blocked, user, searchParams, router, submitting]);

  useEffect(() => {
    const justSignedUp = searchParams.get("justSignedUp");
    const blockedParam = searchParams.get("blocked");

    if (blockedParam === "1") {
      setInfo(null);
      setError("Compte bloqué par l'administrateur.");
    } else if (justSignedUp === "1") {
      setError(null);
      setInfo("Compte créé avec succès ! Connectez-vous.");
    }
  }, [searchParams]);

  useEffect(() => {
    if (typeof window === "undefined") return;
    const storedAttempts = window.localStorage.getItem("loginAttempts");
    const storedLockEnd = window.localStorage.getItem("loginLockEnd");
    const now = Date.now();

    if (storedAttempts) setAttempts(parseInt(storedAttempts, 10) || 0);

    if (storedLockEnd) {
      const end = parseInt(storedLockEnd, 10);
      if (!Number.isNaN(end) && end > now) {
        setIsLocked(true);
        setLockEnd(end);
        setLockRemaining(Math.ceil((end - now) / 1000));
      } else {
        window.localStorage.removeItem("loginAttempts");
        window.localStorage.removeItem("loginLockEnd");
      }
    }
  }, []);

  useEffect(() => {
    if (!isLocked || !lockEnd) return;
    const id = window.setInterval(() => {
      const diff = lockEnd - Date.now();
      if (diff <= 0) {
        setIsLocked(false);
        setAttempts(0);
        setLockEnd(null);
        setLockRemaining(0);
        window.localStorage.removeItem("loginAttempts");
        window.localStorage.removeItem("loginLockEnd");
        window.clearInterval(id);
      } else {
        setLockRemaining(Math.ceil(diff / 1000));
      }
    }, 1000);
    return () => window.clearInterval(id);
  }, [isLocked, lockEnd]);

  useEffect(() => {
    if (typeof window === "undefined") return;
    (async () => {
      try {
        setSubmitting(true);
        const result = await getRedirectResult(auth);
        if (!result) return;

        const u = result.user;
        const ref = doc(db, "users", u.uid);
        const snap = await getDoc(ref);
        
        if (snap.data()?.blocked) {
          await auth.signOut();
          setError("Compte bloqué.");
          return;
        }

        setInfo(`Bienvenue ${u.displayName || u.email || ""} 👋`);
        const redirectTo = searchParams.get("redirect") || "/app";
        router.replace(redirectTo);
      } catch (err: any) {
        console.error("Redirect login error:", err);
      } finally {
        setSubmitting(false);
      }
    })();
  }, []);

  // --- HANDLERS ---
  const handleSubmit = async (e: FormEvent) => {
    e.preventDefault();
    if (isLocked) return;
    setError(null); setInfo(null); setSubmitting(true);

    try {
      const cap = await checkRecaptchaOrDegrade({
        action: "login",
        emailForLog: email,
        providerForLog: "password",
        onError: (msg) => setInfo(msg),
      });
      if (!cap.ok) return;

      const cred = await signInWithEmailAndPassword(auth, email, password);
      const snap = await getDoc(doc(db, "users", cred.user.uid));
      
      if (snap.data()?.blocked) {
        await auth.signOut();
        setError("Compte bloqué.");
        return;
      }

      setAttempts(0); setIsLocked(false);
      window.localStorage.removeItem("loginAttempts");
      window.localStorage.removeItem("loginLockEnd");
      const redirectTo = searchParams.get("redirect") || "/app";
      router.replace(redirectTo);

    } catch (err: any) {
      logAuthFailed({ email, provider: "password", errorCode: err.code, errorMessage: err.message });
      
      setAttempts((prev) => {
        const next = prev + 1;
        window.localStorage.setItem("loginAttempts", String(next));
        if (next >= MAX_ATTEMPTS) {
          const end = Date.now() + LOCK_DURATION_MS;
          setIsLocked(true);
          setLockEnd(end);
          setLockRemaining(Math.ceil(LOCK_DURATION_MS / 1000));
          window.localStorage.setItem("loginLockEnd", String(end));
        }
        return next;
      });

      if (err.code === "auth/wrong-password" || err.code === "auth/user-not-found") {
        setError("Email ou mot de passe incorrect.");
      } else if (err.code === "auth/too-many-requests") {
        setError("Trop de tentatives. Réessayez plus tard.");
      } else {
        setError("Erreur de connexion. Réessayez.");
      }
    } finally {
      setSubmitting(false);
    }
  };

  const handleGoogleLogin = async () => {
    setError(null); setInfo(null); setSubmitting(true);
    try {
      const provider = googleProvider || new GoogleAuthProvider();
      try {
        const result = await signInWithPopup(auth, provider);
        const snap = await getDoc(doc(db, "users", result.user.uid));
        if (snap.data()?.blocked) {
          await auth.signOut();
          setError("Compte bloqué.");
          return;
        }
        const redirectTo = searchParams.get("redirect") || "/app";
        router.replace(redirectTo);
      } catch (e: any) {
        if (e.code === "auth/popup-blocked") {
          await signInWithRedirect(auth, provider);
          return;
        }
        throw e;
      }
    } catch (err: any) {
      logAuthFailed({ email, provider: "google", errorCode: err.code, errorMessage: err.message });
      setError("Erreur connexion Google.");
    } finally {
      setSubmitting(false);
    }
  };

  return (
    <div className="min-h-screen flex flex-col bg-gradient-to-b from-slate-950 via-slate-950/95 to-slate-900 text-slate-100">
      
      {/* NAVBAR */}
      <header className="border-b border-slate-800/80 bg-slate-950/80 backdrop-blur">
        <div className="max-w-5xl mx-auto px-4 sm:px-6 py-3 flex items-center justify-between gap-3">
          <div className="flex items-center gap-2">
            <div className="w-8 h-8 rounded-xl bg-gradient-to-br from-sky-500 to-sky-400 flex items-center justify-center text-[10px] font-semibold text-slate-950 shadow-lg shadow-sky-500/40">
              IA
            </div>
            <div className="flex flex-col">
              <span className="text-[10px] uppercase tracking-[0.18em] text-slate-400">Assistant candidatures</span>
              <span className="text-xs font-medium text-slate-100">Connexion</span>
            </div>
          </div>
          <nav className="flex items-center gap-2 text-[11px]">
            <Link href="/" className="px-2 py-1 rounded-full border border-slate-700/80 hover:border-sky-500/80 text-slate-300 hover:text-sky-300 transition-colors flex items-center gap-1">
              <ArrowLeft className="w-3 h-3" /> Retour
            </Link>
            <Link href="/signup" className="px-3 py-1 rounded-full bg-sky-500/90 text-slate-950 font-medium hover:bg-sky-400 transition-colors">
              S'inscrire
            </Link>
          </nav>
        </div>
      </header>

      {/* CONTENU */}
      <main className="flex-1 flex items-center justify-center px-4 py-8">
        <div className="glass max-w-md w-full p-6 sm:p-7 rounded-2xl border border-slate-800 bg-slate-950/80 shadow-2xl shadow-sky-900/40">
          
          <div className="mb-6 text-center sm:text-left">
            <p className="inline-flex items-center gap-2 rounded-full bg-slate-900/80 border border-slate-700 px-3 py-1 mb-3">
              <LogIn className="w-3 h-3 text-sky-400" />
              <span className="text-[10px] uppercase tracking-[0.18em] text-slate-300">Connexion</span>
            </p>
            <h1 className="text-xl font-bold text-slate-50 mb-1">Bon retour 👋</h1>
            <p className="text-xs text-slate-400">Connectez-vous pour accéder à votre espace candidat.</p>
          </div>

          {/* MESSAGES ALERTE */}
          {info && (
            <div className="mb-4 p-3 rounded-lg bg-emerald-500/10 border border-emerald-500/20 text-emerald-200 text-xs flex gap-2 items-start">
              <CheckCircle2 className="w-4 h-4 flex-shrink-0 mt-0.5" /> <span>{info}</span>
            </div>
          )}
          {error && (
            <div className="mb-4 p-3 rounded-lg bg-rose-500/10 border border-rose-500/20 text-rose-200 text-xs flex gap-2 items-start">
              <AlertCircle className="w-4 h-4 flex-shrink-0 mt-0.5" /> <span>{error}</span>
            </div>
          )}
          {isLocked && (
            <div className="mb-4 p-3 rounded-lg bg-amber-500/10 border border-amber-500/20 text-amber-200 text-xs flex gap-2 items-start">
              <Lock className="w-4 h-4 flex-shrink-0 mt-0.5" /> <span>Compte bloqué ({lockRemaining}s).</span>
            </div>
          )}

          <form onSubmit={handleSubmit} className="space-y-4">
            <div className="space-y-1.5">
              <label className="text-xs font-medium text-slate-300 ml-1">Email</label>
              <div className="relative">
                <Mail className="absolute left-3 top-2.5 w-4 h-4 text-slate-500" />
                <input 
                  type="email" required value={email} onChange={e => setEmail(e.target.value)}
                  className="w-full bg-[#0A0A0B] border border-white/10 rounded-xl pl-10 pr-3 py-2 text-xs text-white placeholder:text-slate-600 focus:border-sky-500 focus:ring-1 focus:ring-sky-500 outline-none transition-all"
                  placeholder="nom@exemple.com"
                  disabled={submitting || isLocked}
                />
              </div>
            </div>

            <div className="space-y-1.5">
              <div className="flex justify-between items-center ml-1">
                <label className="text-xs font-medium text-slate-300">Mot de passe</label>
                <Link href="/forgot-password" className="text-[10px] text-blue-400 hover:text-blue-300 transition-colors">Oublié ?</Link>
              </div>
              <div className="relative">
                <Lock className="absolute left-3 top-2.5 w-4 h-4 text-slate-500" />
                <input 
                  type={showPwd ? "text" : "password"} required value={password} onChange={e => setPassword(e.target.value)}
                  className="w-full bg-[#0A0A0B] border border-white/10 rounded-xl pl-10 pr-10 py-2 text-xs text-white placeholder:text-slate-600 focus:border-sky-500 focus:ring-1 focus:ring-sky-500 outline-none transition-all"
                  placeholder="••••••••"
                  disabled={submitting || isLocked}
                />
                <button type="button" onClick={() => setShowPwd(!showPwd)} className="absolute right-3 top-2.5 text-slate-500 hover:text-white transition-colors">
                  {showPwd ? <EyeOff className="w-4 h-4" /> : <Eye className="w-4 h-4" />}
                </button>
              </div>
            </div>

            <button 
              type="submit" 
              disabled={submitting || isLocked}
              className="w-full h-11 rounded-xl bg-sky-500 hover:bg-sky-400 text-white font-semibold text-sm transition-all shadow-lg shadow-sky-500/20 disabled:opacity-50 flex items-center justify-center gap-2 mt-2"
            >
              {submitting ? <Loader2 className="w-4 h-4 animate-spin" /> : "Se connecter"}
            </button>
          </form>

          <div className="flex items-center gap-3 my-5">
            <div className="h-px flex-1 bg-slate-800" />
            <span className="text-[10px] text-slate-500 uppercase tracking-widest font-bold">Ou</span>
            <div className="h-px flex-1 bg-slate-800" />
          </div>

          <button 
            onClick={handleGoogleLogin} 
            disabled={submitting}
            className="w-full h-11 rounded-xl bg-slate-900 border border-slate-700 hover:border-sky-500/50 text-slate-200 font-medium text-xs flex items-center justify-center gap-2 transition-all hover:bg-slate-800 disabled:opacity-50"
          >
            <svg className="w-4 h-4" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.84z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
            Continuer avec Google
          </button>

          <p className="mt-6 text-center text-xs text-slate-500">
            Nouveau ici ? <Link href="/signup" className="text-sky-400 hover:text-sky-300 font-semibold underline decoration-sky-500/30">Créer un compte</Link>
          </p>
        </div>
      </main>
    </div>
  );
}

export default function LoginPage() {
  return (
    <Suspense fallback={<div className="min-h-screen bg-[#0A0A0B] flex items-center justify-center"><Loader2 className="w-6 h-6 text-slate-500 animate-spin" /></div>}>
      <LoginPageInner />
    </Suspense>
  );
}
````

## File: app/page.tsx
````typescript
"use client";

import Link from "next/link";
import { motion, useScroll, useTransform } from "framer-motion";
import { useRef, useState, useEffect } from "react";
import { useRouter } from "next/navigation";
import { onAuthStateChanged, type User } from "firebase/auth";
import { auth } from "@/lib/firebase";
import { 
  ArrowRight, CheckCircle2, Sparkles, Zap, 
  FileText, Mic, BarChart3, ShieldCheck, 
  ChevronDown, Search, Bell, MoreHorizontal,
  Briefcase, PenTool, LayoutDashboard
} from "lucide-react";

// --- ANIMATION HELPERS ---
const fadeUp = (delay = 0) => ({
  initial: { opacity: 0, y: 20 },
  whileInView: { opacity: 1, y: 0 },
  viewport: { once: true, margin: "-50px" },
  transition: { duration: 0.5, delay, ease: "easeOut" }
});

export default function LandingPage() {
  const [currentUser, setCurrentUser] = useState<User | null>(null);
  const [navigating, setNavigating] = useState(false);
  const router = useRouter();
  const scrollRef = useRef<HTMLDivElement>(null);

  // Parallax Hero
  const { scrollY } = useScroll();
  const heroY = useTransform(scrollY, [0, 500], [0, 150]);
  const heroOpacity = useTransform(scrollY, [0, 400], [1, 0]);

  useEffect(() => {
    const unsub = onAuthStateChanged(auth, (user) => setCurrentUser(user));
    return () => unsub();
  }, []);

  const handleSmartLogin = () => {
    if (navigating) return;
    setNavigating(true);
    router.push(currentUser ? "/app" : "/login");
  };

  const scrollTo = (id: string) => {
    document.getElementById(id)?.scrollIntoView({ behavior: "smooth" });
  };

  return (
    <div className="min-h-screen bg-[#0A0A0B] text-slate-200 selection:bg-blue-500/30 selection:text-blue-200 overflow-x-hidden">
      
      {/* --- NAVBAR --- */}
      <nav className="fixed top-0 inset-x-0 z-50 h-16 border-b border-white/5 bg-[#0A0A0B]/80 backdrop-blur-md">
        <div className="max-w-7xl mx-auto px-4 h-full flex items-center justify-between">
          <div className="flex items-center gap-2 cursor-pointer" onClick={() => window.scrollTo({ top: 0, behavior: 'smooth' })}>
            <div className="w-8 h-8 rounded-lg bg-gradient-to-tr from-blue-600 to-indigo-600 flex items-center justify-center shadow-lg shadow-blue-500/20">
              <Zap className="w-4 h-4 text-white fill-white" />
            </div>
            <span className="font-bold text-white tracking-tight">SmartApply</span>
          </div>

          <div className="hidden md:flex items-center gap-8 text-sm font-medium text-slate-400">
            <button onClick={() => scrollTo("features")} className="hover:text-white transition-colors">Fonctionnalités</button>
            <button onClick={() => scrollTo("process")} className="hover:text-white transition-colors">Comment ça marche</button>
            <button onClick={() => scrollTo("pricing")} className="hover:text-white transition-colors">Tarifs</button>
          </div>

          <div className="flex items-center gap-4">
            <button 
              onClick={handleSmartLogin}
              className="hidden sm:block text-sm font-medium text-slate-300 hover:text-white transition-colors"
            >
              Connexion
            </button>
            <Link 
              href="/signup"
              className="group relative px-5 py-2 rounded-full bg-white text-black text-sm font-bold overflow-hidden transition-all hover:bg-slate-200"
            >
              <span className="relative z-10 flex items-center gap-2">
                Essayer gratuitement <ArrowRight className="w-3 h-3 group-hover:translate-x-1 transition-transform" />
              </span>
            </Link>
          </div>
        </div>
      </nav>

      <main className="relative pt-32 pb-16">
        
        {/* --- HERO SECTION --- */}
        <section className="relative px-4 max-w-7xl mx-auto mb-32">
          {/* Background Glows */}
          <div className="absolute top-0 left-1/2 -translate-x-1/2 w-[800px] h-[500px] bg-blue-600/20 rounded-full blur-[120px] pointer-events-none opacity-50" />
          
          <motion.div 
            style={{ y: heroY, opacity: heroOpacity }}
            className="relative z-10 text-center flex flex-col items-center"
          >
            <motion.div 
              initial={{ opacity: 0, y: 20 }} 
              animate={{ opacity: 1, y: 0 }} 
              transition={{ delay: 0.1 }}
              className="inline-flex items-center gap-2 px-3 py-1 rounded-full border border-blue-500/30 bg-blue-500/10 text-blue-300 text-xs font-medium mb-6"
            >
              <Sparkles className="w-3 h-3" /> Nouveau : Analyse de CV par IA v2
            </motion.div>

            <motion.h1 
              initial={{ opacity: 0, y: 20 }} 
              animate={{ opacity: 1, y: 0 }} 
              transition={{ delay: 0.2 }}
              className="text-5xl md:text-7xl font-bold tracking-tight text-white mb-6 max-w-4xl leading-[1.1]"
            >
              Décrochez le job <br />
              <span className="text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-indigo-400">sans la corvée.</span>
            </motion.h1>

            <motion.p 
              initial={{ opacity: 0, y: 20 }} 
              animate={{ opacity: 1, y: 0 }} 
              transition={{ delay: 0.3 }}
              className="text-lg md:text-xl text-slate-400 max-w-2xl mb-10 leading-relaxed"
            >
              L'assistant IA qui rédige vos lettres, prépare vos pitchs et optimise votre CV en quelques secondes. 
              Concentrez-vous sur l'entretien, on gère le reste.
            </motion.p>

            <motion.div 
              initial={{ opacity: 0, y: 20 }} 
              animate={{ opacity: 1, y: 0 }} 
              transition={{ delay: 0.4 }}
              className="flex flex-col sm:flex-row items-center gap-4 w-full sm:w-auto"
            >
              {/* BOUTON 1 : Essayer gratuitement */}
              <Link 
                href="/signup" 
                className="w-full sm:w-auto h-12 px-8 rounded-xl bg-blue-600 hover:bg-blue-500 text-white font-semibold transition-all shadow-lg shadow-blue-500/25 flex items-center justify-center gap-2"
              >
                Essayer gratuitement
                <ArrowRight className="w-4 h-4" />
              </Link>

              {/* BOUTON 2 : Générer un CV ATS */}
              <button 
                onClick={handleSmartLogin}
                className="w-full sm:w-auto h-12 px-8 rounded-xl bg-white/5 hover:bg-white/10 border border-white/10 text-white font-medium transition-all flex items-center justify-center gap-2 group"
              >
                <FileText className="w-4 h-4 text-slate-400 group-hover:text-white transition-colors" />
                Générer un CV ATS
              </button>
            </motion.div>

            {/* 🔥 DASHBOARD PREVIEW MOCKUP 🔥 */}
            <motion.div 
              initial={{ opacity: 0, y: 40, rotateX: 10 }}
              animate={{ opacity: 1, y: 0, rotateX: 0 }}
              transition={{ delay: 0.6, duration: 0.8 }}
              className="mt-16 w-full max-w-5xl rounded-2xl border border-white/10 bg-[#0F1115] shadow-2xl shadow-blue-900/20 overflow-hidden relative group perspective-1000"
            >
              {/* Overlay dégradé (demandé par l'utilisateur) pour fondre le bas */}
              <div className="absolute inset-0 bg-gradient-to-t from-[#0A0A0B] via-transparent to-transparent z-20 pointer-events-none"></div>

              {/* Contenu de l'interface (Mockup) */}
              <div className="grid grid-cols-[200px_1fr] h-[550px] opacity-90">
                
                {/* 1. Sidebar Mockup */}
                <div className="border-r border-white/5 bg-[#16181D] p-4 flex flex-col gap-6">
                  {/* Fake User */}
                  <div className="flex items-center gap-3 px-2">
                    <div className="w-8 h-8 rounded-full bg-gradient-to-tr from-blue-500 to-indigo-500"></div>
                    <div className="space-y-1">
                      <div className="h-2 w-16 bg-white/20 rounded"></div>
                      <div className="h-1.5 w-10 bg-white/10 rounded"></div>
                    </div>
                  </div>
                  
                  {/* Fake Nav */}
                  <div className="space-y-1">
                    <div className="flex items-center gap-3 px-3 py-2 rounded-lg bg-blue-500/10 border border-blue-500/20 text-blue-400 text-xs font-medium">
                      <LayoutDashboard className="w-3.5 h-3.5" /> Tableau de bord
                    </div>
                    {[
                      { icon: FileText, label: "Mes CVs" },
                      { icon: Briefcase, label: "Candidatures" },
                      { icon: PenTool, label: "Lettres IA" },
                      { icon: BarChart3, label: "Statistiques" }
                    ].map((item, i) => (
                      <div key={i} className="flex items-center gap-3 px-3 py-2 rounded-lg text-slate-500 hover:bg-white/5 transition-colors cursor-default">
                        <item.icon className="w-3.5 h-3.5" />
                        <div className="h-2 w-12 bg-white/10 rounded"></div>
                      </div>
                    ))}
                  </div>

                  <div className="mt-auto p-3 rounded-xl bg-gradient-to-br from-indigo-900/30 to-purple-900/30 border border-white/5">
                    <div className="flex items-center gap-2 mb-2">
                      <Sparkles className="w-3 h-3 text-indigo-400" />
                      <span className="text-[10px] font-bold text-indigo-200">Mode Pro</span>
                    </div>
                    <div className="h-1.5 w-full bg-white/10 rounded-full overflow-hidden">
                      <div className="h-full w-2/3 bg-indigo-500"></div>
                    </div>
                  </div>
                </div>

                {/* 2. Main Content Mockup */}
                <div className="bg-[#0F1115] p-6 flex flex-col gap-6 relative">
                  
                  {/* Top Bar */}
                  <div className="flex items-center justify-between">
                    <div>
                      <h3 className="text-white font-semibold text-lg">Bonjour, Thomas 👋</h3>
                      <p className="text-slate-500 text-xs">Vous avez 2 actions suggérées aujourd'hui.</p>
                    </div>
                    <div className="flex gap-3">
                      <div className="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center border border-white/5"><Search className="w-3.5 h-3.5 text-slate-400" /></div>
                      <div className="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center border border-white/5 relative">
                        <Bell className="w-3.5 h-3.5 text-slate-400" />
                        <div className="absolute top-2 right-2 w-1.5 h-1.5 bg-red-500 rounded-full border border-[#0F1115]"></div>
                      </div>
                    </div>
                  </div>

                  {/* Main Action Card */}
                  <div className="p-5 rounded-2xl bg-gradient-to-r from-blue-900/20 to-indigo-900/20 border border-blue-500/20 relative overflow-hidden">
                    <div className="relative z-10 flex justify-between items-start">
                      <div className="space-y-3">
                        <div className="inline-flex items-center gap-2 px-2 py-1 rounded bg-blue-500/20 text-blue-300 text-[10px] font-bold uppercase tracking-wider border border-blue-500/20">
                          <Zap className="w-3 h-3" /> Assistant Actif
                        </div>
                        <h4 className="text-xl font-bold text-white">Prêt à postuler ?</h4>
                        <div className="h-8 w-64 bg-[#0A0A0B]/50 rounded-lg border border-white/10 flex items-center px-3 text-xs text-slate-500">
                          Collez une URL ou description de poste...
                        </div>
                      </div>
                      <div className="w-10 h-10 rounded-full bg-blue-600 flex items-center justify-center shadow-lg shadow-blue-500/40">
                        <ArrowRight className="w-5 h-5 text-white" />
                      </div>
                    </div>
                  </div>

                  {/* Grid of Cards */}
                  <div className="grid grid-cols-3 gap-4">
                    {/* Card 1: Job Match */}
                    <div className="p-4 rounded-xl bg-[#16181D] border border-white/5 space-y-3">
                      <div className="flex justify-between items-start">
                        <div className="w-8 h-8 rounded bg-white/10 flex items-center justify-center"><Briefcase className="w-4 h-4 text-slate-400" /></div>
                        <MoreHorizontal className="w-4 h-4 text-slate-600" />
                      </div>
                      <div>
                        <div className="h-2 w-16 bg-white/20 rounded mb-1.5"></div>
                        <div className="h-1.5 w-24 bg-white/10 rounded"></div>
                      </div>
                      <div className="pt-2 border-t border-white/5 flex items-center gap-2">
                        <div className="w-16 h-1 bg-white/10 rounded-full overflow-hidden">
                          <div className="w-3/4 h-full bg-emerald-500"></div>
                        </div>
                        <span className="text-[10px] text-emerald-400 font-bold">92% Match</span>
                      </div>
                    </div>

                    {/* Card 2: CV Status */}
                    <div className="p-4 rounded-xl bg-[#16181D] border border-white/5 space-y-3">
                      <div className="flex justify-between items-start">
                        <div className="w-8 h-8 rounded bg-white/10 flex items-center justify-center"><FileText className="w-4 h-4 text-slate-400" /></div>
                        <div className="px-1.5 py-0.5 rounded bg-amber-500/10 text-amber-500 text-[10px] font-bold">V3</div>
                      </div>
                      <div>
                        <div className="h-2 w-20 bg-white/20 rounded mb-1.5"></div>
                        <div className="h-1.5 w-12 bg-white/10 rounded"></div>
                      </div>
                      <div className="pt-2 border-t border-white/5 flex gap-1">
                        {[1,2,3].map(i => <div key={i} className="h-1 w-1 rounded-full bg-slate-600"></div>)}
                      </div>
                    </div>

                    {/* Card 3: Pitch */}
                    <div className="p-4 rounded-xl bg-[#16181D] border border-white/5 space-y-3">
                      <div className="flex justify-between items-start">
                        <div className="w-8 h-8 rounded bg-white/10 flex items-center justify-center"><Mic className="w-4 h-4 text-slate-400" /></div>
                        <div className="w-2 h-2 rounded-full bg-red-500 animate-pulse"></div>
                      </div>
                      <div className="flex items-end gap-0.5 h-8 opacity-50">
                        {[4,8,6,3,9,5,7,4,6,3].map((h, i) => (
                          <div key={i} style={{ height: `${h * 10}%` }} className="w-1 bg-white/40 rounded-full"></div>
                        ))}
                      </div>
                      <div className="text-[10px] text-slate-500 text-center">Génération du pitch...</div>
                    </div>
                  </div>

                  {/* List Items */}
                  <div className="flex-1 rounded-xl bg-[#16181D] border border-white/5 p-4 space-y-3">
                    <div className="flex items-center justify-between mb-2">
                      <div className="h-2 w-24 bg-white/10 rounded"></div>
                      <div className="h-2 w-8 bg-white/5 rounded"></div>
                    </div>
                    {[1, 2, 3].map((i) => (
                      <div key={i} className="flex items-center gap-3 p-2 rounded hover:bg-white/5 transition-colors">
                        <div className="w-8 h-8 rounded bg-blue-500/10 flex items-center justify-center text-blue-500 font-bold text-xs">G</div>
                        <div className="space-y-1 flex-1">
                          <div className="h-1.5 w-20 bg-white/20 rounded"></div>
                          <div className="h-1 w-12 bg-white/10 rounded"></div>
                        </div>
                        <div className="px-2 py-1 rounded bg-green-500/10 text-green-500 text-[10px]">Envoyé</div>
                      </div>
                    ))}
                  </div>

                </div>
              </div>
            </motion.div>
          </motion.div>
        </section>

        {/* --- FEATURES BENTO GRID (Identique) --- */}
        <section id="features" className="max-w-7xl mx-auto px-4 py-24">
          <div className="text-center mb-16">
            <h2 className="text-3xl md:text-4xl font-bold text-white mb-4">Une suite complète pour candidats</h2>
            <p className="text-slate-400 max-w-2xl mx-auto">Tout ce dont vous avez besoin pour passer du statut "Candidat" à "Recruté", centralisé dans une interface fluide.</p>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
            {/* Feature 1 (Large) */}
            <motion.div 
              {...fadeUp(0)}
              whileHover={{ y: -5 }}
              className="md:col-span-2 rounded-3xl bg-gradient-to-br from-blue-900/20 to-[#111] border border-white/10 p-8 relative overflow-hidden group"
            >
              <div className="absolute top-0 right-0 p-10 opacity-10 group-hover:opacity-20 transition-opacity">
                <FileText className="w-64 h-64 text-blue-500" />
              </div>
              <div className="relative z-10">
                <div className="w-12 h-12 rounded-xl bg-blue-600/20 flex items-center justify-center mb-4 text-blue-400">
                  <Sparkles className="w-6 h-6" />
                </div>
                <h3 className="text-xl font-bold text-white mb-2">Générateur de Lettres IA</h3>
                <p className="text-slate-400 max-w-sm">Collez l'offre, notre IA analyse les mots-clés et rédige une lettre de motivation unique qui matche parfaitement votre profil avec le poste.</p>
              </div>
            </motion.div>

            {/* Feature 2 */}
            <motion.div 
              {...fadeUp(0.1)}
              whileHover={{ y: -5 }}
              className="rounded-3xl bg-[#111] border border-white/10 p-8 group"
            >
              <div className="w-12 h-12 rounded-xl bg-emerald-600/20 flex items-center justify-center mb-4 text-emerald-400">
                <Mic className="w-6 h-6" />
              </div>
              <h3 className="text-xl font-bold text-white mb-2">Pitch Oral</h3>
              <p className="text-slate-400 text-sm">Ne bégayez plus. Obtenez un script de présentation "Tell me about yourself" sur-mesure pour briller en entretien.</p>
            </motion.div>

            {/* Feature 3 */}
            <motion.div 
              {...fadeUp(0.15)}
              whileHover={{ y: -5 }}
              className="rounded-3xl bg-[#111] border border-white/10 p-8 group"
            >
              <div className="w-12 h-12 rounded-xl bg-purple-600/20 flex items-center justify-center mb-4 text-purple-400">
                <BarChart3 className="w-6 h-6" />
              </div>
              <h3 className="text-xl font-bold text-white mb-2">Suivi Candidatures</h3>
              <p className="text-slate-400 text-sm">Un tableau de type Kanban pour suivre l'état de chaque candidature : Envoyé, Entretien, Offre.</p>
            </motion.div>

            {/* Feature 4 (Large) */}
            <motion.div 
              {...fadeUp(0.2)}
              whileHover={{ y: -5 }}
              className="md:col-span-2 rounded-3xl bg-gradient-to-bl from-indigo-900/20 to-[#111] border border-white/10 p-8 relative overflow-hidden group"
            >
              <div className="absolute top-0 right-0 p-10 opacity-10 group-hover:opacity-20 transition-opacity">
                <ShieldCheck className="w-64 h-64 text-indigo-500" />
              </div>
              <div className="relative z-10">
                <div className="w-12 h-12 rounded-xl bg-indigo-600/20 flex items-center justify-center mb-4 text-indigo-400">
                  <ShieldCheck className="w-6 h-6" />
                </div>
                <h3 className="text-xl font-bold text-white mb-2">Analyseur de CV</h3>
                <p className="text-slate-400 max-w-sm">Importez votre PDF. L'IA extrait vos compétences et expériences pour les réutiliser intelligemment dans chaque nouvelle candidature.</p>
              </div>
            </motion.div>
          </div>
        </section>

        {/* --- HOW IT WORKS (Timeline) --- */}
        <section id="process" className="max-w-5xl mx-auto px-4 py-24">
          <h2 className="text-3xl md:text-4xl font-bold text-white mb-16 text-center">Comment ça marche ?</h2>
          
          <div className="relative border-l border-white/10 ml-6 md:ml-12 space-y-16">
            {[
              {
                step: "01",
                title: "Importez votre profil",
                desc: "Uploadez votre CV actuel. Notre système analyse votre parcours, vos skills et vos réalisations.",
                icon: FileText
              },
              {
                step: "02",
                title: "Ciblez une offre",
                desc: "Copiez-collez la description du poste qui vous intéresse. L'IA identifie les points clés attendus.",
                icon: Zap
              },
              {
                step: "03",
                title: "Générez & Postulez",
                desc: "Obtenez instantanément une lettre, un pitch et des conseils d'entretien. Personnalisez, exportez, envoyez.",
                icon: CheckCircle2
              }
            ].map((item, index) => (
              <motion.div 
                key={index}
                initial={{ opacity: 0, x: -20 }}
                whileInView={{ opacity: 1, x: 0 }}
                viewport={{ once: true, margin: "-100px" }}
                className="relative pl-12"
              >
                <div className="absolute -left-[25px] top-0 w-12 h-12 rounded-full bg-[#0A0A0B] border border-blue-500/50 flex items-center justify-center text-blue-400 font-bold shadow-[0_0_15px_rgba(59,130,246,0.3)]">
                  {item.step}
                </div>
                <h3 className="text-2xl font-bold text-white mb-2 flex items-center gap-3">
                  {item.title}
                </h3>
                <p className="text-slate-400 text-lg leading-relaxed max-w-xl">
                  {item.desc}
                </p>
              </motion.div>
            ))}
          </div>
        </section>

        {/* --- PRICING --- */}
        <section id="pricing" className="max-w-7xl mx-auto px-4 py-24 bg-white/[0.02] border-y border-white/5">
          <div className="text-center mb-16">
            <h2 className="text-3xl md:text-4xl font-bold text-white mb-4">Investissez dans votre avenir</h2>
            <p className="text-slate-400">Pas d'abonnement caché. Payez ce que vous utilisez.</p>
          </div>

          <div className="grid md:grid-cols-3 gap-8 max-w-5xl mx-auto">
            {[
              { title: "Découverte", price: "Gratuit", desc: "Pour tester la puissance de l'IA", features: ["Analyse CV basique", "1 Lettre de motivation", "Accès Tracker"] },
              { title: "Boost", price: "9.99€", desc: "Pour une recherche active", features: ["Analyse CV complète", "15 Lettres de motivation", "5 Pitchs d'entretien", "Support prioritaire"], popular: true },
              { title: "Carrière", price: "19.99€", desc: "L'arsenal complet", features: ["Crédits illimités (30 jours)", "Optimisation CV par IA", "Lettres illimitées", "Coaching entretien IA"] }
            ].map((plan, i) => (
              <motion.div 
                key={i}
                whileHover={{ y: -10 }}
                className={`relative p-8 rounded-3xl border flex flex-col ${
                  plan.popular 
                    ? "bg-gradient-to-b from-blue-900/20 to-[#0A0A0B] border-blue-500/50 shadow-2xl shadow-blue-900/20" 
                    : "bg-[#111] border-white/10"
                }`}
              >
                {plan.popular && (
                  <div className="absolute -top-4 left-1/2 -translate-x-1/2 px-4 py-1 bg-blue-600 text-white text-xs font-bold uppercase tracking-wider rounded-full">
                    Populaire
                  </div>
                )}
                <h3 className="text-lg font-medium text-slate-300 mb-2">{plan.title}</h3>
                <div className="text-4xl font-bold text-white mb-2">{plan.price}</div>
                <p className="text-sm text-slate-500 mb-8">{plan.desc}</p>
                
                <ul className="space-y-4 mb-8 flex-1">
                  {plan.features.map((feat, j) => (
                    <li key={j} className="flex items-center gap-3 text-sm text-slate-300">
                      <CheckCircle2 className="w-4 h-4 text-blue-500 flex-shrink-0" />
                      {feat}
                    </li>
                  ))}
                </ul>

                <button 
                  onClick={handleSmartLogin}
                  className={`w-full py-3 rounded-xl font-bold transition-all ${
                    plan.popular 
                      ? "bg-blue-600 hover:bg-blue-500 text-white" 
                      : "bg-white/10 hover:bg-white/20 text-white"
                  }`}
                >
                  Choisir
                </button>
              </motion.div>
            ))}
          </div>
        </section>

        {/* --- FAQ --- */}
        <section id="faq" className="max-w-3xl mx-auto px-4 py-24">
          <h2 className="text-3xl font-bold text-white mb-12 text-center">Questions fréquentes</h2>
          <div className="space-y-4">
            {[
              { q: "Est-ce que l'IA remplace mon travail ?", a: "Non, elle l'accélère. Vous gardez le contrôle final sur tous les textes générés." },
              { q: "Mes données sont-elles sécurisées ?", a: "Oui, nous ne vendons pas vos données. Elles servent uniquement à générer vos documents." },
              { q: "Puis-je annuler à tout moment ?", a: "Il n'y a rien à annuler ! Nous fonctionnons par packs de crédits, sans abonnement récurrent." }
            ].map((item, i) => (
              <details key={i} className="group bg-[#111] rounded-2xl border border-white/5 overflow-hidden">
                <summary className="flex items-center justify-between p-6 cursor-pointer list-none">
                  <span className="font-medium text-slate-200">{item.q}</span>
                  <ChevronDown className="w-5 h-5 text-slate-500 transition-transform group-open:rotate-180" />
                </summary>
                <div className="px-6 pb-6 text-slate-400 text-sm leading-relaxed">
                  {item.a}
                </div>
              </details>
            ))}
          </div>
        </section>

        {/* --- CTA FINAL --- */}
        <section className="px-4 py-24 text-center">
          <div className="max-w-4xl mx-auto bg-gradient-to-b from-blue-900/40 to-[#0A0A0B] border border-blue-500/30 rounded-[3rem] p-12 relative overflow-hidden">
            <div className="absolute top-0 left-1/2 -translate-x-1/2 w-full h-full bg-[radial-gradient(circle_at_center,_rgba(59,130,246,0.15),_transparent_70%)] pointer-events-none" />
            
            <h2 className="text-3xl md:text-5xl font-bold text-white mb-6 relative z-10">Prêt à décrocher votre prochain poste ?</h2>
            <p className="text-lg text-slate-400 mb-10 max-w-2xl mx-auto relative z-10">
              Rejoignez des milliers de candidats qui ont réduit leur stress et augmenté leurs entretiens.
            </p>
            
            <Link 
              href="/signup"
              className="relative z-10 px-8 py-4 bg-white text-black text-lg font-bold rounded-full hover:bg-slate-200 transition-all shadow-[0_0_40px_rgba(255,255,255,0.3)] inline-block"
            >
              Essayer gratuitement
            </Link>
          </div>
        </section>

      </main>

      {/* --- FOOTER --- */}
      <footer className="border-t border-white/5 bg-[#050505] text-slate-500 py-12 px-4 text-center text-sm">
        <div className="flex items-center justify-center gap-2 mb-4">
          <Zap className="w-4 h-4" />
          <span className="font-bold text-slate-300">SmartApply AI</span>
        </div>
        <p>&copy; {new Date().getFullYear()} SmartApply. Tous droits réservés.</p>
      </footer>
    </div>
  );
}
````

## File: components/InterviewChat.tsx
````typescript
// components/InterviewChat.tsx
"use client";

import { useEffect, useMemo, useRef, useState } from "react";
import { useAuth } from "@/context/AuthContext";
import { tryGetRecaptchaToken } from "@/lib/recaptcha";

export type SimConfig = {
  jobTitle: string;
  jobDesc: string;
  type: "complet" | "rapide" | "technique" | "comportemental";
  difficulty: "facile" | "standard" | "difficile";
  recruiter: "man" | "woman";
};

export type InterviewMessage = {
  role: "interviewer" | "candidate" | "system";
  text: string;
};

export type InterviewResult = {
  sessionId: string | null;
  history: InterviewMessage[];
  finalSummary: string | null;
  finalScore: number | null;
  finalDecision: string | null;
  startedAt: number;
  endedAt: number;
  questionsAsked: number;
};

type Props = {
  initialConfig?: SimConfig | null;

  onFinish?: (result: InterviewResult) => void;
  endSignal?: number;
  autoListen?: boolean;
};

type InterviewMode = SimConfig["type"];
type Difficulty = SimConfig["difficulty"];
type VoiceProfileId = "femme" | "homme";
type RecruiterGender = "f" | "m";

const INTERVIEW_QUESTION_PLAN: Record<InterviewMode, number> = {
  complet: 8,
  rapide: 4,
  technique: 6,
  comportemental: 6,
};

const VOICE_PROFILES: Record<VoiceProfileId, { label: string; pitch: number; rate: number }> = {
  femme: { label: "Voix féminine", pitch: 1.1, rate: 1.0 },
  homme: { label: "Voix masculine", pitch: 0.9, rate: 0.98 },
};

const AVG_MIN_PER_QUESTION = 1.5;
const RECAPTCHA_ACTION = "interview";

const getCandidateNameFromAuth = (user: any): string | null => {
  if (!user) return null;
  const possible = user.displayName || user.fullName || user.name || user.email?.split("@")[0] || "";
  const trimmed = (possible || "").toString().trim();
  return trimmed || null;
};

const personalizeQuestionClient = (raw: string | null | undefined, user: any): string => {
  if (!raw) return "";
  let q = raw;

  const safeName = getCandidateNameFromAuth(user) || "";
  const firstName = safeName.split(" ")[0] || safeName;

  if (safeName) {
    q = q.replace(/\[Nom du candidat[^\]]*\]/gi, safeName);
    q = q.replace(/\[Prénom du candidat[^\]]*\]/gi, firstName);
    q = q.replace(/\[Name of the candidate[^\]]*\]/gi, safeName);
    q = q.replace(/\[First name of the candidate[^\]]*\]/gi, firstName);
  } else {
    q = q.replace(/\[Nom du candidat[^\]]*\]/gi, "");
    q = q.replace(/\[Prénom du candidat[^\]]*\]/gi, "");
    q = q.replace(/\[Name of the candidate[^\]]*\]/gi, "");
    q = q.replace(/\[First name of the candidate[^\]]*\]/gi, "");
  }

  q = q.replace(/\s+,/g, ",");
  q = q.replace(/\s{2,}/g, " ").trim();
  q = q.replace(/^,\s*/, "");
  q = q.replace(/^Bonjour\s*,/i, "Bonjour,");
  q = q.replace(/^Bonjour\s+$/, "Bonjour,");

  return q.trim();
};

const formatMMSS = (sec: number) => {
  const s = Math.max(0, Math.floor(sec));
  const mm = String(Math.floor(s / 60)).padStart(2, "0");
  const ss = String(s % 60).padStart(2, "0");
  return `${mm}:${ss}`;
};

export default function InterviewChat({ initialConfig, onFinish, endSignal, autoListen = true }: Props) {
  const { user } = useAuth();

  const cfg = initialConfig ?? null;

  // si pas de config => pas de formulaire ici, juste un message.
  const canRun = !!cfg;

  const [sessionId, setSessionId] = useState<string | null>(null);
  const [history, setHistory] = useState<InterviewMessage[]>([]);
  const [input, setInput] = useState("");
  const [loading, setLoading] = useState(false);

  const [started, setStarted] = useState(false);
  const [finished, setFinished] = useState(false);

  // config dérivée
  const jobTitle = cfg?.jobTitle ?? "";
  const jobDesc = cfg?.jobDesc ?? "";
  const interviewMode: InterviewMode = cfg?.type ?? "complet";
  const difficulty: Difficulty = cfg?.difficulty ?? "standard";
  const recruiterGender: RecruiterGender = cfg?.recruiter === "woman" ? "f" : "m";
  const voiceProfile: VoiceProfileId = cfg?.recruiter === "woman" ? "femme" : "homme";

  const totalQuestions = useMemo(() => INTERVIEW_QUESTION_PLAN[interviewMode], [interviewMode]);

  const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);

  // Speech / mic
  const [listening, setListening] = useState(false);
  const recognitionRef = useRef<any>(null);
  const [speechSupported, setSpeechSupported] = useState(false);
  const [recognitionSupported, setRecognitionSupported] = useState(false);
  const [aiSpeaking, setAiSpeaking] = useState(false);

  // Final
  const [finalSummary, setFinalSummary] = useState<string | null>(null);
  const [finalScore, setFinalScore] = useState<number | null>(null);
  const [finalDecision, setFinalDecision] = useState<string | null>(null);

  // Typewriter
  const [typing, setTyping] = useState(false);
  const [typingIndex, setTypingIndex] = useState(0);

  // Scroll transcript (optionnel)
  const chatRef = useRef<HTMLDivElement | null>(null);
  const [showTranscript, setShowTranscript] = useState(false);

  const hasStartedRef = useRef(false);
  const endSignalRef = useRef<number | undefined>(undefined);

  const startedAtRef = useRef<number>(0);

  // ---- VISIO (camera) ----
  const [camEnabled, setCamEnabled] = useState(false);
  const camStreamRef = useRef<MediaStream | null>(null);
  const userVideoRef = useRef<HTMLVideoElement | null>(null);
  const [camError, setCamError] = useState<string | null>(null);

  // AI video sources (mets tes mp4 dans /public/videos/)
  const aiVideoSrc = recruiterGender === "f" ? "/videos/recruiter-woman.mp4" : "/videos/recruiter-man.mp4";

  const [aiVideoError, setAiVideoError] = useState(false);

  const requestCamera = async () => {
    setCamError(null);
    try {
      if (typeof window === "undefined" || !navigator.mediaDevices?.getUserMedia) {
        setCamError("Caméra non supportée par ce navigateur.");
        return false;
      }

      // stop old stream first
      if (camStreamRef.current) {
        camStreamRef.current.getTracks().forEach((t) => t.stop());
        camStreamRef.current = null;
      }

      const stream = await navigator.mediaDevices.getUserMedia({
        video: { width: { ideal: 1280 }, height: { ideal: 720 }, facingMode: "user" },
        audio: false,
      });

      camStreamRef.current = stream;

      if (userVideoRef.current) {
        userVideoRef.current.srcObject = stream;
        try {
          await userVideoRef.current.play();
        } catch {
          // autoplay may be blocked; user gesture will fix
        }
      }
      return true;
    } catch (e: any) {
      setCamError(e?.message || "Impossible d’accéder à la caméra.");
      return false;
    }
  };

  const stopCamera = () => {
    if (camStreamRef.current) {
      camStreamRef.current.getTracks().forEach((t) => t.stop());
      camStreamRef.current = null;
    }
    if (userVideoRef.current) {
      userVideoRef.current.srcObject = null;
    }
  };

  const toggleCamera = async () => {
    if (camEnabled) {
      setCamEnabled(false);
      stopCamera();
      return;
    }
    const ok = await requestCamera();
    setCamEnabled(ok);
  };

  // cleanup camera on unmount
  useEffect(() => {
    return () => {
      stopCamera();
    };
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  // ✅ Helper fetch /api/interview + reCAPTCHA
  const postInterview = async (payload: any) => {
    const recaptchaToken = await tryGetRecaptchaToken(RECAPTCHA_ACTION).catch(() => null);

    const headers: Record<string, string> = { "Content-Type": "application/json" };
    if (recaptchaToken) headers["X-Recaptcha-Token"] = recaptchaToken;

    const body = {
      ...payload,
      recaptchaToken: recaptchaToken || undefined,
      recaptchaAction: RECAPTCHA_ACTION,
    };

    const res = await fetch("/api/interview", {
      method: "POST",
      headers,
      body: JSON.stringify(body),
    });

    const contentType = res.headers.get("content-type") || "";
    const data = contentType.includes("application/json") ? await res.json().catch(() => null) : await res.text().catch(() => "");

    if (!res.ok) {
      const errMsg =
        typeof data === "object" && data
          ? data.error || `HTTP ${res.status}` + (data.details ? ` — ${JSON.stringify(data.details)}` : "")
          : typeof data === "string"
          ? data || `HTTP ${res.status}`
          : `HTTP ${res.status}`;

      throw new Error(errMsg);
    }

    return data;
  };

  // --- INIT VOIX (TTS) ---
  useEffect(() => {
    if (typeof window === "undefined") return;
    setSpeechSupported("speechSynthesis" in window);
  }, []);

  // --- AUTO-SCROLL transcript ---
  useEffect(() => {
    if (!showTranscript) return;
    const el = chatRef.current;
    if (!el) return;
    el.scrollTop = el.scrollHeight;
  }, [history, loading, showTranscript]);

  const lastInterviewerIndex =
    history.length > 0
      ? [...history]
          .map((m, i) => ({ m, i }))
          .reverse()
          .find(({ m }) => m.role === "interviewer")?.i ?? -1
      : -1;

  const lastInterviewerMessage = lastInterviewerIndex >= 0 ? history[lastInterviewerIndex]?.text || "" : "";

  // --- TYPEWRITER ---
  useEffect(() => {
    if (!typing) return;
    if (lastInterviewerIndex === -1) return;
    const msg = history[lastInterviewerIndex];
    if (!msg) return;

    if (typingIndex >= msg.text.length) {
      setTyping(false);
      return;
    }

    const interval = setInterval(() => setTypingIndex((prev) => prev + 2), 15);
    return () => clearInterval(interval);
  }, [typing, typingIndex, history, lastInterviewerIndex]);

  // --- BEEP MIC ---
  const playMicBeep = () => {
    try {
      const W = window as any;
      const AudioContext = W.AudioContext || W.webkitAudioContext;
      if (!AudioContext) return;
      const ctx = new AudioContext();
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.type = "sine";
      osc.frequency.value = 1000;
      gain.gain.value = 0.06;
      osc.connect(gain);
      gain.connect(ctx.destination);
      osc.start();
      setTimeout(() => {
        osc.stop();
        ctx.close();
      }, 120);
    } catch {}
  };

  // --- MIC CONTROL ---
  const startMic = () => {
    if (!recognitionRef.current) return false;
    try {
      setListening(true);
      playMicBeep();
      recognitionRef.current.start();
      return true;
    } catch {
      setListening(false);
      return false;
    }
  };

  const stopMic = () => {
    if (!recognitionRef.current) return;
    try {
      recognitionRef.current.stop();
    } catch {}
  };

  // --- PARLER (TTS) ---
  const speak = (text: string) => {
    if (typeof window === "undefined") return;
    const toSpeak = (text || "").trim();
    if (!toSpeak) return;
    if (!("speechSynthesis" in window)) return;

    try {
      if (listening) stopMic();

      const utterance = new SpeechSynthesisUtterance(toSpeak);
      utterance.lang = "fr-FR";

      const profile = VOICE_PROFILES[voiceProfile];
      if (profile) {
        utterance.pitch = profile.pitch;
        utterance.rate = profile.rate;
      }

      utterance.onstart = () => setAiSpeaking(true);
      utterance.onend = () => {
        setAiSpeaking(false);
        if (autoListen && started && !finished && recognitionSupported) {
          startMic();
        }
      };
      utterance.onerror = () => setAiSpeaking(false);

      try {
        window.speechSynthesis.cancel();
      } catch {}
      window.speechSynthesis.speak(utterance);
    } catch {
      setAiSpeaking(false);
    }
  };

  // --- PARSE backend payload ---
  const parseInterviewPayload = (raw: any) => {
    let obj: any = raw;

    const tryParseString = (txt: string | null | undefined): any => {
      if (!txt) return null;
      let inner = txt.trim();

      if (inner.startsWith("```")) {
        inner = inner.replace(/^```[a-zA-Z]*\s*\n?/, "").replace(/```$/, "").trim();
      }

      try {
        return JSON.parse(inner);
      } catch {
        return { next_question: inner };
      }
    };

    if (typeof obj === "string") obj = tryParseString(obj);

    const nextQuestionRaw = obj?.next_question || obj?.nextQuestion || obj?.question || null;
    const shortAnalysis = obj?.short_analysis || obj?.shortAnalysis || null;
    const finalSummary = obj?.final_summary || obj?.finalSummary || null;
    const finalScoreRaw = obj?.final_score ?? obj?.finalScore ?? null;

    const nextQuestionText = typeof nextQuestionRaw === "string" ? nextQuestionRaw.trim() : null;

    const scoreNum =
      typeof finalScoreRaw === "number" ? finalScoreRaw : typeof finalScoreRaw === "string" ? parseFloat(finalScoreRaw) : null;

    return {
      nextQuestion: nextQuestionText || null,
      shortAnalysis: typeof shortAnalysis === "string" ? shortAnalysis.trim() : null,
      finalSummary: typeof finalSummary === "string" ? finalSummary.trim() : null,
      finalScore: Number.isNaN(scoreNum as any) ? null : (scoreNum as any),
    };
  };

  const computeDecision = (score: number | null) => {
    if (typeof score !== "number") return null;
    if (score >= 80) return "Très bon entretien : fortes chances d’être retenu(e). 🎉";
    if (score >= 60) return "Entretien correct : possible suite, mais axes d’amélioration.";
    return "Entretien en dessous des attentes : retravailler des points clés avant de postuler.";
  };

  const emitFinish = (override?: Partial<InterviewResult>) => {
    const endedAt = Date.now();
    const questionsAsked = history.filter((m) => m.role === "interviewer").length;

    const result: InterviewResult = {
      sessionId,
      history,
      finalSummary,
      finalScore,
      finalDecision,
      startedAt: startedAtRef.current || endedAt,
      endedAt,
      questionsAsked,
      ...override,
    };

    onFinish?.(result);
  };

  // --- START (auto) ---
  const startInterview = async () => {
    if (!cfg) return;
    if (!user) {
      setHistory([{ role: "system", text: "Connecte-toi pour lancer la simulation." }]);
      return;
    }

    setLoading(true);
    setHistory([]);
    setFinished(false);
    setFinalSummary(null);
    setFinalScore(null);
    setFinalDecision(null);
    setCurrentQuestionIndex(0);

    startedAtRef.current = Date.now();

    try {
      // unlock TTS best-effort
      try {
        if (typeof window !== "undefined" && "speechSynthesis" in window) {
          const silent = new SpeechSynthesisUtterance(" ");
          silent.volume = 0;
          window.speechSynthesis.speak(silent);
        }
      } catch {}

      const data = await postInterview({
        action: "start",
        userId: user.uid,
        jobTitle,
        jobDesc,
        interviewMode,
        difficulty,
        channel: "oral",
      });

      const rawFirst =
        (data as any)?.firstQuestion ||
        (data as any)?.first_question ||
        (data as any)?.nextQuestion ||
        (data as any)?.next_question ||
        data;

      const { nextQuestion, shortAnalysis, finalSummary: fs, finalScore: sc } = parseInterviewPayload(rawFirst);

      const firstQ = personalizeQuestionClient(
        nextQuestion || "Bonjour ! Pour commencer, pouvez-vous vous présenter en quelques phrases ?",
        user
      );

      setSessionId((data as any)?.sessionId || (data as any)?.session_id || null);
      setStarted(true);
      setCurrentQuestionIndex(1);

      const newHistory: InterviewMessage[] = [{ role: "interviewer", text: firstQ }];

      if (shortAnalysis) {
        newHistory.push({ role: "system", text: `💭 Ce que pense le recruteur : ${shortAnalysis}` });
      }

      setHistory(newHistory);

      if (fs) {
        setFinalSummary(fs);
        if (sc !== null) setFinalScore(sc);
        const dec = computeDecision(sc);
        if (dec) setFinalDecision(dec);
        setFinished(true);
        setTimeout(() => emitFinish({ finalSummary: fs, finalScore: sc, finalDecision: dec }), 0);
      }

      setTypingIndex(0);
      setTyping(true);
      speak(firstQ);
    } catch (e: any) {
      setHistory([{ role: "system", text: e?.message || "Erreur lors du démarrage." }]);
      setStarted(false);
      setSessionId(null);
    } finally {
      setLoading(false);
    }
  };

  // auto-start once when config arrives
  useEffect(() => {
    if (!canRun) return;
    if (!cfg) return;
    if (hasStartedRef.current) return;
    hasStartedRef.current = true;
    startInterview();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [canRun, cfg?.jobTitle, cfg?.jobDesc, cfg?.type, cfg?.difficulty, cfg?.recruiter]);

  // --- SEND ANSWER ---
  const sendAnswer = async (text: string) => {
    const answer = text.trim();
    if (!answer) return;

    if (!started || !sessionId) return;

    setHistory((prev) => [...prev, { role: "candidate", text: answer }]);
    setInput("");
    setLoading(true);

    try {
      const data = await postInterview({
        action: "answer",
        userId: user?.uid,
        sessionId,
        userMessage: answer,
        interviewMode,
        difficulty,
      });

      const { nextQuestion, shortAnalysis, finalSummary: fs, finalScore: sc } = parseInterviewPayload(data);

      const nextQClean = nextQuestion ? personalizeQuestionClient(nextQuestion, user) : null;

      setHistory((prev) => {
        const newHistory = [...prev];

        if (shortAnalysis) {
          newHistory.push({ role: "system", text: `💭 Ce que pense le recruteur : ${shortAnalysis}` });
        }

        if (nextQClean && !fs) {
          newHistory.push({ role: "interviewer", text: nextQClean });
        }

        return newHistory;
      });

      if (fs || typeof sc === "number") {
        if (fs) setFinalSummary(fs);
        if (typeof sc === "number") setFinalScore(sc);

        const dec = computeDecision(typeof sc === "number" ? sc : null);
        if (dec) setFinalDecision(dec);

        setFinished(true);

        if (listening) stopMic();

        setTimeout(() => {
          emitFinish({
            finalSummary: fs ?? finalSummary,
            finalScore: typeof sc === "number" ? sc : finalScore,
            finalDecision: dec ?? finalDecision,
          });
        }, 0);
      }

      if (nextQClean && !fs) {
        setCurrentQuestionIndex((prev) => Math.min(prev + 1, totalQuestions));
        setTypingIndex(0);
        setTyping(true);
        speak(nextQClean);
      }
    } catch (e: any) {
      setHistory((prev) => [...prev, { role: "system", text: e?.message || "Erreur lors de l'envoi." }]);
    } finally {
      setLoading(false);
    }
  };

  // --- FINALIZE (Quitter / endSignal) ---
  const finalizeInterviewNow = async () => {
    if (!started || !sessionId || finished) return;
    setLoading(true);

    try {
      let data: any = null;
      try {
        data = await postInterview({
          action: "finalize",
          userId: user?.uid,
          sessionId,
          interviewMode,
          difficulty,
        });
      } catch {
        data = await postInterview({
          action: "answer",
          userId: user?.uid,
          sessionId,
          userMessage:
            "Je souhaite terminer l’entretien maintenant. Merci de générer le bilan final (synthèse + note sur 100 + décision probable).",
          interviewMode,
          difficulty,
        });
      }

      const { finalSummary: fs, finalScore: sc } = parseInterviewPayload(data);

      const dec = computeDecision(typeof sc === "number" ? sc : null);

      if (fs) setFinalSummary(fs);
      if (typeof sc === "number") setFinalScore(sc);
      if (dec) setFinalDecision(dec);

      setFinished(true);

      if (listening) stopMic();

      setTimeout(() => {
        emitFinish({
          finalSummary: fs ?? "Bilan non disponible (fin anticipée).",
          finalScore: typeof sc === "number" ? sc : null,
          finalDecision: dec ?? null,
        });
      }, 0);
    } catch (e: any) {
      setHistory((prev) => [...prev, { role: "system", text: e?.message || "Impossible de générer le bilan. Réessaie." }]);
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    if (endSignal === undefined) return;
    if (endSignalRef.current === undefined) {
      endSignalRef.current = endSignal;
      return;
    }
    if (endSignalRef.current !== endSignal) {
      endSignalRef.current = endSignal;
      finalizeInterviewNow();
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [endSignal]);

  // --- INIT SPEECH RECOGNITION ---
  useEffect(() => {
    if (typeof window === "undefined") return;

    const w = window as any;
    const SpeechRecognition = w.SpeechRecognition || w.webkitSpeechRecognition;

    if (!SpeechRecognition) {
      setRecognitionSupported(false);
      recognitionRef.current = null;
      return;
    }

    setRecognitionSupported(true);

    const recognition = new SpeechRecognition();
    recognition.lang = "fr-FR";
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;

    recognition.onresult = (event: any) => {
      const text = event.results?.[0]?.[0]?.transcript || "";
      if (text) sendAnswer(text);
    };

    recognition.onend = () => setListening(false);
    recognition.onerror = () => setListening(false);

    recognitionRef.current = recognition;

    return () => {
      try {
        recognition.stop();
      } catch {}
    };
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [started, sessionId]);

  const toggleMic = () => {
    if (!started) return;

    if (!recognitionRef.current) {
      alert("Reconnaissance vocale indisponible ici. Tu peux répondre au clavier.");
      return;
    }

    if (listening) stopMic();
    else startMic();
  };

  const progressPercent = totalQuestions > 0 ? Math.min((currentQuestionIndex / totalQuestions) * 100, 100) : 0;
  const questionsLeft = Math.max(totalQuestions - currentQuestionIndex, 0);
  const estimatedMinutesLeft = questionsLeft * AVG_MIN_PER_QUESTION;
  const estimatedMinutesRounded = questionsLeft > 0 ? Math.max(1, Math.round(estimatedMinutesLeft)) : 0;

  // Timer (countdown "visio")
  const totalPlannedSeconds = Math.max(60, Math.round(totalQuestions * AVG_MIN_PER_QUESTION * 60));
  const [remainingSec, setRemainingSec] = useState(totalPlannedSeconds);

  useEffect(() => {
    if (!started || finished) return;
    setRemainingSec(totalPlannedSeconds);

    const t = setInterval(() => {
      const elapsed = Math.floor((Date.now() - (startedAtRef.current || Date.now())) / 1000);
      setRemainingSec(Math.max(0, totalPlannedSeconds - elapsed));
    }, 500);

    return () => clearInterval(t);
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [started, finished, totalPlannedSeconds]);

  // ---- RENDER ----
  if (!canRun) {
    return (
      <div className="p-6 text-sm text-[var(--muted)]">
        Configuration manquante. Retourne à l’étape 1 (Initialisation) pour lancer l’entretien.
      </div>
    );
  }

  const lastInterviewerForSubtitle =
    lastInterviewerIndex >= 0
      ? (() => {
          const m = history[lastInterviewerIndex];
          if (!m) return "";
          return typing ? m.text.slice(0, typingIndex) : m.text;
        })()
      : "";

  return (
    <section className="w-full">
      {/* VISIO CONTAINER */}
      <div className="rounded-3xl border border-white/10 bg-black/60 overflow-hidden shadow-2xl">
        {/* TOP TIMER */}
        <div className="relative">
          <div className="absolute left-1/2 -translate-x-1/2 top-3 z-20">
            <div className="px-5 py-2 rounded-full bg-black/60 border border-white/10 backdrop-blur-md text-white text-xl font-semibold tracking-wide">
              {formatMMSS(remainingSec)}
            </div>
          </div>

          {/* VIDEO GRID */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-3 p-4 pt-16">
            {/* AI tile */}
            <div className="relative aspect-video rounded-2xl overflow-hidden border border-white/10 bg-black">
              {!aiVideoError ? (
                <video
                  className="absolute inset-0 w-full h-full object-cover"
                  src={aiVideoSrc}
                  autoPlay
                  loop
                  muted
                  playsInline
                  onError={() => setAiVideoError(true)}
                />
              ) : (
                <div className="absolute inset-0 bg-gradient-to-br from-slate-900 to-slate-800 flex items-center justify-center">
                  <div className={`h-16 w-16 rounded-2xl border border-white/10 bg-white/5 flex items-center justify-center ${aiSpeaking ? "animate-pulse" : ""}`}>
                    <span className="text-4xl">{recruiterGender === "f" ? "👩‍💼" : "👨‍💼"}</span>
                  </div>
                </div>
              )}

              <div className="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-black/20" />

              {/* label */}
              <div className="absolute left-3 bottom-3 flex items-center gap-2 bg-black/55 border border-white/10 backdrop-blur-md rounded-xl px-3 py-2">
                <span className="text-white/90">🎙️</span>
                <div className="leading-tight">
                  <div className="text-white text-sm font-semibold">Simon</div>
                  <div className="text-white/70 text-xs">Recruteur IA</div>
                </div>
                <div className="ml-2">
                  <span className={`inline-flex h-2 w-2 rounded-full ${aiSpeaking ? "bg-emerald-400 animate-pulse" : "bg-white/30"}`} />
                </div>
              </div>
            </div>

            {/* You tile */}
            <div className="relative aspect-video rounded-2xl overflow-hidden border border-white/10 bg-black">
              {camEnabled ? (
                <>
                  <video
                    ref={userVideoRef}
                    className="absolute inset-0 w-full h-full object-cover"
                    autoPlay
                    playsInline
                    muted
                  />
                  <div className="absolute inset-0 bg-gradient-to-t from-black/50 via-transparent to-black/15" />
                </>
              ) : (
                <div className="absolute inset-0 bg-gradient-to-br from-slate-900 to-slate-800 flex items-center justify-center">
                  <div className="text-center">
                    <div className="mx-auto h-16 w-16 rounded-2xl border border-white/10 bg-white/5 flex items-center justify-center">
                      <span className="text-3xl">👤</span>
                    </div>
                    <div className="mt-3 text-white/80 text-sm">Caméra désactivée</div>
                    {camError && <div className="mt-1 text-xs text-red-200/90">{camError}</div>}
                  </div>
                </div>
              )}

              {/* label */}
              <div className="absolute left-3 bottom-3 flex items-center gap-2 bg-black/55 border border-white/10 backdrop-blur-md rounded-xl px-3 py-2">
                <span className="text-white/90">🎤</span>
                <div className="leading-tight">
                  <div className="text-white text-sm font-semibold">Vous</div>
                  <div className="text-white/70 text-xs">{listening ? "Micro: ON" : "Micro: OFF"}</div>
                </div>
                <div className="ml-2">
                  <span className={`inline-flex h-2 w-2 rounded-full ${listening ? "bg-red-400 animate-pulse" : "bg-white/30"}`} />
                </div>
              </div>
            </div>
          </div>

          {/* SUBTITLE (question) */}
          <div className="px-6 pb-4">
            <div className="text-center text-white/90 text-lg font-medium drop-shadow">
              {lastInterviewerForSubtitle || (loading ? "…" : "")}
            </div>
            <div className="mt-2 flex items-center justify-center gap-3 text-xs text-white/60">
              <span>
                {finished
                  ? "Entretien terminé"
                  : aiSpeaking
                  ? "L’IA parle…"
                  : listening
                  ? "Vous répondez…"
                  : "À vous"}
              </span>
              <span className="h-1 w-1 rounded-full bg-white/30" />
              <span>
                {finished ? "—" : `Question ${Math.max(1, currentQuestionIndex)} / ${totalQuestions}`}
              </span>
              <span className="h-1 w-1 rounded-full bg-white/30" />
              <span>{questionsLeft > 0 && !finished ? `~${estimatedMinutesRounded} min restantes` : ""}</span>
            </div>
          </div>
        </div>

        {/* CONTROLS BAR */}
        <div className="border-t border-white/10 bg-black/70">
          <div className="px-4 py-4 flex flex-col gap-3">
            <div className="flex flex-wrap items-center gap-3 justify-between">
              <div className="flex items-center gap-2">
                <button
                  onClick={toggleMic}
                  disabled={!started || loading || aiSpeaking || finished}
                  type="button"
                  className={`h-12 w-12 rounded-2xl border border-white/10 flex items-center justify-center transition
                    ${listening ? "bg-red-500/70 animate-pulse" : "bg-white/5 hover:bg-white/10"}
                    ${!started || loading || aiSpeaking || finished ? "opacity-50 cursor-not-allowed" : ""}`}
                  title={aiSpeaking ? "Attends la fin de la question" : listening ? "Arrêter le micro" : "Micro"}
                >
                  🎤
                </button>

                <button
                  onClick={toggleCamera}
                  disabled={finished}
                  type="button"
                  className={`h-12 px-5 rounded-2xl border border-white/10 flex items-center justify-center gap-2 transition
                    ${camEnabled ? "bg-blue-600/55" : "bg-white/5 hover:bg-white/10"}
                    ${finished ? "opacity-50 cursor-not-allowed" : ""}`}
                  title={camEnabled ? "Désactiver la caméra" : "Activer la caméra"}
                >
                  <span>📹</span>
                  <span className="text-white/90 text-sm font-semibold">Video</span>
                </button>

                <button
                  type="button"
                  onClick={() => lastInterviewerMessage && speak(lastInterviewerMessage)}
                  disabled={!lastInterviewerMessage}
                  className="h-12 px-5 rounded-2xl border border-white/10 bg-white/5 hover:bg-white/10 transition text-white/90 text-sm font-semibold disabled:opacity-40 disabled:cursor-not-allowed"
                  title="Réécouter la question"
                >
                  🔊 Réécouter
                </button>

                <button
                  type="button"
                  onClick={() => {
                    if (!lastInterviewerMessage) return;
                    navigator.clipboard?.writeText(lastInterviewerMessage).catch(() => {});
                  }}
                  disabled={!lastInterviewerMessage}
                  className="h-12 px-5 rounded-2xl border border-white/10 bg-white/5 hover:bg-white/10 transition text-white/90 text-sm font-semibold disabled:opacity-40 disabled:cursor-not-allowed"
                  title="Copier la question"
                >
                  📋 Copier la question
                </button>

                <button
                  type="button"
                  onClick={() => setShowTranscript((v) => !v)}
                  className="h-12 px-5 rounded-2xl border border-white/10 bg-white/5 hover:bg-white/10 transition text-white/90 text-sm font-semibold"
                  title="Afficher / masquer le transcript"
                >
                  {showTranscript ? "🧾 Masquer" : "🧾 Transcript"}
                </button>
              </div>

              <button
                type="button"
                onClick={finalizeInterviewNow}
                disabled={!started || finished || loading}
                className={`h-12 px-8 rounded-2xl border border-red-500/30 bg-red-500/75 hover:bg-red-500/85 transition text-white font-bold
                  ${!started || finished || loading ? "opacity-50 cursor-not-allowed" : ""}`}
                title="Quitter et générer le bilan"
              >
                Quitter
              </button>
            </div>

            {/* Keyboard answer (minimal, but still available) */}
            <div className="flex items-center gap-2">
              <div className="flex-1 rounded-2xl border border-white/10 bg-white/5 px-4 py-3 flex items-center gap-3">
                <input
                  className="flex-1 bg-transparent outline-none text-white placeholder:text-white/40 text-sm"
                  placeholder={started ? "Écris ta réponse (Entrée pour envoyer)..." : "Démarrage en cours..."}
                  value={input}
                  disabled={!started || loading || finished}
                  onChange={(e) => setInput(e.target.value)}
                  onKeyDown={(e) => started && e.key === "Enter" && sendAnswer(input)}
                />
                <button
                  onClick={() => sendAnswer(input)}
                  disabled={!started || loading || finished}
                  type="button"
                  className="h-10 px-5 rounded-xl border border-white/10 bg-white/10 hover:bg-white/15 transition text-white text-sm font-semibold disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  Envoyer ➤
                </button>
              </div>
            </div>

            {/* Transcript panel (optional) */}
            {showTranscript && (
              <div className="rounded-2xl border border-white/10 bg-black/40 overflow-hidden">
                <div className="px-4 py-3 border-b border-white/10 flex items-center justify-between">
                  <div className="text-white/80 text-sm font-semibold">Transcript</div>
                  <div className="text-white/50 text-xs">
                    {loading ? "L’IA réfléchit…" : finished ? "Terminé" : "En cours"}
                  </div>
                </div>

                <div ref={chatRef} className="max-h-[260px] overflow-y-auto custom-scrollbar p-4 space-y-3">
                  {history.map((m, i) => {
                    const isCandidate = m.role === "candidate";
                    const isSystem = m.role === "system";

                    if (isSystem) {
                      return (
                        <div key={i} className="text-xs text-white/55 bg-white/5 border border-white/10 rounded-xl px-3 py-2">
                          {m.text}
                        </div>
                      );
                    }

                    return (
                      <div key={i} className={`flex ${isCandidate ? "justify-end" : "justify-start"}`}>
                        <div
                          className={`max-w-[85%] rounded-2xl px-3 py-2 text-sm border border-white/10
                            ${isCandidate ? "bg-blue-600/20 text-white" : "bg-white/5 text-white/90"}`}
                        >
                          {m.text}
                        </div>
                      </div>
                    );
                  })}
                </div>

                {finished && (finalSummary || finalScore !== null) && (
                  <div className="px-4 py-4 border-t border-white/10 bg-emerald-500/10">
                    <div className="flex items-center justify-between">
                      <div className="text-emerald-200 font-semibold text-sm">Bilan</div>
                      {typeof finalScore === "number" && (
                        <div className="text-xs px-2 py-1 rounded-full border border-emerald-400/30 bg-emerald-500/10 text-emerald-100">
                          {Math.round(finalScore)}/100
                        </div>
                      )}
                    </div>
                    {finalDecision && <div className="mt-2 text-sm text-white/90 whitespace-pre-line">{finalDecision}</div>}
                    {finalSummary && <div className="mt-2 text-sm text-white/80 whitespace-pre-line">{finalSummary}</div>}
                  </div>
                )}
              </div>
            )}

            <div className="text-[11px] text-white/45 flex items-center justify-between">
              <span>
                {!recognitionSupported ? "⚠️ Reconnaissance vocale indisponible (clavier OK)." : ""}
                {!speechSupported ? " ⚠️ Synthèse vocale indisponible." : ""}
              </span>
              <span className="text-white/45">
                {jobTitle ? `Poste: ${jobTitle}` : ""}
              </span>
            </div>
          </div>
        </div>
      </div>
    </section>
  );
}
````

## File: context/LangContext.tsx
````typescript
// context/I18nContext.tsx
"use client";

import React, {
  createContext,
  useContext,
  useEffect,
  useState,
  type ReactNode,
} from "react";

export type LangCode = "fr" | "en" | "ar" | "zh";

type I18nContextValue = {
  lang: LangCode;
  setLang: (lang: LangCode) => void;
  t: (key: string) => string;
};

const I18nContext = createContext<I18nContextValue | undefined>(undefined);

const LANG_KEY = "acv-lang";

const translations: Record<LangCode, Record<string, string>> = {
  fr: {
    appTitle: "Assistant Candidatures V4",
    heroTitle:
      "L'assistant IA pour candidater comme un pro, sans y passer tes soirées.",
    heroSubtitle:
      "Importe ton CV, colle une offre d’emploi, laisse l’IA générer une lettre ciblée, un pitch oral et suis toutes tes candidatures depuis un tableau de bord unique.",
    startFree: "Essayer gratuitement",
    alreadyHaveAccount: "J'ai déjà un compte",
    logout: "Se déconnecter",
    creditsShort: "Cr.",
  },
  en: {
    appTitle: "Job Application Assistant V4",
    heroTitle:
      "The AI assistant to apply like a pro, without spending your evenings on it.",
    heroSubtitle:
      "Upload your resume, paste a job offer, let the AI generate a tailored cover letter, an interview pitch and track all your applications from one dashboard.",
    startFree: "Start for free",
    alreadyHaveAccount: "I already have an account",
    logout: "Logout",
    creditsShort: "Cr.",
  },
  ar: {
    appTitle: "مساعد التقديم على الوظائف V4",
    heroTitle:
      "مساعدك بالذكاء الاصطناعي للتقديم باحتراف، بدون أن تضيع أمسياتك.",
    heroSubtitle:
      "ارفع سيرتك الذاتية، والصق عرض العمل، ودع الذكاء الاصطناعي يُنشئ رسالة تحفيز موجهة، و«بيتش» للمقابلة، مع تتبع لجميع طلباتك في لوحة تحكم واحدة.",
    startFree: "ابدأ مجانًا",
    alreadyHaveAccount: "لدي حساب بالفعل",
    logout: "تسجيل الخروج",
    creditsShort: "رصيد",
  },
  zh: {
    appTitle: "AI 求职助手 V4",
    heroTitle: "用 AI 像专业人士一样投递，而不用熬夜写材料。",
    heroSubtitle:
      "上传简历、粘贴职位描述，AI 为你生成定制求职信和自我介绍，并在一个看板里跟踪所有投递。",
    startFree: "免费开始",
    alreadyHaveAccount: "我已有账号",
    logout: "退出登录",
    creditsShort: "点数",
  },
};

export const I18nProvider = ({ children }: { children: ReactNode }) => {
  const [lang, setLangState] = useState<LangCode>("fr");

  useEffect(() => {
    const stored = localStorage.getItem(LANG_KEY) as LangCode | null;
    const initial =
      stored && translations[stored] ? stored : ("fr" as LangCode);

    setLangState(initial);
    document.documentElement.dir = initial === "ar" ? "rtl" : "ltr";
    document.documentElement.lang = initial;
  }, []);

  const setLang = (next: LangCode) => {
    setLangState(next);
    localStorage.setItem(LANG_KEY, next);
    document.documentElement.dir = next === "ar" ? "rtl" : "ltr";
    document.documentElement.lang = next;
  };

  const t = (key: string) => translations[lang]?.[key] ?? key;

  return (
    <I18nContext.Provider value={{ lang, setLang, t }}>
      {children}
    </I18nContext.Provider>
  );
};

export const useI18n = () => {
  const ctx = useContext(I18nContext);
  if (!ctx) throw new Error("useI18n must be used inside I18nProvider");
  return ctx;
};
````

## File: firebase.json
````json
{
  "hosting": {
    "site": "assistant-ia-v4",
    "public": "out",
    "ignore": [
      "firebase.json",
      "**/.*",
      "**/node_modules/**"
    ],
    "rewrites": [
      { "source": "/api/recaptchaVerify", "function": "recaptchaVerify" },

      { "source": "/api/interview", "function": "interview" },
      { "source": "/api/extractProfile", "function": "extractProfile" },

      { "source": "/api/generateLetterAndPitch", "function": "generateLetterAndPitch" },
      { "source": "/api/generateInterviewQA", "function": "generateInterviewQA" },
      { "source": "/api/generateCvPdf", "function": "generateCvPdf" },
      { "source": "/api/generateCvLmZip", "function": "generateCvLmZip" },
      { "source": "/api/generateLetterPdf", "function": "generateLetterPdf" },

      { "source": "/api/jobs", "function": "jobs" },

      { "source": "/api/polar/checkout", "function": "polarCheckout" },
      { "source": "/api/polar/webhook", "function": "polarWebhook" },

      { "source": "**", "destination": "/index.html" }
    ],
    "cleanUrls": true,
    "trailingSlash": false
  },
  "firestore": {
    "rules": "firestore.rules",
    "indexes": "firestore.indexes.json"
  },
  "functions": {
    "source": "functions"
  }
}
````

## File: functions/package.json
````json
{
  "name": "assistant-candidatures-functions",
  "main": "index.js",
  "engines": {
    "node": "20"
  },
  "dependencies": {
    "@google-cloud/recaptcha-enterprise": "^6.3.1",
    "@google/genai": "^1.30.0",
    "@polar-sh/sdk": "^0.41.5",
    "busboy": "^1.6.0",
    "cors": "^2.8.5",
    "firebase-admin": "^12.7.0",
    "firebase-functions": "^5.1.1",
    "jszip": "^3.10.1",
    "node-fetch": "^3.3.2",
    "nodemailer": "^7.0.10",
    "pdf-lib": "^1.17.1",
    "pdf-parse": "^2.4.5",
    "pdfjs-dist": "^5.4.394",
    "pdfmake": "^0.2.21"
  }
}
````

## File: functions/recaptcha-interview.js
````javascript
"use strict";

const functions = require("firebase-functions");
const admin = require("firebase-admin");
const { RecaptchaEnterpriseServiceClient } = require("@google-cloud/recaptcha-enterprise");

// Init Admin
if (!admin.apps.length) admin.initializeApp();

const recaptchaClient = new RecaptchaEnterpriseServiceClient();

/* ============================
   CORS (Hosting + localhost)
   ============================ */
function setCors(req, res) {
  const origin = req.headers.origin || "";
  const allowed = [
    "http://localhost:3000",
    "http://127.0.0.1:3000",
    "https://assistant-ia-v4.web.app",
    "https://assistant-ia-v4.firebaseapp.com",
  ];

  if (allowed.includes(origin)) {
    res.set("Access-Control-Allow-Origin", origin);
  }

  res.set("Vary", "Origin");
  res.set("Access-Control-Allow-Methods", "POST, OPTIONS");
  // ✅ ajoute X-Recaptcha-Token au cas où
  res.set("Access-Control-Allow-Headers", "Content-Type, Authorization, X-Recaptcha-Token");
}

/* ============================
   reCAPTCHA config
   ============================ */
function getRecaptchaConfig() {
  const cfg = (functions.config && functions.config() && functions.config().recaptcha) || {};
  const projectId = cfg.project_id || process.env.RECAPTCHA_PROJECT_ID || "";
  const siteKey = cfg.site_key || process.env.RECAPTCHA_SITE_KEY || "";
  const thresholdRaw = cfg.threshold || process.env.RECAPTCHA_THRESHOLD || "0.5";

  const threshold = Number(thresholdRaw);
  return {
    projectId,
    siteKey,
    threshold: Number.isFinite(threshold) ? threshold : 0.5,
  };
}

function getClientIp(req) {
  const xf = req.headers["x-forwarded-for"];
  if (typeof xf === "string" && xf.trim()) return xf.split(",")[0].trim();
  return (
    req.ip ||
    (req.connection && req.connection.remoteAddress) ||
    (req.socket && req.socket.remoteAddress) ||
    ""
  );
}

// ✅ IMPORTANT : on ne lower-case plus ici.
// On garde l’action telle qu’envoyée, et on compare en lowercase plus bas.
function normalizeAction(action) {
  return String(action || "").trim();
}

/**
 * Vérifie un token reCAPTCHA Enterprise
 */
async function verifyRecaptchaToken({ token, expectedAction, req }) {
  const { projectId, siteKey, threshold } = getRecaptchaConfig();

  // Si pas configuré, on ne bloque pas (mais on log)
  if (!projectId || !siteKey) {
    console.warn("[recaptcha] NOT CONFIGURED -> bypass (projectId/siteKey missing)");
    return { ok: true, bypass: true, score: null, threshold };
  }

  if (!token) return { ok: false, reason: "missing_token" };

  const userIp = getClientIp(req);
  const userAgent = String(req.headers["user-agent"] || "");

  const parent = `projects/${projectId}`;

  const [assessment] = await recaptchaClient.createAssessment({
    parent,
    assessment: {
      event: {
        token,
        siteKey,
        // ✅ on n’envoie plus expectedAction à Google (évite mismatch sur casse iOS)
        // expectedAction: expectedAction || undefined,
        userAgent: userAgent || undefined,
        userIpAddress: userIp || undefined,
      },
    },
  });

  const tokenProps = assessment && assessment.tokenProperties;
  if (!tokenProps || tokenProps.valid !== true) {
    return {
      ok: false,
      reason: "invalid_token",
      invalidReason: tokenProps ? tokenProps.invalidReason : null,
    };
  }

  // ✅ Action check case-insensitive
  // reCAPTCHA Enterprise est souvent case-sensitive côté token/action.
  // On compare en lowercase pour éviter les refus "Login" vs "login".
  const got = String(tokenProps.action || "").trim().toLowerCase();
  const exp = String(expectedAction || "").trim().toLowerCase();

  if (exp && got && got !== exp) {
    return { ok: false, reason: "action_mismatch", expected: exp, got };
  }

  const score =
    assessment &&
    assessment.riskAnalysis &&
    typeof assessment.riskAnalysis.score === "number"
      ? assessment.riskAnalysis.score
      : null;

  if (typeof score === "number" && score < threshold) {
    return { ok: false, reason: "low_score", score, threshold };
  }

  return { ok: true, score, threshold };
}

/* ============================
   1) Endpoint public: /recaptchaVerify
   ============================ */
exports.recaptchaVerify = functions
  .region("europe-west1")
  .https.onRequest(async (req, res) => {
    setCors(req, res);
    if (req.method === "OPTIONS") return res.status(204).send("");

    if (req.method !== "POST") {
      return res.status(405).json({ ok: false, reason: "method_not_allowed" });
    }
    if (!req.is("application/json")) {
      return res.status(400).json({ ok: false, reason: "invalid_content_type" });
    }

    try {
      const { token, action } = req.body || {};
      const expectedAction = normalizeAction(action);

      if (!token || !expectedAction) {
        return res.status(400).json({ ok: false, reason: "missing_token_or_action" });
      }

      const r = await verifyRecaptchaToken({ token, expectedAction, req });

      if (!r.ok) {
        return res.status(401).json({ ok: false, reason: r.reason, details: r });
      }

      return res.status(200).json({ ok: true, score: r.score ?? null });
    } catch (e) {
      console.error("recaptchaVerify error:", e);
      return res.status(500).json({ ok: false, reason: "server_error" });
    }
  });

/* ============================
   2) Cloud Function: interview (protégée par reCAPTCHA)
   ============================ */
exports.interview = functions
  .region("europe-west1")
  .https.onRequest(async (req, res) => {
    setCors(req, res);
    if (req.method === "OPTIONS") return res.status(204).send("");

    if (req.method !== "POST") {
      return res.status(405).json({ error: "method_not_allowed" });
    }
    if (!req.is("application/json")) {
      return res.status(400).json({ error: "invalid_content_type" });
    }

    try {
      const body = req.body || {};

      const token =
        body.recaptchaToken ||
        body.token ||
        (body.recaptcha && body.recaptcha.token) ||
        null;

      // ✅ On garde l’action telle qu’envoyée, et la vérif est case-insensitive dans verifyRecaptchaToken
      const expectedAction = normalizeAction(body.recaptchaAction || body.actionName || "interview");

      if (!token) {
        return res.status(403).json({
          error: "reCAPTCHA failed",
          details: "token_missing_or_invalid",
          expectedAction,
        });
      }

      const r = await verifyRecaptchaToken({ token, expectedAction, req });
      if (!r.ok) {
        return res.status(403).json({
          error: "reCAPTCHA failed",
          details: r.reason,
          score: r.score ?? null,
          expectedAction,
          extra: r,
        });
      }

      return res.status(200).json({ ok: true, message: "interview OK", score: r.score ?? null });
    } catch (e) {
      console.error("interview error:", e);
      return res.status(500).json({ error: "internal_error" });
    }
  });
````

## File: lib/firebase.ts
````typescript
// lib/firebase.ts
"use client";

import { initializeApp, getApps, getApp } from "firebase/app";
import { getAuth, GoogleAuthProvider } from "firebase/auth";
import { getFirestore } from "firebase/firestore";
import { getFunctions } from "firebase/functions";

// Firebase config (publique)
const firebaseConfig = {
  apiKey: "AIzaSyCNb2cU0yhUeBGOk-8IK3TGNbjL6wSYMRs",
  authDomain: "assistant-ia-v4.firebaseapp.com",
  projectId: "assistant-ia-v4",
  storageBucket: "assistant-ia-v4.firebasestorage.app",
  messagingSenderId: "500826253198",
  appId: "1:500826253198:web:4bc5bd2402d7dd286326df",
  measurementId: "G-61HCNNZBTN",
};

export const app = getApps().length ? getApp() : initializeApp(firebaseConfig);

export const auth = getAuth(app);
export const db = getFirestore(app);

// Functions dans la même région que tes Cloud Functions
export const functions = getFunctions(app, "europe-west1");

// Provider Google (pour popup)
export const googleProvider = new GoogleAuthProvider();
googleProvider.setCustomParameters({ prompt: "select_account" });
````

## File: lib/firestore.ts
````typescript
// src/lib/firebase.ts
import { initializeApp, getApps, getApp } from "firebase/app";
import { getAuth } from "firebase/auth";
import { initializeFirestore } from "firebase/firestore";

const firebaseConfig = {
  apiKey: process.env.NEXT_PUBLIC_FIREBASE_API_KEY!,
  authDomain: process.env.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN!,
  projectId: process.env.NEXT_PUBLIC_FIREBASE_PROJECT_ID!,
  storageBucket: process.env.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET!,
  messagingSenderId: process.env.NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID!,
  appId: process.env.NEXT_PUBLIC_FIREBASE_APP_ID!,
};

export const app = getApps().length ? getApp() : initializeApp(firebaseConfig);

export const auth = getAuth(app);

// ✅ IMPORTANT iOS/mobile: force long-polling (corrige Listen/channel sur Safari / réseaux stricts)
export const db = initializeFirestore(app, {
  experimentalForceLongPolling: true,
  // si tu as encore des soucis sur certains mobiles, tu peux aussi activer ça :
  // useFetchStreams: false,
});
````

## File: lib/pdf/generateCvLm.ts
````typescript
// src/lib/pdf/generateCvLm.ts
import { makePdfColors } from "./colors";
import { fitOnePage } from "./fitOnePage";
import { mergePdfBlobs } from "./mergePdfs";
import { downloadBlob } from "./pdfmakeClient";
import { buildCvAtsPdf, type CvDocModel } from "./templates/cvAts";
import { buildLmStyledPdf, buildLmFallbackPdf, type LmModel } from "./templates/letter";

export async function generateAndDownloadCvLmPdf(params: {
  brandHex: string;
  cv: CvDocModel;
  cvLang: "fr" | "en";
  // LM: soit modèle structuré, soit texte brut
  lm?: LmModel;
  lmTextFallback?: string;
  filename?: string;
}) {
  const colors = makePdfColors(params.brandHex);

  // 1) CV -> fit 1 page
  const cvFit = await fitOnePage((scale) =>
    buildCvAtsPdf(params.cv, params.cvLang, colors, "auto", scale)
  );

  // 2) LM -> fit 1 page
  const lmFit = await fitOnePage(
    (scale) => {
      if (params.lm) return buildLmStyledPdf(params.lm, colors, scale);
      return buildLmFallbackPdf(params.lmTextFallback || "", colors, scale);
    },
    { min: 0.85, max: 1.6, iterations: 6, initial: 1.0 }
  );

  // 3) fusion (2 pages)
  const merged = await mergePdfBlobs([cvFit.blob, lmFit.blob]);

  downloadBlob(merged, params.filename || `CV_LM_${new Date().toISOString().slice(0, 10)}.pdf`);
}
````

## File: lib/pdf/pdfmakeClient.ts
````typescript
"use client";

import pdfMakeMod from "pdfmake/build/pdfmake";
import pdfFontsMod from "pdfmake/build/vfs_fonts";

let cached: any | null = null;

function buildVfsFromModule(mod: any) {
  if (!mod) return null;

  const classic =
    mod?.pdfMake?.vfs ??
    mod?.default?.pdfMake?.vfs ??
    mod?.default?.vfs ??
    mod?.vfs;

  if (classic && typeof classic === "object") return classic;

  const candidate = typeof mod === "object" ? mod : null;
  if (!candidate) return null;

  const vfs: Record<string, string> = {};

  for (const [k, v] of Object.entries(candidate)) {
    if (k === "default") continue;
    if (!k.toLowerCase().endsWith(".ttf")) continue;
    if (typeof v !== "string") continue;
    vfs[k] = v;
  }

  const def = candidate?.default;
  if (def && typeof def === "object") {
    for (const [k, v] of Object.entries(def)) {
      if (!k.toLowerCase().endsWith(".ttf")) continue;
      if (typeof v !== "string") continue;
      vfs[k] = v;
    }
  }

  return Object.keys(vfs).length ? vfs : null;
}

export async function getPdfMake() {
  if (cached) return cached;

  const pdfMake = (pdfMakeMod as any).default ?? (pdfMakeMod as any);
  const vfs = buildVfsFromModule(pdfFontsMod);

  if (!vfs) {
    console.error("vfs_fonts module keys:", Object.keys((pdfFontsMod as any) || {}));
    console.error("vfs_fonts.default keys:", Object.keys((pdfFontsMod as any)?.default || {}));
    throw new Error("pdfmake vfs_fonts introuvable (vfs).");
  }

  // injecte vfs une seule fois
  if (!pdfMake.vfs) pdfMake.vfs = vfs;

  pdfMake.fonts = {
    Roboto: {
      normal: "Roboto-Regular.ttf",
      bold: "Roboto-Medium.ttf",
      italics: "Roboto-Italic.ttf",
      bolditalics: "Roboto-MediumItalic.ttf",
    },
  };

  cached = pdfMake;
  return pdfMake;
}

export async function pdfMakeToBlob(docDef: any): Promise<Blob> {
  const pdfMake = await getPdfMake();
  return new Promise((resolve, reject) => {
    try {
      pdfMake.createPdf(docDef).getBlob((blob: Blob) => resolve(blob));
    } catch (e) {
      reject(e);
    }
  });
}

export function downloadBlob(blob: Blob, filename: string) {
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(() => URL.revokeObjectURL(url), 2500);
}
````

## File: lib/pdf/templates/letter.ts
````typescript
// lib/pdf/templates/letter.ts
import type { PdfColors } from "../colors";
export type { PdfColors } from "../colors";

import type { CvTemplateId } from "./cvTemplates"; // ✅ pour matcher thème CV

export type LmModel = {
  lang: "fr" | "en";
  name: string;
  contactLines: string[];
  service: string;
  companyName: string;
  companyAddr?: string;
  city: string;
  dateStr: string;
  subject: string;
  salutation: string;
  body: string; // corps uniquement
  closing: string;
  signature: string;
};

function splitParas(text: string) {
  return (text || "")
    .replace(/\n{3,}/g, "\n\n")
    .split(/\n\s*\n/)
    .map((p) => p.trim())
    .filter(Boolean);
}

const DEFAULT_COLORS: PdfColors = {
  brand: "#2563eb",
  brandDark: "#1e40af",
  ink: "#0f172a",
  muted: "#475569",
  border: "#e2e8f0",
  bgSoft: "#f1f5f9",
  hair: "#cbd5e1",
};

function safeText(v: any) {
  return String(v ?? "").replace(/\u00A0/g, " ").trim();
}

function pickColor(colors: PdfColors, key: keyof PdfColors, fallback: string) {
  const v = colors?.[key];
  return typeof v === "string" && v.trim() ? v.trim() : fallback;
}

function hexToRgb(hex: string) {
  const h = hex.replace("#", "").trim();
  if (h.length === 3) {
    const r = parseInt(h[0] + h[0], 16);
    const g = parseInt(h[1] + h[1], 16);
    const b = parseInt(h[2] + h[2], 16);
    return { r, g, b };
  }
  return {
    r: parseInt(h.slice(0, 2), 16),
    g: parseInt(h.slice(2, 4), 16),
    b: parseInt(h.slice(4, 6), 16),
  };
}
function rgbToHex(r: number, g: number, b: number) {
  const to = (x: number) =>
    Math.max(0, Math.min(255, Math.round(x)))
      .toString(16)
      .padStart(2, "0");
  return `#${to(r)}${to(g)}${to(b)}`;
}
function mixHex(a: string, b: string, t: number) {
  const A = hexToRgb(a);
  const B = hexToRgb(b);
  return rgbToHex(A.r + (B.r - A.r) * t, A.g + (B.g - A.g) * t, A.b + (B.b - A.b) * t);
}

function themeUsesHeaderBand(theme: CvTemplateId) {
  return theme === "modern" || theme === "pro_max" || theme === "tech";
}

function themeHeaderBg(theme: CvTemplateId, brand: string) {
  if (theme === "tech") return "#0b1220";
  if (theme === "pro_max") return brand; // on fera dégradé via background
  if (theme === "modern") return brand;
  return brand;
}

function themeBackground(theme: CvTemplateId, brand: string, pageSize: any, scale: number) {
  const w = pageSize?.width ?? 595;
  const h = pageSize?.height ?? 842;

  if (theme === "pro_max") {
    const brand2 = mixHex(brand, "#ffffff", 0.35);
    const bands = Array.from({ length: 18 }).map((_, i) => ({
      type: "rect",
      x: (w / 18) * i,
      y: 0,
      w: w / 18 + 1,
      h: 140 * scale,
      color: mixHex(brand, brand2, i / 17),
      opacity: 0.96,
    }));

    const dots = Array.from({ length: 180 }).map((_, i) => {
      const cols = 18;
      const x = 18 + (i % cols) * 30;
      const y = 16 + Math.floor(i / cols) * 14;
      return { type: "ellipse", x, y, r1: 1.4, r2: 1.4, color: "#ffffff", opacity: 0.35 };
    });

    return [
      { canvas: bands },
      { canvas: dots },
      { canvas: [{ type: "rect", x: 0, y: h - 10, w, h: 10, color: brand }] },
    ];
  }

  if (theme === "modern") {
    const headerH = 130 * scale;
    const dots = Array.from({ length: 96 }).map((_, i) => {
      const cols = 12;
      const x = w - 36 - (i % cols) * 18;
      const y = 18 + Math.floor(i / cols) * 14;
      return { type: "ellipse", x, y, r1: 1.4, r2: 1.4, color: "#ffffff", opacity: 0.25 };
    });

    return [
      { canvas: [{ type: "rect", x: 0, y: 0, w, h: headerH, color: brand }] },
      { canvas: dots },
      { canvas: [{ type: "rect", x: 0, y: h - 10, w, h: 10, color: brand }] },
    ];
  }

  if (theme === "tech") {
    return [
      { canvas: [{ type: "rect", x: 0, y: 0, w, h: 95 * scale, color: "#0b1220" }] },
      { canvas: [{ type: "rect", x: 0, y: 95 * scale, w, h: 4 * scale, color: brand }] },
    ];
  }

  if (theme === "minimalist" || theme === "elegant") {
    return [{ canvas: [{ type: "rect", x: 0, y: 0, w, h: 6 * scale, color: brand }] }];
  }

  // ats / classic / creative : sobre
  return [];
}

/**
 * ✅ LM stylée avec thème (optionnel) — compatible avec tes appels existants
 * buildLmStyledPdf(lm, colors, scale)
 * buildLmStyledPdf(lm, colors, scale, cvTemplate)
 */
export function buildLmStyledPdf(
  lm: LmModel,
  colors: PdfColors,
  scale = 1,
  theme: CvTemplateId = "ats"
) {
  const bodyParas = splitParas(lm.body);

  const brandColor = pickColor(colors, "brand", DEFAULT_COLORS.brand);
  const mutedColor = pickColor(colors, "muted", DEFAULT_COLORS.muted);
  const borderColor = pickColor(colors, "border", DEFAULT_COLORS.border);
  const hairColor = pickColor(colors, "hair", DEFAULT_COLORS.hair);
  const inkColor = pickColor(colors, "ink", DEFAULT_COLORS.ink);

  const baseFs = 10.5 * scale;
  const nameFs = 12 * scale;

  const dateLine =
    lm.lang === "en"
      ? `At ${safeText(lm.city)}, ${safeText(lm.dateStr)}`
      : `À ${safeText(lm.city)}, le ${safeText(lm.dateStr)}`;

  const rightStack: any[] = [
    { text: safeText(lm.service), color: mutedColor },
    { text: safeText(lm.companyName), bold: true, color: mutedColor },
    ...(lm.companyAddr ? safeText(lm.companyAddr).split(/\n+/).map((l) => ({ text: l })) : []),
  ];

  const leftMargin = 40 * scale;
  const rightMargin = 40 * scale;
  const bottomMargin = 36 * scale;
  const topMargin = themeUsesHeaderBand(theme) ? 110 * scale : 36 * scale;

  const pageW = 595;
  const lineW = pageW - leftMargin - rightMargin;

  const headerOnBand = themeUsesHeaderBand(theme);
  const headerNameColor = headerOnBand ? "#ffffff" : mutedColor;
  const headerMetaColor = headerOnBand ? "#ffffff" : inkColor;
  const headerMetaOpacity = headerOnBand ? 0.92 : 1;

  const brandBar = headerOnBand
    ? null
    : {
        canvas: [{ type: "line", x1: 0, y1: 0, x2: lineW, y2: 0, lineWidth: 3 * scale, lineColor: brandColor }],
        margin: [0, 0, 0, 10 * scale],
      };

  const hair = {
    canvas: [
      { type: "line", x1: 0, y1: 0, x2: lineW, y2: 0, lineWidth: 1, lineColor: hairColor },
    ],
    margin: [0, 6 * scale, 0, 10 * scale],
  };

  const headerBlock = {
    columns: [
      {
        width: "*",
        stack: [
          { text: safeText(lm.name), bold: true, fontSize: nameFs, color: headerNameColor },
          ...(lm.contactLines || []).map((t) => ({
            text: safeText(t),
            color: headerMetaColor,
            opacity: headerMetaOpacity,
            fontSize: 9.6 * scale,
          })),
        ],
      },
      {
        width: "auto",
        alignment: "right",
        stack: rightStack.map((x) => ({
          ...x,
          color: headerOnBand ? "#ffffff" : x.color,
          opacity: headerMetaOpacity,
          fontSize: 9.6 * scale,
        })),
        margin: [0, 28 * scale, 0, 0],
      },
    ],
    columnGap: 15 * scale,
    margin: [0, headerOnBand ? -78 * scale : 0, 0, 0],
  };

  return {
    pageSize: "A4",
    pageMargins: [leftMargin, topMargin, rightMargin, bottomMargin],
    background: (currentPage: number, pageSize: any) => {
      if (currentPage !== 1) return null;
      return themeBackground(theme, themeHeaderBg(theme, brandColor), pageSize, scale);
    },
    defaultStyle: {
      font: "Roboto",
      fontSize: baseFs,
      lineHeight: 1.24,
      color: inkColor,
    },
    content: [
      ...(brandBar ? [brandBar] : []),

      headerBlock,

      headerOnBand
        ? {
            canvas: [
              {
                type: "line",
                x1: 0,
                y1: 0,
                x2: lineW,
                y2: 0,
                lineWidth: 1,
                lineColor: mixHex(borderColor, "#ffffff", 0.25),
              },
            ],
            margin: [0, 10 * scale, 0, 12 * scale],
          }
        : hair,

      { text: dateLine, margin: [0, 0, 0, 8 * scale], color: mutedColor },
      { text: safeText(lm.subject), bold: true, color: brandColor, margin: [0, 0, 0, 10 * scale] },
      { text: safeText(lm.salutation), margin: [0, 0, 0, 8 * scale] },

      ...bodyParas.map((p) => ({ text: p, margin: [0, 0, 0, 6 * scale] })),

      { text: safeText(lm.closing), margin: [0, 12 * scale, 0, 2 * scale], alignment: "right" },
      { text: safeText(lm.signature), bold: true, alignment: "right" },
    ],
  };
}

/**
 * ✅ Fallback qui accepte:
 * - un LmModel (structuré)
 * - OU un string (texte brut)
 *
 * + optionnel: theme pour matcher CV
 */
export function buildLmFallbackPdf(text: string, colors: PdfColors, scale?: number, theme?: CvTemplateId): any;
export function buildLmFallbackPdf(lm: LmModel, colors: PdfColors, scale?: number, theme?: CvTemplateId): any;
export function buildLmFallbackPdf(text: string, scale?: number, theme?: CvTemplateId): any;
export function buildLmFallbackPdf(lm: LmModel, scale?: number, theme?: CvTemplateId): any;
export function buildLmFallbackPdf(
  first: string | LmModel,
  second?: PdfColors | number,
  third?: number | CvTemplateId,
  fourth?: CvTemplateId
) {
  const colors: PdfColors = typeof second === "object" && second ? second : DEFAULT_COLORS;

  const scale = typeof second === "number" ? second : typeof third === "number" ? third : 1;

  const theme: CvTemplateId =
    (typeof third === "string" ? third : typeof fourth === "string" ? fourth : "ats") as CvTemplateId;

  // Si on a un modèle structuré -> rendu exact (thémé)
  if (typeof first === "object" && first) {
    return buildLmStyledPdf(first, colors, scale, theme);
  }

  // Sinon texte brut (string) — fallback simple mais avec background du thème
  const rawText = String(first || "");
  const paras = splitParas(rawText);

  const brandColor = pickColor(colors, "brand", DEFAULT_COLORS.brand);
  const hairColor = pickColor(colors, "hair", DEFAULT_COLORS.hair);
  const inkColor = pickColor(colors, "ink", DEFAULT_COLORS.ink);

  const leftMargin = 40 * scale;
  const rightMargin = 40 * scale;
  const bottomMargin = 36 * scale;
  const topMargin = themeUsesHeaderBand(theme) ? 90 * scale : 36 * scale;

  const pageW = 595;
  const lineW = pageW - leftMargin - rightMargin;

  const baseFs = 10.5 * scale;

  return {
    pageSize: "A4",
    pageMargins: [leftMargin, topMargin, rightMargin, bottomMargin],
    background: (currentPage: number, pageSize: any) => {
      if (currentPage !== 1) return null;
      return themeBackground(theme, themeHeaderBg(theme, brandColor), pageSize, scale);
    },
    defaultStyle: {
      font: "Roboto",
      fontSize: baseFs,
      lineHeight: 1.26,
      color: inkColor,
    },
    content: [
      ...(themeUsesHeaderBand(theme)
        ? []
        : [
            {
              canvas: [
                { type: "line", x1: 0, y1: 0, x2: lineW, y2: 0, lineWidth: 3 * scale, lineColor: brandColor },
              ],
              margin: [0, 0, 0, 10 * scale],
            },
          ]),

      {
        canvas: [{ type: "line", x1: 0, y1: 0, x2: lineW, y2: 0, lineWidth: 1, lineColor: hairColor }],
        margin: [0, 0, 0, 12 * scale],
      },

      ...(paras.length ? paras : [""]).map((p) => ({ text: p, margin: [0, 0, 0, 7 * scale] })),
    ],
  };
}
````

## File: app/layout.tsx
````typescript
// app/layout.tsx
import "./globals.css";
import type { Metadata, Viewport } from "next";
import Script from "next/script";

import { AuthProvider } from "@/context/AuthContext";
import ActivityTracker from "@/components/ActivityTracker";

import { ThemeProvider } from "@/context/ThemeContext";
import I18nClientProvider from "@/components/I18nClientProvider";
import { Starfield } from "@/components/ui/Starfield";

export const metadata: Metadata = {
  title: "Assistant Candidatures IA",
  description: "Tableau de bord CV / LM / candidatures",
};

export const viewport: Viewport = {
  width: "device-width",
  initialScale: 1,
  maximumScale: 1,
  viewportFit: "cover",
};

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  const siteKey = process.env.NEXT_PUBLIC_RECAPTCHA_SITE_KEY || "";
  const useEnterprise =
    (process.env.NEXT_PUBLIC_RECAPTCHA_ENTERPRISE || "")
      .toLowerCase()
      .trim() === "true";

  const recaptchaSrc = siteKey
    ? useEnterprise
      ? `https://www.google.com/recaptcha/enterprise.js?render=${encodeURIComponent(
          siteKey
        )}`
      : `https://www.google.com/recaptcha/api.js?render=${encodeURIComponent(
          siteKey
        )}`
    : "";

  return (
    <html lang="fr">
      <head>
        <link rel="manifest" href="/manifest.webmanifest" />
        <meta name="theme-color" content="#020617" />
        <meta name="mobile-web-app-capable" content="yes" />
        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta
          name="apple-mobile-web-app-status-bar-style"
          content="black-translucent"
        />
      </head>

      <body className="min-h-screen bg-[var(--bg)] text-[var(--ink)] overflow-x-hidden antialiased">
        {/* reCAPTCHA v3 / enterprise */}
        {siteKey ? (
          <Script
            src={recaptchaSrc}
            strategy="afterInteractive"
            data-recaptcha={useEnterprise ? "enterprise" : "v3"}
          />
        ) : null}

        <ThemeProvider>
          {/* ✅ i18next provider (détection navigateur + cache) */}
          <I18nClientProvider>
            {/* Fond étoilé derrière tout */}
            <Starfield />

            <AuthProvider>
              <ActivityTracker />
              <div className="app-shell min-h-screen flex flex-col">
                {children}
              </div>
            </AuthProvider>
          </I18nClientProvider>
        </ThemeProvider>
      </body>
    </html>
  );
}
````

## File: lib/pdf/templates/cvTemplates.ts
````typescript
// src/lib/pdf/templates/cvTemplates.ts
import { buildCvAtsPdf, type CvDocModel } from "@/lib/pdf/templates/cvAts";

export type Lang = "fr" | "en";

export type CvTemplateId =
  | "ats"
  | "classic"
  | "modern"
  | "minimalist"
  | "creative"
  | "elegant"
  | "tech"
  | "pro_max"
  // ✅ nouveaux
  | "executive"
  | "startup"
  | "two_column"
  | "elegant_color"
  | "academic"
  | "sales";

export type PdfColorsLike = Record<string, string | undefined> & {
  brand?: string;
  ink?: string;
  muted?: string;
  line?: string;
  bg?: string;
  bgSoft?: string;
  white?: string;
};

export type CvTemplateMeta = {
  id: CvTemplateId;
  label: string;
  description: string;
  previewSrc: string;
  badge?: string;
};

// ----------------------------------------------------
// Liste des templates disponibles (UI)
// ----------------------------------------------------

export const CV_TEMPLATES: CvTemplateMeta[] = [
  {
    id: "ats",
    label: "ATS (Standard)",
    description: "Template 1 colonne très lisible, optimisé pour les ATS.",
    previewSrc: "/cv-templates/cv-template-ats.png",
    badge: "Recommandé",
  },
  {
    id: "classic",
    label: "Classic (Sidebar)",
    description: "Colonne latérale, structure pro et lisible.",
    previewSrc: "/cv-templates/cv-template-classic.png",
  },
  {
    id: "modern",
    label: "Modern (Design)",
    description: "Header moderne, blocs aérés, idéal profils tech/produit.",
    previewSrc: "/cv-templates/cv-template-modern.png",
  },
  {
    id: "minimalist",
    label: "Minimalist",
    description: "CV ultra épuré, typographie clean, parfait pour cabinets.",
    previewSrc: "/cv-templates/cv-template-minimalist.png",
  },
  {
    id: "creative",
    label: "Creative",
    description: "Mise en page en cartes / blocs, look plus dynamique.",
    previewSrc: "/cv-templates/cv-template-creative.png",
  },
  {
    id: "elegant",
    label: "Elegant",
    description: "Style plus premium, hiérarchie douce, très corporate.",
    previewSrc: "/cv-templates/cv-template-elegant.png",
  },
  {
    id: "tech",
    label: "Tech (Dark)",
    description: "Palette sombre, vibe engineering / cybersécurité.",
    previewSrc: "/cv-templates/cv-template-tech.png",
  },
  {
    id: "pro_max",
    label: "Pro Max",
    description: "Version premium inspirée des CV design (header fort, cartes).",
    previewSrc: "/cv-templates/cv-template-pro-max.png",
    badge: "Nouveau",
  },

  // ✅ NOUVEAUX TEMPLATES
  {
    id: "executive",
    label: "Executive",
    description: "Sobriété premium, sidebar douce, parfait corporate / direction.",
    previewSrc: "/cv-templates/cv-template-executive.png",
    badge: "Nouveau",
  },
  {
    id: "startup",
    label: "Startup",
    description: "Header impactant, sections dynamiques, look moderne startup.",
    previewSrc: "/cv-templates/cv-template-startup.png",
    badge: "Nouveau",
  },
  {
    id: "two_column",
    label: "Two-Column",
    description: "Équilibré en 2 colonnes, très lisible, polyvalent.",
    previewSrc: "/cv-templates/cv-template-two-column.png",
  },
  {
    id: "elegant_color",
    label: "Elegant Color",
    description: "Version élégante avec touches de couleur plus visibles.",
    previewSrc: "/cv-templates/cv-template-elegant-color.png",
  },
  {
    id: "academic",
    label: "Academic",
    description: "Recherche/enseignement : publications, projets, sections académiques.",
    previewSrc: "/cv-templates/cv-template-academic.png",
  },
  {
    id: "sales",
    label: "Sales (KPIs)",
    description: "Orienté business : KPIs / résultats mis en avant.",
    previewSrc: "/cv-templates/cv-template-sales.png",
  },
];

// utilisé par l’UI
export function getCvTemplates(): CvTemplateMeta[] {
  return CV_TEMPLATES;
}

// ----------------------------------------------------
// Helpers génériques
// ----------------------------------------------------

function normLang(lang: Lang): Lang {
  return lang === "en" ? "en" : "fr";
}

function clamp(value: number, min: number, max: number): number {
  return Math.min(max, Math.max(min, value));
}

function safeText(v: unknown): string {
  return String(v ?? "")
    .replace(/\u00A0/g, " ")
    .trim();
}

function pick(colors: PdfColorsLike | undefined, key: keyof PdfColorsLike, fallback: string): string {
  if (!colors) return fallback;
  const v = colors[key];
  return typeof v === "string" && v ? v : fallback;
}

function joinDot(list: string[] | undefined, maxChars = 80): string {
  const arr = Array.isArray(list)
    ? list.map((s: string) => safeText(s)).filter(Boolean)
    : [];

  if (!arr.length) return "—";

  const out: string[] = [];
  let used = 0;

  for (const item of arr) {
    const extra = (out.length ? 3 : 0) + item.length; // " • "
    if (out.length && used + extra > maxChars) break;
    out.push(item);
    used += extra;
  }

  return out.join(" • ");
}

function hr(scale: number, color: string, w = 515) {
  return {
    canvas: [
      {
        type: "line",
        x1: 0,
        y1: 0,
        x2: w,
        y2: 0,
        lineWidth: 0.6,
        lineColor: color,
      },
    ],
    margin: [0, 4 * scale, 0, 4 * scale],
  };
}

function sectionTitle(label: string, scale: number, color: string) {
  return {
    text: label,
    fontSize: 10.5 * scale,
    bold: true,
    color,
    margin: [0, 4 * scale, 0, 3 * scale],
  };
}

function sectionTitleAccent(label: string, scale: number, brand: string) {
  return {
    text: label,
    fontSize: 10.5 * scale,
    bold: true,
    color: brand,
    margin: [0, 6 * scale, 0, 3 * scale],
  };
}

function normalizeLines(v: unknown, max = 6): string[] {
  if (Array.isArray(v)) {
    return (v as unknown as string[]).map(safeText).filter(Boolean).slice(0, max);
  }
  const one = safeText(v);
  if (!one) return [];
  return one
    .split("\n")
    .map((l) => l.trim())
    .filter(Boolean)
    .slice(0, max);
}

function collectSkills(model: CvDocModel): string[] {
  const s: any = (model as any).skills || {};
  const keys = ["cloud", "sec", "sys", "auto", "tools", "soft"];
  const out: string[] = [];

  for (const key of keys) {
    const value = s[key];
    if (Array.isArray(value)) {
      for (const item of value as string[]) {
        const txt = safeText(item);
        if (txt) out.push(txt);
      }
    }
  }

  return out;
}

function renderXp(model: CvDocModel, scale: number, ink: string, muted: string) {
  const xpRaw: unknown = (model as any).xp;
  const xpArr: CvDocModel["xp"] = Array.isArray(xpRaw) ? (xpRaw as CvDocModel["xp"]) : [];

  if (!xpArr.length) {
    return [{ text: "—", fontSize: 9 * scale, color: muted }];
  }

  return xpArr.map((x: CvDocModel["xp"][number]) => {
    const titleParts: string[] = [];
    if (x.role) titleParts.push(safeText(x.role));
    if (x.company) titleParts.push(safeText(x.company));
    const title = titleParts.join(" — ") || "—";

    const metaParts: string[] = [];
    if (x.city) metaParts.push(safeText(x.city));
    if (x.dates) metaParts.push(safeText(x.dates));
    const meta = metaParts.join(" • ");

    const bulletsRaw: unknown = x.bullets;
    const bullets: string[] = Array.isArray(bulletsRaw)
      ? (bulletsRaw as string[]).map((b: string) => safeText(b)).filter(Boolean)
      : [];

    const stack: any[] = [
      {
        text: title,
        fontSize: 9.8 * scale,
        bold: true,
        color: ink,
        margin: [0, 0, 0, 1.5 * scale],
      },
    ];

    if (meta) {
      stack.push({
        text: meta,
        fontSize: 9 * scale,
        color: muted,
        margin: [0, 0, 0, 2 * scale],
      });
    }

    if (bullets.length) {
      stack.push({
        ul: bullets,
        fontSize: 9 * scale,
        color: ink,
        margin: [0, 0, 0, 4 * scale],
      });
    }

    return { stack };
  });
}

function renderEducation(model: CvDocModel, scale: number, ink: string, muted: string) {
  const eduRaw: unknown = (model as any).education;
  let eduArr: string[] = [];

  if (Array.isArray(eduRaw)) {
    eduArr = (eduRaw as unknown as string[]).map((v: string) => safeText(v)).filter(Boolean);
  } else {
    const one = safeText(eduRaw);
    if (one) {
      eduArr = one
        .split("\n")
        .map((l: string) => l.trim())
        .filter(Boolean);
    }
  }

  if (!eduArr.length) {
    return [{ text: "—", fontSize: 9 * scale, color: muted }];
  }

  return eduArr.slice(0, 5).map((line: string) => ({
    text: line,
    fontSize: 9 * scale,
    color: ink,
    margin: [0, 0, 0, 4 * scale],
  }));
}

// ----------------------------------------------------
// Base docDefinition
// ----------------------------------------------------

function baseDocDefinition(
  _model: CvDocModel,
  colors: PdfColorsLike,
  scale: number,
  pageMargins: [number, number, number, number]
) {
  const brand = pick(colors, "brand", "#2563eb");
  const ink = pick(colors, "ink", "#111827");
  const muted = pick(colors, "muted", "#6b7280");
  const line = pick(colors, "line", "#e5e7eb");
  const bgSoft = pick(colors, "bgSoft", "#f3f4f6");
  const white = pick(colors, "white", "#ffffff");

  return {
    pageSize: "A4",
    pageMargins,
    defaultStyle: { font: "Roboto", fontSize: 10 * scale, color: ink },
    styles: {
      name: { fontSize: 18 * scale, bold: true, color: ink },
      title: { fontSize: 11 * scale, bold: true, color: brand },
      contact: { fontSize: 9 * scale, color: muted },
      section: { fontSize: 10.5 * scale, bold: true, color: ink },
      small: { fontSize: 9 * scale, color: muted },
    },
    _palette: { brand, ink, muted, line, bgSoft, white },
    content: [] as any[],
  } as any;
}

// ----------------------------------------------------
// Templates existants
// ----------------------------------------------------

function buildClassic(model: CvDocModel, lang: Lang, colors: PdfColorsLike, scale: number) {
  const L = normLang(lang);
  const ink = pick(colors, "ink", "#111827");
  const muted = pick(colors, "muted", "#6b7280");
  const line = pick(colors, "line", "#e5e7eb");

  const doc = baseDocDefinition(model, colors, scale, [34 * scale, 30 * scale, 34 * scale, 26 * scale]);
  const leftWidth = 170 * scale;

  const skills = collectSkills(model);

  (doc.content as any[]).push({
    columns: [
      {
        width: leftWidth,
        stack: [
          { text: safeText(model.name), style: "name" },
          { text: safeText((model as any).title), style: "title", margin: [0, 2 * scale, 0, 0] },
          {
            text: safeText((model as any).contactLine ?? (model as any).contact),
            style: "contact",
            margin: [0, 6 * scale, 0, 8 * scale],
          },
          hr(scale, line),

          sectionTitle(L === "en" ? "Skills" : "Compétences", scale, ink),
          { text: joinDot(skills, 120), fontSize: 9 * scale, color: muted, margin: [0, 2 * scale, 0, 6 * scale] },

          sectionTitle(L === "en" ? "Languages" : "Langues", scale, ink),
          { text: safeText((model as any).langLine), fontSize: 9 * scale, color: muted, margin: [0, 2 * scale, 0, 6 * scale] },

          sectionTitle(L === "en" ? "Interests" : "Centres d’intérêt", scale, ink),
          { text: joinDot((model as any).hobbies as string[] | undefined, 120), fontSize: 9 * scale, color: muted },
        ],
      },
      {
        width: "*",
        stack: [
          sectionTitle(L === "en" ? "Profile" : "Profil", scale, ink),
          {
            text: safeText((model as any).profile),
            fontSize: 9.5 * scale,
            color: ink,
            margin: [0, 2 * scale, 0, 8 * scale],
            alignment: "justify",
          },

          hr(scale, line),

          sectionTitle(L === "en" ? "Experience" : "Expérience professionnelle", scale, ink),
          { stack: renderXp(model, scale, ink, muted) },

          hr(scale, line),

          sectionTitle(L === "en" ? "Education" : "Formation", scale, ink),
          { stack: renderEducation(model, scale, ink, muted) },

          sectionTitle(L === "en" ? "Certifications" : "Certifications", scale, ink),
          { text: safeText((model as any).certs), fontSize: 9 * scale, color: ink, margin: [0, 2 * scale, 0, 0] },
        ],
      },
    ],
    columnGap: 18 * scale,
  });

  return doc;
}

function buildModern(model: CvDocModel, lang: Lang, colors: PdfColorsLike, scale: number) {
  const L = normLang(lang);
  const brand = pick(colors, "brand", "#2563eb");
  const ink = pick(colors, "ink", "#0f172a");
  const muted = pick(colors, "muted", "#6b7280");
  const bgSoft = pick(colors, "bgSoft", "#eff6ff");

  const doc = baseDocDefinition(model, colors, scale, [30 * scale, 28 * scale, 30 * scale, 28 * scale]);
  const skills = collectSkills(model);

  (doc.content as any[]).push(
    {
      table: {
        widths: ["*", "*"],
        body: [
          [
            {
              stack: [
                { text: safeText(model.name), fontSize: 20 * scale, bold: true, color: ink },
                { text: safeText((model as any).title), fontSize: 11 * scale, bold: true, color: brand, margin: [0, 2 * scale, 0, 0] },
              ],
            },
            {
              stack: [
                { text: safeText((model as any).contactLine ?? (model as any).contact), fontSize: 9 * scale, color: muted, alignment: "right" },
                { text: safeText((model as any).langLine), fontSize: 9 * scale, color: muted, alignment: "right", margin: [0, 2 * scale, 0, 0] },
              ],
            },
          ],
        ],
      },
      layout: "noBorders",
      fillColor: bgSoft,
      margin: [-6 * scale, -6 * scale, -6 * scale, 10 * scale],
    },
    {
      columns: [
        {
          width: "*",
          stack: [
            sectionTitle(L === "en" ? "Profile" : "Profil", scale, ink),
            { text: safeText((model as any).profile), fontSize: 9.5 * scale, color: ink, margin: [0, 2 * scale, 0, 6 * scale], alignment: "justify" },

            sectionTitle(L === "en" ? "Experience" : "Expérience", scale, ink),
            { stack: renderXp(model, scale, ink, muted) },
          ],
        },
        {
          width: 180 * scale,
          margin: [16 * scale, 0, 0, 0],
          stack: [
            sectionTitle(L === "en" ? "Key Skills" : "Compétences clés", scale, ink),
            { text: joinDot(skills, 140), fontSize: 9 * scale, color: muted, margin: [0, 2 * scale, 0, 6 * scale] },

            sectionTitle(L === "en" ? "Education" : "Formation", scale, ink),
            { stack: renderEducation(model, scale, ink, muted) },

            sectionTitle(L === "en" ? "Certifications" : "Certifications", scale, ink),
            { text: safeText((model as any).certs), fontSize: 9 * scale, color: muted, margin: [0, 2 * scale, 0, 6 * scale] },

            sectionTitle(L === "en" ? "Interests" : "Centres d’intérêt", scale, ink),
            { text: joinDot((model as any).hobbies as string[] | undefined, 140), fontSize: 9 * scale, color: muted },
          ],
        },
      ],
      columnGap: 18 * scale,
    }
  );

  return doc;
}

function buildMinimalist(model: CvDocModel, lang: Lang, colors: PdfColorsLike, scale: number) {
  const L = normLang(lang);
  const ink = pick(colors, "ink", "#111827");
  const muted = pick(colors, "muted", "#6b7280");
  const line = pick(colors, "line", "#e5e7eb");

  const doc = baseDocDefinition(model, colors, scale, [40 * scale, 32 * scale, 40 * scale, 32 * scale]);
  const skills = collectSkills(model);

  (doc.content as any[]).push(
    { text: safeText(model.name), fontSize: 20 * scale, bold: true, color: ink, margin: [0, 0, 0, 2 * scale] },
    { text: safeText((model as any).title), fontSize: 11 * scale, color: muted, margin: [0, 0, 0, 4 * scale] },
    { text: safeText((model as any).contactLine ?? (model as any).contact), fontSize: 9 * scale, color: muted, margin: [0, 0, 0, 8 * scale] },
    hr(scale, line),
    sectionTitle(L === "en" ? "Profile" : "Profil", scale, ink),
    { text: safeText((model as any).profile), fontSize: 9.5 * scale, color: ink, margin: [0, 2 * scale, 0, 6 * scale], alignment: "justify" },

    sectionTitle(L === "en" ? "Experience" : "Expérience", scale, ink),
    { stack: renderXp(model, scale, ink, muted), margin: [0, 0, 0, 4 * scale] },

    sectionTitle(L === "en" ? "Education" : "Formation", scale, ink),
    { stack: renderEducation(model, scale, ink, muted) },

    sectionTitle(L === "en" ? "Skills" : "Compétences", scale, ink),
    { text: joinDot(skills, 160), fontSize: 9 * scale, color: muted, margin: [0, 2 * scale, 0, 4 * scale] },

    sectionTitle(L === "en" ? "Languages" : "Langues", scale, ink),
    { text: safeText((model as any).langLine), fontSize: 9 * scale, color: muted, margin: [0, 2 * scale, 0, 4 * scale] },

    sectionTitle(L === "en" ? "Interests" : "Centres d’intérêt", scale, ink),
    { text: joinDot((model as any).hobbies as string[] | undefined, 160), fontSize: 9 * scale, color: muted }
  );

  return doc;
}

// les anciens "creative/elegant" réutilisent encore des bases
function buildCreative(model: CvDocModel, lang: Lang, colors: PdfColorsLike, scale: number) {
  return buildModern(model, lang, colors, scale);
}
function buildElegant(model: CvDocModel, lang: Lang, colors: PdfColorsLike, scale: number) {
  return buildClassic(model, lang, colors, scale);
}
function buildTech(model: CvDocModel, lang: Lang, colors: PdfColorsLike, scale: number) {
  const overridden: PdfColorsLike = {
    ...colors,
    brand: colors.brand || "#22c55e",
    ink: colors.ink || "#f9fafb",
    muted: colors.muted || "#94a3b8",
    bgSoft: colors.bgSoft || "#020617",
    line: colors.line || "#1e293b",
  };
  return buildModern(model, lang, overridden, scale);
}
function buildProMax(model: CvDocModel, lang: Lang, colors: PdfColorsLike, scale: number) {
  const overridden: PdfColorsLike = { ...colors, brand: colors.brand || "#0ea5e9" };
  const boostedScale = clamp(scale * 1.02, 0.75, 1.6);
  return buildModern(model, lang, overridden, boostedScale);
}

// ----------------------------------------------------
// ✅ NOUVEAUX TEMPLATES (6)
// ----------------------------------------------------

function buildExecutive(model: CvDocModel, lang: Lang, colors: PdfColorsLike, scale: number) {
  const L = normLang(lang);
  const brand = pick(colors, "brand", "#111827"); // sobre
  const ink = pick(colors, "ink", "#0f172a");
  const muted = pick(colors, "muted", "#64748b");
  const line = pick(colors, "line", "#e5e7eb");
  const bgSoft = pick(colors, "bgSoft", "#f3f4f6");

  const doc = baseDocDefinition(model, colors, scale, [30 * scale, 28 * scale, 30 * scale, 26 * scale]);
  const skills = collectSkills(model);

  const leftW = 175 * scale;

  (doc.content as any[]).push(
    {
      text: safeText(model.name),
      fontSize: 22 * scale,
      bold: true,
      color: ink,
      margin: [0, 0, 0, 2 * scale],
    },
    {
      text: safeText((model as any).title),
      fontSize: 11.5 * scale,
      bold: true,
      color: brand,
      margin: [0, 0, 0, 8 * scale],
    },
    {
      table: {
        widths: [leftW, "*"],
        body: [
          [
            {
              fillColor: bgSoft,
              margin: [12 * scale, 12 * scale, 12 * scale, 12 * scale],
              stack: [
                sectionTitle(L === "en" ? "Contact" : "Contact", scale, ink),
                { text: safeText((model as any).contactLine ?? (model as any).contact), fontSize: 9 * scale, color: muted, margin: [0, 0, 0, 6 * scale] },

                hr(scale, line, leftW - 24 * scale),

                sectionTitle(L === "en" ? "Skills" : "Compétences", scale, ink),
                { text: joinDot(skills, 140), fontSize: 9 * scale, color: muted, margin: [0, 2 * scale, 0, 6 * scale] },

                sectionTitle(L === "en" ? "Languages" : "Langues", scale, ink),
                { text: safeText((model as any).langLine), fontSize: 9 * scale, color: muted, margin: [0, 2 * scale, 0, 6 * scale] },

                sectionTitle(L === "en" ? "Interests" : "Centres d’intérêt", scale, ink),
                { text: joinDot((model as any).hobbies as string[] | undefined, 160), fontSize: 9 * scale, color: muted },
              ],
            },
            {
              margin: [14 * scale, 0, 0, 0],
              stack: [
                sectionTitle(L === "en" ? "Profile" : "Profil", scale, ink),
                { text: safeText((model as any).profile), fontSize: 9.5 * scale, color: ink, margin: [0, 2 * scale, 0, 8 * scale], alignment: "justify" },

                hr(scale, line),

                sectionTitle(L === "en" ? "Experience" : "Expérience", scale, ink),
                { stack: renderXp(model, scale, ink, muted) },

                hr(scale, line),

                sectionTitle(L === "en" ? "Education" : "Formation", scale, ink),
                { stack: renderEducation(model, scale, ink, muted) },

                sectionTitle(L === "en" ? "Certifications" : "Certifications", scale, ink),
                { text: safeText((model as any).certs), fontSize: 9 * scale, color: ink },
              ],
            },
          ],
        ],
      },
      layout: "noBorders",
    }
  );

  return doc;
}

function buildStartup(model: CvDocModel, lang: Lang, colors: PdfColorsLike, scale: number) {
  const L = normLang(lang);
  const brand = pick(colors, "brand", "#f97316"); // orange
  const ink = pick(colors, "ink", "#0f172a");
  const muted = pick(colors, "muted", "#64748b");
  const line = pick(colors, "line", "#e5e7eb");

  const doc = baseDocDefinition(model, colors, scale, [28 * scale, 26 * scale, 28 * scale, 24 * scale]);
  const skills = collectSkills(model);

  (doc.content as any[]).push(
    {
      table: {
        widths: ["*", "*"],
        body: [
          [
            {
              fillColor: brand,
              margin: [14 * scale, 12 * scale, 14 * scale, 12 * scale],
              stack: [
                { text: safeText(model.name), fontSize: 20 * scale, bold: true, color: "#ffffff" },
                { text: safeText((model as any).title), fontSize: 11 * scale, bold: true, color: "#ffffff", margin: [0, 2 * scale, 0, 0] },
              ],
            },
            {
              fillColor: brand,
              margin: [14 * scale, 12 * scale, 14 * scale, 12 * scale],
              stack: [
                { text: safeText((model as any).contactLine ?? (model as any).contact), fontSize: 9 * scale, color: "#ffffff", alignment: "right" },
                { text: safeText((model as any).langLine), fontSize: 9 * scale, color: "#ffffff", alignment: "right", margin: [0, 2 * scale, 0, 0] },
              ],
            },
          ],
        ],
      },
      layout: "noBorders",
      margin: [-6 * scale, -6 * scale, -6 * scale, 10 * scale],
    },
    {
      columns: [
        {
          width: "*",
          stack: [
            sectionTitleAccent(L === "en" ? "Profile" : "Profil", scale, brand),
            { text: safeText((model as any).profile), fontSize: 9.5 * scale, color: ink, margin: [0, 2 * scale, 0, 8 * scale], alignment: "justify" },

            sectionTitleAccent(L === "en" ? "Experience" : "Expérience", scale, brand),
            { stack: renderXp(model, scale, ink, muted) },
          ],
        },
        {
          width: 190 * scale,
          margin: [16 * scale, 0, 0, 0],
          stack: [
            sectionTitleAccent(L === "en" ? "Skills" : "Compétences", scale, brand),
            { text: joinDot(skills, 150), fontSize: 9 * scale, color: muted, margin: [0, 2 * scale, 0, 10 * scale] },

            sectionTitleAccent(L === "en" ? "Education" : "Formation", scale, brand),
            { stack: renderEducation(model, scale, ink, muted) },

            sectionTitleAccent(L === "en" ? "Certifications" : "Certifications", scale, brand),
            { text: safeText((model as any).certs), fontSize: 9 * scale, color: muted, margin: [0, 2 * scale, 0, 0] },
          ],
        },
      ],
    }
  );

  return doc;
}

function buildTwoColumn(model: CvDocModel, lang: Lang, colors: PdfColorsLike, scale: number) {
  const L = normLang(lang);
  const brand = pick(colors, "brand", "#2563eb");
  const ink = pick(colors, "ink", "#0f172a");
  const muted = pick(colors, "muted", "#64748b");
  const line = pick(colors, "line", "#e5e7eb");
  const bgSoft = pick(colors, "bgSoft", "#eff6ff");

  const doc = baseDocDefinition(model, colors, scale, [28 * scale, 26 * scale, 28 * scale, 24 * scale]);
  const skills = collectSkills(model);

  (doc.content as any[]).push(
    {
      table: {
        widths: ["*", "*"],
        body: [
          [
            {
              stack: [
                { text: safeText(model.name), fontSize: 20 * scale, bold: true, color: ink },
                { text: safeText((model as any).title), fontSize: 11 * scale, bold: true, color: brand, margin: [0, 2 * scale, 0, 0] },
              ],
            },
            {
              stack: [
                { text: safeText((model as any).contactLine ?? (model as any).contact), fontSize: 9 * scale, color: muted, alignment: "right" },
                { text: safeText((model as any).langLine), fontSize: 9 * scale, color: muted, alignment: "right", margin: [0, 2 * scale, 0, 0] },
              ],
            },
          ],
        ],
      },
      layout: "noBorders",
      fillColor: bgSoft,
      margin: [-6 * scale, -6 * scale, -6 * scale, 10 * scale],
    },
    {
      columns: [
        {
          width: 210 * scale,
          stack: [
            sectionTitle(L === "en" ? "Profile" : "Profil", scale, ink),
            { text: safeText((model as any).profile), fontSize: 9.5 * scale, color: ink, margin: [0, 2 * scale, 0, 8 * scale], alignment: "justify" },
            hr(scale, line, 210 * scale),

            sectionTitle(L === "en" ? "Skills" : "Compétences", scale, ink),
            { text: joinDot(skills, 160), fontSize: 9 * scale, color: muted, margin: [0, 2 * scale, 0, 8 * scale] },

            sectionTitle(L === "en" ? "Interests" : "Centres d’intérêt", scale, ink),
            { text: joinDot((model as any).hobbies as string[] | undefined, 160), fontSize: 9 * scale, color: muted },
          ],
        },
        {
          width: "*",
          margin: [16 * scale, 0, 0, 0],
          stack: [
            sectionTitle(L === "en" ? "Experience" : "Expérience", scale, ink),
            { stack: renderXp(model, scale, ink, muted) },

            hr(scale, line),

            sectionTitle(L === "en" ? "Education" : "Formation", scale, ink),
            { stack: renderEducation(model, scale, ink, muted) },

            sectionTitle(L === "en" ? "Certifications" : "Certifications", scale, ink),
            { text: safeText((model as any).certs), fontSize: 9 * scale, color: ink },
          ],
        },
      ],
    }
  );

  return doc;
}

function buildElegantColor(model: CvDocModel, lang: Lang, colors: PdfColorsLike, scale: number) {
  const L = normLang(lang);
  const brand = pick(colors, "brand", "#10b981"); // emerald accent
  const ink = pick(colors, "ink", "#0f172a");
  const muted = pick(colors, "muted", "#64748b");
  const line = pick(colors, "line", "#e5e7eb");

  const doc = baseDocDefinition(model, colors, scale, [32 * scale, 28 * scale, 32 * scale, 26 * scale]);
  const skills = collectSkills(model);

  (doc.content as any[]).push(
    {
      columns: [
        {
          width: "*",
          stack: [
            { text: safeText(model.name), fontSize: 22 * scale, bold: true, color: ink },
            { text: safeText((model as any).title), fontSize: 11.5 * scale, bold: true, color: brand, margin: [0, 2 * scale, 0, 4 * scale] },
            { text: safeText((model as any).contactLine ?? (model as any).contact), fontSize: 9 * scale, color: muted },
          ],
        },
        {
          width: 140 * scale,
          stack: [
            { canvas: [{ type: "rect", x: 0, y: 0, w: 140 * scale, h: 6 * scale, color: brand }] },
            { canvas: [{ type: "rect", x: 0, y: 0, w: 90 * scale, h: 6 * scale, color: brand }], margin: [0, 8 * scale, 0, 0] },
          ],
        },
      ],
      margin: [0, 0, 0, 8 * scale],
    },
    hr(scale, line),
    sectionTitleAccent(L === "en" ? "Profile" : "Profil", scale, brand),
    { text: safeText((model as any).profile), fontSize: 9.5 * scale, color: ink, margin: [0, 2 * scale, 0, 8 * scale], alignment: "justify" },

    sectionTitleAccent(L === "en" ? "Experience" : "Expérience", scale, brand),
    { stack: renderXp(model, scale, ink, muted) },

    hr(scale, line),

    {
      columns: [
        {
          width: "*",
          stack: [
            sectionTitleAccent(L === "en" ? "Education" : "Formation", scale, brand),
            { stack: renderEducation(model, scale, ink, muted) },
          ],
        },
        {
          width: 200 * scale,
          margin: [16 * scale, 0, 0, 0],
          stack: [
            sectionTitleAccent(L === "en" ? "Skills" : "Compétences", scale, brand),
            { text: joinDot(skills, 160), fontSize: 9 * scale, color: muted, margin: [0, 2 * scale, 0, 8 * scale] },

            sectionTitleAccent(L === "en" ? "Certifications" : "Certifications", scale, brand),
            { text: safeText((model as any).certs), fontSize: 9 * scale, color: muted },
          ],
        },
      ],
    }
  );

  return doc;
}

function buildAcademic(model: CvDocModel, lang: Lang, colors: PdfColorsLike, scale: number) {
  const L = normLang(lang);
  const brand = pick(colors, "brand", "#0f172a");
  const ink = pick(colors, "ink", "#0f172a");
  const muted = pick(colors, "muted", "#64748b");
  const line = pick(colors, "line", "#e5e7eb");

  const doc = baseDocDefinition(model, colors, scale, [34 * scale, 30 * scale, 34 * scale, 28 * scale]);

  const publications = normalizeLines((model as any).publications ?? (model as any).pubs, 8);
  const projects = normalizeLines((model as any).projects, 6);
  const teaching = normalizeLines((model as any).teaching, 6);

  (doc.content as any[]).push(
    { text: safeText(model.name), fontSize: 22 * scale, bold: true, color: ink, margin: [0, 0, 0, 2 * scale] },
    { text: safeText((model as any).title), fontSize: 11.5 * scale, bold: true, color: brand, margin: [0, 0, 0, 4 * scale] },
    { text: safeText((model as any).contactLine ?? (model as any).contact), fontSize: 9 * scale, color: muted, margin: [0, 0, 0, 8 * scale] },
    hr(scale, line),

    sectionTitle(L === "en" ? "Research Summary" : "Résumé de recherche", scale, ink),
    { text: safeText((model as any).profile), fontSize: 9.5 * scale, color: ink, margin: [0, 2 * scale, 0, 8 * scale], alignment: "justify" },

    sectionTitle(L === "en" ? "Academic Experience" : "Expérience", scale, ink),
    { stack: renderXp(model, scale, ink, muted) },

    sectionTitle(L === "en" ? "Education" : "Formation", scale, ink),
    { stack: renderEducation(model, scale, ink, muted) },

    sectionTitle(L === "en" ? "Projects" : "Projets", scale, ink),
    publications.length || projects.length
      ? { ul: projects.length ? projects : ["—"], fontSize: 9 * scale, color: ink, margin: [0, 0, 0, 6 * scale] }
      : { text: "—", fontSize: 9 * scale, color: muted, margin: [0, 0, 0, 6 * scale] },

    sectionTitle(L === "en" ? "Teaching" : "Enseignement", scale, ink),
    teaching.length
      ? { ul: teaching, fontSize: 9 * scale, color: ink, margin: [0, 0, 0, 6 * scale] }
      : { text: "—", fontSize: 9 * scale, color: muted, margin: [0, 0, 0, 6 * scale] },

    sectionTitle(L === "en" ? "Publications" : "Publications", scale, ink),
    publications.length
      ? { ol: publications, fontSize: 9 * scale, color: ink }
      : { text: "—", fontSize: 9 * scale, color: muted }
  );

  return doc;
}

function buildSales(model: CvDocModel, lang: Lang, colors: PdfColorsLike, scale: number) {
  const L = normLang(lang);
  const brand = pick(colors, "brand", "#1e3a8a"); // blue
  const ink = pick(colors, "ink", "#0f172a");
  const muted = pick(colors, "muted", "#64748b");
  const line = pick(colors, "line", "#e5e7eb");
  const bgSoft = pick(colors, "bgSoft", "#eff6ff");

  const doc = baseDocDefinition(model, colors, scale, [28 * scale, 26 * scale, 28 * scale, 24 * scale]);
  const skills = collectSkills(model);

  const kpisRaw = (model as any).kpis ?? (model as any).salesKpis ?? [];
  const kpis: Array<{ label: string; value: string }> = Array.isArray(kpisRaw)
    ? kpisRaw
        .map((x: any) => ({ label: safeText(x?.label), value: safeText(x?.value) }))
        .filter((x) => x.label || x.value)
        .slice(0, 6)
    : [];

  (doc.content as any[]).push(
    {
      table: {
        widths: ["*", "*"],
        body: [
          [
            {
              fillColor: brand,
              margin: [14 * scale, 12 * scale, 14 * scale, 12 * scale],
              stack: [
                { text: safeText(model.name), fontSize: 20 * scale, bold: true, color: "#ffffff" },
                { text: safeText((model as any).title), fontSize: 11 * scale, bold: true, color: "#ffffff", margin: [0, 2 * scale, 0, 0] },
              ],
            },
            {
              fillColor: brand,
              margin: [14 * scale, 12 * scale, 14 * scale, 12 * scale],
              stack: [
                { text: safeText((model as any).contactLine ?? (model as any).contact), fontSize: 9 * scale, color: "#ffffff", alignment: "right" },
                { text: safeText((model as any).langLine), fontSize: 9 * scale, color: "#ffffff", alignment: "right", margin: [0, 2 * scale, 0, 0] },
              ],
            },
          ],
        ],
      },
      layout: "noBorders",
      margin: [-6 * scale, -6 * scale, -6 * scale, 10 * scale],
    },
    {
      columns: [
        {
          width: 210 * scale,
          stack: [
            {
              table: {
                widths: ["*"],
                body: [
                  [
                    {
                      fillColor: bgSoft,
                      margin: [10 * scale, 10 * scale, 10 * scale, 10 * scale],
                      stack: [
                        sectionTitle(L === "en" ? "Top KPIs" : "KPIs", scale, ink),
                        ...(kpis.length
                          ? kpis.map((k) => ({
                              columns: [
                                { width: "*", text: k.label || "—", fontSize: 9 * scale, color: muted },
                                { width: 70 * scale, text: k.value || "—", fontSize: 9.2 * scale, bold: true, color: ink, alignment: "right" },
                              ],
                              columnGap: 8 * scale,
                              margin: [0, 1 * scale, 0, 3 * scale],
                            }))
                          : [{ text: "—", fontSize: 9 * scale, color: muted }]),
                      ],
                    },
                  ],
                ],
              },
              layout: "noBorders",
              margin: [0, 0, 0, 10 * scale],
            },

            sectionTitle(L === "en" ? "Skills" : "Compétences", scale, ink),
            { text: joinDot(skills, 160), fontSize: 9 * scale, color: muted, margin: [0, 2 * scale, 0, 10 * scale] },

            sectionTitle(L === "en" ? "Certifications" : "Certifications", scale, ink),
            { text: safeText((model as any).certs), fontSize: 9 * scale, color: muted },
          ],
        },
        {
          width: "*",
          margin: [16 * scale, 0, 0, 0],
          stack: [
            sectionTitle(L === "en" ? "Profile" : "Profil", scale, ink),
            { text: safeText((model as any).profile), fontSize: 9.5 * scale, color: ink, margin: [0, 2 * scale, 0, 8 * scale], alignment: "justify" },

            hr(scale, line),

            sectionTitle(L === "en" ? "Experience" : "Expérience", scale, ink),
            { stack: renderXp(model, scale, ink, muted) },

            hr(scale, line),

            sectionTitle(L === "en" ? "Education" : "Formation", scale, ink),
            { stack: renderEducation(model, scale, ink, muted) },
          ],
        },
      ],
    }
  );

  return doc;
}

// ----------------------------------------------------
// Public API
// ----------------------------------------------------

export function buildCvPdf(
  templateId: CvTemplateId,
  model: CvDocModel,
  lang: Lang,
  colors: PdfColorsLike,
  layout: "auto" | "tight" | "spacious" = "auto",
  scale = 1
) {
  const L = normLang(lang);

  const styleMode: "auto" | "compact" | "expanded" =
    layout === "tight" ? "compact" : layout === "spacious" ? "expanded" : "auto";

  if (templateId === "ats") {
    return buildCvAtsPdf(model, L, colors as any, styleMode, scale);
  }

  const mul = layout === "tight" ? 0.92 : layout === "spacious" ? 1.08 : 1.0;
  const s = clamp(scale * mul, 0.75, 1.6);

  switch (templateId) {
    case "classic":
      return buildClassic(model, L, colors, s);
    case "modern":
      return buildModern(model, L, colors, s);
    case "minimalist":
      return buildMinimalist(model, L, colors, s);
    case "creative":
      return buildCreative(model, L, colors, s);
    case "elegant":
      return buildElegant(model, L, colors, s);
    case "tech":
      return buildTech(model, L, colors, s);
    case "pro_max":
      return buildProMax(model, L, colors, s);

    // ✅ nouveaux
    case "executive":
      return buildExecutive(model, L, colors, s);
    case "startup":
      return buildStartup(model, L, colors, s);
    case "two_column":
      return buildTwoColumn(model, L, colors, s);
    case "elegant_color":
      return buildElegantColor(model, L, colors, s);
    case "academic":
      return buildAcademic(model, L, colors, s);
    case "sales":
      return buildSales(model, L, colors, s);

    default:
      return buildClassic(model, L, colors, s);
  }
}
````

## File: lib/recaptcha.ts
````typescript
// lib/recaptcha.ts
"use client";

/**
 * ✅ Single source of truth reCAPTCHA (v3 standard ou Enterprise)
 * - Loader robuste (script injecté si absent + attente réelle de grecaptcha)
 * - tryGetRecaptchaToken(): non bloquant => retourne null si adblock/timeout…
 * - getRecaptchaToken(): strict => throw si impossible
 * - verifyRecaptcha(): optionnel via endpoint CF /recaptchaVerify (Enterprise côté serveur)
 *
 * Notes :
 * - Côté Cloud Functions, tes endpoints acceptent le token via body.recaptchaToken|token
 *   OU via header "x-recaptcha-token".
 * - L’action est normalisée côté client, et envoyée au /recaptchaVerify (optionnel).
 */

declare global {
  interface Window {
    grecaptcha?: GrecaptchaRoot;
  }
}

type GrecaptchaClient = {
  ready?: (cb: () => void) => void;
  execute: (siteKey: string, opts: { action: string }) => Promise<string>;
};

type GrecaptchaRoot = GrecaptchaClient & {
  enterprise?: GrecaptchaClient;
};

export type VerifyResult =
  | { ok: true; score?: number }
  | { ok: false; reason: string; score?: number };

const DEFAULT_API_BASE = "https://europe-west1-assistant-ia-v4.cloudfunctions.net";

export const API_BASE = (process.env.NEXT_PUBLIC_API_BASE_URL || DEFAULT_API_BASE).replace(
  /\/+$/,
  ""
);

const SITE_KEY =
  process.env.NEXT_PUBLIC_RECAPTCHA_SITE_KEY ||
  process.env.NEXT_PUBLIC_RECAPTCHA_KEY ||
  "";

const USE_ENTERPRISE =
  (process.env.NEXT_PUBLIC_RECAPTCHA_ENTERPRISE || "").toLowerCase().trim() === "true";

/**
 * Optionnel : certains environnements bloquent google.com mais autorisent recaptcha.net
 * (même si, souvent, les deux sont filtrés). Tu peux forcer via env si besoin.
 */
const USE_RECAPTCHA_NET =
  (process.env.NEXT_PUBLIC_RECAPTCHA_USE_NET || "").toLowerCase().trim() === "true";

let recaptchaLoadPromise: Promise<void> | null = null;

function isBrowser(): boolean {
  return typeof window !== "undefined" && typeof document !== "undefined";
}

function normalizeAction(action: string): string {
  return (action || "").trim().toLowerCase();
}

function describeRecaptchaLoadFailure(): string {
  return [
    "Sécurité: impossible de valider reCAPTCHA.",
    "Le script reCAPTCHA n’a pas pu être chargé ou est bloqué.",
    "Causes fréquentes: bloqueur de pubs, DNS filtrant, proxy/corporate, CSP trop stricte, ou réseau qui bloque google.com.",
  ].join(" ");
}

function getScriptSelector(): string {
  return USE_ENTERPRISE ? 'script[data-recaptcha="enterprise"]' : 'script[data-recaptcha="v3"]';
}

function getScriptSrc(): string {
  const host = USE_RECAPTCHA_NET ? "https://www.recaptcha.net" : "https://www.google.com";
  const base = USE_ENTERPRISE
    ? `${host}/recaptcha/enterprise.js`
    : `${host}/recaptcha/api.js`;
  return `${base}?render=${encodeURIComponent(SITE_KEY)}`;
}

function hasUsableRecaptcha(): boolean {
  const g = window.grecaptcha;
  if (!g) return false;

  if (USE_ENTERPRISE) {
    return Boolean(g.enterprise && typeof g.enterprise.execute === "function");
  }

  return typeof g.execute === "function";
}

function pickRecaptchaClient(): GrecaptchaClient | null {
  const g = window.grecaptcha;
  if (!g) return null;

  if (USE_ENTERPRISE) {
    if (g.enterprise && typeof g.enterprise.execute === "function") return g.enterprise;
    return null;
  }

  if (typeof g.execute === "function") return g;
  return null;
}

/**
 * ✅ Loader robuste :
 * - injecte le script si absent
 * - attend que grecaptcha soit réellement dispo
 * - retentable (reset promise en cas d’échec)
 */
async function ensureRecaptchaLoaded(): Promise<void> {
  if (!isBrowser()) {
    throw new Error("reCAPTCHA: appelé côté serveur (SSR).");
  }
  if (!SITE_KEY) {
    throw new Error("reCAPTCHA: NEXT_PUBLIC_RECAPTCHA_SITE_KEY manquant.");
  }
  if (hasUsableRecaptcha()) return;
  if (recaptchaLoadPromise) return recaptchaLoadPromise;

  recaptchaLoadPromise = new Promise<void>((resolve, reject) => {
    const selector = getScriptSelector();
    const existing = document.querySelector<HTMLScriptElement>(selector);

    const waitUntil = (timeoutMs: number) => {
      const t0 = Date.now();

      const tick = () => {
        if (hasUsableRecaptcha()) return resolve();
        if (Date.now() - t0 > timeoutMs) return reject(new Error(describeRecaptchaLoadFailure()));

        // requestAnimationFrame peut être throttlé en onglet inactif, on mixe avec setTimeout.
        window.setTimeout(tick, 50);
      };

      tick();
    };

    // Script déjà présent => on attend juste l'exposition de grecaptcha
    if (existing) {
      waitUntil(12_000);
      return;
    }

    const script = document.createElement("script");
    script.async = true;
    script.defer = true;
    script.setAttribute("data-recaptcha", USE_ENTERPRISE ? "enterprise" : "v3");
    script.src = getScriptSrc();

    const timeout = window.setTimeout(() => {
      reject(new Error(describeRecaptchaLoadFailure()));
    }, 15_000);

    script.onload = () => {
      window.clearTimeout(timeout);
      waitUntil(10_000);
    };

    script.onerror = () => {
      window.clearTimeout(timeout);
      reject(new Error(describeRecaptchaLoadFailure()));
    };

    document.head.appendChild(script);
  }).catch((e) => {
    recaptchaLoadPromise = null; // ✅ retentable
    throw e;
  });

  return recaptchaLoadPromise;
}

/**
 * ✅ Non bloquant :
 * - retourne un token si possible
 * - sinon null (adblock, script bloqué, timeout…)
 */
export async function tryGetRecaptchaToken(action: string): Promise<string | null> {
  if (!isBrowser()) return null;
  if (!SITE_KEY) return null;

  const normalizedAction = normalizeAction(action);
  if (!normalizedAction) return null;

  try {
    await ensureRecaptchaLoaded();

    const client = pickRecaptchaClient();
    if (!client) return null;

    const token = await new Promise<string>((resolve, reject) => {
      const runExecute = () => {
        client
          .execute(SITE_KEY, { action: normalizedAction })
          .then((t) => resolve(t))
          .catch(reject);
      };

      try {
        if (typeof client.ready === "function") client.ready(runExecute);
        else runExecute();
      } catch (e) {
        reject(e);
      }
    });

    return typeof token === "string" && token.trim() ? token : null;
  } catch {
    return null;
  }
}

/** Version stricte */
export async function getRecaptchaToken(action: string): Promise<string> {
  const token = await tryGetRecaptchaToken(action);
  if (!token) throw new Error(describeRecaptchaLoadFailure());
  return token;
}

/** Précharge le script (utile au mount) */
export async function warmupRecaptcha(): Promise<void> {
  await ensureRecaptchaLoaded();
}

/**
 * Helper pratique pour tes appels Cloud Functions:
 * - met le token en header (tes CF le lisent via x-recaptcha-token)
 * - ou tu peux aussi le mettre dans le body (recaptchaToken)
 */
export function buildRecaptchaHeaders(token: string | null): HeadersInit {
  if (!token) return {};
  return {
    "X-Recaptcha-Token": token,
    "x-recaptcha-token": token,
  };
}

/** Vérif optionnelle via endpoint /recaptchaVerify (serveur) */
export async function verifyRecaptcha(token: string, action: string): Promise<VerifyResult> {
  const normalizedAction = normalizeAction(action);

  if (!token) return { ok: false, reason: "missing_token" };
  if (!normalizedAction) return { ok: false, reason: "missing_action" };

  try {
    const res = await fetch(`${API_BASE}/recaptchaVerify`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ token, action: normalizedAction }),
      cache: "no-store",
    });

    const data: any = await res.json().catch(() => ({}));

    if (!res.ok || !data?.ok) {
      const score =
        typeof data?.score === "number"
          ? data.score
          : typeof data?.details?.score === "number"
            ? data.details.score
            : undefined;

      return {
        ok: false,
        reason: String(data?.reason || data?.details?.reason || "recaptcha_failed"),
        score,
      };
    }

    return { ok: true, score: typeof data?.score === "number" ? data.score : undefined };
  } catch {
    return { ok: false, reason: "network_error" };
  }
}
````

## File: .firebase/hosting.b3V0.cache
````
tech.txt,1768232327191,07dea7568104f210c285af98a04ce5915e4cfbe593f8c7e4ffb326bbcd3e057f
signup.txt,1768232327446,26dd25c3bba26b7f844f456750f2a1a02d16f63643c9857e990da832c5aac840
manifest.webmanifest,1768155459013,927dbc0269ea50145506eadf7dd849187d3396c84167fa6dd2ae0c4f1e83b361
tech.html,1768232327191,163ec37fc8505ef567cb73b243fbb0d8b7d9128a0dc3ad8bbec5090f1532dfe9
login.txt,1768232327457,ca87ba672804d10dc07ff080e02eeb4024d41bbe38624c3909bc120587fa7053
signup.html,1768232327448,0f5120a959f81577735f8c4d02e33c80ee3f6e5df7a47d59c8beab3ce278aacf
index.txt,1768232327726,858917c295cfee3a224f8a2ee9fb63481e4742cd270892f7ea1bf9eb1e03e878
login.html,1768232327468,f7d73e529150617146890bbdd03f1b9643e17f5cd0028ada53dac039e2276834
forgot-password.txt,1768232327358,ce989409548cbc3341683997040d35503e51414b28ab3389d8d1ecdd42df4ba6
index.html,1768232327743,3036bc4ad2a844ea2ed46c964a2e7acbb7d13cb409be9e15e477a2ea88d25524
assistance-candidature.html,1768232327745,0a3e63bd24bc75794e58575278663f2a2bce58ca88887876e0d2213e56b839e6
app.txt,1768232327775,566a1adc4b772f3a714dc4b2fd24211b912562b6f9463001fd8cacd29e16dabf
assistance-candidature.txt,1768232327743,1c0ce59b84138a036e2c835e91033099f0632e3a66dd9a9ec64b2efc5f809452
admin.txt,1768232327693,96fb193523c612c7849993fc104db22ff65be23f465ce6c2c8d2c402b822a7bb
app.html,1768232327775,6a0179f2221a001873708bd28cd8d7206791aeb49d575962815ba80f4c4d2504
admin.html,1768232327695,8cef85da42daef11aeaa9e1fa5ecf4da128e0b6ac7ceb382503de383817a43a8
404.html,1768232370153,3730e04cfa68ba1c4651d7f23a5c1a4f860ddc728ef9f3609288d92166acda2e
_next/static/chunks/webpack-68d128f78d0676ff.js,1768232280864,985dde1c5969fbb277924c31ddb83b4578733f5079ba6334186b90bb286d327e
_next/static/chunks/main-app-b44c38f55a311223.js,1768232280864,7b9da02faa69b812bae2e3782ea1d87663439ef1989b079b5a461f5accd6b87f
_next/static/css/8000f1f83c79eeaf.css,1768232280895,c3b6f784717e23b46d785962786d6088f1558515d38294786fb1bd3661001dd0
forgot-password.html,1768232327362,ef21ea35810eb755914235a4a8f4aec3d54e3d6aa262efe6b110f6ea67e07db2
_next/static/chunks/500-40506023c0508dd9.js,1768232280880,e907e3542dff0f6ce72a15b736192ff3acc27c725cb31cdc5fb6a1c9cece20ff
_next/static/chunks/pages/_error-7ba65e1336b92748.js,1768232280864,09b35fbc854afaf76c1b75a5b3272bf936d957493d106176ade3af1047ea394e
_next/static/chunks/276-a01f3bf27c64a121.js,1768232280880,2fe706013077f14423ce7a536ca7facb7139e40b49bb34720ec83bd9813f26b0
_next/static/chunks/pages/_app-d874dd764970d7b7.js,1768232280864,cf7b5e145b6ff49e05e63e9aaff7eab9faac517141e28fea4ceb4189f44dcf94
_next/static/chunks/app/not-found-c54ea71e399c07fa.js,1768232280864,cd56ad360e9bc042d61f43ea31b0dfe75458a3e062e9eff075599e928723f1ee
_next/static/chunks/app/page-8e925a9ce70a8927.js,1768232280864,44cb4cefd1e0adc7da38bf4bd4f67d239329609cf91fc7d7ed7e128e7d4d3070
_next/static/chunks/app/_not-found/page-7494094633467ef3.js,1768232280864,8c1182c18d7bc5d5c3a2750f36a686fc71507b1b715f5e9f467c18edfc450feb
_next/static/chunks/app/layout-5b848cc536c696cd.js,1768232280864,2ee1cff9179f8c473565ce7b40917ba453781458d10273c3471b1ff0c222f56f
_next/static/chunks/app/tech/page-d34b3c98fa71b65e.js,1768232280864,836cfe3934c7871c392e72afb4922aaeadf2be2ae1248422258b75bb8c67a015
_next/static/chunks/app/login/page-ea17d1db66f23d5e.js,1768232280864,1957195a4e4f1f7d5c019cbd2dc3946eb9c37fbd14506f2ea076e34bbb27dbb5
_next/static/chunks/app/forgot-password/page-f1b6e474a2b27851.js,1768232280864,aa9d4dbd3bb79123ebfa736659daf09b1bb91a110411b15ee84482b71d8e3014
_next/static/chunks/app/auth/verify-email/page-f6671504df2b2a2a.js,1768232280864,288124857e6e8e9910964610d84e7b6b1e9643725f391331d533e8b2cedcad9b
_next/static/chunks/app/debug/polar/page-c9423332f2d52118.js,1768232280864,5d3ab3f7dd327bffab273d1dc8968d96858bd951945d2874a14c043be5fc9442
_next/static/chunks/app/signup/page-9769d867f5041426.js,1768232280864,f0404cc8ed95b915b44301397362170e1a3a4d74bd82b2aa15ae988f44143a21
_next/static/chunks/648-e6a5e95ed82680cc.js,1768232280880,0a1b01dd91db087fd33a19826f12b2743d381c471c64e4aff61f63efa84568f1
_next/static/chunks/437-5a3a96e5c77e24da.js,1768232280880,5cf8ec596ea9f549b08f46c9a2fd69c4c5f6f2be98d3ecd20cb39cc4cdcf3ec3
_next/static/chunks/941-55c74cdbddb30c1c.js,1768232280880,709b17ed010374d69b5b9cdbab70cd5ee894bbf5f890a3ed9d50511e3a7c6ba9
_next/static/chunks/ebf8faf4-abffcf7098821415.js,1768232280880,24160a7ef9fc328073af4d7e4e1eedb6b2be94df035ccdee2a240ea1d3544dbc
_next/static/chunks/polyfills-42372ed130431b0a.js,1768232280880,18e28d3214eda45048d80d3925ea7627b809e69ad2e95f7f98459e9146a61c3d
_next/static/chunks/main-99b5844079a416a5.js,1768232280864,d836d40bf77e7f4ad1b682ed1c5d24d5ea42895d4579f8a7a46c0e99b827c1c1
_next/static/chunks/600-b26beb7436e15456.js,1768232280880,3875f3c4da55130ebb4469254db30b41f89f0968c60c6e13bb068369702a33e5
_next/static/chunks/810-e72ee95d8a67468c.js,1768232280880,ce498c2bfe790e2b9f2405feab4dc8124312c3ec2ebfc87b8f7e3fa4a2298384
_next/static/chunks/app/assistance-candidature/page-f38626f0664fd689.js,1768232280864,1ea42bef71c64ce6ac12815cb0857e30c318215eb5a1840de5960b539ecb9795
_next/static/chunks/app/app/settings/page-b54d25ac58112b26.js,1768232280864,3edd843607a3475433043bcc0ff4cecf7d38eb00fee4fc5f2163add847ab560a
_next/static/chunks/app/app/pitch/page-9f70e6afbd107c4d.js,1768232280864,772c93ddb637585b225f67878d74818e91300fea9b1fa4f2e3f299e319b0ccf6
_next/static/chunks/app/app/tracker/page-bb7cfaf6dbc380e2.js,1768232280864,1ebe7883e6d8bb77686ee933013e4a9e41de97fe7522d1d810f1487c510b040a
_next/static/chunks/app/app/layout-3b2592bf7d07c4ee.js,1768232280864,6b36be819d904eace988cec5e856d510bd106173580455b16805482ff4e9b633
_next/static/chunks/app/app/history/page-6eaf54d7d7fb7fa5.js,1768232280864,a02e2fcca5ac63a54691b7f7d3e5a82d7806ee7d2f9d802da45806ddb9661624
_next/static/chunks/app/app/cv/page-ea58a3b11db4dcad.js,1768232280864,b3e6e5c8ef322c4def53e5892738c3208db6bf18a32fa7d15b33c8d69859a861
_next/static/chunks/app/app/interview/page-484257de30d47503.js,1768232280864,1a9d8b1f049b726409af47e45b97e9096c195547087bdc3e55afbc33854ba0b8
_next/static/chunks/app/app/credits/page-9bfe13505e14fb3c.js,1768232280864,24c652d02add086720d9050f523deb3d6f5fddae61a3c9e1e371f7be540db247
_next/static/chunks/app/app/apply/page-6398e0f5cc4b2135.js,1768232280864,f09f080e9762f38a5f1444deecc97ee4314356aef5807b124eb761bd4a78c442
_next/static/chunks/app/admin/login/page-09799a14fcf4172c.js,1768232280864,bbeb81ddcba384589057468531d59bbc2fceea212837d24b05b894dc7c239606
_next/static/BJI4H3wcfM3OY8Ysagnca/_ssgManifest.js,1768232328864,dc28a4dc92fe352ed5d2201bd3972ce47691bc8e89e0400a68d1541d0567c6d5
_next/static/chunks/app/admin/logs/page-6bb69cf437bde6a5.js,1768232280864,e29f9861ceea1c62331379fe2569f94a702c29faac0987c4aa4adb29e8549edb
_next/static/BJI4H3wcfM3OY8Ysagnca/_buildManifest.js,1768232280880,b7b50b96854bcbc40ab6e8bf51e9f11625752bd8ac7aed0bd0353f441f2b3134
locales/fr/common.json,1768155459013,707b637bc54157f7da34d6e091ad4e5f01e6752856dda30b45c68c7774240ec9
_next/static/chunks/app/admin/page-54895cf7627dccdf.js,1768232280864,4a32b7e3b29b1b65565cbcf375a389e966a7fe583ae421834358ca815ca59d56
locales/en/common.json,1768155459013,5a3970a9a35eb5770ad8bd5ada32e77f4cbb61f12df77c4e77e245212109e438
debug/polar.txt,1768232327468,40bea7d55d8852684deb11300b13dfd36f52fd53ac77659a827484fb73c8d276
_next/static/chunks/framework-aec844d2ccbe7592.js,1768232280880,6d49f7a813e42aa1377442e7d1344f04694df3f7f20a10c083c6223aa17097ee
debug/polar.html,1768232327469,f57919755a3bc2d10ec720a8fcea95ffe23c274e1e8ea6f705c14b7ab37f02d2
cv-templates/cv-template-startup.png,1768155459006,10ff02ee2a3992f53f8035b70912aa2daaeb70718a7900ca37a71447602d4fa7
cv-templates/cv-template-sales.png,1768155459006,3ccb7554a72903759fbf658c7258944990e048a0e1274937d1f0a35afb33cdc9
cv-templates/cv-template-minimalist.png,1768155459006,59fb9f56f1f2509b41fdbc456e63ad74eabba7528612701ef1fd64efdb35ed56
cv-templates/cv-template-elegant.png,1768155459005,61f9c9b1455fc4e66ff4313c0a7ccdbc4c474c6a440c9e471481983f006d92d7
_next/static/chunks/app/app/page-d941683217870466.js,1768232280864,bc9168f5ebb8a7f85ce86461098e2ad6228abd38a46ca8db012ba9d0a7d4b519
cv-templates/cv-template-executive.png,1768155459006,7f3e5a0f04a99c5e18f5c74457e9cd853c507382c320600d92cef555c5b39ae1
cv-templates/cv-template-creative.png,1768155459003,b7b74901e46fdce39f0775270ba51571271c81669f24a9b4d6f23b1c5554819d
cv-templates/cv-template-two-column.png,1768155459006,94420bf7caf1be58040156a9458e4fb2ee1423193b9eb86be368793a890f667a
cv-templates/cv-template-tech.png,1768155459006,bf53e790e51c7f9a17f3afd7da9167c7c08070eccdabe4eaeac4549a0c1a74de
_next/static/chunks/7508b87c-2affb3ad7b55ab3d.js,1768232280880,1a5fe16e0a16175b907c108838608d2bb5c1d2690c4a0232480fc2e435290d96
cv-templates/cv-template-modern.png,1768155459006,06a16f9c92c9ce60a928230ed19d9bbc5afad384cbc4c008f322dcd71410e34a
cv-templates/cv-template-elegant-color.png,1768155459005,7d2d065f8844d958858052d7996b4c6f6d27d67e54262234b3c604ef1d230316
_next/static/chunks/app/app/lm/page-af04d6401b6c6b90.js,1768232280864,3865f38d30f24a288131b84c763d667e3152eed39b27c87a3f054b5338039e8c
_next/static/chunks/fd9d1056-1087d9c94f014549.js,1768232280880,080cf476a9e293eef13f2f7c86fd42cd8b401b9e2a2aaa7baf5af2d925db31cb
cv-templates/cv-template-ats.png,1768155459001,49bad74c38af0004a759aa118e9f427358fb71096f89d9089d1fed556e036630
cv-templates/cv-template-timeline.png,1768155459006,84449d23ee324af39c851d36d3fe469ad4fe627cb0071a1dc1f9c48bd58ae6c0
cv-templates/cv-template-skills-matrix.png,1768155459006,a24f8f2c8f19a2bc580456684f8a5620aef0a99ea8274f88b22db957d195da75
_next/static/chunks/ca377847-044365abace2608d.js,1768232280880,a333dda307754304e0d97bb9fa98b0e98d532336a3e7b3a73fa4cef8c94806f0
cv-templates/cv-template-projects.png,1768155459006,84543e1eb68dd43d706a8fe8929a3ec96294a256059392be4bcdb572cc0b8b8f
cv-templates/cv-template-academic.png,1768155459001,00d5c89975c6ba971022b68b972607f2ec9c96820311cc72b5d39c626e217ad9
auth/verify-email.txt,1768232327489,fc9e9079a8617fff44a7115511923716db2ff176d427ffc146215ec9096a4807
cv-templates/cv-template-classic.png,1768155459001,563abe4526225fe326cf7fafeb1cade16432929e33a1d4ae6a04db37343de62f
cv-templates/cv-template-pro-max.png,1768155459006,fd16ad4492ebe50c928d3793bd07da0c3532144d52cad892e4d37294ab0aa648
auth/verify-email.html,1768232327491,37917934861c08efbbb0fdc0b0fcba21790eafdc05dad1c4899a8c1916304404
app/tracker.txt,1768232327722,6710d4e3e468491ebf64a801791c33cbb3189263b07c7ff895af41fea2009c8d
app/settings.txt,1768232327775,ef1b6dfb4ea2ac202e2430ba3afe26229790c65ee29c579bcc5dd34ebbfe300e
app/tracker.html,1768232327773,50703067f2cd4333d83168ea6add57c851c85fb8e935a47a2768d16b71cc00a9
app/settings.html,1768232327783,56b8d09a66044332728c674b98b2ae32eb484e9406abf9817357f758d0a8dc0a
app/pitch.txt,1768232327655,0d475ac86bf796d8a2435fca44cd92dfa225f660eae2ec4f4b8cde8c10350f56
app/lm.txt,1768232327807,9f20e4a27109ad5d4171e2d8cb5bcac8ff13d5c988a75d44a69dcd26ad344074
app/pitch.html,1768232327724,949b8f07492c394c1a6ceff871bf1c36a93fd5a6756e93c88e502f7d7f07f3e2
app/lm.html,1768232327807,357799b25037b78ae56cdddef5d1cb81a931255c350cf0c8bd734d2dd51d6b99
app/interview.txt,1768232327775,5597a2432df4647fc3dd66dabcf67cc4b4efa2720491eb8c54d78cdc9539abeb
app/interview.html,1768232327775,3b1ba4e5327da894295d0e95cac4198feb61075e82f8a5eb05277e3906ff7c50
app/history.txt,1768232327469,4367b94bf6cf850c274ad2976691d21ca864bdc30b0fdc3c38a59b257781a9ae
cv-templates/cv-template-consulting.png,1768155459003,a762971601164a96e29220bc3b078fc96c61a304834299e06511547108193803
app/cv.html,1768232327775,5e5318e37301e8fada1b6b98dc02ec80de091c7b9dba3c05bcf46c52a2ffc9f1
app/history.html,1768232327491,b9acbe74ce6fd5036e000483dbb370615b34433e37d0c4011a187b9a3fdb85bd
app/credits.txt,1768232327489,b8c6ea0ba8d0b744cbe9bd3ec095526ea39b083e0fb3c878b536f47b40abcf38
app/credits.html,1768232327491,4299c0d76bd0c4b6b0b5b6c312a7c86d01a0313a7b8815b565522e430383c833
app/apply.txt,1768232327493,a111df833e25f641f6d7d648196ccdf10d2531e144507e0a52d7cfc9a5a845b5
app/apply.html,1768232327495,117a89209f7688d8776f024eb49665527711d0c159d577384ae7d39b59e4c90a
admin/logs.txt,1768232327741,5edfe7989ff91b69f3eee33fce26d393a09808741d197ac90553a3bb9a3c2496
admin/logs.html,1768232327744,e23d3d6bb9f55d048894db802d4c28123e8fa445b2e3c6cd37dba98d2e4f532c
admin/login.txt,1768232327431,83ac712377e133c28a4d5603275d371d90aeeb208aa94c8b83ffb21b678e865f
admin/login.html,1768232327452,81675796b13cd8b404485b8ce8c3dd17c4e88e45c96ca3807dc6b3655ab96e91
cv-templates/cv-template-compact.png,1768155459003,f61f6b0ee424bcb8e344ff9ff65792e7195e66b445f9e5e63a74c55e4ec6e4fb
app/cv.txt,1768232327775,7d0b34e85d1c04653e7fa463c6597d7531a21f935807e0f6cd658a9749ae7d0e
cv-templates/cv-previews-grid-new.png,1768155459000,3a73ebb2c557a312be904b0974ff52cb264b680389d4e74825a6ad881d20b107
_next/static/chunks/323-54d09e3358a73f44.js,1768232280880,0f0b7e4cb051869a5aa8d71fb6862e6aad0873de53f94645fd77c1778550f2d3
_next/static/chunks/63b94182-0b71b7d5be618145.js,1768232280880,b363fbf335d12cfc0e03092a2d29e63e6ae89707dfe2c6b5ffdddca109b9f762
_next/static/chunks/5493da1b-773a6facf441f357.js,1768232280880,ee7b981196e314fb0993c0c831394c0c52b5ecc67e90c4baa4d51c47ccf9513c
````

## File: next.config.mjs
````javascript
/** @type {import('next').NextConfig} */
const nextConfig = {
  reactStrictMode: true,

  // Export statique (Firebase Hosting)
  output: "export",

  images: { unoptimized: true },

  transpilePackages: ["pdfjs-dist"],

  // DEV uniquement : proxy /api/* vers Cloud Functions
  async rewrites() {
    if (process.env.NODE_ENV !== "development") return [];
    return [
      {
        source: "/api/:path*",
        destination:
          "https://europe-west1-assistant-ia-v4.cloudfunctions.net/:path*",
      },
    ];
  },
};

export default nextConfig;
````

## File: functions/index.js
````javascript
// functions/index.js
"use strict";

/**
 * ✅ Smart2 — Firebase Functions (FULL FILE)
 * - Gemini (CV extraction + lettres + pitch + interview + Q&A)
 * - PDF (CV + Lettre)
 * - ZIP (CV+LM)
 * - reCAPTCHA Enterprise (avec bypass si user authentifié sur endpoints sensibles)
 * - Admin (setAdminRole, adminUpdateCredits)
 * - Jobs (Adzuna)
 * - Paiements (Polar checkout + webhook)
 *
 * ⚠️ Pré-requis package.json functions:
 * - engines.node: "18"
 * - deps: firebase-admin, firebase-functions, pdf-lib, jszip, @polar-sh/sdk,
 *         @google-cloud/recaptcha-enterprise
 *
 * ⚠️ Secrets:
 * - GEMINI_API_KEY (runWith secrets)
 *
 * ⚠️ Env/config:
 * - RECAPTCHA_PROJECT_ID / RECAPTCHA_SITE_KEY / RECAPTCHA_THRESHOLD / RECAPTCHA_BYPASS / RECAPTCHA_STRICT_ACTION
 * - ADZUNA_APP_ID / ADZUNA_APP_KEY (ou functions.config().adzuna.*)
 * - POLAR_ACCESS_TOKEN / POLAR_ENV / POLAR_PRODUCT_*_ID / POLAR_PRICE_*_ID
 * - NEXT_PUBLIC_APP_URL ou functions.config().app.base_url
 * - CORS_ALLOW_ORIGINS (csv) ou functions.config().app.cors_allow_origins (csv)
 */

const functions = require("firebase-functions/v1");
const admin = require("firebase-admin");
const { PDFDocument, StandardFonts, rgb } = require("pdf-lib");
const JSZip = require("jszip");
const { Polar } = require("@polar-sh/sdk");
const { RecaptchaEnterpriseServiceClient } = require("@google-cloud/recaptcha-enterprise");

// =============================
// Firebase Admin init
// =============================
if (!admin.apps.length) admin.initializeApp();
const db = admin.firestore();

// =============================
// Helper fetch (Node 18+)
// =============================
const fetchFn = globalThis.fetch;
if (!fetchFn) {
  console.warn(
    "⚠️ globalThis.fetch introuvable. Mets Node 18+ dans functions/package.json (engines.node=18)."
  );
}

// ======================================================
// ✅ PROMPTS INLINE (LM/PITCH JSON strict + CV TAILOR)
// ======================================================
const TEMPLATE_LETTER_PITCH_FR = `
Tu es un recruteur senior et un coach carrière.

Retourne STRICTEMENT un JSON valide :
{ "coverLetterBody": "string", "pitch": "string" }

RÈGLES LETTRE (coverLetterBody) :
- UNIQUEMENT le CORPS (pas d’en-tête, pas d’objet, pas de formule d’appel, pas de signature).
- 3 à 4 paragraphes (séparés par UNE ligne vide).
- Longueur : 220 à 320 mots.
- Ton professionnel, concret, pas de blabla.
- Utilise explicitement 2 à 3 expériences du candidat (missions / réalisations) AVEC outils/technos déjà présents dans le profil.
- Ne pas inventer (entreprises/outils/chiffres).
- Ne recopie PAS la fiche de poste : pas plus de 10–12 mots identiques d’affilée.
- Ignore totalement les blocs “UI” d’offres copiées/collées (Indeed/LinkedIn) du type :
  “Informations sur le profil”, “Correspondance…”, “Détails de l’emploi”, “Compétences”, “Formation”, etc.
- Base-toi UNIQUEMENT sur le profil candidat + les éléments utiles de la fiche de poste.

RÈGLES PITCH :
- 2 à 4 phrases max.
- Spécifique au poste et à l’entreprise.
- Ne pas inventer.

PROFIL CANDIDAT (source de vérité) :
{{cvText}}

FICHE DE POSTE (ne pas copier, juste s'en inspirer) :
{{jobDescription}}

INTITULÉ : {{jobTitle}}
ENTREPRISE : {{companyName}}
`.trim();

const TEMPLATE_LETTER_PITCH_EN = `
You are a senior recruiter and career coach.

Return STRICTLY valid JSON:
{ "coverLetterBody": "string", "pitch": "string" }

COVER LETTER RULES (coverLetterBody):
- ONLY the BODY (no header, no subject, no greeting, no signature).
- 3 to 4 paragraphs separated by ONE blank line.
- Length: 220 to 320 words.
- Professional, concrete, no fluff.
- Explicitly reference 2 to 3 candidate experiences (impact / responsibilities) using ONLY tools already present in the profile.
- Do not invent facts, companies, tools, numbers.
- Do NOT copy the job description: no more than 10–12 consecutive identical words.
- Ignore any job-board UI fragments pasted from Indeed/LinkedIn such as:
  “Profile information”, “Match between…”, “Job details”, “Skills”, “Education”, etc.
- Use ONLY the candidate profile and the job description (as hints).

PITCH RULES:
- 2 to 4 sentences max.
- Specific to the role and the company.
- Do not invent.

CANDIDATE PROFILE (source of truth):
{{cvText}}

JOB DESCRIPTION (do not copy; use as hints):
{{jobDescription}}

JOB TITLE: {{jobTitle}}
COMPANY: {{companyName}}
`.trim();

const TEMPLATE_CV_TAILOR_FR = `
Tu es un expert CV (recruteur senior).

Retourne STRICTEMENT ce JSON :
{
  "tailoredSummary": "string",
  "tailoredKeySkills": ["string", "..."]
}

RÈGLES :
- tailoredSummary : 3 à 5 lignes max, spécifique au poste.
- tailoredKeySkills : 8 à 14 éléments max, UNIQUEMENT des compétences/outils présents dans le profil candidat.
- Ne pas inventer.
- Base-toi UNIQUEMENT sur le profil candidat + la fiche de poste.

INTITULÉ : {{jobTitle}}
ENTREPRISE : {{companyName}}

FICHE DE POSTE :
{{jobDescription}}

PROFIL CANDIDAT :
{{cvText}}
`.trim();

const TEMPLATE_CV_TAILOR_EN = `
You are a senior recruiter and CV expert.

Return STRICTLY this JSON:
{
  "tailoredSummary": "string",
  "tailoredKeySkills": ["string", "..."]
}

RULES:
- tailoredSummary: 3 to 5 lines max, specific to the job.
- tailoredKeySkills: 8 to 14 items max, ONLY skills/tools that exist in the candidate profile.
- Do not invent.
- Use ONLY the candidate profile and the job description.

JOB TITLE: {{jobTitle}}
COMPANY: {{companyName}}

JOB DESCRIPTION:
{{jobDescription}}

CANDIDATE PROFILE:
{{cvText}}
`.trim();

function normalizeLang(langRaw) {
  const l = String(langRaw || "fr").toLowerCase();
  return l.startsWith("en") ? "en" : "fr";
}

function fillTemplate(template, vars) {
  return template.replace(/\{\{(\w+)\}\}/g, (_, k) =>
    String(vars && Object.prototype.hasOwnProperty.call(vars, k) ? vars[k] : "")
  );
}

function buildLetterAndPitchPrompt({ lang, cvText, jobDescription, jobTitle, companyName }) {
  const L = normalizeLang(lang);
  const tpl = L === "en" ? TEMPLATE_LETTER_PITCH_EN : TEMPLATE_LETTER_PITCH_FR;

  return fillTemplate(tpl, {
    cvText: cvText || "",
    jobDescription: sanitizeJobDescription(jobDescription) || "—",
    jobTitle: jobTitle || (L === "en" ? "the role" : "le poste"),
    companyName: companyName || (L === "en" ? "your company" : "votre entreprise"),
  });
}

function buildCvTailorPrompt({ lang, cvText, jobDescription, jobTitle, companyName }) {
  const L = normalizeLang(lang);
  const tpl = L === "en" ? TEMPLATE_CV_TAILOR_EN : TEMPLATE_CV_TAILOR_FR;

  return fillTemplate(tpl, {
    cvText: cvText || "",
    jobDescription: sanitizeJobDescription(jobDescription) || "—",
    jobTitle: jobTitle || (L === "en" ? "the role" : "le poste"),
    companyName: companyName || (L === "en" ? "your company" : "votre entreprise"),
  });
}

// =============================
// ✅ Nettoyage jobDescription (HTML / UI)
// =============================
function decodeHtmlEntities(input) {
  let s = String(input || "");
  s = s
    .replace(/&nbsp;/gi, " ")
    .replace(/&amp;/gi, "&")
    .replace(/&quot;/gi, '"')
    .replace(/&#39;/gi, "'")
    .replace(/&lt;/gi, "<")
    .replace(/&gt;/gi, ">");

  s = s.replace(/&#(\d+);/g, (_, n) => {
    const code = parseInt(n, 10);
    return Number.isFinite(code) ? String.fromCharCode(code) : "";
  });
  s = s.replace(/&#x([0-9a-f]+);/gi, (_, n) => {
    const code = parseInt(n, 16);
    return Number.isFinite(code) ? String.fromCharCode(code) : "";
  });

  return s;
}

function stripHtmlTags(input) {
  let s = String(input || "");
  s = s.replace(/<script[\s\S]*?<\/script>/gi, " ");
  s = s.replace(/<style[\s\S]*?<\/style>/gi, " ");
  s = s.replace(/<\/?[^>]+>/g, " ");
  return s;
}

function sanitizeJobDescription(raw) {
  let t = String(raw || "");
  if (!t.trim()) return "";

  t = decodeHtmlEntities(t);
  t = stripHtmlTags(t);

  t = t.replace(/\r/g, "\n");
  t = t.replace(/[ \t]+/g, " ");
  t = t.replace(/\n{3,}/g, "\n\n").trim();

  t = t.replace(/^\s*(description du poste|job description)\s*:?/gim, "").trim();

  const cutPatterns = [
    /informations sur le profil/i,
    /correspondance entre/i,
    /d[ée]tails de l['’]emploi/i,
    /^\s*comp[ée]tences\s*$/im,
    /^\s*formation\s*$/im,
    /avez-vous de l['’]exp[ée]rience/i,
    /^\s*avantages\s*$/im,
    /type d['’]emploi/i,
    /r[ée]mun[ée]ration/i,
    /lieu du poste/i,
    /mutuelle/i,
    /prime/i,
    /accord d['’]int[ée]ressement/i,
  ];

  let cutAt = -1;
  for (const re of cutPatterns) {
    const idx = t.search(re);
    if (idx !== -1) cutAt = cutAt === -1 ? idx : Math.min(cutAt, idx);
  }
  if (cutAt !== -1) t = t.slice(0, cutAt).trim();

  if (t.length > 1600) t = t.slice(0, 1600).trim() + "…";
  return t;
}

// =============================
// ✅ Normalisation lettre : pas de double/triple signature
// =============================
function escapeRegExp(s) {
  return String(s).replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
}

function stripMarkdownAndBullets(text) {
  let t = String(text || "").replace(/\r/g, "").trim();
  if (!t) return "";

  if (t.startsWith("```")) {
    t = t.replace(/^```[a-zA-Z]*\s*/, "").replace(/```$/g, "").trim();
  }

  t = t.replace(/\*\*(.*?)\*\*/g, "$1").replace(/__(.*?)__/g, "$1").replace(/`([^`]+)`/g, "$1");

  t = t
    .split("\n")
    .map((line) => line.replace(/^\s*[-•]\s+/, "").trimEnd())
    .join("\n")
    .trim();

  t = t.replace(/\n{3,}/g, "\n\n").trim();
  return t;
}

function looksLikeFullLetter(text, lang) {
  const t = String(text || "").trim();
  if (!t) return false;

  if (lang === "en") {
    return (
      /^dear\s+/i.test(t) ||
      /sincerely,/i.test(t) ||
      /kind regards,/i.test(t) ||
      /best regards,/i.test(t)
    );
  }

  return (
    /^madame,\s+monsieur,/i.test(t) ||
    /^bonjour\s+/i.test(t) ||
    /cordialement,/i.test(t) ||
    /bien cordialement,/i.test(t) ||
    /salutations,/i.test(t)
  );
}

function dedupeClosingBlockAtEnd(text, lang, candidateName) {
  const L = normalizeLang(lang);
  const name = String(candidateName || "").trim();
  if (!text) return "";

  const closing = L === "en" ? "Sincerely," : "Cordialement,";
  const closingEsc = escapeRegExp(closing);

  let t = String(text).replace(/\r/g, "").trim();

  if (name) {
    const nameEsc = escapeRegExp(name);
    t = t.replace(
      new RegExp(`(?:\\n\\s*${closingEsc}\\s*\\n\\s*${nameEsc}\\s*){2,}$`, "i"),
      `\n\n${closing}\n${name}`
    );
  } else {
    t = t.replace(new RegExp(`(?:\\n\\s*${closingEsc}\\s*){2,}$`, "i"), `\n\n${closing}`);
  }

  t = t.replace(/\n{3,}/g, "\n\n").trim();
  return t;
}

function ensureFullLetterFormat({ letter, lang, candidateName }) {
  let t = stripMarkdownAndBullets(letter || "");
  if (!t) return "";

  const L = normalizeLang(lang);
  const name = (candidateName || (L === "en" ? "The candidate" : "Le candidat")).trim();

  if (!looksLikeFullLetter(t, L)) {
    const greeting = L === "en" ? "Dear Hiring Manager," : "Madame, Monsieur,";
    t = `${greeting}\n\n${t}`;
  }

  const closing = L === "en" ? "Sincerely," : "Cordialement,";
  const closingEsc = escapeRegExp(closing);

  const hasClosing = new RegExp(`(?:^|\\n)\\s*${closingEsc}\\s*(?:\\n|$)`, "i").test(t);

  if (!hasClosing) {
    t = `${t}\n\n${closing}\n${name}`;
  } else {
    const lines = t.split("\n");
    for (let i = 0; i < lines.length; i++) {
      if (lines[i].trim().toLowerCase() === closing.toLowerCase()) {
        const next = (lines[i + 1] || "").trim();
        if (!next) lines[i + 1] = name;
        break;
      }
    }
    t = lines.join("\n");
  }

  t = dedupeClosingBlockAtEnd(t, L, name);
  return t;
}

function sanitizeLmBodyOnly(raw, lang, candidateName) {
  const L = normalizeLang(lang);
  const name = String(candidateName || "").trim();
  let t = stripMarkdownAndBullets(raw || "");
  if (!t) return "";

  t = t.replace(/<\/?body>/gi, "").trim();
  t = t.replace(/^\s*(objet|subject)\s*:\s*.*$/gim, "").trim();

  if (L === "fr") {
    t = t.replace(/^\s*madame,\s+monsieur,?\s*/i, "").trim();
    t = t.replace(/^\s*(madame|monsieur)\s*,?\s*(monsieur|madame)?\s*,?\s*$/i, "").trim();
  } else {
    t = t.replace(/^\s*dear\s+.*,\s*/i, "").trim();
  }

  const closings =
    L === "fr"
      ? ["cordialement,", "bien cordialement,", "salutations,", "respectueusement,"]
      : ["sincerely,", "kind regards,", "best regards,"];

  for (const c of closings) {
    const cEsc = escapeRegExp(c);
    t = t.replace(new RegExp(`\\n\\s*${cEsc}[\\s\\S]*$`, "i"), "").trim();
  }

  if (name) {
    const nEsc = escapeRegExp(name);
    t = t.replace(new RegExp(`\\n\\s*${nEsc}\\s*$`, "i"), "").trim();
  }

  t = t.replace(/\n{3,}/g, "\n\n").trim();
  return t;
}

function sanitizeLmBodyFromModel(raw) {
  if (!raw) return "";
  return String(raw)
    .replace(/\r/g, "")
    .replace(/<br\s*\/?>/gi, "\n")
    .replace(/<\/?p>/gi, "")
    .replace(/<\/?body>/gi, "")
    .replace(/^\s*<body>\s*$/gim, "")
    .replace(/^\s*<\/body>\s*$/gim, "")
    .replace(/^\s*body\s*$/gim, "")
    .replace(/<\/?[^>]+>/g, "")
    .replace(/^\s*aperçu\b.*$/gim, "")
    .replace(/\[[^\]]*\]/g, "")
    .replace(/\*+/g, "")
    .replace(/^-{2,}.*$/gmi, "")
    .replace(/^\s*(note|remarque|important|disclaimer|attention|nb)\b.*$/gmi, "")
    .replace(/^\s*objet\s*:.*$/gmi, "")
    .replace(/^\s*(madame|monsieur|dear)[^\n]*$/gmi, "")
    .replace(/[“”«»]/g, "")
    .replace(/^\s*"+|"+\s*$/gm, "")
    .replace(/\s"+/g, " ")
    .replace(/["+]\s*/g, " ")
    .replace(/[ \t]+\n/g, "\n")
    .replace(/\n{3,}/g, "\n\n")
    .trim();
}

// =============================
// ✅ Date FR/EN (timezone Europe/Paris)
// =============================
function formatLetterDateLine({ city, lang }) {
  const L = normalizeLang(lang);
  const tz = "Europe/Paris";
  const d = new Date();

  if (L === "fr") {
    const dateFr = new Intl.DateTimeFormat("fr-FR", {
      timeZone: tz,
      day: "numeric",
      month: "long",
      year: "numeric",
    }).format(d);

    const c = String(city || "").trim();
    return c ? `À ${c}, ${dateFr}` : `Le ${dateFr}`;
  }

  const dateEn = new Intl.DateTimeFormat("en-GB", {
    timeZone: tz,
    day: "numeric",
    month: "long",
    year: "numeric",
  }).format(d);

  const c = String(city || "").trim();
  return c ? `${c}, ${dateEn}` : `${dateEn}`;
}

function sanitizeCompanyNameForHeader(companyName) {
  let c = String(companyName || "").replace(/\r/g, "").trim();
  if (!c) return "";
  c = c.replace(/\s+/g, " ").trim();
  c = c.replace(/^(service recrutement|recruitment team)\s*[-:|]?\s*/i, "").trim();
  c = c.replace(/(.+?)\s+\1$/i, "$1").trim();
  return c;
}

function uniqueLines(lines) {
  const out = [];
  const seen = new Set();
  for (const l of lines) {
    const s = String(l || "").trim();
    if (!s) continue;
    const k = s.toLowerCase();
    if (seen.has(k)) continue;
    seen.add(k);
    out.push(s);
  }
  return out;
}

function composeFullCoverLetterDoc({ profile, jobTitle, companyName, lang, bodyOnly }) {
  const L = normalizeLang(lang);
  const p = profile || {};

  const fullName = String(p.fullName || "").trim() || (L === "en" ? "The candidate" : "Le candidat");
  const phone = String(p.phone || "").trim();
  const email = String(p.email || "").trim();
  const linkedin = String(p.linkedin || "").trim();
  const city = String(p.city || "").trim();

  const compRaw =
    String(companyName || "").trim() || (L === "en" ? "Your company" : "Votre entreprise");
  const comp = sanitizeCompanyNameForHeader(compRaw) || compRaw;

  const role = String(jobTitle || "").trim() || (L === "en" ? "the position" : "le poste");

  const headerLeft = uniqueLines([
    fullName,
    phone ? (L === "en" ? `Phone: ${phone}` : `${phone}`) : "",
    email ? (L === "en" ? `Email: ${email}` : `${email}`) : "",
    linkedin ? `LinkedIn: ${linkedin}` : "",
  ]).join("\n");

  const headerRightLines = uniqueLines([L === "en" ? "Recruitment Team" : "Service Recrutement", comp]);
  const headerRight = headerRightLines.join("\n");

  const dateLine = formatLetterDateLine({ city, lang: L });
  const subjectLine =
    L === "en" ? `Subject: Application for ${role}` : `Objet : Candidature au poste de ${role}`;

  const greeting = L === "en" ? "Dear Hiring Manager," : "Madame, Monsieur,";
  const closing = L === "en" ? "Sincerely," : "Cordialement,";

  const cleanBody = sanitizeLmBodyFromModel(String(bodyOnly || "")).trim();

  let doc = [
    headerLeft,
    "",
    headerRight,
    "",
    dateLine,
    "",
    subjectLine,
    "",
    greeting,
    "",
    cleanBody,
    "",
    closing,
    "",
    fullName,
  ]
    .join("\n")
    .replace(/\n{3,}/g, "\n\n")
    .trim();

  doc = dedupeClosingBlockAtEnd(doc, L, fullName);
  return doc;
}

function looksLikeFormattedLetterDoc(text) {
  const t = String(text || "").trim();
  if (!t) return false;
  const hasSubject = /(objet\s*:|subject\s*:)/i.test(t);
  const hasGreeting = /(madame,\s+monsieur,|dear\s+)/i.test(t);
  return hasSubject && hasGreeting;
}

// =============================
// reCAPTCHA Enterprise
// =============================
const recaptchaClient = new RecaptchaEnterpriseServiceClient();

function getRecaptchaConfig() {
  const cfg = (functions.config && functions.config() && functions.config().recaptcha) || {};

  const projectId = cfg.project_id || process.env.RECAPTCHA_PROJECT_ID || "";
  const siteKey = cfg.site_key || process.env.RECAPTCHA_SITE_KEY || "";
  const thresholdRaw = cfg.threshold || process.env.RECAPTCHA_THRESHOLD || "0.5";
  const threshold = Number(thresholdRaw);

  const bypassRaw = cfg.bypass || process.env.RECAPTCHA_BYPASS || "false";
  const bypass = String(bypassRaw).toLowerCase() === "true";

  const strictActionRaw = cfg.strict_action || process.env.RECAPTCHA_STRICT_ACTION || "false";
  const strictAction = String(strictActionRaw).toLowerCase() === "true";

  return {
    projectId,
    siteKey,
    threshold: Number.isFinite(threshold) ? threshold : 0.5,
    bypass,
    strictAction,
  };
}

function isEmulator() {
  return process.env.FUNCTIONS_EMULATOR === "true" || !!process.env.FIREBASE_EMULATOR_HUB;
}

function getClientIp(req) {
  const xf = req.headers["x-forwarded-for"];
  if (typeof xf === "string" && xf.trim()) return xf.split(",")[0].trim();

  const ip =
    req.ip ||
    (req.connection && req.connection.remoteAddress) ||
    (req.socket && req.socket.remoteAddress) ||
    "";
  return typeof ip === "string" ? ip : "";
}

// =============================
// AUTH helper (HTTP)
// =============================
function getBearerToken(req) {
  const h = req.headers["authorization"] || req.headers["Authorization"] || "";
  const s = typeof h === "string" ? h : Array.isArray(h) ? h[0] : "";
  if (!s) return "";
  if (s.startsWith("Bearer ")) return s.slice(7).trim();
  return "";
}

async function tryFirebaseUser(req) {
  const token = getBearerToken(req);
  if (!token) return null;
  try {
    const decoded = await admin.auth().verifyIdToken(token);
    return { uid: decoded.uid, email: decoded.email || "" };
  } catch {
    return null;
  }
}

async function requireFirebaseUser(req) {
  const token = getBearerToken(req);
  if (!token) {
    const err = new Error("MISSING_AUTH");
    err.code = "MISSING_AUTH";
    throw err;
  }
  try {
    const decoded = await admin.auth().verifyIdToken(token);
    return { uid: decoded.uid, email: decoded.email || "" };
  } catch {
    const err = new Error("INVALID_AUTH");
    err.code = "INVALID_AUTH";
    throw err;
  }
}

/**
 * ✅ PATCH reCAPTCHA : on remonte aussi hostname + action
 */
async function verifyRecaptchaToken({ token, expectedAction, req }) {
  const { projectId, siteKey, threshold, bypass, strictAction } = getRecaptchaConfig();

  // bypass en dev/emulator
  if (bypass && (isEmulator() || process.env.NODE_ENV !== "production")) {
    return { ok: true, bypass: true, score: null, threshold };
  }

  if (!projectId || !siteKey) {
    console.warn("reCAPTCHA non configuré (project_id / site_key manquants) => bypass.");
    return { ok: true, bypass: true, score: null, threshold };
  }

  if (!token) return { ok: false, reason: "missing_token" };

  try {
    const userIp = getClientIp(req);
    const userAgent = String(req.headers["user-agent"] || "");

    const request = {
      parent: `projects/${projectId}`,
      assessment: {
        event: {
          token,
          siteKey,
          expectedAction: expectedAction || undefined,
          userAgent: userAgent || undefined,
          userIpAddress: userIp || undefined,
        },
      },
    };

    const [response] = await recaptchaClient.createAssessment(request);

    const tokenProps = response && response.tokenProperties;

    if (!tokenProps || tokenProps.valid !== true) {
      return {
        ok: false,
        reason: "invalid_token",
        invalidReason: tokenProps ? tokenProps.invalidReason : null,
        hostname: tokenProps ? tokenProps.hostname : null,
        action: tokenProps ? tokenProps.action : null,
      };
    }

    // action mismatch : bloquant seulement si strictAction=true
    if (expectedAction && tokenProps.action && String(tokenProps.action) !== String(expectedAction)) {
      if (strictAction) {
        return {
          ok: false,
          reason: "action_mismatch",
          got: tokenProps.action,
          expected: expectedAction,
          hostname: tokenProps.hostname || null,
          action: tokenProps.action || null,
        };
      }
      console.warn("reCAPTCHA action mismatch (non bloquant):", {
        got: tokenProps.action,
        expected: expectedAction,
      });
    }

    const score =
      response && response.riskAnalysis && typeof response.riskAnalysis.score === "number"
        ? response.riskAnalysis.score
        : null;

    if (typeof score === "number" && score < threshold) {
      return {
        ok: false,
        reason: "low_score",
        score,
        threshold,
        hostname: tokenProps.hostname || null,
        action: tokenProps.action || null,
      };
    }

    return {
      ok: true,
      score,
      threshold,
      hostname: tokenProps.hostname || null,
      action: tokenProps.action || null,
    };
  } catch (err) {
    console.error("Erreur reCAPTCHA Enterprise:", err);
    return { ok: false, reason: "recaptcha_error" };
  }
}

async function enforceRecaptchaOrReturn(req, res, expectedAction) {
  // ✅ Bypass si l'utilisateur est authentifié
  const authed = await tryFirebaseUser(req);
  if (authed && authed.uid) return null;

  const token =
    (req.body && (req.body.recaptchaToken || req.body.token)) ||
    req.headers["x-recaptcha-token"] ||
    req.headers["x-recaptchatoken"] ||
    "";

  const actionFromBody =
    (req.body && (req.body.recaptchaAction || req.body.actionRecaptcha || req.body.action)) || "";

  const action = expectedAction || actionFromBody || "";

  const result = await verifyRecaptchaToken({
    token: typeof token === "string" ? token : String(token),
    expectedAction: typeof action === "string" ? action : String(action),
    req,
  });

  if (!result.ok) return res.status(403).json({ error: "reCAPTCHA failed", details: result });
  return null;
}

// =============================
// CORS
// =============================
function getAllowedOrigins() {
  const raw =
    process.env.CORS_ALLOW_ORIGINS ||
    (functions.config &&
      functions.config() &&
      functions.config().app &&
      functions.config().app.cors_allow_origins) ||
    "";
  return raw
    .split(",")
    .map((s) => s.trim())
    .filter(Boolean);
}

function setCors(req, res) {
  const origin = req.headers.origin;
  const allowlist = getAllowedOrigins();

  if (origin && allowlist.length > 0) {
    if (allowlist.includes(origin)) {
      res.set("Access-Control-Allow-Origin", origin);
      res.set("Vary", "Origin");
    }
  } else {
    res.set("Access-Control-Allow-Origin", "*");
  }

  res.set("Access-Control-Allow-Methods", "POST, OPTIONS");
  res.set(
    "Access-Control-Allow-Headers",
    "Content-Type, Authorization, Polar-Signature, polar-signature, X-Recaptcha-Token, x-recaptcha-token"
  );
}

// =============================
// Helpers (profil, contrat)
// =============================
function normalizeString(str) {
  if (!str) return "";
  return str
    .toString()
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .toLowerCase();
}

function inferContractTypeStandard(raw) {
  const norm = normalizeString(raw);
  if (!norm) return "";

  if (norm.includes("alternance") || norm.includes("apprentissage")) return "Alternance";
  if (norm.includes("stage") || norm.includes("intern")) return "Stage";
  if (norm.includes("freelance") || norm.includes("independant") || norm.includes("auto-entrepreneur"))
    return "Freelance";
  if (norm.includes("cdd") || norm.includes("duree determinee") || norm.includes("durée determinee"))
    return "CDD";
  if (norm.includes("cdi") || norm.includes("duree indeterminee") || norm.includes("durée indeterminee"))
    return "CDI";
  if (norm.includes("interim") || norm.includes("intérim")) return "Intérim";

  return "";
}

// =============================
// Admin helpers
// =============================
function assertIsAdmin(context) {
  if (!context.auth) {
    throw new functions.https.HttpsError("unauthenticated", "Tu dois être connecté.");
  }

  const token = context.auth.token || {};
  const isAdmin = token.isAdmin === true || token.email === "aakane0105@gmail.com";

  if (!isAdmin) {
    throw new functions.https.HttpsError("permission-denied", "Accès réservé à l'administrateur.");
  }
}

exports.setAdminRole = functions
  .region("europe-west1")
  .https.onCall(async (data, context) => {
    assertIsAdmin(context);

    const uid = data && data.uid;
    const isAdmin = data && data.isAdmin;

    if (!uid || typeof isAdmin !== "boolean") {
      throw new functions.https.HttpsError("invalid-argument", "uid (string) et isAdmin (boolean) sont requis.");
    }

    await admin.auth().setCustomUserClaims(uid, { isAdmin });
    return { success: true, uid, isAdmin };
  });

exports.adminUpdateCredits = functions
  .region("europe-west1")
  .https.onCall(async (data, context) => {
    assertIsAdmin(context);

    const userId = data && data.userId;
    const credits = data && data.credits;

    if (!userId || typeof credits !== "number") {
      throw new functions.https.HttpsError("invalid-argument", "userId (string) et credits (number) sont requis.");
    }

    const userRef = db.collection("users").doc(userId);
    await userRef.set({ credits, updatedAt: admin.firestore.FieldValue.serverTimestamp() }, { merge: true });

    return { success: true, userId, credits };
  });

// ======================================================
// ✅ JSON helpers (robuste) — FIX AI_BAD_JSON
// ======================================================
function normalizeSmartQuotes(s) {
  return String(s || "")
    .replace(/[“”]/g, '"')
    .replace(/[‘’]/g, "'");
}

function stripCodeFences(s) {
  let t = String(s || "").trim();
  if (t.startsWith("```")) {
    t = t.replace(/^```[a-zA-Z]*\s*/, "");
    t = t.replace(/```$/g, "");
  }
  return t.trim();
}

function extractFirstJsonBlock(s) {
  const text = String(s || "");
  const startIdx = text.search(/[\{\[]/);
  if (startIdx === -1) return null;

  const stack = [];
  for (let i = startIdx; i < text.length; i++) {
    const ch = text[i];
    if (ch === "{" || ch === "[") stack.push(ch);
    else if (ch === "}" || ch === "]") {
      const last = stack.pop();
      if (!last) return null;
      if ((last === "{" && ch !== "}") || (last === "[" && ch !== "]")) return null;
      if (stack.length === 0) return text.slice(startIdx, i + 1);
    }
  }
  return null;
}

function repairJsonString(s) {
  let t = normalizeSmartQuotes(s);
  t = t.replace(/,\s*([}\]])/g, "$1");
  return t.trim();
}

function safeJsonParseFromModel(raw) {
  let t = stripCodeFences(raw);
  t = repairJsonString(t);

  try {
    return JSON.parse(t);
  } catch {}

  const extracted = extractFirstJsonBlock(t) || extractFirstJsonBlock(raw);
  if (extracted) {
    const fixed = repairJsonString(stripCodeFences(extracted));
    try {
      return JSON.parse(fixed);
    } catch {}
  }
  return null;
}

// =============================
// Gemini helpers
// =============================
async function callGeminiText(prompt, apiKey, temperature = 0.7, maxOutputTokens = 2400, responseMimeType = null) {
  if (!fetchFn) throw new Error("fetch indisponible. Mets Node 18+.");

  const endpoint = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent";

  const generationConfig = { temperature, maxOutputTokens };
  if (responseMimeType) generationConfig.response_mime_type = responseMimeType;

  const body = {
    contents: [{ role: "user", parts: [{ text: prompt }] }],
    generationConfig,
  };

  const resp = await fetchFn(endpoint, {
    method: "POST",
    headers: { "Content-Type": "application/json", "x-goog-api-key": apiKey },
    body: JSON.stringify(body),
  });

  if (!resp.ok) {
    const errorText = await resp.text();
    throw new Error("Erreur Gemini (texte): " + errorText);
  }

  const data = await resp.json();
  const parts = data?.candidates?.[0]?.content?.parts || [];
  const text = parts
    .map((p) => (typeof p.text === "string" ? p.text : ""))
    .join("\n")
    .trim();

  if (!text) throw new Error("Réponse Gemini (texte) vide");
  return text;
}

async function callGeminiJson(prompt, apiKey, temperature = 0.6, maxOutputTokens = 2200) {
  const raw = await callGeminiText(prompt, apiKey, temperature, maxOutputTokens, "application/json");
  const parsed = safeJsonParseFromModel(raw);
  if (parsed === null || parsed === undefined || typeof parsed !== "object") {
    const err = new Error("AI_BAD_JSON");
    err.code = "AI_BAD_JSON";
    err.raw = raw;
    throw err;
  }
  return parsed;
}

// =============================
// callGeminiWithCv (PDF->JSON)
// =============================
async function callGeminiWithCv(base64Pdf, apiKey) {
  if (!fetchFn) throw new Error("fetch indisponible. Mets Node 18+.");

  const endpoint = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent";

  const body = {
    contents: [
      {
        role: "user",
        parts: [
          { inline_data: { mime_type: "application/pdf", data: base64Pdf } },
          {
            text: `Lis ce CV et renvoie STRICTEMENT un JSON valide avec exactement ce schéma :

{
  "fullName": string,
  "email": string,
  "phone": string,
  "linkedin": string,
  "profileSummary": string,

  "city": string,
  "address": string,

  "contractType": string,
  "contractTypeStandard": string,
  "contractTypeFull": string,
  "primaryDomain": string,
  "secondaryDomains": string[],
  "skills": {
    "sections": [
      { "title": string, "items": string[] }
    ],
    "tools": string[]
  },
  "softSkills": string[],
  "experiences": [
    { "company": string, "role": string, "dates": string, "bullets": string[] }
  ],
  "education": [
    { "school": string, "degree": string, "dates": string }
  ],
  "educationShort": string[],
  "certs": string,
  "langLine": string,
  "hobbies": string[],

  "drivingLicense": string,
  "vehicle": string
}

RÈGLES IMPORTANTES :
- Ne pas inventer.
- Si une info est absente -> "" ou [].
- RENVOIE UNIQUEMENT ce JSON, sans texte autour.
`.trim(),
          },
        ],
      },
    ],
    generationConfig: { response_mime_type: "application/json" },
  };

  const resp = await fetchFn(endpoint, {
    method: "POST",
    headers: { "Content-Type": "application/json", "x-goog-api-key": apiKey },
    body: JSON.stringify(body),
  });

  if (!resp.ok) {
    const errorText = await resp.text();
    throw new Error("Erreur Gemini: " + errorText);
  }

  const data = await resp.json();

  let parsed = null;
  const text = data?.candidates?.[0]?.content?.parts?.[0]?.text;

  if (typeof text === "string" && text.trim()) {
    parsed = safeJsonParseFromModel(text);
    if (!parsed) {
      console.error("JSON Gemini invalide dans le champ text:", text);
      throw new Error("JSON Gemini invalide (Parsing text) : " + text);
    }
  } else {
    parsed = data;
  }

  let sectionsRaw = Array.isArray(parsed?.skills?.sections) ? parsed.skills.sections : [];
  let tools = Array.isArray(parsed?.skills?.tools) ? parsed.skills.tools : [];
  let softSkillsArr = Array.isArray(parsed?.softSkills) ? parsed.softSkills : [];

  const softSeen = new Set();
  softSkillsArr = softSkillsArr
    .filter((s) => typeof s === "string")
    .map((s) => s.trim())
    .filter((s) => {
      const key = s.toLowerCase();
      if (!s || softSeen.has(key)) return false;
      softSeen.add(key);
      return true;
    });

  if (softSkillsArr.length > 0) {
    let idx = sectionsRaw.findIndex(
      (sec) => sec && typeof sec.title === "string" && /soft|transversal|comportement|relationnel/i.test(sec.title)
    );

    if (idx === -1) {
      sectionsRaw.push({ title: "Soft skills", items: softSkillsArr });
    } else {
      const items = Array.isArray(sectionsRaw[idx].items) ? sectionsRaw[idx].items : [];
      const seenLocal = new Set(items.filter((x) => typeof x === "string").map((x) => x.toLowerCase().trim()));
      sectionsRaw[idx].items = [...items, ...softSkillsArr.filter((s) => !seenLocal.has(s.toLowerCase().trim()))];
    }
  }

  const sections = sectionsRaw
    .map((sec) => {
      const seen = new Set();
      const items = Array.isArray(sec.items) ? sec.items : [];
      const cleanItems = [];
      for (const raw of items) {
        if (typeof raw !== "string") continue;
        const trimmed = raw.trim();
        const key = trimmed.toLowerCase();
        if (!trimmed || seen.has(key)) continue;
        seen.add(key);
        cleanItems.push(trimmed);
      }
      return {
        title: typeof sec.title === "string" ? sec.title.trim() : "",
        items: cleanItems,
      };
    })
    .filter((sec) => sec.title || sec.items.length);

  const cleanTools = [];
  const seenTools = new Set();
  for (const raw of tools) {
    if (typeof raw !== "string") continue;
    const trimmed = raw.trim();
    const key = trimmed.toLowerCase();
    if (!trimmed || seenTools.has(key)) continue;
    seenTools.add(key);
    cleanTools.push(trimmed);
  }
  tools = cleanTools;

  const sectionItemSet = new Set();
  sections.forEach((sec) => sec.items.forEach((it) => sectionItemSet.add(String(it).toLowerCase())));
  tools = tools.filter((t) => !sectionItemSet.has(String(t).toLowerCase()));

  const contractTypeFull = parsed?.contractTypeFull || parsed?.contractType || "";
  let contractTypeStandard = parsed?.contractTypeStandard || "";
  if (!contractTypeStandard) contractTypeStandard = inferContractTypeStandard(contractTypeFull);
  const contractTypeFinal = contractTypeStandard || contractTypeFull || "";

  return {
    fullName: parsed?.fullName || "",
    email: parsed?.email || "",
    phone: parsed?.phone || "",
    linkedin: parsed?.linkedin || "",
    profileSummary: parsed?.profileSummary || "",
    city: parsed?.city || "",
    address: parsed?.address || "",
    contractType: contractTypeFinal,
    contractTypeStandard,
    contractTypeFull,
    primaryDomain: parsed?.primaryDomain || "",
    secondaryDomains: Array.isArray(parsed?.secondaryDomains) ? parsed.secondaryDomains : [],
    softSkills: softSkillsArr,
    drivingLicense: parsed?.drivingLicense || "",
    vehicle: parsed?.vehicle || "",
    skills: { sections, tools },
    experiences: Array.isArray(parsed?.experiences) ? parsed.experiences : [],
    education: Array.isArray(parsed?.education) ? parsed.education : [],
    educationShort: Array.isArray(parsed?.educationShort) ? parsed.educationShort : [],
    certs: parsed?.certs || "",
    langLine: parsed?.langLine || "",
    hobbies: Array.isArray(parsed?.hobbies) ? parsed.hobbies : [],
  };
}

// =============================
// Build profile context for IA
// =============================
function buildProfileContextForIA(profile) {
  const p = profile || {};

  let skillsArr;
  if (Array.isArray(p.skills)) {
    skillsArr = p.skills;
  } else if (p.skills && typeof p.skills === "object") {
    skillsArr = [];
    if (Array.isArray(p.skills.sections)) {
      p.skills.sections.forEach((sec) => {
        if (Array.isArray(sec.items)) skillsArr = skillsArr.concat(sec.items);
      });
    }
    if (Array.isArray(p.skills.tools)) skillsArr = skillsArr.concat(p.skills.tools);
  } else {
    skillsArr = [];
  }

  const skillsStr = (skillsArr || []).join(", ");

  const expStr = Array.isArray(p.experiences)
    ? p.experiences
        .map(
          (e) =>
            `${e.role || e.title || ""} chez ${e.company || ""} (${e.dates || ""}): ${(e.bullets || []).join(" ")}`
        )
        .join("; \n")
    : "";

  const eduStr = Array.isArray(p.education)
    ? p.education
        .map((e) => `${e.degree || e.title || ""} - ${e.school || e.institution || ""} (${e.dates || ""})`)
        .join("; \n")
    : "";

  return `Nom: ${p.fullName || p.name || ""}
Contact: ${p.email || ""} | ${p.phone || ""} | ${p.linkedin || ""} | ${p.city || ""}
Résumé de profil: ${p.profileSummary || p.summary || ""}
Compétences: ${skillsStr}
Expériences:
${expStr}
Formations:
${eduStr}
Certifications: ${p.certs || ""}
Langues: ${p.langLine || p.lang || ""}`.trim();
}

// =============================
// ✅ CV tailoring via IA (optionnel)
// =============================
async function tailorCvForJob({ profile, jobTitle, companyName, jobDescription, lang, apiKey }) {
  try {
    const cvText = buildProfileContextForIA(profile);

    const prompt = buildCvTailorPrompt({
      lang,
      cvText,
      jobTitle,
      companyName,
      jobDescription: sanitizeJobDescription(jobDescription),
    });

    const parsed = await callGeminiJson(prompt, apiKey, 0.4, 1200);

    const tailoredSummary = typeof parsed?.tailoredSummary === "string" ? parsed.tailoredSummary.trim() : "";
    const tailoredKeySkills = Array.isArray(parsed?.tailoredKeySkills)
      ? parsed.tailoredKeySkills
          .map((x) => String(x).trim())
          .filter(Boolean)
          .slice(0, 14)
      : [];

    return { tailoredSummary, tailoredKeySkills };
  } catch (e) {
    console.warn("tailorCvForJob (IA) failed:", e?.message || e);
    return { tailoredSummary: "", tailoredKeySkills: [] };
  }
}

// =============================
// PDF helpers (CV)
// =============================
async function createSimpleCvPdf(profile, options) {
  const {
    targetJob = "",
    lang = "fr",
    contract = "",
    jobLink = "",
    jobDescription = "",
    tailoredSummary = "",
    tailoredKeySkills = [],
  } = options || {};

  const p = profile || {};
  const pdfDoc = await PDFDocument.create();
  const page = pdfDoc.addPage([595.28, 841.89]); // A4
  const font = await pdfDoc.embedFont(StandardFonts.Helvetica);
  const fontBold = await pdfDoc.embedFont(StandardFonts.HelveticaBold);

  const { width, height } = page.getSize();
  const marginX = 50;
  let y = height - 60;

  function drawLine(text, size = 11, bold = false) {
    if (!text || y < 50) return;
    const f = bold ? fontBold : font;
    page.drawText(text, { x: marginX, y, size, font: f, color: rgb(0.1, 0.12, 0.16) });
    y -= size + 4;
  }

  function drawParagraph(text, size = 10) {
    if (!text) return;
    const f = font;
    const maxWidth = width - marginX * 2;
    const paragraphs = String(text).split(/\n{2,}/);

    for (const paragraph of paragraphs) {
      const words = paragraph.split(/\s+/);
      let line = "";

      for (const w of words) {
        const testLine = line ? line + " " + w : w;
        const testWidth = f.widthOfTextAtSize(testLine, size);
        if (testWidth > maxWidth) {
          if (y < 50) return;
          page.drawText(line, {
            x: marginX,
            y,
            size,
            font: f,
            color: rgb(0.1, 0.12, 0.16),
          });
          y -= size + 3;
          line = w;
        } else {
          line = testLine;
        }
      }

      if (line && y >= 50) {
        page.drawText(line, { x: marginX, y, size, font: f, color: rgb(0.1, 0.12, 0.16) });
        y -= size + 6;
      }
      y -= 2;
    }
  }

  function drawSectionTitle(title) {
    if (!title || y < 60) return;
    page.drawText(title, {
      x: marginX,
      y,
      size: 11,
      font: fontBold,
      color: rgb(0.08, 0.15, 0.45),
    });
    y -= 14;
  }

  function drawBullet(text, size = 9) {
    if (!text || y < 50) return;
    const f = font;
    const bulletX = marginX + 8;
    const maxWidth = width - marginX * 2 - 10;
    const words = String(text).split(/\s+/);
    let line = "";
    let firstLine = true;

    for (const w of words) {
      const testLine = line ? line + " " + w : w;
      const testWidth = f.widthOfTextAtSize(testLine, size);
      if (testWidth > maxWidth) {
        if (y < 50) return;
        page.drawText(firstLine ? "• " + line : "  " + line, {
          x: bulletX,
          y,
          size,
          font: f,
          color: rgb(0.1, 0.12, 0.16),
        });
        y -= size + 3;
        line = w;
        firstLine = false;
      } else {
        line = testLine;
      }
    }

    if (line && y >= 50) {
      page.drawText(firstLine ? "• " + line : "  " + line, {
        x: bulletX,
        y,
        size,
        font: f,
        color: rgb(0.1, 0.12, 0.16),
      });
      y -= size + 3;
    }
  }

  drawLine(p.fullName || "", 16, true);
  const jobLine =
    targetJob || contract || p.contractType || (lang === "en" ? "Target position" : "Poste recherché");
  drawLine(jobLine, 11, false);

  const contactParts = [p.email || "", p.phone || "", p.city || "", p.linkedin || ""].filter(Boolean);
  if (contactParts.length) drawLine(contactParts.join(" · "), 9, false);
  if (jobLink) drawLine((lang === "en" ? "Job link: " : "Lien de l'offre : ") + jobLink, 8, false);

  y -= 6;

  const summaryToUse = tailoredSummary || p.profileSummary;
  if (summaryToUse) {
    drawSectionTitle(lang === "en" ? "Profile" : "Profil");
    drawParagraph(summaryToUse, 9.5);
    y -= 4;
  }

  if (Array.isArray(tailoredKeySkills) && tailoredKeySkills.length) {
    drawSectionTitle(lang === "en" ? "Targeted skills" : "Compétences ciblées");
    drawParagraph(tailoredKeySkills.join(" · "), 9);
    y -= 4;
  }

  if (p.skills && Array.isArray(p.skills.sections) && p.skills.sections.length) {
    drawSectionTitle(lang === "en" ? "Key skills" : "Compétences clés");
    p.skills.sections.forEach((sec) => {
      if (!sec || (!sec.title && !Array.isArray(sec.items))) return;
      if (sec.title) drawLine(sec.title, 9.5, true);
      if (Array.isArray(sec.items)) drawParagraph(sec.items.join(" · "), 9);
      y -= 2;
    });
  }

  if (Array.isArray(p.experiences) && p.experiences.length) {
    drawSectionTitle(lang === "en" ? "Experience" : "Expériences professionnelles");
    p.experiences.forEach((exp) => {
      if (y < 90) return;
      const header = [exp.role, exp.company].filter(Boolean).join(" — ");
      if (header) drawLine(header, 10, true);
      if (exp.dates) drawLine(exp.dates, 8.5, false);
      if (Array.isArray(exp.bullets)) exp.bullets.slice(0, 4).forEach((b) => drawBullet(b, 8.5));
      y -= 4;
    });
  }

  if (Array.isArray(p.education) && p.education.length && y > 80) {
    drawSectionTitle(lang === "en" ? "Education" : "Formation");
    p.education.forEach((ed) => {
      if (y < 60) return;
      const header = [ed.degree, ed.school].filter(Boolean).join(" — ");
      if (header) drawLine(header, 9.5, true);
      if (ed.dates) drawLine(ed.dates, 8.5, false);
      y -= 4;
    });
  }

  if (p.langLine && y > 60) {
    drawSectionTitle(lang === "en" ? "Languages" : "Langues");
    drawParagraph(p.langLine, 9);
  }

  if (Array.isArray(p.hobbies) && p.hobbies.length && y > 60) {
    drawSectionTitle(lang === "en" ? "Interests" : "Centres d'intérêt");
    drawParagraph(p.hobbies.join(" · "), 9);
  }

  const pdfBytes = await pdfDoc.save();
  return Buffer.from(pdfBytes);
}

// =============================
// PDF helper (Lettre)
// =============================
async function createLetterPdf(coverLetterFull, meta) {
  const { jobTitle = "", companyName = "", candidateName = "", lang = "fr" } = meta || {};

  let letterText = String(coverLetterFull || "").trim();
  letterText = dedupeClosingBlockAtEnd(letterText, lang, candidateName);

  const pdfDoc = await PDFDocument.create();
  const page = pdfDoc.addPage([595.28, 841.89]); // A4
  const font = await pdfDoc.embedFont(StandardFonts.Helvetica);
  const fontBold = await pdfDoc.embedFont(StandardFonts.HelveticaBold);

  const { width, height } = page.getSize();
  const marginX = 60;
  let y = height - 70;

  function drawLine(text, size = 11, bold = false) {
    if (!text || y < 60) return;
    const f = bold ? fontBold : font;
    page.drawText(text, { x: marginX, y, size, font: f, color: rgb(0.15, 0.17, 0.23) });
    y -= size + 4;
  }

  function drawParagraph(text, size = 11) {
    if (!text) return;
    const f = font;
    const maxWidth = width - marginX * 2;
    const paragraphs = String(text).split(/\n{2,}/);

    for (const paragraph of paragraphs) {
      const words = paragraph.split(/\s+/);
      let line = "";

      for (const w of words) {
        const testLine = line ? line + " " + w : w;
        const testWidth = f.widthOfTextAtSize(testLine, size);
        if (testWidth > maxWidth) {
          if (y < 60) return;
          page.drawText(line, { x: marginX, y, size, font: f, color: rgb(0.15, 0.17, 0.23) });
          y -= size + 4;
          line = w;
        } else {
          line = testLine;
        }
      }

      if (line && y >= 60) {
        page.drawText(line, { x: marginX, y, size, font: f, color: rgb(0.15, 0.17, 0.23) });
        y -= size + 8;
      }
      y -= 4;
    }
  }

  const alreadyFormatted = looksLikeFormattedLetterDoc(letterText);

  if (!alreadyFormatted) {
    if (candidateName) drawLine(candidateName, 14, true);

    if (jobTitle || companyName) {
      const titleLine =
        lang === "en"
          ? `Application for ${jobTitle || "the position"} – ${companyName || "Company"}`
          : `Candidature : ${jobTitle || "poste"} – ${companyName || "Entreprise"}`;
      drawLine(titleLine, 11, false);
    }

    y -= 10;
  }

  drawParagraph(letterText, 11);

  const pdfBytes = await pdfDoc.save();
  return Buffer.from(pdfBytes);
}

// ======================================================
// Fallback lettre/pitch (BODY ONLY)
// ======================================================
function buildFallbackLetterAndPitchBody(profile, jobTitle, companyName, jobDescription, lang) {
  const p = profile || {};
  const companyLabel = companyName || (lang === "en" ? "your company" : "votre entreprise");
  const roleLabel = jobTitle || (lang === "en" ? "the role" : "le poste");
  const experiences = Array.isArray(p.experiences) ? p.experiences : [];

  const flatSkills = [];
  if (p.skills) {
    if (Array.isArray(p.skills)) flatSkills.push(...p.skills);
    else {
      if (Array.isArray(p.skills.sections)) {
        p.skills.sections.forEach((sec) => Array.isArray(sec.items) && flatSkills.push(...sec.items));
      }
      if (Array.isArray(p.skills.tools)) flatSkills.push(...p.skills.tools);
    }
  }

  const mainSkills = flatSkills
    .filter((x) => typeof x === "string")
    .map((x) => x.trim())
    .filter(Boolean)
    .slice(0, 8)
    .join(", ");

  const xp1 = experiences[0];
  const xp2 = experiences[1];

  function xpLineFr(xp) {
    if (!xp) return "";
    const company = xp.company || "";
    const role = xp.role || xp.title || "";
    const dates = xp.dates || "";
    const bullet = Array.isArray(xp.bullets) && xp.bullets.length ? xp.bullets[0] : "";
    const base = [role, company].filter(Boolean).join(" chez ");
    const meta = [dates].filter(Boolean).join(" · ");
    const bulletPart = bullet ? ` (ex: ${bullet})` : "";
    return `${base}${meta ? ` — ${meta}` : ""}${bulletPart}`;
  }

  function xpLineEn(xp) {
    if (!xp) return "";
    const company = xp.company || "";
    const role = xp.role || xp.title || "";
    const dates = xp.dates || "";
    const bullet = Array.isArray(xp.bullets) && xp.bullets.length ? xp.bullets[0] : "";
    const base = [role, company].filter(Boolean).join(" at ");
    const meta = [dates].filter(Boolean).join(" · ");
    const bulletPart = bullet ? ` (e.g. ${bullet})` : "";
    return `${base}${meta ? ` — ${meta}` : ""}${bulletPart}`;
  }

  const jdClean = sanitizeJobDescription(jobDescription || "");
  const hasJd = !!(jdClean && jdClean.trim());

  if (lang === "en") {
    const body = [
      `I am applying for the ${roleLabel} position at ${companyLabel}. My background has given me strong experience with ${
        mainSkills || "security, delivery, and collaboration"
      } and a practical, operational approach.`,
      "",
      xp1 || xp2
        ? `Recently, I worked on concrete projects such as: ${[xpLineEn(xp1), xpLineEn(xp2)].filter(Boolean).join(
            " | "
          )}.`
        : `In my recent roles, I delivered end-to-end tasks with a focus on reliability and security.`,
      "",
      hasJd
        ? `Your needs described in the job posting align with my skills and motivation. I am eager to contribute with pragmatic, maintainable improvements.`
        : `The responsibilities of this role align with my experience and my motivation to contribute.`,
      "",
      `I would be happy to discuss how I can contribute to your projects.`,
    ].join("\n");

    const pitch =
      (p.profileSummary && String(p.profileSummary).trim()) ||
      `Motivated candidate applying for ${roleLabel} at ${companyLabel}, with practical skills in ${
        mainSkills || "security and delivery"
      }.`;

    return { body, pitch };
  }

  const bodyFr = [
    `Je souhaite vous proposer ma candidature au poste de ${roleLabel} au sein de ${companyLabel}. Mon parcours m’a permis de développer une expertise solide sur ${
      mainSkills || "la sécurité, le delivery et la collaboration"
    }, avec une approche orientée résultats.`,
    "",
    xp1 || xp2
      ? `Au cours de mes dernières expériences, j’ai mené des missions concrètes, notamment : ${[
          xpLineFr(xp1),
          xpLineFr(xp2),
        ]
          .filter(Boolean)
          .join(" | ")}.`
      : `Au cours de mes expériences, j’ai pris en charge des missions de bout en bout avec un objectif de fiabilité et de sécurité.`,
    "",
    hasJd
      ? `Les missions décrites dans votre offre font écho à mon parcours : je peux contribuer avec des actions pragmatiques, maintenables et orientées service.`
      : `Les responsabilités associées à ce poste correspondent à mon objectif : contribuer avec des actions pragmatiques et maintenables.`,
    "",
    `Je serais ravi d’échanger pour détailler la manière dont je peux contribuer à vos projets.`,
  ].join("\n");

  const pitchFr =
    (p.profileSummary && String(p.profileSummary).trim()) ||
    `Candidat(e) motivé(e) pour le poste de ${roleLabel} chez ${companyLabel}, avec des compétences en ${
      mainSkills || "sécurité et delivery"
    }.`;

  return { body: bodyFr, pitch: pitchFr };
}

// =============================
// extractProfile (PDF base64) ✅
// =============================
exports.extractProfile = functions
  .runWith({ secrets: ["GEMINI_API_KEY"] })
  .region("europe-west1")
  .https.onRequest(async (req, res) => {
    setCors(req, res);

    if (req.method === "OPTIONS") return res.status(204).send("");
    if (req.method !== "POST") return res.status(405).json({ error: "Méthode non autorisée" });
    if (!req.is("application/json")) return res.status(400).json({ error: "Content-Type invalide. Envoie du JSON." });

    const deny = await enforceRecaptchaOrReturn(req, res, "extract_profile");
    if (deny) return;

    try {
      const base64Pdf = req.body?.base64Pdf;
      if (!base64Pdf) return res.status(400).json({ error: "Champ 'base64Pdf' manquant." });

      const GEMINI_API_KEY = process.env.GEMINI_API_KEY;
      if (!GEMINI_API_KEY) {
        return res.status(500).json({
          error: "Clé Gemini manquante côté serveur. Configure le secret GEMINI_API_KEY.",
        });
      }

      const profile = await callGeminiWithCv(base64Pdf, GEMINI_API_KEY);
      return res.status(200).json(profile);
    } catch (err) {
      console.error("Erreur analyse CV :", err);
      const msg = String(err?.message || "");
      return res.status(500).json({
        error: msg.startsWith("Erreur Gemini:") ? msg : "Erreur pendant l'analyse du CV.",
      });
    }
  });

// =============================
// generateLetterAndPitch ✅ (IA JSON strict + bodyOnly + lettre format exemple)
// =============================
exports.generateLetterAndPitch = functions
  .runWith({ secrets: ["GEMINI_API_KEY"] })
  .region("europe-west1")
  .https.onRequest(async (req, res) => {
    setCors(req, res);

    if (req.method === "OPTIONS") return res.status(204).send("");
    if (req.method !== "POST") return res.status(405).json({ error: "Méthode non autorisée" });
    if (!req.is("application/json"))
      return res.status(400).json({ error: "Content-Type invalide. Envoie du JSON." });

    const deny = await enforceRecaptchaOrReturn(req, res, "generate_letter_pitch");
    if (deny) return;

    try {
      const body = req.body || {};
      const profile = body.profile;
      const jobDescriptionRaw = body.jobDescription || "";
      const jobTitle = (body.jobTitle || "").toString().trim();
      const companyName = (body.companyName || "").toString().trim();
      const lang = normalizeLang(body.lang || "fr");

      if (!profile) return res.status(400).json({ error: "Champ 'profile' manquant." });
      if (!jobTitle && !jobDescriptionRaw) {
        return res.status(400).json({
          error: "Ajoute au moins l'intitulé du poste ou un extrait de la description.",
        });
      }

      const GEMINI_API_KEY = process.env.GEMINI_API_KEY;
      if (!GEMINI_API_KEY) {
        return res.status(503).json({
          error: "AI_UNAVAILABLE",
          message: "IA indisponible (GEMINI_API_KEY manquant).",
        });
      }

      const jobDescription = sanitizeJobDescription(jobDescriptionRaw || "");
      const cvText = buildProfileContextForIA(profile);

      const prompt = buildLetterAndPitchPrompt({
        lang,
        cvText,
        jobDescription,
        jobTitle: jobTitle || (lang === "en" ? "the role" : "le poste"),
        companyName: companyName || (lang === "en" ? "your company" : "votre entreprise"),
      });

      let coverLetterBody = "";
      let pitch = "";

      try {
        const parsed = await callGeminiJson(prompt, GEMINI_API_KEY, 0.55, 1800);
        coverLetterBody = typeof parsed?.coverLetterBody === "string" ? parsed.coverLetterBody.trim() : "";
        pitch = typeof parsed?.pitch === "string" ? parsed.pitch.trim() : "";
      } catch (e) {
        console.error("Gemini JSON letter/pitch failed:", e?.message || e);
      }

      if (!coverLetterBody || !pitch) {
        const fb = buildFallbackLetterAndPitchBody(profile, jobTitle, companyName, jobDescription, lang);
        if (!coverLetterBody) coverLetterBody = fb.body;
        if (!pitch) pitch = fb.pitch;
      }

      const cleanedFromModel = sanitizeLmBodyFromModel(coverLetterBody);
      const bodyOnly = sanitizeLmBodyOnly(cleanedFromModel, lang, profile?.fullName || "");

      if (!bodyOnly) {
        return res.status(502).json({ error: "AI_EMPTY", message: "Lettre vide après nettoyage." });
      }

      const coverLetter = composeFullCoverLetterDoc({
        profile,
        jobTitle,
        companyName,
        lang,
        bodyOnly,
      });

      return res.status(200).json({
        lang,
        letterBody: bodyOnly,
        coverLetter,
        pitch,
      });
    } catch (err) {
      console.error("Erreur generateLetterAndPitch:", err);
      return res.status(500).json({ error: err?.message || "Erreur interne." });
    }
  });

// =============================
// Interview (simulation) ✅ IA
// =============================
const INTERVIEW_QUESTION_PLAN = {
  complet: 8,
  rapide: 4,
  technique: 6,
  comportemental: 6,
};

function createInterviewSessionId() {
  return Math.random().toString(36).slice(2) + "-" + Date.now().toString(36);
}

const interviewSessions = new Map();

function extractInterviewJson(raw) {
  if (!raw || typeof raw !== "string") return null;
  let t = raw.trim();

  if (t.startsWith("```")) {
    t = t.replace(/^```[a-zA-Z]*\s*/, "").replace(/```$/, "").trim();
  }

  const direct = safeJsonParseFromModel(t);
  if (direct && typeof direct === "object") return direct;

  const match = t.match(/\{[\s\S]*\}/);
  if (match) {
    const inner = safeJsonParseFromModel(match[0]);
    if (inner && typeof inner === "object") return inner;
  }
  return null;
}

function buildInterviewPrompt(session, lastUserAnswer) {
  const total = session.totalQuestions || 8;
  const step = session.currentStep || 1;

  const modeLabelMap = {
    complet: "entretien complet (général + motivation + compétences)",
    rapide: "entretien flash (questions essentielles)",
    technique: "entretien focalisé sur les compétences techniques",
    comportemental: "entretien focalisé sur les soft skills / situations",
  };

  const modeLabel = modeLabelMap[session.interviewMode] || "entretien général";

  const historyLines = (session.history || [])
    .map((h) => {
      const who = h.role === "candidate" ? "Candidat" : "Recruteur";
      return `- ${who} : ${h.text}`;
    })
    .join("\n");

  const base = `Tu es un recruteur humain expérimenté qui mène un entretien d'embauche en FRANÇAIS pour le poste suivant :

Intitulé du poste : ${session.jobTitle || "(non précisé)"}
Contexte / description du poste : ${session.jobDesc || "(non précisé)"}

Mode d'entretien : ${modeLabel}.
Niveau de difficulté : ${session.difficulty || "standard"}.

Tu mènes un entretien structuré avec environ ${total} questions maximum.`;

  const histBlock = historyLines
    ? `Historique de l'entretien (questions / réponses) :
${historyLines}`
    : `L'entretien commence, tu vas poser la première question.`;

  const stepInfo = `Nous en sommes à l'étape ${step} sur ${total}.
${lastUserAnswer ? `Dernière réponse du candidat : "${lastUserAnswer}".` : ""}

SI nous ne sommes PAS à la dernière étape (étape < ${total}) :
1) Analyse très brièvement la réponse précédente du candidat (ou son profil au démarrage).
2) Propose la prochaine question d'entretien adaptée au poste.

SI nous SOMMES à la dernière étape (étape >= ${total}) :
1) Fais un bilan synthétique (points forts / axes d'amélioration).
2) Donne un score global sur 100 (final_score).

Ta RÉPONSE DOIT être STRICTEMENT un objet JSON VALIDE, sans aucun texte autour, EXACTEMENT :

{
  "next_question": "string ou null",
  "short_analysis": "string",
  "final_summary": "string ou null",
  "final_score": nombre ou null
}`;

  return `${base}\n\n${histBlock}\n\n${stepInfo}`;
}

exports.interview = functions
  .runWith({ secrets: ["GEMINI_API_KEY"] })
  .region("europe-west1")
  .https.onRequest(async (req, res) => {
    setCors(req, res);

    if (req.method === "OPTIONS") return res.status(204).send("");
    if (req.method !== "POST") return res.status(405).json({ error: "Méthode non autorisée" });
    if (!req.is("application/json"))
      return res.status(400).json({ error: "Content-Type invalide. Envoie du JSON." });

    const deny = await enforceRecaptchaOrReturn(req, res, "interview");
    if (deny) return;

    try {
      const body = req.body || {};
      const action = body.action;

      if (!action)
        return res.status(400).json({ error: "Champ 'action' manquant ('start' ou 'answer')." });

      const GEMINI_API_KEY = process.env.GEMINI_API_KEY;

      if (action === "start") {
        const userId = body.userId || "";
        const jobTitle = body.jobTitle || "";
        const jobDesc = sanitizeJobDescription(body.jobDesc || "");
        const interviewMode = body.interviewMode || "complet";
        const difficulty = body.difficulty || "standard";

        if (!userId) return res.status(400).json({ error: "Champ 'userId' manquant." });

        const totalQuestions = INTERVIEW_QUESTION_PLAN[interviewMode] || INTERVIEW_QUESTION_PLAN.complet;
        const sessionId = createInterviewSessionId();
        const nowIso = new Date().toISOString();

        const session = {
          sessionId,
          userId,
          jobTitle,
          jobDesc,
          interviewMode,
          difficulty,
          totalQuestions,
          currentStep: 1,
          history: [],
          createdAt: nowIso,
          updatedAt: nowIso,
          finished: false,
        };

        interviewSessions.set(sessionId, session);

        let nextQuestion = null;
        let shortAnalysis = "";
        let finalSummary = null;
        let finalScore = null;

        try {
          if (!GEMINI_API_KEY) throw new Error("GEMINI_API_KEY manquante");

          const prompt = buildInterviewPrompt(session, null);
          const raw = await callGeminiText(prompt, GEMINI_API_KEY, 0.6, 1200, "application/json");

          const parsed = extractInterviewJson(raw) || {};
          if (typeof parsed.next_question === "string" && parsed.next_question.trim())
            nextQuestion = parsed.next_question.trim();
          if (typeof parsed.short_analysis === "string") shortAnalysis = parsed.short_analysis.trim();
          if (typeof parsed.final_summary === "string" && parsed.final_summary.trim())
            finalSummary = parsed.final_summary.trim();
          if (typeof parsed.final_score === "number" || typeof parsed.final_score === "string") {
            const num = Number(parsed.final_score);
            if (!Number.isNaN(num)) finalScore = num;
          }
        } catch (err) {
          console.error("Erreur Gemini (interview/start):", err);
        }

        if (!nextQuestion) {
          nextQuestion = jobTitle
            ? `Bonjour ! Pour commencer, pouvez-vous vous présenter et m'expliquer pourquoi vous ciblez le poste de ${jobTitle} ?`
            : "Bonjour ! Pour commencer, pouvez-vous vous présenter en quelques phrases ?";
          if (!shortAnalysis)
            shortAnalysis = "Mode dégradé sans analyse IA détaillée (erreur ou quota Gemini).";
        }

        session.history.push({ role: "interviewer", text: nextQuestion, createdAt: nowIso });
        if (finalSummary) session.finished = true;

        session.updatedAt = new Date().toISOString();
        interviewSessions.set(sessionId, session);

        return res.status(200).json({
          sessionId,
          step: session.currentStep,
          totalQuestions: session.totalQuestions,
          next_question: nextQuestion,
          short_analysis: shortAnalysis,
          final_summary: finalSummary,
          final_score: finalScore,
        });
      }

      if (action === "answer") {
        const userId = body.userId || "";
        const sessionId = body.sessionId || "";
        const userMessage = (body.userMessage || "").toString().trim();

        if (!userId || !sessionId || !userMessage) {
          return res.status(400).json({
            error: "Champs 'userId', 'sessionId' ou 'userMessage' manquants.",
          });
        }

        const session = interviewSessions.get(sessionId);
        if (!session) {
          return res.status(404).json({
            error: "Session d'entretien introuvable ou expirée (instance de fonction différente).",
          });
        }

        if (session.userId && session.userId !== userId) {
          return res.status(403).json({ error: "Cette session ne correspond pas à cet utilisateur." });
        }

        session.history.push({
          role: "candidate",
          text: userMessage,
          createdAt: new Date().toISOString(),
        });

        const nextStep = Math.min(
          (session.currentStep || 1) + 1,
          session.totalQuestions || INTERVIEW_QUESTION_PLAN.complet
        );
        session.currentStep = nextStep;

        let nextQuestion = null;
        let shortAnalysis = "";
        let finalSummary = null;
        let finalScore = null;

        try {
          if (!GEMINI_API_KEY) throw new Error("GEMINI_API_KEY manquante");

          const prompt = buildInterviewPrompt(session, userMessage);
          const raw = await callGeminiText(prompt, GEMINI_API_KEY, 0.6, 1200, "application/json");

          const parsed = extractInterviewJson(raw) || {};
          if (typeof parsed.next_question === "string" && parsed.next_question.trim())
            nextQuestion = parsed.next_question.trim();
          if (typeof parsed.short_analysis === "string") shortAnalysis = parsed.short_analysis.trim();
          if (typeof parsed.final_summary === "string" && parsed.final_summary.trim())
            finalSummary = parsed.final_summary.trim();
          if (typeof parsed.final_score === "number" || typeof parsed.final_score === "string") {
            const num = Number(parsed.final_score);
            if (!Number.isNaN(num)) finalScore = num;
          }
        } catch (err) {
          console.error("Erreur Gemini (interview/answer):", err);
        }

        const isLastStep = session.currentStep >= (session.totalQuestions || INTERVIEW_QUESTION_PLAN.complet);

        if (!nextQuestion && !finalSummary) {
          if (isLastStep) {
            nextQuestion = "Merci pour tes réponses, l'entretien est terminé.";
            finalSummary =
              "Mode dégradé : le bilan détaillé n'a pas pu être généré car l'API IA n'était pas disponible.";
          } else {
            nextQuestion =
              "Merci pour ta réponse. Peux-tu me donner un exemple encore plus concret en lien avec ce poste ?";
            shortAnalysis = shortAnalysis || "Mode dégradé sans analyse IA détaillée (erreur ou quota Gemini).";
          }
        }

        if (nextQuestion) {
          session.history.push({
            role: "interviewer",
            text: nextQuestion,
            createdAt: new Date().toISOString(),
          });
        }

        if (finalSummary || isLastStep) session.finished = true;

        session.updatedAt = new Date().toISOString();
        interviewSessions.set(sessionId, session);

        return res.status(200).json({
          sessionId,
          step: session.currentStep,
          totalQuestions: session.totalQuestions,
          next_question: nextQuestion,
          short_analysis: shortAnalysis,
          final_summary: finalSummary,
          final_score: finalScore,
        });
      }

      return res.status(400).json({ error: "Action invalide. Utilise 'start' ou 'answer'." });
    } catch (err) {
      console.error("Erreur interne /interview:", err);
      return res.status(500).json({ error: "Erreur interne lors de la simulation d'entretien." });
    }
  });

// =============================
// generateInterviewQA ✅ IA
// =============================
function buildFallbackQuestions(lang, role, company, city, dates, bullets) {
  const missions = (Array.isArray(bullets) ? bullets : []).filter((b) => typeof b === "string").slice(0, 3);

  if (lang === "en") {
    return [
      {
        question: `Can you describe your role as ${role} at ${company}?`,
        answer: `In my position as ${role} at ${company}${city ? " in " + city : ""}${
          dates ? " (" + dates + ")" : ""
        }, I was responsible for ${missions[0] || "several key tasks related to this role"}.`,
      },
      {
        question: `Tell me about a concrete achievement in this role.`,
        answer: missions[1] ? `One strong achievement was: ${missions[1]}` : `One of my main achievements was delivering key tasks with measurable impact.`,
      },
      {
        question: `Which tools or technologies did you use most often?`,
        answer: missions[2] ? `I regularly used tools/technologies such as: ${missions[2]}.` : `I used the main tools and workflows of the role on a daily basis.`,
      },
    ];
  }

  return [
    {
      question: `Pouvez-vous me décrire votre rôle de ${role} chez ${company} ?`,
      answer: `Dans ce poste de ${role} chez ${company}${city ? " à " + city : ""}${dates ? " (" + dates + ")" : ""}, j'étais principalement en charge de ${
        missions[0] || "missions clés en lien avec le poste (projets, coordination, suivi, etc.)"
      }.`,
    },
    {
      question: `Parlez-moi d'une réalisation concrète dont vous êtes fier(e).`,
      answer: missions[1] ? `Une réalisation marquante : ${missions[1]}` : `Une de mes réalisations majeures a eu un impact positif mesurable sur l'équipe et/ou l'entreprise.`,
    },
    {
      question: `Quels outils ou technologies utilisiez-vous le plus souvent ?`,
      answer: missions[2] ? `J'utilisais notamment ${missions[2]} au quotidien.` : `J'utilisais au quotidien les principaux outils liés à ce poste.`,
    },
  ];
}

exports.generateInterviewQA = functions
  .runWith({ secrets: ["GEMINI_API_KEY"] })
  .region("europe-west1")
  .https.onRequest(async (req, res) => {
    setCors(req, res);

    if (req.method === "OPTIONS") return res.status(204).send("");
    if (!req.is("application/json"))
      return res.status(400).json({ error: "Content-Type invalide. Envoie du JSON." });

    const deny = await enforceRecaptchaOrReturn(req, res, "generate_interview_qa");
    if (deny) return;

    try {
      const body = req.body || {};
      const profile = body.profile;
      const experienceIndex = body.experienceIndex;
      const lang = normalizeLang(body.lang || "fr");

      if (!profile || !Array.isArray(profile.experiences)) {
        return res.status(400).json({
          error: "Profil ou expériences manquants. Assure-toi d'avoir bien analysé ton CV.",
        });
      }

      const idx = Number.isInteger(experienceIndex) ? experienceIndex : parseInt(experienceIndex, 10);
      if (Number.isNaN(idx) || !profile.experiences[idx])
        return res.status(400).json({ error: "Indice d'expérience invalide." });

      const exp = profile.experiences[idx] || {};
      const role = exp.role || exp.title || (lang === "en" ? "Role" : "Poste");
      const company = exp.company || "";
      const city = exp.city || exp.location || "";
      const dates = exp.dates || "";
      const bullets = Array.isArray(exp.bullets) ? exp.bullets : [];

      const GEMINI_API_KEY = process.env.GEMINI_API_KEY;
      const cvText = buildProfileContextForIA(profile);

      if (!GEMINI_API_KEY) {
        const questions = buildFallbackQuestions(lang, role, company, city, dates, bullets);
        return res.status(200).json({ questions, lang });
      }

      const prompt =
        lang === "en"
          ? `You are an interview coach.
Return STRICTLY a JSON array of EXACTLY 3 objects:
[
  { "question": "string", "answer": "string" },
  { "question": "string", "answer": "string" },
  { "question": "string", "answer": "string" }
]

Rules:
- Answers must be concrete, aligned with the missions.
- Do not invent facts.

Context:
- Role: ${role} — ${company} — ${city} — ${dates}
- Missions: ${bullets.join(" ")}
- Candidate profile:
${cvText}`
          : `Tu es un coach d'entretien.
Retourne STRICTEMENT un tableau JSON de EXACTEMENT 3 objets :
[
  { "question": "string", "answer": "string" },
  { "question": "string", "answer": "string" },
  { "question": "string", "answer": "string" }
]

Règles:
- Réponses concrètes, alignées avec les missions.
- Ne pas inventer.

Contexte :
- ${role} — ${company} — ${city} — ${dates}
- Missions : ${bullets.join(" ")}
- Profil candidat :
${cvText}`;

      let questions = null;

      try {
        const parsed = await callGeminiJson(prompt, GEMINI_API_KEY, 0.55, 1200);

        if (Array.isArray(parsed)) {
          questions = parsed
            .map((item) => ({
              question: (item.question || item.q || "").toString().trim(),
              answer: (item.answer || item.a || "").toString().trim(),
            }))
            .filter((qa) => qa.question && qa.answer)
            .slice(0, 3);
        }
      } catch (e) {
        console.error("Erreur Gemini generateInterviewQA:", e);
      }

      if (!questions || questions.length !== 3) {
        questions = buildFallbackQuestions(lang, role, company, city, dates, bullets);
      }

      return res.status(200).json({ questions, lang });
    } catch (err) {
      console.error("Erreur generateInterviewQA:", err);
      return res.status(500).json({ error: "Erreur interne lors de la génération des Q&A." });
    }
  });

// =============================
// Credits / Logs
// =============================
function getReqPath(req) {
  try {
    return (req.originalUrl || req.path || "") + "";
  } catch {
    return "";
  }
}

async function debitCreditsAndLog({ uid, email, cost, tool, docType, docsGenerated, cvGenerated, lmGenerated, req, meta }) {
  const userRef = db.collection("users").doc(uid);
  const usageRef = db.collection("usageLogs").doc();
  const now = Date.now();
  const ip = getClientIp(req);
  const userAgent = String(req.headers["user-agent"] || "");
  const path = getReqPath(req);

  await db.runTransaction(async (tx) => {
    const snap = await tx.get(userRef);
    const data = snap.exists ? snap.data() || {} : {};
    const currentCredits = typeof data.credits === "number" ? data.credits : 0;

    if (currentCredits < cost) {
      const err = new Error("NO_CREDITS");
      err.code = "NO_CREDITS";
      throw err;
    }

    const updates = {
      credits: currentCredits - cost,
      totalIaCalls: admin.firestore.FieldValue.increment(1),
      updatedAt: admin.firestore.FieldValue.serverTimestamp(),
    };

    if (docsGenerated && docsGenerated > 0) updates.totalDocumentsGenerated = admin.firestore.FieldValue.increment(docsGenerated);
    if (cvGenerated && cvGenerated > 0) updates.totalCvGenerated = admin.firestore.FieldValue.increment(cvGenerated);
    if (lmGenerated && lmGenerated > 0) updates.totalLmGenerated = admin.firestore.FieldValue.increment(lmGenerated);

    tx.set(userRef, updates, { merge: true });

    tx.set(
      usageRef,
      {
        userId: uid,
        email: email || "",
        action: "generate_document",
        docType: docType || "other",
        eventType: "generate",
        tool: tool || null,
        creditsDelta: -cost,
        meta: meta || null,
        path: path || null,
        createdAt: now,
        createdAtServer: admin.firestore.FieldValue.serverTimestamp(),
        ip: ip || null,
        userAgent: userAgent || null,
      },
      { merge: true }
    );
  });
}

// =============================
// recaptchaVerify endpoint (pour login etc.)
// =============================
exports.recaptchaVerify = functions
  .region("europe-west1")
  .https.onRequest(async (req, res) => {
    setCors(req, res);

    if (req.method === "OPTIONS") return res.status(204).send("");
    if (req.method !== "POST") return res.status(405).json({ ok: false, reason: "method_not_allowed" });
    if (!req.is("application/json")) return res.status(400).json({ ok: false, reason: "bad_content_type" });

    const token = String(req.body?.token || "");
    const action = String(req.body?.action || "").trim();

    if (!token) return res.status(400).json({ ok: false, reason: "missing_token" });
    if (!action) return res.status(400).json({ ok: false, reason: "missing_action" });

    const result = await verifyRecaptchaToken({ token, expectedAction: action, req });

    if (!result.ok) {
      return res.status(403).json({
        ok: false,
        reason: result.reason || "recaptcha_failed",
        score: typeof result.score === "number" ? result.score : undefined,
        threshold: typeof result.threshold === "number" ? result.threshold : undefined,
        invalidReason: result.invalidReason || null,
        hostname: result.hostname || null,
        action: result.action || null,
        got: result.got || undefined,
        expected: result.expected || undefined,
      });
    }

    return res.status(200).json({
      ok: true,
      score: typeof result.score === "number" ? result.score : undefined,
      threshold: typeof result.threshold === "number" ? result.threshold : undefined,
    });
  });

// =============================
// generateCvPdf (auth + credits + recaptcha) ✅
// =============================
exports.generateCvPdf = functions
  .runWith({ secrets: ["GEMINI_API_KEY"] })
  .region("europe-west1")
  .https.onRequest(async (req, res) => {
    setCors(req, res);

    if (req.method === "OPTIONS") return res.status(204).send("");
    if (req.method !== "POST") return res.status(405).json({ error: "Méthode non autorisée" });
    if (!req.is("application/json")) return res.status(400).json({ error: "Content-Type invalide. Envoie du JSON." });

    const deny = await enforceRecaptchaOrReturn(req, res, "generate_cv_pdf");
    if (deny) return;

    let authUser = null;
    try {
      authUser = await requireFirebaseUser(req);
    } catch (e) {
      const code = e?.code || e?.message;
      if (code === "MISSING_AUTH") return res.status(401).json({ error: "unauthenticated" });
      return res.status(401).json({ error: "invalid_auth" });
    }

    try {
      const body = req.body || {};
      const profile = body.profile;
      const targetJob = body.targetJob || "";
      const lang = normalizeLang(body.lang || "fr");
      const contract = body.contract || "";
      const jobLink = body.jobLink || "";
      const jobDescription = sanitizeJobDescription(body.jobDescription || "");
      const companyName = body.companyName || "";

      if (!profile) return res.status(400).json({ error: "Champ 'profile' manquant." });

      try {
        await debitCreditsAndLog({
          uid: authUser.uid,
          email: authUser.email,
          cost: 1,
          tool: "generateCvPdf",
          docType: "cv",
          docsGenerated: 1,
          cvGenerated: 1,
          lmGenerated: 0,
          req,
          meta: { targetJob, lang },
        });
      } catch (e) {
        if (e?.code === "NO_CREDITS" || e?.message === "NO_CREDITS")
          return res.status(402).json({ error: "NO_CREDITS" });
        console.error("Débit crédits (CV) error:", e);
        return res.status(500).json({ error: "credits_error" });
      }

      const GEMINI_API_KEY = process.env.GEMINI_API_KEY;

      let tailoredSummary = "";
      let tailoredKeySkills = [];

      if (GEMINI_API_KEY && (targetJob || jobDescription)) {
        const t = await tailorCvForJob({
          profile,
          jobTitle: targetJob,
          companyName,
          jobDescription,
          lang,
          apiKey: GEMINI_API_KEY,
        });
        tailoredSummary = t.tailoredSummary || "";
        tailoredKeySkills = t.tailoredKeySkills || [];
      }

      const pdfBuffer = await createSimpleCvPdf(profile, {
        targetJob,
        lang,
        contract,
        jobLink,
        jobDescription,
        tailoredSummary,
        tailoredKeySkills,
      });

      res.setHeader("Content-Type", "application/pdf");
      res.setHeader("Content-Disposition", 'attachment; filename="cv-ia.pdf"');
      return res.status(200).send(pdfBuffer);
    } catch (err) {
      console.error("Erreur generateCvPdf:", err);
      return res.status(500).json({ error: err?.message || "Erreur interne." });
    }
  });

// =============================
// generateCvLmZip ✅ (auth + credits + recaptcha)
// =============================
exports.generateCvLmZip = functions
  .runWith({ secrets: ["GEMINI_API_KEY"] })
  .region("europe-west1")
  .https.onRequest(async (req, res) => {
    setCors(req, res);

    if (req.method === "OPTIONS") return res.status(204).send("");
    if (!req.is("application/json")) return res.status(400).json({ error: "Content-Type invalide. Envoie du JSON." });

    const deny = await enforceRecaptchaOrReturn(req, res, "generate_cv_lm_zip");
    if (deny) return;

    let authUser = null;
    try {
      authUser = await requireFirebaseUser(req);
    } catch (e) {
      const code = e?.code || e?.message;
      if (code === "MISSING_AUTH") return res.status(401).json({ error: "unauthenticated" });
      return res.status(401).json({ error: "invalid_auth" });
    }

    try {
      const body = req.body || {};
      const profile = body.profile;
      const targetJob = body.targetJob || "";
      const lang = normalizeLang(body.lang || "fr");
      const contract = body.contract || "";
      const jobLink = body.jobLink || "";
      const jobDescription = sanitizeJobDescription(body.jobDescription || "");
      const lm = body.lm || {};

      if (!profile) return res.status(400).json({ error: "Champ 'profile' manquant." });

      try {
        await debitCreditsAndLog({
          uid: authUser.uid,
          email: authUser.email,
          cost: 2,
          tool: "generateCvLmZip",
          docType: "other",
          docsGenerated: 2,
          cvGenerated: 1,
          lmGenerated: 1,
          req,
          meta: { targetJob, lang },
        });
      } catch (e) {
        if (e?.code === "NO_CREDITS" || e?.message === "NO_CREDITS")
          return res.status(402).json({ error: "NO_CREDITS" });
        console.error("Débit crédits (ZIP) error:", e);
        return res.status(500).json({ error: "credits_error" });
      }

      const GEMINI_API_KEY = process.env.GEMINI_API_KEY;

      let tailoredSummary = "";
      let tailoredKeySkills = [];
      if (GEMINI_API_KEY && (targetJob || jobDescription)) {
        const t = await tailorCvForJob({
          profile,
          jobTitle: targetJob,
          companyName: lm.companyName || "",
          jobDescription: sanitizeJobDescription(lm.jobDescription || jobDescription || ""),
          lang,
          apiKey: GEMINI_API_KEY,
        });
        tailoredSummary = t.tailoredSummary || "";
        tailoredKeySkills = t.tailoredKeySkills || [];
      }

      const cvBuffer = await createSimpleCvPdf(profile, {
        targetJob,
        lang,
        contract,
        jobLink,
        jobDescription,
        tailoredSummary,
        tailoredKeySkills,
      });

      if (!GEMINI_API_KEY) {
        return res.status(500).json({
          error: "Clé Gemini manquante côté serveur. Configure le secret GEMINI_API_KEY.",
        });
      }

      const companyName = lm.companyName || "";
      const jobTitle = lm.jobTitle || targetJob || "";
      const lmJobDescription = sanitizeJobDescription(lm.jobDescription || jobDescription || "");
      const lmLang = normalizeLang(lm.lang || lang);

      const cvText = buildProfileContextForIA(profile);
      const prompt = buildLetterAndPitchPrompt({
        lang: lmLang,
        cvText,
        jobDescription: lmJobDescription,
        jobTitle: jobTitle || (lmLang === "en" ? "the role" : "le poste"),
        companyName: companyName || (lmLang === "en" ? "your company" : "votre entreprise"),
      });

      let parsed = null;
      try {
        parsed = await callGeminiJson(prompt, GEMINI_API_KEY, 0.55, 1800);
      } catch (e) {
        console.error("Erreur Gemini JSON (ZIP LM):", e);
      }

      let coverBody = parsed && typeof parsed.coverLetterBody === "string" ? parsed.coverLetterBody : "";
      coverBody = sanitizeLmBodyOnly(sanitizeLmBodyFromModel(coverBody), lmLang, profile.fullName || "");
      if (!coverBody) {
        const fb = buildFallbackLetterAndPitchBody(profile, jobTitle, companyName, lmJobDescription, lmLang);
        coverBody = fb.body;
      }

      const coverLetterFull = composeFullCoverLetterDoc({
        profile,
        jobTitle,
        companyName,
        lang: lmLang,
        bodyOnly: coverBody,
      });

      const lmBuffer = await createLetterPdf(coverLetterFull, {
        jobTitle,
        companyName,
        candidateName: profile.fullName || "",
        lang: lmLang,
      });

      const zip = new JSZip();
      zip.file("cv-ia.pdf", cvBuffer);
      zip.file(lmLang === "en" ? "cover-letter.pdf" : "lettre-motivation.pdf", lmBuffer);

      const zipContent = await zip.generateAsync({ type: "nodebuffer" });

      res.setHeader("Content-Type", "application/zip");
      res.setHeader("Content-Disposition", 'attachment; filename="cv-lm-ia.zip"');
      return res.status(200).send(zipContent);
    } catch (err) {
      console.error("Erreur generateCvLmZip:", err);
      return res.status(500).json({ error: err?.message || "Erreur interne." });
    }
  });

// =============================
// generateLetterPdf ✅ (recaptcha)
// =============================
exports.generateLetterPdf = functions
  .region("europe-west1")
  .https.onRequest(async (req, res) => {
    setCors(req, res);

    if (req.method === "OPTIONS") return res.status(204).send("");
    if (!req.is("application/json")) return res.status(400).json({ error: "Content-Type invalide. Envoie du JSON." });

    const deny = await enforceRecaptchaOrReturn(req, res, "generate_letter_pdf");
    if (deny) return;

    try {
      const body = req.body || {};
      const coverLetterRaw = (body.coverLetter || "").toString().trim();
      const jobTitle = (body.jobTitle || "").toString().trim();
      const companyName = (body.companyName || "").toString().trim();
      const candidateName = (body.candidateName || "").toString().trim();
      const lang = normalizeLang(body.lang || "fr");

      if (!coverLetterRaw) return res.status(400).json({ error: "Champ 'coverLetter' manquant ou vide." });

      const coverLetterFull = looksLikeFormattedLetterDoc(coverLetterRaw)
        ? coverLetterRaw
        : ensureFullLetterFormat({ letter: coverLetterRaw, lang, candidateName });

      const pdfBuffer = await createLetterPdf(coverLetterFull, {
        jobTitle,
        companyName,
        candidateName,
        lang,
      });

      const safeJob = jobTitle.toLowerCase().replace(/[^a-z0-9]+/g, "-").replace(/^-+|-+$/g, "");
      const filename =
        (lang === "en" ? "cover-letter" : "lettre-motivation") + (safeJob ? `-${safeJob}` : "") + ".pdf";

      res.setHeader("Content-Type", "application/pdf");
      res.setHeader("Content-Disposition", `attachment; filename="${filename}"`);
      return res.status(200).send(pdfBuffer);
    } catch (err) {
      console.error("Erreur generateLetterPdf:", err);
      return res.status(500).json({ error: "Erreur interne lors de la génération du PDF." });
    }
  });

// =============================
// jobs (Adzuna)
// =============================
exports.jobs = functions
  .region("europe-west1")
  .https.onRequest(async (req, res) => {
    setCors(req, res);

    if (req.method === "OPTIONS") return res.status(204).send("");
    if (!req.is("application/json")) return res.status(400).json({ error: "Content-Type invalide. Envoie du JSON." });

    const deny = await enforceRecaptchaOrReturn(req, res, "jobs_search");
    if (deny) return;

    try {
      if (!fetchFn) throw new Error("fetch indisponible. Mets Node 18+.");

      const body = req.body || {};
      const query = (body.query || "").toString().trim();
      const location = (body.location || "").toString().trim();
      const pageRaw = body.page;

      if (!query && !location) {
        return res.status(400).json({ error: "Ajoute au moins un mot-clé (query) ou un lieu (location)." });
      }

      const ADZUNA_APP_ID = (functions.config().adzuna && functions.config().adzuna.app_id) || process.env.ADZUNA_APP_ID;
      const ADZUNA_APP_KEY = (functions.config().adzuna && functions.config().adzuna.app_key) || process.env.ADZUNA_APP_KEY;

      if (!ADZUNA_APP_ID || !ADZUNA_APP_KEY) return res.status(500).json({ error: "Clés Adzuna manquantes côté serveur." });

      const page =
        typeof pageRaw === "number" && pageRaw > 0
          ? pageRaw
          : parseInt(pageRaw, 10) > 0
          ? parseInt(pageRaw, 10)
          : 1;

      const params = new URLSearchParams();
      params.set("app_id", ADZUNA_APP_ID);
      params.set("app_key", ADZUNA_APP_KEY);
      params.set("results_per_page", "20");
      params.set("content-type", "application/json");
      if (query) params.set("what", query);
      if (location) params.set("where", location);

      const url = `https://api.adzuna.com/v1/api/jobs/fr/search/${page}?${params.toString()}`;

      const resp = await fetchFn(url, { method: "GET", headers: { Accept: "application/json" } });
      if (!resp.ok) {
        const textErr = await resp.text();
        console.error("Erreur Adzuna:", resp.status, textErr);
        return res.status(500).json({ error: "Erreur lors de l'appel à l'API Adzuna." });
      }

      const data = await resp.json();
      const results = Array.isArray(data.results) ? data.results : [];

      const jobs = results.map((job, index) => {
        const salaryMin = job.salary_min || 0;
        const salaryMax = job.salary_max || 0;
        const hasSalary = salaryMin > 0 || salaryMax > 0;

        return {
          id: job.id || `job-${index}`,
          title: job.title || "Offre sans titre",
          company: job.company && job.company.display_name ? job.company.display_name : "Entreprise non renseignée",
          location: job.location && job.location.display_name ? job.location.display_name : "Lieu non précisé",
          url: job.redirect_url || "",
          description: job.description || "",
          created: job.created || "",
          salary: hasSalary ? `${salaryMin.toLocaleString("fr-FR")} – ${salaryMax.toLocaleString("fr-FR")} €` : null,
        };
      });

      return res.status(200).json({ jobs });
    } catch (err) {
      console.error("Erreur /jobs:", err);
      return res.status(500).json({ error: "Erreur interne lors de la recherche d'offres (Adzuna /jobs)." });
    }
  });

// =============================
// Polar checkout + webhook
// =============================
const POLAR_ACCESS_TOKEN_BOOT =
  process.env.POLAR_ACCESS_TOKEN || (functions.config().polar && functions.config().polar.access_token);

if (!POLAR_ACCESS_TOKEN_BOOT) {
  console.warn("⚠️ POLAR_ACCESS_TOKEN manquant. Les paiements ne fonctionneront pas.");
}

exports.polarCheckout = functions
  .region("europe-west1")
  .https.onRequest(async (req, res) => {
    setCors(req, res);

    if (req.method === "OPTIONS") return res.status(204).send("");
    if (req.method !== "POST") return res.status(405).json({ error: "Méthode non autorisée" });

    const deny = await enforceRecaptchaOrReturn(req, res, "polar_checkout");
    if (deny) return;

    try {
      const body = req.body || {};
      const packId = body.packId;
      const userId = body.userId;
      const email = body.email;

      if (!packId || !userId || !email) {
        return res.status(400).json({
          ok: false,
          error: "Paramètres manquants : packId, userId et email sont obligatoires.",
        });
      }

      const polarAccessToken =
        process.env.POLAR_ACCESS_TOKEN || (functions.config().polar && functions.config().polar.access_token);

      const polarEnv = process.env.POLAR_ENV || (functions.config().polar && functions.config().polar.env) || "sandbox";

      const product20 =
        process.env.POLAR_PRODUCT_20_ID || (functions.config().polar && functions.config().polar.product_20_id);
      const product50 =
        process.env.POLAR_PRODUCT_50_ID || (functions.config().polar && functions.config().polar.product_50_id);
      const product100 =
        process.env.POLAR_PRODUCT_100_ID || (functions.config().polar && functions.config().polar.product_100_id);

      if (!polarAccessToken) return res.status(500).json({ ok: false, error: "Configuration Polar manquante côté serveur." });

      const server = polarEnv === "production" ? "production" : "sandbox";
      const polar = new Polar({ accessToken: polarAccessToken, server });

      const mapPackToProduct = { "20": product20, "50": product50, "100": product100 };
      const productId = mapPackToProduct[String(packId)];

      if (!productId) {
        return res.status(400).json({
          ok: false,
          error: `Pack invalide ou productId non configuré pour "${packId}".`,
        });
      }

      const baseUrl =
        process.env.NEXT_PUBLIC_APP_URL ||
        (functions.config().app && functions.config().app.base_url) ||
        "https://assistant-ia-v4.web.app";

      const successUrl = `${baseUrl}/app/credits?status=success`;
      const returnUrl = `${baseUrl}/app/credits?status=cancel`;

      const payload = {
        products: [productId],
        success_url: successUrl,
        return_url: returnUrl,
        customer_email: email,
        external_customer_id: userId,
        allow_discount_codes: true,
        require_billing_address: false,
        allow_trial: true,
        is_business_customer: false,
        metadata: { firebase_uid: String(userId), pack_id: String(packId), app: "assistant-ia-v4" },
      };

      const checkout = await polar.checkouts.create(payload);

      if (!checkout || !checkout.url) return res.status(500).json({ ok: false, error: "Checkout Polar créé mais URL manquante." });

      try {
        const checkoutId = checkout.id ? String(checkout.id) : null;
        const customerId = checkout.customer_id ? String(checkout.customer_id) : null;
        const productPriceId = checkout.product_price_id || checkout.productPriceId || null;

        if (checkoutId) {
          await db.collection("polar_checkouts").doc(checkoutId).set(
            {
              userId: String(userId),
              email: String(email),
              packId: String(packId),
              productId: String(productId),
              productPriceId: productPriceId ? String(productPriceId) : null,
              customerId: customerId ? String(customerId) : null,
              env: server,
              status: checkout.status || null,
              createdAt: admin.firestore.FieldValue.serverTimestamp(),
              updatedAt: admin.firestore.FieldValue.serverTimestamp(),
            },
            { merge: true }
          );
        }

        if (customerId) {
          await db.collection("polar_customers").doc(customerId).set(
            { userId: String(userId), email: String(email), updatedAt: admin.firestore.FieldValue.serverTimestamp() },
            { merge: true }
          );
        }
      } catch (e) {
        console.warn("Impossible d'écrire le mapping polar_checkouts:", e);
      }

      return res.status(200).json({ ok: true, url: checkout.url });
    } catch (err) {
      console.error("Erreur polarCheckout:", err);
      return res.status(500).json({ ok: false, error: "Erreur interne lors de la création du checkout Polar." });
    }
  });

function deepFindByKey(obj, keyNames) {
  if (!obj || typeof obj !== "object") return null;
  const keys = Array.isArray(keyNames) ? keyNames : [keyNames];

  for (const k of Object.keys(obj)) {
    const lower = k.toLowerCase();
    const found = keys.find((target) => lower === target.toLowerCase());
    if (found) {
      const val = obj[k];
      if (val !== undefined && val !== null && val !== "") return val;
    }
    const child = obj[k];
    if (child && typeof child === "object") {
      const result = deepFindByKey(child, keys);
      if (result !== null && result !== undefined) return result;
    }
  }
  return null;
}

function deepCollectByKey(obj, keyNames, acc = []) {
  if (!obj || typeof obj !== "object") return acc;
  const keys = Array.isArray(keyNames) ? keyNames : [keyNames];

  for (const k of Object.keys(obj)) {
    const lower = k.toLowerCase();
    const isMatch = keys.some((target) => lower === target.toLowerCase());
    const val = obj[k];

    if (isMatch) {
      if (val !== undefined && val !== null && val !== "") acc.push(val);
    }

    if (val && typeof val === "object") deepCollectByKey(val, keyNames, acc);
  }
  return acc;
}

function inferCreditsFromText(text) {
  if (!text || typeof text !== "string") return 0;
  const m = text.match(/(\d+)\s*credits?/i);
  if (!m) return 0;
  const n = parseInt(m[1], 10);
  if ([20, 50, 100].includes(n)) return n;
  return 0;
}

exports.polarWebhook = functions
  .region("europe-west1")
  .https.onRequest(async (req, res) => {
    setCors(req, res);

    if (req.method === "OPTIONS") return res.status(204).send("");
    if (req.method !== "POST") return res.status(405).json({ ok: false, error: "Méthode non autorisée" });

    try {
      const event = req.body || {};
      console.log("Webhook Polar reçu :", JSON.stringify(event, null, 2));

      if (!event || !event.type) return res.status(400).json({ ok: false, error: "Event Polar invalide (type manquant)." });
      if (event.type !== "order.paid") return res.status(200).json({ ok: true, ignored: true });

      const product20 =
        process.env.POLAR_PRODUCT_20_ID || (functions.config().polar && functions.config().polar.product_20_id);
      const product50 =
        process.env.POLAR_PRODUCT_50_ID || (functions.config().polar && functions.config().polar.product_50_id);
      const product100 =
        process.env.POLAR_PRODUCT_100_ID || (functions.config().polar && functions.config().polar.product_100_id);

      const price20 =
        process.env.POLAR_PRICE_20_ID || (functions.config().polar && functions.config().polar.price_20_id);
      const price50 =
        process.env.POLAR_PRICE_50_ID || (functions.config().polar && functions.config().polar.price_50_id);
      const price100 =
        process.env.POLAR_PRICE_100_ID || (functions.config().polar && functions.config().polar.price_100_id);

      const CREDITS_BY_PRODUCT_ID = {};
      if (product20) CREDITS_BY_PRODUCT_ID[String(product20)] = 20;
      if (product50) CREDITS_BY_PRODUCT_ID[String(product50)] = 50;
      if (product100) CREDITS_BY_PRODUCT_ID[String(product100)] = 100;

      const CREDITS_BY_PRICE_ID = {};
      if (price20) CREDITS_BY_PRICE_ID[String(price20)] = 20;
      if (price50) CREDITS_BY_PRICE_ID[String(price50)] = 50;
      if (price100) CREDITS_BY_PRICE_ID[String(price100)] = 100;

      const data = event.data || {};
      const priceIds = deepCollectByKey(data, ["product_price_id", "productPriceId"]).map(String);
      const productIds = deepCollectByKey(data, ["product_id", "productId"]).map(String);

      let creditsToAdd = 0;

      for (const pid of priceIds) {
        if (CREDITS_BY_PRICE_ID[pid]) {
          creditsToAdd = CREDITS_BY_PRICE_ID[pid];
          break;
        }
      }
      if (!creditsToAdd) {
        for (const id of productIds) {
          if (CREDITS_BY_PRODUCT_ID[id]) {
            creditsToAdd = CREDITS_BY_PRODUCT_ID[id];
            break;
          }
        }
      }
      if (!creditsToAdd) {
        const labels = deepCollectByKey(data, ["label", "description", "name"])
          .filter((x) => typeof x === "string")
          .map((x) => x.trim());
        for (const t of labels) {
          const n = inferCreditsFromText(t);
          if (n) {
            creditsToAdd = n;
            break;
          }
        }
      }

      if (!creditsToAdd) {
        return res.status(200).json({
          ok: true,
          ignored: true,
          reason: "credits introuvables",
          found: { priceIds, productIds },
        });
      }

      let userId =
        deepFindByKey(data, ["external_customer_id", "customer_external_id"]) ||
        deepFindByKey(data, ["firebase_uid", "firebaseUid"]) ||
        (deepFindByKey(data, ["custom_field_data"]) || {})?.firebase_uid ||
        null;

      if (userId && typeof userId !== "string") userId = String(userId);

      if (!userId) {
        const customerId = deepFindByKey(data, ["customer_id", "customerId"]) || null;
        if (customerId) {
          const snap = await db.collection("polar_customers").doc(String(customerId)).get();
          if (snap.exists) userId = String((snap.data() || {}).userId || "");
        }
      }

      if (!userId) {
        const checkoutId = deepFindByKey(data, ["checkout_id", "checkoutId"]) || null;
        if (checkoutId) {
          const snap = await db.collection("polar_checkouts").doc(String(checkoutId)).get();
          if (snap.exists) userId = String((snap.data() || {}).userId || "");
        }
      }

      if (!userId) {
        const email = deepFindByKey(data, ["customer_email", "email"]) || null;
        if (email && typeof email === "string") {
          try {
            const u = await admin.auth().getUserByEmail(email);
            if (u?.uid) userId = u.uid;
          } catch (e) {
            console.warn("Fallback email->uid impossible:", e);
          }
        }
      }

      if (!userId) return res.status(200).json({ ok: true, ignored: true, reason: "userId introuvable" });

      const orderId = (data && (data.id || data.order_id || data.orderId)) || event.id || null;
      const ledgerRef = orderId ? db.collection("polar_orders").doc(String(orderId)) : null;

      await db.runTransaction(async (tx) => {
        if (ledgerRef) {
          const ledgerSnap = await tx.get(ledgerRef);
          if (ledgerSnap.exists) return;
        }

        const userRef = db.collection("users").doc(userId);
        const userSnap = await tx.get(userRef);
        const userData = userSnap.exists ? userSnap.data() || {} : {};
        const currentCredits = typeof userData.credits === "number" ? userData.credits : 0;

        const newCredits = currentCredits + creditsToAdd;

        tx.set(userRef, { credits: newCredits, updatedAt: admin.firestore.FieldValue.serverTimestamp() }, { merge: true });

        if (ledgerRef) {
          tx.set(ledgerRef, {
            processed: true,
            userId,
            creditsAdded: creditsToAdd,
            productIds,
            priceIds,
            eventType: event.type,
            createdAt: admin.firestore.FieldValue.serverTimestamp(),
          });
        }

        const rechargeId = orderId ? String(orderId) : `${event.type}_${Date.now()}`;
        const rechargeRef = db.collection("users").doc(userId).collection("rechargeHistory").doc(rechargeId);

        tx.set(
          rechargeRef,
          {
            provider: "polar",
            orderId: orderId ? String(orderId) : null,
            checkoutId: deepFindByKey(data, ["checkout_id", "checkoutId"]) || null,
            creditsAdded: creditsToAdd,
            productIds,
            priceIds,
            amount: deepFindByKey(data, ["amount", "price_amount", "total_amount"]) || null,
            currency: deepFindByKey(data, ["currency", "price_currency"]) || null,
            status: deepFindByKey(data, ["status", "payment_status"]) || null,
            eventType: event.type,
            createdAt: admin.firestore.FieldValue.serverTimestamp(),
          },
          { merge: true }
        );

        console.log(`Crédits ajoutés: +${creditsToAdd} (total=${newCredits}) userId=${userId}`);
      });

      return res.status(200).json({ ok: true, processed: true });
    } catch (err) {
      console.error("Erreur polarWebhook:", err);
      return res.status(500).json({ ok: false, error: "Erreur interne lors du traitement du webhook Polar." });
    }
  });
````

## File: lib/gemini.ts
````typescript
// /lib/gemini.ts
// Client-side helpers to call Firebase Cloud Functions (Gemini / PDF / Interview / reCAPTCHA / Jobs / Polar).
// ✅ Single source of truth: NEXT_PUBLIC_API_BASE_URL
// ✅ Optional emulator: NEXT_PUBLIC_USE_FUNCTIONS_EMULATOR + NEXT_PUBLIC_FUNCTIONS_EMULATOR_URL
// ✅ No runtime "process" usage beyond build-time inlined NEXT_PUBLIC_*.

export type Lang = "fr" | "en";

export type SkillSection = { title: string; items: string[] };
export type SkillsBlock = { sections: SkillSection[]; tools: string[] };

export type Experience = {
  company?: string;
  role?: string;
  title?: string;
  dates?: string;
  city?: string;
  location?: string;
  bullets?: string[];
};

export type Education = {
  school?: string;
  degree?: string;
  dates?: string;
};

export type Profile = {
  fullName?: string;
  name?: string;
  email?: string;
  phone?: string;
  linkedin?: string;
  profileSummary?: string;
  summary?: string;

  city?: string;
  address?: string;

  contractType?: string;
  contractTypeStandard?: string;
  contractTypeFull?: string;

  primaryDomain?: string;
  secondaryDomains?: string[];

  skills?: SkillsBlock | string[];
  softSkills?: string[];

  experiences?: Experience[];
  education?: Education[];
  educationShort?: string[];

  certs?: string;
  langLine?: string;
  lang?: string;

  hobbies?: string[];

  drivingLicense?: string;
  vehicle?: string;
};

export type ExtractProfileResult = Profile;

export type GenerateLetterAndPitchResult = {
  lang: Lang;
  letterBody: string; // body only
  coverLetter: string; // fully formatted doc (header/date/objet/salutation/signature)
  pitch: string;
};

export type InterviewQAItem = { question: string; answer: string };

export type GenerateInterviewQAResult = {
  questions: InterviewQAItem[];
  lang: Lang;
};

export type InterviewStartResult = {
  sessionId: string;
  step: number;
  totalQuestions: number;
  next_question: string | null;
  short_analysis: string;
  final_summary: string | null;
  final_score: number | null;
};

export type InterviewAnswerResult = InterviewStartResult;

export type RecaptchaVerifyResult =
  | { ok: true; score?: number; threshold?: number }
  | {
      ok: false;
      reason: string;
      score?: number;
      threshold?: number;
      invalidReason?: string;
    };

type JsonValue = any;

function stripTrailingSlash(u: string) {
  return u.replace(/\/+$/, "");
}

// --- base url selection (prod by default) ---
const BASE_URL = (() => {
  const prod =
    process.env.NEXT_PUBLIC_API_BASE_URL ||
    process.env.NEXT_PUBLIC_FUNCTIONS_BASE_URL || // backward compat if still present
    "https://europe-west1-assistant-ia-v4.cloudfunctions.net";

  const useEmu =
    (process.env.NEXT_PUBLIC_USE_FUNCTIONS_EMULATOR || "").trim() === "1";

  const emu =
    process.env.NEXT_PUBLIC_FUNCTIONS_EMULATOR_URL ||
    "http://127.0.0.1:5001/assistant-ia-v4/europe-west1";

  return stripTrailingSlash(useEmu ? emu : prod);
})();

function getFunctionsBaseUrl(): string {
  return BASE_URL;
}

function buildHeaders(opts?: {
  idToken?: string;
  extra?: Record<string, string>;
}): HeadersInit {
  const h: Record<string, string> = {
    "Content-Type": "application/json",
    ...(opts?.extra || {}),
  };
  if (opts?.idToken) h.Authorization = `Bearer ${opts.idToken}`;
  return h;
}

async function parseError(resp: Response): Promise<{ message: string; data?: any }> {
  const ct = resp.headers.get("content-type") || "";
  try {
    if (ct.includes("application/json")) {
      const j = await resp.json();
      const msg =
        (j && (j.message || j.error || j?.details?.reason || j?.details?.error)) ||
        JSON.stringify(j);
      return { message: String(msg), data: j };
    }
    const t = await resp.text();
    return { message: t || `${resp.status} ${resp.statusText}` };
  } catch {
    return { message: `${resp.status} ${resp.statusText}` };
  }
}

async function postJson<T = JsonValue>(
  path: string,
  body: any,
  opts?: { idToken?: string }
): Promise<T> {
  const url = `${getFunctionsBaseUrl()}/${path.replace(/^\/+/, "")}`;
  const resp = await fetch(url, {
    method: "POST",
    headers: buildHeaders({ idToken: opts?.idToken }),
    body: JSON.stringify(body ?? {}),
  });

  if (!resp.ok) {
    const err = await parseError(resp);
    throw Object.assign(new Error(err.message), {
      status: resp.status,
      data: err.data,
      url,
    });
  }

  return (await resp.json()) as T;
}

async function postBinary(
  path: string,
  body: any,
  opts?: { idToken?: string }
): Promise<Blob> {
  const url = `${getFunctionsBaseUrl()}/${path.replace(/^\/+/, "")}`;
  const resp = await fetch(url, {
    method: "POST",
    headers: buildHeaders({ idToken: opts?.idToken }),
    body: JSON.stringify(body ?? {}),
  });

  if (!resp.ok) {
    const err = await parseError(resp);
    throw Object.assign(new Error(err.message), {
      status: resp.status,
      data: err.data,
      url,
    });
  }

  const ab = await resp.arrayBuffer();
  const ct = resp.headers.get("content-type") || "application/octet-stream";
  return new Blob([ab], { type: ct });
}

// -----------------------------
// reCAPTCHA (optional)
// -----------------------------
export async function callRecaptchaVerify(args: {
  token: string;
  action: string;
}): Promise<RecaptchaVerifyResult> {
  return await postJson<RecaptchaVerifyResult>("recaptchaVerify", {
    token: args.token,
    action: args.action,
  });
}

// -----------------------------
// Gemini: extract profile from CV PDF base64
// -----------------------------
export async function callExtractProfile(args: {
  base64Pdf: string;
  recaptchaToken?: string;
  idToken?: string;
}): Promise<ExtractProfileResult> {
  return await postJson<ExtractProfileResult>(
    "extractProfile",
    {
      base64Pdf: args.base64Pdf,
      recaptchaToken: args.recaptchaToken,
      action: "extract_profile",
      recaptchaAction: "extract_profile",
    },
    { idToken: args.idToken }
  );
}

// -----------------------------
// Gemini: generate letter + pitch
// -----------------------------
export async function callGenerateLetterAndPitch(args: {
  profile: Profile;
  jobDescription?: string;
  jobTitle?: string;
  companyName?: string;
  lang?: Lang;
  recaptchaToken?: string;
  idToken?: string;
}): Promise<GenerateLetterAndPitchResult> {
  return await postJson<GenerateLetterAndPitchResult>(
    "generateLetterAndPitch",
    {
      profile: args.profile,
      jobDescription: args.jobDescription || "",
      jobTitle: args.jobTitle || "",
      companyName: args.companyName || "",
      lang: args.lang || "fr",
      recaptchaToken: args.recaptchaToken,
      recaptchaAction: "generate_letter_pitch",
      action: "generate_letter_pitch",
    },
    { idToken: args.idToken }
  );
}

// -----------------------------
// Gemini: generate interview Q&A
// -----------------------------
export async function callGenerateInterviewQA(args: {
  profile: Profile;
  experienceIndex: number;
  lang?: Lang;
  recaptchaToken?: string;
  idToken?: string;
}): Promise<GenerateInterviewQAResult> {
  return await postJson<GenerateInterviewQAResult>(
    "generateInterviewQA",
    {
      profile: args.profile,
      experienceIndex: args.experienceIndex,
      lang: args.lang || "fr",
      recaptchaToken: args.recaptchaToken,
      recaptchaAction: "generate_interview_qa",
      action: "generate_interview_qa",
    },
    { idToken: args.idToken }
  );
}

// -----------------------------
// Interview simulation
// -----------------------------
export async function callInterviewStart(args: {
  userId: string;
  jobTitle?: string;
  jobDesc?: string;
  interviewMode?: "complet" | "rapide" | "technique" | "comportemental";
  difficulty?: "standard" | "difficile";
  recaptchaToken?: string;
  idToken?: string;
}): Promise<InterviewStartResult> {
  return await postJson<InterviewStartResult>(
    "interview",
    {
      action: "start",
      userId: args.userId,
      jobTitle: args.jobTitle || "",
      jobDesc: args.jobDesc || "",
      interviewMode: args.interviewMode || "complet",
      difficulty: args.difficulty || "standard",
      recaptchaToken: args.recaptchaToken,
      recaptchaAction: "interview",
    },
    { idToken: args.idToken }
  );
}

export async function callInterviewAnswer(args: {
  userId: string;
  sessionId: string;
  userMessage: string;
  recaptchaToken?: string;
  idToken?: string;
}): Promise<InterviewAnswerResult> {
  return await postJson<InterviewAnswerResult>(
    "interview",
    {
      action: "answer",
      userId: args.userId,
      sessionId: args.sessionId,
      userMessage: args.userMessage,
      recaptchaToken: args.recaptchaToken,
      recaptchaAction: "interview",
    },
    { idToken: args.idToken }
  );
}

// -----------------------------
// PDF endpoints (return Blob)
// -----------------------------
export async function callGenerateCvPdf(args: {
  profile: Profile;
  targetJob?: string;
  lang?: Lang;
  contract?: string;
  jobLink?: string;
  jobDescription?: string;
  companyName?: string;
  recaptchaToken?: string;
  idToken: string; // required
}): Promise<Blob> {
  return await postBinary(
    "generateCvPdf",
    {
      profile: args.profile,
      targetJob: args.targetJob || "",
      lang: args.lang || "fr",
      contract: args.contract || "",
      jobLink: args.jobLink || "",
      jobDescription: args.jobDescription || "",
      companyName: args.companyName || "",
      recaptchaToken: args.recaptchaToken,
      recaptchaAction: "generate_cv_pdf",
      action: "generate_cv_pdf",
    },
    { idToken: args.idToken }
  );
}

export async function callGenerateCvLmZip(args: {
  profile: Profile;
  targetJob?: string;
  lang?: Lang;
  contract?: string;
  jobLink?: string;
  jobDescription?: string;
  lm: {
    jobTitle?: string;
    companyName?: string;
    jobDescription?: string;
    lang?: Lang;
  };
  recaptchaToken?: string;
  idToken: string;
}): Promise<Blob> {
  return await postBinary(
    "generateCvLmZip",
    {
      profile: args.profile,
      targetJob: args.targetJob || "",
      lang: args.lang || "fr",
      contract: args.contract || "",
      jobLink: args.jobLink || "",
      jobDescription: args.jobDescription || "",
      lm: args.lm || {},
      recaptchaToken: args.recaptchaToken,
      recaptchaAction: "generate_cv_lm_zip",
      action: "generate_cv_lm_zip",
    },
    { idToken: args.idToken }
  );
}

export async function callGenerateLetterPdf(args: {
  coverLetter: string;
  jobTitle?: string;
  companyName?: string;
  candidateName?: string;
  lang?: Lang;
  recaptchaToken?: string;
  idToken?: string;
}): Promise<Blob> {
  return await postBinary(
    "generateLetterPdf",
    {
      coverLetter: args.coverLetter,
      jobTitle: args.jobTitle || "",
      companyName: args.companyName || "",
      candidateName: args.candidateName || "",
      lang: args.lang || "fr",
      recaptchaToken: args.recaptchaToken,
      recaptchaAction: "generate_letter_pdf",
      action: "generate_letter_pdf",
    },
    { idToken: args.idToken }
  );
}

// -----------------------------
// Jobs search (Adzuna proxy)
// -----------------------------
export type JobItem = {
  id: string;
  title: string;
  company: string;
  location: string;
  url: string;
  description: string;
  created: string;
  salary: string | null;
};

export type JobsSearchResult = { jobs: JobItem[] };

export async function callJobsSearch(args: {
  query?: string;
  location?: string;
  page?: number;
  recaptchaToken?: string;
  idToken?: string;
}): Promise<JobsSearchResult> {
  return await postJson<JobsSearchResult>(
    "jobs",
    {
      query: args.query || "",
      location: args.location || "",
      page: typeof args.page === "number" ? args.page : 1,
      recaptchaToken: args.recaptchaToken,
      recaptchaAction: "jobs_search",
      action: "jobs_search",
    },
    { idToken: args.idToken }
  );
}

// -----------------------------
// Polar checkout
// -----------------------------
export type PolarCheckoutResult =
  | { ok: true; url: string }
  | { ok: false; error: string };

export async function callPolarCheckout(args: {
  packId: "20" | "50" | "100" | string;
  userId: string;
  email: string;
  recaptchaToken?: string;
  idToken?: string;
}): Promise<PolarCheckoutResult> {
  return await postJson<PolarCheckoutResult>(
    "polarCheckout",
    {
      packId: args.packId,
      userId: args.userId,
      email: args.email,
      recaptchaToken: args.recaptchaToken,
      recaptchaAction: "polar_checkout",
      action: "polar_checkout",
    },
    { idToken: args.idToken }
  );
}
````

## File: package.json
````json
{
  "name": "assistant-candidatures",
  "version": "1.0.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "next lint"
  },
  "dependencies": {
    "@polar-sh/checkout": "^0.1.14",
    "@polar-sh/sdk": "^0.41.5",
    "aos": "^2.3.4",
    "chart.js": "^4.5.1",
    "clsx": "^2.1.1",
    "firebase": "^12.7.0",
    "firebase-admin": "^13.6.0",
    "firebase-functions": "^7.0.2",
    "framer-motion": "^11.18.2",
    "i18next": "^25.7.3",
    "i18next-browser-languagedetector": "^8.2.0",
    "jszip": "^3.10.1",
    "lucide-react": "^0.562.0",
    "next": "^14.2.35",
    "next-intl": "^4.7.0",
    "node-fetch": "^3.3.2",
    "openai": "^6.10.0",
    "pdf-lib": "^1.17.1",
    "pdfjs-dist": "^5.4.530",
    "pdfmake": "^0.2.21",
    "react": "18.2.0",
    "react-dom": "18.2.0",
    "react-i18next": "^16.5.1",
    "react-pdf": "^10.2.0",
    "tailwind-merge": "^3.4.0"
  },
  "devDependencies": {
    "@types/aos": "^3.0.7",
    "@types/jszip": "^3.4.0",
    "@types/node": "^20.12.7",
    "@types/pdfmake": "^0.2.12",
    "@types/react": "^18.2.66",
    "autoprefixer": "^10.4.19",
    "postcss": "^8.4.38",
    "tailwindcss": "^3.4.4",
    "typescript": "^5.5.0"
  }
}
````

## File: app/app/lm/page.tsx
````typescript
// app/app/assistant-candidature/page.tsx
"use client";

import { logUsage } from "@/lib/logUsage";
import { useEffect, useMemo, useRef, useState, type FormEvent } from "react";
import type { ReactNode } from "react";
import { motion, AnimatePresence } from "framer-motion";
import { auth, db } from "@/lib/firebase";
import { onAuthStateChanged } from "firebase/auth";
import { doc, getDoc, collection, addDoc, serverTimestamp } from "firebase/firestore";

import { getRecaptchaToken } from "@/lib/recaptcha";
import { callGenerateCvPdf, callGenerateLetterAndPitch } from "@/lib/gemini";

import { makePdfColors } from "@/lib/pdf/colors";
import { fitOnePage } from "@/lib/pdf/fitOnePage";
import { mergePdfBlobs } from "@/lib/pdf/mergePdfs";
import { downloadBlob } from "@/lib/pdf/pdfmakeClient";

import type { CvDocModel } from "@/lib/pdf/templates/cvAts";
import { buildCvPdf, getCvTemplates, type CvTemplateId } from "@/lib/pdf/templates/cvTemplates";
import { buildLmStyledPdf, type LmModel } from "@/lib/pdf/templates/letter";

import {
  PenTool,
  Sparkles,
  FileText,
  Briefcase,
  Send,
  Copy,
  RotateCcw,
  CheckCircle2,
  AlertCircle,
  ArrowRight,
  Download,
  Mail,
  MessageSquareText,
  Loader2,
} from "lucide-react";

// =============================
// TYPES
// =============================
type CvSkillsSection = { title: string; items: string[] };
type CvSkills = { sections: CvSkillsSection[]; tools: string[] };

type CvExperience = {
  company: string;
  role: string;
  dates: string;
  bullets: string[];
  location?: string;
};

type CvEducation = {
  school: string;
  degree: string;
  dates: string;
  location?: string;
};

type CvProfile = {
  // meta
  title?: string;

  // ident
  fullName: string;
  email: string;
  phone: string;
  linkedin: string;
  profileSummary: string;

  city?: string;
  address?: string;

  contractType: string;
  contractTypeStandard?: string;
  contractTypeFull?: string;

  primaryDomain?: string;
  secondaryDomains?: string[];
  softSkills?: string[];

  drivingLicense?: string;
  vehicle?: string;

  skills: CvSkills;
  experiences: CvExperience[];
  education: CvEducation[];
  educationShort: string[];
  certs: string;
  langLine: string;
  hobbies: string[];
  updatedAt?: number;
};

type Lang = "fr" | "en";
type ViewMode = "cv_lm" | "pitch" | "mail";
type GenerationKind = "cv" | "cv_lm" | "lm" | "pitch";

// =============================
// Helpers (texte & model)
// =============================
function safeText(v: any) {
  return String(v ?? "").replace(/\u00A0/g, " ").trim();
}
function normalizeSpaces(s: string) {
  return safeText(s).replace(/[ \t]+/g, " ").trim();
}
function sanitizeCompanyHeaderName(name: string) {
  let s = safeText(name);
  if (!s) return "";
  s = s.replace(/^(service recrutement|recruitment team)\s*[-:|]?\s*/i, "");
  s = s.replace(/\s+/g, " ").trim();
  s = s.replace(/(.+?)\s+\1$/i, "$1").trim();
  return s;
}
function buildContactLine(p: CvProfile) {
  const parts: string[] = [];
  if (p.city) parts.push(safeText(p.city));
  if (p.phone) parts.push(safeText(p.phone));
  if (p.email) parts.push(safeText(p.email));
  if (p.linkedin) parts.push(safeText(p.linkedin));
  return parts.filter(Boolean).join(" | ");
}

function normalizeHex(v: string) {
  const s = safeText(v).trim();
  return /^#[0-9a-f]{6}$/i.test(s) ? s : "#3b82f6";
}

function categorizeSkills(profile: CvProfile) {
  const cloud: string[] = [];
  const sec: string[] = [];
  const sys: string[] = [];
  const auto: string[] = [];
  const tools: string[] = [];
  const soft: string[] = Array.isArray(profile.softSkills) ? profile.softSkills : [];

  const sections = profile.skills?.sections || [];
  for (const s of sections) {
    const title = (s?.title || "").toLowerCase();
    const items = (s?.items || []).filter(Boolean);
    const pushAll = (arr: string[], vals: string[]) => vals.forEach((x) => arr.push(x));

    if (title.match(/cloud|azure|aws|gcp/)) pushAll(cloud, items);
    else if (title.match(/sécu|secu|security|cyber/)) pushAll(sec, items);
    else if (title.match(/réseau|reseau|system|système|sys/)) pushAll(sys, items);
    else if (title.match(/autom|devops|ia|api/)) pushAll(auto, items);
    else pushAll(tools, items);
  }

  const extraTools = Array.isArray(profile.skills?.tools) ? profile.skills.tools : [];
  extraTools.forEach((t) => tools.push(t));

  const uniq = (arr: string[]) => Array.from(new Set(arr.map((x) => safeText(x)).filter(Boolean)));

  return {
    cloud: uniq(cloud),
    sec: uniq(sec),
    sys: uniq(sys),
    auto: uniq(auto),
    tools: uniq(tools),
    soft: uniq(soft),
  };
}

function profileToCvDocModel(profile: CvProfile, params: { targetJob: string; contract: string }): CvDocModel {
  const titleParts: string[] = [];
  if (params.targetJob?.trim()) titleParts.push(params.targetJob.trim());
  if (params.contract?.trim()) titleParts.push(params.contract.trim());
  const title = titleParts.length > 0 ? titleParts.join(" — ") : profile.contractType || "Candidature";

  const skills = categorizeSkills(profile);

  const xp = (profile.experiences || []).map((x) => ({
    company: safeText(x.company),
    city: safeText(x.location || ""),
    role: safeText(x.role),
    dates: safeText(x.dates),
    bullets: Array.isArray(x.bullets) ? x.bullets.map(safeText).filter(Boolean) : [],
  }));

  const educationLines =
    Array.isArray(profile.educationShort) && profile.educationShort.length
      ? profile.educationShort.map(safeText).filter(Boolean)
      : (profile.education || []).map((e) => {
          const a = safeText(e.degree);
          const b = safeText(e.school);
          const c = safeText(e.dates);
          const d = safeText(e.location || "");
          return [a, b, c, d].filter(Boolean).join(" — ");
        });

  return {
    name: safeText(profile.fullName) || safeText(profile.email) || "Candidat",
    title,
    contactLine: buildContactLine(profile),
    profile: safeText(profile.profileSummary),
    skills,
    xp,
    education: educationLines,
    certs: safeText(profile.certs),
    langLine: safeText(profile.langLine),
    hobbies: Array.isArray(profile.hobbies) ? profile.hobbies.map(safeText).filter(Boolean) : [],
  };
}

// =============================
// LM prompt strict + sanitize
// =============================
function buildProfileContext(profile: CvProfile) {
  const fullName = safeText(profile.fullName);
  const summary = safeText(profile.profileSummary);

  const sections = Array.isArray(profile.skills?.sections) ? profile.skills.sections : [];
  const tools = Array.isArray(profile.skills?.tools) ? profile.skills.tools : [];

  const skillsLines = sections
    .filter((s) => s && (s.title || (Array.isArray(s.items) && s.items.length)))
    .slice(0, 8)
    .map((s) => {
      const title = normalizeSpaces(s.title || "Compétences");
      const items = Array.isArray(s.items) ? s.items.map(safeText).filter(Boolean).slice(0, 18) : [];
      return `- ${title}: ${items.join(", ")}`.trim();
    })
    .filter(Boolean);

  const toolsLine = tools.map(safeText).filter(Boolean).slice(0, 25).join(", ");

  const experiences = Array.isArray(profile.experiences) ? profile.experiences : [];
  const xpLines = experiences.slice(0, 5).map((xp, idx) => {
    const role = normalizeSpaces(xp?.role || "");
    const company = normalizeSpaces(xp?.company || "");
    const dates = normalizeSpaces(xp?.dates || "");
    const location = normalizeSpaces(xp?.location || "");
    const bullets = Array.isArray(xp?.bullets) ? xp.bullets.map(safeText).filter(Boolean).slice(0, 6) : [];

    const header = `EXP${idx + 1}: ${role}${company ? ` — ${company}` : ""}${dates ? ` (${dates})` : ""}${location ? ` — ${location}` : ""}`.trim();
    const bulletBlock = bullets.length ? bullets.map((b) => `  • ${b}`).join("\n") : "  • (détails non fournis)";
    return `${header}\n${bulletBlock}`;
  });

  const educationShort = Array.isArray(profile.educationShort) ? profile.educationShort.map(safeText).filter(Boolean) : [];
  const education = Array.isArray(profile.education) ? profile.education : [];

  const eduLines =
    educationShort.length
      ? educationShort.slice(0, 6)
      : education
          .slice(0, 6)
          .map((e) => [e?.degree, e?.school, e?.dates, e?.location].map(safeText).filter(Boolean).join(" — "))
          .filter(Boolean);

  const certs = safeText(profile.certs);
  const langLine = safeText(profile.langLine);
  const soft = Array.isArray(profile.softSkills) ? profile.softSkills.map(safeText).filter(Boolean).slice(0, 12) : [];

  return [
    `CANDIDAT: ${fullName || "(nom non fourni)"}`,
    summary ? `RESUME: ${summary}` : `RESUME: (non fourni)`,
    "",
    "COMPETENCES (sections):",
    skillsLines.length ? skillsLines.join("\n") : "- (non fournies)",
    "",
    `OUTILS: ${toolsLine || "(non fournis)"}`,
    soft.length ? `SOFT SKILLS: ${soft.join(", ")}` : "",
    "",
    "EXPERIENCES:",
    xpLines.length ? xpLines.join("\n\n") : "(non fournies)",
    "",
    "FORMATION:",
    eduLines.length ? eduLines.map((l) => `- ${l}`).join("\n") : "- (non fournie)",
    "",
    certs ? `CERTIFICATIONS: ${certs}` : "",
    langLine ? `LANGUES: ${langLine}` : "",
  ]
    .filter(Boolean)
    .join("\n")
    .trim();
}

function buildLmPrompt(args: {
  lang: Lang;
  jobTitle: string;
  companyName: string;
  profileContext: string;
  jobDescription: string;
  jobLink: string;
}) {
  const L = args.lang === "en" ? "en" : "fr";
  const title = normalizeSpaces(args.jobTitle || "");
  const company = normalizeSpaces(args.companyName || "");
  const jd = safeText(args.jobDescription || "");
  const link = safeText(args.jobLink || "");

  if (L === "en") {
    return `
Role: You are an expert recruitment assistant.
Task: Write ONLY the BODY text (no header, no address, no date, no subject line, no signature) of a professional, clear, punchy cover letter.

Format constraints:
- Output plain text (no Markdown, no HTML).
- 3 to 5 short, impactful paragraphs.
- Align to the role of "${title || "the role"}" at "${company || "the company"}".
- Do NOT copy/paste the job description.
- Do NOT list tools/skills as a raw catalog; integrate them naturally into sentences.
- Tone: professional, confident, concrete, results-oriented.
- Avoid generic fluff. Avoid invented experience.
- Target length: ~320–450 words.

JOB_URL: ${link || "(not provided)"}

Candidate data:
${args.profileContext || "(no candidate context provided)"}

Job offer hints:
${jd || "(no job description provided)"}

Language: English
`.trim();
  }

  return `
Rôle : Tu es un assistant expert en recrutement.
Tâche : Rédige UNIQUEMENT le CORPS du texte (sans en-tête, sans adresse, sans date, sans objet, sans signature) d’une lettre de motivation professionnelle, claire et percutante.

Contraintes de format :
- Rendu en texte brut (sans Markdown, sans HTML).
- 3 à 5 paragraphes courts et impactants.
- Aligne le discours sur le poste "${title || "le poste"}" chez "${company || "l’entreprise"}".
- Ne copie pas mot pour mot le descriptif du poste.
- N’énumère pas les outils/skills en catalogue : intègre-les naturellement dans des phrases.
- Ton professionnel, déterminé, concret, orienté résultats.
- Pas de blabla générique. N’invente aucune expérience.
- Longueur cible : ~320–450 mots.

OFFRE_URL: ${link || "(non fournie)"}

Données du candidat :
${args.profileContext || "(contexte candidat non fourni)"}

Détails de l’offre (indices) :
${jd || "(description de poste non fournie)"}

Langue de rédaction : Français
`.trim();
}

function sanitizeLM(raw: string): string {
  if (!raw) return "";
  let txt = String(raw);

  txt = txt.replace(/^\uFEFF/, "").replace(/\u200B/g, "");
  txt = txt.replace(/```[\s\S]*?```/g, " ");
  txt = txt.replace(/<\/?body[^>]*>/gi, "\n");
  txt = txt.replace(/<\/?html[^>]*>/gi, "\n");
  txt = txt.replace(/<\/?head[^>]*>[\s\S]*?<\/head>/gi, "\n");
  txt = txt.replace(/<\/?[^>]+>/g, "");

  txt = txt.replace(/^#{1,6}\s+/gm, "");
  txt = txt.replace(/\*\*(.*?)\*\*/g, "$1");
  txt = txt.replace(/__(.*?)__/g, "$1");
  txt = txt.replace(/\*(.*?)\*/g, "$1");
  txt = txt.replace(/_(.*?)_/g, "$1");

  txt = txt
    .split(/\r?\n/)
    .filter((line) => {
      const l = line.trim();
      if (!l) return true;
      return !/^(note|remarque|explication|instruction|exemple)\s*[:\-]/i.test(l);
    })
    .join("\n");

  txt = txt.replace(/^\s*[-•*]\s+/gm, "");
  txt = txt.replace(/\r\n/g, "\n");
  txt = txt.replace(/[ \t]+\n/g, "\n");
  txt = txt.replace(/\n{3,}/g, "\n\n");
  txt = txt.trim();

  return txt;
}

function extractBodyOnly(text: string, lang: Lang, fullName: string) {
  const raw = sanitizeLM(text);
  if (!raw) return "";

  const L = lang === "en" ? "en" : "fr";
  const lines = raw
    .split("\n")
    .map((l) => l.trim())
    .filter(Boolean);

  while (lines.length && /^(objet|subject)\s*:/i.test(lines[0])) lines.shift();

  if (lines.length) {
    const first = lines[0].toLowerCase();
    const isGreeting =
      (L === "fr" && (first.startsWith("madame") || first.startsWith("monsieur") || first.startsWith("bonjour"))) ||
      (L === "en" && (first.startsWith("dear") || first.startsWith("hello")));
    if (isGreeting) lines.shift();
  }

  const name = safeText(fullName).toLowerCase();
  while (lines.length) {
    const last = lines[lines.length - 1].toLowerCase();
    if (
      last.includes("cordialement") ||
      last.includes("bien cordialement") ||
      last.includes("salutations") ||
      last.includes("sincerely") ||
      last.includes("best regards") ||
      last.includes("kind regards")
    ) {
      lines.pop();
      continue;
    }
    if (name && last.includes(name)) {
      lines.pop();
      continue;
    }
    break;
  }

  return lines.join("\n\n").trim();
}

function buildLmModel(profile: CvProfile, lang: Lang, companyNameInput: string, jobTitle: string, letterBodyOnly: string): LmModel {
  const name = safeText(profile.fullName) || "Candidat";

  const contactLines: string[] = [];
  if (profile.phone) contactLines.push(lang === "fr" ? `Téléphone : ${safeText(profile.phone)}` : `Phone: ${safeText(profile.phone)}`);
  if (profile.email) contactLines.push(lang === "fr" ? `Email : ${safeText(profile.email)}` : `Email: ${safeText(profile.email)}`);
  if (profile.linkedin) contactLines.push(lang === "fr" ? `LinkedIn : ${safeText(profile.linkedin)}` : `LinkedIn: ${safeText(profile.linkedin)}`);

  const city = safeText(profile.city) || "Paris";

  // ✅ date stable + timezone Europe/Paris
  const dateStr =
    lang === "fr"
      ? new Intl.DateTimeFormat("fr-FR", { timeZone: "Europe/Paris" }).format(new Date())
      : new Intl.DateTimeFormat("en-GB", { timeZone: "Europe/Paris" }).format(new Date());

  const subject = lang === "fr" ? `Objet : Candidature – ${jobTitle || "poste"}` : `Subject: Application – ${jobTitle || "role"}`;
  const salutation = lang === "fr" ? "Madame, Monsieur," : "Dear Hiring Manager,";
  const closing = lang === "fr" ? "Cordialement," : "Sincerely,";

  const cleaned = sanitizeLM(letterBodyOnly);
  const bodyOnly = extractBodyOnly(cleaned, lang, name) || cleaned;

  return {
    lang,
    name,
    contactLines,
    service: lang === "fr" ? "Service Recrutement" : "Recruitment Team",
    companyName: sanitizeCompanyHeaderName(companyNameInput) || (lang === "fr" ? "Entreprise" : "Company"),
    companyAddr: "",
    city,
    dateStr,
    subject,
    salutation,
    body: bodyOnly,
    closing,
    signature: name,
  };
}

// =============================
// CV editor helpers
// =============================
type CvSectionKey = "profile" | "xp" | "education" | "skills" | "certs" | "languages" | "hobbies";

const DEFAULT_CV_SECTIONS: Record<CvSectionKey, boolean> = {
  profile: true,
  xp: true,
  education: true,
  skills: true,
  certs: true,
  languages: true,
  hobbies: true,
};

const splitList = (s: string) =>
  String(s || "")
    .split(/[,\n;|•]+/g)
    .map((x) => x.trim())
    .filter(Boolean);

const joinList = (arr: string[]) => (Array.isArray(arr) ? arr.filter(Boolean).join(", ") : "");
const textToLines = (t: string) => String(t || "").split(/\r?\n/g).map((x) => x.trim()).filter(Boolean);
const linesToText = (lines: string[]) => (Array.isArray(lines) ? lines.filter(Boolean).join("\n") : "");
const bulletsToText = (bullets: string[]) => linesToText(Array.isArray(bullets) ? bullets : []);
const textToBullets = (t: string) => textToLines(t);

function emptySkillsLike(base: any) {
  const keys = ["cloud", "sec", "sys", "auto", "tools", "soft"];
  const out: any = {};
  for (const k of keys) out[k] = [];
  if (!base) return out;
  for (const k of Object.keys(base)) {
    if (Array.isArray(base[k])) out[k] = [];
  }
  return out;
}

// =============================
// Full screen modal
// =============================
function useLockBodyScroll(locked: boolean) {
  useEffect(() => {
    if (!locked) return;
    const prev = document.body.style.overflow;
    document.body.style.overflow = "hidden";
    return () => {
      document.body.style.overflow = prev;
    };
  }, [locked]);
}

function FullScreenModal({
  open,
  title,
  onClose,
  actions,
  children,
}: {
  open: boolean;
  title: string;
  onClose: () => void;
  actions?: ReactNode;
  children: ReactNode;
}) {
  useLockBodyScroll(open);

  useEffect(() => {
    if (!open) return;
    const onKey = (e: KeyboardEvent) => {
      if (e.key === "Escape") onClose();
    };
    window.addEventListener("keydown", onKey);
    return () => window.removeEventListener("keydown", onKey);
  }, [open, onClose]);

  if (!open) return null;

  return (
    <div className="fixed inset-0 z-[80]" role="dialog" aria-modal="true">
      <div className="absolute inset-0 bg-black/60" onClick={onClose} />
      <div className="absolute inset-0 p-2 sm:p-3">
        <div className="h-full w-full rounded-2xl border border-[var(--border)] bg-[var(--bg)] shadow-xl overflow-hidden flex flex-col">
          <div className="p-2.5 sm:p-3 border-b border-[var(--border)] bg-[var(--bg-soft)] flex items-center justify-between gap-2">
            <div className="min-w-0">
              <p className="text-[12px] font-semibold text-[var(--ink)] truncate">{title}</p>
              <p className="text-[10px] text-[var(--muted)]">ESC pour fermer</p>
            </div>
            <div className="flex items-center gap-2">
              {actions}
              <button type="button" className="btn-secondary !py-1.5 !px-3 text-[12px]" onClick={onClose}>
                Fermer
              </button>
            </div>
          </div>

          <div className="flex-1 min-h-0">{children}</div>
        </div>
      </div>
    </div>
  );
}

// =============================
// PDF VIEWER via PDF.js CDN
// =============================
let __pdfjsReady = false;
let __pdfjs: any = null;
let __pdfjsLoading: Promise<any> | null = null;

async function ensurePdfJs() {
  if (__pdfjsReady && __pdfjs) return __pdfjs;
  if (__pdfjsLoading) return __pdfjsLoading;

  __pdfjsLoading = (async () => {
    if (typeof window === "undefined") throw new Error("PDF.js doit être chargé côté client.");
    const PDFJS_VERSION = "4.0.379";
    const pdfjs: any = await import(/* webpackIgnore: true */ `https://cdn.jsdelivr.net/npm/pdfjs-dist@${PDFJS_VERSION}/build/pdf.mjs`);
    pdfjs.GlobalWorkerOptions.workerSrc = `https://cdn.jsdelivr.net/npm/pdfjs-dist@${PDFJS_VERSION}/build/pdf.worker.min.mjs`;
    __pdfjs = pdfjs;
    __pdfjsReady = true;
    return pdfjs;
  })();

  return __pdfjsLoading;
}

function PdfCanvasViewer({ fileUrl, className }: { fileUrl: string | null; className?: string }) {
  const wrapRef = useRef<HTMLDivElement | null>(null);
  const canvasRef = useRef<HTMLCanvasElement | null>(null);

  // ✅ avoid leaks / overlapping renders
  const loadingTaskRef = useRef<any>(null);
  const renderTaskRef = useRef<any>(null);

  const [pdf, setPdf] = useState<any>(null);
  const [numPages, setNumPages] = useState(1);
  const [page, setPage] = useState(1);
  const [scale, setScale] = useState(1.05);
  const [rendering, setRendering] = useState(false);
  const [err, setErr] = useState<string | null>(null);

  useEffect(() => {
    let cancelled = false;

    (async () => {
      setErr(null);
      setPdf(null);
      setNumPages(1);
      setPage(1);

      // cleanup previous tasks / doc
      try {
        renderTaskRef.current?.cancel?.();
      } catch {}
      renderTaskRef.current = null;

      try {
        loadingTaskRef.current?.destroy?.();
      } catch {}
      loadingTaskRef.current = null;

      try {
        await pdf?.destroy?.();
      } catch {}

      if (!fileUrl) return;

      try {
        const pdfjs = await ensurePdfJs();
        const task = (pdfjs as any).getDocument({ url: fileUrl });
        loadingTaskRef.current = task;

        const doc = await task.promise;
        if (cancelled) {
          try {
            await doc?.destroy?.();
          } catch {}
          return;
        }

        setPdf(doc);
        setNumPages(doc.numPages || 1);
      } catch (e: any) {
        if (cancelled) return;
        setErr(e?.message || "Impossible d’ouvrir le PDF.");
      }
    })();

    return () => {
      cancelled = true;
    };
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [fileUrl]);

  useEffect(() => {
    let cancelled = false;

    (async () => {
      if (!pdf || !canvasRef.current) return;

      // cancel previous render if any
      try {
        renderTaskRef.current?.cancel?.();
      } catch {}
      renderTaskRef.current = null;

      setRendering(true);

      try {
        const p = await pdf.getPage(page);
        if (cancelled) return;

        const dpr = typeof window !== "undefined" ? window.devicePixelRatio || 1 : 1;
        const viewport = p.getViewport({ scale });

        const canvas = canvasRef.current!;
        const ctx = canvas.getContext("2d");
        if (!ctx) throw new Error("Canvas context indisponible.");

        canvas.width = Math.floor(viewport.width * dpr);
        canvas.height = Math.floor(viewport.height * dpr);
        canvas.style.width = `${Math.floor(viewport.width)}px`;
        canvas.style.height = `${Math.floor(viewport.height)}px`;

        ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

        const renderTask = p.render({ canvasContext: ctx, viewport });
        renderTaskRef.current = renderTask;

        await renderTask.promise;

        if (!cancelled) setErr(null);
      } catch (e: any) {
        if (!cancelled) setErr(e?.message || "Erreur rendu PDF.");
      } finally {
        if (!cancelled) setRendering(false);
      }
    })();

    return () => {
      cancelled = true;
    };
  }, [pdf, page, scale]);

  const canPrev = page > 1;
  const canNext = page < numPages;

  const fitWidth = async () => {
    if (!pdf || !wrapRef.current) return;
    try {
      const p = await pdf.getPage(page);
      const viewport1 = p.getViewport({ scale: 1 });
      const pad = 24;
      const w = Math.max(280, wrapRef.current.clientWidth - pad);
      const next = w / viewport1.width;
      setScale(Math.max(0.4, Math.min(2.2, next)));
    } catch {
      // ignore
    }
  };

  return (
    <div className={["h-full min-h-0 flex flex-col", className || ""].join(" ")}>
      <div className="px-2.5 py-2 border-b border-[var(--border)] bg-[var(--bg-soft)] flex flex-wrap items-center justify-between gap-2">
        <div className="flex items-center gap-2 text-[11px] text-[var(--muted)]">
          <span className="inline-flex items-center gap-1">
            <span className="font-medium text-[var(--ink)]">Page</span>
            <input
              className="input !py-1 !px-2 !text-[11px] w-[56px] bg-[var(--bg)]"
              value={String(page)}
              onChange={(e) => {
                const n = Number(e.target.value || "1");
                if (!Number.isFinite(n)) return;
                setPage(Math.max(1, Math.min(numPages, Math.floor(n))));
              }}
            />
            <span>/ {numPages}</span>
          </span>

          {rendering && (
            <span className="inline-flex items-center gap-1">
              <span className="inline-flex w-3 h-3 rounded-full border-2 border-[var(--brand)] border-t-transparent animate-spin" />
              rendu…
            </span>
          )}
        </div>

        <div className="flex items-center gap-2">
          <button type="button" className="btn-secondary !py-1 !px-2.5 text-[11px]" onClick={() => canPrev && setPage((p) => p - 1)} disabled={!canPrev}>
            ←
          </button>
          <button type="button" className="btn-secondary !py-1 !px-2.5 text-[11px]" onClick={() => canNext && setPage((p) => p + 1)} disabled={!canNext}>
            →
          </button>

          <span className="w-[1px] h-5 bg-[var(--border)] mx-1" />

          <button type="button" className="btn-secondary !py-1 !px-2.5 text-[11px]" onClick={() => setScale((s) => Math.max(0.4, Number((s - 0.1).toFixed(2))))}>
            -
          </button>
          <span className="text-[11px] text-[var(--muted)] w-[52px] text-center">{Math.round(scale * 100)}%</span>
          <button type="button" className="btn-secondary !py-1 !px-2.5 text-[11px]" onClick={() => setScale((s) => Math.min(2.2, Number((s + 0.1).toFixed(2))))}>
            +
          </button>

          <button type="button" className="btn-secondary !py-1 !px-2.5 text-[11px]" onClick={fitWidth}>
            Ajuster
          </button>
        </div>
      </div>

      <div ref={wrapRef} className="flex-1 min-h-0 overflow-auto bg-white">
        {err ? (
          <div className="p-4 text-[11px] text-red-400">{err}</div>
        ) : !fileUrl ? (
          <div className="h-full flex items-center justify-center text-[11px] text-[var(--muted)]">Aucun PDF à afficher.</div>
        ) : (
          <div className="p-2.5 flex justify-center">
            <canvas ref={canvasRef} className="shadow-sm border border-black/10 rounded-lg bg-white" />
          </div>
        )}
      </div>
    </div>
  );
}

// =============================
// UI bits (compact)
// =============================
function CyberCard({ className = "", children }: { className?: string; children: ReactNode }) {
  return <div className={["bg-slate-900/60 border border-white/5 rounded-2xl p-4 backdrop-blur-md shadow-xl", className].join(" ")}>{children}</div>;
}

function CyberSectionTitle({ icon, title, subtitle }: { icon?: ReactNode; title: string; subtitle?: string }) {
  return (
    <div className="mb-3">
      <h3 className="text-[11px] font-bold text-white uppercase tracking-widest flex items-center gap-2">
        {icon}
        {title}
      </h3>
      {subtitle ? <p className="text-[11px] text-slate-500 mt-1">{subtitle}</p> : null}
    </div>
  );
}

function CyberInput({ label, value, onChange, placeholder, area = false, rows = 4, type = "text" }: any) {
  return (
    <div className="space-y-1.5">
      <label className="text-[10px] font-bold text-slate-500 uppercase tracking-widest ml-1">{label}</label>
      {area ? (
        <textarea
          value={value}
          onChange={(e) => onChange(e.target.value)}
          placeholder={placeholder}
          rows={rows}
          className="w-full bg-slate-950/50 border border-white/10 rounded-xl px-3.5 py-2.5 text-xs text-slate-300 focus:border-blue-500/50 outline-none transition-all resize-none custom-scrollbar placeholder:text-slate-700"
        />
      ) : (
        <input
          value={value}
          onChange={(e) => onChange(e.target.value)}
          placeholder={placeholder}
          type={type}
          className="w-full bg-slate-950/50 border border-white/10 rounded-xl px-3.5 py-2.5 text-xs text-slate-300 focus:border-blue-500/50 outline-none transition-all placeholder:text-slate-700"
        />
      )}
    </div>
  );
}

function CyberPillTabs<T extends string>({
  value,
  onChange,
  items,
}: {
  value: T;
  onChange: (v: T) => void;
  items: Array<{ key: T; label: string; icon?: ReactNode }>;
}) {
  return (
    <div className="flex bg-slate-950 rounded-xl p-1 border border-white/10">
      {items.map((it) => {
        const active = value === it.key;
        return (
          <button
            key={it.key}
            type="button"
            onClick={() => onChange(it.key)}
            className={[
              "flex-1 flex items-center justify-center gap-2 px-3 py-2 rounded-lg text-[10px] font-bold transition-all",
              active ? "bg-white text-slate-900" : "text-slate-500 hover:text-white hover:bg-white/5",
            ].join(" ")}
          >
            {it.icon}
            <span>{it.label}</span>
          </button>
        );
      })}
    </div>
  );
}

function CyberCallout({ kind, children }: { kind: "error" | "success" | "info"; children: ReactNode }) {
  const styles =
    kind === "success"
      ? "bg-emerald-500/10 border-emerald-500/20 text-emerald-200"
      : kind === "error"
        ? "bg-red-500/10 border-red-500/20 text-red-200"
        : "bg-white/5 border-white/10 text-slate-300";

  const Icon = kind === "success" ? CheckCircle2 : kind === "error" ? AlertCircle : MessageSquareText;

  return (
    <div className={["p-3 rounded-xl border flex items-start gap-3", styles].join(" ")}>
      <Icon className="h-4 w-4 mt-0.5 opacity-90" />
      <div className="text-xs leading-relaxed">{children}</div>
    </div>
  );
}

// =============================
// PAGE
// =============================
export default function AssistanceCandidaturePage() {
  // --- profil ---
  const [userId, setUserId] = useState<string | null>(null);
  const [profile, setProfile] = useState<CvProfile | null>(null);
  const [loadingProfile, setLoadingProfile] = useState(true);

  const [globalLoadingMessage, setGlobalLoadingMessage] = useState<string | null>(null);

  // ✅ Tabs
  const [viewMode, setViewMode] = useState<ViewMode>("cv_lm");

  // ✅ Mobile: switch between CONFIG / PREVIEW to keep “one-screen”
  const [mobilePane, setMobilePane] = useState<"config" | "preview">("config");

  // --- CV ---
  const [cvTargetJob, setCvTargetJob] = useState("");
  const [cvTemplate, setCvTemplate] = useState<CvTemplateId>("ats");
  const [cvLang, setCvLang] = useState<Lang>("fr");
  const [cvContract, setCvContract] = useState("CDI");

  const [cvLoading, setCvLoading] = useState(false);
  const [cvStatus, setCvStatus] = useState<string | null>(null);
  const [cvError, setCvError] = useState<string | null>(null);

  const [pdfBrand, setPdfBrand] = useState("#3b82f6");
  const [cvOfferDescription, setCvOfferDescription] = useState("");
  const [cvUseAiOptimizeOnDownload, setCvUseAiOptimizeOnDownload] = useState(true);

  const [templatesModalOpen, setTemplatesModalOpen] = useState(false);
  const [templateSearch, setTemplateSearch] = useState("");

  const [cvSections, setCvSections] = useState<Record<CvSectionKey, boolean>>(DEFAULT_CV_SECTIONS);
  const [cvDraft, setCvDraft] = useState<CvDocModel | null>(null);
  const [cvDraftDirty, setCvDraftDirty] = useState(false);

  const [cvLastBlob, setCvLastBlob] = useState<Blob | null>(null);
  const [cvPreviewUrl, setCvPreviewUrl] = useState<string | null>(null);

  const [cvLmLastBlob, setCvLmLastBlob] = useState<Blob | null>(null);
  const [cvLmPreviewUrl, setCvLmPreviewUrl] = useState<string | null>(null);

  // Fullscreen modals
  const [cvEditorOpen, setCvEditorOpen] = useState(false);
  const [cvLmViewerOpen, setCvLmViewerOpen] = useState(false);
  const [cvMobileView, setCvMobileView] = useState<"edit" | "preview">("edit");

  // --- LM ---
  const [lmLang, setLmLang] = useState<Lang>("fr");
  const [companyName, setCompanyName] = useState("");
  const [jobTitle, setJobTitle] = useState("");
  const [jobDescription, setJobDescription] = useState("");
  const [jobLink, setJobLink] = useState("");

  const [letterBody, setLetterBody] = useState("");
  const [lmLoading, setLmLoading] = useState(false);
  const [lmError, setLmError] = useState<string | null>(null);

  const [lmPdfLoading, setLmPdfLoading] = useState(false);
  const [lmPdfError, setLmPdfError] = useState<string | null>(null);

  const [lmLastBlob, setLmLastBlob] = useState<Blob | null>(null);
  const [lmPreviewUrl, setLmPreviewUrl] = useState<string | null>(null);
  const [lmEditorOpen, setLmEditorOpen] = useState(false);

  // --- PITCH ---
  const [pitchLang, setPitchLang] = useState<Lang>("fr");
  const [pitchText, setPitchText] = useState("");
  const [pitchLoading, setPitchLoading] = useState(false);
  const [pitchError, setPitchError] = useState<string | null>(null);
  const [pitchCopied, setPitchCopied] = useState(false);

  // --- MAIL ---
  const [recruiterName, setRecruiterName] = useState("");
  const [emailTone, setEmailTone] = useState<"standard" | "court" | "pro">("standard");
  const [emailPreview, setEmailPreview] = useState("");
  const [subjectPreview, setSubjectPreview] = useState("");
  const [emailCopied, setEmailCopied] = useState(false);

  // --- Auto create
  const [cvAutoCreate, setCvAutoCreate] = useState(true);

  // =============================
  // Load profile
  // =============================
  useEffect(() => {
    const unsub = onAuthStateChanged(auth, async (user) => {
      if (!user) {
        setUserId(null);
        setProfile(null);
        setLoadingProfile(false);
        return;
      }

      setUserId(user.uid);

      try {
        const ref = doc(db, "profiles", user.uid);
        const snap = await getDoc(ref);

        if (snap.exists()) {
          const data = snap.data() as any;

          const loadedProfile: CvProfile = {
            title: data.title || "",
            fullName: data.fullName || "",
            email: data.email || "",
            phone: data.phone || "",
            linkedin: data.linkedin || "",
            profileSummary: data.profileSummary || "",
            city: data.city || "",
            address: data.address || "",
            contractType: data.contractType || data.contractTypeStandard || "",
            contractTypeStandard: data.contractTypeStandard || "",
            contractTypeFull: data.contractTypeFull || "",
            primaryDomain: data.primaryDomain || "",
            secondaryDomains: Array.isArray(data.secondaryDomains) ? data.secondaryDomains : [],
            softSkills: Array.isArray(data.softSkills) ? data.softSkills : [],
            drivingLicense: data.drivingLicense || "",
            vehicle: data.vehicle || "",
            skills: {
              sections: Array.isArray(data.skills?.sections) ? data.skills.sections : [],
              tools: Array.isArray(data.skills?.tools) ? data.skills.tools : [],
            },
            experiences: Array.isArray(data.experiences) ? data.experiences : [],
            education: Array.isArray(data.education) ? data.education : [],
            educationShort: Array.isArray(data.educationShort) ? data.educationShort : [],
            certs: data.certs || "",
            langLine: data.langLine || "",
            hobbies: Array.isArray(data.hobbies) ? data.hobbies : [],
            updatedAt: typeof data.updatedAt === "number" ? data.updatedAt : undefined,
          };

          setProfile(loadedProfile);

          // prefill titles
          const detectedTitle = safeText(data.title);
          if (detectedTitle) {
            setCvTargetJob((v) => v || detectedTitle);
            setJobTitle((v) => v || detectedTitle);
          }
        } else {
          setProfile(null);
        }
      } catch (e) {
        console.error("Erreur chargement profil Firestore:", e);
      } finally {
        setLoadingProfile(false);
      }
    });

    return () => unsub();
  }, []);

  // =============================
  // Derived
  // =============================
  const miniHeadline = profile?.profileSummary?.split(".")[0] || profile?.contractType || "Analyse ton CV PDF dans « CV IA » pour activer l’assistant.";

  const targetedJob = jobTitle || cvTargetJob || "Poste cible";
  const targetedCompany = companyName || "Entreprise";

  const cvTemplates = useMemo(() => getCvTemplates(), []);
  const colors = useMemo(() => makePdfColors(normalizeHex(pdfBrand)), [pdfBrand]);

  const baseCvModel = useMemo(() => {
    if (!profile) return null;
    return profileToCvDocModel(profile, { targetJob: cvTargetJob, contract: cvContract });
  }, [profile, cvTargetJob, cvContract]);

  useEffect(() => {
    if (!baseCvModel) return;
    if (!cvDraft || !cvDraftDirty) setCvDraft(baseCvModel);
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [baseCvModel]);

  useEffect(() => {
    return () => {
      if (cvPreviewUrl) URL.revokeObjectURL(cvPreviewUrl);
      if (lmPreviewUrl) URL.revokeObjectURL(lmPreviewUrl);
      if (cvLmPreviewUrl) URL.revokeObjectURL(cvLmPreviewUrl);
    };
  }, [cvPreviewUrl, lmPreviewUrl, cvLmPreviewUrl]);

  const top3Templates = useMemo(() => {
    const all = cvTemplates || [];
    const first = all.slice(0, 3);
    if (cvTemplate && !first.some((t) => t.id === cvTemplate)) {
      const sel = all.find((t) => t.id === cvTemplate);
      if (sel) return [first[0], first[1], sel].filter(Boolean);
    }
    return first;
  }, [cvTemplates, cvTemplate]);

  const filteredTemplates = useMemo(() => {
    const q = templateSearch.trim().toLowerCase();
    if (!q) return cvTemplates;
    return cvTemplates.filter((t) => (t.label + " " + t.description).toLowerCase().includes(q));
  }, [cvTemplates, templateSearch]);

  // =============================
  // Build final CV model
  // =============================
  const buildFinalCvModel = () => {
    const m = (cvDraft || baseCvModel) as CvDocModel;
    return {
      ...m,
      profile: cvSections.profile ? m.profile : "",
      xp: cvSections.xp ? m.xp : [],
      education: cvSections.education ? m.education : [],
      skills: cvSections.skills ? m.skills : (emptySkillsLike((m as any).skills) as any),
      certs: cvSections.certs ? m.certs : "",
      langLine: cvSections.languages ? m.langLine : "",
      hobbies: cvSections.hobbies ? m.hobbies : [],
    } as CvDocModel;
  };

  // =============================
  // Firestore: auto create
  // =============================
  const autoCreateApplication = async (kind: GenerationKind) => {
    if (!cvAutoCreate) return;
    if (!userId || !profile) return;

    try {
      const appsRef = collection(db, "applications");
      await addDoc(appsRef, {
        userId,
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp(),
        company: companyName || "",
        jobTitle: jobTitle || cvTargetJob || "",
        jobLink: jobLink || "",
        status: "draft",
        source: "Assistant candidature IA",
        hasCv: kind === "cv" || kind === "cv_lm",
        hasLm: kind === "lm" || kind === "cv_lm",
        hasPitch: kind === "pitch",
        langCv: cvLang,
        langLm: lmLang,
        langPitch: pitchLang,
      });
    } catch (e) {
      console.error("Erreur création entrée suivi candidature:", e);
    }
  };

  // =============================
  // CV preview (no download)
  // =============================
  const prepareCvPreview = async (): Promise<Blob | null> => {
    if (!profile || !baseCvModel) {
      setCvError("Aucun profil CV IA détecté. Va d'abord dans l'onglet CV IA.");
      return null;
    }

    setCvError(null);
    setCvStatus(null);
    setCvLoading(true);
    setGlobalLoadingMessage("Aperçu CV…");

    try {
      const cvModel = buildFinalCvModel();
      const { blob, bestScale } = await fitOnePage((scale) => buildCvPdf(cvTemplate, cvModel, cvLang, colors, "auto", scale));

      setCvLastBlob(blob);
      const nextUrl = URL.createObjectURL(blob);
      setCvPreviewUrl((prev) => {
        if (prev) URL.revokeObjectURL(prev);
        return nextUrl;
      });

      setCvStatus(`Aperçu prêt ✅ (scale=${bestScale.toFixed(2)})`);
      return blob;
    } catch (err: any) {
      console.error("Erreur preview CV:", err);
      setCvError(err?.message || "Impossible de générer l’aperçu CV.");
      return null;
    } finally {
      setCvLoading(false);
      setGlobalLoadingMessage(null);
    }
  };

  // =============================
  // Download CV (click)
  // =============================
  const downloadCv = async () => {
    if (!profile || !baseCvModel) {
      setCvError("Aucun profil CV IA détecté. Va d'abord dans l'onglet CV IA.");
      return;
    }

    if (cvUseAiOptimizeOnDownload && cvOfferDescription.trim()) {
      try {
        const user = auth.currentUser;
        if (!user) throw new Error("Connecte-toi pour télécharger un CV adapté.");

        setCvError(null);
        setGlobalLoadingMessage("CV adapté à l’offre (IA)…");
        const idToken = await user.getIdToken();
        const recaptchaToken = await getRecaptchaToken("generate_cv_pdf");

        const blob = await callGenerateCvPdf({
          profile: profile as any,
          targetJob: cvTargetJob,
          lang: cvLang,
          contract: cvContract,
          jobLink,
          jobDescription: cvOfferDescription,
          companyName,
          recaptchaToken,
          idToken,
        });

        downloadBlob(blob, "cv-ia-adapte.pdf");
        await autoCreateApplication("cv");

        await logUsage({
          user,
          action: "download_pdf",
          docType: "cv",
          eventType: "cv_download",
          tool: "cloudFunctionGenerateCvPdf",
        });

        return;
      } catch (e: any) {
        setCvError(e?.message || "Impossible d’adapter le CV via IA.");
      } finally {
        setGlobalLoadingMessage(null);
      }
    }

    const blob = cvLastBlob ?? (await prepareCvPreview());
    if (!blob) return;

    downloadBlob(blob, "cv-ia.pdf");
    await autoCreateApplication("cv");

    if (auth.currentUser) {
      await logUsage({
        user: auth.currentUser,
        action: "download_pdf",
        docType: "cv",
        eventType: "cv_download",
        tool: "clientPdfMakeCv",
      });
    }
  };

  // =============================
  // Letter text (AI)
  // =============================
  const generateCoverLetterText = async (lang: Lang): Promise<string> => {
    if (!profile) throw new Error("Profil manquant.");
    if (!jobTitle && !jobDescription) throw new Error("Ajoute au moins l'intitulé du poste ou un extrait de la description.");

    const user = auth.currentUser;
    if (!user) throw new Error("Vous devez être connecté pour générer une lettre.");

    const idToken = await user.getIdToken();
    const recaptchaToken = await getRecaptchaToken("generate_letter_pitch");

    const profileContext = buildProfileContext(profile);
    const strictPrompt = buildLmPrompt({
      lang,
      jobTitle,
      companyName,
      profileContext,
      jobDescription,
      jobLink,
    });

    const res = await callGenerateLetterAndPitch({
      profile: profile as any,
      jobTitle,
      companyName,
      jobDescription: strictPrompt,
      lang,
      recaptchaToken,
      idToken,
    });

    const out = (res.letterBody || res.coverLetter || "").trim();
    const cleaned = sanitizeLM(out);
    if (!cleaned) throw new Error("Lettre vide renvoyée par l'API.");

    const name = safeText(profile.fullName);
    return extractBodyOnly(cleaned, lang, name) || cleaned;
  };

  // =============================
  // LM preview (no download)
  // =============================
  const prepareLmPreview = async (opts?: { ensureText?: boolean }): Promise<Blob | null> => {
    if (!profile) {
      setLmPdfError("Profil manquant.");
      return null;
    }

    setLmPdfError(null);
    setLmPdfLoading(true);
    setGlobalLoadingMessage("Aperçu LM…");

    try {
      let cover = letterBody?.trim();

      if (opts?.ensureText && !cover) {
        setGlobalLoadingMessage("Texte lettre (IA)…");
        cover = await generateCoverLetterText(lmLang);
        setLetterBody(cover);
      }

      if (!cover) throw new Error("Texte de lettre vide. Génère ou colle un texte.");

      const lmModel: LmModel = buildLmModel(profile, lmLang, companyName, jobTitle, cover);
      const { blob } = await fitOnePage((scale) => buildLmStyledPdf(lmModel, colors as any, scale), {
        min: 0.85,
        max: 1.6,
        iterations: 7,
        initial: 1.0,
      });

      setLmLastBlob(blob);
      const nextUrl = URL.createObjectURL(blob);
      setLmPreviewUrl((prev) => {
        if (prev) URL.revokeObjectURL(prev);
        return nextUrl;
      });

      return blob;
    } catch (err: any) {
      console.error("Erreur preview LM:", err);
      setLmPdfError(err?.message || "Impossible de générer l’aperçu LM.");
      return null;
    } finally {
      setLmPdfLoading(false);
      setGlobalLoadingMessage(null);
    }
  };

  // Download LM
  const downloadLm = async () => {
    const blob = lmLastBlob ?? (await prepareLmPreview({ ensureText: true }));
    if (!blob) return;

    downloadBlob(blob, "lettre-motivation.pdf");
    await autoCreateApplication("lm");

    if (auth.currentUser) {
      await logUsage({
        user: auth.currentUser,
        action: "download_pdf",
        docType: "lm",
        eventType: "lm_download",
        tool: "clientPdfMakeLm",
      });
    }
  };

  // =============================
  // CV+LM preview + download
  // =============================
  const prepareCvLmPreview = async (): Promise<Blob | null> => {
    if (!profile || !baseCvModel) {
      setCvError("Aucun profil CV IA détecté.");
      return null;
    }

    setCvError(null);
    setCvStatus(null);
    setCvLoading(true);
    setGlobalLoadingMessage("Aperçu CV+LM…");

    try {
      const cvModel = buildFinalCvModel();
      const cvFit = await fitOnePage((scale) => buildCvPdf(cvTemplate, cvModel, cvLang, colors, "auto", scale));

      let cover = letterBody?.trim();
      if (!cover) {
        setGlobalLoadingMessage("Texte lettre (IA)…");
        cover = await generateCoverLetterText(lmLang);
        setLetterBody(cover);
      }
      const lmModel: LmModel = buildLmModel(profile, lmLang, companyName, jobTitle, cover);
      const lmFit = await fitOnePage((scale) => buildLmStyledPdf(lmModel, colors as any, scale), {
        min: 0.85,
        max: 1.6,
        iterations: 7,
        initial: 1.0,
      });

      const merged = await mergePdfBlobs([cvFit.blob, lmFit.blob]);
      setCvLmLastBlob(merged);

      const nextUrl = URL.createObjectURL(merged);
      setCvLmPreviewUrl((prev) => {
        if (prev) URL.revokeObjectURL(prev);
        return nextUrl;
      });

      setCvStatus("Aperçu CV+LM prêt ✅ (2 pages)");
      return merged;
    } catch (err: any) {
      console.error("Erreur preview CV+LM:", err);
      setCvError(err?.message || "Impossible de générer l’aperçu CV+LM.");
      return null;
    } finally {
      setCvLoading(false);
      setGlobalLoadingMessage(null);
    }
  };

  const downloadCvLm = async () => {
    const blob = cvLmLastBlob ?? (await prepareCvLmPreview());
    if (!blob) return;

    downloadBlob(blob, "cv-lm-ia.pdf");
    await autoCreateApplication("cv_lm");

    if (auth.currentUser) {
      await logUsage({
        user: auth.currentUser,
        action: "download_pdf",
        docType: "cv",
        eventType: "cv_lm_download",
        tool: "clientPdfMakeCvLm",
      });
    }
  };

  // =============================
  // Debounced auto preview in editors
  // =============================
  const cvPreviewTimer = useRef<number | null>(null);
  useEffect(() => {
    if (!cvEditorOpen) return;
    if (!cvDraft) return;

    if (cvPreviewTimer.current) window.clearTimeout(cvPreviewTimer.current);
    cvPreviewTimer.current = window.setTimeout(() => {
      prepareCvPreview();
    }, 420);

    return () => {
      if (cvPreviewTimer.current) window.clearTimeout(cvPreviewTimer.current);
    };
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [cvEditorOpen, cvDraft, cvSections, cvTemplate, cvLang, colors]);

  const lmPreviewTimer = useRef<number | null>(null);
  useEffect(() => {
    if (!lmEditorOpen) return;
    if (!letterBody?.trim()) return;

    if (lmPreviewTimer.current) window.clearTimeout(lmPreviewTimer.current);
    lmPreviewTimer.current = window.setTimeout(() => {
      prepareLmPreview({ ensureText: false });
    }, 420);

    return () => {
      if (lmPreviewTimer.current) window.clearTimeout(lmPreviewTimer.current);
    };
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [lmEditorOpen, letterBody, lmLang, colors, companyName, jobTitle]);

  // =============================
  // Generate LM (button)
  // =============================
  const handleGenerateLetter = async (e?: FormEvent) => {
    if (e) e.preventDefault();
    if (!profile) {
      setLmError("Aucun profil CV IA détecté. Va d'abord dans l'onglet CV IA.");
      return;
    }
    if (!jobTitle && !jobDescription) {
      setLmError("Ajoute au moins l'intitulé du poste ou un extrait de la description.");
      return;
    }

    setLmError(null);
    setLmPdfError(null);
    setPitchError(null);
    setLmLoading(true);
    setGlobalLoadingMessage("Lettre (IA)…");

    try {
      const coverLetterBody = await generateCoverLetterText(lmLang);
      setLetterBody(coverLetterBody);
      setLmEditorOpen(true);
      await prepareLmPreview({ ensureText: false });
    } catch (err: any) {
      console.error("Erreur generateLetter:", err);
      setLmError(err?.message || "Impossible de générer la lettre de motivation.");
    } finally {
      setLmLoading(false);
      setGlobalLoadingMessage(null);
    }
  };

  // =============================
  // Pitch
  // =============================
  const handleGeneratePitch = async () => {
    if (!profile) {
      setPitchError("Aucun profil CV IA détecté. Va d'abord dans l'onglet CV IA.");
      return;
    }

    const effectiveJobTitle = jobTitle || cvTargetJob || "Candidature cible";
    const effectiveDesc = jobDescription || "";

    setPitchError(null);
    setPitchLoading(true);
    setPitchCopied(false);
    setGlobalLoadingMessage("Pitch (IA)…");

    try {
      const user = auth.currentUser;
      if (!user) throw new Error("Connecte-toi pour générer un pitch.");
      const token = await user.getIdToken();
      const recaptchaToken = await getRecaptchaToken("generate_letter_pitch");

      const res = await callGenerateLetterAndPitch({
        profile: profile as any,
        jobTitle: effectiveJobTitle,
        companyName,
        jobDescription: effectiveDesc,
        lang: pitchLang,
        recaptchaToken,
        idToken: token,
      });

      const pitch = (res.pitch || "").trim();
      if (!pitch) throw new Error("Pitch vide renvoyé par l'API.");

      setPitchText(pitch);
      await autoCreateApplication("pitch");

      await logUsage({
        user,
        action: "generate_pitch",
        docType: "other",
        eventType: "generate",
        tool: "generateLetterAndPitch",
      });
    } catch (err: any) {
      console.error("Erreur generatePitch:", err);
      setPitchError(err?.message || "Impossible de générer le pitch.");
    } finally {
      setPitchLoading(false);
      setGlobalLoadingMessage(null);
    }
  };

  const handleCopyPitch = async () => {
    if (!pitchText) return;
    try {
      await navigator.clipboard.writeText(pitchText);
      setPitchCopied(true);
      setTimeout(() => setPitchCopied(false), 1200);
    } catch (e) {
      console.error("Erreur copie pitch:", e);
    }
  };

  // =============================
  // Mail
  // =============================
  const buildEmailContent = () => {
    const name = profile?.fullName || "";
    const recruiter = recruiterName.trim();
    const greeting = recruiter ? `Bonjour ${recruiter},` : "Bonjour,";

    const job = jobTitle || "le poste";
    const company = companyName || "votre entreprise";

    const subject = `Candidature – ${job} – ${name || "Candidat"}`;

    let body = "";

    if (emailTone === "court") {
      body = `${greeting}

Je vous contacte pour vous proposer ma candidature au poste de ${job} chez ${company}.
Vous trouverez en pièces jointes mon CV et ma lettre de motivation.

Je suis disponible pour un échange à votre convenance.

Cordialement,
${name || "—"}
`;
    } else if (emailTone === "pro") {
      body = `${greeting}

Je me permets de vous soumettre ma candidature au poste de ${job} au sein de ${company}.
Au regard de mon parcours, je peux apporter une contribution concrète sur les sujets clés du poste (mise en œuvre, amélioration continue, fiabilisation et travail transverse).

Vous trouverez en pièces jointes mon CV ainsi que ma lettre de motivation.
Je serais ravi(e) d’échanger avec vous afin de préciser ma motivation et mes disponibilités.

Bien cordialement,
${name || "—"}
`;
    } else {
      body = `${greeting}

Je vous adresse ma candidature pour le poste de ${job} au sein de ${company}.
Vous trouverez en pièces jointes mon CV et ma lettre de motivation.

Je reste à votre disposition pour un échange et vous remercie par avance pour votre retour.

Cordialement,
${name || "—"}
`;
    }

    setSubjectPreview(subject);
    setEmailPreview(body);
  };

  const handleGenerateEmail = (e: FormEvent) => {
    e.preventDefault();
    buildEmailContent();
  };

  const copyEmailAll = async () => {
    const text = `Objet: ${subjectPreview}\n\n${emailPreview}`;
    try {
      await navigator.clipboard.writeText(text);
      setEmailCopied(true);
      setTimeout(() => setEmailCopied(false), 1200);
    } catch (e) {
      console.error("Erreur copie email:", e);
    }
  };

  // =============================
  // LocalStorage CV draft (optionnel)
  // =============================
  const cvStorageKey = useMemo(() => {
    if (!userId) return null;
    return `cvDraft:${userId}:${cvTemplate}:${cvLang}`;
  }, [userId, cvTemplate, cvLang]);

  const saveCvDraft = () => {
    if (!cvStorageKey || !cvDraft) return;
    const payload = { cvDraft, cvSections, pdfBrand };
    localStorage.setItem(cvStorageKey, JSON.stringify(payload));
  };
  const loadCvDraft = () => {
    if (!cvStorageKey) return;
    const raw = localStorage.getItem(cvStorageKey);
    if (!raw) return;
    try {
      const parsed = JSON.parse(raw);
      if (parsed?.cvDraft) {
        setCvDraft(parsed.cvDraft);
        setCvDraftDirty(true);
      }
      if (parsed?.cvSections) setCvSections(parsed.cvSections);
      if (parsed?.pdfBrand) setPdfBrand(parsed.pdfBrand);
    } catch {
      // ignore
    }
  };
  const clearCvDraft = () => {
    if (!cvStorageKey) return;
    localStorage.removeItem(cvStorageKey);
  };

  // =============================
  // RENDER
  // =============================
  if (loadingProfile) {
    return (
      <div className="h-screen flex items-center justify-center bg-[#020617] text-slate-200">
        <Loader2 className="w-6 h-6 animate-spin text-blue-500" />
      </div>
    );
  }

  return (
    <div className="h-screen overflow-hidden bg-[#020617] text-slate-200 font-sans selection:bg-blue-500/30 p-3 lg:p-4">
      {/* Minimal CSS (keeps file standalone even if your global classes are missing) */}
      <style jsx global>{`
        :root {
          --bg: #0b1220;
          --bg-soft: rgba(15, 23, 42, 0.72);
          --ink: #e5e7eb;
          --muted: rgba(148, 163, 184, 0.9);
          --border: rgba(148, 163, 184, 0.18);
          --brand: #3b82f6;
        }
        .custom-scrollbar::-webkit-scrollbar {
          width: 10px;
          height: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
          background: rgba(255, 255, 255, 0.08);
          border-radius: 999px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
          background: rgba(255, 255, 255, 0.02);
        }
        .input {
          border: 1px solid var(--border);
          background: rgba(2, 6, 23, 0.6);
          color: var(--ink);
          border-radius: 12px;
          padding: 10px 12px;
          font-size: 12px;
          outline: none;
        }
        .input:focus {
          border-color: rgba(59, 130, 246, 0.55);
        }
        .textarea {
          resize: none;
        }
        .btn-primary {
          border-radius: 12px;
          background: var(--brand);
          color: white;
          border: 1px solid rgba(59, 130, 246, 0.5);
          padding: 10px 12px;
          font-weight: 800;
          font-size: 12px;
        }
        .btn-primary:hover {
          filter: brightness(1.08);
        }
        .btn-secondary {
          border-radius: 12px;
          background: rgba(255, 255, 255, 0.04);
          color: var(--ink);
          border: 1px solid var(--border);
          padding: 10px 12px;
          font-weight: 800;
          font-size: 12px;
        }
        .btn-secondary:hover {
          background: rgba(255, 255, 255, 0.07);
        }
      `}</style>

      <div className="max-w-7xl mx-auto h-full min-h-0 grid lg:grid-cols-[360px,1fr] gap-4">
        {/* LEFT / CONFIG */}
        <motion.aside initial={{ opacity: 0, x: -14 }} animate={{ opacity: 1, x: 0 }} className="flex flex-col gap-3 min-h-0">
          {/* Compact header card */}
          <CyberCard className="bg-slate-900/75 p-4">
            <div className="flex items-center gap-3">
              <div className="h-9 w-9 rounded-lg bg-blue-600 flex items-center justify-center shadow-lg shadow-blue-900/30">
                <PenTool className="text-white h-4 w-4" />
              </div>
              <div className="min-w-0">
                <h1 className="text-[16px] font-bold text-white tracking-tight leading-tight truncate">Assistant Candidature</h1>
                <p className="text-[9px] font-mono text-blue-400 uppercase tracking-widest">CV • LM • Pitch • Mail</p>
              </div>
            </div>

            <div className="mt-3 grid grid-cols-1 gap-2">
              <div className="rounded-xl border border-white/10 bg-slate-950/40 px-3 py-2">
                <p className="text-[9px] text-slate-500 uppercase tracking-widest font-bold">Cible</p>
                <p className="text-[12px] text-slate-200 mt-1 truncate">
                  🎯 <span className="font-semibold">{targetedJob}</span>
                </p>
                <p className="text-[12px] text-slate-200 truncate">
                  🏢 <span className="font-semibold">{targetedCompany}</span>
                </p>
                {miniHeadline ? <p className="mt-2 text-[11px] text-slate-500 line-clamp-2">{miniHeadline}</p> : null}
              </div>

              {globalLoadingMessage ? (
                <div className="rounded-xl border border-white/10 bg-slate-950/40 px-3 py-2 flex items-center gap-2">
                  <span className="inline-flex w-3.5 h-3.5 rounded-full border-2 border-blue-500/30 border-t-blue-400 animate-spin" />
                  <p className="text-[11px] text-slate-300 font-mono truncate">{globalLoadingMessage}</p>
                </div>
              ) : null}

              {!profile ? (
                <CyberCallout kind="info">
                  Aucun profil CV IA détecté. Passe d’abord par <span className="font-semibold">CV IA</span> pour charger ton profil.
                </CyberCallout>
              ) : null}
            </div>
          </CyberCard>

          {/* Mobile pane switch (one-screen) */}
          <div className="lg:hidden">
            <CyberPillTabs
              value={mobilePane}
              onChange={setMobilePane}
              items={[
                { key: "config", label: "Config", icon: <Briefcase className="h-4 w-4" /> },
                { key: "preview", label: "Aperçu", icon: <FileText className="h-4 w-4" /> },
              ]}
            />
          </div>

          {/* Tabs */}
          <CyberCard className="p-3">
            <CyberPillTabs
              value={viewMode}
              onChange={(v) => {
                setViewMode(v);
                setMobilePane("config");
              }}
              items={[
                { key: "cv_lm", label: "CV + LM", icon: <FileText className="h-4 w-4" /> },
                { key: "pitch", label: "PITCH", icon: <Sparkles className="h-4 w-4" /> },
                { key: "mail", label: "MAIL", icon: <Mail className="h-4 w-4" /> },
              ]}
            />
          </CyberCard>

          {/* Forms (scroll INSIDE) */}
          <CyberCard className={["flex-1 min-h-0 overflow-y-auto custom-scrollbar", mobilePane === "preview" ? "hidden lg:block" : ""].join(" ")}>
            <AnimatePresence mode="wait" initial={false}>
              {viewMode === "cv_lm" && (
                <motion.div
                  key="cv_lm"
                  initial={{ opacity: 0, y: 6 }}
                  animate={{ opacity: 1, y: 0 }}
                  exit={{ opacity: 0, y: -6 }}
                  transition={{ duration: 0.16 }}
                  className="space-y-5"
                >
                  {/* CV CONFIG */}
                  <div>
                    <CyberSectionTitle icon={<Briefcase className="h-4 w-4 text-emerald-400" />} title="CV" subtitle="Aperçu interne + éditeur." />
                    <div className="space-y-3">
                      <CyberInput label="Titre / objectif" value={cvTargetJob} onChange={setCvTargetJob} placeholder="Ex: Ingénieur Cybersécurité" />

                      <CyberInput
                        label="Offre (option IA au téléchargement)"
                        value={cvOfferDescription}
                        onChange={setCvOfferDescription}
                        placeholder="Colle 5–20 lignes (missions, outils, contexte)…"
                        area
                        rows={4}
                      />

                      <label className="flex items-center gap-2 text-xs text-slate-400 cursor-pointer">
                        <input
                          type="checkbox"
                          checked={cvUseAiOptimizeOnDownload}
                          onChange={(e) => setCvUseAiOptimizeOnDownload(e.target.checked)}
                          className="accent-blue-500"
                        />
                        Adapter via IA au téléchargement
                      </label>

                      <div className="grid grid-cols-2 gap-2">
                        <div>
                          <label className="text-[10px] font-bold text-slate-500 uppercase tracking-widest ml-1">Langue</label>
                          <select
                            className="w-full mt-1 bg-slate-950/50 border border-white/10 rounded-xl px-3 py-2 text-xs text-slate-200 focus:border-blue-500/50 outline-none"
                            value={cvLang}
                            onChange={(e) => setCvLang(e.target.value as Lang)}
                          >
                            <option value="fr">FR</option>
                            <option value="en">EN</option>
                          </select>
                        </div>
                        <div>
                          <label className="text-[10px] font-bold text-slate-500 uppercase tracking-widest ml-1">Contrat</label>
                          <select
                            className="w-full mt-1 bg-slate-950/50 border border-white/10 rounded-xl px-3 py-2 text-xs text-slate-200 focus:border-blue-500/50 outline-none"
                            value={cvContract}
                            onChange={(e) => setCvContract(e.target.value)}
                          >
                            <option value="CDI">CDI</option>
                            <option value="CDD">CDD</option>
                            <option value="Alternance">Alternance</option>
                            <option value="Stage">Stage</option>
                            <option value="Freelance">Freelance</option>
                          </select>
                        </div>
                      </div>

                      <div>
                        <label className="text-[10px] font-bold text-slate-500 uppercase tracking-widest ml-1">Couleur PDF</label>
                        <div className="flex items-center gap-2 mt-1">
                          <input type="color" value={normalizeHex(pdfBrand)} onChange={(e) => setPdfBrand(e.target.value)} className="h-9 w-11 rounded-xl border border-white/10 bg-slate-950/50" />
                          <input value={pdfBrand} onChange={(e) => setPdfBrand(e.target.value)} className="flex-1 input" placeholder="#3b82f6" />
                        </div>
                      </div>

                      <label className="flex items-center gap-2 text-xs text-slate-400 cursor-pointer">
                        <input type="checkbox" checked={cvAutoCreate} onChange={(e) => setCvAutoCreate(e.target.checked)} className="accent-blue-500" />
                        Créer une entrée “Suivi 📌” au téléchargement
                      </label>

                      {/* Templates compact */}
                      <div className="rounded-2xl border border-white/10 bg-slate-950/30 p-3 space-y-2">
                        <div className="flex items-center justify-between gap-2">
                          <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Modèles</p>
                          <button
                            type="button"
                            onClick={() => setTemplatesModalOpen(true)}
                            className="px-3 py-1.5 rounded-lg bg-white/5 hover:bg-white/10 border border-white/10 text-[10px] font-bold text-slate-200 transition"
                          >
                            + Plus
                          </button>
                        </div>
                        <div className="grid grid-cols-3 gap-2">
                          {top3Templates.map((t) => {
                            const active = t.id === cvTemplate;
                            return (
                              <button
                                key={t.id}
                                type="button"
                                onClick={() => setCvTemplate(t.id)}
                                className={[
                                  "rounded-xl border overflow-hidden transition text-left bg-slate-950/40",
                                  active ? "border-blue-500/60 ring-2 ring-blue-500/20" : "border-white/10 hover:border-white/20",
                                ].join(" ")}
                              >
                                <img src={t.previewSrc} alt={t.label} className="w-full h-[70px] object-cover bg-white" loading="lazy" />
                                <div className="p-2">
                                  <p className="text-[10px] font-bold text-slate-200 truncate">{t.label}</p>
                                </div>
                              </button>
                            );
                          })}
                        </div>
                      </div>

                      <div className="grid grid-cols-2 gap-2 pt-1">
                        <button
                          type="button"
                          onClick={async () => {
                            await prepareCvPreview();
                            setCvMobileView("edit");
                            setCvEditorOpen(true);
                          }}
                          disabled={cvLoading || !profile}
                          className="h-10 rounded-xl bg-blue-600 hover:bg-blue-500 text-white font-extrabold shadow-lg shadow-blue-900/30 flex items-center justify-center gap-2 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                          <PenTool className="h-4 w-4" />
                          Éditer
                        </button>

                        <button
                          type="button"
                          onClick={async () => {
                            await prepareCvLmPreview();
                            setCvLmViewerOpen(true);
                          }}
                          disabled={cvLoading || !profile}
                          className="h-10 rounded-xl bg-white/5 hover:bg-white/10 border border-white/10 text-slate-200 font-extrabold flex items-center justify-center gap-2 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                          <FileText className="h-4 w-4" />
                          2p
                        </button>
                      </div>

                      <div className="grid grid-cols-2 gap-2">
                        <button
                          type="button"
                          onClick={downloadCv}
                          disabled={cvLoading || !profile}
                          className="h-10 rounded-xl bg-white/5 hover:bg-white/10 border border-white/10 text-slate-200 font-extrabold flex items-center justify-center gap-2 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                          <Download className="h-4 w-4" />
                          CV
                        </button>

                        <button
                          type="button"
                          onClick={downloadCvLm}
                          disabled={cvLoading || !profile}
                          className="h-10 rounded-xl bg-blue-600 hover:bg-blue-500 text-white font-extrabold shadow-lg shadow-blue-900/30 flex items-center justify-center gap-2 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                          <Download className="h-4 w-4" />
                          CV+LM
                        </button>
                      </div>

                      {cvError ? <CyberCallout kind="error">{cvError}</CyberCallout> : null}
                      {cvStatus ? <CyberCallout kind="success">{cvStatus}</CyberCallout> : null}
                    </div>
                  </div>

                  <div className="h-px bg-white/5" />

                  {/* LM CONFIG */}
                  <div>
                    <CyberSectionTitle icon={<FileText className="h-4 w-4 text-blue-400" />} title="Lettre (IA)" subtitle="Génère → édite → PDF." />
                    <div className="space-y-3">
                      <div className="flex items-center justify-between">
                        <span className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Langue</span>
                        <div className="flex bg-slate-950 rounded-lg p-1 border border-white/10">
                          <button
                            type="button"
                            onClick={() => setLmLang("fr")}
                            className={[
                              "px-3 py-1 rounded-md text-[10px] font-bold transition-all",
                              lmLang === "fr" ? "bg-white text-slate-900" : "text-slate-500 hover:text-white",
                            ].join(" ")}
                          >
                            FR
                          </button>
                          <button
                            type="button"
                            onClick={() => setLmLang("en")}
                            className={[
                              "px-3 py-1 rounded-md text-[10px] font-bold transition-all",
                              lmLang === "en" ? "bg-white text-slate-900" : "text-slate-500 hover:text-white",
                            ].join(" ")}
                          >
                            EN
                          </button>
                        </div>
                      </div>

                      <CyberInput label="Entreprise" value={companyName} onChange={setCompanyName} placeholder="Ex: Thales, Doctolib…" />
                      <CyberInput label="Poste" value={jobTitle} onChange={setJobTitle} placeholder="Ex: Ingénieur Réseaux & Sécurité" />
                      <CyberInput label="Offre (optionnel)" value={jobDescription} onChange={setJobDescription} placeholder="Missions / outils / contexte…" area rows={4} />
                      <CyberInput label="Lien (optionnel)" value={jobLink} onChange={setJobLink} placeholder="https://" type="url" />

                      <button
                        type="button"
                        onClick={() => handleGenerateLetter()}
                        disabled={lmLoading || !profile}
                        className="w-full h-11 rounded-xl bg-blue-600 hover:bg-blue-500 text-white font-extrabold shadow-lg shadow-blue-900/30 flex items-center justify-center gap-2 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                      >
                        {lmLoading ? <span className="h-4 w-4 border-2 border-white/30 border-t-white rounded-full animate-spin" /> : <Sparkles className="h-4 w-4" />}
                        {lmLoading ? "GÉNÉRATION..." : "GÉNÉRER"}
                      </button>

                      <button
                        type="button"
                        onClick={async () => {
                          setLmEditorOpen(true);
                          await prepareLmPreview({ ensureText: true });
                        }}
                        disabled={lmPdfLoading || !profile}
                        className="w-full h-10 rounded-xl bg-white/5 hover:bg-white/10 border border-white/10 text-slate-200 font-extrabold flex items-center justify-center gap-2 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                      >
                        <PenTool className="h-4 w-4" />
                        Éditeur LM
                      </button>

                      {lmError ? <CyberCallout kind="error">{lmError}</CyberCallout> : null}
                      {lmPdfError ? <CyberCallout kind="error">{lmPdfError}</CyberCallout> : null}
                    </div>
                  </div>
                </motion.div>
              )}

              {viewMode === "pitch" && (
                <motion.div
                  key="pitch"
                  initial={{ opacity: 0, y: 6 }}
                  animate={{ opacity: 1, y: 0 }}
                  exit={{ opacity: 0, y: -6 }}
                  transition={{ duration: 0.16 }}
                  className="space-y-4"
                >
                  <CyberSectionTitle icon={<Sparkles className="h-4 w-4 text-blue-400" />} title="Pitch" subtitle="2–4 phrases, prêt entretien." />

                  <div className="flex items-center justify-between">
                    <span className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Langue</span>
                    <div className="flex bg-slate-950 rounded-lg p-1 border border-white/10">
                      <button
                        type="button"
                        onClick={() => setPitchLang("fr")}
                        className={[
                          "px-3 py-1 rounded-md text-[10px] font-bold transition-all",
                          pitchLang === "fr" ? "bg-white text-slate-900" : "text-slate-500 hover:text-white",
                        ].join(" ")}
                      >
                        FR
                      </button>
                      <button
                        type="button"
                        onClick={() => setPitchLang("en")}
                        className={[
                          "px-3 py-1 rounded-md text-[10px] font-bold transition-all",
                          pitchLang === "en" ? "bg-white text-slate-900" : "text-slate-500 hover:text-white",
                        ].join(" ")}
                      >
                        EN
                      </button>
                    </div>
                  </div>

                  <div className="grid grid-cols-2 gap-2">
                    <button
                      type="button"
                      onClick={handleGeneratePitch}
                      disabled={pitchLoading || !profile}
                      className="h-10 rounded-xl bg-blue-600 hover:bg-blue-500 text-white font-extrabold shadow-lg shadow-blue-900/30 flex items-center justify-center gap-2 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                      {pitchLoading ? <span className="h-4 w-4 border-2 border-white/30 border-t-white rounded-full animate-spin" /> : <Sparkles className="h-4 w-4" />}
                      Générer
                    </button>

                    <button
                      type="button"
                      onClick={handleCopyPitch}
                      disabled={!pitchText}
                      className="h-10 rounded-xl bg-white/5 hover:bg-white/10 border border-white/10 text-slate-200 font-extrabold flex items-center justify-center gap-2 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                      <Copy className="h-4 w-4" />
                      {pitchCopied ? "Copié" : "Copier"}
                    </button>
                  </div>

                  {pitchError ? <CyberCallout kind="error">{pitchError}</CyberCallout> : null}
                </motion.div>
              )}

              {viewMode === "mail" && (
                <motion.div
                  key="mail"
                  initial={{ opacity: 0, y: 6 }}
                  animate={{ opacity: 1, y: 0 }}
                  exit={{ opacity: 0, y: -6 }}
                  transition={{ duration: 0.16 }}
                  className="space-y-4"
                >
                  <CyberSectionTitle icon={<Mail className="h-4 w-4 text-blue-400" />} title="Mail" subtitle="Objet + corps à copier." />

                  <CyberInput label="Entreprise" value={companyName} onChange={setCompanyName} placeholder="Ex: IMOGATE" />
                  <CyberInput label="Poste" value={jobTitle} onChange={setJobTitle} placeholder="Ex: Ingénieur Réseaux & Sécurité" />
                  <CyberInput label="Recruteur (optionnel)" value={recruiterName} onChange={setRecruiterName} placeholder="Ex: Mme Dupont" />

                  <div>
                    <label className="text-[10px] font-bold text-slate-500 uppercase tracking-widest ml-1">Ton</label>
                    <select
                      className="w-full mt-1 bg-slate-950/50 border border-white/10 rounded-xl px-3 py-2 text-xs text-slate-200 focus:border-blue-500/50 outline-none"
                      value={emailTone}
                      onChange={(e) => setEmailTone(e.target.value as any)}
                    >
                      <option value="standard">Standard</option>
                      <option value="pro">Très pro</option>
                      <option value="court">Court</option>
                    </select>
                  </div>

                  <div className="grid grid-cols-2 gap-2">
                    <button
                      type="button"
                      onClick={(e: any) => handleGenerateEmail(e)}
                      className="h-10 rounded-xl bg-blue-600 hover:bg-blue-500 text-white font-extrabold shadow-lg shadow-blue-900/30 flex items-center justify-center gap-2 transition-all"
                    >
                      <Send className="h-4 w-4" />
                      Générer
                    </button>

                    <button
                      type="button"
                      onClick={copyEmailAll}
                      disabled={!subjectPreview || !emailPreview}
                      className="h-10 rounded-xl bg-white/5 hover:bg-white/10 border border-white/10 text-slate-200 font-extrabold flex items-center justify-center gap-2 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                      <Copy className="h-4 w-4" />
                      {emailCopied ? "Copié" : "Copier"}
                    </button>
                  </div>
                </motion.div>
              )}
            </AnimatePresence>
          </CyberCard>
        </motion.aside>

        {/* RIGHT / PREVIEW */}
        <motion.main
          initial={{ opacity: 0, y: 12 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ delay: 0.05 }}
          className={[
            "bg-slate-900/30 rounded-3xl border border-white/5 p-3 lg:p-4 relative overflow-hidden flex flex-col min-h-0",
            mobilePane === "config" ? "hidden lg:flex" : "",
          ].join(" ")}
        >
          <AnimatePresence mode="wait" initial={false}>
            {viewMode === "cv_lm" && (
              <motion.div
                key="out_cv_lm"
                initial={{ opacity: 0, y: 8 }}
                animate={{ opacity: 1, y: 0 }}
                exit={{ opacity: 0, y: -8 }}
                transition={{ duration: 0.16 }}
                className="flex flex-col h-full min-h-0 gap-3"
              >
                <div className="flex items-center justify-between bg-slate-950/70 p-2.5 rounded-2xl border border-white/10">
                  <div className="flex items-center gap-2 px-2 min-w-0">
                    <div className="h-2 w-2 rounded-full bg-blue-500 shadow-[0_0_10px_rgba(59,130,246,0.5)]" />
                    <span className="text-[11px] font-bold text-slate-300 uppercase tracking-wider truncate">Aperçu PDF</span>
                  </div>
                  <div className="flex items-center gap-2">
                    <button
                      type="button"
                      onClick={prepareCvPreview}
                      disabled={cvLoading || !profile}
                      className="p-2 rounded-lg hover:bg-white/5 text-slate-400 hover:text-white transition-colors disabled:opacity-50"
                      title="Régénérer aperçu CV"
                    >
                      <RotateCcw className="h-4 w-4" />
                    </button>
                    <button
                      type="button"
                      onClick={downloadCvLm}
                      disabled={cvLoading || !profile}
                      className="flex items-center gap-2 px-3 py-1.5 rounded-lg bg-blue-600 hover:bg-blue-500 text-[11px] font-bold text-white shadow-lg transition-colors disabled:opacity-50"
                    >
                      <Download className="h-3.5 w-3.5" />
                      CV+LM
                    </button>
                  </div>
                </div>

                {globalLoadingMessage ? (
                  <div className="flex-1 min-h-0 flex flex-col items-center justify-center gap-4">
                    <div className="relative">
                      <div className="h-20 w-20 rounded-full border-4 border-blue-500/20 border-t-blue-500 animate-spin" />
                      <div className="absolute inset-0 flex items-center justify-center">
                        <Sparkles className="h-7 w-7 text-blue-400 animate-pulse" />
                      </div>
                    </div>
                    <div className="text-center space-y-1">
                      <h2 className="text-[16px] font-bold text-white tracking-tight">{globalLoadingMessage}</h2>
                      <p className="text-[12px] text-slate-500">Préparation…</p>
                    </div>
                  </div>
                ) : cvLmPreviewUrl || cvPreviewUrl ? (
                  <div className="flex-1 min-h-0 rounded-2xl overflow-hidden border border-white/10 bg-white">
                    <PdfCanvasViewer fileUrl={cvLmPreviewUrl || cvPreviewUrl} className="h-full" />
                  </div>
                ) : (
                  <div className="flex-1 min-h-0 flex flex-col items-center justify-center text-center opacity-50">
                    <ArrowRight className="h-12 w-12 text-slate-600 mb-3" />
                    <h3 className="text-[16px] font-bold text-white">Génère un aperçu</h3>
                    <p className="text-[12px] text-slate-400 max-w-md mx-auto mt-1">Prépare un aperçu (CV ou CV+LM). Tu verras le rendu ici, sans toolbar Chrome.</p>
                  </div>
                )}
              </motion.div>
            )}

            {viewMode === "pitch" && (
              <motion.div
                key="out_pitch"
                initial={{ opacity: 0, y: 8 }}
                animate={{ opacity: 1, y: 0 }}
                exit={{ opacity: 0, y: -8 }}
                transition={{ duration: 0.16 }}
                className="flex flex-col h-full min-h-0 gap-3"
              >
                <div className="flex items-center justify-between bg-slate-950/70 p-2.5 rounded-2xl border border-white/10">
                  <div className="flex items-center gap-2 px-2">
                    <div className="h-2 w-2 rounded-full bg-emerald-500 shadow-[0_0_10px_rgba(16,185,129,0.5)]" />
                    <span className="text-[11px] font-bold text-slate-300 uppercase tracking-wider">Pitch</span>
                  </div>
                  <button
                    type="button"
                    onClick={handleCopyPitch}
                    disabled={!pitchText}
                    className="flex items-center gap-2 px-3 py-1.5 rounded-lg bg-white/5 hover:bg-white/10 border border-white/10 text-[11px] font-bold text-slate-200 transition-colors disabled:opacity-50"
                  >
                    <Copy className="h-3.5 w-3.5" />
                    {pitchCopied ? "Copié" : "Copier"}
                  </button>
                </div>

                <div className="flex-1 min-h-0 bg-slate-950 border border-white/10 rounded-2xl p-4 text-[13px] leading-relaxed text-slate-300 custom-scrollbar overflow-auto">
                  {pitchLoading ? (
                    <div className="h-full flex items-center justify-center gap-3 text-slate-400">
                      <span className="h-4 w-4 border-2 border-white/20 border-t-white rounded-full animate-spin" />
                      Génération…
                    </div>
                  ) : pitchText ? (
                    <pre className="whitespace-pre-wrap font-sans">{pitchText}</pre>
                  ) : (
                    <div className="h-full flex items-center justify-center text-slate-500">Génère un pitch pour l’afficher ici.</div>
                  )}
                </div>
              </motion.div>
            )}

            {viewMode === "mail" && (
              <motion.div
                key="out_mail"
                initial={{ opacity: 0, y: 8 }}
                animate={{ opacity: 1, y: 0 }}
                exit={{ opacity: 0, y: -8 }}
                transition={{ duration: 0.16 }}
                className="flex flex-col h-full min-h-0 gap-3"
              >
                <div className="flex items-center justify-between bg-slate-950/70 p-2.5 rounded-2xl border border-white/10">
                  <div className="flex items-center gap-2 px-2">
                    <div className="h-2 w-2 rounded-full bg-blue-500 shadow-[0_0_10px_rgba(59,130,246,0.5)]" />
                    <span className="text-[11px] font-bold text-slate-300 uppercase tracking-wider">Mail</span>
                  </div>
                  <button
                    type="button"
                    onClick={copyEmailAll}
                    disabled={!subjectPreview || !emailPreview}
                    className="flex items-center gap-2 px-3 py-1.5 rounded-lg bg-blue-600 hover:bg-blue-500 text-[11px] font-bold text-white shadow-lg transition-colors disabled:opacity-50"
                  >
                    <Copy className="h-3.5 w-3.5" />
                    {emailCopied ? "Copié" : "Copier"}
                  </button>
                </div>

                <div className="grid lg:grid-cols-2 gap-3 flex-1 min-h-0">
                  <div className="bg-slate-950 border border-white/10 rounded-2xl p-4 overflow-auto custom-scrollbar">
                    <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Objet</p>
                    <div className="mt-2 text-[13px] text-slate-200 whitespace-pre-line">{subjectPreview || "Génère un mail pour voir l’objet."}</div>
                  </div>

                  <div className="bg-slate-950 border border-white/10 rounded-2xl p-4 overflow-auto custom-scrollbar">
                    <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Corps</p>
                    <div className="mt-2 text-[13px] text-slate-200 whitespace-pre-line">{emailPreview || "Génère un mail pour voir le corps."}</div>
                  </div>
                </div>
              </motion.div>
            )}
          </AnimatePresence>
        </motion.main>
      </div>

      {/* ===========================
          MODALS
          =========================== */}
      <FullScreenModal
        open={cvEditorOpen}
        title="Éditeur CV — plein écran"
        onClose={() => setCvEditorOpen(false)}
        actions={
          <>
            <button type="button" className="btn-secondary !py-1.5 !px-3 text-[12px]" onClick={loadCvDraft} disabled={!userId}>
              Charger
            </button>
            <button type="button" className="btn-secondary !py-1.5 !px-3 text-[12px]" onClick={saveCvDraft} disabled={!userId || !cvDraft}>
              Enregistrer
            </button>
            <button type="button" className="btn-secondary !py-1.5 !px-3 text-[12px]" onClick={clearCvDraft} disabled={!userId}>
              Oublier
            </button>
            <button type="button" className="btn-secondary !py-1.5 !px-3 text-[12px]" onClick={prepareCvPreview} disabled={cvLoading}>
              Régénérer
            </button>
            <button type="button" className="btn-primary !py-1.5 !px-3 text-[12px]" onClick={downloadCv}>
              Télécharger
            </button>
          </>
        }
      >
        <div className="h-full min-h-0">
          <div className="lg:hidden p-2 border-b border-[var(--border)] bg-[var(--bg-soft)] flex gap-2">
            <button type="button" className={`btn-secondary flex-1 !py-2 ${cvMobileView === "edit" ? "!border-[var(--brand)]" : ""}`} onClick={() => setCvMobileView("edit")}>
              Éditer
            </button>
            <button
              type="button"
              className={`btn-secondary flex-1 !py-2 ${cvMobileView === "preview" ? "!border-[var(--brand)]" : ""}`}
              onClick={() => setCvMobileView("preview")}
            >
              Aperçu
            </button>
          </div>

          <div className="h-[calc(100%-48px)] lg:h-full grid grid-cols-1 lg:grid-cols-2 min-h-0">
            <div
              className={`${cvMobileView === "preview" ? "hidden" : ""} lg:block min-h-0 overflow-auto p-3 sm:p-4 border-b lg:border-b-0 lg:border-r border-[var(--border)] custom-scrollbar`}
            >
              {!cvDraft ? (
                <p className="text-[11px] text-[var(--muted)]">Charge ton profil CV IA pour éditer.</p>
              ) : (
                <div className="space-y-3">
                  <div className="rounded-xl border border-[var(--border)] bg-[var(--bg-soft)] p-3">
                    <p className="text-[11px] font-medium text-[var(--muted)] mb-2">Sections à afficher</p>
                    <div className="grid grid-cols-2 gap-2 text-[11px] text-[var(--muted)]">
                      {(
                        [
                          ["profile", "Profil"],
                          ["xp", "Expérience"],
                          ["education", "Formation"],
                          ["skills", "Compétences"],
                          ["certs", "Certifications"],
                          ["languages", "Langues"],
                          ["hobbies", "Hobbies"],
                        ] as Array<[CvSectionKey, string]>
                      ).map(([k, label]) => (
                        <label key={k} className="flex items-center gap-2 cursor-pointer">
                          <input type="checkbox" checked={cvSections[k]} onChange={(e) => setCvSections((prev) => ({ ...prev, [k]: e.target.checked }))} />
                          <span>{label}</span>
                        </label>
                      ))}
                    </div>
                  </div>

                  <div className="grid sm:grid-cols-2 gap-3">
                    <div>
                      <label className="block text-[11px] font-medium text-[var(--muted)] mb-1">Nom</label>
                      <input
                        className="input w-full"
                        value={(cvDraft as any).name || ""}
                        onChange={(e) => {
                          setCvDraftDirty(true);
                          setCvDraft((prev) => (prev ? ({ ...prev, name: e.target.value } as any) : prev));
                        }}
                      />
                    </div>
                    <div>
                      <label className="block text-[11px] font-medium text-[var(--muted)] mb-1">Titre</label>
                      <input
                        className="input w-full"
                        value={(cvDraft as any).title || ""}
                        onChange={(e) => {
                          setCvDraftDirty(true);
                          setCvDraft((prev) => (prev ? ({ ...prev, title: e.target.value } as any) : prev));
                        }}
                      />
                    </div>
                  </div>

                  <div>
                    <label className="block text-[11px] font-medium text-[var(--muted)] mb-1">Contact line</label>
                    <input
                      className="input w-full"
                      value={(cvDraft as any).contactLine || ""}
                      onChange={(e) => {
                        setCvDraftDirty(true);
                        setCvDraft((prev) => (prev ? ({ ...prev, contactLine: e.target.value } as any) : prev));
                      }}
                    />
                  </div>

                  <div>
                    <label className="block text-[11px] font-medium text-[var(--muted)] mb-1">Profil</label>
                    <textarea
                      rows={4}
                      className="input textarea w-full"
                      value={(cvDraft as any).profile || ""}
                      onChange={(e) => {
                        setCvDraftDirty(true);
                        setCvDraft((prev) => (prev ? ({ ...prev, profile: e.target.value } as any) : prev));
                      }}
                    />
                  </div>

                  <div className="grid sm:grid-cols-2 gap-3">
                    <div>
                      <label className="block text-[11px] font-medium text-[var(--muted)] mb-1">Certifications</label>
                      <textarea
                        rows={3}
                        className="input textarea w-full"
                        value={(cvDraft as any).certs || ""}
                        onChange={(e) => {
                          setCvDraftDirty(true);
                          setCvDraft((prev) => (prev ? ({ ...prev, certs: e.target.value } as any) : prev));
                        }}
                      />
                    </div>

                    <div>
                      <label className="block text-[11px] font-medium text-[var(--muted)] mb-1">Langues</label>
                      <textarea
                        rows={3}
                        className="input textarea w-full"
                        value={(cvDraft as any).langLine || ""}
                        onChange={(e) => {
                          setCvDraftDirty(true);
                          setCvDraft((prev) => (prev ? ({ ...prev, langLine: e.target.value } as any) : prev));
                        }}
                      />
                    </div>
                  </div>

                  <div className="grid sm:grid-cols-2 gap-3">
                    <div>
                      <label className="block text-[11px] font-medium text-[var(--muted)] mb-1">Compétences – tools (virgules)</label>
                      <textarea
                        rows={3}
                        className="input textarea w-full"
                        value={joinList(((cvDraft as any).skills?.tools || []) as string[])}
                        onChange={(e) => {
                          const tools = splitList(e.target.value);
                          setCvDraftDirty(true);
                          setCvDraft((prev) => {
                            if (!prev) return prev;
                            const skills = { ...(prev as any).skills, tools };
                            return { ...(prev as any), skills };
                          });
                        }}
                      />
                    </div>

                    <div>
                      <label className="block text-[11px] font-medium text-[var(--muted)] mb-1">Compétences – cloud</label>
                      <textarea
                        rows={3}
                        className="input textarea w-full"
                        value={joinList(((cvDraft as any).skills?.cloud || []) as string[])}
                        onChange={(e) => {
                          const cloud = splitList(e.target.value);
                          setCvDraftDirty(true);
                          setCvDraft((prev) => {
                            if (!prev) return prev;
                            const skills = { ...(prev as any).skills, cloud };
                            return { ...(prev as any), skills };
                          });
                        }}
                      />
                    </div>
                  </div>

                  <div>
                    <label className="block text-[11px] font-medium text-[var(--muted)] mb-1">Formation (1 ligne = 1 entrée)</label>
                    <textarea
                      rows={4}
                      className="input textarea w-full"
                      value={linesToText(((cvDraft as any).education || []) as string[])}
                      onChange={(e) => {
                        setCvDraftDirty(true);
                        const education = textToLines(e.target.value);
                        setCvDraft((prev) => (prev ? ({ ...prev, education } as any) : prev));
                      }}
                    />
                  </div>

                  {/* Experiences */}
                  <div className="rounded-xl border border-[var(--border)] bg-[var(--bg-soft)] p-3">
                    <div className="flex items-center justify-between gap-2 mb-2">
                      <p className="text-[11px] font-medium text-[var(--muted)]">Expériences</p>
                      <button
                        type="button"
                        className="btn-secondary !py-1 !px-3 text-[11px]"
                        onClick={() => {
                          setCvDraftDirty(true);
                          setCvDraft((prev) => {
                            if (!prev) return prev;
                            const xp = Array.isArray((prev as any).xp) ? ([...(prev as any).xp] as any[]) : [];
                            xp.unshift({ company: "", role: "", dates: "", city: "", bullets: [] });
                            return { ...(prev as any), xp };
                          });
                        }}
                      >
                        + Ajouter
                      </button>
                    </div>

                    <div className="space-y-2">
                      {(((cvDraft as any).xp || []) as any[]).map((x, idx) => (
                        <details key={idx} className="rounded-xl border border-[var(--border)] bg-[var(--bg)] p-2">
                          <summary className="cursor-pointer text-[12px] font-semibold text-[var(--ink)]">
                            {(x.role || "Rôle")} — {(x.company || "Entreprise")}{" "}
                            <span className="text-[10px] text-[var(--muted)]">#{idx + 1}</span>
                          </summary>

                          <div className="mt-2 space-y-2">
                            <div className="grid sm:grid-cols-2 gap-2">
                              <input
                                className="input w-full"
                                placeholder="Rôle"
                                value={x.role || ""}
                                onChange={(e) => {
                                  setCvDraftDirty(true);
                                  setCvDraft((prev) => {
                                    if (!prev) return prev;
                                    const xp = [...((prev as any).xp || [])];
                                    xp[idx] = { ...xp[idx], role: e.target.value };
                                    return { ...(prev as any), xp };
                                  });
                                }}
                              />
                              <input
                                className="input w-full"
                                placeholder="Entreprise"
                                value={x.company || ""}
                                onChange={(e) => {
                                  setCvDraftDirty(true);
                                  setCvDraft((prev) => {
                                    if (!prev) return prev;
                                    const xp = [...((prev as any).xp || [])];
                                    xp[idx] = { ...xp[idx], company: e.target.value };
                                    return { ...(prev as any), xp };
                                  });
                                }}
                              />
                            </div>

                            <div className="grid sm:grid-cols-2 gap-2">
                              <input
                                className="input w-full"
                                placeholder="Dates (ex: 2022–2024)"
                                value={x.dates || ""}
                                onChange={(e) => {
                                  setCvDraftDirty(true);
                                  setCvDraft((prev) => {
                                    if (!prev) return prev;
                                    const xp = [...((prev as any).xp || [])];
                                    xp[idx] = { ...xp[idx], dates: e.target.value };
                                    return { ...(prev as any), xp };
                                  });
                                }}
                              />
                              <input
                                className="input w-full"
                                placeholder="Ville / Lieu"
                                value={x.city || ""}
                                onChange={(e) => {
                                  setCvDraftDirty(true);
                                  setCvDraft((prev) => {
                                    if (!prev) return prev;
                                    const xp = [...((prev as any).xp || [])];
                                    xp[idx] = { ...xp[idx], city: e.target.value };
                                    return { ...(prev as any), xp };
                                  });
                                }}
                              />
                            </div>

                            <textarea
                              rows={4}
                              className="input textarea w-full"
                              placeholder={"Bullets (1 ligne = 1 bullet)\n- Exemple: Mise en place MFA\n- Exemple: Durcissement AD"}
                              value={bulletsToText(x.bullets || [])}
                              onChange={(e) => {
                                const bullets = textToBullets(e.target.value);
                                setCvDraftDirty(true);
                                setCvDraft((prev) => {
                                  if (!prev) return prev;
                                  const xp = [...((prev as any).xp || [])];
                                  xp[idx] = { ...xp[idx], bullets };
                                  return { ...(prev as any), xp };
                                });
                              }}
                            />

                            <div className="flex flex-wrap gap-2">
                              <button
                                type="button"
                                className="btn-secondary !py-1 !px-3 text-[11px]"
                                onClick={() => {
                                  setCvDraftDirty(true);
                                  setCvDraft((prev) => {
                                    if (!prev) return prev;
                                    const xp = [...((prev as any).xp || [])];
                                    if (idx > 0) [xp[idx - 1], xp[idx]] = [xp[idx], xp[idx - 1]];
                                    return { ...(prev as any), xp };
                                  });
                                }}
                              >
                                ↑ Monter
                              </button>

                              <button
                                type="button"
                                className="btn-secondary !py-1 !px-3 text-[11px]"
                                onClick={() => {
                                  setCvDraftDirty(true);
                                  setCvDraft((prev) => {
                                    if (!prev) return prev;
                                    const xp = [...((prev as any).xp || [])];
                                    if (idx < xp.length - 1) [xp[idx + 1], xp[idx]] = [xp[idx], xp[idx + 1]];
                                    return { ...(prev as any), xp };
                                  });
                                }}
                              >
                                ↓ Descendre
                              </button>

                              <button
                                type="button"
                                className="btn-secondary !py-1 !px-3 text-[11px] border-red-500/40 text-red-300 hover:border-red-500"
                                onClick={() => {
                                  setCvDraftDirty(true);
                                  setCvDraft((prev) => {
                                    if (!prev) return prev;
                                    const xp = [...((prev as any).xp || [])];
                                    xp.splice(idx, 1);
                                    return { ...(prev as any), xp };
                                  });
                                }}
                              >
                                Supprimer
                              </button>
                            </div>
                          </div>
                        </details>
                      ))}
                    </div>
                  </div>

                  <div>
                    <label className="block text-[11px] font-medium text-[var(--muted)] mb-1">Hobbies (virgules)</label>
                    <input
                      className="input w-full"
                      value={joinList(((cvDraft as any).hobbies || []) as string[])}
                      onChange={(e) => {
                        const hobbies = splitList(e.target.value);
                        setCvDraftDirty(true);
                        setCvDraft((prev) => (prev ? ({ ...prev, hobbies } as any) : prev));
                      }}
                    />
                  </div>

                  <button
                    type="button"
                    className="btn-secondary w-full"
                    onClick={() => {
                      if (!baseCvModel) return;
                      setCvDraft(baseCvModel);
                      setCvDraftDirty(false);
                      setCvSections(DEFAULT_CV_SECTIONS);
                    }}
                  >
                    Réinitialiser au profil IA
                  </button>
                </div>
              )}
            </div>

            <div className={`${cvMobileView === "edit" ? "hidden" : ""} lg:block min-h-0 bg-white border-t lg:border-t-0 lg:border-l border-[var(--border)]`}>
              <PdfCanvasViewer fileUrl={cvPreviewUrl} />
            </div>
          </div>
        </div>
      </FullScreenModal>

      <FullScreenModal
        open={lmEditorOpen}
        title="Éditeur Lettre de motivation — plein écran"
        onClose={() => setLmEditorOpen(false)}
        actions={
          <>
            <button type="button" className="btn-secondary !py-1.5 !px-3 text-[12px]" onClick={() => prepareLmPreview({ ensureText: true })} disabled={lmPdfLoading}>
              Régénérer
            </button>
            <button type="button" className="btn-primary !py-1.5 !px-3 text-[12px]" onClick={downloadLm}>
              Télécharger
            </button>
          </>
        }
      >
        <div className="h-full grid grid-cols-1 lg:grid-cols-2 min-h-0">
          <div className="min-h-0 overflow-auto p-3 sm:p-4 border-b lg:border-b-0 lg:border-r border-[var(--border)] custom-scrollbar">
            <div className="space-y-2">
              <p className="text-[11px] text-[var(--muted)]">Édite le texte → l’aperçu se met à jour automatiquement.</p>
              <label className="block text-[11px] font-medium text-[var(--muted)]">Texte (corps uniquement)</label>
              <textarea
                rows={18}
                className="input textarea w-full text-[13px] text-[var(--ink)] bg-[var(--bg)]"
                value={letterBody}
                onChange={(e) => setLetterBody(e.target.value)}
                placeholder="Colle / modifie ici…"
              />
              {lmPdfError && <p className="text-[11px] text-red-400">{lmPdfError}</p>}
              <div className="grid grid-cols-2 gap-2">
                <button type="button" className="btn-secondary" onClick={() => prepareLmPreview({ ensureText: false })} disabled={lmPdfLoading}>
                  Régénérer
                </button>
                <button type="button" className="btn-primary" onClick={downloadLm}>
                  Télécharger
                </button>
              </div>
            </div>
          </div>

          <div className="min-h-0 bg-white border-t lg:border-t-0 lg:border-l border-[var(--border)]">
            <PdfCanvasViewer fileUrl={lmPreviewUrl} />
          </div>
        </div>
      </FullScreenModal>

      <FullScreenModal
        open={cvLmViewerOpen}
        title="Aperçu CV + LM — plein écran (2 pages)"
        onClose={() => setCvLmViewerOpen(false)}
        actions={
          <>
            <button type="button" className="btn-secondary !py-1.5 !px-3 text-[12px]" onClick={prepareCvLmPreview} disabled={cvLoading}>
              Régénérer
            </button>
            <button type="button" className="btn-primary !py-1.5 !px-3 text-[12px]" onClick={downloadCvLm}>
              Télécharger
            </button>
          </>
        }
      >
        <div className="h-full min-h-0">
          <PdfCanvasViewer fileUrl={cvLmPreviewUrl} className="h-full" />
        </div>
      </FullScreenModal>

      {/* Templates modal */}
      {templatesModalOpen && (
        <div className="fixed inset-0 z-[60] flex items-center justify-center p-3" aria-modal="true" role="dialog">
          <div className="absolute inset-0 bg-black/60" onClick={() => setTemplatesModalOpen(false)} />
          <motion.div
            initial={{ opacity: 0, y: 10, scale: 0.98 }}
            animate={{ opacity: 1, y: 0, scale: 1 }}
            transition={{ duration: 0.18 }}
            className="relative w-full max-w-4xl rounded-2xl border border-[var(--border)] bg-[var(--bg)] shadow-xl overflow-hidden"
          >
            <div className="p-3 sm:p-4 border-b border-[var(--border)] bg-[var(--bg-soft)] flex flex-wrap items-center justify-between gap-2">
              <div>
                <p className="text-[13px] font-semibold text-[var(--ink)]">Choisir un modèle</p>
                <p className="text-[10px] text-[var(--muted)]">Recherche + sélection instantanée</p>
              </div>
              <div className="flex items-center gap-2">
                <input
                  value={templateSearch}
                  onChange={(e) => setTemplateSearch(e.target.value)}
                  className="input !py-2 !text-[12px] w-[220px]"
                  placeholder="Rechercher (ex: pro, ats, tech)"
                />
                <button type="button" className="btn-secondary !py-2 !px-3 text-[12px]" onClick={() => setTemplatesModalOpen(false)}>
                  Fermer
                </button>
              </div>
            </div>

            <div className="p-3 sm:p-4 max-h-[70vh] overflow-auto custom-scrollbar">
              <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
                {filteredTemplates.map((t) => {
                  const active = t.id === cvTemplate;
                  return (
                    <button
                      key={t.id}
                      type="button"
                      onClick={() => {
                        setCvTemplate(t.id);
                        setTemplatesModalOpen(false);
                        setTemplateSearch("");
                      }}
                      className={`text-left rounded-2xl border p-2 bg-[var(--bg-soft)] transition ${
                        active ? "border-[var(--brand)] ring-2 ring-[var(--brand)]/20" : "border-[var(--border)] hover:border-[var(--brand)]/50"
                      }`}
                    >
                      <img src={t.previewSrc} alt={t.label} className="w-full h-[140px] object-cover rounded-xl border border-[var(--border)] bg-white" loading="lazy" />
                      <div className="mt-2">
                        <p className="text-[12px] font-semibold text-[var(--ink)] flex items-center justify-between gap-2">
                          <span>{t.label}</span>
                          {active && (
                            <span className="text-[10px] px-2 py-[2px] rounded-full bg-[var(--brand)]/10 text-[var(--brand)] border border-[var(--brand)]/20">
                              Sélectionné
                            </span>
                          )}
                        </p>
                        <p className="text-[10px] text-[var(--muted)] line-clamp-2">{t.description}</p>
                      </div>
                    </button>
                  );
                })}
              </div>

              {!filteredTemplates.length && <p className="text-center text-[11px] text-[var(--muted)] py-8">Aucun modèle trouvé.</p>}
            </div>
          </motion.div>
        </div>
      )}
    </div>
  );
}
````
